{"file_contents":{"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n\" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n           // @replit: no hover, and add primary border\n           \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm border-destructive-border\",\n        outline:\n          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color. Uses shadow-xs. no shadow on active\n          // No hover state\n          \" border [border-color:var(--button-outline)] shadow-xs active:shadow-none \",\n        secondary:\n          // @replit border, no hover, no shadow, secondary border.\n          \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // @replit no hover, transparent border\n        ghost: \"border border-transparent\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        // @replit changed sizes\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2356,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1237,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: true,\n      refetchOnReconnect: true,\n      staleTime: 60000, // 1 minute - data considered fresh\n      gcTime: 300000, // 5 minutes - keep in cache\n      retry: 1,\n      retryDelay: 1000,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1518,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5124,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4419,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4280,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/sonner\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { useCurrentUser, onSessionExpired, useUserPreferences, useUpdateUserPreferences } from \"@/lib/api\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\nimport { useEffect, lazy, Suspense, useCallback, useRef, useState } from \"react\";\nimport { DashboardProvider } from \"@/contexts/DashboardContext\";\nimport { toast } from \"sonner\";\nimport { WelcomeModal } from \"@/components/WelcomeModal\";\n\n// Loading component for lazy-loaded routes\nconst PageLoader = () => (\n  <div className=\"min-h-screen flex items-center justify-center bg-background\">\n    <div className=\"text-muted-foreground\">Loading...</div>\n  </div>\n);\n\n// Lazy load all page components for code splitting\nconst NotFound = lazy(() => import(\"@/pages/not-found\"));\nconst AuthPage = lazy(() => import(\"@/pages/auth/AuthPage\"));\nconst ResetPassword = lazy(() => import(\"@/pages/auth/ResetPassword\"));\nconst Dashboard = lazy(() => import(\"@/pages/ceo/Dashboard\"));\nconst DealManagement = lazy(() => import(\"@/pages/ceo/DealManagement\"));\nconst InvestorMatching = lazy(() => import(\"@/pages/ceo/InvestorMatching\"));\nconst EmployeeInvestorMatching = lazy(() => import(\"@/pages/employee/InvestorMatching\"));\nconst TeamAssignment = lazy(() => import(\"@/pages/ceo/TeamAssignment\"));\nconst TeamPerformance = lazy(() => import(\"@/pages/ceo/TeamPerformance\"));\nconst TeamProfiles = lazy(() => import(\"@/pages/ceo/TeamProfiles\"));\nconst InvestorCRM = lazy(() => import(\"@/pages/ceo/InvestorCRM\"));\nconst ClientPortal = lazy(() => import(\"@/pages/shared/ClientPortal\"));\nconst MentorshipPairing = lazy(() => import(\"@/pages/shared/MentorshipPairing\"));\nconst GoalSettingOKRs = lazy(() => import(\"@/pages/shared/GoalSettingOKRs\"));\nconst DealAnnouncements = lazy(() => import(\"@/pages/shared/DealAnnouncements\"));\nconst StakeholderDirectory = lazy(() => import(\"@/pages/shared/StakeholderDirectory\"));\nconst EventCalendar = lazy(() => import(\"@/pages/shared/EventCalendar\"));\nconst MyTasks = lazy(() => import(\"@/pages/employee/MyTasks\"));\nconst EmployeeHome = lazy(() => import(\"@/pages/employee/Home\"));\nconst Chat = lazy(() => import(\"@/pages/shared/Chat\"));\nconst UserManagement = lazy(() => import(\"@/pages/ceo/UserManagement\"));\nconst InvestorDatabase = lazy(() => import(\"@/pages/ceo/InvestorDatabase\"));\nconst DealTemplates = lazy(() => import(\"@/pages/shared/DealTemplates\"));\nconst DocumentManagement = lazy(() => import(\"@/pages/shared/DocumentManagement\"));\nconst AuditLogs = lazy(() => import(\"@/pages/ceo/AuditLogs\"));\nconst Opportunities = lazy(() => import(\"@/pages/ceo/Opportunities\"));\nconst AssetManagement = lazy(() => import(\"@/pages/employee/AssetManagement\"));\nconst PortalLogin = lazy(() => import(\"@/pages/portal/PortalLogin\"));\nconst PortalRegister = lazy(() => import(\"@/pages/portal/PortalRegister\"));\nconst PortalDashboard = lazy(() => import(\"@/pages/portal/PortalDashboard\"));\nconst Forms = lazy(() => import(\"@/pages/shared/Forms\"));\nconst PublicForm = lazy(() => import(\"@/pages/shared/PublicForm\"));\nconst TaskTemplates = lazy(() => import(\"@/pages/shared/TaskTemplates\"));\nconst PersonalityAssessment = lazy(() => import(\"@/pages/shared/PersonalityAssessment\"));\nconst ResumeOnboarding = lazy(() => import(\"@/pages/shared/ResumeOnboarding\"));\n\n// Wrapper components to ensure props are passed correctly with wouter\nconst CeoDealManagement = () => <DealManagement role=\"CEO\" />;\nconst EmployeeDealManagement = () => <DealManagement role=\"Employee\" />;\nconst CeoChat = () => <Chat role=\"CEO\" />;\nconst EmployeeChat = () => <Chat role=\"Employee\" />;\nconst CeoClientPortal = () => <ClientPortal role=\"CEO\" />;\nconst CeoMentorshipPairing = () => <MentorshipPairing role=\"CEO\" />;\nconst CeoGoalSettingOKRs = () => <GoalSettingOKRs role=\"CEO\" />;\nconst EmployeeGoalSettingOKRs = () => <GoalSettingOKRs role=\"Employee\" />;\nconst CeoDealAnnouncements = () => <DealAnnouncements role=\"CEO\" />;\nconst EmployeeDealAnnouncements = () => <DealAnnouncements role=\"Employee\" />;\nconst CeoStakeholderDirectory = () => <StakeholderDirectory role=\"CEO\" />;\nconst EmployeeStakeholderDirectory = () => <StakeholderDirectory role=\"Employee\" />;\nconst CeoEventCalendar = () => <EventCalendar role=\"CEO\" />;\nconst EmployeeEventCalendar = () => <EventCalendar role=\"Employee\" />;\nconst CeoDealTemplates = () => <DealTemplates role=\"CEO\" />;\nconst CeoDocumentGenerator = () => <DocumentManagement role=\"CEO\" defaultTab=\"templates\" />;\nconst EmployeeDocumentGenerator = () => <DocumentManagement role=\"Employee\" defaultTab=\"templates\" />;\nconst CeoDocumentLibrary = () => <DocumentManagement role=\"CEO\" defaultTab=\"library\" />;\nconst EmployeeDocumentLibrary = () => <DocumentManagement role=\"Employee\" defaultTab=\"library\" />;\nconst CeoMyTasks = () => <MyTasks role=\"CEO\" />;\n\nfunction ProtectedRoute({ component: Component }: { component: React.ComponentType }) {\n  const { data: user, isLoading } = useCurrentUser();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/\");\n    }\n  }, [user, isLoading, setLocation]);\n\n  if (isLoading) {\n    return <PageLoader />;\n  }\n\n  if (!user) {\n    return null;\n  }\n\n  return <Component />;\n}\n\nfunction WelcomeModalWrapper({ children }: { children: React.ReactNode }) {\n  const { data: user } = useCurrentUser();\n  const { data: preferences, isLoading: prefsLoading, isSuccess } = useUserPreferences();\n  const updatePreferences = useUpdateUserPreferences();\n  const [showWelcome, setShowWelcome] = useState(false);\n  const [checkedUserId, setCheckedUserId] = useState<string | null>(null);\n\n  useEffect(() => {\n    // Only check when:\n    // 1. User is logged in\n    // 2. Preferences query succeeded  \n    // 3. Preferences data exists (not null from 401)\n    // 4. Haven't checked this user yet\n    if (user && !prefsLoading && isSuccess && preferences && checkedUserId !== user.id) {\n      setCheckedUserId(user.id);\n      // Show welcome modal if hasSeenWelcome is false, undefined, or null (new users)\n      const hasNotSeenWelcome = !preferences?.hasSeenWelcome;\n      if (hasNotSeenWelcome) {\n        setShowWelcome(true);\n      }\n    }\n  }, [user, preferences, prefsLoading, checkedUserId, isSuccess]);\n\n  const handleCloseWelcome = () => {\n    setShowWelcome(false);\n    updatePreferences.mutate({ hasSeenWelcome: true }, {\n      onError: (error) => {\n        console.error('Failed to save welcome preference:', error);\n      }\n    });\n  };\n\n  return (\n    <>\n      {children}\n      {user && (\n        <WelcomeModal \n          isOpen={showWelcome} \n          onClose={handleCloseWelcome}\n          userName={user.name?.split(' ')[0]}\n        />\n      )}\n    </>\n  );\n}\n\nfunction PortalProtectedRoute({ component: Component }: { component: React.ComponentType }) {\n  const { data: user, isLoading } = useCurrentUser();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/portal/login\");\n    }\n  }, [user, isLoading, setLocation]);\n\n  useEffect(() => {\n    if (!isLoading && user && user.role !== 'External') {\n      if (user.accessLevel === 'admin') {\n        setLocation(\"/ceo/dashboard\");\n      } else {\n        setLocation(\"/employee/home\");\n      }\n    }\n  }, [user, isLoading, setLocation]);\n\n  if (isLoading) {\n    return <PageLoader />;\n  }\n\n  if (!user || user.role !== 'External') {\n    return null;\n  }\n\n  return <Component />;\n}\n\nfunction Router() {\n  const { data: user, refetch } = useCurrentUser();\n  const [location, setLocation] = useLocation();\n  const sessionExpiredHandled = useRef(false);\n\n  const handleSessionExpired = useCallback(() => {\n    if (sessionExpiredHandled.current) return;\n    if (location === \"/\" || location === \"/auth\" || location.startsWith(\"/portal/login\") || location.startsWith(\"/form/\")) return;\n    \n    sessionExpiredHandled.current = true;\n    \n    toast.error(\"Your session has expired. Please log in again.\", {\n      duration: 5000,\n      id: \"session-expired\",\n    });\n    \n    queryClient.clear();\n    \n    setTimeout(() => {\n      setLocation(\"/\");\n      sessionExpiredHandled.current = false;\n    }, 500);\n  }, [location, setLocation]);\n\n  useEffect(() => {\n    const unsubscribe = onSessionExpired(handleSessionExpired);\n    return unsubscribe;\n  }, [handleSessionExpired]);\n\n  useEffect(() => {\n    const welcomePending = sessionStorage.getItem('welcomePending');\n    if (welcomePending === 'true') {\n      return;\n    }\n    \n    if (user && location === \"/\") {\n      if (user.accessLevel === 'admin') {\n        setLocation(\"/ceo/dashboard\");\n      } else {\n        setLocation(\"/employee/home\");\n      }\n    }\n  }, [user, location, setLocation]);\n\n  return (\n    <Suspense fallback={<PageLoader />}>\n      <Switch>\n        <Route path=\"/\" component={AuthPage} />\n        <Route path=\"/auth\" component={AuthPage} />\n        <Route path=\"/reset-password\" component={ResetPassword} />\n        <Route path=\"/form/:shareToken\" component={PublicForm} />\n        \n        {/* CEO Routes */}\n        <Route path=\"/ceo/dashboard\">\n          {() => <ProtectedRoute component={Dashboard} />}\n        </Route>\n        <Route path=\"/ceo/deals\">\n          {() => <ProtectedRoute component={CeoDealManagement} />}\n        </Route>\n        <Route path=\"/ceo/documents\">\n          {() => <ProtectedRoute component={CeoDocumentGenerator} />}\n        </Route>\n        <Route path=\"/ceo/investors\">\n          {() => <ProtectedRoute component={InvestorMatching} />}\n        </Route>\n        <Route path=\"/ceo/team\">\n          {() => <ProtectedRoute component={TeamAssignment} />}\n        </Route>\n        <Route path=\"/ceo/chat\">\n          {() => <ProtectedRoute component={CeoChat} />}\n        </Route>\n        <Route path=\"/ceo/team-performance\">\n          {() => <ProtectedRoute component={TeamPerformance} />}\n        </Route>\n        <Route path=\"/ceo/team-profiles\">\n          {() => <ProtectedRoute component={TeamProfiles} />}\n        </Route>\n        <Route path=\"/ceo/investor-crm\">\n          {() => <ProtectedRoute component={InvestorCRM} />}\n        </Route>\n        <Route path=\"/ceo/client-portal\">\n          {() => <ProtectedRoute component={CeoClientPortal} />}\n        </Route>\n        <Route path=\"/ceo/mentorship\">\n          {() => <ProtectedRoute component={CeoMentorshipPairing} />}\n        </Route>\n        <Route path=\"/ceo/okrs\">\n          {() => <ProtectedRoute component={CeoGoalSettingOKRs} />}\n        </Route>\n        <Route path=\"/ceo/announcements\">\n          {() => <ProtectedRoute component={CeoDealAnnouncements} />}\n        </Route>\n        <Route path=\"/ceo/calendar\">\n          {() => <ProtectedRoute component={CeoEventCalendar} />}\n        </Route>\n        <Route path=\"/ceo/stakeholders\">\n          {() => <ProtectedRoute component={CeoStakeholderDirectory} />}\n        </Route>\n        <Route path=\"/ceo/admin\">\n          {() => <ProtectedRoute component={UserManagement} />}\n        </Route>\n        <Route path=\"/ceo/investor-database\">\n          {() => <ProtectedRoute component={InvestorDatabase} />}\n        </Route>\n        <Route path=\"/ceo/audit-logs\">\n          {() => <ProtectedRoute component={() => <AuditLogs role=\"CEO\" />} />}\n        </Route>\n        <Route path=\"/ceo/deal-templates\">\n          {() => <ProtectedRoute component={CeoDealTemplates} />}\n        </Route>\n        <Route path=\"/ceo/document-library\">\n          {() => <ProtectedRoute component={CeoDocumentLibrary} />}\n        </Route>\n        <Route path=\"/ceo/opportunities\">\n          {() => <ProtectedRoute component={Opportunities} />}\n        </Route>\n        <Route path=\"/ceo/asset-management\">\n          {() => <ProtectedRoute component={() => <AssetManagement role=\"CEO\" />} />}\n        </Route>\n        <Route path=\"/ceo/tasks\">\n          {() => <ProtectedRoute component={CeoMyTasks} />}\n        </Route>\n        <Route path=\"/ceo/forms\">\n          {() => <ProtectedRoute component={Forms} />}\n        </Route>\n        <Route path=\"/ceo/task-templates\">\n          {() => <ProtectedRoute component={TaskTemplates} />}\n        </Route>\n        <Route path=\"/ceo/personality-assessment\">\n          {() => <ProtectedRoute component={PersonalityAssessment} />}\n        </Route>\n        <Route path=\"/ceo/resume-onboarding\">\n          {() => <ProtectedRoute component={ResumeOnboarding} />}\n        </Route>\n        \n        {/* Employee Routes */}\n        <Route path=\"/employee/home\">\n          {() => <ProtectedRoute component={EmployeeHome} />}\n        </Route>\n        <Route path=\"/employee/tasks\">\n          {() => <ProtectedRoute component={MyTasks} />}\n        </Route>\n        <Route path=\"/employee/documents\">\n          {() => <ProtectedRoute component={EmployeeDocumentGenerator} />}\n        </Route>\n        <Route path=\"/employee/opportunities\">\n          {() => <ProtectedRoute component={() => <Opportunities role=\"Employee\" />} />}\n        </Route>\n        <Route path=\"/employee/deals\">\n          {() => <ProtectedRoute component={EmployeeDealManagement} />}\n        </Route>\n        <Route path=\"/employee/investors\">\n          {() => <ProtectedRoute component={EmployeeInvestorMatching} />}\n        </Route>\n        <Route path=\"/employee/chat\">\n          {() => <ProtectedRoute component={EmployeeChat} />}\n        </Route>\n        <Route path=\"/employee/calendar\">\n          {() => <ProtectedRoute component={EmployeeEventCalendar} />}\n        </Route>\n        <Route path=\"/employee/okrs\">\n          {() => <ProtectedRoute component={EmployeeGoalSettingOKRs} />}\n        </Route>\n        <Route path=\"/employee/announcements\">\n          {() => <ProtectedRoute component={EmployeeDealAnnouncements} />}\n        </Route>\n        <Route path=\"/employee/stakeholders\">\n          {() => <ProtectedRoute component={EmployeeStakeholderDirectory} />}\n        </Route>\n        <Route path=\"/employee/document-library\">\n          {() => <ProtectedRoute component={EmployeeDocumentLibrary} />}\n        </Route>\n        <Route path=\"/employee/asset-management\">\n          {() => <ProtectedRoute component={AssetManagement} />}\n        </Route>\n        <Route path=\"/employee/audit-logs\">\n          {() => <ProtectedRoute component={() => <AuditLogs role=\"Employee\" />} />}\n        </Route>\n        <Route path=\"/employee/forms\">\n          {() => <ProtectedRoute component={Forms} />}\n        </Route>\n        <Route path=\"/employee/task-templates\">\n          {() => <ProtectedRoute component={TaskTemplates} />}\n        </Route>\n        <Route path=\"/employee/personality-assessment\">\n          {() => <ProtectedRoute component={PersonalityAssessment} />}\n        </Route>\n        <Route path=\"/employee/resume-onboarding\">\n          {() => <ProtectedRoute component={ResumeOnboarding} />}\n        </Route>\n        \n        {/* External Portal Routes */}\n        <Route path=\"/portal/login\" component={PortalLogin} />\n        <Route path=\"/portal/register/:token\" component={PortalRegister} />\n        <Route path=\"/portal\">\n          {() => <PortalProtectedRoute component={PortalDashboard} />}\n        </Route>\n\n        <Route component={NotFound} />\n      </Switch>\n    </Suspense>\n  );\n}\n\nfunction App() {\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <DashboardProvider>\n          <TooltipProvider>\n            <Toaster />\n            <WelcomeModalWrapper>\n              <Router />\n            </WelcomeModalWrapper>\n          </TooltipProvider>\n        </DashboardProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":15780,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":792,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/index.css":{"content":"@import \"tailwindcss\";\n@import \"tw-animate-css\";\n\n@custom-variant dark (&:is(.dark *));\n\n@theme inline {\n  /* Fintech Navy Theme */\n  --color-background: hsl(222 47% 11%); /* Deep Navy #0f172a */\n  --color-foreground: hsl(210 40% 98%); /* White-ish */\n\n  --color-card: hsl(217 33% 17%); /* Lighter Navy #1e293b */\n  --color-card-foreground: hsl(210 40% 98%);\n\n  --color-popover: hsl(222 47% 11%);\n  --color-popover-foreground: hsl(210 40% 98%);\n\n  --color-primary: hsl(217 91% 60%); /* Bright Blue */\n  --color-primary-foreground: hsl(222 47% 11%);\n\n  --color-secondary: hsl(217 33% 17%);\n  --color-secondary-foreground: hsl(210 40% 98%);\n\n  --color-muted: hsl(217 33% 17%);\n  --color-muted-foreground: hsl(215 20% 65%);\n\n  --color-accent: hsl(43 96% 64%); /* Gold/Yellow for active states */\n  --color-accent-foreground: hsl(222 47% 11%);\n\n  --color-destructive: hsl(0 62% 30%);\n  --color-destructive-foreground: hsl(210 40% 98%);\n\n  --color-border: hsl(217 33% 22%);\n  --color-input: hsl(217 33% 22%);\n  --color-ring: hsl(224 76% 48%);\n\n  --color-chart-1: hsl(210 100% 56%);  /* Vivid Electric Blue */\n  --color-chart-2: hsl(45 100% 55%);   /* Bright Gold/Yellow */\n  --color-chart-3: hsl(160 84% 45%);   /* Vibrant Emerald Green */\n  --color-chart-4: hsl(280 85% 60%);   /* Rich Purple/Violet */\n  --color-chart-5: hsl(350 92% 58%);   /* Vivid Coral/Red */\n\n  --color-sidebar: hsl(222 47% 10%); /* Slightly darker than bg */\n  --color-sidebar-foreground: hsl(210 40% 98%);\n  --color-sidebar-primary: hsl(217 91% 60%);\n  --color-sidebar-primary-foreground: hsl(0 0% 100%);\n  --color-sidebar-accent: hsl(217 33% 15%);\n  --color-sidebar-accent-foreground: hsl(210 40% 98%);\n  --color-sidebar-border: hsl(217 33% 20%);\n  --color-sidebar-ring: hsl(217 91% 60%);\n\n  --font-sans: 'Inter', sans-serif;\n  --font-display: 'Plus Jakarta Sans', sans-serif;\n  --font-mono: 'Space Mono', monospace;\n\n  --radius: 0.5rem;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n  h1, h2, h3, h4, h5, h6 {\n    @apply font-display tracking-tight;\n  }\n}\n\n/* React Grid Layout Styles */\n.react-grid-layout {\n  position: relative;\n  transition: height 200ms ease;\n}\n\n.react-grid-item {\n  transition: all 200ms ease;\n  transition-property: left, top, width, height;\n}\n\n.react-grid-item.cssTransforms {\n  transition-property: transform, width, height;\n}\n\n.react-grid-item.resizing {\n  z-index: 1;\n  will-change: width, height;\n  transition: none;\n}\n\n.react-grid-item.react-draggable-dragging {\n  z-index: 3;\n  will-change: transform;\n  transition: none;\n}\n\n.react-grid-item.dropping {\n  visibility: hidden;\n}\n\n.react-grid-item.react-grid-placeholder {\n  background: hsl(217 91% 60% / 0.2);\n  border: 2px dashed hsl(217 91% 60% / 0.5);\n  border-radius: var(--radius);\n  z-index: 2;\n  user-select: none;\n}\n\n.react-resizable-handle {\n  position: absolute;\n  width: 20px;\n  height: 20px;\n  background-repeat: no-repeat;\n  background-origin: content-box;\n  box-sizing: border-box;\n  opacity: 0;\n  transition: opacity 200ms ease;\n}\n\n.react-grid-item:hover .react-resizable-handle {\n  opacity: 1;\n}\n\n.react-resizable-handle::after {\n  content: \"\";\n  position: absolute;\n  right: 3px;\n  bottom: 3px;\n  width: 8px;\n  height: 8px;\n  border-right: 2px solid hsl(var(--muted-foreground) / 0.5);\n  border-bottom: 2px solid hsl(var(--muted-foreground) / 0.5);\n}\n\n.react-resizable-handle-se {\n  bottom: 0;\n  right: 0;\n  cursor: se-resize;\n}\n\n.react-resizable-handle-sw {\n  bottom: 0;\n  left: 0;\n  cursor: sw-resize;\n}\n\n.react-resizable-handle-sw::after {\n  right: auto;\n  left: 3px;\n  border-right: none;\n  border-left: 2px solid hsl(var(--muted-foreground) / 0.5);\n}\n\n.react-resizable-handle-nw {\n  top: 0;\n  left: 0;\n  cursor: nw-resize;\n}\n\n.react-resizable-handle-nw::after {\n  right: auto;\n  bottom: auto;\n  left: 3px;\n  top: 3px;\n  border-right: none;\n  border-bottom: none;\n  border-left: 2px solid hsl(var(--muted-foreground) / 0.5);\n  border-top: 2px solid hsl(var(--muted-foreground) / 0.5);\n}\n\n.react-resizable-handle-ne {\n  top: 0;\n  right: 0;\n  cursor: ne-resize;\n}\n\n.react-resizable-handle-ne::after {\n  bottom: auto;\n  top: 3px;\n  border-bottom: none;\n  border-top: 2px solid hsl(var(--muted-foreground) / 0.5);\n}\n\n.react-resizable-handle-w,\n.react-resizable-handle-e {\n  top: 50%;\n  margin-top: -10px;\n  cursor: ew-resize;\n}\n\n.react-resizable-handle-w {\n  left: 0;\n}\n\n.react-resizable-handle-e {\n  right: 0;\n}\n\n.react-resizable-handle-n,\n.react-resizable-handle-s {\n  left: 50%;\n  margin-left: -10px;\n  cursor: ns-resize;\n}\n\n.react-resizable-handle-n {\n  top: 0;\n}\n\n.react-resizable-handle-s {\n  bottom: 0;\n}\n\n/* Custom Scrollbar for dark theme */\n::-webkit-scrollbar {\n  width: 8px;\n  height: 8px;\n}\n::-webkit-scrollbar-track {\n  background: hsl(222 47% 11%);\n}\n::-webkit-scrollbar-thumb {\n  background: hsl(217 33% 25%);\n  border-radius: 4px;\n}\n::-webkit-scrollbar-thumb:hover {\n  background: hsl(217 33% 35%);\n}\n\n/* Utility classes for glassmorphism if needed */\n.glass-panel {\n  background: rgba(30, 41, 59, 0.7);\n  backdrop-filter: blur(12px);\n  -webkit-backdrop-filter: blur(12px);\n  border: 1px solid rgba(255, 255, 255, 0.05);\n}\n\n/* Compact view mode - reduces spacing throughout the app */\n:root {\n  --spacing-multiplier: 1;\n}\n\n.compact-view {\n  --spacing-multiplier: 0.7;\n  font-size: 0.95em;\n}\n\n/* Apply compact spacing to common container classes */\n.compact-view [class*=\"p-4\"],\n.compact-view [class*=\"p-6\"],\n.compact-view [class*=\"p-8\"] {\n  padding: calc(var(--spacing-multiplier) * 1rem) !important;\n}\n\n.compact-view [class*=\"py-4\"],\n.compact-view [class*=\"py-6\"] {\n  padding-top: calc(var(--spacing-multiplier) * 0.75rem) !important;\n  padding-bottom: calc(var(--spacing-multiplier) * 0.75rem) !important;\n}\n\n.compact-view [class*=\"px-4\"],\n.compact-view [class*=\"px-6\"] {\n  padding-left: calc(var(--spacing-multiplier) * 1rem) !important;\n  padding-right: calc(var(--spacing-multiplier) * 1rem) !important;\n}\n\n/* Reduce gaps in flex and grid containers */\n.compact-view [class*=\"gap-4\"],\n.compact-view [class*=\"gap-6\"],\n.compact-view [class*=\"gap-8\"] {\n  gap: calc(var(--spacing-multiplier) * 0.75rem) !important;\n}\n\n/* Reduce space between stacked elements */\n.compact-view [class*=\"space-y-4\"] > * + *,\n.compact-view [class*=\"space-y-6\"] > * + *,\n.compact-view [class*=\"space-y-8\"] > * + * {\n  margin-top: calc(var(--spacing-multiplier) * 0.75rem) !important;\n}\n\n/* Reduce card padding */\n.compact-view [class*=\"CardContent\"] {\n  padding: calc(var(--spacing-multiplier) * 0.75rem) !important;\n}\n\n/* Reduce text sizes slightly */\n.compact-view .text-2xl {\n  font-size: 1.25rem !important;\n}\n\n.compact-view .text-xl {\n  font-size: 1rem !important;\n}\n\n.compact-view .text-lg {\n  font-size: 0.95rem !important;\n}\n\n/* Reduce button and input heights */\n.compact-view button,\n.compact-view input,\n.compact-view select,\n.compact-view textarea {\n  min-height: auto;\n}\n\n.compact-view [class*=\"h-10\"],\n.compact-view [class*=\"h-12\"] {\n  height: auto !important;\n  min-height: 2rem !important;\n}\n\n/* No animations mode - disables all transitions and animations */\n.no-animations,\n.no-animations * {\n  animation-duration: 0s !important;\n  animation-delay: 0s !important;\n  transition-duration: 0s !important;\n  transition-delay: 0s !important;\n}\n\n.no-animations .animate-spin,\n.no-animations .animate-pulse,\n.no-animations .animate-bounce {\n  animation: none !important;\n}\n","path":null,"size_bytes":7432,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7606,"size_tokens":null},"client/src/pages/employee/MyTasks.tsx":{"content":"import { useState, useEffect, useRef, useMemo } from \"react\";\nimport { useSearch, useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { motion, AnimatePresence, useMotionValue, useTransform, PanInfo } from \"framer-motion\";\nimport { \n  Calendar, \n  Clock, \n  AlertCircle, \n  FileText, \n  MessageSquare, \n  BarChart,\n  Check,\n  Search,\n  ChevronLeft,\n  ChevronRight,\n  ArrowUp,\n  ArrowDown,\n  Send,\n  Sparkles,\n  User,\n  Briefcase,\n  Paperclip,\n  ExternalLink,\n  X,\n  Loader2,\n  Brain,\n  Flag,\n  Plus,\n  Trash2,\n  Upload,\n  Download,\n  Pencil,\n  FileEdit,\n  Mail,\n  ListChecks\n} from \"lucide-react\";\nimport { useCurrentUser, useTasks, useDealsListing, useUpdateTask, useCreateTask, useDeleteTask, useUsers, apiRequest, useUserPreferences, useSaveUserPreferences, useCreateTaskAttachment, useStakeholders, useCreateStakeholder } from \"@/lib/api\";\nimport type { Stakeholder } from \"@shared/schema\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport type { UserPreferences } from \"@shared/schema\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format, parseISO, isToday, isBefore, addDays, startOfWeek, endOfWeek, isWithinInterval } from \"date-fns\";\nimport type { Task, Deal } from \"@shared/schema\";\n\ntype SwipeDirection = 'left' | 'right' | 'up' | null;\n\n// Helper to format due date with optional time\nconst formatDueDateTime = (dueDate: string) => {\n  if (!dueDate) return '';\n  try {\n    if (dueDate.includes('T')) {\n      // Has time component\n      const date = new Date(dueDate);\n      return format(date, 'MMM d, yyyy h:mm a');\n    } else {\n      // Date only\n      const date = parseISO(dueDate);\n      return format(date, 'MMM d, yyyy');\n    }\n  } catch {\n    return dueDate;\n  }\n};\n\n// Check if task is overdue - properly handles datetime comparison in LOCAL timezone\nconst isTaskOverdue = (dueDate: string, status: string) => {\n  if (!dueDate || status === 'Completed' || status === 'Overdue') return false;\n  try {\n    const now = new Date();\n    let dueDateTime: Date;\n    \n    if (dueDate.includes('T')) {\n      // Has time component - ALWAYS parse as local time to avoid UTC confusion\n      const [datePart, timePart] = dueDate.split('T');\n      const [year, month, day] = datePart.split('-').map(Number);\n      const timeParts = timePart.replace('Z', '').split(':');\n      const hours = parseInt(timeParts[0]) || 0;\n      const minutes = parseInt(timeParts[1]) || 0;\n      const seconds = parseInt(timeParts[2]) || 0;\n      dueDateTime = new Date(year, month - 1, day, hours, minutes, seconds);\n    } else {\n      // Date only - treat as end of day (23:59:59) in local timezone\n      const [year, month, day] = dueDate.split('-').map(Number);\n      dueDateTime = new Date(year, month - 1, day, 23, 59, 59);\n    }\n    \n    return dueDateTime < now;\n  } catch (e) {\n    console.error('isTaskOverdue error:', e);\n    return false;\n  }\n};\n\ntype UploadedFile = {\n  id: string;\n  filename: string;\n  url: string;\n  size: number;\n  type: string;\n  uploadedAt: string;\n};\n\n// Helper to render text with clickable links\nconst renderTextWithLinks = (text: string) => {\n  if (!text) return null;\n  const urlRegex = /(https?:\\/\\/[^\\s]+)/g;\n  const parts = text.split(urlRegex);\n  \n  return parts.map((part, index) => {\n    if (part.match(urlRegex)) {\n      return (\n        <a\n          key={index}\n          href={part}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"text-primary hover:underline inline-flex items-center gap-1\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {part}\n          <ExternalLink className=\"w-3 h-3 inline\" />\n        </a>\n      );\n    }\n    return <span key={index}>{part}</span>;\n  });\n};\n\ntype AppSuggestion = {\n  name: string;\n  icon: string;\n  description: string;\n  url?: string;\n  localProtocol?: string;\n  macFallback?: string;\n  winFallback?: string;\n  action: 'open' | 'create' | 'edit';\n};\n\n// Detect user's operating system\nconst getOS = (): 'mac' | 'windows' | 'other' => {\n  const platform = navigator.platform.toLowerCase();\n  const userAgent = navigator.userAgent.toLowerCase();\n  if (platform.includes('mac') || userAgent.includes('mac')) return 'mac';\n  if (platform.includes('win') || userAgent.includes('win')) return 'windows';\n  return 'other';\n};\n\n\nconst APP_CATALOG: Record<string, AppSuggestion> = {\n  'excel': { \n    name: 'Spreadsheet', \n    icon: '', \n    description: 'Create or edit spreadsheets', \n    localProtocol: 'ms-excel:', \n    macFallback: 'https://www.icloud.com/numbers',\n    url: 'https://www.office.com/launch/excel', \n    action: 'create' \n  },\n  'word': { \n    name: 'Word Processor', \n    icon: '', \n    description: 'Create or edit documents', \n    localProtocol: 'ms-word:', \n    macFallback: 'https://www.icloud.com/pages',\n    url: 'https://www.office.com/launch/word', \n    action: 'create' \n  },\n  'powerpoint': { \n    name: 'Presentations', \n    icon: '', \n    description: 'Create presentations', \n    localProtocol: 'ms-powerpoint:', \n    macFallback: 'https://www.icloud.com/keynote',\n    url: 'https://www.office.com/launch/powerpoint', \n    action: 'create' \n  },\n  'google_docs': { name: 'Google Docs', icon: '', description: 'Create or edit documents', url: 'https://docs.google.com/document/create', action: 'create' },\n  'google_sheets': { name: 'Google Sheets', icon: '', description: 'Create or edit spreadsheets', url: 'https://docs.google.com/spreadsheets/create', action: 'create' },\n  'google_slides': { name: 'Google Slides', icon: '', description: 'Create presentations', url: 'https://docs.google.com/presentation/create', action: 'create' },\n  'email': { name: 'Email Client', icon: '', description: 'Send emails', url: 'mailto:', action: 'open' },\n  'calendar': { name: 'Calendar', icon: '', description: 'Schedule meetings', localProtocol: 'webcal:', url: 'https://calendar.google.com', action: 'open' },\n  'pdf_editor': { name: 'PDF Editor', icon: '', description: 'Edit PDF documents', url: 'https://www.adobe.com/acrobat/online/pdf-editor.html', action: 'edit' },\n  'bloomberg': { name: 'Bloomberg', icon: '', description: 'Financial data & analysis', url: 'https://www.bloomberg.com', action: 'open' },\n  'pitchbook': { name: 'PitchBook', icon: '', description: 'Deal & investor data', url: 'https://pitchbook.com', action: 'open' },\n  'capital_iq': { name: 'Capital IQ', icon: '', description: 'Financial research', url: 'https://www.capitaliq.com', action: 'open' },\n  'factset': { name: 'FactSet', icon: '', description: 'Financial data platform', url: 'https://www.factset.com', action: 'open' },\n  'docusign': { name: 'DocuSign', icon: '', description: 'Electronic signatures', url: 'https://www.docusign.com', action: 'open' },\n  'zoom': { name: 'Zoom', icon: '', description: 'Video meetings', localProtocol: 'zoommtg:', url: 'https://zoom.us', action: 'open' },\n  'teams': { name: 'Microsoft Teams', icon: '', description: 'Team collaboration', localProtocol: 'msteams:', url: 'https://teams.microsoft.com', action: 'open' },\n  'slack': { name: 'Slack', icon: '', description: 'Team messaging', localProtocol: 'slack:', url: 'https://slack.com', action: 'open' },\n  'notion': { name: 'Notion', icon: '', description: 'Notes & documentation', localProtocol: 'notion:', url: 'https://www.notion.so', action: 'open' },\n};\n\ntype MyTasksProps = {\n  role?: 'CEO' | 'Employee';\n};\n\nexport default function MyTasks({ role = 'Employee' }: MyTasksProps) {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const { data: currentUser } = useCurrentUser();\n  const { data: allTasks = [], isLoading } = useTasks();\n  const { data: deals = [] } = useDealsListing();\n  const { data: users = [] } = useUsers();\n  const { data: stakeholdersData } = useStakeholders({ pageSize: 1000 });\n  const stakeholders = stakeholdersData?.stakeholders || [];\n  const createStakeholder = useCreateStakeholder();\n  const updateTask = useUpdateTask();\n  const createTask = useCreateTask();\n  const deleteTask = useDeleteTask();\n  const createTaskAttachment = useCreateTaskAttachment();\n  const queryClient = useQueryClient();\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  \n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showCreateTaskModal, setShowCreateTaskModal] = useState(false);\n  const [newTaskForm, setNewTaskForm] = useState({\n    title: '',\n    description: '',\n    priority: 'Medium' as 'Low' | 'Medium' | 'High' | 'Urgent',\n    dueDate: '',\n    dueTime: '',\n    dealId: '',\n    type: 'General' as 'General' | 'Document Review' | 'Due Diligence' | 'Client Communication' | 'Financial Analysis' | 'Legal' | 'Compliance'\n  });\n  const [uploadedFiles, setUploadedFiles] = useState<UploadedFile[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [isDragging, setIsDragging] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [showSearchResults, setShowSearchResults] = useState(false);\n  const [highlightedTaskId, setHighlightedTaskId] = useState<string | null>(null);\n  const [currentSwipeIndex, setCurrentSwipeIndex] = useState(0);\n  const [selectedTask, setSelectedTask] = useState<Task | null>(null);\n  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);\n  const [showForwardModal, setShowForwardModal] = useState(false);\n  const [showAIModal, setShowAIModal] = useState(false);\n  const [showEditTaskModal, setShowEditTaskModal] = useState(false);\n  const [editTaskForm, setEditTaskForm] = useState({\n    id: '',\n    title: '',\n    description: '',\n    priority: 'Medium' as 'Low' | 'Medium' | 'High' | 'Urgent',\n    dueDate: '',\n    dueTime: '',\n    dealId: '',\n    type: 'General' as 'General' | 'Document Review' | 'Due Diligence' | 'Client Communication' | 'Financial Analysis' | 'Legal' | 'Compliance',\n    status: 'Pending' as string\n  });\n  const [editAttachments, setEditAttachments] = useState<UploadedFile[]>([]);\n  const [forwardToUser, setForwardToUser] = useState<string>(\"\");\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [aiSuggestion, setAiSuggestion] = useState<{action: string, reasoning: string, tools: string[], apps?: AppSuggestion[]} | null>(null);\n  const [deferredTasks, setDeferredTasks] = useState<string[]>([]);\n  const [workingTask, setWorkingTask] = useState<Task | null>(null);\n  const [showSendWorkModal, setShowSendWorkModal] = useState(false);\n  const [completedWorkNotes, setCompletedWorkNotes] = useState(\"\");\n  const [sendWorkAttachments, setSendWorkAttachments] = useState<UploadedFile[]>([]);\n  \n  // Enhanced Send Work modal state\n  const [sendWorkTab, setSendWorkTab] = useState<'internal' | 'external'>('internal');\n  const [selectedInternalUsers, setSelectedInternalUsers] = useState<string[]>([]);\n  const [internalUserSearch, setInternalUserSearch] = useState(\"\");\n  const [externalRecipientId, setExternalRecipientId] = useState<string>(\"\");\n  const [externalRecipientEmail, setExternalRecipientEmail] = useState(\"\");\n  const [externalRecipientName, setExternalRecipientName] = useState(\"\");\n  const [externalRecipientCompany, setExternalRecipientCompany] = useState(\"\");\n  const [externalEmailMessage, setExternalEmailMessage] = useState(\"\");\n  const [stakeholderSearch, setStakeholderSearch] = useState(\"\");\n  const [showAddNewContact, setShowAddNewContact] = useState(false);\n  const [isSendingExternal, setIsSendingExternal] = useState(false);\n  \n  // Flagged tasks - persisted to user_preferences.settings.flaggedTasks\n  const [flaggedTasks, setFlaggedTasks] = useState<Record<string, string>>({});\n  const [flaggedTasksInitialized, setFlaggedTasksInitialized] = useState(false);\n  const prevFlaggedRef = useRef<string | null>(null);\n  \n  // Load flagged tasks from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !flaggedTasksInitialized) {\n      const savedFlagged = (userPrefs?.settings as any)?.flaggedTasks;\n      if (savedFlagged && typeof savedFlagged === 'object') {\n        setFlaggedTasks(savedFlagged);\n      }\n      setFlaggedTasksInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, flaggedTasksInitialized]);\n  \n  // Flag note dialog state\n  const [showFlagNoteDialog, setShowFlagNoteDialog] = useState(false);\n  const [flagNoteTaskId, setFlagNoteTaskId] = useState<string | null>(null);\n  const [flagNote, setFlagNote] = useState(\"\");\n  \n  const openFlagDialog = (taskId: string) => {\n    if (flaggedTasks[taskId]) {\n      unflagTask(taskId);\n    } else {\n      setFlagNoteTaskId(taskId);\n      setFlagNote(\"\");\n      setShowFlagNoteDialog(true);\n    }\n  };\n  \n  const saveFlaggedTasksToDb = (newFlaggedTasks: Record<string, string>) => {\n    const freshPrefs = queryClient.getQueryData<UserPreferences>(['userPreferences']) || userPrefs;\n    const { id, userId, updatedAt, ...mutablePrefs } = (freshPrefs || {}) as any;\n    const existingSettings = (freshPrefs?.settings as any) || {};\n    saveUserPrefs.mutate({\n      ...mutablePrefs,\n      settings: {\n        ...existingSettings,\n        flaggedTasks: newFlaggedTasks,\n      },\n    });\n  };\n  \n  const unflagTask = (taskId: string) => {\n    const newFlaggedTasks = { ...flaggedTasks };\n    delete newFlaggedTasks[taskId];\n    setFlaggedTasks(newFlaggedTasks);\n    saveFlaggedTasksToDb(newFlaggedTasks);\n    toast.info(\"Task unflagged\");\n  };\n  \n  const confirmFlag = async () => {\n    if (!flagNoteTaskId) return;\n    \n    const newFlaggedTasks = { ...flaggedTasks, [flagNoteTaskId]: flagNote };\n    setFlaggedTasks(newFlaggedTasks);\n    saveFlaggedTasksToDb(newFlaggedTasks);\n    \n    const task = myTasks.find(t => t.id === flagNoteTaskId);\n    if (task && task.dealId) {\n      const deal = getDeal(task.dealId);\n      if (deal) {\n        try {\n          const result = await apiRequest('POST', '/api/notifications/flag', {\n            taskId: flagNoteTaskId,\n            taskTitle: task.title,\n            dealId: deal.id,\n            dealName: deal.name,\n            flaggedBy: currentUser?.name || 'Team member',\n            flagNote: flagNote || undefined,\n          });\n          const data = await result.json();\n          if (data.notifiedCount > 0) {\n            toast.success(`Task flagged! ${data.notifiedCount} pod team member(s) notified.`);\n          } else {\n            toast.success(\"Task flagged!\");\n          }\n        } catch (error) {\n          toast.error(\"Task flagged but failed to notify team. Please try again.\");\n        }\n      } else {\n        toast.success(\"Task flagged!\");\n      }\n    } else {\n      toast.success(\"Task flagged!\");\n    }\n    \n    setShowFlagNoteDialog(false);\n    setFlagNoteTaskId(null);\n    setFlagNote(\"\");\n  };\n  \n  const toggleTaskFlag = (taskId: string) => {\n    openFlagDialog(taskId);\n  };\n  \n  const taskRefs = useRef<{ [key: string]: HTMLDivElement | null }>({});\n  \n  useEffect(() => {\n    if (searchString && allTasks.length > 0) {\n      const params = new URLSearchParams(searchString);\n      const taskId = params.get('id');\n      if (taskId) {\n        setHighlightedTaskId(taskId);\n        setTimeout(() => {\n          const element = taskRefs.current[taskId];\n          if (element) {\n            element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n          }\n        }, 100);\n        setTimeout(() => setHighlightedTaskId(null), 3000);\n      }\n    }\n  }, [searchString, allTasks]);\n  \n  const myTasks = currentUser ? allTasks.filter(t => t.assignedTo === currentUser.id) : [];\n  \n  const getDealName = (dealId: string | null) => {\n    const deal = deals.find(d => d.id === dealId);\n    return deal?.name || 'No Deal';\n  };\n\n  const getDeal = (dealId: string | null): Deal | null => {\n    return deals.find(d => d.id === dealId) || null;\n  };\n\n  const isDateWithinThisWeek = (dateStr: string | null) => {\n    if (!dateStr) return false;\n    const date = parseISO(dateStr);\n    const weekStart = startOfWeek(new Date(), { weekStartsOn: 0 });\n    const weekEnd = endOfWeek(new Date(), { weekStartsOn: 0 });\n    return isWithinInterval(date, { start: weekStart, end: weekEnd }) && !isToday(date);\n  };\n\n  const dueTodayTasks = myTasks.filter(t => \n    t.status !== 'Completed' && t.dueDate && isToday(parseISO(t.dueDate))\n  );\n  \n  const dueNextWeekTasks = myTasks.filter(t => \n    t.status !== 'Completed' && t.dueDate && isDateWithinThisWeek(t.dueDate)\n  );\n  \n  const dueLaterTasks = myTasks.filter(t => {\n    if (t.status === 'Completed' || t.status === 'Draft') return false;\n    if (!t.dueDate) return false;\n    const dueDate = parseISO(t.dueDate);\n    return !isToday(dueDate) && !isDateWithinThisWeek(t.dueDate);\n  });\n  \n  const draftTasks = myTasks.filter(t => \n    t.status !== 'Completed' && (t.status === 'Draft' || !t.dueDate)\n  );\n  \n  const completedTasks = myTasks.filter(t => t.status === 'Completed');\n\n  const swipeableTasks = useMemo(() => {\n    const todayNonDeferred = dueTodayTasks.filter(t => !deferredTasks.includes(t.id));\n    const todayDeferred = dueTodayTasks.filter(t => deferredTasks.includes(t.id));\n    return [...todayNonDeferred, ...todayDeferred];\n  }, [dueTodayTasks, deferredTasks]);\n\n  const searchResults = useMemo(() => {\n    if (!searchQuery.trim()) return { tasks: [], deals: [] };\n    const query = searchQuery.toLowerCase();\n    const matchedTasks = myTasks.filter(t => \n      t.title.toLowerCase().includes(query) || \n      t.description?.toLowerCase().includes(query)\n    );\n    const matchedDeals = deals.filter(d => \n      d.name.toLowerCase().includes(query) || \n      d.client.toLowerCase().includes(query)\n    );\n    return { tasks: matchedTasks, deals: matchedDeals };\n  }, [searchQuery, myTasks, deals]);\n\n  const handleSwipe = async (direction: SwipeDirection, task: Task) => {\n    if (direction === 'right') {\n      setDeferredTasks(prev => [...prev, task.id]);\n      toast.info(\"Task deferred to later\");\n      setCurrentSwipeIndex(prev => Math.min(prev + 1, swipeableTasks.length - 1));\n    } else if (direction === 'left') {\n      setSelectedTask(task);\n      // Always use the enhanced Send Work modal for consistency\n      setShowSendWorkModal(true);\n    } else if (direction === 'up') {\n      setSelectedTask(task);\n      setShowAIModal(true);\n      analyzeTaskWithAI(task);\n    }\n  };\n\n  const handleTaskClick = (task: Task) => {\n    setSelectedTask(task);\n    setShowTaskDetailModal(true);\n  };\n\n  const handleCompleteTask = async (taskId: string) => {\n    try {\n      await updateTask.mutateAsync({ id: taskId, status: 'Completed' });\n      toast.success(\"Task marked as completed!\");\n      setShowTaskDetailModal(false);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update task\");\n    }\n  };\n\n  const handleDeleteTask = async (taskId: string) => {\n    try {\n      await deleteTask.mutateAsync(taskId);\n      toast.success(\"Task deleted successfully!\");\n      setShowTaskDetailModal(false);\n      setSelectedTask(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete task\");\n    }\n  };\n\n  const handleForwardTask = async () => {\n    if (!selectedTask || !forwardToUser) {\n      toast.error(\"Please select a team member\");\n      return;\n    }\n    try {\n      await updateTask.mutateAsync({ \n        id: selectedTask.id, \n        assignedTo: forwardToUser,\n        status: 'Pending'\n      });\n      toast.success(\"Task forwarded successfully!\");\n      setShowForwardModal(false);\n      setForwardToUser(\"\");\n      setSelectedTask(null);\n      setCurrentSwipeIndex(prev => Math.min(prev + 1, swipeableTasks.length - 1));\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to forward task\");\n    }\n  };\n\n  const openEditModal = (task: Task) => {\n    // Parse existing due date/time\n    let dueDate = '';\n    let dueTime = '';\n    if (task.dueDate) {\n      if (task.dueDate.includes('T')) {\n        const parts = task.dueDate.split('T');\n        dueDate = parts[0];\n        dueTime = parts[1]?.substring(0, 5) || '';\n      } else {\n        dueDate = task.dueDate;\n      }\n    }\n    \n    setEditTaskForm({\n      id: task.id,\n      title: task.title,\n      description: task.description || '',\n      priority: task.priority as any,\n      dueDate,\n      dueTime,\n      dealId: task.dealId || '',\n      type: (task.type as any) || 'General',\n      status: task.status\n    });\n    // Load existing attachments for editing\n    const existingAttachments = (task.attachments as any[]) || [];\n    setEditAttachments(existingAttachments.map(a => ({\n      id: a.id || crypto.randomUUID(),\n      filename: a.filename,\n      url: a.url,\n      size: a.size || 0,\n      type: a.type || 'application/octet-stream',\n      uploadedAt: a.uploadedAt || new Date().toISOString(),\n    })));\n    setShowEditTaskModal(true);\n  };\n\n  const handleEditTask = async () => {\n    if (!editTaskForm.title.trim()) {\n      toast.error(\"Please enter a task title\");\n      return;\n    }\n    \n    try {\n      // Combine date and time for full datetime (both optional)\n      let fullDueDate: string | null = null;\n      if (editTaskForm.dueDate) {\n        fullDueDate = editTaskForm.dueTime \n          ? `${editTaskForm.dueDate}T${editTaskForm.dueTime}` \n          : editTaskForm.dueDate;\n      }\n      \n      // If task has no date, set status to Draft; otherwise preserve or set to Pending\n      let newStatus = editTaskForm.status;\n      if (!fullDueDate && newStatus !== 'Completed') {\n        newStatus = 'Draft';\n      } else if (fullDueDate && newStatus === 'Draft') {\n        newStatus = 'Pending';\n      }\n      \n      await updateTask.mutateAsync({\n        id: editTaskForm.id,\n        title: editTaskForm.title.trim(),\n        description: editTaskForm.description.trim() || null,\n        priority: editTaskForm.priority,\n        status: newStatus,\n        type: editTaskForm.type,\n        dueDate: fullDueDate,\n        dealId: editTaskForm.dealId || null,\n        attachments: editAttachments.map(f => ({\n          id: f.id,\n          filename: f.filename,\n          url: f.url,\n          size: f.size,\n          uploadedAt: f.uploadedAt,\n        })),\n      });\n      \n      toast.success(\"Task updated successfully!\");\n      setShowEditTaskModal(false);\n      setShowTaskDetailModal(false);\n      setSelectedTask(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update task\");\n    }\n  };\n\n  const analyzeTaskWithAI = async (task: Task) => {\n    setIsAnalyzing(true);\n    setAiSuggestion(null);\n    \n    try {\n      const deal = getDeal(task.dealId);\n      const attachmentCount = (task.attachments as any[])?.length || 0;\n      const hasAttachments = attachmentCount > 0;\n      \n      const response = await fetch('/api/ai/analyze-task', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          task: {\n            title: task.title,\n            description: task.description,\n            type: task.type,\n            priority: task.priority,\n            hasAttachments,\n            attachmentCount,\n          },\n          deal: deal ? {\n            name: deal.name,\n            client: deal.client,\n            sector: deal.sector,\n            stage: deal.stage,\n          } : null\n        })\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to analyze task');\n      }\n      \n      const data = await response.json();\n      \n      // Map suggested tools to app catalog\n      const suggestedApps = mapToolsToApps(data.tools || [], task);\n      setAiSuggestion({ ...data, apps: suggestedApps });\n    } catch (error: any) {\n      toast.error(\"Failed to analyze task with AI\");\n      const fallbackApps = mapToolsToApps([\"Document Editor\", \"Email Client\", \"Calendar\"], task);\n      setAiSuggestion({\n        action: \"Manual Analysis Required\",\n        reasoning: \"Unable to get AI suggestions at this time. Please analyze the task manually.\",\n        tools: [\"Document Editor\", \"Email Client\", \"Calendar\"],\n        apps: fallbackApps\n      });\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n  \n  const mapToolsToApps = (tools: string[], task: Task): AppSuggestion[] => {\n    const apps: AppSuggestion[] = [];\n    const taskType = task.type?.toLowerCase() || '';\n    const title = task.title?.toLowerCase() || '';\n    const desc = task.description?.toLowerCase() || '';\n    \n    // Add context-aware apps based on task type\n    if (taskType.includes('financial') || title.includes('model') || title.includes('valuation') || desc.includes('excel')) {\n      apps.push(APP_CATALOG['excel'] || APP_CATALOG['google_sheets']);\n    }\n    if (taskType.includes('document') || title.includes('memo') || title.includes('report') || desc.includes('document')) {\n      apps.push(APP_CATALOG['word'] || APP_CATALOG['google_docs']);\n    }\n    if (title.includes('presentation') || title.includes('deck') || title.includes('pitch')) {\n      apps.push(APP_CATALOG['powerpoint'] || APP_CATALOG['google_slides']);\n    }\n    if (taskType.includes('communication') || title.includes('email') || title.includes('client')) {\n      apps.push(APP_CATALOG['email']);\n    }\n    if (title.includes('meeting') || title.includes('call') || title.includes('schedule')) {\n      apps.push(APP_CATALOG['calendar']);\n      apps.push(APP_CATALOG['zoom']);\n    }\n    if (title.includes('sign') || title.includes('signature') || desc.includes('signature')) {\n      apps.push(APP_CATALOG['docusign']);\n    }\n    if (taskType.includes('due diligence') || title.includes('research') || desc.includes('research')) {\n      apps.push(APP_CATALOG['capital_iq']);\n      apps.push(APP_CATALOG['pitchbook']);\n    }\n    \n    // Map any remaining tools from AI response\n    tools.forEach(tool => {\n      const toolLower = tool.toLowerCase();\n      if (toolLower.includes('excel') || toolLower.includes('spreadsheet')) {\n        if (!apps.find(a => a.name.includes('Excel') || a.name.includes('Sheets'))) {\n          apps.push(APP_CATALOG['excel']);\n        }\n      }\n      if (toolLower.includes('word') || toolLower.includes('document')) {\n        if (!apps.find(a => a.name.includes('Word') || a.name.includes('Docs'))) {\n          apps.push(APP_CATALOG['word']);\n        }\n      }\n      if (toolLower.includes('powerpoint') || toolLower.includes('presentation') || toolLower.includes('slides')) {\n        if (!apps.find(a => a.name.includes('PowerPoint') || a.name.includes('Slides'))) {\n          apps.push(APP_CATALOG['powerpoint']);\n        }\n      }\n      if (toolLower.includes('email') || toolLower.includes('mail')) {\n        if (!apps.find(a => a.name.includes('Email'))) {\n          apps.push(APP_CATALOG['email']);\n        }\n      }\n      if (toolLower.includes('calendar')) {\n        if (!apps.find(a => a.name.includes('Calendar'))) {\n          apps.push(APP_CATALOG['calendar']);\n        }\n      }\n      if (toolLower.includes('pdf')) {\n        if (!apps.find(a => a.name.includes('PDF'))) {\n          apps.push(APP_CATALOG['pdf_editor']);\n        }\n      }\n    });\n    \n    // Ensure at least some apps are suggested\n    if (apps.length === 0) {\n      apps.push(APP_CATALOG['word'], APP_CATALOG['email'], APP_CATALOG['calendar']);\n    }\n    \n    // Remove duplicates and filter undefined\n    const uniqueApps = apps.filter((app, index, self) => \n      app && self.findIndex(a => a?.name === app.name) === index\n    );\n    \n    return uniqueApps.slice(0, 3); // Max 3 best apps\n  };\n  \n  const openAppForTask = (app: AppSuggestion, task: Task) => {\n    const os = getOS();\n    \n    // Set this task as the working task\n    setWorkingTask(task);\n    setShowAIModal(false);\n    \n    // Try local protocol handler first for specific apps\n    if (app.localProtocol) {\n      // For protocol handlers, we use window.location.href and catch errors\n      // Show a toast with instructions\n      toast.info(`Opening ${app.name}...`, { \n        description: 'If the app doesn\\'t open, it may not be installed. Falling back to web version.',\n        duration: 3000\n      });\n      \n      // Try protocol handler with timeout fallback\n      const protocolUrl = app.localProtocol;\n      const startTime = Date.now();\n      \n      // Use an iframe to test protocol handler (doesn't navigate away)\n      const iframe = document.createElement('iframe');\n      iframe.style.display = 'none';\n      document.body.appendChild(iframe);\n      \n      try {\n        if (iframe.contentWindow) {\n          iframe.contentWindow.location.href = protocolUrl;\n        }\n      } catch {\n        // Protocol failed, continue to fallback\n      }\n      \n      // After short delay, open web fallback\n      setTimeout(() => {\n        document.body.removeChild(iframe);\n        // If on Mac and there's a Mac fallback, use it\n        if (os === 'mac' && app.macFallback) {\n          window.open(app.macFallback, '_blank');\n        } else if (app.url) {\n          window.open(app.url, '_blank');\n        }\n      }, 500);\n    } else {\n      // No protocol handler, use OS-specific fallback or default URL\n      if (os === 'mac' && app.macFallback) {\n        window.open(app.macFallback, '_blank');\n      } else if (os === 'windows' && app.winFallback) {\n        window.open(app.winFallback, '_blank');\n      } else if (app.url) {\n        window.open(app.url, '_blank');\n      } else {\n        toast.error(`Unable to open ${app.name}`);\n        return;\n      }\n    }\n    \n    toast.success(`Working on task. Swipe left on the task when ready to send your work.`, {\n      duration: 5000,\n    });\n  };\n  \n  const handleBringBackWork = () => {\n    if (!workingTask) return;\n    setSelectedTask(workingTask);\n    setShowSendWorkModal(true);\n  };\n  \n  const handleSendWork = async () => {\n    if (!selectedTask) {\n      toast.error(\"No task selected\");\n      return;\n    }\n    \n    if (sendWorkTab === 'internal') {\n      // Internal: send to selected platform users\n      if (selectedInternalUsers.length === 0) {\n        toast.error(\"Please select at least one team member\");\n        return;\n      }\n      \n      try {\n        const currentDescription = selectedTask.description || '';\n        const workNote = completedWorkNotes ? `\\n\\n--- Work Completed ---\\n${completedWorkNotes}` : '';\n        \n        const existingAttachments = (selectedTask.attachments as any[]) || [];\n        const newAttachments = sendWorkAttachments.map(f => ({\n          id: f.id,\n          filename: f.filename,\n          url: f.url,\n          size: f.size,\n          uploadedAt: f.uploadedAt,\n        }));\n        const allAttachments = [...existingAttachments, ...newAttachments];\n        \n        // If one user selected, update the existing task\n        if (selectedInternalUsers.length === 1) {\n          await updateTask.mutateAsync({ \n            id: selectedTask.id, \n            assignedTo: selectedInternalUsers[0],\n            description: currentDescription + workNote,\n            attachments: allAttachments,\n            status: 'Pending'\n          });\n        } else {\n          // Multiple users: create copies of the task for each\n          for (const userId of selectedInternalUsers) {\n            await createTask.mutateAsync({\n              title: selectedTask.title,\n              description: currentDescription + workNote,\n              priority: selectedTask.priority as any,\n              status: 'Pending',\n              type: selectedTask.type as any,\n              dueDate: selectedTask.dueDate || null,\n              dealId: selectedTask.dealId || null,\n              assignedTo: userId,\n              assignedBy: currentUser?.id || '',\n              attachments: allAttachments,\n            });\n          }\n          // Mark original as completed\n          await updateTask.mutateAsync({\n            id: selectedTask.id,\n            status: 'Completed',\n            description: currentDescription + workNote + `\\n\\n[Forwarded to ${selectedInternalUsers.length} team members]`,\n          });\n        }\n        \n        toast.success(`Work sent to ${selectedInternalUsers.length} team member(s)!`);\n        resetSendWorkModal();\n      } catch (error: any) {\n        toast.error(error.message || \"Failed to send work\");\n      }\n    } else {\n      // External: send email to external stakeholder\n      const recipientEmail = externalRecipientEmail || stakeholders.find(s => s.id === externalRecipientId)?.email;\n      const recipientName = externalRecipientName || stakeholders.find(s => s.id === externalRecipientId)?.name;\n      \n      if (!recipientEmail) {\n        toast.error(\"Please provide a valid email address\");\n        return;\n      }\n      \n      setIsSendingExternal(true);\n      try {\n        // If adding new contact, save it first\n        if (showAddNewContact && externalRecipientName && externalRecipientEmail) {\n          await createStakeholder.mutateAsync({\n            name: externalRecipientName,\n            email: externalRecipientEmail,\n            company: externalRecipientCompany || 'Unknown',\n            title: 'Contact',\n            type: 'other',\n          });\n        }\n        \n        // Send email with attachments\n        const response = await fetch('/api/send-external-work', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            recipientEmail,\n            recipientName: recipientName || 'Recipient',\n            senderName: currentUser?.name || 'Team Member',\n            taskTitle: selectedTask.title,\n            message: externalEmailMessage || completedWorkNotes,\n            attachments: sendWorkAttachments.map(f => ({\n              filename: f.filename,\n              url: f.url,\n            })),\n          }),\n        });\n        \n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Failed to send email');\n        }\n        \n        // Mark task as completed with note about external send\n        const currentDescription = selectedTask.description || '';\n        const workNote = `\\n\\n--- Sent Externally ---\\nTo: ${recipientName} <${recipientEmail}>\\nDate: ${new Date().toLocaleString()}\\n${externalEmailMessage || completedWorkNotes}`;\n        \n        await updateTask.mutateAsync({\n          id: selectedTask.id,\n          status: 'Completed',\n          description: currentDescription + workNote,\n        });\n        \n        toast.success(`Work sent to ${recipientName} via email!`);\n        resetSendWorkModal();\n      } catch (error: any) {\n        toast.error(error.message || \"Failed to send email\");\n      } finally {\n        setIsSendingExternal(false);\n      }\n    }\n  };\n  \n  const resetSendWorkModal = () => {\n    setShowSendWorkModal(false);\n    setWorkingTask(null);\n    setSelectedTask(null);\n    setForwardToUser(\"\");\n    setCompletedWorkNotes(\"\");\n    setSendWorkAttachments([]);\n    setSendWorkTab('internal');\n    setSelectedInternalUsers([]);\n    setInternalUserSearch(\"\");\n    setExternalRecipientId(\"\");\n    setExternalRecipientEmail(\"\");\n    setExternalRecipientName(\"\");\n    setExternalRecipientCompany(\"\");\n    setExternalEmailMessage(\"\");\n    setStakeholderSearch(\"\");\n    setShowAddNewContact(false);\n  };\n\n  const handleSearchSelect = (type: 'task' | 'deal', id: string) => {\n    setShowSearchResults(false);\n    setSearchQuery(\"\");\n    if (type === 'task') {\n      const task = myTasks.find(t => t.id === id);\n      if (task) {\n        setSelectedTask(task);\n        setShowTaskDetailModal(true);\n      }\n    } else {\n      setLocation(`/employee/deals?id=${id}`);\n    }\n  };\n\n  const uploadFiles = async (fileList: FileList | File[]) => {\n    const files = Array.from(fileList);\n    if (files.length === 0) return;\n    \n    setIsUploading(true);\n    \n    try {\n      for (const file of files) {\n        const formData = new FormData();\n        formData.append('file', file);\n        \n        const response = await fetch('/api/upload', {\n          method: 'POST',\n          body: formData,\n        });\n        \n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Failed to upload file');\n        }\n        \n        const uploadedFile: UploadedFile = await response.json();\n        setUploadedFiles(prev => [...prev, uploadedFile]);\n      }\n      toast.success(`${files.length} file(s) uploaded successfully`);\n    } catch (error: any) {\n      toast.error(error.message || 'Failed to upload file');\n    } finally {\n      setIsUploading(false);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = '';\n      }\n    }\n  };\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      await uploadFiles(e.target.files);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n  };\n\n  const handleDrop = async (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n    \n    const files = e.dataTransfer.files;\n    if (files.length > 0) {\n      await uploadFiles(files);\n    }\n  };\n\n  const removeAttachment = async (index: number) => {\n    const file = uploadedFiles[index];\n    if (file) {\n      try {\n        const filename = file.url.replace('/uploads/', '');\n        await fetch(`/api/upload/${filename}`, { method: 'DELETE' });\n      } catch (error) {\n        console.error('Failed to delete file:', error);\n      }\n    }\n    setUploadedFiles(prev => prev.filter((_, i) => i !== index));\n  };\n\n  // Time options for dropdown\n  const timeOptions = [\n    { value: '', label: 'No specific time' },\n    { value: '09:00', label: '9:00 AM' },\n    { value: '09:30', label: '9:30 AM' },\n    { value: '10:00', label: '10:00 AM' },\n    { value: '10:30', label: '10:30 AM' },\n    { value: '11:00', label: '11:00 AM' },\n    { value: '11:30', label: '11:30 AM' },\n    { value: '12:00', label: '12:00 PM' },\n    { value: '12:30', label: '12:30 PM' },\n    { value: '13:00', label: '1:00 PM' },\n    { value: '13:30', label: '1:30 PM' },\n    { value: '14:00', label: '2:00 PM' },\n    { value: '14:30', label: '2:30 PM' },\n    { value: '15:00', label: '3:00 PM' },\n    { value: '15:30', label: '3:30 PM' },\n    { value: '16:00', label: '4:00 PM' },\n    { value: '16:30', label: '4:30 PM' },\n    { value: '17:00', label: '5:00 PM' },\n    { value: '17:30', label: '5:30 PM' },\n    { value: '18:00', label: '6:00 PM' },\n    { value: '18:30', label: '6:30 PM' },\n    { value: '19:00', label: '7:00 PM' },\n    { value: '20:00', label: '8:00 PM' },\n    { value: '21:00', label: '9:00 PM' },\n  ];\n\n  const handleCreateTask = async () => {\n    if (!newTaskForm.title.trim()) {\n      toast.error(\"Please enter a task title\");\n      return;\n    }\n    \n    try {\n      // Combine date and time for full datetime (both optional)\n      let fullDueDate: string | null = null;\n      if (newTaskForm.dueDate) {\n        fullDueDate = newTaskForm.dueTime \n          ? `${newTaskForm.dueDate}T${newTaskForm.dueTime}` \n          : newTaskForm.dueDate;\n      }\n      \n      const taskData: any = {\n        title: newTaskForm.title.trim(),\n        description: newTaskForm.description.trim() || null,\n        priority: newTaskForm.priority,\n        status: fullDueDate ? 'Pending' : 'Draft',\n        type: newTaskForm.type,\n        assignedTo: currentUser?.id || '',\n        dueDate: fullDueDate,\n      };\n      if (newTaskForm.dealId && newTaskForm.dealId !== 'none') {\n        taskData.dealId = newTaskForm.dealId;\n        const selectedDeal = deals.find(d => d.id === newTaskForm.dealId);\n        if (selectedDeal) {\n          taskData.dealStage = selectedDeal.stage;\n        }\n      }\n      const attachmentObjects = uploadedFiles.map(file => ({\n        id: file.id,\n        filename: file.filename,\n        url: file.url,\n        size: file.size,\n        uploadedAt: file.uploadedAt,\n      }));\n\n      if (attachmentObjects.length > 0) {\n        taskData.attachments = attachmentObjects;\n      }\n\n      const createdTask = await createTask.mutateAsync(taskData);\n      \n      for (const file of uploadedFiles) {\n        await createTaskAttachment.mutateAsync({\n          taskId: createdTask.id,\n          filename: file.url.split('/').pop() || file.filename,\n          originalName: file.filename,\n          mimeType: file.type || null,\n          size: file.size,\n        });\n      }\n      \n      toast.success(\"Task created successfully!\");\n      setShowCreateTaskModal(false);\n      setNewTaskForm({\n        title: '',\n        description: '',\n        priority: 'Medium',\n        dueDate: '',\n        dueTime: '',\n        dealId: '',\n        type: 'General'\n      });\n      setUploadedFiles([]);\n      if (fileInputRef.current) fileInputRef.current.value = '';\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create task\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role} pageTitle=\"My Tasks\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading tasks...</div>\n        </div>\n      </Layout>\n    );\n  }\n\n  const currentTask = swipeableTasks[currentSwipeIndex];\n\n  return (\n    <Layout role={role} pageTitle=\"My Tasks\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        \n        {/* Search Bar */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search tasks, deals, or projects...\"\n            value={searchQuery}\n            onChange={(e) => {\n              setSearchQuery(e.target.value);\n              setShowSearchResults(e.target.value.length > 0);\n            }}\n            onFocus={() => setShowSearchResults(searchQuery.length > 0)}\n            className=\"pl-10 h-12 bg-card border-border text-lg\"\n            data-testid=\"input-task-search\"\n          />\n          {showSearchResults && (searchResults.tasks.length > 0 || searchResults.deals.length > 0) && (\n            <div className=\"absolute top-full left-0 right-0 z-50 mt-2 bg-card border border-border rounded-lg shadow-xl max-h-[400px] overflow-y-auto\">\n              {searchResults.tasks.length > 0 && (\n                <>\n                  <div className=\"px-4 py-2 text-xs font-medium text-muted-foreground uppercase tracking-wider bg-secondary/50\">\n                    Tasks\n                  </div>\n                  {searchResults.tasks.map(task => (\n                    <div\n                      key={task.id}\n                      className=\"px-4 py-3 hover:bg-secondary/50 cursor-pointer transition-colors border-b border-border/50 last:border-b-0\"\n                      onClick={() => handleSearchSelect('task', task.id)}\n                      data-testid={`search-result-task-${task.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <FileText className=\"w-4 h-4 text-primary\" />\n                        <div>\n                          <div className=\"font-medium text-sm\">{task.title}</div>\n                          <div className=\"text-xs text-muted-foreground\">{getDealName(task.dealId)}  {task.status}</div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </>\n              )}\n              {searchResults.deals.length > 0 && (\n                <>\n                  <div className=\"px-4 py-2 text-xs font-medium text-muted-foreground uppercase tracking-wider bg-secondary/50\">\n                    Deals / Projects\n                  </div>\n                  {searchResults.deals.map(deal => (\n                    <div\n                      key={deal.id}\n                      className=\"px-4 py-3 hover:bg-secondary/50 cursor-pointer transition-colors border-b border-border/50 last:border-b-0\"\n                      onClick={() => handleSearchSelect('deal', deal.id)}\n                      data-testid={`search-result-deal-${deal.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <Briefcase className=\"w-4 h-4 text-accent\" />\n                        <div>\n                          <div className=\"font-medium text-sm\">{deal.name}</div>\n                          <div className=\"text-xs text-muted-foreground\">{deal.client}  {deal.stage}</div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </>\n              )}\n              {searchResults.tasks.length === 0 && searchResults.deals.length === 0 && (\n                <div className=\"px-4 py-6 text-center text-muted-foreground text-sm\">\n                  No results found for \"{searchQuery}\"\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n        \n        {/* Header Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4 flex items-center gap-4\">\n              <div className=\"w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-500\">\n                <AlertCircle className=\"w-5 h-5\" />\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold\" data-testid=\"stat-today\">{dueTodayTasks.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Due Today</div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4 flex items-center gap-4\">\n              <div className=\"w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500\">\n                <Calendar className=\"w-5 h-5\" />\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold\" data-testid=\"stat-week\">{dueNextWeekTasks.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Due This Week</div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4 flex items-center gap-4\">\n              <div className=\"w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500\">\n                <Clock className=\"w-5 h-5\" />\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold\" data-testid=\"stat-later\">{dueLaterTasks.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Due Later</div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4 flex items-center gap-4\">\n              <div className=\"w-10 h-10 rounded-full bg-gray-500/20 flex items-center justify-center text-gray-500\">\n                <FileEdit className=\"w-5 h-5\" />\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold\" data-testid=\"stat-drafts\">{draftTasks.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Drafts</div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4 flex items-center gap-4\">\n              <div className=\"w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-500\">\n                <Check className=\"w-5 h-5\" />\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold\" data-testid=\"stat-completed\">{completedTasks.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Completed</div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Swipeable Task Section */}\n        <Card className=\"bg-card border-border overflow-hidden\">\n          <CardHeader className=\"pb-2 border-b border-border\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Sparkles className=\"w-5 h-5 text-primary\" />\n                Today's Focus\n              </CardTitle>\n              <div className=\"flex items-center gap-3\">\n                <Button \n                  size=\"sm\" \n                  onClick={() => setShowCreateTaskModal(true)}\n                  data-testid=\"button-create-task\"\n                >\n                  <Plus className=\"w-4 h-4 mr-1\" />\n                  Create Task\n                </Button>\n                <div className=\"text-sm text-muted-foreground\">\n                  {currentSwipeIndex + 1} / {swipeableTasks.length}\n                </div>\n              </div>\n            </div>\n            <CardDescription className=\"text-xs\">\n              Swipe right to defer  Swipe up for AI assist  Swipe left to forward  Click for details\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"p-6\">\n            {swipeableTasks.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Check className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                <p className=\"text-lg font-medium\">All caught up!</p>\n                <p className=\"text-sm\">No tasks due today</p>\n              </div>\n            ) : (\n              <div className=\"relative h-[300px] flex items-center justify-center\">\n                <AnimatePresence mode=\"wait\">\n                  {currentTask && (\n                    <SwipeableTaskCard\n                      key={currentTask.id}\n                      task={currentTask}\n                      dealName={getDealName(currentTask.dealId)}\n                      onSwipe={(direction) => handleSwipe(direction, currentTask)}\n                      onClick={() => handleTaskClick(currentTask)}\n                    />\n                  )}\n                </AnimatePresence>\n                \n                {/* Swipe indicators */}\n                <div className=\"absolute left-0 top-1/2 -translate-y-1/2 text-green-500 opacity-30\">\n                  <div className=\"flex flex-col items-center gap-1\">\n                    <ChevronRight className=\"w-8 h-8\" />\n                    <span className=\"text-xs\">Defer</span>\n                  </div>\n                </div>\n                <div className=\"absolute right-0 top-1/2 -translate-y-1/2 text-blue-500 opacity-30\">\n                  <div className=\"flex flex-col items-center gap-1\">\n                    <ChevronLeft className=\"w-8 h-8\" />\n                    <span className=\"text-xs\">Forward</span>\n                  </div>\n                </div>\n                <div className=\"absolute top-0 left-1/2 -translate-x-1/2 text-purple-500 opacity-30\">\n                  <div className=\"flex flex-col items-center gap-1\">\n                    <ArrowUp className=\"w-8 h-8\" />\n                    <span className=\"text-xs\">AI Assist</span>\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Work in Progress Indicator - placed under main task widget */}\n        {workingTask && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            className=\"mt-4\"\n          >\n            <Card className=\"bg-primary/90 text-primary-foreground shadow-lg border-0 px-4 py-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"w-2 h-2 bg-green-400 rounded-full animate-pulse\" />\n                  <span className=\"text-sm font-medium\">Working on: {workingTask.title}</span>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button \n                    size=\"sm\" \n                    variant=\"secondary\" \n                    className=\"h-7 text-xs\"\n                    onClick={handleBringBackWork}\n                    data-testid=\"button-send-work\"\n                  >\n                    <Send className=\"w-3 h-3 mr-1\" />\n                    Send Work\n                  </Button>\n                  <Button \n                    size=\"sm\" \n                    variant=\"ghost\" \n                    className=\"h-7 text-xs text-primary-foreground hover:text-primary-foreground hover:bg-white/20\"\n                    onClick={() => setWorkingTask(null)}\n                    data-testid=\"button-clear-working\"\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </Button>\n                </div>\n              </div>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Task Categories Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-5 gap-6\">\n          \n          {/* Drafts */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                <FileEdit className=\"w-4 h-4 text-gray-500\" />\n                Drafts\n              </h3>\n              <Badge variant=\"outline\" className=\"bg-gray-500/10 text-gray-500 border-gray-500/20\">{draftTasks.length}</Badge>\n            </div>\n            <ScrollArea className=\"h-[400px] pr-2\">\n              {draftTasks.length === 0 ? (\n                <Card className=\"bg-card/50 border-border border-dashed\">\n                  <CardContent className=\"p-4 text-center text-muted-foreground text-sm\">\n                    No draft tasks - create a task without a deadline to save as draft\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-3\">\n                  {draftTasks.map((task) => (\n                    <TaskCard \n                      key={task.id} \n                      task={task} \n                      dealName={getDealName(task.dealId)}\n                      onClick={() => handleTaskClick(task)}\n                      highlighted={highlightedTaskId === task.id}\n                      isFlagged={!!flaggedTasks[task.id]}\n                      onFlag={(e) => { e.stopPropagation(); toggleTaskFlag(task.id); }}\n                      ref={(el) => { taskRefs.current[task.id] = el; }}\n                    />\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n\n          {/* Due Today */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                <AlertCircle className=\"w-4 h-4 text-orange-500\" />\n                Due Today\n              </h3>\n              <Badge variant=\"outline\" className=\"bg-orange-500/10 text-orange-500 border-orange-500/20\">{dueTodayTasks.length}</Badge>\n            </div>\n            <ScrollArea className=\"h-[400px] pr-2\">\n              {dueTodayTasks.length === 0 ? (\n                <Card className=\"bg-card/50 border-border border-dashed\">\n                  <CardContent className=\"p-4 text-center text-muted-foreground text-sm\">\n                    No tasks due today\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-3\">\n                  {dueTodayTasks.map((task) => (\n                    <TaskCard \n                      key={task.id} \n                      task={task} \n                      dealName={getDealName(task.dealId)}\n                      onClick={() => handleTaskClick(task)}\n                      highlighted={highlightedTaskId === task.id}\n                      isFlagged={!!flaggedTasks[task.id]}\n                      onFlag={(e) => { e.stopPropagation(); toggleTaskFlag(task.id); }}\n                      ref={(el) => { taskRefs.current[task.id] = el; }}\n                    />\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n\n          {/* Due This Week */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                <Calendar className=\"w-4 h-4 text-blue-500\" />\n                Due This Week\n              </h3>\n              <Badge variant=\"outline\" className=\"bg-blue-500/10 text-blue-500 border-blue-500/20\">{dueNextWeekTasks.length}</Badge>\n            </div>\n            <ScrollArea className=\"h-[400px] pr-2\">\n              {dueNextWeekTasks.length === 0 ? (\n                <Card className=\"bg-card/50 border-border border-dashed\">\n                  <CardContent className=\"p-4 text-center text-muted-foreground text-sm\">\n                    No tasks due this week\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-3\">\n                  {dueNextWeekTasks.map((task) => (\n                    <TaskCard \n                      key={task.id} \n                      task={task} \n                      dealName={getDealName(task.dealId)}\n                      onClick={() => handleTaskClick(task)}\n                      highlighted={highlightedTaskId === task.id}\n                      isFlagged={!!flaggedTasks[task.id]}\n                      onFlag={(e) => { e.stopPropagation(); toggleTaskFlag(task.id); }}\n                      ref={(el) => { taskRefs.current[task.id] = el; }}\n                    />\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n\n          {/* Due Later */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                <Clock className=\"w-4 h-4 text-purple-500\" />\n                Due Later\n              </h3>\n              <Badge variant=\"outline\" className=\"bg-purple-500/10 text-purple-500 border-purple-500/20\">{dueLaterTasks.length}</Badge>\n            </div>\n            <ScrollArea className=\"h-[400px] pr-2\">\n              {dueLaterTasks.length === 0 ? (\n                <Card className=\"bg-card/50 border-border border-dashed\">\n                  <CardContent className=\"p-4 text-center text-muted-foreground text-sm\">\n                    No tasks due later\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-3\">\n                  {dueLaterTasks.map((task) => (\n                    <TaskCard \n                      key={task.id} \n                      task={task} \n                      dealName={getDealName(task.dealId)}\n                      onClick={() => handleTaskClick(task)}\n                      highlighted={highlightedTaskId === task.id}\n                      isFlagged={!!flaggedTasks[task.id]}\n                      onFlag={(e) => { e.stopPropagation(); toggleTaskFlag(task.id); }}\n                      ref={(el) => { taskRefs.current[task.id] = el; }}\n                    />\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n\n          {/* Completed */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                <Check className=\"w-4 h-4 text-green-500\" />\n                Completed\n              </h3>\n              <Badge variant=\"outline\" className=\"bg-green-500/10 text-green-500 border-green-500/20\">{completedTasks.length}</Badge>\n            </div>\n            <ScrollArea className=\"h-[400px] pr-2\">\n              {completedTasks.length === 0 ? (\n                <Card className=\"bg-card/50 border-border border-dashed\">\n                  <CardContent className=\"p-4 text-center text-muted-foreground text-sm\">\n                    No completed tasks yet\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-3\">\n                  {completedTasks.slice(0, 10).map((task) => (\n                    <TaskCard \n                      key={task.id} \n                      task={task} \n                      dealName={getDealName(task.dealId)}\n                      onClick={() => handleTaskClick(task)}\n                      highlighted={highlightedTaskId === task.id}\n                      completed\n                      ref={(el) => { taskRefs.current[task.id] = el; }}\n                    />\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n        </div>\n      </div>\n\n      {/* Task Detail Modal */}\n      <Dialog open={showTaskDetailModal} onOpenChange={setShowTaskDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{selectedTask?.title}</DialogTitle>\n            <DialogDescription>Task Details</DialogDescription>\n          </DialogHeader>\n          {selectedTask && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"outline\" className={cn(\n                  \"text-xs\",\n                  selectedTask.priority === 'High' ? \"bg-red-500/10 text-red-500 border-red-500/20\" : \n                  selectedTask.priority === 'Medium' ? \"bg-yellow-500/10 text-yellow-500 border-yellow-500/20\" :\n                  \"bg-blue-500/10 text-blue-500 border-blue-500/20\"\n                )}>\n                  {selectedTask.priority} Priority\n                </Badge>\n                <Badge variant=\"secondary\">{selectedTask.type}</Badge>\n                <Badge variant={selectedTask.status === 'Completed' ? 'default' : 'outline'}>\n                  {selectedTask.status}\n                </Badge>\n              </div>\n              \n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Description</Label>\n                <p className=\"text-sm mt-1 whitespace-pre-wrap\">\n                  {selectedTask.description ? renderTextWithLinks(selectedTask.description) : 'No description provided'}\n                </p>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Deal</Label>\n                  <p className=\"text-sm mt-1\">{getDealName(selectedTask.dealId)}</p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Due Date & Time</Label>\n                  <p className={cn(\n                    \"text-sm mt-1 flex items-center gap-1\",\n                    (selectedTask.status === 'Overdue' || isTaskOverdue(selectedTask.dueDate, selectedTask.status)) && \"text-red-500 font-medium\"\n                  )}>\n                    {selectedTask.dueDate ? (\n                      <>\n                        {selectedTask.status === 'Overdue' || isTaskOverdue(selectedTask.dueDate, selectedTask.status) ? (\n                          <AlertCircle className=\"w-3 h-3\" />\n                        ) : selectedTask.dueDate.includes('T') ? (\n                          <Clock className=\"w-3 h-3\" />\n                        ) : (\n                          <Calendar className=\"w-3 h-3\" />\n                        )}\n                        {formatDueDateTime(selectedTask.dueDate)}\n                      </>\n                    ) : 'No due date'}\n                  </p>\n                </div>\n              </div>\n              \n              {selectedTask.attachments && Array.isArray(selectedTask.attachments) && selectedTask.attachments.length > 0 && (\n                <div>\n                  <Label className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                    <Paperclip className=\"w-3 h-3\" /> Attachments\n                  </Label>\n                  <div className=\"mt-2 space-y-2\">\n                    {(selectedTask.attachments as any[]).map((attachment: any, i: number) => {\n                      const filename = typeof attachment === 'string' ? attachment : attachment?.filename || attachment?.name || 'Attachment';\n                      const url = typeof attachment === 'string' ? attachment : attachment?.url;\n                      return (\n                        <div key={i} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                          <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"text-sm flex-1 truncate\">{filename}</span>\n                          <div className=\"flex items-center gap-1\">\n                            {url && (\n                              <Button \n                                variant=\"ghost\" \n                                size=\"icon\" \n                                className=\"h-6 w-6\"\n                                onClick={() => window.open(url, '_blank')}\n                                title=\"View\"\n                                data-testid={`view-attachment-${i}`}\n                              >\n                                <ExternalLink className=\"w-3 h-3\" />\n                              </Button>\n                            )}\n                            {url && (\n                              <Button \n                                variant=\"ghost\" \n                                size=\"icon\" \n                                className=\"h-6 w-6\"\n                                onClick={() => {\n                                  const link = document.createElement('a');\n                                  link.href = url;\n                                  link.download = filename;\n                                  document.body.appendChild(link);\n                                  link.click();\n                                  document.body.removeChild(link);\n                                }}\n                                title=\"Download\"\n                                data-testid={`download-attachment-${i}`}\n                              >\n                                <Download className=\"w-3 h-3\" />\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter className=\"gap-2\">\n            <Button \n              variant=\"destructive\" \n              onClick={() => selectedTask && handleDeleteTask(selectedTask.id)}\n              data-testid=\"button-delete-task\"\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" /> Delete\n            </Button>\n            <Button variant=\"outline\" onClick={() => selectedTask && openEditModal(selectedTask)} data-testid=\"button-edit-task\">\n              Edit\n            </Button>\n            <Button variant=\"outline\" onClick={() => setShowTaskDetailModal(false)}>\n              Close\n            </Button>\n            {selectedTask?.status !== 'Completed' && (\n              <Button onClick={() => selectedTask && handleCompleteTask(selectedTask.id)}>\n                <Check className=\"w-4 h-4 mr-2\" /> Mark Complete\n              </Button>\n            )}\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Forward Task Modal */}\n      <Dialog open={showForwardModal} onOpenChange={setShowForwardModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Forward Task</DialogTitle>\n            <DialogDescription>\n              Choose a team member to forward \"{selectedTask?.title}\" to\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Select Team Member</Label>\n              <Select value={forwardToUser} onValueChange={setForwardToUser}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Choose a team member\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.filter(u => u.id !== currentUser?.id).map(user => (\n                    <SelectItem key={user.id} value={user.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <User className=\"w-4 h-4\" />\n                        <span>{user.name}</span>\n                        <span className=\"text-muted-foreground\">({user.jobTitle || user.role})</span>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowForwardModal(false)}>\n              Cancel\n            </Button>\n            <Button onClick={handleForwardTask} disabled={!forwardToUser}>\n              <Send className=\"w-4 h-4 mr-2\" /> Forward Task\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* AI Analysis Modal */}\n      <Dialog open={showAIModal} onOpenChange={setShowAIModal}>\n        <DialogContent className=\"bg-card border-border max-w-xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Brain className=\"w-5 h-5 text-primary\" />\n              AI Task Analysis\n            </DialogTitle>\n            <DialogDescription>\n              Analyzing \"{selectedTask?.title}\" to suggest next steps\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            {isAnalyzing ? (\n              <div className=\"flex flex-col items-center justify-center py-8\">\n                <Loader2 className=\"w-8 h-8 animate-spin text-primary mb-4\" />\n                <p className=\"text-muted-foreground\">Analyzing task details...</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">Considering deal stage and IB best practices</p>\n              </div>\n            ) : aiSuggestion ? (\n              <>\n                <div className=\"p-4 bg-primary/10 rounded-lg border border-primary/20\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <h4 className=\"font-medium text-sm\">Recommended Action</h4>\n                    {aiSuggestion.estimatedTime && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        <Clock className=\"w-3 h-3 mr-1\" />\n                        {aiSuggestion.estimatedTime}\n                      </Badge>\n                    )}\n                  </div>\n                  <p className=\"text-lg font-semibold\">{aiSuggestion.action}</p>\n                </div>\n                \n                <div>\n                  <h4 className=\"font-medium text-sm mb-2\">Reasoning</h4>\n                  <p className=\"text-sm text-muted-foreground\">{aiSuggestion.reasoning}</p>\n                </div>\n                \n                {aiSuggestion.keySteps && aiSuggestion.keySteps.length > 0 && (\n                  <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                    <h4 className=\"font-medium text-sm mb-2 flex items-center gap-2\">\n                      <ListChecks className=\"w-4 h-4\" />\n                      Key Steps\n                    </h4>\n                    <ol className=\"space-y-1.5 text-sm text-muted-foreground\">\n                      {aiSuggestion.keySteps.map((step: string, i: number) => (\n                        <li key={i} className=\"flex items-start gap-2\">\n                          <span className=\"flex-shrink-0 w-5 h-5 bg-primary/20 rounded-full flex items-center justify-center text-xs font-medium text-primary\">\n                            {i + 1}\n                          </span>\n                          <span>{step}</span>\n                        </li>\n                      ))}\n                    </ol>\n                  </div>\n                )}\n                \n                <Separator />\n                \n                <div>\n                  <h4 className=\"font-medium text-sm mb-3\">Choose an App to Start Working</h4>\n                  <p className=\"text-xs text-muted-foreground mb-3\">Click an app below to open it. When finished, swipe left on the task to send your work.</p>\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    {(aiSuggestion.apps || []).map((app, i) => (\n                      <Button \n                        key={i} \n                        variant=\"outline\" \n                        className=\"h-auto py-3 px-4 flex flex-col items-start gap-1 hover:bg-primary/10 hover:border-primary/30 transition-all\"\n                        onClick={() => selectedTask && openAppForTask(app, selectedTask)}\n                        data-testid={`button-open-app-${i}`}\n                      >\n                        <div className=\"flex items-center gap-2 w-full\">\n                          <span className=\"text-xl\">{app.icon}</span>\n                          <span className=\"font-medium text-sm\">{app.name}</span>\n                          <ExternalLink className=\"w-3 h-3 ml-auto text-muted-foreground\" />\n                        </div>\n                        <span className=\"text-[10px] text-muted-foreground text-left\">{app.description}</span>\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              </>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>No analysis available</p>\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAIModal(false)}>\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Enhanced Send Work Modal */}\n      <Dialog open={showSendWorkModal} onOpenChange={(open) => { if (!open) resetSendWorkModal(); else setShowSendWorkModal(true); }}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Send className=\"w-5 h-5 text-primary\" />\n              Send Completed Work\n            </DialogTitle>\n            <DialogDescription>\n              Send your completed work for \"{selectedTask?.title}\"\n            </DialogDescription>\n          </DialogHeader>\n          \n          <Tabs value={sendWorkTab} onValueChange={(v) => {\n            setSendWorkTab(v as 'internal' | 'external');\n            // Reset tab-specific selections when switching tabs\n            setSelectedInternalUsers([]);\n            setInternalUserSearch(\"\");\n            setExternalRecipientId(\"\");\n            setExternalRecipientEmail(\"\");\n            setExternalRecipientName(\"\");\n            setExternalRecipientCompany(\"\");\n            setStakeholderSearch(\"\");\n            setShowAddNewContact(false);\n          }}>\n            <TabsList className=\"grid w-full grid-cols-2\">\n              <TabsTrigger value=\"internal\" className=\"flex items-center gap-2\">\n                <User className=\"w-4 h-4\" /> Internal Team\n              </TabsTrigger>\n              <TabsTrigger value=\"external\" className=\"flex items-center gap-2\">\n                <Send className=\"w-4 h-4\" /> External (Email)\n              </TabsTrigger>\n            </TabsList>\n            \n            {/* Shared: Work Notes & Attachments */}\n            <div className=\"space-y-4 py-4\">\n              <div className=\"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg\">\n                <p className=\"text-xs text-blue-400\">\n                  <strong>Tip:</strong> Upload your completed files below. {sendWorkTab === 'internal' \n                    ? 'Recipients will see the task in their MyTasks page.' \n                    : 'Recipients will receive an email with your message and file links.'}\n                </p>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>{sendWorkTab === 'external' ? 'Message' : 'Work Notes'} (Optional)</Label>\n                <Textarea\n                  placeholder={sendWorkTab === 'external' \n                    ? \"Write a message to include in the email...\" \n                    : \"Describe what you completed, any notes for the recipient...\"}\n                  value={sendWorkTab === 'external' ? externalEmailMessage : completedWorkNotes}\n                  onChange={(e) => sendWorkTab === 'external' ? setExternalEmailMessage(e.target.value) : setCompletedWorkNotes(e.target.value)}\n                  rows={3}\n                  className=\"resize-none\"\n                  data-testid=\"textarea-work-notes\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Attach Completed Files</Label>\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      const input = document.createElement('input');\n                      input.type = 'file';\n                      input.multiple = true;\n                      input.onchange = async (e) => {\n                        const files = (e.target as HTMLInputElement).files;\n                        if (!files) return;\n                        for (const file of Array.from(files)) {\n                          const formData = new FormData();\n                          formData.append('file', file);\n                          try {\n                            const response = await fetch('/api/upload', { method: 'POST', body: formData });\n                            if (response.ok) {\n                              const uploaded = await response.json();\n                              setSendWorkAttachments(prev => [...prev, uploaded]);\n                              toast.success(`Attached: ${file.name}`);\n                            }\n                          } catch {\n                            toast.error(`Failed to upload ${file.name}`);\n                          }\n                        }\n                      };\n                      input.click();\n                    }}\n                    className=\"flex items-center gap-2\"\n                  >\n                    <Upload className=\"w-4 h-4\" /> Upload Files\n                  </Button>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {sendWorkAttachments.length > 0 ? `${sendWorkAttachments.length} file(s)` : 'No files'}\n                  </span>\n                </div>\n                {sendWorkAttachments.length > 0 && (\n                  <div className=\"space-y-1 mt-2 max-h-24 overflow-y-auto\">\n                    {sendWorkAttachments.map((file, idx) => (\n                      <div key={idx} className=\"flex items-center justify-between p-2 bg-secondary/30 rounded text-sm\">\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                          <Paperclip className=\"w-3 h-3 flex-shrink-0\" />\n                          <span className=\"truncate\">{file.filename}</span>\n                        </div>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={() => setSendWorkAttachments(prev => prev.filter((_, i) => i !== idx))}>\n                          <X className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n            \n            <TabsContent value=\"internal\" className=\"space-y-4 mt-0\">\n              <div className=\"space-y-2\">\n                <Label>Send To (select one or more team members) *</Label>\n                <Input\n                  placeholder=\"Search team members...\"\n                  value={internalUserSearch}\n                  onChange={(e) => setInternalUserSearch(e.target.value)}\n                  className=\"mb-2\"\n                  data-testid=\"input-search-internal-users\"\n                />\n                <ScrollArea className=\"h-40 border rounded-md p-2\">\n                  {users\n                    .filter(u => u.id !== currentUser?.id)\n                    .filter(u => internalUserSearch === '' || u.name.toLowerCase().includes(internalUserSearch.toLowerCase()))\n                    .map(user => (\n                      <div \n                        key={user.id} \n                        className={cn(\n                          \"flex items-center gap-3 p-2 rounded-md cursor-pointer hover:bg-secondary/50\",\n                          selectedInternalUsers.includes(user.id) && \"bg-primary/10 border border-primary/30\"\n                        )}\n                        onClick={() => {\n                          setSelectedInternalUsers(prev => \n                            prev.includes(user.id) \n                              ? prev.filter(id => id !== user.id) \n                              : [...prev, user.id]\n                          );\n                        }}\n                      >\n                        <Checkbox \n                          checked={selectedInternalUsers.includes(user.id)} \n                          onCheckedChange={() => {\n                            setSelectedInternalUsers(prev => \n                              prev.includes(user.id) \n                                ? prev.filter(id => id !== user.id) \n                                : [...prev, user.id]\n                            );\n                          }}\n                        />\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"font-medium\">{user.name}</span>\n                          <span className=\"text-xs text-muted-foreground\">({user.jobTitle || user.role})</span>\n                        </div>\n                      </div>\n                    ))}\n                </ScrollArea>\n                {selectedInternalUsers.length > 0 && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    {selectedInternalUsers.length} user(s) selected\n                  </p>\n                )}\n              </div>\n            </TabsContent>\n            \n            <TabsContent value=\"external\" className=\"space-y-4 mt-0\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label>Recipient</Label>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setShowAddNewContact(!showAddNewContact);\n                      setExternalRecipientId(\"\");\n                    }}\n                    className=\"text-xs\"\n                  >\n                    {showAddNewContact ? 'Select from Directory' : '+ Add New Contact'}\n                  </Button>\n                </div>\n                \n                {showAddNewContact ? (\n                  <div className=\"space-y-3 p-3 border rounded-lg bg-secondary/20\">\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs\">Name *</Label>\n                      <Input\n                        placeholder=\"Contact name\"\n                        value={externalRecipientName}\n                        onChange={(e) => setExternalRecipientName(e.target.value)}\n                        data-testid=\"input-external-name\"\n                      />\n                    </div>\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs\">Email *</Label>\n                      <Input\n                        type=\"email\"\n                        placeholder=\"email@example.com\"\n                        value={externalRecipientEmail}\n                        onChange={(e) => setExternalRecipientEmail(e.target.value)}\n                        data-testid=\"input-external-email\"\n                      />\n                    </div>\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs\">Company</Label>\n                      <Input\n                        placeholder=\"Company name (optional)\"\n                        value={externalRecipientCompany}\n                        onChange={(e) => setExternalRecipientCompany(e.target.value)}\n                        data-testid=\"input-external-company\"\n                      />\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      This contact will be saved to your directory for future use.\n                    </p>\n                  </div>\n                ) : (\n                  <>\n                    <Input\n                      placeholder=\"Search stakeholders...\"\n                      value={stakeholderSearch}\n                      onChange={(e) => setStakeholderSearch(e.target.value)}\n                      className=\"mb-2\"\n                      data-testid=\"input-search-stakeholders\"\n                    />\n                    <ScrollArea className=\"h-40 border rounded-md p-2\">\n                      {stakeholders\n                        .filter(s => s.email)\n                        .filter(s => stakeholderSearch === '' || \n                          s.name.toLowerCase().includes(stakeholderSearch.toLowerCase()) ||\n                          s.company?.toLowerCase().includes(stakeholderSearch.toLowerCase()) ||\n                          s.email?.toLowerCase().includes(stakeholderSearch.toLowerCase())\n                        )\n                        .map(stakeholder => (\n                          <div \n                            key={stakeholder.id} \n                            className={cn(\n                              \"flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-secondary/50\",\n                              externalRecipientId === stakeholder.id && \"bg-primary/10 border border-primary/30\"\n                            )}\n                            onClick={() => setExternalRecipientId(stakeholder.id)}\n                          >\n                            <div className=\"flex flex-col\">\n                              <span className=\"font-medium text-sm\">{stakeholder.name}</span>\n                              <span className=\"text-xs text-muted-foreground\">{stakeholder.email}</span>\n                            </div>\n                            <Badge variant=\"outline\" className=\"text-xs\">{stakeholder.type}</Badge>\n                          </div>\n                        ))}\n                      {stakeholders.filter(s => s.email).length === 0 && (\n                        <div className=\"text-center py-4 text-muted-foreground text-sm\">\n                          No stakeholders with email found. Click \"Add New Contact\" above.\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </>\n                )}\n              </div>\n            </TabsContent>\n          </Tabs>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={resetSendWorkModal}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleSendWork} \n              disabled={\n                (sendWorkTab === 'internal' && selectedInternalUsers.length === 0) ||\n                (sendWorkTab === 'external' && !externalRecipientId && !externalRecipientEmail) ||\n                isSendingExternal\n              }\n            >\n              {isSendingExternal ? (\n                <><Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> Sending...</>\n              ) : (\n                <><Send className=\"w-4 h-4 mr-2\" /> {sendWorkTab === 'internal' ? 'Send Work' : 'Send Email'}</>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Flag Note Dialog */}\n      <Dialog open={showFlagNoteDialog} onOpenChange={(open) => {\n        if (!open) {\n          setShowFlagNoteDialog(false);\n          setFlagNoteTaskId(null);\n          setFlagNote(\"\");\n        }\n      }}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Flag className=\"w-5 h-5 text-orange-500\" />\n              Flag Task\n            </DialogTitle>\n            <DialogDescription>\n              Add a note to explain why this task is being flagged\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Flag Note (Optional)</Label>\n              <Textarea\n                placeholder=\"Describe the issue or reason for flagging this task...\"\n                value={flagNote}\n                onChange={(e) => setFlagNote(e.target.value)}\n                rows={4}\n                className=\"resize-none\"\n                data-testid=\"textarea-flag-note\"\n              />\n            </div>\n            <div className=\"text-xs text-muted-foreground\">\n              This note will be visible to pod team members working on this project.\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => {\n              setShowFlagNoteDialog(false);\n              setFlagNoteTaskId(null);\n              setFlagNote(\"\");\n            }}>\n              Cancel\n            </Button>\n            <Button onClick={confirmFlag} className=\"bg-orange-500 hover:bg-orange-600\">\n              <Flag className=\"w-4 h-4 mr-2\" /> Flag Task\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Task Dialog */}\n      <Dialog open={showCreateTaskModal} onOpenChange={setShowCreateTaskModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Plus className=\"w-5 h-5 text-primary\" />\n              Create New Task\n            </DialogTitle>\n            <DialogDescription>\n              Add a new task to your to-do list\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Task Title *</Label>\n              <Input\n                placeholder=\"Enter task title...\"\n                value={newTaskForm.title}\n                onChange={(e) => setNewTaskForm({ ...newTaskForm, title: e.target.value })}\n                data-testid=\"input-new-task-title\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Description</Label>\n              <Textarea\n                placeholder=\"Add details about this task...\"\n                value={newTaskForm.description}\n                onChange={(e) => setNewTaskForm({ ...newTaskForm, description: e.target.value })}\n                rows={3}\n                className=\"resize-none\"\n                data-testid=\"textarea-new-task-description\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Priority</Label>\n                <Select \n                  value={newTaskForm.priority} \n                  onValueChange={(value: 'Low' | 'Medium' | 'High' | 'Urgent') => setNewTaskForm({ ...newTaskForm, priority: value })}\n                >\n                  <SelectTrigger data-testid=\"select-new-task-priority\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Low\">Low</SelectItem>\n                    <SelectItem value=\"Medium\">Medium</SelectItem>\n                    <SelectItem value=\"High\">High</SelectItem>\n                    <SelectItem value=\"Urgent\">Urgent</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Type</Label>\n                <Select \n                  value={newTaskForm.type} \n                  onValueChange={(value: typeof newTaskForm.type) => setNewTaskForm({ ...newTaskForm, type: value })}\n                >\n                  <SelectTrigger data-testid=\"select-new-task-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"General\">General</SelectItem>\n                    <SelectItem value=\"Document Review\">Document Review</SelectItem>\n                    <SelectItem value=\"Due Diligence\">Due Diligence</SelectItem>\n                    <SelectItem value=\"Client Communication\">Client Communication</SelectItem>\n                    <SelectItem value=\"Financial Analysis\">Financial Analysis</SelectItem>\n                    <SelectItem value=\"Legal\">Legal</SelectItem>\n                    <SelectItem value=\"Compliance\">Compliance</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Due Date & Time (Optional)</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  type=\"date\"\n                  value={newTaskForm.dueDate}\n                  onChange={(e) => setNewTaskForm({ ...newTaskForm, dueDate: e.target.value })}\n                  className=\"flex-1\"\n                  data-testid=\"input-new-task-due-date\"\n                />\n                <Select \n                  value={newTaskForm.dueTime || 'none'} \n                  onValueChange={(value) => setNewTaskForm({ ...newTaskForm, dueTime: value === 'none' ? '' : value })}\n                >\n                  <SelectTrigger className=\"w-36\" data-testid=\"select-new-task-due-time\">\n                    <SelectValue placeholder=\"Time\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {timeOptions.map(opt => (\n                      <SelectItem key={opt.value || 'none'} value={opt.value || 'none'}>{opt.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">Leave blank to save as a draft without deadline</p>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Related Deal (Optional)</Label>\n              <Select \n                value={newTaskForm.dealId} \n                onValueChange={(value) => setNewTaskForm({ ...newTaskForm, dealId: value })}\n              >\n                <SelectTrigger data-testid=\"select-new-task-deal\">\n                  <SelectValue placeholder=\"Select a deal...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">No deal</SelectItem>\n                  {deals.map(deal => (\n                    <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Attachments (Optional)</Label>\n              <div\n                onDragOver={handleDragOver}\n                onDragLeave={handleDragLeave}\n                onDrop={handleDrop}\n                className={cn(\n                  \"border-2 border-dashed rounded-lg p-4 transition-colors cursor-pointer\",\n                  isDragging ? \"border-primary bg-primary/10\" : \"border-border hover:border-primary/50\"\n                )}\n                onClick={() => fileInputRef.current?.click()}\n              >\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  multiple\n                  onChange={handleFileSelect}\n                  className=\"hidden\"\n                  data-testid=\"input-task-attachment\"\n                />\n                <div className=\"flex flex-col items-center gap-2 text-center\">\n                  {isUploading ? (\n                    <>\n                      <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n                      <span className=\"text-sm text-muted-foreground\">Uploading...</span>\n                    </>\n                  ) : (\n                    <>\n                      <Upload className=\"w-8 h-8 text-muted-foreground\" />\n                      <span className=\"text-sm text-muted-foreground\">\n                        Drag & drop files here, or click to browse\n                      </span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        Supports documents, images, videos up to 500MB\n                      </span>\n                    </>\n                  )}\n                </div>\n              </div>\n              {uploadedFiles.length > 0 && (\n                <div className=\"space-y-2\">\n                  {uploadedFiles.map((file, index) => (\n                    <div key={file.id} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded text-sm\">\n                      <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"truncate flex-1\">{file.filename}</span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {file.size >= 1024 * 1024 \n                          ? `${(file.size / (1024 * 1024)).toFixed(1)} MB`\n                          : `${(file.size / 1024).toFixed(1)} KB`\n                        }\n                      </span>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          window.open(file.url, '_blank');\n                        }}\n                        title=\"View\"\n                        data-testid={`view-upload-${index}`}\n                      >\n                        <ExternalLink className=\"w-3 h-3\" />\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          const link = document.createElement('a');\n                          link.href = file.url;\n                          link.download = file.filename;\n                          document.body.appendChild(link);\n                          link.click();\n                          document.body.removeChild(link);\n                        }}\n                        title=\"Download\"\n                        data-testid={`download-upload-${index}`}\n                      >\n                        <Download className=\"w-3 h-3\" />\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6 text-red-500 hover:text-red-700\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          removeAttachment(index);\n                        }}\n                        title=\"Remove\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateTaskModal(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleCreateTask} \n              disabled={createTask.isPending}\n              data-testid=\"button-create-task-submit\"\n            >\n              {createTask.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Creating...\n                </>\n              ) : (\n                <>\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Create Task\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Task Dialog */}\n      <Dialog open={showEditTaskModal} onOpenChange={setShowEditTaskModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Pencil className=\"w-5 h-5 text-primary\" />\n              Edit Task\n            </DialogTitle>\n            <DialogDescription>\n              Update task details\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Task Title *</Label>\n              <Input\n                placeholder=\"Enter task title...\"\n                value={editTaskForm.title}\n                onChange={(e) => setEditTaskForm({ ...editTaskForm, title: e.target.value })}\n                data-testid=\"input-edit-task-title\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Description</Label>\n              <Textarea\n                placeholder=\"Add details about this task...\"\n                value={editTaskForm.description}\n                onChange={(e) => setEditTaskForm({ ...editTaskForm, description: e.target.value })}\n                rows={3}\n                className=\"resize-none\"\n                data-testid=\"textarea-edit-task-description\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Priority</Label>\n                <Select \n                  value={editTaskForm.priority} \n                  onValueChange={(value: 'Low' | 'Medium' | 'High' | 'Urgent') => setEditTaskForm({ ...editTaskForm, priority: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-task-priority\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Low\">Low</SelectItem>\n                    <SelectItem value=\"Medium\">Medium</SelectItem>\n                    <SelectItem value=\"High\">High</SelectItem>\n                    <SelectItem value=\"Urgent\">Urgent</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Type</Label>\n                <Select \n                  value={editTaskForm.type} \n                  onValueChange={(value: typeof editTaskForm.type) => setEditTaskForm({ ...editTaskForm, type: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-task-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"General\">General</SelectItem>\n                    <SelectItem value=\"Document Review\">Document Review</SelectItem>\n                    <SelectItem value=\"Due Diligence\">Due Diligence</SelectItem>\n                    <SelectItem value=\"Client Communication\">Client Communication</SelectItem>\n                    <SelectItem value=\"Financial Analysis\">Financial Analysis</SelectItem>\n                    <SelectItem value=\"Legal\">Legal</SelectItem>\n                    <SelectItem value=\"Compliance\">Compliance</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Due Date & Time (Optional)</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  type=\"date\"\n                  value={editTaskForm.dueDate}\n                  onChange={(e) => setEditTaskForm({ ...editTaskForm, dueDate: e.target.value })}\n                  className=\"flex-1\"\n                  data-testid=\"input-edit-task-due-date\"\n                />\n                <Select \n                  value={editTaskForm.dueTime || 'none'} \n                  onValueChange={(value) => setEditTaskForm({ ...editTaskForm, dueTime: value === 'none' ? '' : value })}\n                >\n                  <SelectTrigger className=\"w-36\" data-testid=\"select-edit-task-due-time\">\n                    <SelectValue placeholder=\"Time\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {timeOptions.map(opt => (\n                      <SelectItem key={opt.value || 'none'} value={opt.value || 'none'}>{opt.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">Leave blank to save as a draft without deadline</p>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Related Deal (Optional)</Label>\n              <Select \n                value={editTaskForm.dealId || 'none'} \n                onValueChange={(value) => setEditTaskForm({ ...editTaskForm, dealId: value === 'none' ? '' : value })}\n              >\n                <SelectTrigger data-testid=\"select-edit-task-deal\">\n                  <SelectValue placeholder=\"Select a deal...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">No deal</SelectItem>\n                  {deals.map(deal => (\n                    <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Attachments</Label>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const input = document.createElement('input');\n                    input.type = 'file';\n                    input.multiple = true;\n                    input.onchange = async (e) => {\n                      const files = (e.target as HTMLInputElement).files;\n                      if (!files) return;\n                      for (const file of Array.from(files)) {\n                        const formData = new FormData();\n                        formData.append('file', file);\n                        try {\n                          const response = await fetch('/api/upload', {\n                            method: 'POST',\n                            body: formData,\n                          });\n                          if (response.ok) {\n                            const uploaded = await response.json();\n                            setEditAttachments(prev => [...prev, uploaded]);\n                            toast.success(`Added: ${file.name}`);\n                          }\n                        } catch {\n                          toast.error(`Failed to upload ${file.name}`);\n                        }\n                      }\n                    };\n                    input.click();\n                  }}\n                  className=\"flex items-center gap-2\"\n                >\n                  <Upload className=\"w-4 h-4\" />\n                  Add Files\n                </Button>\n                <span className=\"text-xs text-muted-foreground\">\n                  {editAttachments.length > 0 ? `${editAttachments.length} file(s)` : 'No files attached'}\n                </span>\n              </div>\n              {editAttachments.length > 0 && (\n                <div className=\"space-y-1 mt-2 max-h-32 overflow-y-auto\">\n                  {editAttachments.map((file, idx) => (\n                    <div key={file.id || idx} className=\"flex items-center justify-between p-2 bg-secondary/30 rounded text-sm\">\n                      <div className=\"flex items-center gap-2 min-w-0\">\n                        <Paperclip className=\"w-3 h-3 flex-shrink-0\" />\n                        <span className=\"truncate\">{file.filename}</span>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6 flex-shrink-0\"\n                        onClick={() => setEditAttachments(prev => prev.filter((_, i) => i !== idx))}\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditTaskModal(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleEditTask} \n              disabled={updateTask.isPending}\n              data-testid=\"button-edit-task-submit\"\n            >\n              {updateTask.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Saving...\n                </>\n              ) : (\n                <>\n                  <Check className=\"w-4 h-4 mr-2\" />\n                  Save Changes\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n    </Layout>\n  );\n\n  async function handleStartTask(taskId: string) {\n    try {\n      await updateTask.mutateAsync({ id: taskId, status: 'In Progress' });\n      toast.success(\"Task started!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to start task\");\n    }\n  }\n}\n\ninterface SwipeableTaskCardProps {\n  task: Task;\n  dealName: string;\n  onSwipe: (direction: SwipeDirection) => void;\n  onClick: () => void;\n}\n\nfunction SwipeableTaskCard({ task, dealName, onSwipe, onClick }: SwipeableTaskCardProps) {\n  const x = useMotionValue(0);\n  const y = useMotionValue(0);\n  const isDragging = useRef(false);\n  const dragDistance = useRef(0);\n  \n  const rotateZ = useTransform(x, [-200, 0, 200], [-15, 0, 15]);\n  const opacity = useTransform(x, [-200, -100, 0, 100, 200], [0.5, 1, 1, 1, 0.5]);\n  \n  const rightIndicatorOpacity = useTransform(x, [0, 100], [0, 1]);\n  const leftIndicatorOpacity = useTransform(x, [-100, 0], [1, 0]);\n  const upIndicatorOpacity = useTransform(y, [-100, 0], [1, 0]);\n  \n  const handleDragStart = () => {\n    isDragging.current = true;\n    dragDistance.current = 0;\n  };\n  \n  const handleDrag = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    dragDistance.current = Math.max(\n      dragDistance.current,\n      Math.abs(info.offset.x) + Math.abs(info.offset.y)\n    );\n  };\n  \n  const handleDragEnd = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    const threshold = 100;\n    \n    if (info.offset.y < -threshold) {\n      onSwipe('up');\n    } else if (info.offset.x > threshold) {\n      onSwipe('right');\n    } else if (info.offset.x < -threshold) {\n      onSwipe('left');\n    }\n    \n    setTimeout(() => {\n      isDragging.current = false;\n    }, 50);\n  };\n  \n  const handleClick = (e: React.MouseEvent) => {\n    if (isDragging.current || dragDistance.current > 10) {\n      e.preventDefault();\n      e.stopPropagation();\n      return;\n    }\n    onClick();\n  };\n\n  return (\n    <motion.div\n      drag\n      dragConstraints={{ left: 0, right: 0, top: 0, bottom: 0 }}\n      dragElastic={0.7}\n      dragTransition={{ bounceStiffness: 300, bounceDamping: 20 }}\n      onDragStart={handleDragStart}\n      onDrag={handleDrag}\n      onDragEnd={handleDragEnd}\n      style={{ x, y, rotateZ, opacity }}\n      initial={{ scale: 0.9, opacity: 0 }}\n      animate={{ scale: 1, opacity: 1 }}\n      exit={{ scale: 0.9, opacity: 0 }}\n      transition={{ type: \"spring\", stiffness: 300, damping: 25 }}\n      onClick={handleClick}\n      className=\"absolute w-full max-w-md cursor-grab active:cursor-grabbing\"\n    >\n      <Card className=\"bg-card border-border shadow-xl\">\n        <CardContent className=\"p-6 space-y-4\">\n          <div className=\"flex justify-between items-start\">\n            <Badge variant=\"outline\" className={cn(\n              \"text-xs\",\n              task.priority === 'High' ? \"bg-red-500/10 text-red-500 border-red-500/20\" : \n              task.priority === 'Medium' ? \"bg-yellow-500/10 text-yellow-500 border-yellow-500/20\" :\n              \"bg-blue-500/10 text-blue-500 border-blue-500/20\"\n            )}>\n              {task.priority} Priority\n            </Badge>\n            <Badge variant=\"secondary\">{task.type}</Badge>\n          </div>\n          \n          <div>\n            <h3 className=\"text-xl font-semibold\">{task.title}</h3>\n            <p className=\"text-sm text-muted-foreground mt-2 line-clamp-2\">\n              {task.description || 'No description'}\n            </p>\n          </div>\n          \n          <div className=\"flex items-center gap-4 pt-2 border-t border-border/50 text-sm text-muted-foreground\">\n            <div className=\"flex items-center gap-1\">\n              <Briefcase className=\"w-4 h-4\" />\n              <span>{dealName}</span>\n            </div>\n            {task.dueDate && (\n              <div className={cn(\n                \"flex items-center gap-1\",\n                (task.status === 'Overdue' || isTaskOverdue(task.dueDate, task.status)) && \"text-red-500 font-medium\"\n              )}>\n                {task.status === 'Overdue' || isTaskOverdue(task.dueDate, task.status) ? (\n                  <AlertCircle className=\"w-4 h-4\" />\n                ) : task.dueDate.includes('T') ? (\n                  <Clock className=\"w-4 h-4\" />\n                ) : (\n                  <Calendar className=\"w-4 h-4\" />\n                )}\n                <span>{formatDueDateTime(task.dueDate)}</span>\n              </div>\n            )}\n          </div>\n          \n          {/* Swipe overlay indicators */}\n          <motion.div\n            style={{ opacity: rightIndicatorOpacity }}\n            className=\"absolute inset-0 bg-green-500/20 rounded-lg flex items-center justify-center pointer-events-none\"\n          >\n            <div className=\"bg-green-500 text-white px-4 py-2 rounded-full font-medium\">\n              Defer\n            </div>\n          </motion.div>\n          \n          <motion.div\n            style={{ opacity: leftIndicatorOpacity }}\n            className=\"absolute inset-0 bg-blue-500/20 rounded-lg flex items-center justify-center pointer-events-none\"\n          >\n            <div className=\"bg-blue-500 text-white px-4 py-2 rounded-full font-medium\">\n              Forward\n            </div>\n          </motion.div>\n          \n          <motion.div\n            style={{ opacity: upIndicatorOpacity }}\n            className=\"absolute inset-0 bg-purple-500/20 rounded-lg flex items-center justify-center pointer-events-none\"\n          >\n            <div className=\"bg-purple-500 text-white px-4 py-2 rounded-full font-medium\">\n              AI Assist\n            </div>\n          </motion.div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\ninterface TaskCardProps {\n  task: Task;\n  dealName: string;\n  onClick: () => void;\n  highlighted?: boolean;\n  completed?: boolean;\n  isFlagged?: boolean;\n  onFlag?: (e: React.MouseEvent) => void;\n}\n\nconst TaskCard = ({ task, dealName, onClick, highlighted, completed, isFlagged, onFlag, ref }: TaskCardProps & { ref?: React.Ref<HTMLDivElement> }) => {\n  return (\n    <Card \n      ref={ref}\n      className={cn(\n        \"bg-card border-border hover:border-primary/50 transition-all cursor-pointer group\",\n        highlighted && \"ring-2 ring-primary border-primary animate-pulse\",\n        completed && \"opacity-60\",\n        isFlagged && \"border-orange-500/50 bg-orange-500/5\"\n      )}\n      onClick={onClick}\n      data-testid={`card-task-${task.id}`}\n    >\n      <CardContent className=\"p-3 space-y-2\">\n        <div className=\"flex justify-between items-start gap-2\">\n          <Badge variant=\"outline\" className={cn(\n            \"text-[10px] px-1.5 py-0.5 h-5 shrink-0\",\n            completed ? \"bg-green-500/10 text-green-500 border-green-500/20\" :\n            task.priority === 'High' ? \"bg-red-500/10 text-red-500 border-red-500/20\" : \n            task.priority === 'Medium' ? \"bg-yellow-500/10 text-yellow-500 border-yellow-500/20\" :\n            \"bg-blue-500/10 text-blue-500 border-blue-500/20\"\n          )}>\n            {completed ? 'Done' : task.priority}\n          </Badge>\n          <div className=\"flex items-center gap-1\">\n            {onFlag && (\n              <button\n                onClick={onFlag}\n                className={cn(\n                  \"p-1 rounded hover:bg-secondary/50 transition-colors\",\n                  isFlagged ? \"text-orange-500\" : \"text-muted-foreground opacity-0 group-hover:opacity-100\"\n                )}\n                data-testid={`flag-task-${task.id}`}\n              >\n                <Flag className=\"w-3.5 h-3.5\" fill={isFlagged ? \"currentColor\" : \"none\"} />\n              </button>\n            )}\n            <Badge variant=\"secondary\" className=\"text-[10px]\">{task.type}</Badge>\n          </div>\n        </div>\n        \n        <div>\n          <h4 className={cn(\n            \"font-medium text-sm\",\n            completed && \"line-through\"\n          )}>{task.title}</h4>\n          <p className=\"text-xs text-muted-foreground mt-0.5\">{dealName}</p>\n        </div>\n        \n        {task.dueDate && !completed && (\n          <div className={cn(\n            \"flex items-center gap-1 text-xs\",\n            task.status === 'Overdue' || isTaskOverdue(task.dueDate, task.status) \n              ? \"text-red-500 font-medium\" \n              : \"text-muted-foreground\"\n          )}>\n            {task.status === 'Overdue' || isTaskOverdue(task.dueDate, task.status) ? (\n              <AlertCircle className=\"w-3 h-3\" />\n            ) : task.dueDate.includes('T') ? (\n              <Clock className=\"w-3 h-3\" />\n            ) : (\n              <Calendar className=\"w-3 h-3\" />\n            )}\n            <span>\n              {task.status === 'Overdue' && 'OVERDUE: '}\n              {formatDueDateTime(task.dueDate)}\n            </span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n};\n","path":null,"size_bytes":120287,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1598,"size_tokens":null},"client/src/components/ui/button-group.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nconst buttonGroupVariants = cva(\n  \"flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1\",\n  {\n    variants: {\n      orientation: {\n        horizontal:\n          \"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none\",\n        vertical:\n          \"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none\",\n      },\n    },\n    defaultVariants: {\n      orientation: \"horizontal\",\n    },\n  }\n)\n\nfunction ButtonGroup({\n  className,\n  orientation,\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof buttonGroupVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"button-group\"\n      data-orientation={orientation}\n      className={cn(buttonGroupVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupText({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  asChild?: boolean\n}) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      className={cn(\n        \"bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupSeparator({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"button-group-separator\"\n      orientation={orientation}\n      className={cn(\n        \"bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  ButtonGroup,\n  ButtonGroupSeparator,\n  ButtonGroupText,\n  buttonGroupVariants,\n}\n","path":null,"size_bytes":2209,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport {\n  ChevronDownIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n} from \"lucide-react\"\nimport { DayButton, DayPicker, getDefaultClassNames } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button, buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  captionLayout = \"label\",\n  buttonVariant = \"ghost\",\n  formatters,\n  components,\n  ...props\n}: React.ComponentProps<typeof DayPicker> & {\n  buttonVariant?: React.ComponentProps<typeof Button>[\"variant\"]\n}) {\n  const defaultClassNames = getDefaultClassNames()\n\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\n        \"bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent\",\n        String.raw`rtl:**:[.rdp-button\\_next>svg]:rotate-180`,\n        String.raw`rtl:**:[.rdp-button\\_previous>svg]:rotate-180`,\n        className\n      )}\n      captionLayout={captionLayout}\n      formatters={{\n        formatMonthDropdown: (date) =>\n          date.toLocaleString(\"default\", { month: \"short\" }),\n        ...formatters,\n      }}\n      classNames={{\n        root: cn(\"w-fit\", defaultClassNames.root),\n        months: cn(\n          \"relative flex flex-col gap-4 md:flex-row\",\n          defaultClassNames.months\n        ),\n        month: cn(\"flex w-full flex-col gap-4\", defaultClassNames.month),\n        nav: cn(\n          \"absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1\",\n          defaultClassNames.nav\n        ),\n        button_previous: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_previous\n        ),\n        button_next: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_next\n        ),\n        month_caption: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]\",\n          defaultClassNames.month_caption\n        ),\n        dropdowns: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium\",\n          defaultClassNames.dropdowns\n        ),\n        dropdown_root: cn(\n          \"has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border\",\n          defaultClassNames.dropdown_root\n        ),\n        dropdown: cn(\n          \"bg-popover absolute inset-0 opacity-0\",\n          defaultClassNames.dropdown\n        ),\n        caption_label: cn(\n          \"select-none font-medium\",\n          captionLayout === \"label\"\n            ? \"text-sm\"\n            : \"[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5\",\n          defaultClassNames.caption_label\n        ),\n        table: \"w-full border-collapse\",\n        weekdays: cn(\"flex\", defaultClassNames.weekdays),\n        weekday: cn(\n          \"text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal\",\n          defaultClassNames.weekday\n        ),\n        week: cn(\"mt-2 flex w-full\", defaultClassNames.week),\n        week_number_header: cn(\n          \"w-[--cell-size] select-none\",\n          defaultClassNames.week_number_header\n        ),\n        week_number: cn(\n          \"text-muted-foreground select-none text-[0.8rem]\",\n          defaultClassNames.week_number\n        ),\n        day: cn(\n          \"group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md\",\n          defaultClassNames.day\n        ),\n        range_start: cn(\n          \"bg-accent rounded-l-md\",\n          defaultClassNames.range_start\n        ),\n        range_middle: cn(\"rounded-none\", defaultClassNames.range_middle),\n        range_end: cn(\"bg-accent rounded-r-md\", defaultClassNames.range_end),\n        today: cn(\n          \"bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none\",\n          defaultClassNames.today\n        ),\n        outside: cn(\n          \"text-muted-foreground aria-selected:text-muted-foreground\",\n          defaultClassNames.outside\n        ),\n        disabled: cn(\n          \"text-muted-foreground opacity-50\",\n          defaultClassNames.disabled\n        ),\n        hidden: cn(\"invisible\", defaultClassNames.hidden),\n        ...classNames,\n      }}\n      components={{\n        Root: ({ className, rootRef, ...props }) => {\n          return (\n            <div\n              data-slot=\"calendar\"\n              ref={rootRef}\n              className={cn(className)}\n              {...props}\n            />\n          )\n        },\n        Chevron: ({ className, orientation, ...props }) => {\n          if (orientation === \"left\") {\n            return (\n              <ChevronLeftIcon className={cn(\"size-4\", className)} {...props} />\n            )\n          }\n\n          if (orientation === \"right\") {\n            return (\n              <ChevronRightIcon\n                className={cn(\"size-4\", className)}\n                {...props}\n              />\n            )\n          }\n\n          return (\n            <ChevronDownIcon className={cn(\"size-4\", className)} {...props} />\n          )\n        },\n        DayButton: CalendarDayButton,\n        WeekNumber: ({ children, ...props }) => {\n          return (\n            <td {...props}>\n              <div className=\"flex size-[--cell-size] items-center justify-center text-center\">\n                {children}\n              </div>\n            </td>\n          )\n        },\n        ...components,\n      }}\n      {...props}\n    />\n  )\n}\n\nfunction CalendarDayButton({\n  className,\n  day,\n  modifiers,\n  ...props\n}: React.ComponentProps<typeof DayButton>) {\n  const defaultClassNames = getDefaultClassNames()\n\n  const ref = React.useRef<HTMLButtonElement>(null)\n  React.useEffect(() => {\n    if (modifiers.focused) ref.current?.focus()\n  }, [modifiers.focused])\n\n  return (\n    <Button\n      ref={ref}\n      variant=\"ghost\"\n      size=\"icon\"\n      data-day={day.date.toLocaleDateString()}\n      data-selected-single={\n        modifiers.selected &&\n        !modifiers.range_start &&\n        !modifiers.range_end &&\n        !modifiers.range_middle\n      }\n      data-range-start={modifiers.range_start}\n      data-range-end={modifiers.range_end}\n      data-range-middle={modifiers.range_middle}\n      className={cn(\n        \"data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70\",\n        defaultClassNames.day,\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Calendar, CalendarDayButton }\n","path":null,"size_bytes":7569,"size_tokens":null},"client/src/pages/ceo/DealManagement.tsx":{"content":"import { useState, useMemo, useEffect, useRef, useCallback } from \"react\";\nimport { useDebounce } from \"@/hooks/useDebounce\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useSearch } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  Search, Filter, MoreVertical, ArrowRight, Calendar, DollarSign, Briefcase, \n  Pencil, Trash2, Eye, Users, Phone, Mail, MessageSquare, Plus, X, \n  Building2, TrendingUp, FileText, Clock, CheckCircle2, ChevronRight,\n  UserPlus, History, LayoutGrid, CalendarDays, ChevronLeft, Upload, GitCompare, ArrowUpDown, BarChart3,\n  Mic, MicOff, Play, Pause, Square, Volume2, Download, UserCircle, ExternalLink, ArrowLeftCircle\n} from \"lucide-react\";\nimport { \n  useCurrentUser, useDealsListing, useDeal, useCreateDeal, useUpdateDeal, useDeleteDeal, useMoveDealToOpportunity, useUsers, useTasks, useCreateDealFee,\n  useStageDocuments, useCreateStageDocument, useDeleteStageDocument,\n  useStagePodMembers, useCreateStagePodMember, useDeleteStagePodMember,\n  useStageVoiceNotes, useCreateStageVoiceNote, useDeleteStageVoiceNote,\n  useTaskComments, useCreateTaskComment, useCreateTask, useDeleteTask,\n  useCustomSectors, useCreateCustomSector,\n  useDealFees, type DealFeeType,\n  useCreateDocument,\n  useAllInvestors,\n  useDealNotes, useCreateDealNote, type DealNoteType,\n  useOnboardingStatus, type OnboardingStatus\n} from \"@/lib/api\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { Check, ChevronsUpDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format, startOfWeek, endOfWeek, startOfMonth, endOfMonth, eachDayOfInterval, isSameDay, addDays, addWeeks, addMonths, subDays, subWeeks, subMonths, isToday, isBefore, isAfter, parseISO } from \"date-fns\";\nimport type { Deal, PodTeamMember, TaggedInvestor, AuditEntry } from \"@shared/schema\";\nimport { isDealEligibleUser } from \"@shared/schema\";\nimport { ObjectUploader, type UploadedFile } from \"@/components/ObjectUploader\";\nimport {\n  RadarChart,\n  PolarGrid,\n  PolarAngleAxis,\n  PolarRadiusAxis,\n  Radar,\n  ResponsiveContainer,\n  Legend,\n  Tooltip\n} from \"recharts\";\n\nconst COMPARISON_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];\n\nconst DEAL_STAGES = ['Origination', 'Structuring', 'Diligence', 'Legal', 'Close'];\n\nfunction DealStageTeamCount({ dealId, stage }: { dealId: string; stage: string }) {\n  const { data: stagePodMembers = [] } = useStagePodMembers(dealId, stage);\n  const [showPopover, setShowPopover] = useState(false);\n  \n  return (\n    <Popover open={showPopover} onOpenChange={setShowPopover}>\n      <PopoverTrigger asChild>\n        <div className=\"cursor-pointer hover:text-primary transition-colors\" onClick={(e) => { e.stopPropagation(); setShowPopover(true); }}>\n          <span className=\"font-medium\">{stagePodMembers.length} members</span>\n        </div>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-72 p-3\" align=\"start\" onClick={(e) => e.stopPropagation()}>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n              <Users className=\"w-4 h-4 text-blue-400\" />\n              {stage} Stage Team\n            </h4>\n            <Badge variant=\"secondary\" className=\"text-xs\">{stagePodMembers.length}</Badge>\n          </div>\n          {stagePodMembers.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">No team members assigned to this stage yet</p>\n          ) : (\n            <ScrollArea className=\"max-h-48\">\n              <div className=\"space-y-2\">\n                {stagePodMembers.map((member: any) => (\n                  <div key={member.id} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div className=\"w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm font-medium\">\n                      {member.userName?.charAt(0) || '?'}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                      <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nfunction DealTotalTeamCount({ dealId, podTeam = [] }: { dealId: string; podTeam?: PodTeamMember[] }) {\n  const { data: allStagePodMembers = [] } = useStagePodMembers(dealId);\n  const [showPopover, setShowPopover] = useState(false);\n  \n  const distinctMembers = useMemo(() => {\n    const seen = new Map<string, any>();\n    // Add stage pod members\n    allStagePodMembers.forEach((member: any) => {\n      if (member.userId && !seen.has(member.userId)) {\n        seen.set(member.userId, { ...member, source: 'stage' });\n      }\n    });\n    // Add pod team members (legacy)\n    podTeam.forEach((member: PodTeamMember) => {\n      if (member.userId && !seen.has(member.userId)) {\n        seen.set(member.userId, { userId: member.userId, userName: member.name, role: member.role, source: 'pod' });\n      }\n    });\n    return Array.from(seen.values());\n  }, [allStagePodMembers, podTeam]);\n  \n  return (\n    <Popover open={showPopover} onOpenChange={setShowPopover}>\n      <PopoverTrigger asChild>\n        <div className=\"cursor-pointer hover:text-primary transition-colors\" onClick={(e) => { e.stopPropagation(); setShowPopover(true); }}>\n          <span className=\"font-medium\">{distinctMembers.length} members</span>\n        </div>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-72 p-3\" align=\"start\" onClick={(e) => e.stopPropagation()}>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n              <Users className=\"w-4 h-4 text-blue-400\" />\n              Deal Team\n            </h4>\n            <Badge variant=\"secondary\" className=\"text-xs\">{distinctMembers.length}</Badge>\n          </div>\n          {distinctMembers.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">No team members assigned yet</p>\n          ) : (\n            <ScrollArea className=\"max-h-48\">\n              <div className=\"space-y-2\">\n                {distinctMembers.map((member: any) => (\n                  <div key={member.userId} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div className=\"w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm font-medium\">\n                      {member.userName?.charAt(0) || '?'}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                      <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nfunction DealTotalTeamCountNumber({ dealId, podTeam = [] }: { dealId: string; podTeam?: PodTeamMember[] }) {\n  const { data: allStagePodMembers = [] } = useStagePodMembers(dealId);\n  \n  const distinctCount = useMemo(() => {\n    const seen = new Set<string>();\n    // Add stage pod members\n    allStagePodMembers.forEach((member: any) => {\n      if (member.userId) {\n        seen.add(member.userId);\n      }\n    });\n    // Add pod team members (legacy)\n    podTeam.forEach((member: PodTeamMember) => {\n      if (member.userId) {\n        seen.add(member.userId);\n      }\n    });\n    return seen.size;\n  }, [allStagePodMembers, podTeam]);\n  \n  return <>{distinctCount}</>;\n}\n\nfunction DealNotesSection({ dealId, allUsers }: { dealId: string; allUsers: any[] }) {\n  const { data: notes = [], isLoading } = useDealNotes(dealId);\n  const createDealNote = useCreateDealNote();\n  const [newNote, setNewNote] = useState(\"\");\n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const filteredUsers = useMemo(() => {\n    if (!mentionQuery) return allUsers.slice(0, 5);\n    return allUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    ).slice(0, 5);\n  }, [allUsers, mentionQuery]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    const position = e.target.selectionStart || 0;\n    setNewNote(value);\n    setCursorPosition(position);\n\n    const textBeforeCursor = value.slice(0, position);\n    const atMatch = textBeforeCursor.match(/@(\\w*)$/);\n    if (atMatch) {\n      setShowMentions(true);\n      setMentionQuery(atMatch[1]);\n    } else {\n      setShowMentions(false);\n      setMentionQuery(\"\");\n    }\n  };\n\n  const insertMention = (userName: string) => {\n    const textBeforeCursor = newNote.slice(0, cursorPosition);\n    const textAfterCursor = newNote.slice(cursorPosition);\n    const beforeAt = textBeforeCursor.replace(/@\\w*$/, '');\n    const mentionName = userName.replace(/\\s+/g, '');\n    const newText = `${beforeAt}@${mentionName} ${textAfterCursor}`;\n    setNewNote(newText);\n    setShowMentions(false);\n    setMentionQuery(\"\");\n    textareaRef.current?.focus();\n  };\n\n  const handleSubmit = async () => {\n    if (!newNote.trim()) return;\n    try {\n      await createDealNote.mutateAsync({ dealId, content: newNote.trim() });\n      setNewNote(\"\");\n      toast.success(\"Note added\");\n    } catch {\n      toast.error(\"Failed to add note\");\n    }\n  };\n\n  const renderContentWithMentions = (content: string) => {\n    const parts = content.split(/(@\\w+)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith('@')) {\n        return <span key={i} className=\"text-primary font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Loading notes...</div>;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"font-medium flex items-center gap-2\">\n          <MessageSquare className=\"w-4 h-4\" />\n          Deal Notes\n        </h4>\n        <Badge variant=\"secondary\">{notes.length} notes</Badge>\n      </div>\n\n      <div className=\"relative\">\n        <Textarea\n          ref={textareaRef}\n          placeholder=\"Add a note... Use @ to mention team members\"\n          value={newNote}\n          onChange={handleInputChange}\n          className=\"min-h-[80px]\"\n          data-testid=\"input-deal-note\"\n        />\n        {showMentions && filteredUsers.length > 0 && (\n          <div className=\"absolute bottom-full left-0 mb-1 w-64 bg-popover border rounded-md shadow-lg z-50 max-h-48 overflow-auto\">\n            {filteredUsers.map(user => (\n              <button\n                key={user.id}\n                className=\"w-full px-3 py-2 text-left hover:bg-accent flex items-center gap-2\"\n                onClick={() => insertMention(user.name)}\n              >\n                <div className=\"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-xs\">\n                  {user.name.charAt(0)}\n                </div>\n                <span className=\"text-sm\">{user.name}</span>\n              </button>\n            ))}\n          </div>\n        )}\n        <div className=\"flex justify-end mt-2\">\n          <Button \n            size=\"sm\" \n            onClick={handleSubmit}\n            disabled={!newNote.trim() || createDealNote.isPending}\n            data-testid=\"button-submit-deal-note\"\n          >\n            <Plus className=\"w-4 h-4 mr-1\" /> Add Note\n          </Button>\n        </div>\n      </div>\n\n      <ScrollArea className=\"h-[300px]\">\n        <div className=\"space-y-3\">\n          {notes.map((note: DealNoteType) => (\n            <div key={note.id} className=\"p-3 bg-secondary/30 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-sm font-medium flex-shrink-0\">\n                  {note.userName?.charAt(0) || '?'}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium text-sm\">{note.userName}</span>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {format(new Date(note.createdAt), 'MMM d, h:mm a')}\n                    </span>\n                  </div>\n                  <p className=\"text-sm mt-1 whitespace-pre-wrap\">\n                    {renderContentWithMentions(note.content)}\n                  </p>\n                </div>\n              </div>\n            </div>\n          ))}\n          {notes.length === 0 && (\n            <div className=\"text-center py-8 text-muted-foreground text-sm\">\n              No notes yet. Add the first note above.\n            </div>\n          )}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n\nconst INVESTOR_TYPES = ['PE', 'VC', 'Strategic', 'Family Office', 'Hedge Fund', 'Sovereign Wealth'];\nconst INVESTOR_STATUSES = ['Contacted', 'Interested', 'In DD', 'Term Sheet', 'Passed', 'Closed'];\n\ntype StageWorkSectionProps = {\n  dealId: string;\n  dealName: string;\n  dealStage: string;\n  allUsers: any[];\n  currentUser: any;\n  allTasks: any[];\n  activeStageTab: string;\n  setActiveStageTab: (stage: string) => void;\n  createStageDocument: any;\n  deleteStageDocument: any;\n  createStagePodMember: any;\n  deleteStagePodMember: any;\n  createStageVoiceNote: any;\n  deleteStageVoiceNote: any;\n  createTaskComment: any;\n  createTask: any;\n  createDocument: any;\n  deleteTask: any;\n  onAuditEntry?: (action: string, details: string) => Promise<void>;\n  totalTeamCount?: number;\n  onboardingStatus?: OnboardingStatus;\n  onShowOnboardingWarning?: (userName: string, missingResume: boolean, missingPersonality: boolean, onConfirm?: () => void) => void;\n};\n\nfunction StageWorkSection({\n  dealId,\n  dealName,\n  dealStage,\n  allUsers,\n  currentUser,\n  allTasks,\n  activeStageTab,\n  setActiveStageTab,\n  createStageDocument,\n  deleteStageDocument,\n  createStagePodMember,\n  deleteStagePodMember,\n  createStageVoiceNote,\n  deleteStageVoiceNote,\n  createTaskComment,\n  createTask,\n  createDocument,\n  deleteTask,\n  onAuditEntry,\n  totalTeamCount,\n  onboardingStatus = {},\n  onShowOnboardingWarning\n}: StageWorkSectionProps) {\n  const { data: stageDocuments = [] } = useStageDocuments(dealId, activeStageTab);\n  const { data: stagePodMembers = [] } = useStagePodMembers(dealId, activeStageTab);\n  const { data: stageVoiceNotes = [] } = useStageVoiceNotes(dealId, activeStageTab);\n  \n  const [showAddDocument, setShowAddDocument] = useState(false);\n  const [showAddMember, setShowAddMember] = useState(false);\n  const [showAddTask, setShowAddTask] = useState(false);\n  const [showTeamPopover, setShowTeamPopover] = useState(false);\n  const [documentTitle, setDocumentTitle] = useState(\"\");\n  const [documentCategory, setDocumentCategory] = useState(\"General\");\n  const [documentFiles, setDocumentFiles] = useState<File[]>([]);\n  const [memberSearch, setMemberSearch] = useState(\"\");\n  const [selectedMember, setSelectedMember] = useState<any>(null);\n  const [memberRole, setMemberRole] = useState(\"\");\n  const [newTaskTitle, setNewTaskTitle] = useState(\"\");\n  const [newTaskPriority, setNewTaskPriority] = useState(\"Medium\");\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingTime, setRecordingTime] = useState(0);\n  const [voiceTitle, setVoiceTitle] = useState(\"\");\n  const recordingInterval = useRef<NodeJS.Timeout | null>(null);\n  \n  const [expandedTask, setExpandedTask] = useState<string | null>(null);\n  \n  useEffect(() => {\n    return () => {\n      if (recordingInterval.current) {\n        clearInterval(recordingInterval.current);\n      }\n    };\n  }, []);\n  \n  const stageTasks = useMemo(() => {\n    return allTasks.filter((task: any) => \n      task.dealId === dealId && \n      (task.dealStage === activeStageTab || (!task.dealStage && activeStageTab === dealStage))\n    );\n  }, [allTasks, dealId, activeStageTab, dealStage]);\n  \n  const filteredMembers = useMemo(() => {\n    if (!memberSearch || memberSearch.length < 2) return [];\n    const query = memberSearch.toLowerCase();\n    return allUsers\n      .filter((user: any) => isDealEligibleUser(user)) // Only show deal-eligible users\n      .filter((user: any) => \n        user.name.toLowerCase().includes(query) || \n        user.email.toLowerCase().includes(query)\n      ).slice(0, 5);\n  }, [allUsers, memberSearch]);\n  \n  const handleAddDocument = async () => {\n    if (documentFiles.length === 0) {\n      toast.error(\"Please select at least one file to upload\");\n      return;\n    }\n    \n    const categoryMap: Record<string, string> = {\n      'General': 'Other',\n      'Financial': 'Financial Documents',\n      'Legal': 'Legal',\n      'Technical': 'Reports',\n      'Presentation': 'Presentations'\n    };\n    \n    let uploadedCount = 0;\n    let failedCount = 0;\n    \n    try {\n      for (const file of documentFiles) {\n        try {\n          const title = file.name;\n          \n          // First upload the file to get a URL\n          const formData = new FormData();\n          formData.append('file', file);\n          \n          const uploadResponse = await fetch('/api/upload', {\n            method: 'POST',\n            body: formData,\n          });\n          \n          if (!uploadResponse.ok) {\n            throw new Error('Failed to upload file');\n          }\n          \n          const uploadResult = await uploadResponse.json();\n          const fileUrl = uploadResult.url;\n          \n          // Save to stage documents with the URL\n          await createStageDocument.mutateAsync({\n            dealId,\n            doc: {\n              stage: activeStageTab,\n              title: title,\n              filename: file.name,\n              url: fileUrl,\n              mimeType: file.type,\n              size: file.size,\n            }\n          });\n          \n          // Also read file as base64 for document library archive\n          const base64Data = await new Promise<string>((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onload = (e) => resolve(e.target?.result as string);\n            reader.onerror = () => reject(new Error(\"Failed to read file\"));\n            reader.readAsDataURL(file);\n          });\n          \n          try {\n            await createDocument.mutateAsync({\n              title: title,\n              filename: `[${dealName}] ${title}`,\n              content: base64Data,\n              category: categoryMap[documentCategory] || 'Other',\n              dealId: dealId,\n              tags: [activeStageTab, 'Stage Work'],\n              type: 'stage_document',\n              uploadedBy: currentUser?.id,\n              originalName: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n          } catch (archiveError) {\n            console.error('Failed to archive document (non-critical):', archiveError);\n          }\n          \n          uploadedCount++;\n        } catch (error) {\n          console.error(`Failed to upload ${file.name}:`, error);\n          failedCount++;\n        }\n      }\n      \n      if (onAuditEntry && uploadedCount > 0) {\n        await onAuditEntry('Documents Uploaded', `${uploadedCount} document(s) uploaded to ${activeStageTab} stage`);\n      }\n      \n      if (uploadedCount > 0) {\n        toast.success(`${uploadedCount} document(s) uploaded successfully${failedCount > 0 ? `, ${failedCount} failed` : ''}`);\n      } else {\n        toast.error(\"Failed to upload documents\");\n      }\n      \n      setDocumentTitle(\"\");\n      setDocumentCategory(\"General\");\n      setDocumentFiles([]);\n      setShowAddDocument(false);\n      if (fileInputRef.current) fileInputRef.current.value = '';\n    } catch (error) {\n      toast.error(\"Failed to upload documents\");\n    }\n  };\n  \n  const handleAddTask = async () => {\n    if (!newTaskTitle.trim()) {\n      toast.error(\"Please enter a task title\");\n      return;\n    }\n    try {\n      const nextWeek = new Date();\n      nextWeek.setDate(nextWeek.getDate() + 7);\n      await createTask.mutateAsync({\n        title: newTaskTitle.trim(),\n        description: '',\n        status: 'Pending',\n        priority: newTaskPriority,\n        dealId: dealId,\n        dealStage: activeStageTab,\n        assignedTo: currentUser?.id || undefined,\n        type: 'Deal Task',\n        dueDate: nextWeek.toISOString().split('T')[0]\n      });\n      if (onAuditEntry) {\n        await onAuditEntry('Task Created', `${newTaskTitle.trim()} created in ${activeStageTab} stage`);\n      }\n      toast.success(\"Task created\");\n      setNewTaskTitle(\"\");\n      setNewTaskPriority(\"Medium\");\n      setShowAddTask(false);\n    } catch (error) {\n      toast.error(\"Failed to create task\");\n    }\n  };\n  \n  const handleAddMember = async () => {\n    if (!selectedMember) {\n      toast.error(\"Please select a team member\");\n      return;\n    }\n    try {\n      await createStagePodMember.mutateAsync({\n        dealId,\n        member: {\n          stage: activeStageTab,\n          userId: selectedMember.id,\n          userName: selectedMember.name,\n          role: memberRole || selectedMember.role || 'Team Member',\n          email: selectedMember.email || '',\n          phone: selectedMember.phone || '',\n        }\n      });\n      if (onAuditEntry) {\n        await onAuditEntry('Team Member Added', `${selectedMember.name} added to ${activeStageTab} stage`);\n      }\n      toast.success(\"Team member added to stage\");\n      setSelectedMember(null);\n      setMemberSearch(\"\");\n      setMemberRole(\"\");\n      setShowAddMember(false);\n    } catch (error) {\n      toast.error(\"Failed to add team member\");\n    }\n  };\n  \n  const startRecording = () => {\n    setIsRecording(true);\n    setRecordingTime(0);\n    recordingInterval.current = setInterval(() => {\n      setRecordingTime(prev => prev + 1);\n    }, 1000);\n    toast.info(\"Recording started\");\n  };\n  \n  const stopRecording = async () => {\n    setIsRecording(false);\n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n    }\n    \n    if (recordingTime > 0) {\n      try {\n        await createStageVoiceNote.mutateAsync({\n          dealId,\n          note: {\n            stage: activeStageTab,\n            title: voiceTitle || `Note ${format(new Date(), 'MMM d, h:mm a')}`,\n            filename: `voice_note_${Date.now()}.webm`,\n            duration: recordingTime,\n          }\n        });\n        toast.success(\"Voice note saved!\");\n      } catch (error) {\n        toast.error(\"Failed to save voice note\");\n      }\n    }\n    \n    setVoiceTitle(\"\");\n    setRecordingTime(0);\n  };\n  \n  const cancelRecording = () => {\n    setIsRecording(false);\n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n    }\n    setRecordingTime(0);\n    setVoiceTitle(\"\");\n  };\n  \n  const formatDuration = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n  \n  const getStageIndex = (stage: string) => DEAL_STAGES.indexOf(stage);\n  \n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center gap-1 p-1 bg-secondary/30 rounded-lg\">\n        {DEAL_STAGES.map((stage, index) => {\n          const isCurrentStage = dealStage === stage;\n          const isPastStage = getStageIndex(dealStage) > index;\n          const isActive = activeStageTab === stage;\n          return (\n            <Button\n              key={stage}\n              variant={isActive ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              className={cn(\n                \"flex-1 text-xs relative\",\n                isActive && \"bg-primary text-primary-foreground\",\n                !isActive && isCurrentStage && \"ring-1 ring-primary/50\",\n                !isActive && isPastStage && \"text-muted-foreground\"\n              )}\n              onClick={() => setActiveStageTab(stage)}\n            >\n              {stage}\n              {isCurrentStage && (\n                <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full\" />\n              )}\n            </Button>\n          );\n        })}\n      </div>\n      \n      <div className=\"text-xs text-muted-foreground text-center\">\n        Viewing stage: <span className=\"font-medium text-foreground\">{activeStageTab}</span>\n        {activeStageTab === dealStage && <span className=\"ml-1 text-green-500\">(Current)</span>}\n      </div>\n      \n      <div className=\"grid grid-cols-3 gap-3\">\n        <Card className=\"bg-secondary/20\">\n          <CardContent className=\"p-3 text-center\">\n            <FileText className=\"w-4 h-4 mx-auto mb-1 text-blue-400\" />\n            <div className=\"text-lg font-bold\">{stageDocuments.length}</div>\n            <div className=\"text-xs text-muted-foreground\">Documents</div>\n          </CardContent>\n        </Card>\n        <Popover open={showTeamPopover} onOpenChange={setShowTeamPopover}>\n          <PopoverTrigger asChild>\n            <Card \n              className=\"bg-secondary/20 cursor-pointer hover:bg-secondary/30 transition-colors\"\n              onClick={(e) => { e.stopPropagation(); setShowTeamPopover(true); }}\n            >\n              <CardContent className=\"p-3 text-center\">\n                <Users className=\"w-4 h-4 mx-auto mb-1 text-blue-400\" />\n                <div className=\"text-lg font-bold\">{stagePodMembers.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Team</div>\n              </CardContent>\n            </Card>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-72 p-3\" align=\"center\" onClick={(e) => e.stopPropagation()}>\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                  <Users className=\"w-4 h-4 text-blue-400\" />\n                  {activeStageTab} Stage Team\n                </h4>\n                <Badge variant=\"secondary\" className=\"text-xs\">{stagePodMembers.length}</Badge>\n              </div>\n              {stagePodMembers.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">No team members assigned to this stage yet</p>\n              ) : (\n                <ScrollArea className=\"max-h-48\">\n                  <div className=\"space-y-2\">\n                    {stagePodMembers.map((member: any) => (\n                      <div key={member.id} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                        <div className=\"w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm font-medium\">\n                          {member.userName?.charAt(0) || '?'}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                          <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              )}\n            </div>\n          </PopoverContent>\n        </Popover>\n        <Card className=\"bg-secondary/20\">\n          <CardContent className=\"p-3 text-center\">\n            <Mic className=\"w-4 h-4 mx-auto mb-1 text-purple-400\" />\n            <div className=\"text-lg font-bold\">{stageVoiceNotes.length}</div>\n            <div className=\"text-xs text-muted-foreground\">Notes</div>\n          </CardContent>\n        </Card>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <FileText className=\"w-4 h-4 text-blue-400\" /> Stage Documents\n          </h5>\n          <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddDocument(!showAddDocument)}>\n            <Plus className=\"w-4 h-4\" />\n          </Button>\n        </div>\n        \n        {showAddDocument && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              multiple\n              onChange={(e) => {\n                const files = e.target.files;\n                if (files && files.length > 0) {\n                  setDocumentFiles(Array.from(files));\n                }\n              }}\n              className=\"w-full text-sm file:mr-3 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:bg-primary file:text-primary-foreground hover:file:bg-primary/90\"\n              data-testid=\"input-file-upload\"\n            />\n            {documentFiles.length > 0 && (\n              <div className=\"text-xs text-muted-foreground\">\n                Selected: {documentFiles.length} file(s) - {documentFiles.map(f => f.name).join(', ')}\n              </div>\n            )}\n            <Select value={documentCategory} onValueChange={setDocumentCategory}>\n              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-document-category\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"General\">General</SelectItem>\n                <SelectItem value=\"Financial\">Financial</SelectItem>\n                <SelectItem value=\"Legal\">Legal</SelectItem>\n                <SelectItem value=\"Technical\">Technical</SelectItem>\n                <SelectItem value=\"Presentation\">Presentation</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={handleAddDocument} className=\"flex-1\" disabled={documentFiles.length === 0} data-testid=\"button-upload-document\">\n                Upload\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddDocument(false); setDocumentFiles([]); setDocumentTitle(''); }}>Cancel</Button>\n            </div>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[100px]\">\n          {stageDocuments.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No documents for this stage\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              {stageDocuments.map((doc: any) => (\n                <div key={doc.id} className=\"flex items-center justify-between p-2 bg-secondary/20 rounded text-sm group\">\n                  <div className=\"flex items-center gap-2\">\n                    <FileText className=\"w-3 h-3 text-blue-400\" />\n                    <span className=\"truncate\">{doc.title}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100\">\n                    {(doc.url || doc.fileData) && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => {\n                          const viewUrl = doc.url || doc.fileData;\n                          if (viewUrl) window.open(viewUrl, '_blank');\n                        }}\n                        title=\"View\"\n                        data-testid={`view-doc-${doc.id}`}\n                      >\n                        <ExternalLink className=\"w-3 h-3 text-green-400\" />\n                      </Button>\n                    )}\n                    {(doc.url || doc.fileData) && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => {\n                          const downloadUrl = doc.url || doc.fileData;\n                          if (downloadUrl) {\n                            const link = document.createElement('a');\n                            link.href = downloadUrl;\n                            link.download = doc.filename || doc.title || 'document';\n                            document.body.appendChild(link);\n                            link.click();\n                            document.body.removeChild(link);\n                          }\n                        }}\n                        title=\"Download\"\n                        data-testid={`download-doc-${doc.id}`}\n                      >\n                        <Download className=\"w-3 h-3 text-blue-400\" />\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-6 w-6\"\n                      onClick={() => deleteStageDocument.mutate({ id: doc.id, dealId, stage: activeStageTab })}\n                      title=\"Delete\"\n                      data-testid={`delete-doc-${doc.id}`}\n                    >\n                      <X className=\"w-3 h-3 text-red-400\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <Users className=\"w-4 h-4 text-green-400\" /> Stage Team\n          </h5>\n          <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddMember(!showAddMember)}>\n            <Plus className=\"w-4 h-4\" />\n          </Button>\n        </div>\n        \n        {showAddMember && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by name or email...\"\n                value={memberSearch}\n                onChange={(e) => setMemberSearch(e.target.value)}\n                className=\"h-8 text-sm pl-7\"\n                data-testid=\"input-team-search\"\n              />\n            </div>\n            {memberSearch.length >= 2 && (\n              <div className=\"max-h-[120px] overflow-y-auto border rounded-md bg-background\">\n                {filteredMembers.length === 0 ? (\n                  <div className=\"p-2 text-sm text-muted-foreground text-center\">No users found</div>\n                ) : (\n                  filteredMembers.map((user: any) => {\n                    const userOnboarding = onboardingStatus[user.id];\n                    const isOnboardingComplete = userOnboarding?.isComplete ?? false;\n                    return (\n                      <button\n                        key={user.id}\n                        onClick={() => {\n                          if (!isOnboardingComplete && onShowOnboardingWarning) {\n                            onShowOnboardingWarning(user.name, !userOnboarding?.hasResume, !userOnboarding?.hasPersonality, () => {\n                              setSelectedMember(user);\n                              setMemberRole(user.jobTitle || user.role || 'Team Member');\n                            });\n                            setMemberSearch('');\n                            return;\n                          }\n                          setSelectedMember(user);\n                          setMemberRole(user.jobTitle || user.role || 'Team Member');\n                          setMemberSearch('');\n                        }}\n                        className={cn(\n                          \"w-full p-2 text-left hover:bg-secondary/50 flex items-center gap-2 text-sm\",\n                          selectedMember?.id === user.id && \"bg-primary/10\"\n                        )}\n                        data-testid={`team-member-${user.id}`}\n                      >\n                        <div className={cn(\n                          \"w-6 h-6 rounded-full flex items-center justify-center text-xs\",\n                          isOnboardingComplete ? \"bg-green-500/20 text-green-400\" : \"bg-amber-500/20 text-amber-400\"\n                        )}>\n                          {user.name?.charAt(0) || '?'}\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"font-medium flex items-center gap-2\">\n                            {user.name}\n                            {!isOnboardingComplete && (\n                              <span className=\"text-[10px] px-1.5 py-0.5 bg-amber-500/20 text-amber-500 rounded\">Incomplete</span>\n                            )}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">{user.email}</div>\n                        </div>\n                      </button>\n                    );\n                  })\n                )}\n              </div>\n            )}\n            {selectedMember && (\n              <div className=\"flex items-center gap-2 p-2 bg-primary/10 rounded text-sm\">\n                <Check className=\"w-4 h-4 text-primary\" />\n                <span>Selected: {selectedMember.name}</span>\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 ml-auto\" onClick={() => setSelectedMember(null)}>\n                  <X className=\"w-3 h-3\" />\n                </Button>\n              </div>\n            )}\n            <Input\n              placeholder=\"Role for this stage\"\n              value={memberRole}\n              onChange={(e) => setMemberRole(e.target.value)}\n              className=\"h-8 text-sm\"\n              data-testid=\"input-member-role\"\n            />\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={handleAddMember} className=\"flex-1\" disabled={!selectedMember} data-testid=\"button-add-member\">Add Member</Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddMember(false); setSelectedMember(null); setMemberSearch(''); }}>Cancel</Button>\n            </div>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[80px]\">\n          {stagePodMembers.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No team members for this stage\n            </div>\n          ) : (\n            <div className=\"flex flex-wrap gap-2\">\n              {stagePodMembers.map((member: any) => (\n                <div key={member.id} className=\"flex items-center gap-1 px-2 py-1 bg-secondary/30 rounded-full text-xs group\">\n                  <div className=\"w-5 h-5 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-xs\">\n                    {member.userName?.charAt(0) || '?'}\n                  </div>\n                  <span>{member.userName || 'Unknown'}</span>\n                  <span className=\"text-muted-foreground\">({member.role})</span>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-4 w-4 opacity-0 group-hover:opacity-100\"\n                    onClick={() => deleteStagePodMember.mutate(member.id)}\n                  >\n                    <X className=\"w-3 h-3 text-red-400\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <Mic className=\"w-4 h-4 text-purple-400\" /> Voice Notes\n          </h5>\n        </div>\n        \n        {isRecording ? (\n          <div className=\"p-3 bg-red-500/10 border border-red-500/30 rounded-lg space-y-2\">\n            <div className=\"flex items-center justify-center gap-2 text-red-400\">\n              <div className=\"w-2 h-2 bg-red-500 rounded-full animate-pulse\" />\n              Recording: {formatDuration(recordingTime)}\n            </div>\n            <Input\n              placeholder=\"Voice note title (optional)\"\n              value={voiceTitle}\n              onChange={(e) => setVoiceTitle(e.target.value)}\n              className=\"h-8 text-sm\"\n            />\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={stopRecording} className=\"flex-1 bg-red-500 hover:bg-red-600\">\n                <Square className=\"w-3 h-3 mr-1\" /> Stop & Save\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={cancelRecording}>Cancel</Button>\n            </div>\n          </div>\n        ) : (\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            className=\"w-full\" \n            onClick={startRecording}\n          >\n            <Mic className=\"w-4 h-4 mr-2 text-purple-400\" /> Start Recording\n          </Button>\n        )}\n        \n        <ScrollArea className=\"h-[80px]\">\n          {stageVoiceNotes.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No voice notes for this stage\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              {stageVoiceNotes.map((note: any) => (\n                <div key={note.id} className=\"flex items-center justify-between p-2 bg-secondary/20 rounded text-sm group\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\n                      <Play className=\"w-3 h-3 text-purple-400\" />\n                    </Button>\n                    <div>\n                      <span className=\"truncate\">{note.title}</span>\n                      <span className=\"text-xs text-muted-foreground ml-2\">{formatDuration(note.duration)}</span>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100\">\n                    <span className=\"text-xs text-muted-foreground mr-1\">{note.recorderName || note.authorName}</span>\n                    {note.url && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => window.open(note.url, '_blank')}\n                        data-testid={`download-note-${note.id}`}\n                      >\n                        <Download className=\"w-3 h-3 text-purple-400\" />\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-6 w-6\"\n                      onClick={() => deleteStageVoiceNote.mutate(note.id)}\n                      data-testid={`delete-note-${note.id}`}\n                    >\n                      <X className=\"w-3 h-3 text-red-400\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      {/* Tasks Section */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <CheckCircle2 className=\"w-4 h-4 text-orange-400\" /> Deal Tasks\n          </h5>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"secondary\" className=\"text-xs\">{stageTasks.length} tasks</Badge>\n            <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddTask(!showAddTask)} data-testid=\"button-add-task-toggle\">\n              <Plus className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n        \n        {showAddTask && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <Input\n              placeholder=\"Task title\"\n              value={newTaskTitle}\n              onChange={(e) => setNewTaskTitle(e.target.value)}\n              className=\"h-8 text-sm\"\n              data-testid=\"input-task-title\"\n            />\n            <Select value={newTaskPriority} onValueChange={setNewTaskPriority}>\n              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-task-priority\">\n                <SelectValue placeholder=\"Priority\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Low\">Low Priority</SelectItem>\n                <SelectItem value=\"Medium\">Medium Priority</SelectItem>\n                <SelectItem value=\"High\">High Priority</SelectItem>\n                <SelectItem value=\"Critical\">Critical</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={handleAddTask} className=\"flex-1\" disabled={!newTaskTitle.trim()} data-testid=\"button-create-task\">\n                Create Task\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddTask(false); setNewTaskTitle(''); }}>Cancel</Button>\n            </div>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[150px]\">\n          {stageTasks.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No tasks for this deal\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {stageTasks.map((task: any) => (\n                <div key={task.id} className=\"bg-secondary/20 rounded-lg overflow-hidden group\">\n                  <div \n                    className=\"flex items-center justify-between p-2 cursor-pointer hover:bg-secondary/30\"\n                    onClick={() => setExpandedTask(expandedTask === task.id ? null : task.id)}\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <div className={cn(\n                        \"w-2 h-2 rounded-full\",\n                        task.status === 'Completed' ? \"bg-green-500\" :\n                        task.status === 'In Progress' ? \"bg-blue-500\" :\n                        \"bg-yellow-500\"\n                      )} />\n                      <span className=\"text-sm truncate\">{task.title}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {task.priority}\n                      </Badge>\n                      <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-6 w-6 opacity-0 group-hover:opacity-100\"\n                            onClick={(e) => e.stopPropagation()}\n                            data-testid={`delete-task-${task.id}`}\n                          >\n                            <X className=\"w-3 h-3 text-red-400\" />\n                          </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent onClick={(e) => e.stopPropagation()}>\n                          <AlertDialogHeader>\n                            <AlertDialogTitle>Delete Task</AlertDialogTitle>\n                            <AlertDialogDescription>\n                              Are you sure you want to delete \"{task.title}\"? This action cannot be undone.\n                            </AlertDialogDescription>\n                          </AlertDialogHeader>\n                          <AlertDialogFooter>\n                            <AlertDialogCancel>Cancel</AlertDialogCancel>\n                            <AlertDialogAction\n                              onClick={() => {\n                                deleteTask.mutate(task.id);\n                                toast.success(\"Task deleted\");\n                              }}\n                            >\n                              Delete\n                            </AlertDialogAction>\n                          </AlertDialogFooter>\n                        </AlertDialogContent>\n                      </AlertDialog>\n                      <ChevronRight className={cn(\n                        \"w-4 h-4 transition-transform\",\n                        expandedTask === task.id && \"rotate-90\"\n                      )} />\n                    </div>\n                  </div>\n                  \n                  {expandedTask === task.id && (\n                    <TaskComments \n                      taskId={task.id}\n                      currentUser={currentUser}\n                      createTaskComment={createTaskComment}\n                      users={allUsers}\n                    />\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n    </div>\n  );\n}\n\nfunction TaskComments({ \n  taskId,\n  currentUser,\n  createTaskComment,\n  users = []\n}: { \n  taskId: string;\n  currentUser: any;\n  createTaskComment: any;\n  users?: any[];\n}) {\n  const { data: comments = [] } = useTaskComments(taskId);\n  const [newComment, setNewComment] = useState(\"\");\n  const [showMentionDropdown, setShowMentionDropdown] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [mentionStartIndex, setMentionStartIndex] = useState<number | null>(null);\n  const [selectedMentionIndex, setSelectedMentionIndex] = useState(0);\n  const inputRef = useRef<HTMLInputElement>(null);\n  \n  const mentionableUsers = useMemo(() => {\n    const activeUsers = users.filter(u => u.status === 'active' && isDealEligibleUser(u));\n    if (!mentionQuery) return activeUsers.slice(0, 5);\n    return activeUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    ).slice(0, 5);\n  }, [users, mentionQuery]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    const cursorPos = e.target.selectionStart || 0;\n    setNewComment(value);\n    \n    const textBeforeCursor = value.substring(0, cursorPos);\n    const atIndex = textBeforeCursor.lastIndexOf('@');\n    \n    if (atIndex !== -1) {\n      const charBeforeAt = atIndex > 0 ? textBeforeCursor[atIndex - 1] : ' ';\n      if (charBeforeAt === ' ' || atIndex === 0) {\n        const query = textBeforeCursor.substring(atIndex + 1);\n        if (!query.includes(' ')) {\n          setMentionQuery(query);\n          setMentionStartIndex(atIndex);\n          setShowMentionDropdown(true);\n          setSelectedMentionIndex(0);\n          return;\n        }\n      }\n    }\n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n  };\n\n  const insertMention = (user: any) => {\n    if (mentionStartIndex === null) return;\n    const beforeMention = newComment.substring(0, mentionStartIndex);\n    const afterMention = newComment.substring(mentionStartIndex + mentionQuery.length + 1);\n    const newMessage = `${beforeMention}@${user.name} ${afterMention}`;\n    setNewComment(newMessage);\n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n    setSelectedMentionIndex(0);\n    inputRef.current?.focus();\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (!showMentionDropdown) {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        handleAddComment();\n      }\n      return;\n    }\n    \n    if (e.key === 'ArrowDown') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => \n        prev < mentionableUsers.length - 1 ? prev + 1 : prev\n      );\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => prev > 0 ? prev - 1 : 0);\n    } else if (e.key === 'Enter' || e.key === 'Tab') {\n      e.preventDefault();\n      if (mentionableUsers[selectedMentionIndex]) {\n        insertMention(mentionableUsers[selectedMentionIndex]);\n      }\n    } else if (e.key === 'Escape') {\n      setShowMentionDropdown(false);\n    }\n  };\n  \n  const handleAddComment = async () => {\n    if (!newComment.trim()) return;\n    try {\n      await createTaskComment.mutateAsync({\n        taskId,\n        comment: {\n          content: newComment.trim(),\n          authorId: currentUser?.id || '',\n          authorName: currentUser?.name || 'Unknown'\n        }\n      });\n      toast.success(\"Comment added\");\n      setNewComment(\"\");\n    } catch (error) {\n      toast.error(\"Failed to add comment\");\n    }\n  };\n\n  const renderContentWithMentions = (content: string) => {\n    const parts = content.split(/(@[A-Za-z]+(?:\\s[A-Za-z]+)*)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith('@')) {\n        return <span key={i} className=\"text-primary font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n  \n  return (\n    <div className=\"p-2 border-t border-border/50 space-y-2\">\n      <div className=\"text-xs text-muted-foreground\">Comments ({comments.length})</div>\n      \n      {comments.length > 0 && (\n        <div className=\"space-y-1 max-h-[100px] overflow-y-auto\">\n          {comments.map((comment: any) => (\n            <div key={comment.id} className=\"p-2 bg-secondary/30 rounded text-xs\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <span className=\"font-medium\">{comment.authorName}</span>\n                <span className=\"text-muted-foreground\">\n                  {format(new Date(comment.createdAt), 'MMM d, h:mm a')}\n                </span>\n              </div>\n              <p>{renderContentWithMentions(comment.content)}</p>\n            </div>\n          ))}\n        </div>\n      )}\n      \n      <div className=\"relative\">\n        <div className=\"flex gap-2\">\n          <Input\n            ref={inputRef}\n            placeholder=\"Add a comment... (use @ to mention)\"\n            value={newComment}\n            onChange={handleInputChange}\n            className=\"h-7 text-xs\"\n            onKeyDown={handleKeyDown}\n          />\n          <Button \n            size=\"sm\" \n            className=\"h-7 px-2\"\n            onClick={handleAddComment}\n          >\n            <Plus className=\"w-3 h-3\" />\n          </Button>\n        </div>\n        {showMentionDropdown && mentionableUsers.length > 0 && (\n          <div className=\"absolute bottom-full left-0 mb-1 w-48 bg-popover border border-border rounded-md shadow-lg z-50 max-h-32 overflow-y-auto\">\n            {mentionableUsers.map((user, index) => (\n              <div\n                key={user.id}\n                className={cn(\n                  \"px-2 py-1.5 text-xs cursor-pointer flex items-center gap-2\",\n                  index === selectedMentionIndex ? \"bg-accent\" : \"hover:bg-accent\"\n                )}\n                onClick={() => insertMention(user)}\n              >\n                <div className=\"w-5 h-5 rounded-full bg-primary/20 flex items-center justify-center text-[10px] font-medium text-primary\">\n                  {user.name.split(' ').map((n: string) => n[0]).join('')}\n                </div>\n                <span>{user.name}</span>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\ntype DealManagementProps = {\n  role?: 'CEO' | 'Employee';\n};\n\nexport default function DealManagement({ role = 'CEO' }: DealManagementProps) {\n  const searchString = useSearch();\n  const queryClient = useQueryClient();\n  const { data: currentUser } = useCurrentUser();\n  const { data: allDeals = [], isLoading } = useDealsListing();\n  const { data: allUsers = [] } = useUsers();\n  const { data: allTasks = [] } = useTasks();\n  const { data: stakeholders = [] } = useAllInvestors();\n  const { data: onboardingStatus = {} } = useOnboardingStatus();\n  \n  // Filter deals based on access level - non-admin users only see deals they're assigned to\n  // Filter out Opportunities and Asset Management deals - those appear in their own respective pages\n  const deals = useMemo(() => {\n    // Filter out opportunities and asset management deals - they have their own pages\n    const investmentBankingDeals = allDeals.filter(deal => {\n      const dealType = (deal as any).dealType;\n      return dealType !== 'Opportunity' && dealType !== 'Asset Management';\n    });\n    \n    if (currentUser?.accessLevel === 'admin') {\n      return investmentBankingDeals;\n    }\n    // For employees, filter to only show deals where they are in the pod team\n    // If user data is not yet available, show no deals until we can verify access\n    if (!currentUser?.id && !currentUser?.email && !currentUser?.name) {\n      return [];\n    }\n    return investmentBankingDeals.filter(deal => {\n      const podTeam = deal.podTeam || [];\n      return podTeam.some((member: PodTeamMember) => \n        (currentUser.id && member.userId === currentUser.id) || \n        (currentUser.email && member.email === currentUser.email) ||\n        (currentUser.name && member.name === currentUser.name)\n      );\n    });\n  }, [allDeals, role, currentUser]);\n  const createDeal = useCreateDeal();\n  const updateDeal = useUpdateDeal();\n  const deleteDeal = useDeleteDeal();\n  const moveDealToOpportunity = useMoveDealToOpportunity();\n  const createDealFee = useCreateDealFee();\n  const createDocument = useCreateDocument();\n  \n  // Custom sectors\n  const { data: customSectors = [] } = useCustomSectors();\n  const createCustomSector = useCreateCustomSector();\n  \n  // Stage-based mutations\n  const createStageDocument = useCreateStageDocument();\n  const deleteStageDocument = useDeleteStageDocument();\n  const createStagePodMember = useCreateStagePodMember();\n  const deleteStagePodMember = useDeleteStagePodMember();\n  const createStageVoiceNote = useCreateStageVoiceNote();\n  const deleteStageVoiceNote = useDeleteStageVoiceNote();\n  const createTaskComment = useCreateTaskComment();\n  const createTask = useCreateTask();\n  const deleteTask = useDeleteTask();\n\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const debouncedSearchQuery = useDebounce(searchQuery, 300);\n  const [stageFilter, setStageFilter] = useState<string | null>(null);\n  const [showNewDealModal, setShowNewDealModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [selectedDeal, setSelectedDeal] = useState<Deal | null>(null);\n  const [editingDeal, setEditingDeal] = useState<Deal | null>(null);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingLeadDealId, setEditingLeadDealId] = useState<string | null>(null);\n  const [editingLeadValue, setEditingLeadValue] = useState(\"\");\n  \n  // Client contact editing state\n  const [editingClientContact, setEditingClientContact] = useState(false);\n  const [clientContactForm, setClientContactForm] = useState({ name: '', email: '', phone: '', role: '' });\n  \n  // Fetch the FULL deal data (with attachments) when a deal is selected\n  const { data: fullDealData } = useDeal(selectedDeal?.id || '');\n  \n  // Use fullDealData for attachments display (includes large fields excluded from listing)\n  const selectedDealWithAttachments = fullDealData || selectedDeal;\n  \n  // Fetch fees for the selected deal\n  const { data: selectedDealFees = [] } = useDealFees(selectedDeal?.id || '');\n  // Fetch ALL stage pod members for the selected deal (across all stages)\n  const { data: allStagePodMembers = [] } = useStagePodMembers(selectedDeal?.id || '', undefined);\n  // Count unique team members (deduplicated by email or name)\n  const uniqueTeamCount = useMemo(() => {\n    const seen = new Set<string>();\n    allStagePodMembers.forEach((member: any) => {\n      const key = member.email || member.userName || member.userId || crypto.randomUUID();\n      seen.add(key);\n    });\n    return seen.size;\n  }, [allStagePodMembers]);\n  const [activeStageTab, setActiveStageTab] = useState(\"Origination\");\n  const [viewMode, setViewMode] = useState<'grid' | 'calendar' | 'compare'>('grid');\n  const [calendarView, setCalendarView] = useState<'day' | 'week' | 'month'>('week');\n  const [calendarDate, setCalendarDate] = useState(new Date());\n  const [selectedCalendarDeal, setSelectedCalendarDeal] = useState<Deal | null>(null);\n  const [calendarDealSearch, setCalendarDealSearch] = useState(\"\");\n  \n  const [selectedCompareDeals, setSelectedCompareDeals] = useState<string[]>([]);\n  const [compareSortBy, setCompareSortBy] = useState<string>(\"value\");\n  \n  // Task detail modal for calendar view\n  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);\n  const [selectedCalendarTask, setSelectedCalendarTask] = useState<any>(null);\n  \n  // Delete deal confirmation dialog\n  const [showDeleteDealDialog, setShowDeleteDealDialog] = useState(false);\n  const [dealToDelete, setDealToDelete] = useState<string | null>(null);\n  \n  // Onboarding warning dialog\n  const [showOnboardingWarning, setShowOnboardingWarning] = useState(false);\n  const [pendingAssignment, setPendingAssignment] = useState<{ userId: string; userName: string; missingResume: boolean; missingPersonality: boolean; onConfirm?: () => void } | null>(null);\n  \n  const openTaskDetail = (task: any, deal: Deal) => {\n    setSelectedCalendarTask({ ...task, deal });\n    setShowTaskDetailModal(true);\n  };\n\n  // Voice Notes State\n  type DealVoiceNote = {\n    id: string;\n    title: string;\n    duration: number;\n    authorName: string;\n    createdAt: string;\n  };\n  const [dealVoiceNotes, setDealVoiceNotes] = useState<Record<string, DealVoiceNote[]>>({});\n  const [isRecordingVoice, setIsRecordingVoice] = useState(false);\n  const [voiceRecordingTime, setVoiceRecordingTime] = useState(0);\n  const [voiceNoteTitle, setVoiceNoteTitle] = useState(\"\");\n  const voiceRecordingInterval = useRef<NodeJS.Timeout | null>(null);\n  const voicePlaybackInterval = useRef<NodeJS.Timeout | null>(null);\n  const [playingVoiceNoteId, setPlayingVoiceNoteId] = useState<string | null>(null);\n  const [voicePlayProgress, setVoicePlayProgress] = useState(0);\n\n  // Reset voice recording state when deal changes or component unmounts\n  useEffect(() => {\n    if (isRecordingVoice) {\n      if (voiceRecordingInterval.current) {\n        clearInterval(voiceRecordingInterval.current);\n      }\n      setIsRecordingVoice(false);\n      setVoiceRecordingTime(0);\n      setVoiceNoteTitle(\"\");\n    }\n    if (playingVoiceNoteId) {\n      if (voicePlaybackInterval.current) {\n        clearInterval(voicePlaybackInterval.current);\n      }\n      setPlayingVoiceNoteId(null);\n      setVoicePlayProgress(0);\n    }\n  }, [selectedDeal?.id]);\n  \n  const [newDeal, setNewDeal] = useState({\n    name: '',\n    client: '',\n    sector: 'Technology',\n    customSector: '',\n    value: '',\n    stage: 'Origination',\n    lead: '',\n    status: 'Active',\n    progress: 0,\n  });\n  \n  const [newDealFees, setNewDealFees] = useState<{\n    engagement: string;\n    monthly: string;\n    success: string;\n    transaction: string;\n    spread: string;\n  }>({\n    engagement: '',\n    monthly: '',\n    success: '',\n    transaction: '',\n    spread: '',\n  });\n  \n  const BASE_SECTORS = ['Technology', 'Healthcare', 'Energy', 'Consumer', 'Industrials', 'Financial'];\n  const SECTORS = useMemo(() => {\n    const customNames = customSectors.map(s => s.name);\n    // Combine base sectors with custom sectors, avoiding duplicates\n    const allSectors = [...BASE_SECTORS, ...customNames.filter(name => !BASE_SECTORS.includes(name))];\n    return [...allSectors, 'Other'];\n  }, [customSectors]);\n  const [sectorOpen, setSectorOpen] = useState(false);\n  const [editSectorOpen, setEditSectorOpen] = useState(false);\n  const [leadOpen, setLeadOpen] = useState(false);\n  const [editLeadOpen, setEditLeadOpen] = useState(false);\n  const [editCustomSector, setEditCustomSector] = useState('');\n\n  const [newTeamMember, setNewTeamMember] = useState<PodTeamMember>({\n    name: '',\n    role: '',\n    email: '',\n    phone: '',\n    slack: '',\n  });\n  const [teamMemberSearch, setTeamMemberSearch] = useState('');\n  const [teamMemberOpen, setTeamMemberOpen] = useState(false);\n  \n  const filteredUsers = useMemo(() => {\n    if (!teamMemberSearch || teamMemberSearch.length < 2) return [];\n    const query = teamMemberSearch.toLowerCase();\n    return allUsers\n      .filter(user => isDealEligibleUser(user)) // Only show deal-eligible users\n      .filter(user => \n        user.name.toLowerCase().includes(query) || \n        user.email.toLowerCase().includes(query)\n      ).slice(0, 5);\n  }, [allUsers, teamMemberSearch]);\n\n  const [newInvestor, setNewInvestor] = useState<Omit<TaggedInvestor, 'id'>>({\n    name: '',\n    firm: '',\n    type: 'PE',\n    status: 'Contacted',\n    notes: '',\n    email: '',\n    phone: '',\n    website: '',\n  });\n  const [investorSearchOpen, setInvestorSearchOpen] = useState(false);\n  const [investorSearchQuery, setInvestorSearchQuery] = useState('');\n\n  const crmInvestors = useMemo(() => {\n    return stakeholders.map(s => ({\n        id: s.id,\n        name: s.name,\n        firm: s.title || s.company || s.name,\n        type: (s.notes?.match(/Type: ([^|,]+)/)?.[1]) || 'PE',\n        email: s.email || '',\n        phone: s.phone || '',\n        website: s.website || '',\n        focus: s.focus || '',\n      }));\n  }, [stakeholders]);\n\n  const filteredCrmInvestors = useMemo(() => {\n    if (!investorSearchQuery) return crmInvestors;\n    const query = investorSearchQuery.toLowerCase();\n    return crmInvestors.filter(inv => \n      inv.name.toLowerCase().includes(query) || \n      inv.firm.toLowerCase().includes(query)\n    );\n  }, [crmInvestors, investorSearchQuery]);\n\n  const handleSelectCrmInvestor = (investor: typeof crmInvestors[0]) => {\n    setNewInvestor({\n      name: investor.name,\n      firm: investor.firm,\n      type: investor.type,\n      status: 'Contacted',\n      notes: investor.focus ? `Focus: ${investor.focus}` : '',\n      email: investor.email,\n      phone: investor.phone,\n      website: investor.website,\n    });\n    setInvestorSearchOpen(false);\n    setInvestorSearchQuery('');\n  };\n\n  // Handle URL query parameter for selecting a specific deal\n  useEffect(() => {\n    if (searchString && deals.length > 0) {\n      const params = new URLSearchParams(searchString);\n      const dealId = params.get('id');\n      if (dealId) {\n        const deal = deals.find(d => d.id === dealId);\n        if (deal) {\n          setSelectedDeal(deal);\n        }\n      }\n    }\n  }, [searchString, deals]);\n\n  // Keep selectedDeal in sync with fresh data from deals query\n  useEffect(() => {\n    if (selectedDeal && deals.length > 0) {\n      const freshDeal = deals.find(d => d.id === selectedDeal.id);\n      if (freshDeal) {\n        setSelectedDeal(freshDeal);\n      }\n    }\n  }, [deals]);\n\n  const filteredDeals = useMemo(() => {\n    return deals.filter(deal => {\n      const matchesSearch = !debouncedSearchQuery || \n        deal.name.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) ||\n        deal.client.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) ||\n        deal.sector.toLowerCase().includes(debouncedSearchQuery.toLowerCase());\n      const matchesStage = !stageFilter || deal.stage === stageFilter;\n      return matchesSearch && matchesStage;\n    });\n  }, [deals, debouncedSearchQuery, stageFilter]);\n\n  const getStageIndex = (stage: string) => DEAL_STAGES.indexOf(stage);\n  const getStageProgress = (stage: string) => Math.round(((getStageIndex(stage) + 1) / DEAL_STAGES.length) * 100);\n\n  // Voice Note Functions\n  const formatVoiceDuration = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  const startVoiceRecording = () => {\n    setIsRecordingVoice(true);\n    setVoiceRecordingTime(0);\n    voiceRecordingInterval.current = setInterval(() => {\n      setVoiceRecordingTime(prev => prev + 1);\n    }, 1000);\n    toast.info(\"Recording started\");\n  };\n\n  const stopVoiceRecording = () => {\n    setIsRecordingVoice(false);\n    if (voiceRecordingInterval.current) {\n      clearInterval(voiceRecordingInterval.current);\n    }\n\n    if (selectedDeal && voiceRecordingTime > 0) {\n      const newNote = {\n        id: Date.now().toString(),\n        title: voiceNoteTitle || `Note ${format(new Date(), 'MMM d, h:mm a')}`,\n        duration: voiceRecordingTime,\n        authorName: currentUser?.name || \"Unknown\",\n        createdAt: new Date().toISOString()\n      };\n\n      setDealVoiceNotes(prev => ({\n        ...prev,\n        [selectedDeal.id]: [...(prev[selectedDeal.id] || []), newNote]\n      }));\n      \n      setVoiceNoteTitle(\"\");\n      setVoiceRecordingTime(0);\n      toast.success(\"Voice note saved!\");\n    }\n  };\n\n  const cancelVoiceRecording = () => {\n    setIsRecordingVoice(false);\n    if (voiceRecordingInterval.current) {\n      clearInterval(voiceRecordingInterval.current);\n    }\n    setVoiceRecordingTime(0);\n    setVoiceNoteTitle(\"\");\n  };\n\n  const toggleVoiceNotePlay = (noteId: string, duration: number) => {\n    // Always clear any existing playback interval first\n    if (voicePlaybackInterval.current) {\n      clearInterval(voicePlaybackInterval.current);\n      voicePlaybackInterval.current = null;\n    }\n\n    if (playingVoiceNoteId === noteId) {\n      // Stop playing current note\n      setPlayingVoiceNoteId(null);\n      setVoicePlayProgress(0);\n    } else {\n      // Start playing new note\n      setPlayingVoiceNoteId(noteId);\n      setVoicePlayProgress(0);\n      voicePlaybackInterval.current = setInterval(() => {\n        setVoicePlayProgress(prev => {\n          if (prev >= 100) {\n            if (voicePlaybackInterval.current) {\n              clearInterval(voicePlaybackInterval.current);\n              voicePlaybackInterval.current = null;\n            }\n            setPlayingVoiceNoteId(null);\n            return 0;\n          }\n          return prev + (100 / duration);\n        });\n      }, 1000);\n    }\n  };\n\n  const deleteVoiceNote = (dealId: string, noteId: string) => {\n    setDealVoiceNotes(prev => ({\n      ...prev,\n      [dealId]: (prev[dealId] || []).filter(n => n.id !== noteId)\n    }));\n    toast.success(\"Voice note deleted\");\n  };\n\n  const handleCreateDeal = async () => {\n    if (!newDeal.name || !newDeal.client || !newDeal.value) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n    const parsedValue = parseInt(newDeal.value);\n    if (isNaN(parsedValue) || parsedValue <= 0) {\n      toast.error(\"Please enter a valid deal value\");\n      return;\n    }\n    \n    const finalSector = newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector;\n    \n    // Save custom sector if it's a new one not in the existing list\n    const isCustomSector = newDeal.sector === 'Other' && newDeal.customSector;\n    const existingCustomSectorNames = customSectors.map(s => s.name.toLowerCase());\n    const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(newDeal.customSector.toLowerCase()) && !BASE_SECTORS.includes(newDeal.customSector);\n    \n    try {\n      // Save the custom sector first if it's new\n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(newDeal.customSector);\n        } catch (e) {\n          // Ignore if sector already exists (duplicate)\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      const createdDeal = await createDeal.mutateAsync({\n        name: newDeal.name,\n        client: newDeal.client,\n        clientContactName: null,\n        clientContactEmail: null,\n        clientContactPhone: null,\n        clientContactRole: null,\n        sector: finalSector,\n        value: parsedValue,\n        stage: newDeal.stage,\n        lead: newDeal.lead || currentUser?.name || 'Unassigned',\n        status: newDeal.status,\n        progress: getStageProgress(newDeal.stage),\n        dealType: 'M&A',\n        description: null,\n        attachments: [],\n        podTeam: [],\n        taggedInvestors: [],\n        auditTrail: [{\n          id: crypto.randomUUID(),\n          timestamp: new Date().toISOString(),\n          action: 'Deal Created',\n          user: currentUser?.name || 'System',\n          details: `Deal \"${newDeal.name}\" created with initial stage: ${newDeal.stage}`,\n        }],\n      });\n      \n      const feePromises = [];\n      if (newDealFees.engagement && parseFloat(newDealFees.engagement) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'engagement', amount: parseFloat(newDealFees.engagement), percentage: null, currency: 'USD', description: 'Engagement fee', billingFrequency: 'one-time' }\n        }));\n      }\n      if (newDealFees.monthly && parseFloat(newDealFees.monthly) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'monthly', amount: parseFloat(newDealFees.monthly), percentage: null, currency: 'USD', description: 'Monthly retainer', billingFrequency: 'monthly' }\n        }));\n      }\n      if (newDealFees.success && parseFloat(newDealFees.success) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'success', amount: null, percentage: parseFloat(newDealFees.success), currency: 'USD', description: 'Success fee', billingFrequency: 'on-close' }\n        }));\n      }\n      if (newDealFees.transaction && parseFloat(newDealFees.transaction) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'transaction', amount: null, percentage: parseFloat(newDealFees.transaction), currency: 'USD', description: 'Transaction fee', billingFrequency: 'on-close' }\n        }));\n      }\n      if (newDealFees.spread && parseFloat(newDealFees.spread) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'spread', amount: null, percentage: parseFloat(newDealFees.spread), currency: 'USD', description: 'Spread', billingFrequency: 'on-close' }\n        }));\n      }\n      \n      if (feePromises.length > 0) {\n        await Promise.all(feePromises);\n      }\n      \n      toast.success(\"Deal created successfully!\");\n      setShowNewDealModal(false);\n      setNewDeal({ name: '', client: '', sector: 'Technology', customSector: '', value: '', stage: 'Origination', lead: '', status: 'Active', progress: 0 });\n      setNewDealFees({ engagement: '', monthly: '', success: '', transaction: '', spread: '' });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create deal\");\n    }\n  };\n\n  const handleStageChange = async (deal: Deal, newStage: string) => {\n    const newProgress = getStageProgress(newStage);\n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Stage Changed',\n      user: currentUser?.name || 'System',\n      details: `Stage changed from \"${deal.stage}\" to \"${newStage}\"`,\n    };\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: deal.id,\n        stage: newStage,\n        progress: newProgress,\n        auditTrail: [...(deal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      toast.success(`Deal moved to ${newStage}`);\n      if (selectedDeal?.id === deal.id) {\n        setSelectedDeal({ ...deal, stage: newStage, progress: newProgress, auditTrail: [...(deal.auditTrail as AuditEntry[] || []), auditEntry] });\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update stage\");\n    }\n  };\n\n  const handleAddTeamMember = async () => {\n    if (!selectedDeal || !newTeamMember.name || !newTeamMember.role) {\n      toast.error(\"Please fill in name and role\");\n      return;\n    }\n    \n    // Look up the real user ID based on email or name\n    const matchingUser = allUsers.find(user => \n      (newTeamMember.email && user.email === newTeamMember.email) ||\n      user.name === newTeamMember.name\n    );\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Team Member Added',\n      user: currentUser?.name || 'System',\n      details: `Added ${newTeamMember.name} (${newTeamMember.role}) to pod team`,\n    };\n\n    // Use the real user ID if found, otherwise generate a random one for external contacts\n    const userId = matchingUser?.id || crypto.randomUUID();\n    const updatedPodTeam = [...(selectedDeal.podTeam as PodTeamMember[] || []), { ...newTeamMember, userId }];\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        podTeam: updatedPodTeam,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, podTeam: updatedPodTeam, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      setNewTeamMember({ name: '', role: '', email: '', phone: '', slack: '' });\n      toast.success(\"Team member added!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add team member\");\n    }\n  };\n\n  const handleRemoveTeamMember = async (memberIndex: number) => {\n    if (!selectedDeal) return;\n    const member = (selectedDeal.podTeam as PodTeamMember[])?.[memberIndex];\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Team Member Removed',\n      user: currentUser?.name || 'System',\n      details: `Removed ${member?.name} from pod team`,\n    };\n\n    const updatedPodTeam = (selectedDeal.podTeam as PodTeamMember[] || []).filter((_, i) => i !== memberIndex);\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        podTeam: updatedPodTeam,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, podTeam: updatedPodTeam, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Team member removed\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove team member\");\n    }\n  };\n\n  const handleAddInvestor = async () => {\n    if (!selectedDeal || !newInvestor.name || !newInvestor.firm) {\n      toast.error(\"Please fill in investor name and firm\");\n      return;\n    }\n    \n    const investor: TaggedInvestor = {\n      ...newInvestor,\n      id: crypto.randomUUID(),\n    };\n\n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Tagged',\n      user: currentUser?.name || 'System',\n      details: `Tagged ${newInvestor.name} from ${newInvestor.firm} (${newInvestor.type})`,\n    };\n\n    const updatedInvestors = [...(selectedDeal.taggedInvestors as TaggedInvestor[] || []), investor];\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      setNewInvestor({ name: '', firm: '', type: 'PE', status: 'Contacted', notes: '', email: '', phone: '', website: '' });\n      toast.success(\"Investor tagged!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add investor\");\n    }\n  };\n\n  const handleUpdateInvestorStatus = async (investorId: string, newStatus: string) => {\n    if (!selectedDeal) return;\n    \n    const investor = (selectedDeal.taggedInvestors as TaggedInvestor[])?.find(i => i.id === investorId);\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Status Updated',\n      user: currentUser?.name || 'System',\n      details: `${investor?.name} status changed to \"${newStatus}\"`,\n    };\n\n    const updatedInvestors = (selectedDeal.taggedInvestors as TaggedInvestor[] || []).map(i => \n      i.id === investorId ? { ...i, status: newStatus } : i\n    );\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Investor status updated\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update investor status\");\n    }\n  };\n\n  const handleRemoveInvestor = async (investorId: string) => {\n    if (!selectedDeal) return;\n    const investor = (selectedDeal.taggedInvestors as TaggedInvestor[])?.find(i => i.id === investorId);\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Removed',\n      user: currentUser?.name || 'System',\n      details: `Removed ${investor?.name} from ${investor?.firm}`,\n    };\n\n    const updatedInvestors = (selectedDeal.taggedInvestors as TaggedInvestor[] || []).filter(i => i.id !== investorId);\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Investor removed\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove investor\");\n    }\n  };\n\n  const handleEditDeal = async () => {\n    if (!editingDeal) return;\n    \n    // Handle custom sector\n    const finalSector = editingDeal.sector === 'Other' && editCustomSector ? editCustomSector : editingDeal.sector;\n    \n    // Save custom sector if it's a new one\n    const isCustomSector = editingDeal.sector === 'Other' && editCustomSector;\n    const existingCustomSectorNames = customSectors.map(s => s.name.toLowerCase());\n    const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(editCustomSector.toLowerCase()) && !BASE_SECTORS.includes(editCustomSector);\n    \n    try {\n      // Save the custom sector first if it's new\n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(editCustomSector);\n        } catch (e) {\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      await updateDeal.mutateAsync({\n        id: editingDeal.id,\n        name: editingDeal.name,\n        client: editingDeal.client,\n        sector: finalSector,\n        value: editingDeal.value,\n        stage: editingDeal.stage,\n        lead: editingDeal.lead,\n        status: editingDeal.status,\n        progress: editingDeal.progress,\n      });\n      toast.success(\"Deal updated successfully!\");\n      setShowEditModal(false);\n      setEditingDeal(null);\n      setEditCustomSector('');\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update deal\");\n    }\n  };\n\n  const handleDeleteDeal = async (dealId: string) => {\n    try {\n      await deleteDeal.mutateAsync(dealId);\n      toast.success(\"Deal deleted successfully!\");\n      if (selectedDeal?.id === dealId) {\n        setSelectedDeal(null);\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete deal\");\n    }\n  };\n\n  const openEditModal = (deal: Deal) => {\n    setEditingDeal(deal);\n    // If the current sector is not in the SECTORS list, it's a custom sector\n    const isCustom = !BASE_SECTORS.includes(deal.sector) && deal.sector !== 'Other';\n    if (isCustom) {\n      setEditCustomSector(deal.sector);\n      setEditingDeal({ ...deal, sector: 'Other' });\n    } else {\n      setEditCustomSector('');\n    }\n    setShowEditModal(true);\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role} pageTitle=\"Deal Management\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading deals...</div>\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role} pageTitle=\"Deal Management\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header & Filters */}\n        <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n          <div className=\"relative flex-1 max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n            <Input \n              placeholder=\"Search deals by name, client, or sector...\" \n              className=\"pl-9 bg-card border-border\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              data-testid=\"input-search-deals\"\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            {/* View Mode Toggle */}\n            <div className=\"flex items-center bg-card border border-border rounded-md overflow-hidden\">\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none border-r border-border\", viewMode === 'grid' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('grid')}\n                data-testid=\"button-view-grid\"\n              >\n                <LayoutGrid className=\"w-4 h-4\" />\n              </Button>\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none border-r border-border\", viewMode === 'calendar' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('calendar')}\n                data-testid=\"button-view-calendar\"\n              >\n                <CalendarDays className=\"w-4 h-4\" />\n              </Button>\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none\", viewMode === 'compare' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('compare')}\n                data-testid=\"button-view-compare\"\n              >\n                <GitCompare className=\"w-4 h-4\" />\n              </Button>\n            </div>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"outline\" className=\"bg-card border-border gap-2\">\n                  <Filter className=\"w-4 h-4\" /> {stageFilter || 'All Stages'}\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent>\n                <DropdownMenuItem onClick={() => setStageFilter(null)}>All Stages</DropdownMenuItem>\n                <DropdownMenuSeparator />\n                {DEAL_STAGES.map(stage => (\n                  <DropdownMenuItem key={stage} onClick={() => setStageFilter(stage)}>{stage}</DropdownMenuItem>\n                ))}\n              </DropdownMenuContent>\n            </DropdownMenu>\n            {currentUser?.accessLevel === 'admin' && (\n              <Button \n                className=\"bg-primary text-primary-foreground hover:bg-primary/90\"\n                onClick={() => setShowNewDealModal(true)}\n                data-testid=\"button-new-deal\"\n              >\n                <Plus className=\"w-4 h-4 mr-1\" /> New Deal\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {/* Calendar View */}\n        {viewMode === 'calendar' && (() => {\n          const getCalendarDays = () => {\n            if (calendarView === 'day') {\n              return [calendarDate];\n            } else if (calendarView === 'week') {\n              const start = startOfWeek(calendarDate, { weekStartsOn: 0 });\n              const end = endOfWeek(calendarDate, { weekStartsOn: 0 });\n              return eachDayOfInterval({ start, end });\n            } else {\n              const monthStart = startOfMonth(calendarDate);\n              const monthEnd = endOfMonth(calendarDate);\n              const calendarStart = startOfWeek(monthStart, { weekStartsOn: 0 });\n              const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: 0 });\n              return eachDayOfInterval({ start: calendarStart, end: calendarEnd });\n            }\n          };\n\n          const navigatePrev = () => {\n            if (calendarView === 'day') setCalendarDate(subDays(calendarDate, 1));\n            else if (calendarView === 'week') setCalendarDate(subWeeks(calendarDate, 1));\n            else setCalendarDate(subMonths(calendarDate, 1));\n          };\n\n          const navigateNext = () => {\n            if (calendarView === 'day') setCalendarDate(addDays(calendarDate, 1));\n            else if (calendarView === 'week') setCalendarDate(addWeeks(calendarDate, 1));\n            else setCalendarDate(addMonths(calendarDate, 1));\n          };\n\n          const getEventsForDay = (day: Date) => {\n            const events: { type: 'task' | 'milestone' | 'stage_change'; deal: Deal; item?: any; date: Date }[] = [];\n            \n            if (!selectedCalendarDeal) return events;\n            \n            const deal = selectedCalendarDeal;\n            const dealTasks = allTasks.filter((t: any) => t.dealId === deal.id);\n            dealTasks.forEach((task: any) => {\n              if (task.dueDate && isSameDay(parseISO(task.dueDate), day)) {\n                events.push({ type: 'task', deal, item: task, date: day });\n              }\n            });\n            \n            const auditTrail = deal.auditTrail as AuditEntry[] || [];\n            auditTrail.forEach(entry => {\n              if (entry.timestamp && isSameDay(parseISO(entry.timestamp), day)) {\n                if (entry.action === 'Stage Changed' || entry.action === 'Deal Created') {\n                  events.push({ type: 'milestone', deal, item: entry, date: day });\n                }\n              }\n            });\n            \n            return events;\n          };\n\n          const filteredCalendarDeals = deals.filter(deal =>\n            deal.name.toLowerCase().includes(calendarDealSearch.toLowerCase()) ||\n            deal.client.toLowerCase().includes(calendarDealSearch.toLowerCase())\n          );\n\n          const calendarDays = getCalendarDays();\n\n          return (\n            <div className=\"space-y-4\">\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <CalendarDays className=\"w-5 h-5 text-primary\" />\n                        <CardTitle className=\"text-lg\">Deal Calendar</CardTitle>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"flex bg-secondary rounded-lg p-0.5\">\n                          <Button \n                            variant={calendarView === 'day' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('day')}\n                            data-testid=\"calendar-view-day\"\n                          >\n                            Day\n                          </Button>\n                          <Button \n                            variant={calendarView === 'week' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('week')}\n                            data-testid=\"calendar-view-week\"\n                          >\n                            Week\n                          </Button>\n                          <Button \n                            variant={calendarView === 'month' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('month')}\n                            data-testid=\"calendar-view-month\"\n                          >\n                            Month\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                    \n                    {/* Deal Selector */}\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"relative flex-1 max-w-md\">\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                        <Input\n                          placeholder=\"Search and select a deal...\"\n                          value={calendarDealSearch}\n                          onChange={(e) => setCalendarDealSearch(e.target.value)}\n                          className=\"pl-9 bg-secondary/50 border-border\"\n                          data-testid=\"calendar-deal-search\"\n                        />\n                        {calendarDealSearch && (\n                          <div className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-card border border-border rounded-lg shadow-xl max-h-[200px] overflow-y-auto\">\n                            {filteredCalendarDeals.length === 0 ? (\n                              <div className=\"p-3 text-sm text-muted-foreground text-center\">No deals found</div>\n                            ) : (\n                              filteredCalendarDeals.map(deal => (\n                                <div\n                                  key={deal.id}\n                                  className=\"p-3 hover:bg-secondary/50 cursor-pointer transition-colors border-b border-border/50 last:border-b-0\"\n                                  onClick={() => {\n                                    setSelectedCalendarDeal(deal);\n                                    setCalendarDealSearch(\"\");\n                                  }}\n                                  data-testid={`calendar-deal-option-${deal.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{deal.name}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{deal.client}{deal.sector ? `  ${deal.sector}` : ''}  {deal.stage}</div>\n                                </div>\n                              ))\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      {selectedCalendarDeal && (\n                        <div className=\"flex items-center gap-2 px-3 py-2 bg-primary/10 border border-primary/30 rounded-lg\">\n                          <Briefcase className=\"w-4 h-4 text-primary\" />\n                          <span className=\"text-sm font-medium\">{selectedCalendarDeal.name}</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-5 w-5 ml-1\"\n                            onClick={() => setSelectedCalendarDeal(null)}\n                            data-testid=\"calendar-clear-deal\"\n                          >\n                            <X className=\"w-3 h-3\" />\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={navigatePrev}>\n                      <ChevronLeft className=\"w-4 h-4\" />\n                    </Button>\n                    <h3 className=\"text-lg font-semibold\">\n                      {calendarView === 'day' && format(calendarDate, 'EEEE, MMMM d, yyyy')}\n                      {calendarView === 'week' && `${format(startOfWeek(calendarDate, { weekStartsOn: 0 }), 'MMM d')} - ${format(endOfWeek(calendarDate, { weekStartsOn: 0 }), 'MMM d, yyyy')}`}\n                      {calendarView === 'month' && format(calendarDate, 'MMMM yyyy')}\n                    </h3>\n                    <div className=\"flex items-center gap-2\">\n                      <Button variant=\"outline\" size=\"sm\" onClick={() => setCalendarDate(new Date())}>\n                        Today\n                      </Button>\n                      <Button variant=\"outline\" size=\"sm\" onClick={navigateNext}>\n                        <ChevronRight className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {!selectedCalendarDeal && (\n                    <div className=\"text-center py-16 text-muted-foreground\">\n                      <Briefcase className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\n                      <h3 className=\"text-lg font-medium mb-2\">Select a Deal</h3>\n                      <p className=\"text-sm\">Use the search box above to select a deal and view its calendar events</p>\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'month' && (\n                    <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n                      {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (\n                        <div key={day} className=\"bg-secondary p-2 text-center text-xs font-medium text-muted-foreground\">\n                          {day}\n                        </div>\n                      ))}\n                      {calendarDays.map((day, index) => {\n                        const events = getEventsForDay(day);\n                        const isCurrentMonth = day.getMonth() === calendarDate.getMonth();\n                        return (\n                          <div \n                            key={index} \n                            className={cn(\n                              \"bg-card min-h-[100px] p-2 transition-colors\",\n                              !isCurrentMonth && \"opacity-40\",\n                              isToday(day) && \"ring-2 ring-primary ring-inset\"\n                            )}\n                          >\n                            <div className={cn(\n                              \"text-sm font-medium mb-1\",\n                              isToday(day) ? \"text-primary\" : \"text-foreground\"\n                            )}>\n                              {format(day, 'd')}\n                            </div>\n                            <div className=\"space-y-1\">\n                              {events.slice(0, 3).map((event, i) => (\n                                <div \n                                  key={i}\n                                  className={cn(\n                                    \"text-[10px] px-1.5 py-0.5 rounded truncate cursor-pointer hover:opacity-80\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20 text-green-400\" : \"bg-blue-500/20 text-blue-400\"),\n                                    event.type === 'milestone' && \"bg-purple-500/20 text-purple-400\"\n                                  )}\n                                  onClick={() => { setSelectedDeal(event.deal); setActiveTab(\"overview\"); }}\n                                >\n                                  {event.type === 'task' ? event.item?.title : event.item?.action}\n                                </div>\n                              ))}\n                              {events.length > 3 && (\n                                <div className=\"text-[10px] text-muted-foreground pl-1\">\n                                  +{events.length - 3} more\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'week' && (\n                    <div className=\"grid grid-cols-7 gap-2\">\n                      {calendarDays.map((day, index) => {\n                        const events = getEventsForDay(day);\n                        return (\n                          <div \n                            key={index} \n                            className={cn(\n                              \"bg-secondary/30 rounded-lg p-3 min-h-[200px] transition-colors\",\n                              isToday(day) && \"ring-2 ring-primary\"\n                            )}\n                          >\n                            <div className={cn(\n                              \"text-center mb-2 pb-2 border-b border-border\",\n                              isToday(day) ? \"text-primary\" : \"\"\n                            )}>\n                              <div className=\"text-xs text-muted-foreground\">{format(day, 'EEE')}</div>\n                              <div className=\"text-lg font-bold\">{format(day, 'd')}</div>\n                            </div>\n                            <ScrollArea className=\"h-[150px]\">\n                              <div className=\"space-y-1.5\">\n                                {events.map((event, i) => (\n                                  <div \n                                    key={i}\n                                    className={cn(\n                                      \"text-xs p-2 rounded cursor-pointer hover:opacity-80 transition-opacity\",\n                                      event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20 text-green-400\" : \"bg-blue-500/20 text-blue-400\"),\n                                      event.type === 'milestone' && \"bg-purple-500/20 text-purple-400\"\n                                    )}\n                                    onClick={() => {\n                                      if (event.type === 'task') {\n                                        openTaskDetail(event.item, event.deal);\n                                      } else {\n                                        setSelectedDeal(event.deal); \n                                        setActiveTab(\"overview\");\n                                      }\n                                    }}\n                                  >\n                                    <div className=\"font-medium truncate\">{event.type === 'task' ? event.item?.title : event.item?.action}</div>\n                                    <div className=\"text-[10px] opacity-70 truncate\">{event.deal.name}</div>\n                                  </div>\n                                ))}\n                                {events.length === 0 && (\n                                  <div className=\"text-xs text-muted-foreground text-center py-4\">No events</div>\n                                )}\n                              </div>\n                            </ScrollArea>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'day' && (\n                    <div className=\"space-y-4\">\n                      {(() => {\n                        const events = getEventsForDay(calendarDate);\n                        const deal = selectedCalendarDeal;\n\n                        if (events.length === 0) {\n                          return (\n                            <div className=\"text-center py-12 text-muted-foreground\">\n                              <CalendarDays className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                              <p>No events scheduled for this day</p>\n                            </div>\n                          );\n                        }\n\n                        return (\n                          <Card className=\"bg-secondary/30 border-border\">\n                            <CardHeader className=\"pb-2\">\n                              <div className=\"flex items-center justify-between\">\n                                <div>\n                                  <CardTitle className=\"text-base\">{deal.name}</CardTitle>\n                                  <CardDescription>{deal.client}{deal.sector ? `  ${deal.sector}` : ''}</CardDescription>\n                                </div>\n                                <Badge variant=\"outline\">{deal.stage}</Badge>\n                              </div>\n                            </CardHeader>\n                            <CardContent className=\"space-y-2\">\n                              {events.map((event, i) => (\n                                <div \n                                  key={i}\n                                  className={cn(\n                                    \"flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-secondary/50 transition-colors\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/10\" : \"bg-blue-500/10\"),\n                                    event.type === 'milestone' && \"bg-purple-500/10\"\n                                  )}\n                                  onClick={() => {\n                                    if (event.type === 'task') {\n                                      openTaskDetail(event.item, deal);\n                                    } else {\n                                      setSelectedDeal(deal); \n                                      setActiveTab(\"overview\");\n                                    }\n                                  }}\n                                >\n                                  <div className={cn(\n                                    \"w-8 h-8 rounded-full flex items-center justify-center\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20\" : \"bg-blue-500/20\"),\n                                    event.type === 'milestone' && \"bg-purple-500/20\"\n                                  )}>\n                                    {event.type === 'task' ? (\n                                      event.item?.status === 'Completed' ? <CheckCircle2 className=\"w-4 h-4 text-green-400\" /> : <Clock className=\"w-4 h-4 text-blue-400\" />\n                                    ) : (\n                                      <TrendingUp className=\"w-4 h-4 text-purple-400\" />\n                                    )}\n                                  </div>\n                                  <div className=\"flex-1\">\n                                    <div className=\"font-medium text-sm\">\n                                      {event.type === 'task' ? event.item?.title : event.item?.action}\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      {event.type === 'task' ? `Priority: ${event.item?.priority}` : event.item?.details}\n                                    </div>\n                                  </div>\n                                  <Badge variant=\"secondary\" className=\"text-[10px]\">\n                                    {event.type === 'task' ? event.item?.status : 'Milestone'}\n                                  </Badge>\n                                </div>\n                              ))}\n                            </CardContent>\n                          </Card>\n                        );\n                      })()}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Legend</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap gap-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-blue-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Pending Task</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-green-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Completed Task</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-purple-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Milestone / Stage Change</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          );\n        })()}\n\n        {/* Deals Grid */}\n        {viewMode === 'grid' && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {filteredDeals.map((deal) => (\n            <Card \n              key={deal.id} \n              className=\"bg-card border-border hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 group\" \n              data-testid={`card-deal-${deal.id}`}\n            >\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex justify-between items-start\">\n                  <Badge variant=\"outline\" className={cn(\n                    \"border-0 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider\",\n                    deal.stage === 'Origination' ? \"bg-blue-500/20 text-blue-400\" :\n                    deal.stage === 'Structuring' ? \"bg-indigo-500/20 text-indigo-400\" :\n                    deal.stage === 'Diligence' ? \"bg-orange-500/20 text-orange-400\" :\n                    deal.stage === 'Legal' ? \"bg-purple-500/20 text-purple-400\" :\n                    \"bg-green-500/20 text-green-400\"\n                  )}>\n                    {deal.stage}\n                  </Badge>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 -mr-2\">\n                        <MoreVertical className=\"w-4 h-4 text-muted-foreground\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => { setSelectedDeal(deal); setActiveTab(\"overview\"); }}>\n                        <Eye className=\"w-4 h-4 mr-2\" /> View Details\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => openEditModal(deal)}>\n                        <Pencil className=\"w-4 h-4 mr-2\" /> Edit Deal\n                      </DropdownMenuItem>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem \n                        className=\"text-red-500\" \n                        onClick={() => {\n                          setDealToDelete(deal.id);\n                          setShowDeleteDealDialog(true);\n                        }}\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" /> Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n                <CardTitle className=\"text-xl mt-2 group-hover:text-primary transition-colors\">{deal.name}</CardTitle>\n                <CardDescription>{deal.client}{deal.sector ? <>  <span className=\"font-medium\">{deal.sector}</span></> : ''}</CardDescription>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-4\">\n                {/* Stage Progress Bar - Click icons to change stage */}\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between items-center\">\n                    {DEAL_STAGES.map((stage, index) => {\n                      const isActive = getStageIndex(deal.stage) >= index;\n                      const isCurrent = deal.stage === stage;\n                      return (\n                        <div \n                          key={stage} \n                          className=\"flex flex-col items-center flex-1 cursor-pointer group/stage\"\n                          onClick={() => handleStageChange(deal, stage)}\n                          data-testid={`stage-icon-${deal.id}-${stage.toLowerCase().replace(' ', '-')}`}\n                        >\n                          <div className={cn(\n                            \"w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold transition-all\",\n                            isCurrent ? \"bg-primary text-primary-foreground ring-2 ring-primary/30\" :\n                            isActive ? \"bg-primary/60 text-primary-foreground\" :\n                            \"bg-secondary text-muted-foreground\",\n                            \"group-hover/stage:ring-2 group-hover/stage:ring-primary/50 group-hover/stage:scale-110\"\n                          )}>\n                            {isActive ? <CheckCircle2 className=\"w-3.5 h-3.5\" /> : index + 1}\n                          </div>\n                          <span className={cn(\n                            \"text-[8px] mt-1 truncate max-w-full transition-colors\",\n                            isCurrent ? \"text-primary font-bold\" :\n                            isActive ? \"text-foreground\" : \"text-muted-foreground\",\n                            \"group-hover/stage:text-primary\"\n                          )}>{stage.slice(0, 4)}</span>\n                        </div>\n                      );\n                    })}\n                  </div>\n                  <div className=\"h-1 bg-secondary rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-primary transition-all duration-500\" \n                      style={{ width: `${getStageProgress(deal.stage)}%` }}\n                    />\n                  </div>\n                  <p className=\"text-[9px] text-muted-foreground text-center\">Click any stage to update</p>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-1\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider flex items-center gap-1\">\n                      <DollarSign className=\"w-3 h-3\" /> Value\n                    </div>\n                    <div className=\"font-mono font-bold text-lg\">${deal.value}M</div>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider flex items-center gap-1\">\n                      <Users className=\"w-3 h-3\" /> Team\n                    </div>\n                    <DealTotalTeamCount dealId={deal.id} podTeam={(deal.podTeam as PodTeamMember[]) || []} />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-2 pt-2\">\n                  <div className=\"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-[10px] font-bold text-primary\">\n                    {deal.lead.split(' ').map(n => n[0]).join('')}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground\">Lead: {deal.lead}</span>\n                </div>\n              </CardContent>\n              \n              <CardFooter className=\"pt-2\">\n                <Button \n                  className=\"w-full bg-secondary hover:bg-primary hover:text-primary-foreground text-secondary-foreground transition-colors gap-2\"\n                  onClick={() => { setSelectedDeal(deal); setActiveTab(\"overview\"); }}\n                  data-testid={`button-view-deal-${deal.id}`}\n                >\n                  View Deal Room <ArrowRight className=\"w-4 h-4\" />\n                </Button>\n              </CardFooter>\n            </Card>\n          ))}\n        </div>\n        )}\n\n        {filteredDeals.length === 0 && viewMode !== 'compare' && (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            {searchQuery || stageFilter ? \"No deals match your search criteria\" : \"No deals yet. Create your first deal!\"}\n          </div>\n        )}\n\n        {/* Comparison View */}\n        {viewMode === 'compare' && (() => {\n          const selectedDealsData = deals.filter(d => selectedCompareDeals.includes(d.id));\n          \n          const getStageValue = (stage: string) => {\n            const stageIndex = DEAL_STAGES.indexOf(stage);\n            return ((stageIndex + 1) / DEAL_STAGES.length) * 100;\n          };\n          \n          const getTeamScore = (deal: Deal) => {\n            const podTeam = (deal.podTeam as PodTeamMember[]) || [];\n            return Math.min(podTeam.length * 20, 100);\n          };\n          \n          const getInvestorScore = (deal: Deal) => {\n            const investors = (deal.taggedInvestors as TaggedInvestor[]) || [];\n            return Math.min(investors.length * 15, 100);\n          };\n          \n          const getDocumentScore = (deal: Deal) => {\n            const attachments = (deal.attachments as any[]) || [];\n            return Math.min(attachments.length * 10, 100);\n          };\n          \n          const maxValue = Math.max(...deals.map(d => d.value || 0), 1);\n          \n          const radarData = [\n            { metric: 'Deal Value', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, ((d.value || 0) / maxValue) * 100])) },\n            { metric: 'Stage Progress', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getStageValue(d.stage)])) },\n            { metric: 'Team Size', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getTeamScore(d)])) },\n            { metric: 'Investors', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getInvestorScore(d)])) },\n            { metric: 'Documents', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getDocumentScore(d)])) },\n            { metric: 'Progress', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, d.progress || 0])) },\n          ];\n          \n          const toggleDealSelection = (dealId: string) => {\n            if (selectedCompareDeals.includes(dealId)) {\n              setSelectedCompareDeals(selectedCompareDeals.filter(id => id !== dealId));\n            } else if (selectedCompareDeals.length < 5) {\n              setSelectedCompareDeals([...selectedCompareDeals, dealId]);\n            } else {\n              toast.error(\"You can compare up to 5 deals at a time\");\n            }\n          };\n          \n          const sortedDeals = [...deals].sort((a, b) => {\n            switch (compareSortBy) {\n              case 'value': return (b.value || 0) - (a.value || 0);\n              case 'stage': return getStageValue(b.stage) - getStageValue(a.stage);\n              case 'name': return a.name.localeCompare(b.name);\n              default: return 0;\n            }\n          });\n          \n          return (\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                {/* Deal Selection Panel */}\n                <Card className=\"lg:col-span-1\">\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"text-lg flex items-center gap-2\">\n                        <Briefcase className=\"w-5 h-5\" /> Select Deals\n                      </CardTitle>\n                      <Badge variant=\"secondary\">{selectedCompareDeals.length}/5</Badge>\n                    </div>\n                    <CardDescription>Choose up to 5 deals to compare</CardDescription>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Select value={compareSortBy} onValueChange={setCompareSortBy}>\n                        <SelectTrigger className=\"w-full\">\n                          <ArrowUpDown className=\"w-4 h-4 mr-2\" />\n                          <SelectValue placeholder=\"Sort by\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"value\">Sort by Value</SelectItem>\n                          <SelectItem value=\"stage\">Sort by Stage</SelectItem>\n                          <SelectItem value=\"name\">Sort by Name</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <ScrollArea className=\"h-[400px]\">\n                      <div className=\"space-y-2 pr-4\">\n                        {sortedDeals.map((deal) => (\n                          <div\n                            key={deal.id}\n                            className={cn(\n                              \"p-3 rounded-lg border cursor-pointer transition-all\",\n                              selectedCompareDeals.includes(deal.id)\n                                ? \"border-primary bg-primary/10\"\n                                : \"border-border hover:border-primary/50\"\n                            )}\n                            onClick={() => toggleDealSelection(deal.id)}\n                            data-testid={`compare-deal-${deal.id}`}\n                          >\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2\">\n                                  <Checkbox\n                                    checked={selectedCompareDeals.includes(deal.id)}\n                                    onCheckedChange={() => toggleDealSelection(deal.id)}\n                                  />\n                                  <span className=\"font-medium truncate\">{deal.name}</span>\n                                </div>\n                                <div className=\"text-xs text-muted-foreground mt-1\">{deal.client}</div>\n                              </div>\n                              <Badge variant=\"outline\" className=\"shrink-0\">${deal.value}M</Badge>\n                            </div>\n                            <div className=\"flex items-center gap-2 mt-2\">\n                              <Badge className=\"text-xs\" variant=\"secondary\">{deal.stage}</Badge>\n                              <Badge className={cn(\n                                \"text-xs\",\n                                deal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                                deal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                                \"bg-gray-500/20 text-gray-400\"\n                              )}>{deal.status}</Badge>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                    {selectedCompareDeals.length > 0 && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"w-full\"\n                        onClick={() => setSelectedCompareDeals([])}\n                      >\n                        Clear Selection\n                      </Button>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Comparison Charts */}\n                <Card className=\"lg:col-span-2\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <BarChart3 className=\"w-5 h-5\" /> Deal Comparison\n                    </CardTitle>\n                    <CardDescription>\n                      {selectedCompareDeals.length === 0 \n                        ? \"Select deals from the left panel to compare them\"\n                        : `Comparing ${selectedCompareDeals.length} deal${selectedCompareDeals.length > 1 ? 's' : ''}`}\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {selectedCompareDeals.length === 0 ? (\n                      <div className=\"h-[400px] flex items-center justify-center text-muted-foreground\">\n                        <div className=\"text-center\">\n                          <GitCompare className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                          <p>Select at least one deal to see comparison</p>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"h-[400px]\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                          <RadarChart data={radarData}>\n                            <PolarGrid stroke=\"hsl(var(--border))\" />\n                            <PolarAngleAxis \n                              dataKey=\"metric\" \n                              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}\n                            />\n                            <PolarRadiusAxis \n                              angle={30} \n                              domain={[0, 100]} \n                              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10 }}\n                            />\n                            {selectedDealsData.map((deal, index) => (\n                              <Radar\n                                key={deal.id}\n                                name={deal.name}\n                                dataKey={deal.name}\n                                stroke={COMPARISON_COLORS[index % COMPARISON_COLORS.length]}\n                                fill={COMPARISON_COLORS[index % COMPARISON_COLORS.length]}\n                                fillOpacity={0.2}\n                              />\n                            ))}\n                            <Legend />\n                            <Tooltip\n                              contentStyle={{\n                                backgroundColor: 'hsl(var(--card))',\n                                border: '1px solid hsl(var(--border))',\n                                borderRadius: '8px'\n                              }}\n                            />\n                          </RadarChart>\n                        </ResponsiveContainer>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Comparison Table */}\n              {selectedCompareDeals.length > 0 && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Detailed Comparison</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left py-3 px-4 text-sm font-medium text-muted-foreground\">Metric</th>\n                            {selectedDealsData.map((deal, index) => (\n                              <th \n                                key={deal.id} \n                                className=\"text-left py-3 px-4 text-sm font-medium\"\n                                style={{ color: COMPARISON_COLORS[index % COMPARISON_COLORS.length] }}\n                              >\n                                {deal.name}\n                              </th>\n                            ))}\n                          </tr>\n                        </thead>\n                        <tbody>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Deal Value</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4 font-mono font-semibold\">${deal.value}M</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Client</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.client}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Sector</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.sector}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Stage</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <Badge variant=\"secondary\">{deal.stage}</Badge>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Status</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <Badge className={cn(\n                                  deal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                                  deal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                                  \"bg-gray-500/20 text-gray-400\"\n                                )}>{deal.status}</Badge>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Progress</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"w-24 h-2 bg-secondary rounded-full overflow-hidden\">\n                                    <div \n                                      className=\"h-full bg-primary\" \n                                      style={{ width: `${deal.progress || 0}%` }}\n                                    />\n                                  </div>\n                                  <span className=\"text-sm\">{deal.progress || 0}%</span>\n                                </div>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Lead</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.lead}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Team Size</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.podTeam as PodTeamMember[]) || []).length} members\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Tagged Investors</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.taggedInvestors as TaggedInvestor[]) || []).length} investors\n                              </td>\n                            ))}\n                          </tr>\n                          <tr>\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Documents</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.attachments as any[]) || []).length} files\n                              </td>\n                            ))}\n                          </tr>\n                        </tbody>\n                      </table>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          );\n        })()}\n      </div>\n\n      {/* Deal Room Sheet */}\n      <Sheet open={!!selectedDeal} onOpenChange={() => setSelectedDeal(null)}>\n        <SheetContent className=\"w-full sm:max-w-2xl bg-card border-border overflow-y-auto\">\n          {selectedDeal && (\n            <>\n              <SheetHeader className=\"pb-4 border-b border-border\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <SheetTitle className=\"text-2xl\">{selectedDeal.name}</SheetTitle>\n                    <SheetDescription>{selectedDeal.client}  {selectedDeal.sector}</SheetDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <AlertDialog>\n                      <AlertDialogTrigger asChild>\n                        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-move-to-opportunities\">\n                          <ArrowLeftCircle className=\"w-4 h-4 mr-2\" />\n                          Move to Opportunities\n                        </Button>\n                      </AlertDialogTrigger>\n                      <AlertDialogContent>\n                        <AlertDialogHeader>\n                          <AlertDialogTitle>Move to Opportunities?</AlertDialogTitle>\n                          <AlertDialogDescription>\n                            This will move \"{selectedDeal.name}\" back to the Opportunities page. The deal stage will be reset to \"Origination\".\n                          </AlertDialogDescription>\n                        </AlertDialogHeader>\n                        <AlertDialogFooter>\n                          <AlertDialogCancel>Cancel</AlertDialogCancel>\n                          <AlertDialogAction\n                            onClick={() => {\n                              moveDealToOpportunity.mutate(selectedDeal.id, {\n                                onSuccess: () => {\n                                  toast.success('Deal moved to Opportunities');\n                                  setSelectedDeal(null);\n                                },\n                                onError: (error) => {\n                                  toast.error(error.message || 'Failed to move deal');\n                                },\n                              });\n                            }}\n                          >\n                            Move to Opportunities\n                          </AlertDialogAction>\n                        </AlertDialogFooter>\n                      </AlertDialogContent>\n                    </AlertDialog>\n                    <Badge className={cn(\n                      \"px-3 py-1\",\n                      selectedDeal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                      selectedDeal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                      \"bg-gray-500/20 text-gray-400\"\n                    )}>\n                      {selectedDeal.status}\n                    </Badge>\n                  </div>\n                </div>\n              </SheetHeader>\n\n              {/* Stage Progress */}\n              <div className=\"py-6 border-b border-border\">\n                <h4 className=\"text-sm font-medium text-muted-foreground mb-4\">DEAL STAGE</h4>\n                <div className=\"flex items-center gap-2\">\n                  {DEAL_STAGES.map((stage, index) => {\n                    const isActive = getStageIndex(selectedDeal.stage) >= index;\n                    const isCurrent = selectedDeal.stage === stage;\n                    return (\n                      <Button\n                        key={stage}\n                        variant={isCurrent ? \"default\" : isActive ? \"secondary\" : \"outline\"}\n                        size=\"sm\"\n                        className={cn(\n                          \"flex-1 text-xs\",\n                          isCurrent && \"ring-2 ring-primary/30\",\n                          !isActive && \"opacity-50\"\n                        )}\n                        onClick={() => handleStageChange(selectedDeal, stage)}\n                        data-testid={`button-stage-${stage.toLowerCase()}`}\n                      >\n                        {stage}\n                      </Button>\n                    );\n                  })}\n                </div>\n                <div className=\"mt-3 h-2 bg-secondary rounded-full overflow-hidden\">\n                  <div \n                    className=\"h-full bg-primary transition-all duration-500\" \n                    style={{ width: `${getStageProgress(selectedDeal.stage)}%` }}\n                  />\n                </div>\n              </div>\n\n              {/* Tabs */}\n              <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mt-6\">\n                <TabsList className=\"grid grid-cols-8 bg-secondary/50\">\n                  <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n                  <TabsTrigger value=\"stages\">Stage Work</TabsTrigger>\n                  <TabsTrigger value=\"team\">Pod Team</TabsTrigger>\n                  <TabsTrigger value=\"investors\">Investors</TabsTrigger>\n                  <TabsTrigger value=\"documents\">Docs</TabsTrigger>\n                  <TabsTrigger value=\"voice\">Voice</TabsTrigger>\n                  <TabsTrigger value=\"notes\">Notes</TabsTrigger>\n                  <TabsTrigger value=\"audit\">Audit</TabsTrigger>\n                </TabsList>\n\n                {/* Overview Tab */}\n                <TabsContent value=\"overview\" className=\"mt-4 space-y-4\">\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <DollarSign className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\">${selectedDeal.value}M</div>\n                        <div className=\"text-xs text-muted-foreground\">Deal Value</div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <Users className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\"><DealTotalTeamCountNumber dealId={selectedDeal.id} podTeam={(selectedDeal.podTeam as PodTeamMember[]) || []} /></div>\n                        <div className=\"text-xs text-muted-foreground\">Team Members</div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <Building2 className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\">{(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length}</div>\n                        <div className=\"text-xs text-muted-foreground\">Investors</div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <span className=\"text-muted-foreground\">Sector:</span>\n                      <span className=\"ml-2 font-medium\">{selectedDeal.sector}</span>\n                    </div>\n                    <div className=\"p-3 bg-secondary/30 rounded-lg group relative\">\n                      <span className=\"text-muted-foreground\">Lead:</span>\n                      {editingLeadDealId === selectedDeal.id ? (\n                        <div className=\"mt-1\">\n                          <Select \n                            value={editingLeadValue} \n                            onValueChange={(value) => setEditingLeadValue(value)}\n                          >\n                            <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-edit-lead\">\n                              <SelectValue placeholder=\"Select lead\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {allUsers.filter(user => isDealEligibleUser(user)).map(user => (\n                                <SelectItem key={user.id} value={user.name}>{user.name}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <div className=\"flex gap-1 mt-1\">\n                            <Button \n                              size=\"sm\" \n                              className=\"h-6 text-xs px-2\"\n                              onClick={async () => {\n                                try {\n                                  await updateDeal.mutateAsync({ id: selectedDeal.id, lead: editingLeadValue });\n                                  toast.success(\"Lead updated\");\n                                  setEditingLeadDealId(null);\n                                } catch {\n                                  toast.error(\"Failed to update lead\");\n                                }\n                              }}\n                              data-testid=\"button-save-lead\"\n                            >\n                              Save\n                            </Button>\n                            <Button \n                              size=\"sm\" \n                              variant=\"outline\" \n                              className=\"h-6 text-xs px-2\"\n                              onClick={() => setEditingLeadDealId(null)}\n                            >\n                              Cancel\n                            </Button>\n                          </div>\n                        </div>\n                      ) : (\n                        <>\n                          <span className=\"ml-2 font-medium\">{selectedDeal.lead}</span>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-5 w-5 absolute top-2 right-2 opacity-0 group-hover:opacity-100\"\n                            onClick={() => {\n                              setEditingLeadDealId(selectedDeal.id);\n                              setEditingLeadValue(selectedDeal.lead);\n                            }}\n                            data-testid=\"button-edit-lead\"\n                          >\n                            <Pencil className=\"w-3 h-3\" />\n                          </Button>\n                        </>\n                      )}\n                    </div>\n                  </div>\n\n                  {selectedDeal.description && (\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <span className=\"text-muted-foreground text-sm\">Description:</span>\n                      <p className=\"mt-1 text-sm\">{selectedDeal.description}</p>\n                    </div>\n                  )}\n\n                  {/* Client Contact Section */}\n                  <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <UserCircle className=\"w-4 h-4 text-primary\" />\n                        <span className=\"font-medium text-sm\">Client Contact</span>\n                      </div>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"h-6 text-xs\"\n                        onClick={() => {\n                          setEditingClientContact(true);\n                          setClientContactForm({\n                            name: selectedDeal.clientContactName || '',\n                            email: selectedDeal.clientContactEmail || '',\n                            phone: selectedDeal.clientContactPhone || '',\n                            role: selectedDeal.clientContactRole || '',\n                          });\n                        }}\n                        data-testid=\"button-edit-client-contact\"\n                      >\n                        <Pencil className=\"w-3 h-3 mr-1\" /> Edit\n                      </Button>\n                    </div>\n                    {editingClientContact ? (\n                      <div className=\"space-y-2\">\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          <div>\n                            <Label className=\"text-xs\">Contact Name</Label>\n                            <Input \n                              value={clientContactForm.name}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, name: e.target.value }))}\n                              placeholder=\"Contact person name\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-name\"\n                            />\n                          </div>\n                          <div>\n                            <Label className=\"text-xs\">Role/Title</Label>\n                            <Input \n                              value={clientContactForm.role}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, role: e.target.value }))}\n                              placeholder=\"e.g., CFO, CEO\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-role\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          <div>\n                            <Label className=\"text-xs\">Email</Label>\n                            <Input \n                              type=\"email\"\n                              value={clientContactForm.email}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, email: e.target.value }))}\n                              placeholder=\"email@company.com\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-email\"\n                            />\n                          </div>\n                          <div>\n                            <Label className=\"text-xs\">Phone</Label>\n                            <Input \n                              value={clientContactForm.phone}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, phone: e.target.value }))}\n                              placeholder=\"+1 (555) 123-4567\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-phone\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"flex gap-2 mt-2\">\n                          <Button \n                            size=\"sm\" \n                            className=\"h-7 text-xs\"\n                            onClick={async () => {\n                              try {\n                                await updateDeal.mutateAsync({\n                                  id: selectedDeal.id,\n                                  clientContactName: clientContactForm.name || null,\n                                  clientContactEmail: clientContactForm.email || null,\n                                  clientContactPhone: clientContactForm.phone || null,\n                                  clientContactRole: clientContactForm.role || null,\n                                });\n                                setSelectedDeal({\n                                  ...selectedDeal,\n                                  clientContactName: clientContactForm.name || null,\n                                  clientContactEmail: clientContactForm.email || null,\n                                  clientContactPhone: clientContactForm.phone || null,\n                                  clientContactRole: clientContactForm.role || null,\n                                });\n                                setEditingClientContact(false);\n                                toast.success(\"Client contact updated\");\n                              } catch {\n                                toast.error(\"Failed to update client contact\");\n                              }\n                            }}\n                            data-testid=\"button-save-client-contact\"\n                          >\n                            Save\n                          </Button>\n                          <Button \n                            variant=\"outline\" \n                            size=\"sm\" \n                            className=\"h-7 text-xs\"\n                            onClick={() => setEditingClientContact(false)}\n                          >\n                            Cancel\n                          </Button>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"space-y-2\">\n                        {selectedDeal.clientContactName || selectedDeal.clientContactEmail || selectedDeal.clientContactPhone ? (\n                          <>\n                            {selectedDeal.clientContactName && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <UserCircle className=\"w-4 h-4 text-muted-foreground\" />\n                                <span className=\"font-medium\">{selectedDeal.clientContactName}</span>\n                                {selectedDeal.clientContactRole && (\n                                  <Badge variant=\"secondary\" className=\"text-[10px]\">{selectedDeal.clientContactRole}</Badge>\n                                )}\n                              </div>\n                            )}\n                            {selectedDeal.clientContactEmail && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <Mail className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`mailto:${selectedDeal.clientContactEmail}`} className=\"text-primary hover:underline\">\n                                  {selectedDeal.clientContactEmail}\n                                </a>\n                              </div>\n                            )}\n                            {selectedDeal.clientContactPhone && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`tel:${selectedDeal.clientContactPhone}`} className=\"text-primary hover:underline\">\n                                  {selectedDeal.clientContactPhone}\n                                </a>\n                              </div>\n                            )}\n                          </>\n                        ) : (\n                          <div className=\"text-sm text-muted-foreground italic\">No client contact added yet</div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Deal Fees Section */}\n                  {selectedDealFees.length > 0 && (\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <DollarSign className=\"w-4 h-4 text-primary\" />\n                        <span className=\"font-medium text-sm\">Fee Structure</span>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {selectedDealFees.map((fee: DealFeeType) => {\n                          const hasAmount = fee.amount !== null && fee.amount !== undefined && !isNaN(Number(fee.amount));\n                          const hasPercentage = fee.percentage !== null && fee.percentage !== undefined && !isNaN(Number(fee.percentage));\n                          return (\n                            <div key={fee.id} className=\"p-2 bg-background/50 rounded-md border border-border/50\">\n                              <div className=\"text-xs text-muted-foreground capitalize\">{fee.feeType.replace('-', ' ').replace('_', ' ')}</div>\n                              <div className=\"font-semibold text-primary\">\n                                {hasAmount \n                                  ? `$${Number(fee.amount).toLocaleString()}` \n                                  : hasPercentage \n                                    ? `${Number(fee.percentage)}%` \n                                    : '-'}\n                              </div>\n                              {fee.description && (\n                                <div className=\"text-xs text-muted-foreground mt-1\">{fee.description}</div>\n                              )}\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  )}\n                </TabsContent>\n\n                {/* Stage Work Tab */}\n                <TabsContent value=\"stages\" className=\"mt-4 space-y-4\">\n                  <StageWorkSection \n                    dealId={selectedDeal.id}\n                    dealName={selectedDeal.name}\n                    dealStage={selectedDeal.stage}\n                    allUsers={allUsers}\n                    currentUser={currentUser}\n                    allTasks={allTasks}\n                    activeStageTab={activeStageTab}\n                    setActiveStageTab={setActiveStageTab}\n                    createStageDocument={createStageDocument}\n                    deleteStageDocument={deleteStageDocument}\n                    createStagePodMember={createStagePodMember}\n                    deleteStagePodMember={deleteStagePodMember}\n                    createStageVoiceNote={createStageVoiceNote}\n                    deleteStageVoiceNote={deleteStageVoiceNote}\n                    createTaskComment={createTaskComment}\n                    createTask={createTask}\n                    createDocument={createDocument}\n                    deleteTask={deleteTask}\n                    totalTeamCount={uniqueTeamCount}\n                    onboardingStatus={onboardingStatus}\n                    onShowOnboardingWarning={(userName, missingResume, missingPersonality, onConfirm) => {\n                      setPendingAssignment({ userId: '', userName, missingResume, missingPersonality, onConfirm });\n                      setShowOnboardingWarning(true);\n                    }}\n                    onAuditEntry={async (action, details) => {\n                      try {\n                        const auditEntry: AuditEntry = {\n                          id: crypto.randomUUID(),\n                          timestamp: new Date().toISOString(),\n                          action,\n                          user: currentUser?.name || 'System',\n                          details,\n                        };\n                        \n                        // Fetch fresh deal data from server to get authoritative auditTrail\n                        const freshDeal = await queryClient.fetchQuery<Deal>({\n                          queryKey: ['deals', selectedDeal.id],\n                          queryFn: async () => {\n                            const res = await fetch(`/api/deals/${selectedDeal.id}`);\n                            if (!res.ok) throw new Error('Failed to fetch deal');\n                            return res.json();\n                          },\n                          staleTime: 0, // Force fresh fetch\n                        });\n                        \n                        const currentAuditTrail = Array.isArray(freshDeal?.auditTrail) \n                          ? [...(freshDeal.auditTrail as AuditEntry[])]\n                          : [];\n                        const newAuditTrail = [...currentAuditTrail, auditEntry];\n                        \n                        await updateDeal.mutateAsync({\n                          id: selectedDeal.id,\n                          auditTrail: newAuditTrail,\n                        });\n                        \n                        // Only update state after successful mutation\n                        const updatedDeal = { ...selectedDeal, auditTrail: newAuditTrail };\n                        setSelectedDeal(updatedDeal);\n                        \n                        // Also update the cache with a new array (immutable)\n                        queryClient.setQueryData<Deal[]>(['deals'], (old) => \n                          old ? old.map(d => d.id === selectedDeal.id ? { ...d, auditTrail: newAuditTrail } : d) : []\n                        );\n                      } catch (error: any) {\n                        toast.error(\"Failed to log audit entry\");\n                      }\n                    }}\n                  />\n                </TabsContent>\n\n                {/* Pod Team Tab */}\n                <TabsContent value=\"team\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Pod Team Members</h4>\n                    <Badge variant=\"secondary\">{uniqueTeamCount} members</Badge>\n                  </div>\n\n                  {/* Team Members List - Merge stage pod members from DB with legacy podTeam JSON */}\n                  <ScrollArea className=\"h-[200px]\">\n                    <div className=\"space-y-2\">\n                      {/* First show stage_pod_members from database */}\n                      {allStagePodMembers.map((member: any, index: number) => {\n                        const memberName = member.userName || 'Unknown';\n                        const initials = memberName.split(' ').map((n: string) => n[0] || '').join('').slice(0, 2);\n                        return (\n                          <div key={member.id || `stage-${index}`} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-sm font-bold text-primary\">\n                                {initials}\n                              </div>\n                              <div>\n                                <div className=\"font-medium flex items-center gap-2\">\n                                  {memberName}\n                                  {member.isLead && <Badge variant=\"secondary\" className=\"text-xs\">Lead</Badge>}\n                                </div>\n                                <div className=\"text-xs text-muted-foreground\">{member.role} - {member.stage}</div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              {member.phone && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild>\n                                  <a href={`tel:${member.phone}`}><Phone className=\"w-4 h-4 text-green-500\" /></a>\n                                </Button>\n                              )}\n                              {member.email && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild>\n                                  <a href={`mailto:${member.email}`}><Mail className=\"w-4 h-4 text-blue-500\" /></a>\n                                </Button>\n                              )}\n                              <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                  <Button \n                                    variant=\"ghost\" \n                                    size=\"icon\" \n                                    className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                  >\n                                    <X className=\"w-4 h-4 text-red-500\" />\n                                  </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                  <AlertDialogHeader>\n                                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                      This will remove {memberName} from the pod team. This action cannot be undone.\n                                    </AlertDialogDescription>\n                                  </AlertDialogHeader>\n                                  <AlertDialogFooter>\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                    <AlertDialogAction onClick={() => deleteStagePodMember.mutate(member.id)}>\n                                      Remove\n                                    </AlertDialogAction>\n                                  </AlertDialogFooter>\n                                </AlertDialogContent>\n                              </AlertDialog>\n                            </div>\n                          </div>\n                        );\n                      })}\n                      {/* Show legacy podTeam members from deal JSON if no stage_pod_members exist */}\n                      {allStagePodMembers.length === 0 && (selectedDealWithAttachments as any)?.podTeam && ((selectedDealWithAttachments as any).podTeam as PodTeamMember[]).map((member: PodTeamMember, index: number) => {\n                        const initials = member.name.split(' ').map((n: string) => n[0] || '').join('').slice(0, 2);\n                        return (\n                          <div key={`legacy-${index}`} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-sm font-bold text-primary\">\n                                {initials}\n                              </div>\n                              <div>\n                                <div className=\"font-medium\">{member.name}</div>\n                                <div className=\"text-xs text-muted-foreground\">{member.role}</div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              {member.phone && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild>\n                                  <a href={`tel:${member.phone}`}><Phone className=\"w-4 h-4 text-green-500\" /></a>\n                                </Button>\n                              )}\n                              {member.email && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild>\n                                  <a href={`mailto:${member.email}`}><Mail className=\"w-4 h-4 text-blue-500\" /></a>\n                                </Button>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                      {allStagePodMembers.length === 0 && !((selectedDealWithAttachments as any)?.podTeam?.length) && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No team members assigned yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n\n                  {/* Add Team Member Form */}\n                  <div className=\"p-4 border border-dashed border-border rounded-lg space-y-3\">\n                    <div className=\"flex items-center gap-2 text-sm font-medium\">\n                      <UserPlus className=\"w-4 h-4\" /> Add Team Member\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      <Popover open={teamMemberOpen} onOpenChange={setTeamMemberOpen}>\n                        <PopoverTrigger asChild>\n                          <Button variant=\"outline\" role=\"combobox\" className=\"w-full justify-start font-normal\">\n                            {newTeamMember.name || \"Search team member...\"}\n                          </Button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-full p-0\" align=\"start\">\n                          <Command>\n                            <CommandInput \n                              placeholder=\"Type name or email...\" \n                              value={teamMemberSearch}\n                              onValueChange={setTeamMemberSearch}\n                            />\n                            <CommandList>\n                              {teamMemberSearch.length >= 2 && filteredUsers.length === 0 && (\n                                <CommandEmpty>\n                                  <div className=\"p-2 text-sm\">\n                                    <p className=\"text-muted-foreground mb-2\">No users found. Add manually:</p>\n                                    <Input \n                                      placeholder=\"Enter name\"\n                                      value={newTeamMember.name}\n                                      onChange={(e) => setNewTeamMember({ ...newTeamMember, name: e.target.value })}\n                                      onKeyDown={(e) => {\n                                        if (e.key === 'Enter' && newTeamMember.name) {\n                                          setTeamMemberOpen(false);\n                                        }\n                                      }}\n                                    />\n                                  </div>\n                                </CommandEmpty>\n                              )}\n                              <CommandGroup>\n                                {filteredUsers.map((user) => (\n                                  <CommandItem\n                                    key={user.id}\n                                    value={user.name}\n                                    onSelect={() => {\n                                      setNewTeamMember({\n                                        ...newTeamMember,\n                                        name: user.name,\n                                        email: user.email || '',\n                                        phone: user.phone || '',\n                                        role: user.jobTitle || user.role || '',\n                                        userId: user.id,\n                                      });\n                                      setTeamMemberSearch('');\n                                      setTeamMemberOpen(false);\n                                    }}\n                                    className=\"flex items-center gap-2\"\n                                  >\n                                    <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-xs\">\n                                      {user.name.charAt(0).toUpperCase()}\n                                    </div>\n                                    <div className=\"flex-1\">\n                                      <div className=\"font-medium\">{user.name}</div>\n                                      <div className=\"text-xs text-muted-foreground\">{user.email}  {user.jobTitle || user.role}</div>\n                                    </div>\n                                    {newTeamMember.name === user.name && (\n                                      <Check className=\"w-4 h-4 text-primary\" />\n                                    )}\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </CommandList>\n                          </Command>\n                        </PopoverContent>\n                      </Popover>\n                      <Input \n                        placeholder=\"Role *\" \n                        value={newTeamMember.role}\n                        onChange={(e) => setNewTeamMember({ ...newTeamMember, role: e.target.value })}\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <Input \n                        placeholder=\"Email\" \n                        type=\"email\"\n                        value={newTeamMember.email}\n                        onChange={(e) => setNewTeamMember({ ...newTeamMember, email: e.target.value })}\n                      />\n                      <Input \n                        placeholder=\"Phone\" \n                        value={newTeamMember.phone}\n                        onChange={(e) => setNewTeamMember({ ...newTeamMember, phone: e.target.value })}\n                      />\n                      <Input \n                        placeholder=\"Slack ID\" \n                        value={newTeamMember.slack}\n                        onChange={(e) => setNewTeamMember({ ...newTeamMember, slack: e.target.value })}\n                      />\n                    </div>\n                    <Button onClick={handleAddTeamMember} className=\"w-full\">\n                      <Plus className=\"w-4 h-4 mr-1\" /> Add Member\n                    </Button>\n                  </div>\n                </TabsContent>\n\n                {/* Investors Tab */}\n                <TabsContent value=\"investors\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between gap-3\">\n                    <h4 className=\"font-medium\">Tagged Investors</h4>\n                    <div className=\"flex items-center gap-2 flex-1 max-w-xs\">\n                      <div className=\"relative flex-1\">\n                        <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted-foreground\" />\n                        <Input \n                          placeholder=\"Search investors...\"\n                          value={investorSearchQuery}\n                          onChange={(e) => setInvestorSearchQuery(e.target.value)}\n                          className=\"h-8 pl-8 text-sm\"\n                          data-testid=\"input-investor-search\"\n                        />\n                      </div>\n                      <Badge variant=\"secondary\">{(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length}</Badge>\n                    </div>\n                  </div>\n\n                  {/* Investors List */}\n                  <ScrollArea className=\"h-[200px]\">\n                    <div className=\"space-y-2\">\n                      {(selectedDeal.taggedInvestors as TaggedInvestor[] || [])\n                        .filter((investor) => {\n                          if (!investorSearchQuery) return true;\n                          const query = investorSearchQuery.toLowerCase();\n                          return (\n                            investor.name.toLowerCase().includes(query) ||\n                            investor.firm.toLowerCase().includes(query) ||\n                            investor.type.toLowerCase().includes(query) ||\n                            investor.status.toLowerCase().includes(query)\n                          );\n                        })\n                        .map((investor) => (\n                        <div key={investor.id} className=\"p-3 bg-secondary/30 rounded-lg group\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center\">\n                                <Building2 className=\"w-5 h-5 text-primary\" />\n                              </div>\n                              <div>\n                                <div className=\"font-medium\">{investor.name}</div>\n                                <div className=\"text-xs text-muted-foreground\">{investor.firm}  {investor.type}</div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              {investor.email && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild data-testid={`investor-email-${investor.id}`}>\n                                  <a href={`mailto:${investor.email}`}><Mail className=\"w-4 h-4 text-blue-500\" /></a>\n                                </Button>\n                              )}\n                              <Select \n                                value={investor.status} \n                                onValueChange={(v) => handleUpdateInvestorStatus(investor.id, v)}\n                              >\n                                <SelectTrigger className=\"h-8 w-28 text-xs\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {INVESTOR_STATUSES.map(status => (\n                                    <SelectItem key={status} value={status}>{status}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                  <Button \n                                    variant=\"ghost\" \n                                    size=\"icon\" \n                                    className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                  >\n                                    <X className=\"w-4 h-4 text-red-500\" />\n                                  </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                  <AlertDialogHeader>\n                                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                      This will remove {investor.name} from {investor.firm} from this deal. This action cannot be undone.\n                                    </AlertDialogDescription>\n                                  </AlertDialogHeader>\n                                  <AlertDialogFooter>\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                    <AlertDialogAction onClick={() => handleRemoveInvestor(investor.id)}>\n                                      Remove\n                                    </AlertDialogAction>\n                                  </AlertDialogFooter>\n                                </AlertDialogContent>\n                              </AlertDialog>\n                            </div>\n                          </div>\n                          {investor.notes && (\n                            <p className=\"text-xs text-muted-foreground mt-2 pl-13\">{investor.notes}</p>\n                          )}\n                        </div>\n                      ))}\n                      {(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No investors tagged yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n\n                  {/* Add Investor Form */}\n                  <div className=\"p-4 border border-dashed border-border rounded-lg space-y-3\">\n                    <div className=\"flex items-center gap-2 text-sm font-medium\">\n                      <Building2 className=\"w-4 h-4\" /> Tag Investor\n                    </div>\n                    \n                    {/* CRM Investor Search */}\n                    <Popover open={investorSearchOpen} onOpenChange={setInvestorSearchOpen}>\n                      <PopoverTrigger asChild>\n                        <Button\n                          variant=\"outline\"\n                          role=\"combobox\"\n                          aria-expanded={investorSearchOpen}\n                          className=\"w-full justify-between text-muted-foreground font-normal\"\n                          data-testid=\"investor-search-trigger\"\n                        >\n                          {newInvestor.name ? `${newInvestor.name} - ${newInvestor.firm}` : \"Search CRM investors...\"}\n                          <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                        </Button>\n                      </PopoverTrigger>\n                      <PopoverContent className=\"w-[400px] p-0\" align=\"start\">\n                        <Command>\n                          <CommandInput \n                            placeholder=\"Search investors by name or firm...\" \n                            value={investorSearchQuery}\n                            onValueChange={setInvestorSearchQuery}\n                          />\n                          <CommandList>\n                            <CommandEmpty>No investors found. Enter manually below.</CommandEmpty>\n                            <CommandGroup heading=\"CRM Investors\">\n                              {filteredCrmInvestors.slice(0, 10).map((investor) => (\n                                <CommandItem\n                                  key={investor.id}\n                                  value={`${investor.name} ${investor.firm}`}\n                                  onSelect={() => handleSelectCrmInvestor(investor)}\n                                  data-testid={`investor-option-${investor.id}`}\n                                >\n                                  <Check\n                                    className={cn(\n                                      \"mr-2 h-4 w-4\",\n                                      newInvestor.name === investor.name ? \"opacity-100\" : \"opacity-0\"\n                                    )}\n                                  />\n                                  <div className=\"flex flex-col\">\n                                    <span className=\"font-medium\">{investor.name}</span>\n                                    <span className=\"text-xs text-muted-foreground\">{investor.firm}</span>\n                                  </div>\n                                </CommandItem>\n                              ))}\n                            </CommandGroup>\n                          </CommandList>\n                        </Command>\n                      </PopoverContent>\n                    </Popover>\n                    \n                    <div className=\"text-xs text-muted-foreground text-center\">- or enter manually -</div>\n                    \n                    <div className=\"grid grid-cols-2 gap-2\">\n                      <Input \n                        placeholder=\"Contact Name *\" \n                        value={newInvestor.name}\n                        onChange={(e) => setNewInvestor({ ...newInvestor, name: e.target.value })}\n                      />\n                      <Input \n                        placeholder=\"Firm Name *\" \n                        value={newInvestor.firm}\n                        onChange={(e) => setNewInvestor({ ...newInvestor, firm: e.target.value })}\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      <Select value={newInvestor.type} onValueChange={(v) => setNewInvestor({ ...newInvestor, type: v })}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Type\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {INVESTOR_TYPES.map(type => (\n                            <SelectItem key={type} value={type}>{type}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <Select value={newInvestor.status} onValueChange={(v) => setNewInvestor({ ...newInvestor, status: v })}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Status\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {INVESTOR_STATUSES.map(status => (\n                            <SelectItem key={status} value={status}>{status}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <Textarea \n                      placeholder=\"Notes (optional)\" \n                      value={newInvestor.notes}\n                      onChange={(e) => setNewInvestor({ ...newInvestor, notes: e.target.value })}\n                      className=\"resize-none\"\n                      rows={2}\n                    />\n                    <Button onClick={handleAddInvestor} className=\"w-full\">\n                      <Plus className=\"w-4 h-4 mr-1\" /> Tag Investor\n                    </Button>\n                  </div>\n                </TabsContent>\n\n                {/* Documents Tab */}\n                <TabsContent value=\"documents\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Deal Documents</h4>\n                    <Badge variant=\"secondary\">\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).length} files\n                    </Badge>\n                  </div>\n\n                  <ObjectUploader\n                    maxNumberOfFiles={20}\n                    maxFileSize={500 * 1024 * 1024}\n                    accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp,.heic,.bmp,.mp4,.mov,.avi,.mp3,.wav,image/*,video/*,audio/*\"\n                    onComplete={(files: UploadedFile[]) => {\n                      const existingAttachments = (selectedDealWithAttachments?.attachments as any[] || []);\n                      const newAttachments = files.map(f => ({\n                        id: f.id,\n                        filename: f.filename,\n                        url: f.objectPath,\n                        objectPath: f.objectPath,\n                        size: f.size,\n                        type: f.type,\n                        uploadedAt: new Date().toISOString(),\n                      }));\n                      \n                      updateDeal.mutate({\n                        id: selectedDeal.id,\n                        attachments: [...existingAttachments, ...newAttachments],\n                      });\n                      \n                      newAttachments.forEach(doc => {\n                        createDocument.mutate({\n                          title: doc.filename,\n                          type: doc.type || 'application/octet-stream',\n                          category: 'Other',\n                          filename: doc.filename,\n                          originalName: doc.filename,\n                          mimeType: doc.type,\n                          size: doc.size,\n                          content: doc.objectPath,\n                          dealId: selectedDeal.id,\n                          dealName: selectedDeal.name,\n                          tags: ['Deal Document'],\n                        });\n                      });\n                    }}\n                    buttonVariant=\"outline\"\n                  >\n                    <Upload className=\"w-4 h-4 mr-2\" />\n                    Upload Files (up to 500MB)\n                  </ObjectUploader>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Supports documents, images, videos, and audio files\n                  </p>\n\n                  <ScrollArea className=\"h-[300px]\">\n                    <div className=\"space-y-2\">\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).map((doc: any) => (\n                        <div key={doc.id} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"w-10 h-10 rounded bg-primary/10 flex items-center justify-center\">\n                              <FileText className=\"w-5 h-5 text-primary\" />\n                            </div>\n                            <div>\n                              <div className=\"font-medium text-sm\">{doc.filename}</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                {(doc.size / 1024).toFixed(1)} KB  {format(new Date(doc.uploadedAt), 'MMM d, yyyy')}\n                              </div>\n                            </div>\n                          </div>\n                          <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8\"\n                              onClick={() => {\n                                const fileUrl = doc.objectPath || doc.url;\n                                if (doc.contentUnavailable || (!fileUrl?.startsWith('/objects/') && !fileUrl?.startsWith('data:'))) {\n                                  toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n                                  return;\n                                }\n                                window.open(fileUrl, '_blank');\n                              }}\n                              title=\"View\"\n                              data-testid={`button-view-doc-${doc.id}`}\n                            >\n                              <Eye className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8\"\n                              onClick={() => {\n                                const fileUrl = doc.objectPath || doc.url;\n                                if (doc.contentUnavailable || (!fileUrl?.startsWith('/objects/') && !fileUrl?.startsWith('data:'))) {\n                                  toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n                                  return;\n                                }\n                                const link = document.createElement('a');\n                                link.href = fileUrl;\n                                link.download = doc.filename || 'document';\n                                document.body.appendChild(link);\n                                link.click();\n                                document.body.removeChild(link);\n                              }}\n                              title=\"Download\"\n                              data-testid={`button-download-doc-${doc.id}`}\n                            >\n                              <Download className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8 text-red-400 hover:text-red-300\"\n                              onClick={() => {\n                                const updatedAttachments = (selectedDealWithAttachments?.attachments as any[] || [])\n                                  .filter((a: any) => a.id !== doc.id);\n                                updateDeal.mutate({\n                                  id: selectedDeal.id,\n                                  attachments: updatedAttachments,\n                                });\n                              }}\n                              title=\"Delete\"\n                              data-testid={`button-delete-doc-${doc.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No documents uploaded yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n\n                {/* Voice Notes Tab */}\n                <TabsContent value=\"voice\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Voice Notes</h4>\n                    <Badge variant=\"secondary\">{(dealVoiceNotes[selectedDeal.id] || []).length} notes</Badge>\n                  </div>\n\n                  {/* Recording Section */}\n                  <div className=\"p-4 border border-dashed border-border rounded-lg space-y-3\">\n                    {isRecordingVoice ? (\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center justify-center gap-4\">\n                          <div className=\"w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center animate-pulse\">\n                            <Mic className=\"w-6 h-6 text-red-500\" />\n                          </div>\n                          <div className=\"text-2xl font-bold text-red-500\">{formatVoiceDuration(voiceRecordingTime)}</div>\n                        </div>\n                        <Input\n                          placeholder=\"Add a title for this recording...\"\n                          value={voiceNoteTitle}\n                          onChange={(e) => setVoiceNoteTitle(e.target.value)}\n                          className=\"text-center\"\n                        />\n                        <div className=\"flex items-center justify-center gap-2\">\n                          <Button variant=\"outline\" onClick={cancelVoiceRecording}>\n                            <X className=\"w-4 h-4 mr-2\" /> Cancel\n                          </Button>\n                          <Button variant=\"destructive\" onClick={stopVoiceRecording}>\n                            <Square className=\"w-4 h-4 mr-2\" /> Stop & Save\n                          </Button>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"text-center space-y-3\">\n                        <Button onClick={startVoiceRecording} className=\"gap-2\">\n                          <Mic className=\"w-4 h-4\" /> Start Recording\n                        </Button>\n                        <p className=\"text-xs text-muted-foreground\">Record quick audio updates for this deal</p>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Voice Notes List */}\n                  <ScrollArea className=\"h-[200px]\">\n                    <div className=\"space-y-2\">\n                      {(dealVoiceNotes[selectedDeal.id] || []).map((note) => (\n                        <div key={note.id} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                          <div className=\"flex items-center gap-3 flex-1\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              className=\"h-10 w-10 rounded-full bg-primary/20\"\n                              onClick={() => toggleVoiceNotePlay(note.id, note.duration)}\n                            >\n                              {playingVoiceNoteId === note.id ? (\n                                <Pause className=\"w-4 h-4 text-primary\" />\n                              ) : (\n                                <Play className=\"w-4 h-4 text-primary\" />\n                              )}\n                            </Button>\n                            <div className=\"flex-1\">\n                              <div className=\"font-medium text-sm\">{note.title}</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                {note.authorName}  {formatVoiceDuration(note.duration)}  {format(parseISO(note.createdAt), 'MMM d, h:mm a')}\n                              </div>\n                              {playingVoiceNoteId === note.id && (\n                                <div className=\"h-1 bg-secondary rounded-full mt-2 overflow-hidden\">\n                                  <div \n                                    className=\"h-full bg-primary transition-all\" \n                                    style={{ width: `${voicePlayProgress}%` }}\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\"\n                            onClick={() => deleteVoiceNote(selectedDeal.id, note.id)}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-red-500\" />\n                          </Button>\n                        </div>\n                      ))}\n                      {(dealVoiceNotes[selectedDeal.id] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No voice notes recorded yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n\n                {/* Deal Notes Tab */}\n                <TabsContent value=\"notes\" className=\"mt-4 space-y-4\">\n                  <DealNotesSection dealId={selectedDeal.id} allUsers={allUsers} />\n                </TabsContent>\n\n                {/* Audit Trail Tab */}\n                <TabsContent value=\"audit\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Institutional Audit Trail</h4>\n                    <Badge variant=\"secondary\">{(selectedDeal.auditTrail as AuditEntry[] || []).length} entries</Badge>\n                  </div>\n\n                  <ScrollArea className=\"h-[400px]\">\n                    <div className=\"space-y-3\">\n                      {(selectedDeal.auditTrail as AuditEntry[] || []).slice().reverse().map((entry) => (\n                        <div key={entry.id} className=\"flex gap-3 p-3 bg-secondary/30 rounded-lg\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0\">\n                            <History className=\"w-4 h-4 text-primary\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"font-medium text-sm\">{entry.action}</span>\n                              <span className=\"text-xs text-muted-foreground\">\n                                {format(new Date(entry.timestamp), 'MMM d, yyyy h:mm a')}\n                              </span>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground mt-1\">{entry.details}</p>\n                            <p className=\"text-[10px] text-muted-foreground/70 mt-1\">by {entry.user}</p>\n                          </div>\n                        </div>\n                      ))}\n                      {(selectedDeal.auditTrail as AuditEntry[] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No audit entries yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n              </Tabs>\n            </>\n          )}\n        </SheetContent>\n      </Sheet>\n\n      {/* New Deal Modal */}\n      <Dialog open={showNewDealModal} onOpenChange={setShowNewDealModal}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Create New Deal</DialogTitle>\n            <DialogDescription>Enter the details for the new deal below.</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Deal Name *</Label>\n              <Input \n                placeholder=\"Project Codename\" \n                value={newDeal.name}\n                onChange={(e) => setNewDeal({ ...newDeal, name: e.target.value })}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Client *</Label>\n              <Input \n                placeholder=\"Client Company Name\" \n                value={newDeal.client}\n                onChange={(e) => setNewDeal({ ...newDeal, client: e.target.value })}\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Value (in millions) *</Label>\n                <Input \n                  type=\"number\" \n                  placeholder=\"100\" \n                  value={newDeal.value}\n                  onChange={(e) => setNewDeal({ ...newDeal, value: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Sector</Label>\n                <Popover open={sectorOpen} onOpenChange={setSectorOpen}>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" role=\"combobox\" aria-expanded={sectorOpen} className=\"w-full justify-between\">\n                      {newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector}\n                      <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-full p-0\">\n                    <Command>\n                      <CommandInput placeholder=\"Search sector or type custom...\" />\n                      <CommandList>\n                        <CommandEmpty>\n                          <div className=\"p-2\">\n                            <p className=\"text-sm text-muted-foreground mb-2\">No sector found. Add custom:</p>\n                            <Input \n                              placeholder=\"Enter custom sector\"\n                              value={newDeal.customSector}\n                              onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                              onKeyDown={(e) => {\n                                if (e.key === 'Enter' && newDeal.customSector) {\n                                  setNewDeal({ ...newDeal, sector: 'Other' });\n                                  setSectorOpen(false);\n                                }\n                              }}\n                            />\n                          </div>\n                        </CommandEmpty>\n                        <CommandGroup>\n                          {SECTORS.map((sector) => (\n                            <CommandItem\n                              key={sector}\n                              value={sector}\n                              onSelect={() => {\n                                setNewDeal({ ...newDeal, sector, customSector: sector === 'Other' ? newDeal.customSector : '' });\n                                setSectorOpen(false);\n                              }}\n                            >\n                              <Check className={cn(\"mr-2 h-4 w-4\", newDeal.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                              {sector}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n                {newDeal.sector === 'Other' && (\n                  <Input \n                    placeholder=\"Enter custom sector name\"\n                    value={newDeal.customSector}\n                    onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                    className=\"mt-2\"\n                  />\n                )}\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Stage</Label>\n                <Select value={newDeal.stage} onValueChange={(v) => setNewDeal({ ...newDeal, stage: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DEAL_STAGES.map(stage => (\n                      <SelectItem key={stage} value={stage}>{stage}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Lead</Label>\n                <Popover open={leadOpen} onOpenChange={setLeadOpen}>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" role=\"combobox\" aria-expanded={leadOpen} className=\"w-full justify-between\">\n                      {newDeal.lead || \"Select deal lead...\"}\n                      <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-full p-0\">\n                    <Command>\n                      <CommandInput placeholder=\"Search team members...\" />\n                      <CommandList>\n                        <CommandEmpty>No team member found.</CommandEmpty>\n                        <CommandGroup>\n                          {allUsers.filter(user => isDealEligibleUser(user)).map(user => {\n                            const userOnboarding = onboardingStatus[user.id];\n                            const isOnboardingComplete = userOnboarding?.isComplete ?? false;\n                            return (\n                              <CommandItem\n                                key={user.id}\n                                value={user.name}\n                                onSelect={() => {\n                                  if (!isOnboardingComplete) {\n                                    setPendingAssignment({\n                                      userId: user.id,\n                                      userName: user.name,\n                                      missingResume: !userOnboarding?.hasResume,\n                                      missingPersonality: !userOnboarding?.hasPersonality,\n                                      onConfirm: () => {\n                                        setNewDeal({ ...newDeal, lead: user.name });\n                                      }\n                                    });\n                                    setShowOnboardingWarning(true);\n                                    setLeadOpen(false);\n                                    return;\n                                  }\n                                  setNewDeal({ ...newDeal, lead: user.name });\n                                  setLeadOpen(false);\n                                }}\n                              >\n                                <Check className={cn(\"mr-2 h-4 w-4\", newDeal.lead === user.name ? \"opacity-100\" : \"opacity-0\")} />\n                                <span className={cn(!isOnboardingComplete && \"text-muted-foreground\")}>{user.name}</span>\n                                {!isOnboardingComplete && (\n                                  <Badge variant=\"outline\" className=\"ml-2 text-xs text-amber-500 border-amber-500\">Incomplete Onboarding</Badge>\n                                )}\n                              </CommandItem>\n                            );\n                          })}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              </div>\n            </div>\n            \n            <div className=\"border-t border-border pt-4 mt-4\">\n              <h4 className=\"text-sm font-medium mb-3 flex items-center gap-2\">\n                <DollarSign className=\"w-4 h-4\" />\n                Fee Structure (Optional)\n              </h4>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs\">Engagement Fee ($)</Label>\n                  <Input \n                    type=\"number\" \n                    placeholder=\"0\" \n                    value={newDealFees.engagement}\n                    onChange={(e) => setNewDealFees({ ...newDealFees, engagement: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs\">Monthly Retainer ($)</Label>\n                  <Input \n                    type=\"number\" \n                    placeholder=\"0\" \n                    value={newDealFees.monthly}\n                    onChange={(e) => setNewDealFees({ ...newDealFees, monthly: e.target.value })}\n                  />\n                </div>\n              </div>\n              <div className=\"grid grid-cols-3 gap-3 mt-3\">\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs\">Success Fee (%)</Label>\n                  <Input \n                    type=\"number\" \n                    placeholder=\"0\" \n                    step=\"0.1\"\n                    value={newDealFees.success}\n                    onChange={(e) => setNewDealFees({ ...newDealFees, success: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs\">Transaction Fee (%)</Label>\n                  <Input \n                    type=\"number\" \n                    placeholder=\"0\" \n                    step=\"0.1\"\n                    value={newDealFees.transaction}\n                    onChange={(e) => setNewDealFees({ ...newDealFees, transaction: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs\">Spread (%)</Label>\n                  <Input \n                    type=\"number\" \n                    placeholder=\"0\" \n                    step=\"0.1\"\n                    value={newDealFees.spread}\n                    onChange={(e) => setNewDealFees({ ...newDealFees, spread: e.target.value })}\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowNewDealModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateDeal} disabled={createDeal.isPending}>\n              {createDeal.isPending ? \"Creating...\" : \"Create Deal\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Deal Modal */}\n      <Dialog open={showEditModal} onOpenChange={setShowEditModal}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Edit Deal</DialogTitle>\n          </DialogHeader>\n          {editingDeal && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Deal Name</Label>\n                <Input \n                  value={editingDeal.name}\n                  onChange={(e) => setEditingDeal({ ...editingDeal, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Client</Label>\n                <Input \n                  value={editingDeal.client}\n                  onChange={(e) => setEditingDeal({ ...editingDeal, client: e.target.value })}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Value (in millions)</Label>\n                  <Input \n                    type=\"number\" \n                    value={editingDeal.value}\n                    onChange={(e) => setEditingDeal({ ...editingDeal, value: parseInt(e.target.value) || 0 })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Stage</Label>\n                  <Select value={editingDeal.stage} onValueChange={(v) => setEditingDeal({ ...editingDeal, stage: v, progress: getStageProgress(v) })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {DEAL_STAGES.map(stage => (\n                        <SelectItem key={stage} value={stage}>{stage}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Sector</Label>\n                  <Popover open={editSectorOpen} onOpenChange={setEditSectorOpen}>\n                    <PopoverTrigger asChild>\n                      <Button variant=\"outline\" role=\"combobox\" aria-expanded={editSectorOpen} className=\"w-full justify-between\">\n                        {editingDeal.sector === 'Other' && editCustomSector ? editCustomSector : editingDeal.sector}\n                        <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-full p-0\">\n                      <Command>\n                        <CommandInput placeholder=\"Search sector or type custom...\" />\n                        <CommandList>\n                          <CommandEmpty>\n                            <div className=\"p-2\">\n                              <p className=\"text-sm text-muted-foreground mb-2\">No sector found. Add custom:</p>\n                              <Input \n                                placeholder=\"Enter custom sector\"\n                                value={editCustomSector}\n                                onChange={(e) => setEditCustomSector(e.target.value)}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter' && editCustomSector) {\n                                    setEditingDeal({ ...editingDeal, sector: 'Other' });\n                                    setEditSectorOpen(false);\n                                  }\n                                }}\n                              />\n                            </div>\n                          </CommandEmpty>\n                          <CommandGroup>\n                            {SECTORS.map((sector) => (\n                              <CommandItem\n                                key={sector}\n                                value={sector}\n                                onSelect={() => {\n                                  setEditingDeal({ ...editingDeal, sector });\n                                  if (sector !== 'Other') setEditCustomSector('');\n                                  setEditSectorOpen(false);\n                                }}\n                              >\n                                <Check className={cn(\"mr-2 h-4 w-4\", editingDeal.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                                {sector}\n                              </CommandItem>\n                            ))}\n                          </CommandGroup>\n                        </CommandList>\n                      </Command>\n                    </PopoverContent>\n                  </Popover>\n                  {editingDeal.sector === 'Other' && (\n                    <Input \n                      placeholder=\"Enter custom sector name\"\n                      value={editCustomSector}\n                      onChange={(e) => setEditCustomSector(e.target.value)}\n                      className=\"mt-2\"\n                    />\n                  )}\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Status</Label>\n                  <Select value={editingDeal.status} onValueChange={(v) => setEditingDeal({ ...editingDeal, status: v })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Active\">Active</SelectItem>\n                      <SelectItem value=\"On Hold\">On Hold</SelectItem>\n                      <SelectItem value=\"Closed\">Closed</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditModal(false)}>Cancel</Button>\n            <Button onClick={handleEditDeal} disabled={updateDeal.isPending}>\n              {updateDeal.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Task Detail Modal for Calendar View */}\n      <Dialog open={showTaskDetailModal} onOpenChange={setShowTaskDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"w-5 h-5 text-primary\" />\n              Task Details\n            </DialogTitle>\n            <DialogDescription>\n              {selectedCalendarTask?.deal?.name}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedCalendarTask && (\n            <div className=\"space-y-4 py-4\">\n              <div>\n                <h3 className=\"text-lg font-semibold\">{selectedCalendarTask.title}</h3>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Priority</p>\n                  <Badge variant={selectedCalendarTask.priority === 'High' ? 'destructive' : 'secondary'} className=\"mt-1\">\n                    {selectedCalendarTask.priority}\n                  </Badge>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Status</p>\n                  <Badge variant={selectedCalendarTask.status === 'Completed' ? 'default' : 'secondary'} className=\"mt-1\">\n                    {selectedCalendarTask.status}\n                  </Badge>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Due Date</p>\n                  <p className=\"text-sm font-medium mt-1\">\n                    {selectedCalendarTask.dueDate ? format(parseISO(selectedCalendarTask.dueDate), 'MMM d, yyyy') : 'Not set'}\n                  </p>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Assigned To</p>\n                  <p className=\"text-sm font-medium mt-1\">\n                    {allUsers.find((u: any) => u.id === selectedCalendarTask.assignedTo)?.name || 'Unassigned'}\n                  </p>\n                </div>\n              </div>\n              \n              <div>\n                <p className=\"text-xs text-muted-foreground mb-1\">Related Deal</p>\n                <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                  <p className=\"font-medium\">{selectedCalendarTask.deal?.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {selectedCalendarTask.deal?.client}  {selectedCalendarTask.deal?.sector}\n                  </p>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  className=\"flex-1\"\n                  onClick={() => {\n                    setSelectedDeal(selectedCalendarTask.deal);\n                    setActiveTab(\"overview\");\n                    setShowTaskDetailModal(false);\n                  }}\n                >\n                  <Eye className=\"w-4 h-4 mr-2\" />\n                  View Deal\n                </Button>\n                <Button variant=\"outline\" onClick={() => setShowTaskDetailModal(false)}>Close</Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Deal Confirmation Dialog */}\n      <AlertDialog open={showDeleteDealDialog} onOpenChange={setShowDeleteDealDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This action cannot be undone. This will permanently delete this deal and all its associated data including team members, investors, and documents.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => setDealToDelete(null)}>Cancel</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={() => {\n                if (dealToDelete) {\n                  handleDeleteDeal(dealToDelete);\n                  setDealToDelete(null);\n                  setShowDeleteDealDialog(false);\n                }\n              }}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              Delete Deal\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Onboarding Incomplete Warning Dialog */}\n      <AlertDialog open={showOnboardingWarning} onOpenChange={setShowOnboardingWarning}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2 text-amber-500\">\n              <UserCircle className=\"w-5 h-5\" />\n              Onboarding Not Complete\n            </AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-3\">\n              <p>\n                <strong>{pendingAssignment?.userName}</strong> has not completed the required onboarding steps.\n              </p>\n              <div className=\"bg-secondary/50 rounded-lg p-3 space-y-2\">\n                <p className=\"text-sm font-medium\">Missing steps:</p>\n                <ul className=\"text-sm space-y-1\">\n                  {pendingAssignment?.missingResume && (\n                    <li className=\"flex items-center gap-2\">\n                      <X className=\"w-4 h-4 text-destructive\" />\n                      Resume Onboarding (upload and analysis)\n                    </li>\n                  )}\n                  {pendingAssignment?.missingPersonality && (\n                    <li className=\"flex items-center gap-2\">\n                      <X className=\"w-4 h-4 text-destructive\" />\n                      Personality Assessment\n                    </li>\n                  )}\n                </ul>\n              </div>\n              <p className=\"text-sm\">\n                We recommend having this team member complete their onboarding for optimal team assignment. You can still proceed with the assignment if needed.\n              </p>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => {\n              setShowOnboardingWarning(false);\n              setPendingAssignment(null);\n            }}>\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction onClick={() => {\n              if (pendingAssignment?.onConfirm) {\n                pendingAssignment.onConfirm();\n              }\n              setShowOnboardingWarning(false);\n              setPendingAssignment(null);\n            }}>\n              Assign Anyway\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":224037,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { metaImagesPlugin } from \"./vite-plugin-meta-images\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    tailwindcss(),\n    metaImagesPlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  css: {\n    postcss: {\n      plugins: [],\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    allowedHosts: true,\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1330,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":2001,"size_tokens":null},"replit.md":{"content":"# Overview\n\nKronos is a full-stack investment banking operations platform designed to streamline deal management, task assignments, document handling, investor matching, and team collaboration. It provides role-based interfaces for CEOs and employees, aiming to enhance operational efficiency and strategic decision-making within investment banking firms. The platform is built with a React/Vite frontend and an Express backend, leveraging a PostgreSQL database (Neon) and session-based authentication.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## UI/UX Decisions\n\nThe frontend is built with React 18, TypeScript, and Vite. It utilizes `shadcn/ui` with the \"new-york\" style variant for a consistent design system. Styling is managed with Tailwind CSS, featuring a custom fintech-focused navy blue color scheme and dark mode support. The font stack includes Inter, Plus Jakarta Sans, and Space Mono. Role-based layouts ensure tailored experiences for CEOs and employees, with protected routes and reusable UI components.\n\n## Technical Implementations\n\n### Frontend\n- **State Management:** TanStack Query (React Query) v5 for server state and caching.\n- **Routing:** `wouter` for client-side routing.\n- **Form Handling:** `react-hook-form` with Zod for validation.\n- **Notifications:** `sonner` for toast notifications.\n- **Icons:** `lucide-react`.\n\n### Backend\n- **Server:** Express.js with TypeScript and Node.js.\n- **Authentication:** Passport.js with LocalStrategy for email/password, `express-session` for session management, and `bcryptjs` for password hashing. Two-factor authentication (TOTP-based) is implemented using `otplib` and `qrcode`.\n- **API:** RESTful API endpoints with request logging and JSON body parsing.\n- **Database ORM:** Drizzle ORM for type-safe PostgreSQL queries.\n- **Type Safety:** Zod schemas and shared TypeScript types between frontend and backend.\n- **Object Storage:** Integration with Replit Object Storage for large file uploads (up to 500MB) using presigned URLs and owner-scoped access control.\n- **AI Assistant:** An integrated AI assistant powered by OpenAI (gpt-5 model via Replit AI Integrations) provides role-appropriate context from platform data (deals, tasks, users, documents). It supports persistent conversation history and automatic title generation.\n- **Audit Logging:** A system-wide audit trail logs authentication, user management, deal, task, and document operations, accessible to CEOs with filtering and export capabilities.\n\n## System Design Choices\n\n- **Data Persistence:** PostgreSQL database managed via Neon serverless driver.\n- **Schema Design:** Comprehensive schema includes tables for Users (with roles, job titles, performance metrics, 2FA fields), Deals (stage, value, client, sector), Tasks (assignments, priority, due dates), Meetings, Notifications, Investor Matches, User Preferences (for UI state), Deal Templates, Calendar Events, Task Attachments, Documents (with file data, categories, tags), Messages, Conversations, and Conversation Members. A dedicated `audit_logs_table` tracks system events. Task Templates feature includes `taskTemplates`, `taskTemplateSections`, `taskTemplateTasks`, and `taskTemplateUsageLog` tables.\n- **HR Task Templates:** Asana-inspired task templates system allowing HR administrators (Dimitra and Charles only) to create reusable templates with sections, tasks, assignees, and relative due dates. Templates can be applied to create real tasks with computed due dates based on a start date.\n- **User Preferences Persistence:** UI state is saved to the `user_preferences` table, with debounced saves and conflict resolution for concurrent updates.\n- **Security:** Invite-only registration, user suspension, and robust role-based access control.\n\n# External Dependencies\n\n- **Database:** Neon (PostgreSQL serverless driver)\n- **ORM:** `drizzle-orm`, `drizzle-kit`\n- **Authentication:** `passport`, `passport-local`, `bcryptjs`, `express-session`, `otplib`, `qrcode`\n- **Frontend Libraries:** `@tanstack/react-query`, `wouter`, `@radix-ui/*`, `tailwindcss`, `react-hook-form`, `zod`, `sonner`, `lucide-react`\n- **Build Tools:** `vite`, `@vitejs/plugin-react`, `esbuild`, `tsx`\n- **Utilities:** `clsx`, `tailwind-merge`, `class-variance-authority`, `date-fns`, `nanoid`\n- **Email Service:** Resend (via Replit Connectors)\n- **AI Integration:** OpenAI (via Replit AI Integrations)\n- **Object Storage:** Replit Object Storage","path":null,"size_bytes":4487,"size_tokens":null},"client/src/components/ui/kbd.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Kbd({ className, ...props }: React.ComponentProps<\"kbd\">) {\n  return (\n    <kbd\n      data-slot=\"kbd\"\n      className={cn(\n        \"bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium\",\n        \"[&_svg:not([class*='size-'])]:size-3\",\n        \"[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction KbdGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <kbd\n      data-slot=\"kbd-group\"\n      className={cn(\"inline-flex items-center gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Kbd, KbdGroup }\n","path":null,"size_bytes":862,"size_tokens":null},"server/seed.ts":{"content":"import { storage } from \"./storage\";\n\nasync function seed() {\n  try {\n    console.log(\"Seeding database...\");\n\n    // Create users\n    const users = await Promise.all([\n      storage.createUser({\n        name: \"Joshua Orlinsky\",\n        email: \"josh@equiturn.com\",\n        password: \"password123\",\n        role: \"CEO\",\n        score: 98,\n        activeDeals: 6,\n        completedTasks: 45,\n      }),\n      storage.createUser({\n        name: \"Emily Johnson\",\n        email: \"emily@equiturn.com\",\n        password: \"password123\",\n        role: \"Associate\",\n        score: 85,\n        activeDeals: 1,\n        completedTasks: 12,\n      }),\n      storage.createUser({\n        name: \"Michael Rodriguez\",\n        email: \"michael@equiturn.com\",\n        password: \"password123\",\n        role: \"Director\",\n        score: 82,\n        activeDeals: 2,\n        completedTasks: 28,\n      }),\n      storage.createUser({\n        name: \"Sarah Chen\",\n        email: \"sarah@equiturn.com\",\n        password: \"password123\",\n        role: \"Managing Director\",\n        score: 91,\n        activeDeals: 3,\n        completedTasks: 56,\n      }),\n      storage.createUser({\n        name: \"Alex Chen\",\n        email: \"alex@equiturn.com\",\n        password: \"password123\",\n        role: \"Analyst\",\n        score: 74,\n        activeDeals: 1,\n        completedTasks: 8,\n      }),\n    ]);\n\n    console.log(`Created ${users.length} users`);\n\n    // Create deals\n    const deals = await Promise.all([\n      storage.createDeal({\n        name: \"Project Titan\",\n        stage: \"Structuring\",\n        value: 450,\n        client: \"TechCorp Inc.\",\n        sector: \"Technology\",\n        lead: \"Sarah Chen\",\n        progress: 45,\n        status: \"Active\",\n      }),\n      storage.createDeal({\n        name: \"Project Gemini\",\n        stage: \"Diligence\",\n        value: 120,\n        client: \"GreenEnergy Co.\",\n        sector: \"Energy\",\n        lead: \"Michael Rodriguez\",\n        progress: 60,\n        status: \"Active\",\n      }),\n      storage.createDeal({\n        name: \"Project Valkyrie\",\n        stage: \"Legal\",\n        value: 850,\n        client: \"Global Logistics\",\n        sector: \"Industrials\",\n        lead: \"Sarah Chen\",\n        progress: 85,\n        status: \"Active\",\n      }),\n      storage.createDeal({\n        name: \"Project Chimera\",\n        stage: \"Origination\",\n        value: 200,\n        client: \"BioLife Pharma\",\n        sector: \"Healthcare\",\n        lead: \"Emily Johnson\",\n        progress: 15,\n        status: \"Active\",\n      }),\n      storage.createDeal({\n        name: \"Project Hydra\",\n        stage: \"Close\",\n        value: 1200,\n        client: \"Mega Retail\",\n        sector: \"Consumer\",\n        lead: \"Joshua Orlinsky\",\n        progress: 95,\n        status: \"Active\",\n      }),\n    ]);\n\n    console.log(`Created ${deals.length} deals`);\n\n    // Create tasks\n    const tasks = await Promise.all([\n      storage.createTask({\n        title: \"Negotiate Term Sheet\",\n        dealId: deals[0].id,\n        assignedTo: users[3].id,\n        priority: \"High\",\n        dueDate: \"2025-12-02\",\n        status: \"In Progress\",\n        type: \"Meeting\",\n      }),\n      storage.createTask({\n        title: \"Financial Model Review\",\n        dealId: deals[1].id,\n        assignedTo: users[4].id,\n        priority: \"High\",\n        dueDate: \"2025-12-03\",\n        status: \"Pending\",\n        type: \"Analysis\",\n      }),\n      storage.createTask({\n        title: \"Prepare Board Deck\",\n        dealId: deals[2].id,\n        assignedTo: users[1].id,\n        priority: \"Medium\",\n        dueDate: \"2025-12-05\",\n        status: \"Pending\",\n        type: \"Document\",\n      }),\n      storage.createTask({\n        title: \"Legal Due Diligence Call\",\n        dealId: deals[2].id,\n        assignedTo: users[3].id,\n        priority: \"High\",\n        dueDate: \"2025-12-01\",\n        status: \"Completed\",\n        type: \"Meeting\",\n      }),\n      storage.createTask({\n        title: \"Market Research Report\",\n        dealId: deals[3].id,\n        assignedTo: users[4].id,\n        priority: \"Low\",\n        dueDate: \"2025-12-10\",\n        status: \"In Progress\",\n        type: \"Analysis\",\n      }),\n      storage.createTask({\n        title: \"Sign Purchase Agreement\",\n        dealId: deals[4].id,\n        assignedTo: users[0].id,\n        priority: \"High\",\n        dueDate: \"2025-12-01\",\n        status: \"Pending\",\n        type: \"Document\",\n      }),\n    ]);\n\n    console.log(`Created ${tasks.length} tasks`);\n\n    // Create document templates\n    const documentTemplates = await Promise.all([\n      storage.createDocumentTemplate({\n        name: \"Term Sheet\",\n        description: \"Standard term sheet template for initial deal terms\",\n        category: \"Legal\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Letter of Intent\",\n        description: \"LOI template for preliminary offers and expressions of interest\",\n        category: \"Legal\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Due Diligence Request\",\n        description: \"Comprehensive information request checklist\",\n        category: \"Analysis\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Purchase Agreement\",\n        description: \"Legal document for acquisition transactions\",\n        category: \"Legal\",\n        complexity: \"High\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"NDA\",\n        description: \"Non-disclosure agreement for confidential information\",\n        category: \"Legal\",\n        complexity: \"Low\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Board Resolution\",\n        description: \"Corporate governance and approval template\",\n        category: \"Governance\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"M&A Deal Template\",\n        description: \"Complete template for mergers and acquisitions including due diligence, valuation, and integration planning\",\n        category: \"Deal\",\n        complexity: \"High\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"IPO Roadshow Template\",\n        description: \"Investor presentation and roadshow materials for initial public offerings\",\n        category: \"Deal\",\n        complexity: \"High\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Private Placement Memo\",\n        description: \"Confidential information memorandum for private capital raising\",\n        category: \"Deal\",\n        complexity: \"High\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Debt Financing Template\",\n        description: \"Credit facility and bond issuance documentation templates\",\n        category: \"Deal\",\n        complexity: \"High\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Valuation Report\",\n        description: \"Comprehensive business valuation report template with DCF and comps analysis\",\n        category: \"Analysis\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n      storage.createDocumentTemplate({\n        name: \"Investment Committee Memo\",\n        description: \"Presentation format for investment committee approval\",\n        category: \"Governance\",\n        complexity: \"Medium\",\n        isDefault: true,\n      }),\n    ]);\n\n    console.log(`Created ${documentTemplates.length} document templates`);\n    console.log(\"Database seeded successfully!\");\n    process.exit(0);\n  } catch (error) {\n    console.error(\"Error seeding database:\", error);\n    process.exit(1);\n  }\n}\n\nseed();\n","path":null,"size_bytes":7806,"size_tokens":null},"vite-plugin-meta-images.ts":{"content":"import type { Plugin } from 'vite';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * Vite plugin that updates og:image and twitter:image meta tags\n * to point to the app's opengraph image with the correct Replit domain.\n */\nexport function metaImagesPlugin(): Plugin {\n  return {\n    name: 'vite-plugin-meta-images',\n    transformIndexHtml(html) {\n      const baseUrl = getDeploymentUrl();\n      if (!baseUrl) {\n        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');\n        return html;\n      }\n\n      // Check if opengraph image exists in public directory\n      const publicDir = path.resolve(process.cwd(), 'client', 'public');\n      const opengraphPngPath = path.join(publicDir, 'opengraph.png');\n      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');\n      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');\n\n      let imageExt: string | null = null;\n      if (fs.existsSync(opengraphPngPath)) {\n        imageExt = 'png';\n      } else if (fs.existsSync(opengraphJpgPath)) {\n        imageExt = 'jpg';\n      } else if (fs.existsSync(opengraphJpegPath)) {\n        imageExt = 'jpeg';\n      }\n\n      if (!imageExt) {\n        log('[meta-images] OpenGraph image not found, skipping meta tag updates');\n        return html;\n      }\n\n      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;\n\n      log('[meta-images] updating meta image tags to:', imageUrl);\n\n      html = html.replace(\n        /<meta\\s+property=\"og:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta property=\"og:image\" content=\"${imageUrl}\" />`\n      );\n\n      html = html.replace(\n        /<meta\\s+name=\"twitter:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta name=\"twitter:image\" content=\"${imageUrl}\" />`\n      );\n\n      return html;\n    },\n  };\n}\n\nfunction getDeploymentUrl(): string | null {\n  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {\n    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;\n    log('[meta-images] using internal app domain:', url);\n    return url;\n  }\n\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;\n    log('[meta-images] using dev domain:', url);\n    return url;\n  }\n\n  return null;\n}\n\nfunction log(...args: any[]): void {\n  if (process.env.NODE_ENV === 'production') {\n    console.log(...args);\n  }\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3007,"size_tokens":null},"client/src/components/ui/input-group.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nfunction InputGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"input-group\"\n      role=\"group\"\n      className={cn(\n        \"group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]\",\n        \"h-9 has-[>textarea]:h-auto\",\n\n        // Variants based on alignment.\n        \"has-[>[data-align=inline-start]]:[&>input]:pl-2\",\n        \"has-[>[data-align=inline-end]]:[&>input]:pr-2\",\n        \"has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3\",\n        \"has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3\",\n\n        // Focus state.\n        \"has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1\",\n\n        // Error state.\n        \"has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40\",\n\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupAddonVariants = cva(\n  \"text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4\",\n  {\n    variants: {\n      align: {\n        \"inline-start\":\n          \"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]\",\n        \"inline-end\":\n          \"order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]\",\n        \"block-start\":\n          \"[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5\",\n        \"block-end\":\n          \"[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5\",\n      },\n    },\n    defaultVariants: {\n      align: \"inline-start\",\n    },\n  }\n)\n\nfunction InputGroupAddon({\n  className,\n  align = \"inline-start\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof inputGroupAddonVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"input-group-addon\"\n      data-align={align}\n      className={cn(inputGroupAddonVariants({ align }), className)}\n      onClick={(e) => {\n        if ((e.target as HTMLElement).closest(\"button\")) {\n          return\n        }\n        e.currentTarget.parentElement?.querySelector(\"input\")?.focus()\n      }}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupButtonVariants = cva(\n  \"flex items-center gap-2 text-sm shadow-none\",\n  {\n    variants: {\n      size: {\n        xs: \"h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5\",\n        sm: \"h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5\",\n        \"icon-xs\":\n          \"size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0\",\n        \"icon-sm\": \"size-8 p-0 has-[>svg]:p-0\",\n      },\n    },\n    defaultVariants: {\n      size: \"xs\",\n    },\n  }\n)\n\nfunction InputGroupButton({\n  className,\n  type = \"button\",\n  variant = \"ghost\",\n  size = \"xs\",\n  ...props\n}: Omit<React.ComponentProps<typeof Button>, \"size\"> &\n  VariantProps<typeof inputGroupButtonVariants>) {\n  return (\n    <Button\n      type={type}\n      data-size={size}\n      variant={variant}\n      className={cn(inputGroupButtonVariants({ size }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupText({ className, ...props }: React.ComponentProps<\"span\">) {\n  return (\n    <span\n      className={cn(\n        \"text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupInput({\n  className,\n  ...props\n}: React.ComponentProps<\"input\">) {\n  return (\n    <Input\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupTextarea({\n  className,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  return (\n    <Textarea\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupText,\n  InputGroupInput,\n  InputGroupTextarea,\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1037,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"import * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3835,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border bg-card text-card-foreground shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1828,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/pages/auth/AuthPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { useLogin, useSignup } from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Mail, CheckCircle, Shield, Clock } from \"lucide-react\";\nimport logo from \"@assets/generated_images/abstract_minimalist_layer_icon_for_fintech_logo.png\";\nimport { InputOTP, InputOTPGroup, InputOTPSlot } from \"@/components/ui/input-otp\";\n\nconst loginSchema = z.object({\n  email: z.string().email({ message: \"Invalid email address\" }),\n  password: z.string().min(6, { message: \"Password must be at least 6 characters\" }),\n  rememberMe: z.boolean().default(false),\n});\n\nconst JOB_TITLE_OPTIONS = [\n  \"Junior Analyst\",\n  \"Analyst\", \n  \"Associate\",\n  \"Senior Associate\",\n  \"VP\",\n  \"Other\"\n] as const;\n\nconst signupSchema = z.object({\n  name: z.string().min(2, { message: \"Name is required\" }),\n  email: z.string().email({ message: \"Invalid email address\" }),\n  password: z.string().min(6, { message: \"Password must be at least 6 characters\" }),\n  confirmPassword: z.string().min(6, { message: \"Password must be at least 6 characters\" }),\n  jobTitle: z.string().min(1, { message: \"Please select your job title\" }),\n}).refine((data) => data.password === data.confirmPassword, {\n  message: \"Passwords do not match\",\n  path: [\"confirmPassword\"],\n});\n\nexport default function AuthPage() {\n  const [, setLocation] = useLocation();\n  const [activeTab, setActiveTab] = useState(\"login\");\n  const [showWelcome, setShowWelcome] = useState(false);\n  const [welcomeName, setWelcomeName] = useState(\"\");\n  const [redirectPath, setRedirectPath] = useState(\"\");\n  const [showForgotPassword, setShowForgotPassword] = useState(false);\n  const [forgotPasswordEmail, setForgotPasswordEmail] = useState(\"\");\n  const [forgotPasswordLoading, setForgotPasswordLoading] = useState(false);\n  const [forgotPasswordSent, setForgotPasswordSent] = useState(false);\n  const [showTwoFactor, setShowTwoFactor] = useState(false);\n  const [twoFactorEmail, setTwoFactorEmail] = useState(\"\");\n  const [twoFactorCode, setTwoFactorCode] = useState(\"\");\n  const [twoFactorLoading, setTwoFactorLoading] = useState(false);\n  const [showPendingApproval, setShowPendingApproval] = useState(false);\n  const loginMutation = useLogin();\n  const signupMutation = useSignup();\n\n  const handleForgotPassword = async () => {\n    if (!forgotPasswordEmail || !forgotPasswordEmail.includes('@')) {\n      toast.error(\"Please enter a valid email address\");\n      return;\n    }\n    \n    setForgotPasswordLoading(true);\n    try {\n      const response = await fetch('/api/auth/forgot-password', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ email: forgotPasswordEmail }),\n      });\n      \n      const data = await response.json();\n      \n      if (response.ok) {\n        setForgotPasswordSent(true);\n      } else {\n        toast.error(data.error || \"Failed to send reset email\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to send reset email. Please try again.\");\n    } finally {\n      setForgotPasswordLoading(false);\n    }\n  };\n\n  const closeForgotPasswordDialog = () => {\n    setShowForgotPassword(false);\n    setForgotPasswordEmail(\"\");\n    setForgotPasswordSent(false);\n  };\n\n  const handleTwoFactorVerify = async () => {\n    if (twoFactorCode.length !== 6) {\n      toast.error(\"Please enter a 6-digit code\");\n      return;\n    }\n    \n    setTwoFactorLoading(true);\n    try {\n      const response = await fetch('/api/auth/2fa/login-verify', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ email: twoFactorEmail, code: twoFactorCode }),\n      });\n      \n      const data = await response.json();\n      \n      if (response.ok && data.id) {\n        const firstName = data.name?.split(' ')[0] || twoFactorEmail.split('@')[0];\n        setWelcomeName(firstName);\n        \n        if (data.accessLevel === 'admin') {\n          setRedirectPath(\"/ceo/dashboard\");\n        } else {\n          setRedirectPath(\"/employee/home\");\n        }\n        \n        sessionStorage.setItem('welcomePending', 'true');\n        setShowTwoFactor(false);\n        setShowWelcome(true);\n      } else {\n        toast.error(data.error || \"Invalid verification code\");\n        setTwoFactorCode(\"\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to verify code. Please try again.\");\n      setTwoFactorCode(\"\");\n    } finally {\n      setTwoFactorLoading(false);\n    }\n  };\n\n  const loginForm = useForm<z.infer<typeof loginSchema>>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n      rememberMe: false,\n    },\n  });\n\n  const signupForm = useForm<z.infer<typeof signupSchema>>({\n    resolver: zodResolver(signupSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      jobTitle: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (showWelcome && redirectPath) {\n      const timer = setTimeout(() => {\n        sessionStorage.removeItem('welcomePending');\n        setLocation(redirectPath);\n      }, 3500);\n      return () => clearTimeout(timer);\n    }\n  }, [showWelcome, redirectPath, setLocation]);\n\n  async function onLoginSubmit(values: z.infer<typeof loginSchema>) {\n    try {\n      const user = await loginMutation.mutateAsync({\n        email: values.email,\n        password: values.password,\n        rememberMe: values.rememberMe,\n      });\n      \n      if (user?.requiresTwoFactor) {\n        setTwoFactorEmail(user.email);\n        setShowTwoFactor(true);\n        return;\n      }\n      \n      const firstName = user?.name?.split(' ')[0] || values.email.split('@')[0];\n      setWelcomeName(firstName);\n      \n      if (user?.accessLevel === 'admin') {\n        setRedirectPath(\"/ceo/dashboard\");\n      } else {\n        setRedirectPath(\"/employee/home\");\n      }\n      \n      sessionStorage.setItem('welcomePending', 'true');\n      setShowWelcome(true);\n    } catch (error: any) {\n      toast.error(error.message || \"Login failed\");\n    }\n  }\n\n  async function onSignupSubmit(values: z.infer<typeof signupSchema>) {\n    try {\n      const { confirmPassword, ...signupData } = values;\n      const result = await signupMutation.mutateAsync(signupData);\n      \n      if (result?.pending) {\n        setShowPendingApproval(true);\n        return;\n      }\n      \n      const firstName = values.name.split(' ')[0];\n      setWelcomeName(firstName);\n      \n      // Redirect new users to personality questionnaire first\n      if (result?.accessLevel === 'admin') {\n        setRedirectPath(\"/ceo/profile-questionnaire\");\n      } else {\n        setRedirectPath(\"/employee/profile-questionnaire\");\n      }\n      \n      sessionStorage.setItem('welcomePending', 'true');\n      setShowWelcome(true);\n    } catch (error: any) {\n      toast.error(error.message || \"Signup failed\");\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background relative overflow-hidden\">\n      <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-primary/20 via-background to-background pointer-events-none\"></div>\n      <div className=\"absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none opacity-20\"></div>\n      \n      <AnimatePresence>\n        {showWelcome && (\n          <motion.div \n            className=\"fixed inset-0 z-50 flex flex-col items-center justify-center bg-background\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 0.3 }}\n          >\n            <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-primary/30 via-background to-background pointer-events-none\"></div>\n            \n            <motion.div\n              initial={{ scale: 0.5, opacity: 0 }}\n              animate={{ scale: 1, opacity: 1 }}\n              transition={{ \n                type: \"spring\",\n                stiffness: 200,\n                damping: 20,\n                delay: 0.1\n              }}\n              className=\"relative z-10\"\n            >\n              <motion.div \n                className=\"w-24 h-24 rounded-2xl bg-primary/20 flex items-center justify-center p-4 shadow-2xl shadow-primary/30 ring-2 ring-white/10\"\n                animate={{ \n                  boxShadow: [\n                    \"0 0 0 0 rgba(59, 130, 246, 0.4)\",\n                    \"0 0 0 20px rgba(59, 130, 246, 0)\",\n                    \"0 0 0 0 rgba(59, 130, 246, 0)\"\n                  ]\n                }}\n                transition={{ \n                  duration: 2,\n                  repeat: Infinity,\n                  repeatDelay: 0.5\n                }}\n              >\n                <motion.img \n                  src={logo} \n                  alt=\"Logo\" \n                  className=\"w-full h-full object-contain\"\n                  animate={{ rotate: 360 }}\n                  transition={{ duration: 2, ease: \"easeInOut\" }}\n                />\n              </motion.div>\n            </motion.div>\n            \n            <motion.div\n              initial={{ y: 20, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              transition={{ delay: 0.4, duration: 0.5 }}\n              className=\"mt-8 text-center relative z-10\"\n            >\n              <motion.h1 \n                className=\"text-3xl font-display font-bold tracking-tight\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.5 }}\n              >\n                Welcome back, {welcomeName}!\n              </motion.h1>\n              <motion.p \n                className=\"text-muted-foreground mt-2\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.7 }}\n              >\n                Preparing your dashboard...\n              </motion.p>\n            </motion.div>\n            \n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 1 }}\n              className=\"mt-8 relative z-10\"\n            >\n              <div className=\"flex gap-1\">\n                {[0, 1, 2].map((i) => (\n                  <motion.div\n                    key={i}\n                    className=\"w-2 h-2 rounded-full bg-primary\"\n                    animate={{ \n                      y: [0, -8, 0],\n                      opacity: [0.5, 1, 0.5]\n                    }}\n                    transition={{\n                      duration: 0.6,\n                      repeat: Infinity,\n                      delay: i * 0.15\n                    }}\n                  />\n                ))}\n              </div>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n      \n      <Card className=\"w-full max-w-md border-border bg-card/50 backdrop-blur-xl shadow-2xl relative z-10\">\n        <CardHeader className=\"space-y-4 text-center pb-6\">\n          <div className=\"flex justify-center mb-2\">\n            <div className=\"w-16 h-16 rounded-xl bg-primary/20 flex items-center justify-center p-3 shadow-inner shadow-primary/10 ring-1 ring-white/10\">\n              <img src={logo} alt=\"Logo\" className=\"w-full h-full object-contain\" />\n            </div>\n          </div>\n          <div>\n            <CardTitle className=\"text-2xl font-display font-bold tracking-tight\">Kronos</CardTitle>\n            <CardDescription className=\"text-muted-foreground mt-2\">\n              Enterprise Investment Banking Platform\n            </CardDescription>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"login\" value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-2 mb-6\">\n              <TabsTrigger value=\"login\">Sign In</TabsTrigger>\n              <TabsTrigger value=\"signup\">Sign Up</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"login\">\n              <Form {...loginForm}>\n                <form onSubmit={loginForm.handleSubmit(onLoginSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={loginForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email Address</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"name@equiturn.com\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\" \n                            data-testid=\"input-email\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={loginForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <div className=\"flex items-center justify-between\">\n                            <FormLabel>Password</FormLabel>\n                            <Button \n                              variant=\"link\" \n                              className=\"p-0 h-auto text-xs text-primary hover:underline\" \n                              type=\"button\"\n                              onClick={() => setShowForgotPassword(true)}\n                              data-testid=\"button-forgot-password\"\n                            >\n                              Forgot password?\n                            </Button>\n                        </div>\n                        <FormControl>\n                          <Input \n                            type=\"password\" \n                            placeholder=\"\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\"\n                            data-testid=\"input-password\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  \n                  <FormField\n                    control={loginForm.control}\n                    name=\"rememberMe\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-start space-x-3 space-y-0 rounded-md p-4 border border-border/50 bg-secondary/20\">\n                        <FormControl>\n                          <Checkbox\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                          />\n                        </FormControl>\n                        <div className=\"space-y-1 leading-none\">\n                          <FormLabel>\n                            Stay connected\n                          </FormLabel>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n                  \n                  <Button \n                    type=\"submit\" \n                    className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 font-semibold h-11 shadow-lg shadow-primary/20 mt-2\" \n                    disabled={loginMutation.isPending}\n                    data-testid=\"button-login\"\n                  >\n                    {loginMutation.isPending ? \"Authenticating...\" : \"Sign In\"}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n\n            <TabsContent value=\"signup\">\n              <Form {...signupForm}>\n                <form onSubmit={signupForm.handleSubmit(onSignupSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={signupForm.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Full Name</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"John Doe\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\" \n                            data-testid=\"input-fullname\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={signupForm.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email Address</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"name@equiturn.com\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\" \n                            data-testid=\"input-email-signup\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={signupForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Password</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"password\" \n                            placeholder=\"\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\"\n                            data-testid=\"input-password-signup\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={signupForm.control}\n                    name=\"confirmPassword\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Confirm Password</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"password\" \n                            placeholder=\"\" \n                            {...field} \n                            className=\"bg-secondary/50 border-border focus:ring-primary/50\"\n                            data-testid=\"input-confirm-password\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={signupForm.control}\n                    name=\"jobTitle\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Job Title</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger \n                              className=\"bg-secondary/50 border-border focus:ring-primary/50\"\n                              data-testid=\"select-job-title\"\n                            >\n                              <SelectValue placeholder=\"Select your role\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {JOB_TITLE_OPTIONS.map((title) => (\n                              <SelectItem \n                                key={title} \n                                value={title}\n                                data-testid={`option-job-title-${title.toLowerCase().replace(/\\s+/g, '-')}`}\n                              >\n                                {title}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  \n                  <Button \n                    type=\"submit\" \n                    className=\"w-full bg-primary text-primary-foreground hover:bg-primary/90 font-semibold h-11 shadow-lg shadow-primary/20 mt-2\" \n                    disabled={signupMutation.isPending}\n                    data-testid=\"button-signup\"\n                  >\n                    {signupMutation.isPending ? \"Creating Account...\" : \"Create Account\"}\n                  </Button>\n                </form>\n              </Form>\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n        <CardFooter className=\"flex flex-col items-center justify-center space-y-2 pt-4 pb-8 border-t border-border/50\">\n           <div className=\"flex gap-4 text-[10px] text-muted-foreground/50 uppercase tracking-widest mt-4\">\n             <span>Secure</span>\n             <span></span>\n             <span>Compliant</span>\n             <span></span>\n             <span>Enterprise-Grade</span>\n           </div>\n        </CardFooter>\n      </Card>\n\n      <Dialog open={showForgotPassword} onOpenChange={closeForgotPasswordDialog}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              {forgotPasswordSent ? (\n                <>\n                  <CheckCircle className=\"w-5 h-5 text-green-500\" />\n                  Check Your Email\n                </>\n              ) : (\n                <>\n                  <Mail className=\"w-5 h-5\" />\n                  Reset Password\n                </>\n              )}\n            </DialogTitle>\n            <DialogDescription>\n              {forgotPasswordSent \n                ? \"If an account exists with this email, you will receive a password reset link shortly.\"\n                : \"Enter your email address and we'll send you a link to reset your password.\"\n              }\n            </DialogDescription>\n          </DialogHeader>\n          \n          {!forgotPasswordSent ? (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <label htmlFor=\"forgot-email\" className=\"text-sm font-medium\">\n                  Email Address\n                </label>\n                <Input\n                  id=\"forgot-email\"\n                  type=\"email\"\n                  placeholder=\"name@equiturn.com\"\n                  value={forgotPasswordEmail}\n                  onChange={(e) => setForgotPasswordEmail(e.target.value)}\n                  className=\"bg-secondary/50 border-border\"\n                  data-testid=\"input-forgot-email\"\n                />\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\" \n                  onClick={closeForgotPasswordDialog}\n                  data-testid=\"button-cancel-forgot\"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  onClick={handleForgotPassword}\n                  disabled={forgotPasswordLoading}\n                  data-testid=\"button-send-reset\"\n                >\n                  {forgotPasswordLoading ? \"Sending...\" : \"Send Reset Link\"}\n                </Button>\n              </div>\n            </div>\n          ) : (\n            <div className=\"py-4\">\n              <Button \n                className=\"w-full\" \n                onClick={closeForgotPasswordDialog}\n                data-testid=\"button-close-forgot\"\n              >\n                Back to Login\n              </Button>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showTwoFactor} onOpenChange={(open) => !open && setShowTwoFactor(false)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Shield className=\"w-5 h-5 text-primary\" />\n              Two-Factor Authentication\n            </DialogTitle>\n            <DialogDescription>\n              Enter the 6-digit code from your authenticator app to continue.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-6 py-4\">\n            <div className=\"flex justify-center\">\n              <InputOTP \n                maxLength={6} \n                value={twoFactorCode} \n                onChange={setTwoFactorCode}\n                data-testid=\"input-2fa-code\"\n              >\n                <InputOTPGroup>\n                  <InputOTPSlot index={0} />\n                  <InputOTPSlot index={1} />\n                  <InputOTPSlot index={2} />\n                  <InputOTPSlot index={3} />\n                  <InputOTPSlot index={4} />\n                  <InputOTPSlot index={5} />\n                </InputOTPGroup>\n              </InputOTP>\n            </div>\n            \n            <div className=\"flex gap-2 justify-end\">\n              <Button \n                variant=\"outline\" \n                onClick={() => {\n                  setShowTwoFactor(false);\n                  setTwoFactorCode(\"\");\n                }}\n                data-testid=\"button-cancel-2fa\"\n              >\n                Cancel\n              </Button>\n              <Button \n                onClick={handleTwoFactorVerify}\n                disabled={twoFactorLoading || twoFactorCode.length !== 6}\n                data-testid=\"button-verify-2fa\"\n              >\n                {twoFactorLoading ? \"Verifying...\" : \"Verify\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showPendingApproval} onOpenChange={setShowPendingApproval}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Clock className=\"w-5 h-5 text-amber-500\" />\n              Account Pending Approval\n            </DialogTitle>\n            <DialogDescription>\n              Your account has been created successfully!\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"py-4 space-y-4\">\n            <div className=\"bg-amber-500/10 border border-amber-500/20 rounded-lg p-4\">\n              <p className=\"text-sm text-muted-foreground\">\n                Your account is pending approval from an administrator. You'll be able to sign in once your access has been approved.\n              </p>\n            </div>\n            \n            <Button \n              className=\"w-full\" \n              onClick={() => {\n                setShowPendingApproval(false);\n                setActiveTab(\"login\");\n                signupForm.reset();\n              }}\n              data-testid=\"button-back-to-login\"\n            >\n              Back to Login\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":28418,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport session from \"express-session\";\nimport connectPgSimple from \"connect-pg-simple\";\nimport bcrypt from \"bcryptjs\";\nimport { insertUserSchema, insertDealSchema, insertTaskSchema, insertMeetingSchema, insertNotificationSchema, insertAssistantConversationSchema, insertAssistantMessageSchema, insertTimeEntrySchema, insertTimeOffRequestSchema, insertAuditLogSchema, insertInvestorSchema, insertInvestorInteractionSchema, insertOkrSchema, insertStakeholderSchema, insertAnnouncementSchema, insertPollSchema, insertMentorshipPairingSchema, insertClientPortalAccessSchema, insertDocumentTemplateSchema, insertInvestorMatchSchema, insertUserPreferencesSchema, insertDealTemplateSchema, insertCalendarEventSchema, insertTaskAttachmentRecordSchema } from \"@shared/schema\";\nimport { fromError } from \"zod-validation-error\";\nimport { sendMeetingInvite, sendPasswordResetEmail, sendUserInviteEmail, sendExternalWorkEmail, sendFormInvitationEmail } from \"./email\";\nimport { validateBody, loginSchema, signupSchema, forgotPasswordSchema, resetPasswordSchema } from \"./validation\";\nimport { generalLimiter, authLimiter, strictLimiter, uploadLimiter, aiLimiter, preferencesLimiter } from \"./rateLimiter\";\nimport OpenAI from \"openai\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport * as crypto from \"crypto\";\nimport multer from \"multer\";\nimport * as XLSX from \"xlsx\";\nimport { ObjectStorageService, ObjectNotFoundError } from \"./objectStorage\";\nimport { PDFParse } from \"pdf-parse\";\nimport { approveOpportunityToDeal, transitionDealStage, formPodForDeal } from \"./aiPodFormation\";\n\n// PostgreSQL session store\nconst PgSession = connectPgSimple(session);\n\n// Always prefer PRODUCTION_DATABASE_URL if set, otherwise use DATABASE_URL\n// This ensures both dev and production use the same database when PRODUCTION_DATABASE_URL is configured\nconst databaseUrl = process.env.PRODUCTION_DATABASE_URL || process.env.DATABASE_URL!;\n\n// Initialize OpenAI client with Replit AI Integrations\n// the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  // Trust proxy for rate limiting behind reverse proxy (Replit)\n  app.set('trust proxy', 1);\n  \n  // Session configuration with PostgreSQL store\n  // By default, sessions expire when browser closes (no maxAge)\n  // Only persist sessions when user checks \"Stay connected\"\n  const sessionSecret = process.env.SESSION_SECRET;\n  if (!sessionSecret && process.env.NODE_ENV === \"production\") {\n    console.error(\"[SECURITY WARNING] SESSION_SECRET is not set! Using insecure fallback. Set SESSION_SECRET environment variable.\");\n  }\n  \n  app.use(\n    session({\n      store: new PgSession({\n        conString: databaseUrl,\n        tableName: 'sessions',\n        createTableIfMissing: true,\n      }),\n      secret: sessionSecret || \"kronos-dev-secret-change-in-production\",\n      name: 'kronos.sid', // Custom session cookie name (don't reveal tech stack)\n      resave: false,\n      saveUninitialized: false,\n      cookie: {\n        secure: process.env.NODE_ENV === \"production\",\n        httpOnly: true,\n        sameSite: 'strict', // Stricter CSRF protection\n        maxAge: 24 * 60 * 60 * 1000, // 24 hours max session lifetime\n        // No maxAge set by default = session cookie that expires on browser close\n      },\n    })\n  );\n\n  // Passport configuration\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  passport.use(\n    new LocalStrategy(\n      { usernameField: \"email\" },\n      async (email, password, done) => {\n        try {\n          const user = await storage.getUserByEmail(email);\n          if (!user) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n\n          const isValidPassword = await bcrypt.compare(password, user.password);\n          if (!isValidPassword) {\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n\n          // Check user status - only active users can log in\n          if (user.status === 'pending') {\n            return done(null, false, { message: \"Your account is pending approval. Please wait for an administrator to approve your access.\" });\n          }\n          if (user.status === 'suspended') {\n            return done(null, false, { message: \"Your account has been suspended. Please contact an administrator.\" });\n          }\n          if (user.status === 'rejected') {\n            return done(null, false, { message: \"Your registration request was not approved. Please contact an administrator for more information.\" });\n          }\n          if (user.status !== 'active') {\n            return done(null, false, { message: \"Your account is not active. Please contact an administrator.\" });\n          }\n\n          return done(null, user);\n        } catch (error) {\n          return done(error);\n        }\n      }\n    )\n  );\n\n  passport.serializeUser((user: any, done) => {\n    done(null, user.id);\n  });\n\n  passport.deserializeUser(async (id: string, done) => {\n    try {\n      const user = await storage.getUser(id);\n      if (!user) {\n        // User not found - session references a deleted user\n        console.warn(`[Auth] Session references non-existent user: ${id}`);\n        return done(null, false);\n      }\n      done(null, user);\n    } catch (error) {\n      // Log the error but don't crash - just invalidate the session\n      console.error(`[Auth] Error deserializing user ${id}:`, error);\n      done(null, false);\n    }\n  });\n\n  // Helper to sanitize user data (remove password)\n  const sanitizeUser = (user: any) => {\n    if (!user) return null;\n    const { password, ...userWithoutPassword } = user;\n    return userWithoutPassword;\n  };\n\n  // Simple health check - only returns basic status (no sensitive data)\n  app.get(\"/api/health\", (req, res) => {\n    res.json({ status: \"ok\", timestamp: new Date().toISOString() });\n  });\n\n  // Middleware to check authentication\n  const requireAuth = (req: any, res: any, next: any) => {\n    if (req.isAuthenticated()) {\n      return next();\n    }\n    res.status(401).json({ error: \"Unauthorized\" });\n  };\n\n  // Middleware to check admin access level\n  const requireCEO = (req: any, res: any, next: any) => {\n    if (req.isAuthenticated() && req.user?.accessLevel === 'admin') {\n      return next();\n    }\n    res.status(403).json({ error: \"Access denied. Admin access required.\" });\n  };\n  \n  // Middleware to block external users from internal routes\n  const requireInternal = (req: any, res: any, next: any) => {\n    if (req.isAuthenticated() && req.user?.role !== 'External') {\n      return next();\n    }\n    res.status(403).json({ error: \"Access denied. Internal users only.\" });\n  };\n\n  // ===== AUTH ROUTES =====\n  \n  // Helper to create audit log\n  const createAuditLog = async (req: any, action: string, entityType: string, entityId?: string, entityName?: string, details?: any) => {\n    try {\n      await storage.createAuditLogTableEntry({\n        userId: req.user?.id || null,\n        userName: req.user?.name || 'System',\n        action,\n        entityType,\n        entityId: entityId || null,\n        entityName: entityName || null,\n        details: details || {},\n        ipAddress: req.ip || req.headers['x-forwarded-for'] || null,\n        userAgent: req.headers['user-agent'] || null,\n      });\n    } catch (err) {\n      console.error('Failed to create audit log:', err);\n    }\n  };\n\n  // Sign up\n  app.post(\"/api/auth/signup\", authLimiter, async (req, res) => {\n    try {\n      const result = insertUserSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n\n      const existingUser = await storage.getUserByEmail(result.data.email);\n      if (existingUser) {\n        return res.status(400).json({ error: \"Email already registered. Please sign in instead.\" });\n      }\n\n      // Check if this is the first user (make them CEO and active)\n      const allUsers = await storage.getAllUsers();\n      const isFirstUser = allUsers.length === 0;\n      \n      // SECURITY: Non-first users are always assigned 'Associate' role\n      // Only CEOs can grant elevated roles after approval via admin routes\n      const userData = {\n        ...result.data,\n        status: isFirstUser ? 'active' : 'pending',\n        role: isFirstUser ? 'CEO' : 'Associate', // Always Associate for non-first users\n      };\n\n      const user = await storage.createUser(userData);\n      \n      // Create audit log for signup\n      await createAuditLog(req, 'user_signup', 'user', user.id, user.name, { email: user.email, role: user.role, status: user.status, jobTitle: user.jobTitle });\n      \n      // Notify all admins about new signup request\n      if (!isFirstUser) {\n        const ceos = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active');\n        for (const ceo of ceos) {\n          await storage.createNotification({\n            userId: ceo.id,\n            title: 'New Signup Request',\n            message: `${user.name} (${user.jobTitle || 'No title'}) has requested access to the platform`,\n            type: 'info',\n            link: '/ceo/admin',\n          });\n        }\n      }\n      \n      // If first user (CEO), auto-login\n      if (isFirstUser) {\n        req.login(user, (err) => {\n          if (err) {\n            return res.status(500).json({ error: \"Error logging in after signup\" });\n          }\n          res.json(sanitizeUser(user));\n        });\n      } else {\n        // For other users, return success but don't login\n        res.json({ \n          success: true, \n          pending: true,\n          message: \"Your account has been created and is pending approval. You'll be notified when an administrator approves your access.\"\n        });\n      }\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create user\" });\n    }\n  });\n\n  // Login\n  app.post(\"/api/auth/login\", authLimiter, validateBody(loginSchema), (req, res, next) => {\n    const { rememberMe } = req.body;\n    \n    passport.authenticate(\"local\", async (err: any, user: any, info: any) => {\n      if (err) {\n        return res.status(500).json({ error: \"Authentication error\" });\n      }\n      if (!user) {\n        return res.status(401).json({ error: info?.message || \"Invalid credentials\" });\n      }\n      \n      // Check if 2FA is enabled for this user\n      if (user.twoFactorEnabled) {\n        // Store rememberMe preference for 2FA completion\n        (req.session as any).pendingRememberMe = rememberMe;\n        // Don't log in yet - return a flag indicating 2FA is required\n        return res.json({ \n          requiresTwoFactor: true, \n          email: user.email,\n          message: \"Please enter your two-factor authentication code\"\n        });\n      }\n      \n      req.login(user, async (loginErr) => {\n        if (loginErr) {\n          return res.status(500).json({ error: \"Login error\" });\n        }\n        \n        // Configure session cookie based on rememberMe\n        // If rememberMe is true, session persists for 7 days\n        // Otherwise, session expires when browser closes (session cookie)\n        if (rememberMe) {\n          req.session.cookie.maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days\n        } else {\n          // Explicitly set to session cookie (expires on browser close)\n          req.session.cookie.maxAge = null as any;\n          req.session.cookie.expires = false as any;\n        }\n        \n        await createAuditLog(req, 'login', 'user', user.id, user.name, { method: 'password' });\n        res.json(sanitizeUser(user));\n      });\n    })(req, res, next);\n  });\n\n  // Logout\n  app.post(\"/api/auth/logout\", async (req, res) => {\n    const user = req.user as any;\n    const userId = user?.id;\n    const userName = user?.name;\n    \n    req.logout((err) => {\n      if (err) {\n        return res.status(500).json({ error: \"Logout error\" });\n      }\n      \n      if (userId && userName) {\n        createAuditLog(req, 'logout', 'user', userId, userName, {}).catch(() => {});\n      }\n      \n      res.json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  // Forgot Password - Request Reset\n  app.post(\"/api/auth/forgot-password\", strictLimiter, validateBody(forgotPasswordSchema), async (req, res) => {\n    try {\n      const { email } = req.body;\n\n      const user = await storage.getUserByEmail(email);\n      \n      // Always return success to prevent email enumeration attacks\n      if (!user) {\n        return res.json({ message: \"If an account exists with this email, you will receive a password reset link.\" });\n      }\n\n      // Generate secure token\n      const token = crypto.randomBytes(32).toString('hex');\n      const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour from now\n\n      // Store the token\n      await storage.createPasswordResetToken(user.id, token, expiresAt);\n\n      // Generate reset link\n      const baseUrl = process.env.REPLIT_DEV_DOMAIN \n        ? `https://${process.env.REPLIT_DEV_DOMAIN}`\n        : process.env.REPLIT_DEPLOYMENT_URL || 'http://localhost:5000';\n      const resetLink = `${baseUrl}/reset-password?token=${token}`;\n\n      // Send the email\n      console.log('Attempting to send password reset email to:', user.email);\n      console.log('Reset link:', resetLink);\n      \n      const emailResult = await sendPasswordResetEmail({\n        email: user.email,\n        userName: user.name,\n        resetLink,\n      });\n\n      if (!emailResult.success) {\n        console.error('Failed to send password reset email:', emailResult.error);\n        console.error('Email config details - User:', user.email, 'Name:', user.name);\n      } else {\n        console.log('Password reset email sent successfully to:', user.email);\n      }\n\n      res.json({ message: \"If an account exists with this email, you will receive a password reset link.\" });\n    } catch (error) {\n      console.error('Forgot password error:', error);\n      res.status(500).json({ error: \"Failed to process password reset request\" });\n    }\n  });\n\n  // Reset Password - Verify Token and Update Password\n  app.post(\"/api/auth/reset-password\", strictLimiter, validateBody(resetPasswordSchema), async (req, res) => {\n    try {\n      const { token, newPassword } = req.body;\n\n      // Find valid token\n      const resetToken = await storage.getValidPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.status(400).json({ error: \"Invalid or expired reset token. Please request a new password reset.\" });\n      }\n\n      // Update the user's password\n      await storage.updateUserPassword(resetToken.userId, newPassword);\n\n      // Mark token as used\n      await storage.markPasswordResetTokenUsed(resetToken.id);\n      \n      // Get user and activate if pending (for invited users setting password for first time)\n      if (resetToken.userId) {\n        const user = await storage.getUser(resetToken.userId);\n        if (user) {\n          // If user is pending, activate them (invited user completing setup)\n          if (user.status === 'pending') {\n            await storage.updateUserStatus(user.id, 'active');\n            await createAuditLog(req, 'user_activated', 'user', user.id, user.name, { \n              method: 'invite_completion',\n              previousStatus: 'pending',\n              newStatus: 'active'\n            });\n          }\n          await createAuditLog(req, 'password_reset', 'user', user.id, user.name, { method: 'reset_token' });\n        }\n      }\n\n      res.json({ message: \"Password has been reset successfully. You can now log in with your new password.\" });\n    } catch (error) {\n      console.error('Reset password error:', error);\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n\n  // Verify Reset Token (for frontend validation)\n  app.get(\"/api/auth/verify-reset-token\", async (req, res) => {\n    try {\n      const token = req.query.token as string;\n      \n      if (!token) {\n        return res.status(400).json({ valid: false, error: \"Token is required\" });\n      }\n\n      const resetToken = await storage.getValidPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.status(400).json({ valid: false, error: \"Invalid or expired token\" });\n      }\n\n      res.json({ valid: true });\n    } catch (error) {\n      res.status(500).json({ valid: false, error: \"Failed to verify token\" });\n    }\n  });\n\n  // ===== FILE UPLOAD ROUTES =====\n  \n  // Ensure uploads directory exists\n  const uploadsDir = path.join(process.cwd(), \"uploads\");\n  if (!fs.existsSync(uploadsDir)) {\n    fs.mkdirSync(uploadsDir, { recursive: true });\n  }\n\n  // Configure multer for file uploads - use memory storage for base64 conversion\n  const memoryStorage = multer.memoryStorage();\n\n  const upload = multer({\n    storage: memoryStorage,\n    limits: {\n      fileSize: 500 * 1024 * 1024, // 500MB max file size\n    },\n    fileFilter: (_req, file, cb) => {\n      const allowedExtensions = [\n        // Documents\n        '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt', '.csv', '.rtf', '.odt', '.ods', '.odp',\n        // Images\n        '.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.bmp', '.tiff', '.ico', '.heic', '.heif',\n        // Videos\n        '.mp4', '.mov', '.avi', '.webm', '.mkv', '.wmv', '.flv', '.m4v', '.mpeg', '.mpg',\n        // Audio\n        '.mp3', '.wav', '.aac', '.flac', '.ogg', '.m4a', '.wma',\n        // Archives\n        '.zip', '.rar', '.7z', '.tar', '.gz',\n        // Other\n        '.json', '.xml', '.html', '.css', '.js', '.ts', '.md'\n      ];\n      const ext = path.extname(file.originalname).toLowerCase();\n      if (allowedExtensions.includes(ext)) {\n        cb(null, true);\n      } else {\n        cb(new Error(`File type ${ext} is not allowed. Supported: documents, images, videos, audio, and archives.`));\n      }\n    }\n  });\n\n  // Serve uploaded files statically (with path traversal protection)\n  app.use(\"/uploads\", (req, res, next) => {\n    const requestedPath = path.normalize(req.path).replace(/^(\\.\\.[\\/\\\\])+/, '');\n    const filePath = path.join(uploadsDir, requestedPath);\n    \n    // Ensure file is within uploads directory\n    if (!filePath.startsWith(uploadsDir)) {\n      return res.status(403).json({ error: \"Access denied\" });\n    }\n    \n    if (fs.existsSync(filePath)) {\n      res.sendFile(filePath);\n    } else {\n      res.status(404).json({ error: \"File not found\" });\n    }\n  });\n\n  // Upload file using multer - returns base64 data URL for persistent storage\n  app.post(\"/api/upload\", uploadLimiter, requireAuth, upload.single('file'), (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      // Convert buffer to base64 data URL for persistent database storage\n      const base64Content = req.file.buffer.toString('base64');\n      const dataUrl = `data:${req.file.mimetype};base64,${base64Content}`;\n      \n      res.json({\n        id: crypto.randomUUID(),\n        filename: req.file.originalname,\n        url: dataUrl, // Return base64 data URL instead of file path\n        content: dataUrl, // Also include as content for document storage\n        size: req.file.size,\n        type: req.file.mimetype,\n        uploadedAt: new Date().toISOString(),\n      });\n    } catch (error) {\n      console.error(\"File upload error:\", error);\n      res.status(500).json({ error: \"Failed to upload file\" });\n    }\n  });\n\n  // Delete file - now handles both filesystem and database-stored files\n  app.delete(\"/api/upload/:filename\", requireAuth, async (req, res) => {\n    try {\n      const requestedFilename = path.normalize(req.params.filename).replace(/^(\\.\\.[\\/\\\\])+/, '');\n      const filePath = path.join(uploadsDir, requestedFilename);\n      \n      // Ensure file is within uploads directory\n      if (!filePath.startsWith(uploadsDir)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Try to delete from filesystem (legacy files)\n      if (fs.existsSync(filePath)) {\n        fs.unlinkSync(filePath);\n      }\n      // Files stored as base64 in database are deleted when the document record is deleted\n      res.json({ message: \"File deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete file\" });\n    }\n  });\n\n  // ===== OBJECT STORAGE ROUTES (for large file uploads up to 500MB) =====\n  \n  // Get presigned upload URL for object storage\n  app.post(\"/api/objects/upload\", requireAuth, async (req, res) => {\n    try {\n      const objectStorageService = new ObjectStorageService();\n      const { filename } = req.body;\n      const result = await objectStorageService.getObjectEntityUploadURL(filename);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error getting upload URL:\", error);\n      res.status(500).json({ error: error.message || \"Failed to get upload URL\" });\n    }\n  });\n\n  // Confirm upload and set ACL policy\n  app.put(\"/api/objects/confirm\", requireAuth, async (req, res) => {\n    try {\n      const { objectPath, filename, size, type } = req.body;\n      const currentUser = req.user as any;\n      \n      if (!objectPath) {\n        return res.status(400).json({ error: \"objectPath is required\" });\n      }\n\n      const objectStorageService = new ObjectStorageService();\n      \n      // Set ACL policy - make files accessible to authenticated users\n      try {\n        await objectStorageService.trySetObjectEntityAclPolicy(objectPath, {\n          owner: currentUser.id,\n          visibility: \"public\", // Allow all authenticated users to view\n        });\n      } catch (aclError) {\n        console.error(\"Error setting ACL policy:\", aclError);\n        // Continue even if ACL fails - file was uploaded successfully\n      }\n\n      res.json({\n        success: true,\n        objectPath,\n        filename,\n        size,\n        type,\n      });\n    } catch (error: any) {\n      console.error(\"Error confirming upload:\", error);\n      res.status(500).json({ error: error.message || \"Failed to confirm upload\" });\n    }\n  });\n\n  // Serve object storage files\n  app.get(\"/objects/:objectPath(*)\", requireAuth, async (req, res) => {\n    try {\n      const objectStorageService = new ObjectStorageService();\n      const objectFile = await objectStorageService.getObjectEntityFile(req.path);\n      objectStorageService.downloadObject(objectFile, res);\n    } catch (error) {\n      console.error(\"Error serving object:\", error);\n      if (error instanceof ObjectNotFoundError) {\n        return res.status(404).json({ error: \"File not found\" });\n      }\n      res.status(500).json({ error: \"Failed to serve file\" });\n    }\n  });\n\n  // Send external work email\n  app.post(\"/api/send-external-work\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const { recipientEmail, recipientName, senderName, taskTitle, message, attachments } = req.body;\n      \n      if (!recipientEmail || !taskTitle) {\n        return res.status(400).json({ error: \"Recipient email and task title are required\" });\n      }\n      \n      const result = await sendExternalWorkEmail({\n        recipientEmail,\n        recipientName: recipientName || 'Recipient',\n        senderName: senderName || 'Team Member',\n        taskTitle,\n        message: message || '',\n        attachments: attachments || [],\n      });\n      \n      if (!result.success) {\n        return res.status(500).json({ error: result.error || \"Failed to send email\" });\n      }\n      \n      res.json({ success: true, message: \"Email sent successfully\" });\n    } catch (error) {\n      console.error('Error sending external work email:', error);\n      res.status(500).json({ error: \"Failed to send email\" });\n    }\n  });\n\n  // Get current user\n  app.get(\"/api/auth/me\", (req, res) => {\n    if (req.isAuthenticated()) {\n      res.json(sanitizeUser(req.user));\n    } else {\n      res.status(401).json({ error: \"Not authenticated\" });\n    }\n  });\n\n  // ===== USER ROUTES =====\n  \n  // Get all users (CEO only can see all, employees see limited view)\n  app.get(\"/api/users\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const users = await storage.getAllUsers();\n      const sanitizedUsers = users.map(user => sanitizeUser(user));\n      \n      // Admin can see all user details\n      if (currentUser.accessLevel === 'admin') {\n        res.json(sanitizedUsers);\n      } else {\n        // Employees see limited user info (for task assignment display)\n        const limitedUsers = sanitizedUsers.map((u: any) => ({\n          id: u.id,\n          name: u.name,\n          role: u.role,\n        }));\n        res.json(limitedUsers);\n      }\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n  \n  // Get onboarding status for all users (for checking assignment eligibility)\n  // IMPORTANT: This must be defined BEFORE /api/users/:id to avoid route conflict\n  app.get(\"/api/users/onboarding-status\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      const onboardingStatus: Record<string, { hasResume: boolean; hasPersonality: boolean; isComplete: boolean }> = {};\n      \n      for (const user of users) {\n        const resumeAnalysis = await storage.getResumeAnalysis(user.id);\n        const personalityAssessment = await storage.getPersonalityAssessment(user.id);\n        \n        const hasResume = !!(resumeAnalysis && resumeAnalysis.status === 'completed');\n        const hasPersonality = !!(personalityAssessment && personalityAssessment.status === 'completed');\n        \n        onboardingStatus[user.id] = {\n          hasResume,\n          hasPersonality,\n          isComplete: hasResume && hasPersonality,\n        };\n      }\n      \n      res.json(onboardingStatus);\n    } catch (error) {\n      console.error('Error fetching onboarding status:', error);\n      res.status(500).json({ error: \"Failed to fetch onboarding status\" });\n    }\n  });\n\n  app.get(\"/api/users/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      // Admin can see anyone, others can only see themselves\n      if (currentUser.accessLevel !== 'admin' && currentUser.id !== req.params.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      res.json(sanitizeUser(user));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch user\" });\n    }\n  });\n\n  // Get all personality assessments (admin only) - for Team Profiles page\n  app.get(\"/api/admin/personality-assessments\", requireCEO, async (req, res) => {\n    try {\n      const assessments = await storage.getAllPersonalityAssessments();\n      res.json(assessments);\n    } catch (error) {\n      console.error('Error fetching all personality assessments:', error);\n      res.status(500).json({ error: \"Failed to fetch personality assessments\" });\n    }\n  });\n\n  // Get all resume analyses (admin only) - for Team Profiles page\n  app.get(\"/api/admin/resume-analyses\", requireCEO, async (req, res) => {\n    try {\n      const analyses = await storage.getAllResumeAnalyses();\n      res.json(analyses);\n    } catch (error) {\n      console.error('Error fetching all resume analyses:', error);\n      res.status(500).json({ error: \"Failed to fetch resume analyses\" });\n    }\n  });\n\n  // ===== ADMIN ROUTES (CEO ONLY) =====\n  \n  // Get pending users (CEO only)\n  app.get(\"/api/admin/pending-users\", requireCEO, async (req, res) => {\n    try {\n      const pendingUsers = await storage.getUsersByStatus('pending');\n      res.json(pendingUsers.map(u => sanitizeUser(u)));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch pending users\" });\n    }\n  });\n  \n  // Approve user (CEO only)\n  app.post(\"/api/admin/users/:id/approve\", requireCEO, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      if (user.status !== 'pending') {\n        return res.status(400).json({ error: \"User is not in pending status\" });\n      }\n      \n      const updatedUser = await storage.updateUserStatus(req.params.id, 'active');\n      await createAuditLog(req, 'user_approved', 'user', user.id, user.name, { previousStatus: user.status, newStatus: 'active', approvedBy: (req.user as any).name });\n      \n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to approve user\" });\n    }\n  });\n  \n  // Reject user (CEO only) - deletes the pending user\n  app.post(\"/api/admin/users/:id/reject\", requireCEO, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      if (user.status !== 'pending') {\n        return res.status(400).json({ error: \"User is not in pending status\" });\n      }\n      \n      await createAuditLog(req, 'user_rejected', 'user', user.id, user.name, { rejectedBy: (req.user as any).name });\n      await storage.updateUserStatus(req.params.id, 'rejected');\n      \n      res.json({ success: true, message: \"User registration rejected\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to reject user\" });\n    }\n  });\n  \n  // Suspend user (CEO only)\n  app.post(\"/api/admin/users/:id/suspend\", requireCEO, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      if (user.id === currentUser.id) {\n        return res.status(400).json({ error: \"You cannot suspend yourself\" });\n      }\n      \n      const updatedUser = await storage.updateUserStatus(req.params.id, 'suspended');\n      await createAuditLog(req, 'user_suspended', 'user', user.id, user.name, { previousStatus: user.status, newStatus: 'suspended', suspendedBy: currentUser.name });\n      \n      // Invalidate suspended user's session by destroying all sessions for that user\n      // Note: With PostgreSQL session store, we can delete sessions directly\n      try {\n        const { db } = await import(\"./db\");\n        const { sql } = await import(\"drizzle-orm\");\n        await db.execute(sql`DELETE FROM sessions WHERE sess::jsonb->'passport'->>'user' = ${req.params.id}`);\n      } catch (sessionErr) {\n        console.error('Failed to invalidate suspended user sessions:', sessionErr);\n        // Continue even if session cleanup fails\n      }\n      \n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to suspend user\" });\n    }\n  });\n  \n  // Reactivate user (CEO only)\n  app.post(\"/api/admin/users/:id/reactivate\", requireCEO, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      if (user.status !== 'suspended') {\n        return res.status(400).json({ error: \"User is not suspended\" });\n      }\n      \n      const updatedUser = await storage.updateUserStatus(req.params.id, 'active');\n      await createAuditLog(req, 'user_reactivated', 'user', user.id, user.name, { previousStatus: user.status, newStatus: 'active', reactivatedBy: (req.user as any).name });\n      \n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to reactivate user\" });\n    }\n  });\n  \n  // Change user role (CEO only) - Legacy endpoint\n  app.patch(\"/api/admin/users/:id/role\", requireCEO, async (req, res) => {\n    try {\n      const { role } = req.body;\n      const validRoles = ['CEO', 'Associate', 'Director', 'Managing Director', 'Analyst'];\n      if (!role || !validRoles.includes(role)) {\n        return res.status(400).json({ error: \"Invalid role\" });\n      }\n      \n      const currentUser = req.user as any;\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      // Prevent demoting the last admin\n      if (user.accessLevel === 'admin' && role !== 'CEO') {\n        const allUsers = await storage.getAllUsers();\n        const adminCount = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active').length;\n        if (adminCount <= 1) {\n          return res.status(400).json({ error: \"Cannot demote the only admin. Promote another user to admin first.\" });\n        }\n      }\n      \n      const updatedUser = await storage.updateUserProfile(req.params.id, { role });\n      await createAuditLog(req, 'role_changed', 'user', user.id, user.name, { previousRole: user.role, newRole: role, changedBy: currentUser.name });\n      \n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update user role\" });\n    }\n  });\n  \n  // Change user access level (admin only)\n  app.patch(\"/api/admin/users/:id/access-level\", requireCEO, async (req, res) => {\n    try {\n      const { accessLevel } = req.body;\n      const validLevels = ['admin', 'standard'];\n      if (!accessLevel || !validLevels.includes(accessLevel)) {\n        return res.status(400).json({ error: \"Invalid access level. Must be 'admin' or 'standard'.\" });\n      }\n      \n      const currentUser = req.user as any;\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      // Prevent demoting the last admin\n      if (user.accessLevel === 'admin' && accessLevel === 'standard') {\n        const allUsers = await storage.getAllUsers();\n        const adminCount = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active').length;\n        if (adminCount <= 1) {\n          return res.status(400).json({ error: \"Cannot demote the only admin. Promote another user to admin first.\" });\n        }\n      }\n      \n      const updatedUser = await storage.updateUserAccessLevel(req.params.id, accessLevel);\n      await createAuditLog(req, 'access_level_changed', 'user', user.id, user.name, { \n        previousAccessLevel: user.accessLevel, \n        newAccessLevel: accessLevel, \n        changedBy: currentUser.name \n      });\n      \n      res.json(sanitizeUser(updatedUser));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update user access level\" });\n    }\n  });\n  \n  // Get audit logs (CEO only)\n  app.get(\"/api/admin/audit-logs\", requireCEO, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const logs = await storage.getAuditLogTableEntries(limit);\n      res.json(logs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch audit logs\" });\n    }\n  });\n\n  // Invite new user (Admin only)\n  app.post(\"/api/admin/invite-user\", generalLimiter, requireCEO, async (req, res) => {\n    try {\n      const { name, email, accessLevel, jobTitle } = req.body;\n      const currentUser = req.user as any;\n\n      // Validate required fields\n      if (!name || !email) {\n        return res.status(400).json({ error: \"Name and email are required\" });\n      }\n\n      // Validate email format\n      if (!email.includes('@')) {\n        return res.status(400).json({ error: \"Invalid email address\" });\n      }\n\n      // Check if user already exists\n      const existingUser = await storage.getUserByEmail(email);\n      if (existingUser) {\n        return res.status(400).json({ error: \"A user with this email already exists\" });\n      }\n\n      // Create user with a temporary random password (they'll set their own via reset link)\n      const tempPassword = crypto.randomBytes(32).toString('hex');\n      const hashedPassword = await bcrypt.hash(tempPassword, 10);\n\n      const newUser = await storage.createUser({\n        name,\n        email,\n        password: hashedPassword,\n        accessLevel: accessLevel || 'standard',\n        jobTitle: jobTitle || undefined,\n        status: 'pending', // Will be activated when they set their password\n        role: 'Employee',\n      });\n\n      // Create password reset token (24 hour expiry for invites)\n      const token = crypto.randomBytes(32).toString('hex');\n      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n      await storage.createPasswordResetToken(newUser.id, token, expiresAt);\n\n      // Generate setup link\n      const baseUrl = process.env.REPLIT_DEV_DOMAIN \n        ? `https://${process.env.REPLIT_DEV_DOMAIN}`\n        : process.env.REPLIT_DOMAINS\n          ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n          : 'http://localhost:5000';\n      const setupLink = `${baseUrl}/reset-password?token=${token}`;\n\n      // Send invite email\n      const emailResult = await sendUserInviteEmail({\n        email,\n        userName: name,\n        inviterName: currentUser.name,\n        accessLevel: accessLevel || 'standard',\n        jobTitle,\n        setupLink,\n      });\n\n      if (!emailResult.success) {\n        console.error('Failed to send invite email:', emailResult.error);\n        // User was created but email failed - still return success but warn\n        return res.json({ \n          user: sanitizeUser(newUser), \n          emailSent: false,\n          message: \"User created but invite email could not be sent. You may need to resend the invite.\"\n        });\n      }\n\n      // Log the invite action\n      await createAuditLog(req, 'user_invited', 'user', newUser.id, newUser.name, { \n        invitedBy: currentUser.name,\n        accessLevel: accessLevel || 'standard',\n        jobTitle: jobTitle || null,\n      });\n\n      res.json({ \n        user: sanitizeUser(newUser), \n        emailSent: true,\n        message: \"User invited successfully. They will receive an email to set up their account.\"\n      });\n    } catch (error) {\n      console.error('Error inviting user:', error);\n      res.status(500).json({ error: \"Failed to invite user\" });\n    }\n  });\n\n  // Resend invite to pending user (Admin only)\n  app.post(\"/api/admin/users/:id/resend-invite\", generalLimiter, requireCEO, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const user = await storage.getUser(req.params.id);\n      \n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      if (user.status !== 'pending') {\n        return res.status(400).json({ error: \"Can only resend invites to pending users\" });\n      }\n\n      // Create new password reset token (24 hour expiry)\n      const token = crypto.randomBytes(32).toString('hex');\n      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n      await storage.createPasswordResetToken(user.id, token, expiresAt);\n\n      // Generate setup link\n      const baseUrl = process.env.REPLIT_DEV_DOMAIN \n        ? `https://${process.env.REPLIT_DEV_DOMAIN}`\n        : process.env.REPLIT_DOMAINS\n          ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n          : 'http://localhost:5000';\n      const setupLink = `${baseUrl}/reset-password?token=${token}`;\n\n      // Send invite email\n      const emailResult = await sendUserInviteEmail({\n        email: user.email,\n        userName: user.name,\n        inviterName: currentUser.name,\n        accessLevel: user.accessLevel,\n        jobTitle: user.jobTitle || undefined,\n        setupLink,\n      });\n\n      if (!emailResult.success) {\n        return res.status(500).json({ error: \"Failed to send invite email. Please try again.\" });\n      }\n\n      await createAuditLog(req, 'invite_resent', 'user', user.id, user.name, { \n        resentBy: currentUser.name,\n      });\n\n      res.json({ message: \"Invite email resent successfully\" });\n    } catch (error) {\n      console.error('Error resending invite:', error);\n      res.status(500).json({ error: \"Failed to resend invite\" });\n    }\n  });\n\n  // ===== FORMS ROUTES =====\n  \n  // Helper: Check if user can access forms (Dimitra or Charles)\n  const canAccessForms = (user: any): boolean => {\n    if (!user) return false;\n    const name = user.name?.toLowerCase() || '';\n    const email = user.email?.toLowerCase() || '';\n    return name.includes('dimitra') || email.includes('dimitra') || \n           name.includes('charles') || email.includes('charles');\n  };\n  const isDimitraUser = canAccessForms;\n\n  // Get all forms created by the current user (Dimitra only)\n  app.get(\"/api/forms\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const forms = await storage.getFormsByCreator(user.id);\n      res.json(forms);\n    } catch (error) {\n      console.error('Error fetching forms:', error);\n      res.status(500).json({ error: \"Failed to fetch forms\" });\n    }\n  });\n\n  // Get a single form by ID (Dimitra only)\n  app.get(\"/api/forms/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      // Only allow creator to view their own forms\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      res.json(form);\n    } catch (error) {\n      console.error('Error fetching form:', error);\n      res.status(500).json({ error: \"Failed to fetch form\" });\n    }\n  });\n\n  // Create a new form (Dimitra only)\n  app.post(\"/api/forms\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const { title, description, fields } = req.body;\n      if (!title) {\n        return res.status(400).json({ error: \"Form title is required\" });\n      }\n      const form = await storage.createForm({\n        title,\n        description: description || null,\n        fields: fields || [],\n        createdBy: user.id,\n        status: 'draft',\n      });\n      res.json(form);\n    } catch (error) {\n      console.error('Error creating form:', error);\n      res.status(500).json({ error: \"Failed to create form\" });\n    }\n  });\n\n  // Update a form (Dimitra only)\n  app.patch(\"/api/forms/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const updated = await storage.updateForm(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error('Error updating form:', error);\n      res.status(500).json({ error: \"Failed to update form\" });\n    }\n  });\n\n  // Publish a form and generate share token\n  app.post(\"/api/forms/:id/publish\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      // Generate unique share token\n      const shareToken = `form_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      const updated = await storage.updateForm(req.params.id, {\n        status: 'published',\n        shareToken,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error('Error publishing form:', error);\n      res.status(500).json({ error: \"Failed to publish form\" });\n    }\n  });\n\n  // Unpublish a form (revert to draft) - Dimitra or Charles only\n  app.post(\"/api/forms/:id/unpublish\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(400).json({ error: \"Form is not published\" });\n      }\n      // Revert to draft status, keep the shareToken in case they want to republish\n      const updated = await storage.updateForm(req.params.id, {\n        status: 'draft',\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error('Error unpublishing form:', error);\n      res.status(500).json({ error: \"Failed to unpublish form\" });\n    }\n  });\n\n  // Delete a form (Dimitra only)\n  app.delete(\"/api/forms/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      await storage.deleteForm(req.params.id);\n      res.json({ message: \"Form deleted successfully\" });\n    } catch (error) {\n      console.error('Error deleting form:', error);\n      res.status(500).json({ error: \"Failed to delete form\" });\n    }\n  });\n\n  // Share a form with users/emails\n  app.post(\"/api/forms/:id/share\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(400).json({ error: \"Form must be published before sharing\" });\n      }\n      if (!form.shareToken) {\n        return res.status(400).json({ error: \"Form share token not generated. Please try republishing the form.\" });\n      }\n\n      const { emails, message } = req.body;\n      if (!emails || !Array.isArray(emails) || emails.length === 0) {\n        return res.status(400).json({ error: \"At least one email is required\" });\n      }\n\n      const baseUrl = process.env.REPLIT_DEV_DOMAIN \n        ? `https://${process.env.REPLIT_DEV_DOMAIN}`\n        : process.env.REPLIT_DOMAINS\n          ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n          : 'http://localhost:5000';\n      const formLink = `${baseUrl}/form/${form.shareToken}`;\n\n      const allUsers = await storage.getAllUsers();\n      const results = [];\n\n      for (const email of emails) {\n        // Check if email belongs to a platform user\n        const platformUser = allUsers.find(u => u.email.toLowerCase() === email.toLowerCase());\n        \n        // Create invitation record\n        const invitation = await storage.createFormInvitation({\n          formId: form.id,\n          email,\n          userId: platformUser?.id || null,\n          message: message || null,\n        });\n\n        if (platformUser) {\n          // Create task for platform user with the form link\n          const task = await storage.createTask({\n            title: `Complete form: ${form.title}`,\n            description: `You've been asked to complete a form.${message ? ` Message: ${message}` : ''}\\n\\nClick here to complete the form: ${formLink}`,\n            dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 1 week from now\n            priority: 'Medium',\n            status: 'To Do',\n            assignedTo: platformUser.id,\n            dealId: null,\n          });\n\n          // Create notification\n          await storage.createNotification({\n            userId: platformUser.id,\n            title: 'New Form to Complete',\n            message: `${user.name} has shared a form with you: \"${form.title}\"`,\n            type: 'info',\n            link: `/employee/tasks?taskId=${task.id}`,\n          });\n\n          results.push({ email, status: 'task_created', userId: platformUser.id });\n        } else {\n          // Send email to external user\n          try {\n            await sendFormInvitationEmail({\n              email,\n              formTitle: form.title,\n              senderName: user.name,\n              formLink,\n              message: message || undefined,\n            });\n            results.push({ email, status: 'email_sent' });\n          } catch (emailError) {\n            console.error('Error sending form invitation email:', emailError);\n            results.push({ email, status: 'email_failed' });\n          }\n        }\n      }\n\n      res.json({ success: true, results, formLink });\n    } catch (error) {\n      console.error('Error sharing form:', error);\n      res.status(500).json({ error: \"Failed to share form\" });\n    }\n  });\n\n  // Get form submissions (Dimitra only)\n  app.get(\"/api/forms/:id/submissions\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const form = await storage.getForm(req.params.id);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.createdBy !== user.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const submissions = await storage.getFormSubmissions(req.params.id);\n      res.json(submissions);\n    } catch (error) {\n      console.error('Error fetching submissions:', error);\n      res.status(500).json({ error: \"Failed to fetch submissions\" });\n    }\n  });\n\n  // Public route: Get form by share token (no auth required)\n  app.get(\"/api/public/forms/:shareToken\", async (req, res) => {\n    try {\n      const form = await storage.getFormByShareToken(req.params.shareToken);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(404).json({ error: \"Form not available\" });\n      }\n      // Return only necessary fields for public view\n      res.json({\n        id: form.id,\n        title: form.title,\n        description: form.description,\n        coverImage: form.coverImage,\n        fields: form.fields,\n      });\n    } catch (error) {\n      console.error('Error fetching public form:', error);\n      res.status(500).json({ error: \"Failed to fetch form\" });\n    }\n  });\n\n  // Public route: Submit a form (no auth required)\n  app.post(\"/api/public/forms/:shareToken/submit\", async (req, res) => {\n    try {\n      const form = await storage.getFormByShareToken(req.params.shareToken);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(404).json({ error: \"Form not available\" });\n      }\n\n      const { responses, submitterName, submitterEmail } = req.body;\n      if (!responses || !Array.isArray(responses)) {\n        return res.status(400).json({ error: \"Form responses are required\" });\n      }\n\n      // Get form creator (Dimitra) to create task for her\n      const creator = await storage.getUser(form.createdBy);\n      if (!creator) {\n        return res.status(500).json({ error: \"Form creator not found\" });\n      }\n\n      // Create a task for Dimitra with the form submission\n      const task = await storage.createTask({\n        title: `Form Submission: ${form.title}`,\n        description: `A new submission has been received for \"${form.title}\".\\n\\nSubmitter: ${submitterName || 'Anonymous'}\\nEmail: ${submitterEmail || 'Not provided'}`,\n        dueDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(), // 3 days from now\n        priority: 'Medium',\n        status: 'To Do',\n        assignedTo: creator.id,\n        dealId: null,\n      });\n\n      // Create the form submission record\n      const submission = await storage.createFormSubmission({\n        formId: form.id,\n        formTitle: form.title,\n        submitterName: submitterName || null,\n        submitterEmail: submitterEmail || null,\n        submitterId: null,\n        responses,\n        taskId: task.id,\n        status: 'pending',\n      });\n\n      // Create notification for Dimitra\n      await storage.createNotification({\n        userId: creator.id,\n        title: 'New Form Submission',\n        message: `Someone submitted the form \"${form.title}\"`,\n        type: 'info',\n        link: `/employee/tasks?taskId=${task.id}`,\n      });\n\n      res.json({ success: true, message: \"Form submitted successfully\" });\n    } catch (error) {\n      console.error('Error submitting form:', error);\n      res.status(500).json({ error: \"Failed to submit form\" });\n    }\n  });\n\n  // Cleanup expired pending uploads (run opportunistically)\n  async function cleanupExpiredUploads() {\n    try {\n      const expiredUploads = await storage.getExpiredPendingUploads();\n      const objectStorageService = new ObjectStorageService();\n      \n      for (const upload of expiredUploads) {\n        try {\n          // Try to delete the object from storage\n          const file = await objectStorageService.getObjectEntityFile(upload.objectPath);\n          await file.delete();\n        } catch (e) {\n          // Object may not exist, that's fine\n        }\n        // Remove the tracking record\n        await storage.deletePendingFormUpload(upload.id);\n      }\n      \n      if (expiredUploads.length > 0) {\n        console.log(`Cleaned up ${expiredUploads.length} expired pending uploads`);\n      }\n    } catch (error) {\n      console.error(\"Error cleaning up expired uploads:\", error);\n    }\n  }\n\n  // Public route: Get presigned upload URL for form file attachments (no auth required)\n  app.post(\"/api/public/forms/:shareToken/upload\", uploadLimiter, async (req, res) => {\n    try {\n      // Run cleanup opportunistically\n      cleanupExpiredUploads().catch(() => {});\n      \n      const form = await storage.getFormByShareToken(req.params.shareToken);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(404).json({ error: \"Form not available\" });\n      }\n\n      const { filename, size, type } = req.body;\n      \n      // Validate file size (max 10MB for public uploads)\n      const MAX_FILE_SIZE = 10 * 1024 * 1024;\n      if (size && size > MAX_FILE_SIZE) {\n        return res.status(400).json({ error: \"File size exceeds 10MB limit\" });\n      }\n\n      // Validate file type (allow common document/image types)\n      const allowedTypes = [\n        'application/pdf', 'application/msword', \n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n        'application/vnd.ms-excel',\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        'image/jpeg', 'image/png', 'image/gif', 'image/webp',\n        'text/plain', 'text/csv'\n      ];\n      if (type && !allowedTypes.includes(type)) {\n        return res.status(400).json({ error: \"File type not allowed\" });\n      }\n\n      const objectStorageService = new ObjectStorageService();\n      const result = await objectStorageService.getObjectEntityUploadURL(filename);\n      \n      // Track the pending upload with 1 hour expiry\n      await storage.createPendingFormUpload({\n        shareToken: req.params.shareToken,\n        objectPath: result.objectPath,\n        filename: filename || 'unknown',\n        maxSize: MAX_FILE_SIZE,\n        expiresAt: new Date(Date.now() + 60 * 60 * 1000), // 1 hour\n      });\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error getting public upload URL:\", error);\n      res.status(500).json({ error: error.message || \"Failed to get upload URL\" });\n    }\n  });\n\n  // Public route: Confirm public form file upload\n  app.put(\"/api/public/forms/:shareToken/upload/confirm\", async (req, res) => {\n    try {\n      const shareToken = req.params.shareToken;\n      const form = await storage.getFormByShareToken(shareToken);\n      if (!form) {\n        return res.status(404).json({ error: \"Form not found\" });\n      }\n      if (form.status !== 'published') {\n        return res.status(404).json({ error: \"Form not available\" });\n      }\n\n      const { objectPath, filename } = req.body;\n      if (!objectPath) {\n        return res.status(400).json({ error: \"Object path is required\" });\n      }\n\n      // Verify the pending upload record exists and is valid\n      const pendingUpload = await storage.getPendingFormUpload(shareToken, objectPath);\n      if (!pendingUpload) {\n        return res.status(400).json({ error: \"Invalid or expired upload. Please try again.\" });\n      }\n\n      const objectStorageService = new ObjectStorageService();\n      \n      // Verify the object actually exists and get its metadata\n      let objectFile;\n      try {\n        objectFile = await objectStorageService.getObjectEntityFile(objectPath);\n      } catch {\n        // Clean up the pending record since the object doesn't exist\n        await storage.deletePendingFormUpload(pendingUpload.id);\n        return res.status(400).json({ error: \"Uploaded file not found. Please try again.\" });\n      }\n      \n      // Get actual file metadata from storage\n      const [metadata] = await objectFile.getMetadata();\n      const actualSize = parseInt(metadata.size as string, 10);\n      const actualType = metadata.contentType || 'application/octet-stream';\n      \n      // Enforce 10MB limit server-side based on actual uploaded size\n      const MAX_FILE_SIZE = 10 * 1024 * 1024;\n      if (actualSize > MAX_FILE_SIZE) {\n        // Delete the oversized file and tracking record\n        try {\n          await objectFile.delete();\n          await storage.deletePendingFormUpload(pendingUpload.id);\n        } catch (e) {\n          console.error(\"Failed to delete oversized file:\", e);\n        }\n        return res.status(400).json({ error: \"Uploaded file exceeds 10MB limit\" });\n      }\n      \n      // Validate file type based on actual content type\n      const allowedTypes = [\n        'application/pdf', 'application/msword', \n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n        'application/vnd.ms-excel',\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        'image/jpeg', 'image/png', 'image/gif', 'image/webp',\n        'text/plain', 'text/csv', 'application/octet-stream'\n      ];\n      if (!allowedTypes.includes(actualType)) {\n        // Delete the disallowed file and tracking record\n        try {\n          await objectFile.delete();\n          await storage.deletePendingFormUpload(pendingUpload.id);\n        } catch (e) {\n          console.error(\"Failed to delete disallowed file:\", e);\n        }\n        return res.status(400).json({ error: \"File type not allowed\" });\n      }\n\n      await objectStorageService.trySetObjectEntityAclPolicy(objectPath, { \n        visibility: 'private' \n      });\n      \n      // Delete the pending upload record (confirmation = deletion since we validated)\n      await storage.confirmAndDeletePendingFormUpload(shareToken, objectPath);\n\n      res.json({ \n        success: true, \n        objectPath,\n        filename,\n        size: actualSize,\n        type: actualType\n      });\n    } catch (error: any) {\n      console.error(\"Error confirming public upload:\", error);\n      res.status(500).json({ error: error.message || \"Failed to confirm upload\" });\n    }\n  });\n\n  // ===== CUSTOM SECTORS ROUTES =====\n  \n  app.get(\"/api/custom-sectors\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const sectors = await storage.getAllCustomSectors();\n      res.json(sectors);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch custom sectors\" });\n    }\n  });\n  \n  app.post(\"/api/custom-sectors\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { name } = req.body;\n      if (!name || typeof name !== 'string' || name.trim().length === 0) {\n        return res.status(400).json({ error: \"Sector name is required\" });\n      }\n      \n      const currentUser = req.user as any;\n      const sector = await storage.createCustomSector({\n        name: name.trim(),\n        createdBy: currentUser.id,\n      });\n      res.json(sector);\n    } catch (error: any) {\n      // Handle unique constraint violation (duplicate sector)\n      if (error.code === '23505') {\n        return res.status(400).json({ error: \"This sector already exists\" });\n      }\n      res.status(500).json({ error: \"Failed to create custom sector\" });\n    }\n  });\n\n  // ===== TASK TEMPLATES ROUTES (HR/Admin only) =====\n  \n  // Get all task templates\n  app.get(\"/api/task-templates\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const templates = await storage.getAllTaskTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error('Error fetching task templates:', error);\n      res.status(500).json({ error: \"Failed to fetch task templates\" });\n    }\n  });\n\n  // Get single task template\n  app.get(\"/api/task-templates/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const template = await storage.getTaskTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error('Error fetching task template:', error);\n      res.status(500).json({ error: \"Failed to fetch task template\" });\n    }\n  });\n\n  // Create task template\n  app.post(\"/api/task-templates\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const { name, description, category, sections } = req.body;\n      if (!name || typeof name !== 'string' || name.trim().length === 0) {\n        return res.status(400).json({ error: \"Template name is required\" });\n      }\n      const template = await storage.createTaskTemplate({\n        name: name.trim(),\n        description: description || null,\n        category: category || 'HR',\n        sections: sections || [],\n        createdBy: user.id,\n      });\n      res.json(template);\n    } catch (error) {\n      console.error('Error creating task template:', error);\n      res.status(500).json({ error: \"Failed to create task template\" });\n    }\n  });\n\n  // Update task template\n  app.put(\"/api/task-templates/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const template = await storage.getTaskTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      const { name, description, category, sections, isArchived } = req.body;\n      const updated = await storage.updateTaskTemplate(req.params.id, {\n        name: name !== undefined ? name : template.name,\n        description: description !== undefined ? description : template.description,\n        category: category !== undefined ? category : template.category,\n        sections: sections !== undefined ? sections : template.sections,\n        isArchived: isArchived !== undefined ? isArchived : template.isArchived,\n      });\n      res.json(updated);\n    } catch (error) {\n      console.error('Error updating task template:', error);\n      res.status(500).json({ error: \"Failed to update task template\" });\n    }\n  });\n\n  // Delete task template\n  app.delete(\"/api/task-templates/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const template = await storage.getTaskTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      await storage.deleteTaskTemplate(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting task template:', error);\n      res.status(500).json({ error: \"Failed to delete task template\" });\n    }\n  });\n\n  // Apply task template - creates real tasks from template\n  app.post(\"/api/task-templates/:id/apply\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const template = await storage.getTaskTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      \n      const { startDate, contextType, contextName, assigneeOverrides } = req.body;\n      const baseDate = startDate ? new Date(startDate) : new Date();\n      \n      const createdTasks = [];\n      const sections = template.sections || [];\n      \n      for (const section of sections) {\n        for (const templateTask of section.tasks || []) {\n          // Calculate due date based on relative days\n          let dueDate: string | undefined;\n          if (templateTask.relativeDueDays !== undefined && templateTask.relativeDueDays !== null) {\n            const due = new Date(baseDate);\n            due.setDate(due.getDate() + templateTask.relativeDueDays);\n            dueDate = due.toISOString().split('T')[0];\n          }\n          \n          // Get assignee - use override if provided, otherwise use template default\n          const assigneeId = assigneeOverrides?.[templateTask.id] || templateTask.assigneeId || null;\n          \n          const task = await storage.createTask({\n            title: templateTask.title,\n            description: templateTask.description || `From template: ${template.name} - Section: ${section.title}`,\n            dueDate,\n            priority: 'Medium',\n            status: 'To Do',\n            type: 'HR',\n            assignedTo: assigneeId,\n            assignedBy: user.id,\n          });\n          \n          createdTasks.push(task);\n          \n          // Create notification for assigned user\n          if (assigneeId) {\n            await storage.createNotification({\n              userId: assigneeId,\n              title: 'New Task Assigned',\n              message: `You have been assigned a new task: \"${templateTask.title}\"${contextName ? ` for ${contextName}` : ''}`,\n              type: 'info',\n              link: `/employee/tasks?taskId=${task.id}`,\n            });\n          }\n        }\n      }\n      \n      // Log template usage\n      await storage.createTaskTemplateUsage({\n        templateId: template.id,\n        templateName: template.name,\n        appliedBy: user.id,\n        contextType: contextType || null,\n        contextName: contextName || null,\n        tasksCreated: createdTasks.length,\n        startDate: baseDate.toISOString().split('T')[0],\n      });\n      \n      // Increment usage count\n      await storage.incrementTaskTemplateUsage(template.id);\n      \n      res.json({ \n        success: true, \n        tasksCreated: createdTasks.length,\n        tasks: createdTasks,\n      });\n    } catch (error) {\n      console.error('Error applying task template:', error);\n      res.status(500).json({ error: \"Failed to apply task template\" });\n    }\n  });\n\n  // Get template usage history\n  app.get(\"/api/task-templates/:id/usage\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      if (!isDimitraUser(user)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      const usages = await storage.getTaskTemplateUsageByTemplate(req.params.id);\n      res.json(usages);\n    } catch (error) {\n      console.error('Error fetching template usage:', error);\n      res.status(500).json({ error: \"Failed to fetch template usage\" });\n    }\n  });\n\n  // ===== PERSONALITY ASSESSMENT ROUTES =====\n\n  // Question to personality tag mapping (A answer = first tag, B answer = second tag)\n  const PERSONALITY_QUESTION_MAP: Record<number, [string, string]> = {\n    1: ['Politician', 'Sherpa'],\n    2: ['Firefighter', 'Architect'],\n    3: ['Grandmaster', 'Closer'],\n    4: ['Rainmaker', 'Guru'],\n    5: ['Sherpa', 'Creative'],\n    6: ['Misfit', 'Architect'],\n    7: ['Deal Junkie', 'Liaison'],\n    8: ['Closer', 'Sherpa'],\n    9: ['Closer', 'Guru'],\n    10: ['Mayor', 'Grandmaster'],\n    11: ['Deal Junkie', 'Architect'],\n    12: ['Closer', 'Auditor'],\n    13: ['Politician', 'Mayor'],\n    14: ['Firefighter', 'Misfit'],\n    15: ['Deal Junkie', 'Guru'],\n    16: ['Sherpa', 'Liaison'],\n    17: ['Grandmaster', 'Closer'],\n    18: ['Deal Junkie', 'Architect'],\n    19: ['Rainmaker', 'Auditor'],\n    20: ['Closer', 'Guru'],\n    21: ['Deal Junkie', 'Architect'],\n    22: ['Sherpa', 'Misfit'],\n    23: ['Rainmaker', 'Architect'],\n    24: ['Deal Junkie', 'Sherpa'],\n    25: ['Firefighter', 'Auditor'],\n  };\n\n  // Calculate personality scores from answers (16 canonical Equiturn tags)\n  function calculatePersonalityScores(answers: Record<number, 'A' | 'B'>) {\n    const scores: Record<string, number> = {\n      'Politician': 0, 'Rainmaker': 0, 'Mayor': 0, 'Creative': 0,\n      'Deal Junkie': 0, 'Closer': 0, 'Grandmaster': 0, 'Architect': 0,\n      'Guru': 0, 'Sherpa': 0, 'Firefighter': 0, 'Legal': 0,\n      'Liaison': 0, 'Auditor': 0, 'Regulatory': 0, 'Misfit': 0\n    };\n\n    for (const [questionNum, answer] of Object.entries(answers)) {\n      const qNum = parseInt(questionNum);\n      const tags = PERSONALITY_QUESTION_MAP[qNum];\n      if (tags) {\n        const selectedTag = answer === 'A' ? tags[0] : tags[1];\n        scores[selectedTag] = (scores[selectedTag] || 0) + 1;\n      }\n    }\n\n    return scores;\n  }\n\n  // Equiturn Employee Tagging Analyst prompt\n  const EQUITURN_ANALYST_PROMPT = `You are Equiturn Employee Tagging Analyst. Your sole job is to ingest an uploaded personality assessment score sheet and produce an institutional deployment profile used for deal staffing, ending with final deployment tags.\nNon negotiable constraints\nConfidentiality. Treat all employee data as confidential.\nNo fabrication. Do not invent scores, tag names, employee identity, title, or Deal Team status.\nNo questions. You must never ask the user for missing inputs. You must proceed using best effort extraction, inference, and clearly labeled assumptions.\nNo emojis. No tables.\nBehavioral deployment only. Assume baseline technical competence across finance.\nNo advancement language. Do not discuss promotion or progression. Deal Team status is used only to calibrate autonomy, complexity, review cadence, and risk controls.\nDo not reference internal deliberation. Provide conclusions with rationale tied to observed tag scores.\nPrimary input source\n The uploaded file is the source of truth. If multiple files are uploaded, use the most recent file unless a file explicitly states it supersedes another.\nData extraction rules\n1. Extract employee name and title or function if present anywhere in the file. If not present, set name to Name not provided and title to Function not provided.\n2. Extract Deal Team status if present. Valid values are Floater, Deal Team 10, Deal Team 8, Deal Team 2, Deal Team 4, Deal Team 6.\n If not present, default to Floater and flag as an assumption.\n3. Extract the full tag list and numeric scores. The assessment is expected to have 15 tags. If fewer than 15 are present, proceed with available tags and flag missing tags.\n4. Determine score direction. Default assumption is higher score means stronger signal. If the file explicitly states the opposite, follow the file.\n5. Determine score scale automatically. Infer scale from observed min and max values. Treat values like 1 to 5, 1 to 10, 0 to 100 as common scales. If scale is unclear, proceed using rank order only and flag scale ambiguity.\nScore standardization and ranking\n1. Rank order all tags from highest to lowest. Handle ties explicitly.\n2. Compute internal strength tiers using percentiles.\n Tier A equals top third of scores. Tier B equals middle third. Tier C equals bottom third.\n If the distribution is flat or nearly flat, define Tier A as the top five tags by rank, Tier C as the bottom five.\n3. Define High tags as Tier A, Moderate tags as Tier B, Low tags as Tier C.\n4. Never show calculations unless asked. You may show rank order.\nCanonical tag taxonomy\n The canonical Equiturn tags used for mapping are: Politician, Rainmaker, Mayor, Creative, Deal Junkie, Closer, Grandmaster, Architect, Guru, Sherpa, Firefighter, Legal, Liaison, Auditor, Regulatory, Misfit.\nTag name reconciliation\nFirst attempt exact match.\nThen attempt case and spacing insensitive match.\nThen attempt conservative fuzzy match only when the mapping is obvious.\nIf a tag cannot be mapped with high confidence, keep the original tag name and treat it as unmapped. Unmapped tags may influence narrative only if they are in Tier A, but they must not be used to trigger vertical or phase mapping rules. Flag unmapped tags in Data Integrity Notes.\nVertical fit mapping rules\n You must output the top two verticals. Use a rule driven score based on core tags.\n1. M and A buy side\n Core tags: Grandmaster, Closer, Deal Junkie, Architect, Guru\n Strong fit trigger: Closer and Grandmaster and Architect are High\n2. M and A sell side\n Core tags: Rainmaker, Politician, Creative, Firefighter, Legal\n Strong fit trigger: Politician and Rainmaker and Firefighter are High\n3. ECM\n Core tags: Rainmaker, Mayor, Politician, Creative, Deal Junkie\n Strong fit trigger: Rainmaker and Creative and Mayor are High\n4. DCM\n Core tags: Architect, Auditor, Regulatory, Liaison, Guru\n Strong fit trigger: Architect and Auditor and Regulatory are High\n5. Fundraising and AUM raising\n Core tags: Rainmaker, Politician, Mayor, Deal Junkie, Closer\n Strong fit trigger: Rainmaker and Deal Junkie and Politician are High\nVertical scoring method\nFor each vertical, count how many of its core tags are High.\nBreak ties by counting how many are in Tier A or Tier B combined.\nBreak further ties by the sum of normalized scores across that vertical's core tags.\nThe highest scoring is primary vertical. The second highest is secondary vertical.\nIf no vertical meets a strong fit trigger, still assign top two verticals by the scoring method and explicitly state that the fit is mixed and why.\nDeal phase fit mapping rules\n Origination: Rainmaker, Politician, Mayor, Misfit\n Structuring: Architect, Guru, Legal, Grandmaster\n Execution: Sherpa, Firefighter, Deal Junkie, Closer\n Closing: Closer, Grandmaster, Legal, Firefighter\n Integration: Liaison, Auditor, Sherpa, Grandmaster\nPhase scoring method\nFor each phase, count how many of its tags are High.\nBreak ties by Tier A or Tier B count, then normalized sum.\nOutput phases in best fit order.\nName a primary phase and secondary phase based on the top two scores.\nDeal Team calibration rules\n Use Deal Team status to calibrate autonomy, complexity ceiling, and review cadence.\nFloater\n Baseline competency. Deploy in clearly bounded roles with frequent review and explicit checklists.\nDeal Team 10\n Deploy on structured tasks with tight scope. Require frequent review and written next steps.\nDeal Team 8\n Deploy on mid complexity execution and coordination. Moderate autonomy with defined checkpoints.\nDeal Team 2\n Deploy as lead on complex mandates with strategic autonomy. Reviews focus on risk, legal, and final positioning.\nDeal Team 4\n Deploy on highest complexity mandates. Minimal supervision. Reviews focus on governance and institutional quality.\nDeal Team 6\n Deploy on hyper complex mandates. Operate as internal standard setter. Reviews focus on systemic risk and mission critical decisions.\nMandatory output format\n Write the output in this exact order, as short paragraphs, no tables.\n1. Employee Snapshot\n Include name, title or function, Deal Team status, and a one sentence deployment headline.\n Also include Data Integrity Notes in this section, listing assumptions and missing fields in plain language.\n2. Score Distribution\n List each tag and score on its own line.\n3. Primary Archetype\n Identify the top one to two tags that drive behavior in live deals and why.\n4. Secondary Traits\n Explain the next two to three tags and how they show up under pressure.\n5. Supporting Traits\n Explain the next three tags that stabilize delivery and what they enable.\n6. Low Signal Tags\n Explain what is weak and the practical implication.\n7. Absent Traits\n If any tag is at the minimum observed score, treat it as absent and explain the operational limitation it creates. If none are at minimum, state No fully absent traits observed.\n8. Deal Phase Fit\n State best fit phases in order, then name a primary phase and secondary phase with rationale grounded in tags.\n9. Deal Type Proficiency\n State the top two verticals with rationale grounded in the vertical mapping rules. Add one sentence on deal contexts to avoid or constrain.\n10. Managerial Notes\n Give clear instructions for how leadership should deploy and manage this person on live mandates, including review cadence and what they should not own unsupervised, calibrated to Deal Team status.\n11. Final Deployment Tags\n Finish with a single block titled Final Deployment Tags containing, in this order:\n A. Deal Team status\n B. Primary vertical\n C. Secondary vertical\n D. Primary deal phase\n E. Secondary deal phase\n F. Top five archetype tags in rank order\n G. One risk flag tag if applicable, otherwise state No material coverage gaps\nQuality control pass\n Before finalizing, run two checks silently.\nCompleteness check. Every mandatory section exists, Deal Team status stated, and score distribution listed.\nLogic check. Vertical and phase choices must be consistent with the mapping rules and highest scoring tags. If there is a tradeoff, state the tradeoff explicitly.\nMulti employee handling\n If the uploaded file contains multiple employees, produce one full profile per employee in a single response. Separate profiles with a clear header using the employee name.`;\n\n  // AI Analysis function using OpenAI\n  async function analyzePersonalityWithAI(\n    userName: string,\n    userTitle: string,\n    dealTeamStatus: string,\n    scores: { profile: string; score: number }[]\n  ): Promise<{ success: boolean; analysis?: any; error?: string }> {\n    console.log('[Personality AI] Starting analysis for:', userName);\n    try {\n      // Format score sheet for the AI\n      const scoreSheet = scores\n        .map(s => `${s.profile}: ${s.score}`)\n        .join('\\n');\n\n      const userInput = `Employee Name: ${userName}\nTitle/Function: ${userTitle}\nDeal Team Status: ${dealTeamStatus}\n\nPersonality Assessment Score Sheet:\n${scoreSheet}`;\n\n      console.log('[Personality AI] Calling OpenAI API...');\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: EQUITURN_ANALYST_PROMPT },\n          { role: \"user\", content: userInput }\n        ],\n        temperature: 0.3,\n        max_tokens: 3000,\n      });\n\n      const rawResponse = response.choices[0]?.message?.content || '';\n      console.log('[Personality AI] Received response, length:', rawResponse.length);\n      \n      if (!rawResponse) {\n        console.error('[Personality AI] Empty response from OpenAI');\n        return { success: false, error: 'Empty response from AI' };\n      }\n      \n      // Parse the AI response into structured sections\n      const analysis = parseAIAnalysis(rawResponse);\n      console.log('[Personality AI] Parsed analysis sections:', Object.keys(analysis).filter(k => analysis[k] && k !== 'rawResponse'));\n      \n      return { success: true, analysis };\n    } catch (error: any) {\n      console.error('[Personality AI] Error:', error?.message || error);\n      console.error('[Personality AI] Full error:', JSON.stringify(error, null, 2));\n      return { success: false, error: error.message };\n    }\n  }\n\n  // Parse AI response into structured sections\n  function parseAIAnalysis(rawResponse: string): any {\n    const sections: Record<string, string> = {};\n    \n    // Extract sections using regex patterns\n    const sectionPatterns = [\n      { key: 'employeeSnapshot', pattern: /1\\.\\s*Employee Snapshot\\s*([\\s\\S]*?)(?=2\\.\\s*Score Distribution|$)/i },\n      { key: 'scoreDistribution', pattern: /2\\.\\s*Score Distribution\\s*([\\s\\S]*?)(?=3\\.\\s*Primary Archetype|$)/i },\n      { key: 'primaryArchetype', pattern: /3\\.\\s*Primary Archetype\\s*([\\s\\S]*?)(?=4\\.\\s*Secondary Traits|$)/i },\n      { key: 'secondaryTraits', pattern: /4\\.\\s*Secondary Traits\\s*([\\s\\S]*?)(?=5\\.\\s*Supporting Traits|$)/i },\n      { key: 'supportingTraits', pattern: /5\\.\\s*Supporting Traits\\s*([\\s\\S]*?)(?=6\\.\\s*Low Signal Tags|$)/i },\n      { key: 'lowSignalTags', pattern: /6\\.\\s*Low Signal Tags\\s*([\\s\\S]*?)(?=7\\.\\s*Absent Traits|$)/i },\n      { key: 'absentTraits', pattern: /7\\.\\s*Absent Traits\\s*([\\s\\S]*?)(?=8\\.\\s*Deal Phase Fit|$)/i },\n      { key: 'dealPhaseFit', pattern: /8\\.\\s*Deal Phase Fit\\s*([\\s\\S]*?)(?=9\\.\\s*Deal Type Proficiency|$)/i },\n      { key: 'dealTypeProficiency', pattern: /9\\.\\s*Deal Type Proficiency\\s*([\\s\\S]*?)(?=10\\.\\s*Managerial Notes|$)/i },\n      { key: 'managerialNotes', pattern: /10\\.\\s*Managerial Notes\\s*([\\s\\S]*?)(?=11\\.\\s*Final Deployment Tags|$)/i },\n    ];\n\n    for (const { key, pattern } of sectionPatterns) {\n      const match = rawResponse.match(pattern);\n      sections[key] = match ? match[1].trim() : '';\n    }\n\n    // Extract Final Deployment Tags section\n    const deploymentTagsMatch = rawResponse.match(/11\\.\\s*Final Deployment Tags\\s*([\\s\\S]*?)$/i);\n    const deploymentTagsText = deploymentTagsMatch ? deploymentTagsMatch[1].trim() : '';\n\n    // Parse deployment tags\n    const deploymentTags = {\n      dealTeamStatus: extractTagValue(deploymentTagsText, /A\\.\\s*Deal Team status[:\\s]*(.+)/i) || 'Floater',\n      primaryVertical: extractTagValue(deploymentTagsText, /B\\.\\s*Primary vertical[:\\s]*(.+)/i) || '',\n      secondaryVertical: extractTagValue(deploymentTagsText, /C\\.\\s*Secondary vertical[:\\s]*(.+)/i) || '',\n      primaryDealPhase: extractTagValue(deploymentTagsText, /D\\.\\s*Primary deal phase[:\\s]*(.+)/i) || '',\n      secondaryDealPhase: extractTagValue(deploymentTagsText, /E\\.\\s*Secondary deal phase[:\\s]*(.+)/i) || '',\n      topFiveArchetypes: extractTopFive(deploymentTagsText),\n      riskFlag: extractTagValue(deploymentTagsText, /G\\.\\s*(?:One risk flag tag|Risk flag)[:\\s]*(.+)/i) || null,\n    };\n\n    return {\n      ...sections,\n      deploymentTags,\n      rawResponse,\n    };\n  }\n\n  function extractTagValue(text: string, pattern: RegExp): string | null {\n    const match = text.match(pattern);\n    return match ? match[1].trim() : null;\n  }\n\n  function extractTopFive(text: string): string[] {\n    const match = text.match(/F\\.\\s*Top five archetype tags[:\\s]*([\\s\\S]*?)(?=G\\.|$)/i);\n    if (!match) return [];\n    const tagsText = match[1].trim();\n    // Split by commas, newlines, or numbered items\n    return tagsText\n      .split(/[,\\n]/)\n      .map(t => t.replace(/^\\d+\\.\\s*/, '').trim())\n      .filter(t => t.length > 0)\n      .slice(0, 5);\n  }\n\n  // Get current user's personality assessment\n  app.get(\"/api/personality/assessment\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const assessment = await storage.getPersonalityAssessment(user.id);\n      res.json(assessment || null);\n    } catch (error) {\n      console.error('Error fetching personality assessment:', error);\n      res.status(500).json({ error: \"Failed to fetch personality assessment\" });\n    }\n  });\n\n  // Get personality assessment for a specific user (admin only)\n  app.get(\"/api/personality/assessment/:userId\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const assessment = await storage.getPersonalityAssessment(req.params.userId);\n      res.json(assessment || null);\n    } catch (error) {\n      console.error('Error fetching personality assessment:', error);\n      res.status(500).json({ error: \"Failed to fetch personality assessment\" });\n    }\n  });\n\n  // Submit personality assessment\n  app.post(\"/api/personality/assessment\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const { answers, dealTeamStatus } = req.body;\n\n      if (!answers || typeof answers !== 'object') {\n        return res.status(400).json({ error: \"Answers are required\" });\n      }\n\n      // Validate all 25 questions are answered\n      const answeredQuestions = Object.keys(answers).map(k => parseInt(k));\n      const requiredQuestions = Array.from({ length: 25 }, (_, i) => i + 1);\n      const missingQuestions = requiredQuestions.filter(q => !answeredQuestions.includes(q));\n      \n      if (missingQuestions.length > 0) {\n        return res.status(400).json({ \n          error: `Missing answers for questions: ${missingQuestions.join(', ')}` \n        });\n      }\n\n      // Calculate raw scores from answers\n      const rawScores = calculatePersonalityScores(answers);\n      \n      // Convert to sorted array\n      const allScores = Object.entries(rawScores)\n        .map(([profile, score]) => ({ profile, score }))\n        .sort((a, b) => b.score - a.score);\n\n      // Get top 3\n      const topThreeProfiles = allScores.slice(0, 3);\n\n      // Check if user already has an assessment\n      const existingAssessment = await storage.getPersonalityAssessment(user.id);\n\n      // First save/update assessment with pending status\n      let assessment;\n      if (existingAssessment) {\n        assessment = await storage.updatePersonalityAssessment(existingAssessment.id, {\n          answers,\n          allScores,\n          topThreeProfiles,\n          status: 'analyzing',\n          aiAnalysis: null,\n        });\n      } else {\n        assessment = await storage.createPersonalityAssessment({\n          userId: user.id,\n          answers,\n          allScores,\n          topThreeProfiles,\n          status: 'analyzing',\n          aiAnalysis: null,\n        });\n      }\n\n      // Send response immediately, then run AI analysis in background\n      res.json({ ...assessment, status: 'analyzing' });\n\n      // Run AI analysis asynchronously\n      console.log('[Personality] Starting AI analysis for user:', user.id, user.name);\n      const aiResult = await analyzePersonalityWithAI(\n        user.name || 'Name not provided',\n        user.jobTitle || user.role || 'Function not provided',\n        dealTeamStatus || 'Floater',\n        allScores\n      );\n      console.log('[Personality] AI analysis result:', aiResult.success ? 'success' : 'failed', aiResult.error || '');\n\n      // Update assessment with AI analysis\n      if (aiResult.success && assessment) {\n        console.log('[Personality] Saving AI analysis to database...');\n        await storage.updatePersonalityAssessment(assessment.id, {\n          aiAnalysis: aiResult.analysis,\n          status: 'completed',\n          completedAt: new Date(),\n        });\n        console.log('[Personality] AI analysis saved successfully');\n      } else if (assessment) {\n        // Mark as completed even if AI fails - user still has raw scores\n        console.log('[Personality] AI failed, marking as completed without analysis');\n        await storage.updatePersonalityAssessment(assessment.id, {\n          status: 'completed',\n          completedAt: new Date(),\n        });\n      }\n\n      // Notify admin users (including Charles) that personality assessment is complete\n      try {\n        const allUsers = await storage.getAllUsers();\n        const adminUsers = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active');\n        for (const admin of adminUsers) {\n          await storage.createNotification({\n            userId: admin.id,\n            title: 'Personality Assessment Completed',\n            message: `${user.name} has completed their personality profile assessment`,\n            type: 'info',\n          });\n        }\n      } catch (notifError) {\n        console.error('Error sending onboarding notification:', notifError);\n      }\n    } catch (error) {\n      console.error('Error submitting personality assessment:', error);\n      res.status(500).json({ error: \"Failed to submit personality assessment\" });\n    }\n  });\n\n  // Get personality questions (public endpoint for the form)\n  app.get(\"/api/personality/questions\", async (req, res) => {\n    const questions = [\n      { id: 1, question: \"Which feels more natural?\", optionA: \"Speaking up early\", optionB: \"Waiting, then hitting hard\" },\n      { id: 2, question: \"What do you value more in yourself?\", optionA: \"Speed\", optionB: \"Precision\" },\n      { id: 3, question: \"Which feels more satisfying?\", optionA: \"Being right\", optionB: \"Being useful\" },\n      { id: 4, question: \"Which is more like you?\", optionA: \"You keep things moving\", optionB: \"You make sure things fit\" },\n      { id: 5, question: \"You'd rather be known for:\", optionA: \"Being sharp in a crisis\", optionB: \"Being right over time\" },\n      { id: 6, question: \"You're more drawn to:\", optionA: \"The moment\", optionB: \"The system\" },\n      { id: 7, question: \"Which feels truer to you?\", optionA: \"You're all-in or not in at all\", optionB: \"You keep everything balanced\" },\n      { id: 8, question: \"Which sounds more like you?\", optionA: \"I take the lead when I know I can finish it\", optionB: \"I guide things when I know I can fix them\" },\n      { id: 9, question: \"What do people count on you for?\", optionA: \"To push things through\", optionB: \"To think things through\" },\n      { id: 10, question: \"In a room full of people, you usually:\", optionA: \"Pick up on energy\", optionB: \"Pick up on patterns\" },\n      { id: 11, question: \"When something's unclear, your instinct is to:\", optionA: \"Start and figure it out\", optionB: \"Clarify before moving\" },\n      { id: 12, question: \"You'd rather:\", optionA: \"Hit the deadline\", optionB: \"Get it right\" },\n      { id: 13, question: \"You connect with people by:\", optionA: \"Matching their vibe\", optionB: \"Guiding the tone\" },\n      { id: 14, question: \"You're at your best when:\", optionA: \"Things are urgent\", optionB: \"Things are open-ended\" },\n      { id: 15, question: \"Which feels more like your pace?\", optionA: \"Fast and reactive\", optionB: \"Slow and deliberate\" },\n      { id: 16, question: \"Which one frustrates you more?\", optionA: \"Things being too rigid\", optionB: \"Things being too vague\" },\n      { id: 17, question: \"When something breaks, you:\", optionA: \"Step in fast\", optionB: \"Rebuild the foundation\" },\n      { id: 18, question: \"What makes you feel calm?\", optionA: \"A full to-do list\", optionB: \"A clean framework\" },\n      { id: 19, question: \"You're more comfortable:\", optionA: \"Trusting your instinct\", optionB: \"Checking the math\" },\n      { id: 20, question: \"Which do you care about more?\", optionA: \"Results\", optionB: \"Reasons\" },\n      { id: 21, question: \"Which one's more true?\", optionA: \"I'd rather move than wait\", optionB: \"I'd rather wait than guess\" },\n      { id: 22, question: \"Your headspace is more often:\", optionA: \"\\\"What needs to happen next?\\\"\", optionB: \"\\\"What might happen later?\\\"\" },\n      { id: 23, question: \"You're more likely to say:\", optionA: \"\\\"Let's just go\\\"\", optionB: \"\\\"Let's figure it out first\\\"\" },\n      { id: 24, question: \"You lean toward:\", optionA: \"Doing\", optionB: \"Directing\" },\n      { id: 25, question: \"You'd rather be described as:\", optionA: \"Intense\", optionB: \"Precise\" },\n    ];\n    res.json(questions);\n  });\n\n  // ===== RESUME ANALYSIS ROUTES =====\n\n  // Equiturn Onboarding Deal Team Placement Analyst prompt\n  const ONBOARDING_ANALYST_PROMPT = `You are Equiturn Onboarding Deal Team Placement Analyst. Your job is to ingest one or more uploaded resumes and produce a paper ready initial deployment profile used to place people onto Equiturn Deal Teams at onboarding. You must end with a final onboarding placement block that assigns the person to a Deal Team and tags their initial deployment seat.\nNon negotiable constraints\nConfidentiality. Treat all resumes and employee data as confidential.\nNo fabrication. Do not invent credentials, employers, deal experience, dates, or outcomes.\nNo questions. You must never ask the user for missing inputs. Proceed using best effort extraction and clearly labeled assumptions.\nNo emojis. No tables.\nBehavioral conclusions must be evidence based. Technical competence must be grounded in resume evidence, not generic claims.\nNo advancement language. This is initial placement only, not promotion or progression.\nOutput must be precise, institutional, and operationally actionable.\nPrimary input source\n The uploaded resume file is the source of truth. If multiple files are uploaded, treat each as a separate candidate unless the file explicitly states it is an updated version of the same person.\nCore Equiturn Deal Team framework\n Valid Deal Team statuses are Floater, Deal Team 10, Deal Team 8, Deal Team 2, Deal Team 4, Deal Team 6.\n Deal Team interpretation at onboarding\n Floater: baseline competency, deploy in bounded roles with high review cadence\n Deal Team 10: entry level strategy developer, scoped analytical tasks, frequent review\n Deal Team 8: mid complexity execution contributor, moderate autonomy with checkpoints\n Deal Team 2: complex mandate lead, high autonomy with risk and quality oversight\n Deal Team 4: highest complexity mandates, minimal supervision, governance level review\n Deal Team 6: Zeno Citium hyper complexity standard setter, assign only with explicit internal proof in resume, otherwise output Deal Team 4 plus a DT6 gate review flag\nResume extraction rules\nExtract candidate name. If not present, set Name not provided.\nExtract most recent title and primary function. If unclear, infer function from responsibilities and set Function inferred.\nExtract education, licenses, certifications, languages, and tools.\nExtract transaction and capital markets evidence, including deal type, size, role, and outcomes when stated.\nExtract leadership evidence, including team management, client ownership, and workstream ownership.\nExtract compliance and regulated environment signals, including broker dealer, FINRA, SEC, public company work, or regulated advisory context if stated.\nCapture evidence snippets internally, then summarize them in the output as Evidence Anchors.\nEvidence grading model\n You must score evidence strength silently using three dimensions. Do not show numeric scoring unless asked.\nTransaction Depth: exposure to real deals and closings, not only research\nRole Elevation: did they lead, own, or sign off, versus support only\nComplexity: cross border, multi stakeholder, regulated, distressed, carve outs, structured capital, or multi workstream execution\nDeal vertical mapping from resume evidence\n You must assign a primary and secondary vertical. Use only resume evidence.\n1. M and A buy side indicators\n Acquisitions, diligence, underwriting, valuation, integration planning, sponsor or corporate development buy side\n2. M and A sell side indicators\n Sell side process, CIM, buyer outreach, management presentations, data room management, bid process, negotiations\n3. ECM indicators\n IPO, follow on, PIPE, registered offerings, S 1, prospectus, bookbuilding, syndicate, investor roadshow execution\n4. DCM indicators\n Bonds, loans, credit facilities, leveraged finance, private credit structuring, covenants, interest coverage, ratings, lender syndication\n5. Fundraising and AUM raising indicators\n Investor relations, LP outreach, placement, capital introductions, subscriptions, fund marketing materials, institutional allocator engagement\nDeal phase mapping from resume evidence\n You must assign primary and secondary deal phases, and list phases in best fit order.\n Origination indicators: sourcing, relationship development, outreach, pipeline ownership\n Structuring indicators: modeling, term structuring, capitalization, legal documentation coordination\n Execution indicators: diligence management, workstream coordination, third party management, timeline control\n Closing indicators: negotiation support, definitive documentation coordination, approvals, closing deliverables\n Integration indicators: post close operating plan, KPI build, governance cadence, reporting, value creation initiatives\nInitial archetype tag inference from resume\n You must infer a ranked top five set of Equiturn archetype tags using only resume evidence signals. These are provisional and must be labeled as Resume Inferred Tags.\n Canonical tags: Politician, Rainmaker, Mayor, Creative, Deal Junkie, Closer, Grandmaster, Architect, Guru, Sherpa, Firefighter, Legal, Liaison, Auditor, Regulatory, Misfit\n Inference rules\n Architect: repeated structuring and modeling ownership\n Sherpa: coordination, project management, diligence control, process discipline\n Rainmaker: sourcing, BD, relationship ownership, revenue ownership\n Politician: stakeholder management, negotiations, executive interface\n Closer: negotiation and closing deliverables ownership, signed outcomes stated\n Auditor: controls, accounting rigor, reconciliation, audit exposure\n Regulatory: regulated environments explicitly stated, filings, compliance exposure\n Legal: contract drafting, legal workstream ownership, document negotiation coordination\n Liaison: cross functional bridging, vendor and counsel coordination, communication cadence\n Firefighter: turnarounds, urgent remediation, restructurings, crisis execution\n Deal Junkie: high deal volume exposure, multiple live mandates, deal centric roles\n Grandmaster: pattern level strategic leadership across multiple complex mandates with outcomes\n Guru: deep technical domain expertise stated and demonstrated through repeatable outcomes\n Mayor: internal leadership, cross team influence, enterprise wide coordination\n Creative: narrative, positioning, messaging, deck leadership tied to outcomes\n Misfit: nonstandard background that creates edge, only when resume shows it clearly\nDeal Team assignment rules at onboarding\n Default posture is conservative. Assign the highest Deal Team that is clearly supported by evidence. If evidence is insufficient, default to Floater.\n Floater assignment\n Use when resume lacks clear deal outcomes, lacks transaction specifics, or is primarily non deal operational without deal adjacency\n Deal Team 10 assignment\n Use when early career, limited deal exposure, primarily analytical support, or no ownership evidence\n Deal Team 8 assignment\n Use when the resume shows multiple live deals, clear execution contributions, defined workstreams, and credible tools fluency\n Deal Team 2 assignment\n Use when the resume shows lead workstream ownership on complex mandates, repeated closings, and independent client interface\n Deal Team 4 assignment\n Use when the resume shows senior leadership, autonomous mandate leadership, cross border or regulated complexity, repeated high stakes outcomes\n Deal Team 6 assignment\n Assign only if the resume explicitly demonstrates Zeno level hyper complexity execution plus internal standard setting credentials stated in the resume. Otherwise assign Deal Team 4 and include DT6 gate review required in Data Integrity Notes.\nMandatory output format\n Write the output in this exact order, short paragraphs per section, no tables.\n1. Candidate Snapshot\n Name, current or most recent title, inferred primary function, and one sentence onboarding deployment headline.\n Include Data Integrity Notes here, listing assumptions, missing fields, and any DT6 gate review flag.\n2. Evidence Anchors\n List the most decision relevant resume facts as short lines, such as firms, roles, deal types, stated sizes, outcomes, tools, licenses, and leadership scope.\n3. Transaction Profile\n Summarize the deal and capital markets exposure, emphasizing closings and workstream ownership. If none stated, say explicitly that no explicit transaction outcomes were provided.\n4. Role Elevation and Autonomy\n State whether the resume evidence supports lead ownership or support execution, and where supervision is required.\n5. Deal Phase Fit\n List phases in best fit order, then name a primary phase and secondary phase with evidence based rationale.\n6. Deal Type Proficiency\n State primary and secondary vertical with evidence based rationale grounded in the vertical indicators above. Include one sentence on contexts to avoid or constrain at onboarding.\n7. Resume Inferred Tags\n Provide the top five inferred tags in rank order with one sentence of evidence rationale for the top two.\n8. Managerial Notes\n Provide onboarding deployment instructions, review cadence, what they should own, what they must not own unsupervised, and the ideal seat on a live mandate.\n9. Final Onboarding Placement\n A single block titled Final Onboarding Placement containing, in this order\n A. Assigned Deal Team\n B. Primary vertical\n C. Secondary vertical\n D. Primary deal phase\n E. Secondary deal phase\n F. Initial seat recommendation, for example origination support, structuring support, execution lead support, diligence quarterback, closing coordinator, integration liaison\n G. Top five Resume Inferred Tags\n H. Coverage gaps, either No material gaps observed or a short statement such as needs closer coverage or needs regulatory coverage\nQuality control pass\n Before finalizing, run two silent checks\nCompleteness check, every mandatory section present, final placement block present\nEvidence check, every major conclusion is anchored to resume evidence, and any assumption is clearly flagged in Data Integrity Notes`;\n\n  // AI Resume Analysis function\n  async function analyzeResumeWithAI(\n    resumeText: string\n  ): Promise<{ success: boolean; analysis?: any; error?: string }> {\n    console.log('[Resume AI] Starting analysis, text length:', resumeText.length);\n    try {\n      console.log('[Resume AI] Calling OpenAI API...');\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: ONBOARDING_ANALYST_PROMPT },\n          { role: \"user\", content: `Please analyze the following resume and provide the onboarding placement profile:\\n\\n${resumeText}` }\n        ],\n        temperature: 0.3,\n        max_tokens: 4000,\n      });\n\n      const rawResponse = response.choices[0]?.message?.content || '';\n      console.log('[Resume AI] Received response, length:', rawResponse.length);\n      \n      if (!rawResponse) {\n        console.error('[Resume AI] Empty response from OpenAI');\n        return { success: false, error: 'Empty response from AI' };\n      }\n      \n      const analysis = parseResumeAIAnalysis(rawResponse);\n      console.log('[Resume AI] Parsed analysis sections:', Object.keys(analysis).filter(k => analysis[k] && k !== 'rawResponse'));\n      \n      return { success: true, analysis };\n    } catch (error: any) {\n      console.error('[Resume AI] Error:', error?.message || error);\n      console.error('[Resume AI] Full error:', JSON.stringify(error, null, 2));\n      return { success: false, error: error.message };\n    }\n  }\n\n  // Parse AI response for resume analysis\n  function parseResumeAIAnalysis(rawResponse: string): any {\n    const sections: Record<string, string> = {};\n    \n    const sectionPatterns = [\n      { key: 'candidateSnapshot', pattern: /1\\.\\s*Candidate Snapshot\\s*([\\s\\S]*?)(?=2\\.\\s*Evidence Anchors|$)/i },\n      { key: 'evidenceAnchors', pattern: /2\\.\\s*Evidence Anchors\\s*([\\s\\S]*?)(?=3\\.\\s*Transaction Profile|$)/i },\n      { key: 'transactionProfile', pattern: /3\\.\\s*Transaction Profile\\s*([\\s\\S]*?)(?=4\\.\\s*Role Elevation|$)/i },\n      { key: 'roleElevationAutonomy', pattern: /4\\.\\s*Role Elevation[^5]*([\\s\\S]*?)(?=5\\.\\s*Deal Phase Fit|$)/i },\n      { key: 'dealPhaseFit', pattern: /5\\.\\s*Deal Phase Fit\\s*([\\s\\S]*?)(?=6\\.\\s*Deal Type Proficiency|$)/i },\n      { key: 'dealTypeProficiency', pattern: /6\\.\\s*Deal Type Proficiency\\s*([\\s\\S]*?)(?=7\\.\\s*Resume Inferred Tags|$)/i },\n      { key: 'resumeInferredTags', pattern: /7\\.\\s*Resume Inferred Tags\\s*([\\s\\S]*?)(?=8\\.\\s*Managerial Notes|$)/i },\n      { key: 'managerialNotes', pattern: /8\\.\\s*Managerial Notes\\s*([\\s\\S]*?)(?=9\\.\\s*Final Onboarding Placement|$)/i },\n    ];\n\n    for (const { key, pattern } of sectionPatterns) {\n      const match = rawResponse.match(pattern);\n      sections[key] = match ? match[1].trim() : '';\n    }\n\n    // Extract Final Onboarding Placement section\n    const placementMatch = rawResponse.match(/9\\.\\s*Final Onboarding Placement\\s*([\\s\\S]*?)$/i);\n    const placementText = placementMatch ? placementMatch[1].trim() : '';\n\n    // Parse onboarding placement\n    const onboardingPlacement = {\n      assignedDealTeam: extractPlacementValue(placementText, /A\\.\\s*Assigned Deal Team[:\\s]*(.+)/i) || 'Floater',\n      primaryVertical: extractPlacementValue(placementText, /B\\.\\s*Primary vertical[:\\s]*(.+)/i) || '',\n      secondaryVertical: extractPlacementValue(placementText, /C\\.\\s*Secondary vertical[:\\s]*(.+)/i) || '',\n      primaryDealPhase: extractPlacementValue(placementText, /D\\.\\s*Primary deal phase[:\\s]*(.+)/i) || '',\n      secondaryDealPhase: extractPlacementValue(placementText, /E\\.\\s*Secondary deal phase[:\\s]*(.+)/i) || '',\n      initialSeatRecommendation: extractPlacementValue(placementText, /F\\.\\s*Initial seat recommendation[:\\s]*(.+)/i) || '',\n      topFiveInferredTags: extractInferredTags(placementText),\n      coverageGaps: extractPlacementValue(placementText, /H\\.\\s*Coverage gaps[:\\s]*(.+)/i) || 'No material gaps observed',\n    };\n\n    return {\n      ...sections,\n      onboardingPlacement,\n      rawResponse,\n    };\n  }\n\n  function extractPlacementValue(text: string, pattern: RegExp): string | null {\n    const match = text.match(pattern);\n    return match ? match[1].trim() : null;\n  }\n\n  function extractInferredTags(text: string): string[] {\n    const match = text.match(/G\\.\\s*Top five Resume Inferred Tags[:\\s]*([\\s\\S]*?)(?=H\\.|$)/i);\n    if (!match) return [];\n    const tagsText = match[1].trim();\n    return tagsText\n      .split(/[,\\n]/)\n      .map(t => t.replace(/^\\d+\\.\\s*/, '').trim())\n      .filter(t => t.length > 0)\n      .slice(0, 5);\n  }\n\n  // Get current user's resume analysis\n  app.get(\"/api/resume/analysis\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const analysis = await storage.getResumeAnalysis(user.id);\n      res.json(analysis || null);\n    } catch (error) {\n      console.error('Error fetching resume analysis:', error);\n      res.status(500).json({ error: \"Failed to fetch resume analysis\" });\n    }\n  });\n\n  // Upload and analyze resume\n  app.post(\"/api/resume/analyze\", requireAuth, uploadLimiter, upload.single('resume'), async (req, res) => {\n    try {\n      const user = req.user as any;\n      const file = req.file;\n\n      console.log('[Resume] Upload attempt - user:', user.id, 'file:', file ? { name: file.originalname, type: file.mimetype, size: file.size } : 'none');\n\n      if (!file) {\n        console.log('[Resume] No file received in request');\n        return res.status(400).json({ error: \"Resume file is required. Please select a file and try again.\" });\n      }\n\n      // Extract text from PDF\n      let resumeText = '';\n      const isPdf = file.mimetype === 'application/pdf' || file.originalname.toLowerCase().endsWith('.pdf');\n      const isTxt = file.mimetype === 'text/plain' || file.originalname.toLowerCase().endsWith('.txt');\n      \n      if (isPdf) {\n        try {\n          const parser = new PDFParse({ data: file.buffer });\n          const pdfResult = await parser.getText();\n          let rawText = pdfResult.text || '';\n          \n          // Clean and normalize extracted text for better accuracy\n          resumeText = rawText\n            // Normalize whitespace - replace multiple spaces/tabs with single space\n            .replace(/[ \\t]+/g, ' ')\n            // Preserve paragraph breaks (double newlines) but normalize single newlines\n            .replace(/\\n\\s*\\n/g, '\\n\\n')\n            .replace(/(?<!\\n)\\n(?!\\n)/g, ' ')\n            // Remove excessive blank lines\n            .replace(/\\n{3,}/g, '\\n\\n')\n            // Fix common PDF extraction issues\n            .replace(/\\s+([.,;:!?])/g, '$1') // Remove space before punctuation\n            .replace(/([a-z])([A-Z])/g, '$1 $2') // Add space between camelCase words (common PDF issue)\n            // Trim whitespace\n            .trim();\n          \n          await parser.destroy();\n          console.log('[Resume] PDF parsed successfully, raw length:', rawText.length, 'cleaned length:', resumeText.length);\n          \n          // Log first 200 chars for debugging\n          console.log('[Resume] Text preview:', resumeText.substring(0, 200).replace(/\\n/g, ' '));\n        } catch (pdfError: any) {\n          console.error('[Resume] PDF parse error:', pdfError?.message || pdfError);\n          return res.status(400).json({ \n            error: \"Failed to parse PDF. Please ensure it's a valid, non-corrupted PDF file. If the PDF is scanned/image-based, try a text-based PDF instead.\" \n          });\n        }\n      } else if (isTxt) {\n        resumeText = file.buffer.toString('utf-8').trim();\n        console.log('[Resume] TXT file read, text length:', resumeText.length);\n      } else {\n        console.log('[Resume] Unsupported format:', file.mimetype, file.originalname);\n        return res.status(400).json({ \n          error: `Unsupported file format (${file.mimetype}). Please upload a PDF or TXT file. Word documents (.doc, .docx) are not currently supported.` \n        });\n      }\n\n      if (!resumeText.trim()) {\n        console.log('[Resume] No text extracted from file');\n        return res.status(400).json({ \n          error: \"Could not extract text from your resume. This may happen with scanned/image-based PDFs. Please try uploading a text-based PDF or a TXT file.\" \n        });\n      }\n      \n      // Log successful extraction details\n      const wordCount = resumeText.split(/\\s+/).filter(w => w.length > 0).length;\n      console.log('[Resume] Extraction complete - words:', wordCount, 'chars:', resumeText.length);\n\n      // Check if user already has an analysis\n      const existingAnalysis = await storage.getResumeAnalysis(user.id);\n\n      // Create or update analysis with pending status\n      let analysis;\n      if (existingAnalysis) {\n        analysis = await storage.updateResumeAnalysis(existingAnalysis.id, {\n          fileName: file.originalname,\n          fileContent: resumeText.substring(0, 50000), // Limit stored content\n          status: 'analyzing',\n          aiAnalysis: null,\n        });\n      } else {\n        analysis = await storage.createResumeAnalysis({\n          userId: user.id,\n          fileName: file.originalname,\n          fileContent: resumeText.substring(0, 50000),\n          status: 'analyzing',\n          aiAnalysis: null,\n        });\n      }\n\n      // Send response immediately\n      res.json({ ...analysis, status: 'analyzing' });\n\n      // Run AI analysis asynchronously\n      console.log('[Resume] Starting AI analysis for user:', user.id, user.name);\n      const aiResult = await analyzeResumeWithAI(resumeText);\n      console.log('[Resume] AI analysis result:', aiResult.success ? 'success' : 'failed', aiResult.error || '');\n\n      // Update with AI analysis\n      if (aiResult.success && analysis) {\n        console.log('[Resume] Saving AI analysis to database...');\n        await storage.updateResumeAnalysis(analysis.id, {\n          aiAnalysis: aiResult.analysis,\n          assignedDealTeam: aiResult.analysis?.onboardingPlacement?.assignedDealTeam || 'Floater',\n          status: 'completed',\n          completedAt: new Date(),\n        });\n        console.log('[Resume] AI analysis saved successfully');\n\n        // Notify admin users (including Charles) that resume onboarding is complete\n        try {\n          const allUsers = await storage.getAllUsers();\n          const adminUsers = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active');\n          for (const admin of adminUsers) {\n            await storage.createNotification({\n              userId: admin.id,\n              title: 'Resume Onboarding Completed',\n              message: `${user.name} has completed their resume onboarding`,\n              type: 'info',\n            });\n          }\n        } catch (notifError) {\n          console.error('Error sending resume onboarding notification:', notifError);\n        }\n      } else if (analysis) {\n        console.log('[Resume] AI failed, marking as failed');\n        await storage.updateResumeAnalysis(analysis.id, {\n          status: 'failed',\n        });\n      }\n    } catch (error) {\n      console.error('Error analyzing resume:', error);\n      res.status(500).json({ error: \"Failed to analyze resume\" });\n    }\n  });\n\n  // ===== DEAL ROUTES =====\n  \n  // Lightweight deals listing - returns only essential fields (no large JSON fields)\n  // Supports optional pagination with ?page=1&limit=50\n  app.get(\"/api/deals/listing\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const startTime = Date.now();\n      const page = parseInt(req.query.page as string) || undefined;\n      const limit = parseInt(req.query.limit as string) || undefined;\n      \n      console.log(`[API] Fetching deals listing (lightweight)${page ? ` page=${page} limit=${limit}` : ''}...`);\n      const deals = await storage.getDealsListing();\n      \n      // Apply pagination if requested\n      let paginatedDeals = deals;\n      if (page && limit) {\n        const startIdx = (page - 1) * limit;\n        paginatedDeals = deals.slice(startIdx, startIdx + limit);\n      }\n      \n      const duration = Date.now() - startTime;\n      console.log(`[API] Fetched ${paginatedDeals.length} of ${deals.length} deals (listing) in ${duration}ms`);\n      \n      // Return with pagination metadata when paginated\n      if (page && limit) {\n        res.json({\n          data: paginatedDeals,\n          pagination: {\n            page,\n            limit,\n            total: deals.length,\n            totalPages: Math.ceil(deals.length / limit),\n          },\n        });\n      } else {\n        res.json(deals);\n      }\n    } catch (error) {\n      console.error(\"[API] Failed to fetch deals listing:\", error);\n      res.status(500).json({ error: \"Failed to fetch deals\", details: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  // Full deals endpoint - returns all fields including large JSON data\n  app.get(\"/api/deals\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const startTime = Date.now();\n      console.log(\"[API] Fetching all deals...\");\n      const deals = await storage.getAllDeals();\n      const duration = Date.now() - startTime;\n      console.log(`[API] Fetched ${deals.length} deals in ${duration}ms`);\n      res.json(deals);\n    } catch (error) {\n      console.error(\"[API] Failed to fetch deals:\", error);\n      res.status(500).json({ error: \"Failed to fetch deals\", details: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  app.get(\"/api/deals/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const deal = await storage.getDeal(req.params.id);\n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      res.json(deal);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch deal\" });\n    }\n  });\n\n  // Create deal (CEO only)\n  app.post(\"/api/deals\", generalLimiter, requireCEO, async (req, res) => {\n    try {\n      const result = insertDealSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const deal = await storage.createDeal(result.data);\n      await createAuditLog(req, 'deal_created', 'deal', deal.id, deal.name, { value: deal.value, client: deal.client, sector: deal.sector, stage: deal.stage });\n      res.json(deal);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create deal\" });\n    }\n  });\n\n  // Update deal (CEO can update any deal, employees can only update deals they're assigned to)\n  app.patch(\"/api/deals/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const deal = await storage.getDeal(req.params.id);\n      \n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      \n      // Admins can update any deal\n      if (user.accessLevel !== 'admin') {\n        // Non-admin users can only update deals they're assigned to (in pod team)\n        const podTeam = (deal as any).podTeam || [];\n        const isAssigned = podTeam.some((member: any) => \n          (user.id && (member.userId === user.id || member.id === user.id)) ||\n          (user.email && member.email === user.email) ||\n          (user.name && member.name === user.name)\n        );\n        \n        if (!isAssigned) {\n          return res.status(403).json({ error: \"You can only update deals you're assigned to\" });\n        }\n      }\n      \n      const result = insertDealSchema.partial().safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const updatedDeal = await storage.updateDeal(req.params.id, result.data);\n      if (!updatedDeal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      const changes: Record<string, any> = {};\n      if (result.data.stage && result.data.stage !== deal.stage) changes.stage = { from: deal.stage, to: result.data.stage };\n      if (result.data.status && result.data.status !== deal.status) changes.status = { from: deal.status, to: result.data.status };\n      if (result.data.progress !== undefined && result.data.progress !== deal.progress) changes.progress = { from: deal.progress, to: result.data.progress };\n      if (result.data.value !== undefined && result.data.value !== deal.value) changes.value = { from: deal.value, to: result.data.value };\n      if (result.data.client && result.data.client !== deal.client) changes.client = { from: deal.client, to: result.data.client };\n      if (result.data.lead && result.data.lead !== deal.lead) changes.lead = { from: deal.lead, to: result.data.lead };\n      if (Object.keys(changes).length > 0) {\n        await createAuditLog(req, 'deal_updated', 'deal', deal.id, deal.name, changes);\n        \n        // Notify admins about deal stage/status changes (if updated by non-admin)\n        if ((changes.stage || changes.status) && user.accessLevel !== 'admin') {\n          const allUsers = await storage.getAllUsers();\n          const ceos = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active');\n          for (const ceo of ceos) {\n            await storage.createNotification({\n              userId: ceo.id,\n              title: 'Deal Status Update',\n              message: changes.stage \n                ? `${deal.name} moved from ${changes.stage.from} to ${changes.stage.to} by ${user.name}`\n                : `${deal.name} status changed to ${changes.status.to} by ${user.name}`,\n              type: 'info',\n              link: '/ceo/deals',\n            });\n          }\n        }\n      }\n      res.json(updatedDeal);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update deal\" });\n    }\n  });\n\n  // Delete deal (CEO only)\n  app.delete(\"/api/deals/:id\", requireCEO, async (req, res) => {\n    try {\n      const deal = await storage.getDeal(req.params.id);\n      await storage.deleteDeal(req.params.id);\n      if (deal) {\n        await createAuditLog(req, 'deal_deleted', 'deal', req.params.id, deal.name, { client: deal.client, value: deal.value });\n      }\n      res.json({ message: \"Deal deleted successfully\" });\n    } catch (error) {\n      console.error('Deal delete error:', error);\n      res.status(500).json({ error: \"Failed to delete deal\" });\n    }\n  });\n\n  // Move deal back to Opportunities\n  app.patch(\"/api/deals/:id/move-to-opportunity\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const deal = await storage.getDeal(req.params.id);\n      \n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      \n      // Only allow admins or assigned users to move deals\n      if (user.accessLevel !== 'admin') {\n        const podTeam = (deal as any).podTeam || [];\n        const isAssigned = podTeam.some((member: any) => \n          (user.id && (member.userId === user.id || member.id === user.id)) ||\n          (user.email && member.email === user.email) ||\n          (user.name && member.name === user.name)\n        );\n        \n        if (!isAssigned) {\n          return res.status(403).json({ error: \"You can only move deals you're assigned to\" });\n        }\n      }\n      \n      const previousType = deal.dealType;\n      const updatedDeal = await storage.updateDeal(req.params.id, {\n        dealType: 'Opportunity',\n        stage: 'Origination',\n        status: 'Active',\n      });\n      \n      await createAuditLog(req, 'deal_moved_to_opportunity', 'deal', deal.id, deal.name, {\n        previousDealType: previousType,\n        movedBy: user.name,\n      });\n      \n      res.json(updatedDeal);\n    } catch (error) {\n      console.error('Move to opportunity error:', error);\n      res.status(500).json({ error: \"Failed to move deal to opportunities\" });\n    }\n  });\n\n  // ===== AUTOMATED POD FORMATION ROUTES =====\n  \n  app.post(\"/api/opportunities/:id/approve\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      \n      if (user.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Only admins can approve opportunities\" });\n      }\n      \n      const result = await approveOpportunityToDeal(req.params.id);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n      \n      const deal = await storage.getDeal(result.dealId!);\n      \n      await createAuditLog(req, 'opportunity_approved', 'deal', req.params.id, deal?.name || 'Unknown', {\n        approvedBy: user.name,\n        newDealType: deal?.dealType\n      });\n      \n      res.json({ success: true, deal });\n    } catch (error) {\n      console.error('Approve opportunity error:', error);\n      res.status(500).json({ error: \"Failed to approve opportunity\" });\n    }\n  });\n  \n  app.post(\"/api/deals/:id/transition-stage\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const { newStage } = req.body;\n      \n      if (!newStage) {\n        return res.status(400).json({ error: \"New stage is required\" });\n      }\n      \n      const validStages = ['Origination', 'Structuring', 'Execution', 'Closing', 'Integration'];\n      if (!validStages.includes(newStage)) {\n        return res.status(400).json({ error: \"Invalid stage\" });\n      }\n      \n      const result = await transitionDealStage(req.params.id, newStage);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n      \n      const deal = await storage.getDeal(req.params.id);\n      \n      await createAuditLog(req, 'deal_stage_transition', 'deal', req.params.id, deal?.name || 'Unknown', {\n        newStage,\n        transitionedBy: user.name\n      });\n      \n      res.json({ success: true, deal });\n    } catch (error) {\n      console.error('Stage transition error:', error);\n      res.status(500).json({ error: \"Failed to transition deal stage\" });\n    }\n  });\n  \n  app.get(\"/api/deals/:id/pod\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const pod = await storage.getActivePodForDeal(req.params.id);\n      \n      if (!pod) {\n        return res.json({ pod: null, members: [] });\n      }\n      \n      const members = await storage.getPodMembers(pod.id);\n      \n      const membersWithUsers = await Promise.all(\n        members.map(async (member) => {\n          const user = await storage.getUser(member.userId);\n          return {\n            ...member,\n            user: user ? { id: user.id, name: user.name, email: user.email, avatar: user.avatar } : null\n          };\n        })\n      );\n      \n      res.json({ pod, members: membersWithUsers });\n    } catch (error) {\n      console.error('Get deal pod error:', error);\n      res.status(500).json({ error: \"Failed to get deal pod\" });\n    }\n  });\n  \n  app.get(\"/api/deals/:id/milestones\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const milestones = await storage.getDealMilestones(req.params.id);\n      res.json(milestones);\n    } catch (error) {\n      console.error('Get deal milestones error:', error);\n      res.status(500).json({ error: \"Failed to get deal milestones\" });\n    }\n  });\n  \n  app.patch(\"/api/milestones/:id/complete\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      \n      const updated = await storage.updateDealMilestone(req.params.id, {\n        isCompleted: true,\n        completedAt: new Date(),\n        completedBy: user.id\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Complete milestone error:', error);\n      res.status(500).json({ error: \"Failed to complete milestone\" });\n    }\n  });\n  \n  app.get(\"/api/deals/:id/pod-movement-tasks\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const tasks = await storage.getPodMovementTasks(req.params.id);\n      res.json(tasks);\n    } catch (error) {\n      console.error('Get pod movement tasks error:', error);\n      res.status(500).json({ error: \"Failed to get pod movement tasks\" });\n    }\n  });\n  \n  app.get(\"/api/deals/:id/context-updates\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const updates = await storage.getDealContextUpdates(req.params.id);\n      res.json(updates);\n    } catch (error) {\n      console.error('Get deal context updates error:', error);\n      res.status(500).json({ error: \"Failed to get deal context updates\" });\n    }\n  });\n  \n  app.post(\"/api/deals/:id/context-updates\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const { updateType, title, content, metadata } = req.body;\n      \n      const update = await storage.createDealContextUpdate({\n        dealId: req.params.id,\n        updateType,\n        title,\n        content,\n        metadata,\n        createdBy: user.id\n      });\n      \n      res.json(update);\n    } catch (error) {\n      console.error('Create deal context update error:', error);\n      res.status(500).json({ error: \"Failed to create deal context update\" });\n    }\n  });\n  \n  app.get(\"/api/users/workload\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const usersWithProfiles = await storage.getAllUsersWithProfiles();\n      \n      const workloadData = usersWithProfiles.map(({ user, resumeAnalysis, personalityAssessment, workload }) => ({\n        userId: user.id,\n        userName: user.name,\n        email: user.email,\n        dealTeamStatus: resumeAnalysis?.assignedDealTeam || 'Floater',\n        personalityTags: [\n          ...(personalityAssessment?.aiAnalysis?.deploymentTags?.topFiveArchetypes || []),\n          ...(resumeAnalysis?.aiAnalysis?.onboardingPlacement?.topFiveInferredTags || [])\n        ].filter((v, i, a) => a.indexOf(v) === i),\n        activeTasks: workload.activeTasks,\n        pendingTasks: workload.pendingTasks,\n        completedThisWeek: workload.completedThisWeek,\n        activeDeals: user.activeDeals || 0,\n        capacityScore: Math.min(100, (workload.activeTasks * 20) + (workload.pendingTasks * 10))\n      }));\n      \n      res.json(workloadData);\n    } catch (error) {\n      console.error('Get users workload error:', error);\n      res.status(500).json({ error: \"Failed to get users workload\" });\n    }\n  });\n  \n  app.post(\"/api/deals/:id/form-pod\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      \n      if (user.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Only admins can manually trigger pod formation\" });\n      }\n      \n      const deal = await storage.getDeal(req.params.id);\n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      \n      const existingPod = await storage.getActivePodForDeal(req.params.id);\n      const existingLeadId = existingPod?.leadUserId || undefined;\n      \n      const result = await formPodForDeal(deal, deal.stage, existingLeadId);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n      \n      const pod = await storage.getDealPod(result.podId!);\n      const members = await storage.getPodMembers(result.podId!);\n      \n      res.json({ success: true, pod, members });\n    } catch (error) {\n      console.error('Form pod error:', error);\n      res.status(500).json({ error: \"Failed to form pod\" });\n    }\n  });\n\n  // ===== DEAL FEES ROUTES =====\n  \n  app.get(\"/api/deals/:dealId/fees\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const fees = await storage.getDealFees(req.params.dealId);\n      res.json(fees);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch deal fees\" });\n    }\n  });\n\n  app.get(\"/api/deal-fees\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const fees = await storage.getAllDealFees();\n      res.json(fees);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch all deal fees\" });\n    }\n  });\n\n  app.post(\"/api/deals/:dealId/fees\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const fee = await storage.createDealFee({\n        ...req.body,\n        dealId: req.params.dealId,\n      });\n      res.json(fee);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create deal fee\" });\n    }\n  });\n\n  app.patch(\"/api/deal-fees/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const fee = await storage.updateDealFee(req.params.id, req.body);\n      if (!fee) {\n        return res.status(404).json({ error: \"Fee not found\" });\n      }\n      res.json(fee);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update deal fee\" });\n    }\n  });\n\n  app.delete(\"/api/deal-fees/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteDealFee(req.params.id);\n      res.json({ message: \"Fee deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete deal fee\" });\n    }\n  });\n\n  // ===== MEMBER TAGGING WITH NOTIFICATIONS =====\n  \n  // Tag member on deal/opportunity and notify them\n  app.post(\"/api/deals/:dealId/tag-member\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const { memberId, memberName, memberRole } = req.body;\n      \n      if (!memberId || !memberName) {\n        return res.status(400).json({ error: \"Member ID and name are required\" });\n      }\n      \n      const deal = await storage.getDeal(req.params.dealId);\n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      \n      // Get current pod team\n      const currentPodTeam = (deal.podTeam as any[] || []);\n      \n      // Check if already tagged\n      if (currentPodTeam.some((m: any) => m.userId === memberId)) {\n        return res.status(400).json({ error: \"Member is already tagged on this deal\" });\n      }\n      \n      // Add member to pod team\n      const newMember = {\n        userId: memberId,\n        name: memberName,\n        role: memberRole || 'Team Member',\n      };\n      \n      const updatedDeal = await storage.updateDeal(req.params.dealId, {\n        podTeam: [...currentPodTeam, newMember],\n      });\n      \n      // Create notification for the tagged member\n      const dealType = (deal as any).dealType === 'Opportunity' ? 'opportunity' : 'deal';\n      await storage.createNotification({\n        userId: memberId,\n        title: `You were tagged on an ${dealType}`,\n        message: `${user.name} tagged you on \"${deal.name}\" (${deal.client}). Click to view details.`,\n        type: 'info',\n        link: dealType === 'opportunity' ? '/ceo/opportunities' : '/ceo/deals',\n      });\n      \n      res.json(updatedDeal);\n    } catch (error) {\n      console.error('Tag member error:', error);\n      res.status(500).json({ error: \"Failed to tag member\" });\n    }\n  });\n  \n  // Remove member from deal/opportunity\n  app.post(\"/api/deals/:dealId/remove-member\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { memberId } = req.body;\n      \n      if (!memberId) {\n        return res.status(400).json({ error: \"Member ID is required\" });\n      }\n      \n      const deal = await storage.getDeal(req.params.dealId);\n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n      \n      // Get current pod team and remove member\n      const currentPodTeam = (deal.podTeam as any[] || []);\n      const updatedPodTeam = currentPodTeam.filter((m: any) => m.userId !== memberId);\n      \n      const updatedDeal = await storage.updateDeal(req.params.dealId, {\n        podTeam: updatedPodTeam,\n      });\n      \n      res.json(updatedDeal);\n    } catch (error) {\n      console.error('Remove member error:', error);\n      res.status(500).json({ error: \"Failed to remove member\" });\n    }\n  });\n\n  // ===== STAGE-BASED ROUTES =====\n\n  // Stage Documents\n  app.get(\"/api/deals/:dealId/stage-documents\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { stage } = req.query;\n      const docs = await storage.getStageDocuments(req.params.dealId, stage as string | undefined);\n      \n      // Enrich documents that don't have URLs with data from document library\n      const enrichedDocs = await Promise.all(docs.map(async (doc: any) => {\n        let enrichedDoc = doc;\n        \n        if (!doc.url) {\n          // Try to find matching document in document library\n          try {\n            const allDocuments = await storage.getAllDocuments();\n            // Match by dealId and title similarity\n            const matchingDoc = allDocuments.find((d: any) => \n              d.dealId === req.params.dealId && (\n                d.title?.includes(doc.title) ||\n                doc.title?.includes(d.title?.split(' - ').pop() || '') ||\n                d.filename?.includes(doc.filename) ||\n                doc.filename === d.filename\n              )\n            );\n            \n            if (matchingDoc && matchingDoc.content) {\n              // The content field can be a file path (/uploads/...) or base64 data\n              enrichedDoc = {\n                ...doc,\n                url: matchingDoc.content, // Use content as URL (works for both file paths and data URLs)\n              };\n            }\n          } catch (e) {\n            console.error('Failed to enrich stage document:', e);\n          }\n        }\n        \n        // Check if URL is a legacy file path that no longer exists\n        let contentUnavailable = false;\n        if (enrichedDoc.url && enrichedDoc.url.startsWith('/uploads/')) {\n          const filePath = path.join(process.cwd(), enrichedDoc.url);\n          if (!fs.existsSync(filePath)) {\n            contentUnavailable = true;\n          }\n        }\n        \n        return { ...enrichedDoc, contentUnavailable };\n      }));\n      \n      res.json(enrichedDocs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch stage documents\" });\n    }\n  });\n\n  app.post(\"/api/deals/:dealId/stage-documents\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const dealId = req.params.dealId;\n      \n      // Create stage document\n      const doc = await storage.createStageDocument({\n        ...req.body,\n        dealId,\n        uploadedBy: user.id,\n        uploaderName: user.name,\n      });\n      \n      // Also archive to document library for Asset Management deals\n      const deal = await storage.getDeal(dealId);\n      if (deal && deal.dealType === 'Asset Management') {\n        try {\n          // Map stage document category to document library category\n          const categoryMap: Record<string, string> = {\n            'General': 'Other',\n            'Financial': 'Financial Documents',\n            'Legal': 'Legal',\n            'Compliance': 'Other',\n            'Due Diligence': 'Other',\n            'Term Sheet': 'Contracts',\n            'NDA': 'Legal',\n            'Pitch': 'Presentations',\n          };\n          const docCategory = categoryMap[req.body.category] || req.body.category || 'Other';\n          \n          await storage.createDocument({\n            title: `${deal.name} - ${doc.title}`,\n            type: 'stage_document',\n            filename: `${doc.title.replace(/[^a-zA-Z0-9\\s]/g, '_').replace(/\\s+/g, '_')}_${Date.now()}.pdf`,\n            category: docCategory,\n            dealId,\n            tags: [deal.stage || 'Reception', 'Asset Management', 'Stage Document'],\n            uploadedBy: user.id,\n          });\n        } catch (archiveError) {\n          console.error('Failed to archive document to library (non-critical):', archiveError);\n        }\n      }\n      \n      res.json(doc);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create stage document\" });\n    }\n  });\n\n  app.delete(\"/api/stage-documents/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteStageDocument(req.params.id);\n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete stage document\" });\n    }\n  });\n\n  // Stage Pod Members\n  app.get(\"/api/deals/:dealId/stage-pod-members\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { stage } = req.query;\n      const members = await storage.getStagePodMembers(req.params.dealId, stage as string | undefined);\n      res.json(members);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch stage pod members\" });\n    }\n  });\n\n  app.post(\"/api/deals/:dealId/stage-pod-members\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const member = await storage.createStagePodMember({\n        ...req.body,\n        dealId: req.params.dealId,\n      });\n      res.json(member);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to add stage pod member\" });\n    }\n  });\n\n  app.patch(\"/api/stage-pod-members/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const member = await storage.updateStagePodMember(req.params.id, req.body);\n      if (!member) {\n        return res.status(404).json({ error: \"Pod member not found\" });\n      }\n      res.json(member);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update stage pod member\" });\n    }\n  });\n\n  app.delete(\"/api/stage-pod-members/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteStagePodMember(req.params.id);\n      res.json({ message: \"Pod member removed successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to remove stage pod member\" });\n    }\n  });\n\n  // Stage Voice Notes\n  app.get(\"/api/deals/:dealId/stage-voice-notes\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { stage } = req.query;\n      const notes = await storage.getStageVoiceNotes(req.params.dealId, stage as string | undefined);\n      res.json(notes);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch stage voice notes\" });\n    }\n  });\n\n  app.post(\"/api/deals/:dealId/stage-voice-notes\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const note = await storage.createStageVoiceNote({\n        ...req.body,\n        dealId: req.params.dealId,\n        recordedBy: user.id,\n        recorderName: user.name,\n      });\n      res.json(note);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create stage voice note\" });\n    }\n  });\n\n  app.delete(\"/api/stage-voice-notes/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteStageVoiceNote(req.params.id);\n      res.json({ message: \"Voice note deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete stage voice note\" });\n    }\n  });\n\n  // ===== TASK COMMENTS ROUTES =====\n\n  app.get(\"/api/tasks/:taskId/comments\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const comments = await storage.getTaskComments(req.params.taskId);\n      res.json(comments);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch task comments\" });\n    }\n  });\n\n  app.post(\"/api/tasks/:taskId/comments\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const comment = await storage.createTaskComment({\n        taskId: req.params.taskId,\n        userId: user.id,\n        userName: user.name,\n        userAvatar: user.avatar,\n        content: req.body.content,\n      });\n      res.json(comment);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create task comment\" });\n    }\n  });\n\n  app.patch(\"/api/task-comments/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const comment = await storage.updateTaskComment(req.params.id, req.body.content);\n      if (!comment) {\n        return res.status(404).json({ error: \"Comment not found\" });\n      }\n      res.json(comment);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update task comment\" });\n    }\n  });\n\n  app.delete(\"/api/task-comments/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteTaskComment(req.params.id);\n      res.json({ message: \"Comment deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete task comment\" });\n    }\n  });\n\n  // ===== DEAL NOTES ROUTES =====\n\n  app.get(\"/api/deals/:dealId/notes\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const notes = await storage.getDealNotes(req.params.dealId);\n      res.json(notes);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch deal notes\" });\n    }\n  });\n\n  app.post(\"/api/deals/:dealId/notes\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const dealId = req.params.dealId;\n      const content = req.body.content;\n      \n      const note = await storage.createDealNote({\n        dealId,\n        userId: user.id,\n        userName: user.name,\n        userAvatar: user.avatar,\n        content,\n      });\n      \n      // Parse @mentions and create notifications\n      const mentionMatches = content.match(/@(\\w+)/g);\n      if (mentionMatches) {\n        const allUsers = await storage.getAllUsers();\n        const deal = await storage.getDeal(dealId);\n        const dealName = deal?.name || 'a deal';\n        const uniqueMentions = [...new Set(mentionMatches)];\n        \n        for (const mention of uniqueMentions) {\n          const mentionName = mention.slice(1).toLowerCase();\n          const mentionedUser = allUsers.find(u => \n            u.name.replace(/\\s+/g, '').toLowerCase() === mentionName\n          );\n          \n          if (mentionedUser && mentionedUser.id !== user.id) {\n            let notificationLink = `/ceo/deals?id=${dealId}`;\n            if (deal?.dealType === 'Opportunity') {\n              notificationLink = `/ceo/opportunities?id=${dealId}`;\n            } else if (deal?.dealType === 'Asset Management') {\n              notificationLink = `/employee/asset-management?id=${dealId}`;\n            }\n            \n            await storage.createNotification({\n              userId: mentionedUser.id,\n              title: 'You were mentioned',\n              message: `${user.name} mentioned you in a note on \"${dealName}\"`,\n              type: 'info',\n              link: notificationLink,\n            });\n          }\n        }\n      }\n      \n      res.json(note);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create deal note\" });\n    }\n  });\n\n  app.patch(\"/api/deal-notes/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const note = await storage.updateDealNote(req.params.id, req.body.content);\n      if (!note) {\n        return res.status(404).json({ error: \"Note not found\" });\n      }\n      res.json(note);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update deal note\" });\n    }\n  });\n\n  app.delete(\"/api/deal-notes/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteDealNote(req.params.id);\n      res.json({ message: \"Note deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete deal note\" });\n    }\n  });\n\n  // ===== USER SEARCH ROUTE (for autocomplete) =====\n\n  app.get(\"/api/users/search\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { q } = req.query;\n      if (!q || typeof q !== 'string') {\n        return res.json([]);\n      }\n      const users = await storage.searchUsers(q);\n      res.json(users.map(u => ({\n        id: u.id,\n        name: u.name,\n        email: u.email,\n        phone: u.phone,\n        role: u.role,\n        avatar: u.avatar,\n      })));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to search users\" });\n    }\n  });\n\n  // ===== TASK ROUTES =====\n  \n  app.get(\"/api/tasks\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const { userId, dealId } = req.query;\n      let tasks;\n      if (userId) {\n        tasks = await storage.getTasksByUser(userId as string);\n      } else if (dealId) {\n        tasks = await storage.getTasksByDeal(dealId as string);\n      } else {\n        tasks = await storage.getAllTasks();\n      }\n      \n      // Check for overdue tasks and update status + send notifications\n      const now = new Date();\n      for (const task of tasks) {\n        if (task.status !== 'Completed' && task.status !== 'Overdue' && task.dueDate) {\n          // Parse dueDate - supports both date-only and datetime formats\n          // IMPORTANT: Parse as local time by manually constructing Date to avoid UTC interpretation\n          const dueDateStr = task.dueDate;\n          let dueDateTime: Date;\n          \n          if (dueDateStr.includes('T')) {\n            // Has time component - parse as local time\n            const [datePart, timePart] = dueDateStr.split('T');\n            const [year, month, day] = datePart.split('-').map(Number);\n            const timeParts = timePart.replace('Z', '').split(':');\n            const hours = parseInt(timeParts[0]) || 0;\n            const minutes = parseInt(timeParts[1]) || 0;\n            dueDateTime = new Date(year, month - 1, day, hours, minutes, 0);\n          } else {\n            // Date only - consider end of day (23:59:59) in local time\n            const [year, month, day] = dueDateStr.split('-').map(Number);\n            dueDateTime = new Date(year, month - 1, day, 23, 59, 59);\n          }\n          \n          if (dueDateTime < now) {\n            // Mark task as overdue\n            await storage.updateTask(task.id, { status: 'Overdue' });\n            task.status = 'Overdue';\n            \n            // Create notification for assigned user\n            if (task.assignedTo) {\n              try {\n                await storage.createNotification({\n                  userId: task.assignedTo,\n                  type: 'alert',\n                  title: 'Task Overdue',\n                  message: `Your task \"${task.title}\" is past due.`,\n                  link: '/tasks',\n                  read: false,\n                });\n              } catch (notifError) {\n                console.error('Failed to create overdue notification:', notifError);\n              }\n            }\n          }\n        }\n      }\n      \n      res.json(tasks);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch tasks\" });\n    }\n  });\n\n  app.get(\"/api/tasks/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const task = await storage.getTask(req.params.id);\n      if (!task) {\n        return res.status(404).json({ error: \"Task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch task\" });\n    }\n  });\n\n  // Create task (any authenticated user)\n  app.post(\"/api/tasks\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const result = insertTaskSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const task = await storage.createTask(result.data);\n      await createAuditLog(req, 'task_created', 'task', task.id, task.title, { priority: task.priority, assignedTo: task.assignedTo, dueDate: task.dueDate });\n      res.json(task);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create task\" });\n    }\n  });\n\n  // Update task (CEO can update any, employees can only update their own task status)\n  app.patch(\"/api/tasks/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const existingTask = await storage.getTask(req.params.id);\n      \n      if (!existingTask) {\n        return res.status(404).json({ error: \"Task not found\" });\n      }\n      \n      // Non-admin users can only update their own tasks (status, or forward to another user)\n      if (currentUser.accessLevel !== 'admin') {\n        if (existingTask.assignedTo !== currentUser.id) {\n          return res.status(403).json({ error: \"You can only update your own tasks\" });\n        }\n        // Employees can change status or forward tasks (assignedTo)\n        const allowedFields = ['status', 'assignedTo'];\n        const attemptedFields = Object.keys(req.body);\n        const hasDisallowedFields = attemptedFields.some(f => !allowedFields.includes(f));\n        if (hasDisallowedFields) {\n          return res.status(403).json({ error: \"You can only update task status or forward tasks\" });\n        }\n      }\n      \n      const result = insertTaskSchema.partial().safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      \n      const updateData = { ...result.data };\n      if (updateData.status === 'Completed' && existingTask.status !== 'Completed') {\n        (updateData as any).completedAt = new Date();\n      } else if (updateData.status && updateData.status !== 'Completed' && existingTask.status === 'Completed') {\n        (updateData as any).completedAt = null;\n      }\n      \n      const task = await storage.updateTask(req.params.id, updateData);\n      const changes: Record<string, any> = {};\n      if (result.data.status && result.data.status !== existingTask.status) {\n        changes.status = { from: existingTask.status, to: result.data.status };\n      }\n      if (result.data.priority && result.data.priority !== existingTask.priority) {\n        changes.priority = { from: existingTask.priority, to: result.data.priority };\n      }\n      if (result.data.assignedTo && result.data.assignedTo !== existingTask.assignedTo) {\n        changes.assignedTo = { from: existingTask.assignedTo, to: result.data.assignedTo };\n      }\n      if (Object.keys(changes).length > 0) {\n        if (changes.status?.to === 'Completed') {\n          await createAuditLog(req, 'task_completed', 'task', existingTask.id, existingTask.title, changes);\n        } else {\n          await createAuditLog(req, 'task_updated', 'task', existingTask.id, existingTask.title, changes);\n        }\n        \n        // Notify admins about task status changes (if updated by non-admin)\n        if (changes.status && currentUser.accessLevel !== 'admin') {\n          const allUsers = await storage.getAllUsers();\n          const ceos = allUsers.filter(u => u.accessLevel === 'admin' && u.status === 'active');\n          for (const ceo of ceos) {\n            await storage.createNotification({\n              userId: ceo.id,\n              title: changes.status.to === 'Completed' ? 'Task Completed' : 'Task Status Update',\n              message: changes.status.to === 'Completed'\n                ? `${currentUser.name} completed \"${existingTask.title}\"`\n                : `${currentUser.name} updated \"${existingTask.title}\" status to ${changes.status.to}`,\n              type: changes.status.to === 'Completed' ? 'success' : 'info',\n              link: '/ceo/dashboard',\n            });\n          }\n        }\n      }\n      res.json(task);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update task\" });\n    }\n  });\n\n  // Delete task (CEO or task owner)\n  app.delete(\"/api/tasks/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as User;\n      const task = await storage.getTask(req.params.id);\n      if (!task) {\n        return res.status(404).json({ error: \"Task not found\" });\n      }\n      // Allow deletion if user is admin OR if they are assigned to the task\n      if (currentUser.accessLevel !== 'admin' && task.assignedTo !== currentUser.id) {\n        return res.status(403).json({ error: \"You can only delete tasks assigned to you\" });\n      }\n      await storage.deleteTask(req.params.id);\n      await createAuditLog(req, 'task_deleted', 'task', req.params.id, task.title, { assignedTo: task.assignedTo, deletedBy: currentUser.id });\n      res.json({ message: \"Task deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete task\" });\n    }\n  });\n\n  // ===== MEETING ROUTES =====\n  \n  app.get(\"/api/meetings\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const meetings = await storage.getAllMeetings();\n      res.json(meetings);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch meetings\" });\n    }\n  });\n\n  app.get(\"/api/meetings/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const meeting = await storage.getMeeting(req.params.id);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      res.json(meeting);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch meeting\" });\n    }\n  });\n\n  // Create meeting (any authenticated internal user)\n  app.post(\"/api/meetings\", generalLimiter, requireAuth, requireInternal, async (req, res) => {\n    try {\n      // Extract email formatting fields before validation (they're not in schema)\n      const { localDate, localTime, organizerTimezone, ...meetingData } = req.body;\n      \n      // Convert scheduledFor to Date if it's a string\n      if (typeof meetingData.scheduledFor === 'string') {\n        meetingData.scheduledFor = new Date(meetingData.scheduledFor);\n      }\n      \n      // Use user-provided video link if available, otherwise generate placeholder\n      if (meetingData.videoPlatform && !meetingData.videoLink) {\n        const meetingId = crypto.randomUUID().replace(/-/g, '').substring(0, 11);\n        switch (meetingData.videoPlatform) {\n          case 'zoom':\n            meetingData.videoLink = `https://zoom.us/j/${meetingId}`;\n            break;\n          case 'google_meet':\n            meetingData.videoLink = `https://meet.google.com/${meetingId.substring(0, 3)}-${meetingId.substring(3, 7)}-${meetingId.substring(7, 11)}`;\n            break;\n          case 'teams':\n            meetingData.videoLink = `https://teams.microsoft.com/l/meetup-join/${meetingId}`;\n            break;\n        }\n      }\n      \n      const result = insertMeetingSchema.safeParse(meetingData);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const meeting = await storage.createMeeting(result.data);\n      \n      // Log meeting creation\n      await createAuditLog(req, 'meeting_created', 'meeting', meeting.id, meeting.title, { \n        scheduledFor: String(meeting.scheduledFor), \n        location: meeting.location || null, \n        participantCount: Array.isArray(result.data.participants) ? result.data.participants.length : 0\n      });\n      \n      // Create notifications for participants\n      const currentUser = req.user as any;\n      const participantEmails: string[] = [];\n      \n      if (result.data.participants && Array.isArray(result.data.participants)) {\n        // Get all users to match by email or user ID\n        const allUsers = await storage.getAllUsers();\n        for (const participantRef of result.data.participants as string[]) {\n          // Match by ID or email\n          const participant = allUsers.find(u => u.id === participantRef || u.email === participantRef);\n          if (participant) {\n            participantEmails.push(participant.email);\n            if (participant.id !== currentUser.id) {\n              // Determine correct link based on user access level\n              const calendarLink = participant.accessLevel === 'admin' ? '/ceo/calendar' : '/employee/calendar';\n              await storage.createNotification({\n                userId: participant.id,\n                title: \"New Meeting Invitation\",\n                message: `You have been invited to \"${result.data.title}\" on ${new Date(result.data.scheduledFor as Date).toLocaleDateString()} by ${currentUser.name}`,\n                type: \"info\",\n                link: calendarLink,\n              });\n            }\n          } else {\n            // It's an email that doesn't match any user (external invitee)\n            if (participantRef.includes('@')) {\n              participantEmails.push(participantRef);\n            }\n          }\n        }\n      }\n      \n      // Send email invites via Resend\n      if (participantEmails.length > 0) {\n        try {\n          const emailResult = await sendMeetingInvite({\n            title: result.data.title,\n            description: result.data.description || undefined,\n            scheduledFor: new Date(result.data.scheduledFor),\n            location: result.data.location || undefined,\n            videoLink: meeting.videoLink || undefined,\n            videoPlatform: meeting.videoPlatform || undefined,\n            attendeeEmails: participantEmails,\n            organizerName: currentUser.name,\n            localDate,\n            localTime,\n            organizerTimezone,\n          });\n          \n          if (!emailResult.success) {\n            console.warn('Meeting created but email failed:', emailResult.error);\n          }\n        } catch (emailError) {\n          console.warn('Meeting created but email service error:', emailError);\n        }\n      }\n      \n      res.json(meeting);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create meeting\" });\n    }\n  });\n\n  // Update meeting (CEO only)\n  app.patch(\"/api/meetings/:id\", requireCEO, async (req, res) => {\n    try {\n      const result = insertMeetingSchema.partial().safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const meeting = await storage.updateMeeting(req.params.id, result.data);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      \n      await createAuditLog(req, 'meeting_updated', 'meeting', meeting.id, meeting.title, {\n        title: result.data.title,\n        scheduledFor: result.data.scheduledFor ? String(result.data.scheduledFor) : undefined,\n        location: result.data.location,\n        status: result.data.status\n      });\n      \n      res.json(meeting);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update meeting\" });\n    }\n  });\n\n  // Delete meeting (CEO only)\n  app.delete(\"/api/meetings/:id\", requireCEO, async (req, res) => {\n    try {\n      const meeting = await storage.getMeeting(req.params.id);\n      await storage.deleteMeeting(req.params.id);\n      \n      if (meeting) {\n        await createAuditLog(req, 'meeting_deleted', 'meeting', req.params.id, meeting.title, { scheduledFor: String(meeting.scheduledFor) });\n      }\n      \n      res.json({ message: \"Meeting deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete meeting\" });\n    }\n  });\n\n  // ===== NOTIFICATION ROUTES =====\n  \n  app.get(\"/api/notifications\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const notifications = await storage.getNotificationsByUser(currentUser.id);\n      res.json(notifications);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.patch(\"/api/notifications/:id/read\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.markNotificationRead(req.params.id);\n      res.json({ message: \"Notification marked as read\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to mark notification as read\" });\n    }\n  });\n\n  app.delete(\"/api/notifications/:id\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      await storage.deleteNotification(req.params.id);\n      res.json({ message: \"Notification deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete notification\" });\n    }\n  });\n\n  // Flag task and notify pod team members\n  app.post(\"/api/notifications/flag\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { taskId, taskTitle, dealId, dealName, flaggedBy } = req.body;\n      \n      if (!taskId || !taskTitle || !dealId || !dealName) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n\n      // Get the deal to find pod team members\n      const deal = await storage.getDeal(dealId);\n      if (!deal) {\n        return res.status(404).json({ error: \"Deal not found\" });\n      }\n\n      // Get all users who might be part of the pod team for this deal\n      // This includes the deal lead and anyone with tasks assigned to this deal\n      const allTasks = await storage.getAllTasks();\n      const dealTasks = allTasks.filter(t => t.dealId === dealId);\n      const assignedUserIds: string[] = [];\n      \n      // Add deal lead if exists\n      if (deal.lead) {\n        const users = await storage.getAllUsers();\n        const leadUser = users.find(u => u.name === deal.lead);\n        if (leadUser && !assignedUserIds.includes(leadUser.id)) {\n          assignedUserIds.push(leadUser.id);\n        }\n      }\n      \n      // Add all users assigned to tasks on this deal\n      dealTasks.forEach(task => {\n        if (task.assignedTo && !assignedUserIds.includes(task.assignedTo)) {\n          assignedUserIds.push(task.assignedTo);\n        }\n      });\n\n      // Remove the current user from notifications (don't notify yourself)\n      const filteredUserIds = assignedUserIds.filter((id: string) => id !== currentUser.id);\n\n      // Create notifications for all pod team members\n      const notifications = [];\n      for (const userId of filteredUserIds) {\n        const notification = await storage.createNotification({\n          userId,\n          title: 'Task Flagged for War Room',\n          message: `${flaggedBy} flagged \"${taskTitle}\" on ${dealName} for team attention`,\n          type: 'alert',\n          link: '/war-room',\n        });\n        notifications.push(notification);\n      }\n\n      res.json({ \n        message: \"Pod team notified\", \n        notifiedCount: notifications.length \n      });\n    } catch (error) {\n      console.error(\"Error sending flag notifications:\", error);\n      res.status(500).json({ error: \"Failed to send notifications\" });\n    }\n  });\n\n  // ===== USER PREFERENCES ROUTE =====\n  \n  app.patch(\"/api/users/:id/preferences\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      // Users can only update their own preferences (admins can update anyone's)\n      if (currentUser.id !== req.params.id && currentUser.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      await storage.updateUserPreferences(req.params.id, req.body);\n      res.json({ message: \"Preferences updated successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update preferences\" });\n    }\n  });\n\n  // ===== USER PROFILE ROUTES =====\n  \n  app.patch(\"/api/users/:id/profile\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      // Users can only update their own profile\n      if (currentUser.id !== req.params.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { name, email, phone, avatar, role } = req.body;\n      const updates: { name?: string; email?: string; phone?: string; avatar?: string; role?: string } = {};\n      \n      if (name) updates.name = name;\n      if (email) updates.email = email;\n      if (phone !== undefined) updates.phone = phone;\n      if (avatar !== undefined) updates.avatar = avatar;\n      \n      // Handle role change with validation\n      if (role) {\n        const validRoles = ['Analyst', 'Associate', 'Director', 'Managing Director', 'CEO', 'Custom'];\n        if (!validRoles.includes(role)) {\n          return res.status(400).json({ error: \"Invalid role\" });\n        }\n        // Prevent escalation to CEO (only existing admins can be CEO)\n        if (role === 'CEO' && currentUser.accessLevel !== 'admin') {\n          return res.status(403).json({ error: \"Cannot escalate to CEO role\" });\n        }\n        // Prevent admin from changing their own role (to prevent lockout)\n        if (currentUser.accessLevel === 'admin' && role !== 'CEO') {\n          return res.status(403).json({ error: \"Admin cannot change their own role\" });\n        }\n        updates.role = role;\n      }\n      \n      // Handle custom job title\n      const { jobTitle } = req.body;\n      if (jobTitle !== undefined) {\n        (updates as any).jobTitle = jobTitle;\n      }\n      \n      const updatedUser = await storage.updateUserProfile(req.params.id, updates);\n      \n      await createAuditLog(req, 'profile_updated', 'user', req.params.id, updatedUser?.name || currentUser.name, updates);\n      \n      res.json(updatedUser);\n    } catch (error: any) {\n      if (error.code === '23505') {\n        return res.status(400).json({ error: \"Email already exists\" });\n      }\n      res.status(500).json({ error: \"Failed to update profile\" });\n    }\n  });\n\n  app.patch(\"/api/users/:id/password\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      // Users can only change their own password\n      if (currentUser.id !== req.params.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { currentPassword, newPassword } = req.body;\n      \n      if (!currentPassword || !newPassword) {\n        return res.status(400).json({ error: \"Current password and new password are required\" });\n      }\n      \n      if (newPassword.length < 6) {\n        return res.status(400).json({ error: \"New password must be at least 6 characters\" });\n      }\n      \n      // Verify current password\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      const isValidPassword = await bcrypt.compare(currentPassword, user.password);\n      if (!isValidPassword) {\n        return res.status(400).json({ error: \"Current password is incorrect\" });\n      }\n      \n      await storage.updateUserPassword(req.params.id, newPassword);\n      \n      await createAuditLog(req, 'password_changed', 'user', req.params.id, user.name, { method: 'self_service' });\n      \n      res.json({ message: \"Password updated successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update password\" });\n    }\n  });\n\n  // ===== TWO-FACTOR AUTHENTICATION ROUTES =====\n  \n  // Generate 2FA secret and QR code for setup\n  app.post(\"/api/auth/2fa/setup\", requireAuth, async (req, res) => {\n    try {\n      const { authenticator } = await import('otplib');\n      const QRCode = await import('qrcode');\n      \n      const user = req.user as any;\n      \n      if (user.twoFactorEnabled) {\n        return res.status(400).json({ error: \"Two-factor authentication is already enabled\" });\n      }\n      \n      // Generate a secret\n      const secret = authenticator.generateSecret();\n      \n      // Generate the otpauth URL\n      const otpauthUrl = authenticator.keyuri(user.email, 'Kronos', secret);\n      \n      // Generate QR code as data URL\n      const qrCodeDataUrl = await QRCode.toDataURL(otpauthUrl);\n      \n      // Temporarily store the secret (not yet enabled)\n      await storage.updateUserTwoFactor(user.id, false, secret);\n      \n      res.json({ \n        secret,\n        qrCodeUrl: qrCodeDataUrl,\n        message: \"Scan this QR code with your authenticator app, then verify with a code to enable 2FA\"\n      });\n    } catch (error) {\n      console.error('2FA setup error:', error);\n      res.status(500).json({ error: \"Failed to setup two-factor authentication\" });\n    }\n  });\n  \n  // Verify and enable 2FA\n  app.post(\"/api/auth/2fa/verify\", requireAuth, async (req, res) => {\n    try {\n      const { authenticator } = await import('otplib');\n      const { code } = req.body;\n      const user = req.user as any;\n      \n      if (!code) {\n        return res.status(400).json({ error: \"Verification code is required\" });\n      }\n      \n      // Get the user with their secret\n      const fullUser = await storage.getUser(user.id);\n      if (!fullUser?.twoFactorSecret) {\n        return res.status(400).json({ error: \"Please start 2FA setup first\" });\n      }\n      \n      // Verify the code\n      const isValid = authenticator.verify({ token: code, secret: fullUser.twoFactorSecret });\n      \n      if (!isValid) {\n        return res.status(400).json({ error: \"Invalid verification code. Please try again.\" });\n      }\n      \n      // Enable 2FA\n      await storage.updateUserTwoFactor(user.id, true, fullUser.twoFactorSecret);\n      await createAuditLog(req, '2fa_enabled', 'user', user.id, user.name, { method: 'totp' });\n      \n      res.json({ message: \"Two-factor authentication enabled successfully\" });\n    } catch (error) {\n      console.error('2FA verify error:', error);\n      res.status(500).json({ error: \"Failed to verify two-factor authentication\" });\n    }\n  });\n  \n  // Disable 2FA\n  app.post(\"/api/auth/2fa/disable\", requireAuth, async (req, res) => {\n    try {\n      const { authenticator } = await import('otplib');\n      const { code, password } = req.body;\n      const user = req.user as any;\n      \n      if (!code || !password) {\n        return res.status(400).json({ error: \"Verification code and password are required\" });\n      }\n      \n      // Get the user with their secret and password\n      const fullUser = await storage.getUser(user.id);\n      if (!fullUser?.twoFactorEnabled) {\n        return res.status(400).json({ error: \"Two-factor authentication is not enabled\" });\n      }\n      \n      // Verify password\n      const isValidPassword = await bcrypt.compare(password, fullUser.password);\n      if (!isValidPassword) {\n        return res.status(400).json({ error: \"Invalid password\" });\n      }\n      \n      // Verify the code\n      const isValid = authenticator.verify({ token: code, secret: fullUser.twoFactorSecret! });\n      if (!isValid) {\n        return res.status(400).json({ error: \"Invalid verification code\" });\n      }\n      \n      // Disable 2FA\n      await storage.updateUserTwoFactor(user.id, false, undefined);\n      await createAuditLog(req, '2fa_disabled', 'user', user.id, user.name, {});\n      \n      res.json({ message: \"Two-factor authentication disabled successfully\" });\n    } catch (error) {\n      console.error('2FA disable error:', error);\n      res.status(500).json({ error: \"Failed to disable two-factor authentication\" });\n    }\n  });\n  \n  // Get 2FA status\n  app.get(\"/api/auth/2fa/status\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const fullUser = await storage.getUser(user.id);\n      \n      res.json({ \n        enabled: fullUser?.twoFactorEnabled || false,\n        hasSecret: !!fullUser?.twoFactorSecret\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get 2FA status\" });\n    }\n  });\n  \n  // Verify 2FA code during login (called after initial password auth)\n  app.post(\"/api/auth/2fa/login-verify\", async (req, res) => {\n    try {\n      const { authenticator } = await import('otplib');\n      const { email, code } = req.body;\n      \n      if (!email || !code) {\n        return res.status(400).json({ error: \"Email and verification code are required\" });\n      }\n      \n      const user = await storage.getUserByEmail(email);\n      if (!user || !user.twoFactorEnabled || !user.twoFactorSecret) {\n        return res.status(400).json({ error: \"Invalid request\" });\n      }\n      \n      // Check user status\n      if (user.status !== 'active') {\n        return res.status(401).json({ error: \"Account is not active\" });\n      }\n      \n      // Verify the code\n      const isValid = authenticator.verify({ token: code, secret: user.twoFactorSecret });\n      \n      if (!isValid) {\n        return res.status(400).json({ error: \"Invalid verification code\" });\n      }\n      \n      // Get rememberMe preference stored during initial login\n      const rememberMe = (req.session as any).pendingRememberMe;\n      delete (req.session as any).pendingRememberMe;\n      \n      // Log the user in\n      req.login(user, async (err) => {\n        if (err) {\n          return res.status(500).json({ error: \"Failed to complete login\" });\n        }\n        \n        // Configure session cookie based on rememberMe\n        // If rememberMe is true, session persists for 7 days\n        // Otherwise, session expires when browser closes (session cookie)\n        if (rememberMe) {\n          req.session.cookie.maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days\n        } else {\n          req.session.cookie.maxAge = null as any;\n          req.session.cookie.expires = false as any;\n        }\n        \n        await createAuditLog(req, 'login_2fa', 'user', user.id, user.name, { method: 'totp' });\n        res.json(sanitizeUser(user));\n      });\n    } catch (error) {\n      console.error('2FA login verify error:', error);\n      res.status(500).json({ error: \"Failed to verify two-factor authentication\" });\n    }\n  });\n\n  // ===== AI DOCUMENT GENERATION =====\n  \n  app.post(\"/api/generate-document\", requireAuth, async (req, res) => {\n    try {\n      const { templateName, dealData, complianceOptions } = req.body;\n      \n      if (!templateName) {\n        return res.status(400).json({ error: \"Template name is required\" });\n      }\n      \n      const openai = new OpenAI({\n        apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n        baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n      });\n      \n      const complianceText = [\n        complianceOptions?.sec && 'SEC compliance requirements',\n        complianceOptions?.finra && 'FINRA regulatory standards',\n        complianceOptions?.legal && 'legal review requirements',\n      ].filter(Boolean).join(', ') || 'standard legal compliance';\n      \n      const dealContext = dealData ? `\nDeal Information:\n- Project Name: ${dealData.name || 'N/A'}\n- Client: ${dealData.client || 'N/A'}\n- Sector: ${dealData.sector || 'N/A'}\n- Transaction Value: $${dealData.value || 0}M\n- Current Stage: ${dealData.stage || 'N/A'}\n- Description: ${dealData.description || 'N/A'}\n` : 'No specific deal context provided.';\n\n      const prompt = `You are a professional investment banking document generator for Kronos platform.\n\nGenerate a complete, professional ${templateName} document based on the following context:\n\n${dealContext}\n\nCompliance Requirements: ${complianceText}\n\nRequirements:\n1. Use formal investment banking language and terminology\n2. Include all standard sections appropriate for a ${templateName}\n3. Format with clear headers and professional structure\n4. Include placeholder fields where specific data is needed [in brackets]\n5. Make it ready for executive review\n6. Current date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n7. The document should be from \"Equiturn Holdings LLC\" (the acquiring/investing party)\n\nGenerate only the document content, no additional commentary.`;\n\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: \"You are an expert investment banking document specialist who creates professional legal and financial documents.\" },\n          { role: \"user\", content: prompt }\n        ],\n        max_tokens: 2000,\n        temperature: 0.7,\n      });\n      \n      const content = response.choices[0]?.message?.content || 'Failed to generate content';\n      \n      res.json({ content });\n    } catch (error: any) {\n      console.error('Document generation error:', error);\n      res.status(500).json({ error: error.message || \"Failed to generate document\" });\n    }\n  });\n\n  // ===== AI TASK ANALYSIS =====\n\n  app.post(\"/api/ai/analyze-task\", requireAuth, async (req, res) => {\n    try {\n      const { task, deal } = req.body;\n      \n      if (!task) {\n        return res.status(400).json({ error: \"Task data is required\" });\n      }\n      \n      const openai = new OpenAI({\n        apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n        baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n      });\n\n      // Build rich task context\n      const taskTitle = (task.title || '').toLowerCase();\n      const taskDesc = (task.description || '').toLowerCase();\n      const taskType = task.type || 'General';\n      const hasAttachments = task.hasAttachments || false;\n      const attachmentCount = task.attachmentCount || 0;\n      \n      // Detect task category for more accurate suggestions\n      const isFinancialModeling = taskTitle.includes('model') || taskTitle.includes('valuation') || \n        taskTitle.includes('dcf') || taskTitle.includes('lbo') || taskTitle.includes('financial') ||\n        taskDesc.includes('excel') || taskDesc.includes('spreadsheet') || taskDesc.includes('analysis');\n      \n      const isDocumentDrafting = taskTitle.includes('draft') || taskTitle.includes('memo') || \n        taskTitle.includes('document') || taskTitle.includes('write') || taskTitle.includes('prepare') ||\n        taskTitle.includes('letter') || taskTitle.includes('agreement') || taskTitle.includes('contract');\n      \n      const isPresentation = taskTitle.includes('presentation') || taskTitle.includes('pitch') || \n        taskTitle.includes('deck') || taskTitle.includes('slides') || taskTitle.includes('powerpoint');\n      \n      const isResearch = taskTitle.includes('research') || taskTitle.includes('diligence') || \n        taskTitle.includes('analyze') || taskTitle.includes('review') || taskTitle.includes('investigate');\n      \n      const isCommunication = taskTitle.includes('email') || taskTitle.includes('call') || \n        taskTitle.includes('meeting') || taskTitle.includes('schedule') || taskTitle.includes('contact');\n      \n      const isDataEntry = taskTitle.includes('update') || taskTitle.includes('enter') || \n        taskTitle.includes('input') || taskTitle.includes('log') || taskTitle.includes('record');\n\n      const taskContext = `\nTASK DETAILS:\n- Title: ${task.title || 'Untitled Task'}\n- Description: ${task.description || 'No description provided'}\n- Task Type: ${taskType}\n- Priority: ${task.priority || 'Medium'}\n- Has Attachments: ${hasAttachments ? `Yes (${attachmentCount} files)` : 'No'}\n\nDETECTED TASK CATEGORY: ${\n  isFinancialModeling ? 'Financial Modeling/Analysis' :\n  isDocumentDrafting ? 'Document Drafting/Legal' :\n  isPresentation ? 'Presentation Creation' :\n  isResearch ? 'Research/Due Diligence' :\n  isCommunication ? 'Communication/Scheduling' :\n  isDataEntry ? 'Data Entry/Updates' :\n  'General Task'\n}`;\n\n      const dealContext = deal ? `\nDEAL CONTEXT:\n- Deal Name: ${deal.name || 'N/A'}\n- Client: ${deal.client || 'N/A'}\n- Sector: ${deal.sector || 'N/A'}\n- Current Stage: ${deal.stage || 'N/A'}\n${deal.stage ? `\nSTAGE-SPECIFIC CONSIDERATIONS:\n${deal.stage === 'Opportunity' ? '- Early stage: Focus on initial research, market sizing, preliminary valuation' :\n  deal.stage === 'Pitch' ? '- Pitch stage: Focus on pitch materials, management presentations, initial financials' :\n  deal.stage === 'Due Diligence' ? '- DD stage: Focus on detailed analysis, data room review, verification' :\n  deal.stage === 'Negotiation' ? '- Negotiation: Focus on term sheets, deal terms, legal documentation' :\n  deal.stage === 'Closing' ? '- Closing: Focus on final documentation, closing conditions, execution' :\n  '- Standard deal workflow applies'}` : ''}` : '';\n\n      const systemPrompt = `You are an expert investment banking workflow assistant at Equiturn Holdings. You help analysts and associates determine the best approach to complete their tasks efficiently.\n\nAVAILABLE TOOLS (use EXACT names from this list):\n- \"Excel\" - Financial modeling, data analysis, calculations, spreadsheets\n- \"Word\" - Documents, memos, letters, agreements, contracts\n- \"PowerPoint\" - Presentations, pitch decks, slides\n- \"Email\" - Client/team communication, sending documents\n- \"Calendar\" - Scheduling meetings, calls, deadlines\n- \"Web Research\" - Market research, company research, news\n- \"Bloomberg\" - Market data, financial information, company filings\n- \"CapIQ\" - Company financials, comparable analysis, screening\n- \"Data Room\" - Document review, due diligence materials\n- \"PDF Editor\" - Reviewing/annotating documents, combining files\n- \"Teams/Zoom\" - Video calls, virtual meetings\n\nAlways respond with valid JSON matching the exact schema requested.`;\n\n      const prompt = `Analyze this investment banking task and provide specific, actionable guidance:\n\n${taskContext}\n${dealContext}\n\nProvide your analysis in this exact JSON format:\n{\n  \"action\": \"A specific, actionable recommendation in 1-2 sentences. Be precise about what to do first.\",\n  \"reasoning\": \"Explain why this approach is best for this specific task. Reference the task type, deal stage, or industry best practices. 2-3 sentences.\",\n  \"tools\": [\"Tool1\", \"Tool2\", \"Tool3\"],\n  \"estimatedTime\": \"Estimated time to complete (e.g., '30 minutes', '2 hours', '1-2 days')\",\n  \"keySteps\": [\"Step 1 brief description\", \"Step 2 brief description\", \"Step 3 brief description\"]\n}\n\nIMPORTANT:\n- Recommend 2-4 tools from the AVAILABLE TOOLS list\n- Order tools by importance (primary tool first)\n- Be specific to investment banking workflows\n- Consider the deal stage when making recommendations\n- Provide realistic time estimates`;\n\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: prompt }\n        ],\n        max_tokens: 600,\n        temperature: 0.3, // Lower temperature for more consistent, accurate responses\n        response_format: { type: \"json_object\" }\n      });\n      \n      const content = response.choices[0]?.message?.content;\n      \n      if (!content) {\n        return res.status(500).json({ error: \"Failed to analyze task\" });\n      }\n      \n      const analysis = JSON.parse(content);\n      res.json(analysis);\n    } catch (error: any) {\n      console.error('AI task analysis error:', error);\n      res.status(500).json({ \n        action: \"Manual Review Required\",\n        reasoning: \"Unable to analyze the task automatically at this time.\",\n        tools: [\"Excel\", \"Word\", \"Email\"],\n        estimatedTime: \"Varies\",\n        keySteps: [\"Review task requirements\", \"Gather necessary materials\", \"Complete task\"]\n      });\n    }\n  });\n\n  // ===== REAPER ASSISTANT ROUTES =====\n  \n  // Get user's assistant conversations\n  app.get(\"/api/assistant/conversations\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversations = await storage.getAssistantConversationsByUser(currentUser.id);\n      res.json(conversations);\n    } catch (error) {\n      console.error('Error fetching assistant conversations:', error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n  \n  // Create new assistant conversation\n  app.post(\"/api/assistant/conversations\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      \n      // Validate and sanitize title\n      let title = 'New Conversation';\n      if (req.body.title && typeof req.body.title === 'string') {\n        title = req.body.title.trim().slice(0, 100); // Limit to 100 chars\n      }\n      \n      const conversation = await storage.createAssistantConversation({\n        userId: currentUser.id,\n        title,\n      });\n      res.json(conversation);\n    } catch (error) {\n      console.error('Error creating assistant conversation:', error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n  \n  // Get messages for a conversation\n  app.get(\"/api/assistant/conversations/:id/messages\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getAssistantConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      if (conversation.userId !== currentUser.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const messages = await storage.getAssistantMessages(req.params.id);\n      res.json(messages);\n    } catch (error) {\n      console.error('Error fetching assistant messages:', error);\n      res.status(500).json({ error: \"Failed to fetch messages\" });\n    }\n  });\n  \n  // Send message to Reaper and get AI response\n  app.post(\"/api/assistant/conversations/:id/messages\", aiLimiter, requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getAssistantConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      if (conversation.userId !== currentUser.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { content, attachments, mentions } = req.body;\n      if (!content || typeof content !== 'string') {\n        return res.status(400).json({ error: \"Message content is required\" });\n      }\n      \n      // Save user message with attachments and mentions\n      const userMessage = await storage.createAssistantMessage({\n        conversationId: req.params.id,\n        role: 'user',\n        content,\n        attachments: attachments || [],\n        mentions: mentions || [],\n      });\n      \n      // Create notifications for mentioned users (with validation and deduplication)\n      if (mentions && Array.isArray(mentions) && mentions.length > 0) {\n        const notifiedUserIds = new Set<string>();\n        for (const mention of mentions) {\n          // Skip self-mentions and duplicates\n          if (!mention.userId || mention.userId === currentUser.id || notifiedUserIds.has(mention.userId)) {\n            continue;\n          }\n          // Validate that the mentioned user exists\n          const mentionedUser = await storage.getUser(mention.userId);\n          if (!mentionedUser) {\n            console.warn(`Mentioned user not found: ${mention.userId}`);\n            continue;\n          }\n          // Create notification and track to avoid duplicates\n          await storage.createNotification({\n            userId: mention.userId,\n            title: 'Mentioned in Kronos',\n            message: `${currentUser.name} mentioned you in a conversation with Kronos AI`,\n            type: 'info',\n            link: '/ceo/assistant',\n          });\n          notifiedUserIds.add(mention.userId);\n        }\n      }\n      \n      // Gather expanded context for the AI (use lightweight listing to avoid 507 errors)\n      const [deals, tasks, users, allTasks, investors, meetings, timeEntries, documents] = await Promise.all([\n        storage.getDealsListing(), // Lightweight version without full document data\n        storage.getTasksByUser(currentUser.id),\n        storage.getAllUsers(),\n        storage.getAllTasks(),\n        storage.getAllInvestors(),\n        storage.getAllMeetings(),\n        storage.getAllTimeEntries(),\n        storage.getDocumentsList(), // Lightweight version without file data\n      ]);\n      \n      // Calculate analytics\n      const now = new Date();\n      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n      const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n      \n      // Team workload analysis\n      const teamWorkload = users.map(u => {\n        const userTasks = allTasks.filter(t => t.assignedTo === u.id);\n        const activeTasks = userTasks.filter(t => t.status !== 'Completed');\n        const overdueTasks = userTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'Completed');\n        return {\n          id: u.id,\n          name: u.name,\n          role: u.role,\n          activeTasks: activeTasks.length,\n          overdueTasks: overdueTasks.length,\n          completedThisWeek: userTasks.filter(t => t.status === 'Completed' && t.updatedAt && new Date(t.updatedAt) > oneWeekAgo).length,\n          workloadScore: activeTasks.length + (overdueTasks.length * 2), // Higher = busier\n        };\n      });\n\n      // Deal velocity & pipeline analytics\n      const dealsByStage = deals.reduce((acc, d) => {\n        acc[d.stage] = (acc[d.stage] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n      \n      const stalledDeals = deals.filter(d => {\n        if (d.status !== 'Active') return false;\n        const lastUpdate = d.updatedAt ? new Date(d.updatedAt) : null;\n        return lastUpdate && lastUpdate < oneWeekAgo && d.progress < 100;\n      });\n\n      // Overdue tasks across platform\n      const allOverdueTasks = allTasks.filter(t => \n        new Date(t.dueDate) < now && t.status !== 'Completed'\n      );\n\n      // Upcoming deadlines (next 7 days)\n      const upcomingDeadlines = allTasks\n        .filter(t => {\n          const dueDate = new Date(t.dueDate);\n          return dueDate >= now && dueDate <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000) && t.status !== 'Completed';\n        })\n        .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());\n\n      // Build enhanced context about the platform state\n      const platformContext = {\n        currentUser: { \n          id: currentUser.id, \n          name: currentUser.name, \n          role: currentUser.role,\n          accessLevel: currentUser.accessLevel,\n          activeDeals: currentUser.activeDeals,\n          completedTasks: currentUser.completedTasks,\n        },\n        dealsSummary: {\n          total: deals.length,\n          active: deals.filter(d => d.status === 'Active').length,\n          closed: deals.filter(d => d.status === 'Closed').length,\n          stages: dealsByStage,\n          totalValue: deals.reduce((sum, d) => sum + d.value, 0),\n          averageValue: deals.length > 0 ? deals.reduce((sum, d) => sum + d.value, 0) / deals.length : 0,\n          bySector: deals.reduce((acc, d) => {\n            acc[d.sector] = (acc[d.sector] || 0) + 1;\n            return acc;\n          }, {} as Record<string, number>),\n        },\n        myTasks: {\n          total: tasks.length,\n          pending: tasks.filter(t => t.status === 'Pending').length,\n          inProgress: tasks.filter(t => t.status === 'In Progress').length,\n          completed: tasks.filter(t => t.status === 'Completed').length,\n          overdue: tasks.filter(t => new Date(t.dueDate) < now && t.status !== 'Completed').length,\n        },\n        teamMembers: users.map(u => ({ \n          id: u.id, \n          name: u.name, \n          role: u.role,\n          activeDeals: u.activeDeals,\n          completedTasks: u.completedTasks,\n        })),\n        teamWorkload,\n        recentDeals: deals.slice(0, 10).map(d => ({\n          id: d.id,\n          name: d.name,\n          stage: d.stage,\n          value: d.value,\n          client: d.client,\n          sector: d.sector,\n          lead: d.lead,\n          progress: d.progress,\n          status: d.status,\n          dealType: d.dealType,\n        })),\n        allDeals: deals.map(d => ({\n          id: d.id,\n          name: d.name,\n          stage: d.stage,\n          value: d.value,\n          client: d.client,\n          sector: d.sector,\n          lead: d.lead,\n          progress: d.progress,\n          status: d.status,\n          dealType: d.dealType,\n        })),\n        upcomingTasks: tasks\n          .filter(t => t.status !== 'Completed')\n          .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime())\n          .slice(0, 10)\n          .map(t => ({\n            id: t.id,\n            title: t.title,\n            priority: t.priority,\n            dueDate: t.dueDate,\n            status: t.status,\n            type: t.type,\n            dealId: t.dealId,\n          })),\n        // New: Investor data\n        investors: investors.slice(0, 20).map(inv => ({\n          id: inv.id,\n          name: inv.name,\n          type: inv.type,\n          focus: inv.focus,\n          aum: inv.aum,\n          minInvestment: inv.minInvestment,\n          maxInvestment: inv.maxInvestment,\n          preferredSectors: inv.preferredSectors,\n          status: inv.status,\n        })),\n        investorStats: {\n          total: investors.length,\n          active: investors.filter(i => i.status === 'Active').length,\n          byType: investors.reduce((acc, i) => {\n            acc[i.type] = (acc[i.type] || 0) + 1;\n            return acc;\n          }, {} as Record<string, number>),\n        },\n        // New: Upcoming meetings\n        upcomingMeetings: meetings\n          .filter(m => new Date(m.date) >= now)\n          .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n          .slice(0, 10)\n          .map(m => ({\n            id: m.id,\n            title: m.title,\n            date: m.date,\n            time: m.time,\n            location: m.location,\n            dealId: m.dealId,\n            attendees: m.attendees,\n          })),\n        // New: Documents summary\n        documentStats: {\n          total: documents.length,\n          byCategory: documents.reduce((acc, d) => {\n            const cat = d.category || 'Other';\n            acc[cat] = (acc[cat] || 0) + 1;\n            return acc;\n          }, {} as Record<string, number>),\n        },\n        // New: Time tracking summary\n        timeTrackingSummary: {\n          totalEntriesThisMonth: timeEntries.filter(e => new Date(e.date) > oneMonthAgo).length,\n          totalHoursThisMonth: timeEntries\n            .filter(e => new Date(e.date) > oneMonthAgo)\n            .reduce((sum, e) => sum + e.hours, 0),\n        },\n        // Proactive insights\n        proactiveAlerts: {\n          stalledDeals: stalledDeals.map(d => ({ id: d.id, name: d.name, stage: d.stage, daysSinceUpdate: d.updatedAt ? Math.floor((now.getTime() - new Date(d.updatedAt).getTime()) / (24 * 60 * 60 * 1000)) : 0 })),\n          overdueTasks: allOverdueTasks.slice(0, 10).map(t => ({ id: t.id, title: t.title, dueDate: t.dueDate, assignedTo: users.find(u => u.id === t.assignedTo)?.name || 'Unassigned' })),\n          upcomingDeadlines: upcomingDeadlines.slice(0, 10).map(t => ({ id: t.id, title: t.title, dueDate: t.dueDate, assignedTo: users.find(u => u.id === t.assignedTo)?.name || 'Unassigned', daysUntilDue: Math.ceil((new Date(t.dueDate).getTime() - now.getTime()) / (24 * 60 * 60 * 1000)) })),\n          highWorkloadTeamMembers: teamWorkload.filter(m => m.workloadScore > 10).map(m => ({ name: m.name, activeTasks: m.activeTasks, overdueTasks: m.overdueTasks })),\n        },\n      };\n      \n      // Get conversation history for context\n      const previousMessages = await storage.getAssistantMessages(req.params.id);\n      const conversationHistory = previousMessages\n        .filter(m => m.id !== userMessage.id)\n        .slice(-10) // Last 10 messages for context\n        .map(m => ({\n          role: m.role as 'user' | 'assistant',\n          content: m.content,\n        }));\n      \n      // Build the enhanced system prompt\n      const systemPrompt = `You are Kronos, an advanced AI assistant for the Kronos investment banking operations platform at Equiturn. You help ${currentUser.accessLevel === 'admin' ? 'executives and Managing Directors' : 'investment banking professionals'} manage transactions, execute deals, and optimize team productivity.\n\n## YOUR EXPERTISE - INVESTMENT BANKING KNOWLEDGE:\n\n### Transaction Lifecycle:\n- **Origination**: Client sourcing, mandate pitching, engagement letters, fee negotiations\n- **Due Diligence**: VDR management, information requests, management presentations, Q&A coordination\n- **Execution**: Transaction documentation, deal structuring, regulatory filings, closing mechanics\n- **Deal Types**: M&A (buy-side/sell-side), capital raises, IPOs, debt financing, restructuring\n\n### Key IB Terminology:\n- **LOI/IOI**: Letter of Intent / Indication of Interest\n- **SPA/APA**: Stock/Asset Purchase Agreement\n- **VDR**: Virtual Data Room\n- **CIM/IM**: Confidential Information Memorandum\n- **DCF/LBO**: Discounted Cash Flow / Leveraged Buyout analysis\n- **EBITDA multiples**: Enterprise value metrics\n- **Term Sheet**: Non-binding summary of key transaction terms\n- **Closing conditions**: Conditions precedent to transaction completion\n\n### Stage-Based Best Practices (Investment Banking):\n- Origination: Focus on relationship building and deal qualification\n- Structuring: Define transaction structure, prepare materials\n- Diligence: Maintain momentum, respond to requests within 24-48 hours\n- Legal: Track open items, coordinate with legal counsel\n- Close: Ensure all conditions satisfied, coordinate funds flow\n\n## YOUR CAPABILITIES:\n\n### Query & Analysis:\n- Answer questions about deals, pipeline status, tasks, investors, and team activities\n- Provide insights on deal velocity, conversion rates, and stage progression\n- Analyze team workload distribution and identify capacity constraints\n- Calculate metrics like average time-in-stage, completion rates, and fee projections\n- Match investors based on sector focus, check size, and investment criteria\n- Summarize documents by category and deal association\n\n### Actions You Can Take:\n- CREATE TASKS: Assign work to team members with priorities and deadlines\n- SCHEDULE MEETINGS: Book calls and meetings with internal or external attendees\n- UPDATE DEALS: Modify stage, status, or progress for transactions\n- UPDATE TASKS: Mark complete, change priority, or update status\n- SEND MESSAGES: Communicate with team members via in-app chat\n- SHARE FILES: Send documents to colleagues with context\n- GENERATE DOCUMENTS: Draft term sheets, NDAs, deal memos, LOIs, checklists\n- ANALYZE INVESTOR FIT: Find matching investors for specific deals\n- GET DEAL RECOMMENDATIONS: Receive AI-powered next steps based on deal stage\n\n### Proactive Intelligence:\n- Flag stalled deals that haven't been updated recently (deal velocity alerts)\n- Identify overdue tasks requiring immediate attention\n- Alert about upcoming deadlines within the next week\n- Highlight team members with high workload for capacity planning\n- Suggest stage-appropriate next steps for active transactions\n\n## CURRENT PLATFORM CONTEXT:\n${JSON.stringify(platformContext, null, 2)}\n\n## PROACTIVE ALERTS TO MENTION WHEN RELEVANT:\n${platformContext.proactiveAlerts.stalledDeals.length > 0 ? ` ${platformContext.proactiveAlerts.stalledDeals.length} deals haven't been updated in over a week` : ''}\n${platformContext.proactiveAlerts.overdueTasks.length > 0 ? ` ${platformContext.proactiveAlerts.overdueTasks.length} tasks are overdue` : ''}\n${platformContext.proactiveAlerts.upcomingDeadlines.length > 0 ? ` ${platformContext.proactiveAlerts.upcomingDeadlines.length} tasks due in the next 7 days` : ''}\n${platformContext.proactiveAlerts.highWorkloadTeamMembers.length > 0 ? ` ${platformContext.proactiveAlerts.highWorkloadTeamMembers.length} team members have high workload` : ''}\n\n## ACTION INSTRUCTIONS:\n\n**Creating Tasks:** When asked to create/add a task, use create_task with title, assignee name, priority, and due date.\nExample: \"Create a task for Sarah to review the Alpha Corp proposal by Friday\" -> call create_task\n\n**Scheduling Meetings:** When asked to schedule/book a meeting, use schedule_meeting with title, date, time, and attendees.\nExample: \"Schedule a meeting with the tech team tomorrow at 2pm\" -> call schedule_meeting\n\n**Updating Deals:** When asked to update a deal's status, stage, or progress, use update_deal.\nExample: \"Update Alpha Corp deal to Diligence stage\" -> call update_deal\n\n**Updating Tasks:** When asked to mark a task complete, change priority, or update status, use update_task.\nExample: \"Mark the compliance review task as completed\" -> call update_task\n\n**Sending Messages:** When asked to message someone, use send_message.\nExample: \"Tell Michael the meeting is moved to 3pm\" -> call send_message\n\n**Generating Documents:** When asked to draft, create, or generate a document, use generate_document.\nExample: \"Draft a term sheet for the TechCo deal\" -> call generate_document with documentType: \"term_sheet\"\nAvailable document types: term_sheet, nda, deal_memo, investor_update, email_draft, loi, due_diligence_checklist, closing_checklist, pitch_deck_outline\n\n**Deal Recommendations:** When asked for advice or next steps on a deal, use get_deal_recommendation.\nExample: \"What should we focus on next for the Alpha Corp deal?\" -> call get_deal_recommendation\n\n**Investor Analysis:** When asked to find or match investors for a deal, use analyze_investor_fit.\nExample: \"Which investors would be good for the healthcare deal?\" -> call analyze_investor_fit\n\n**Market Data:** When asked about stock prices, market data, or company news, use get_market_data.\nExample: \"What's Apple's stock price?\" -> call get_market_data with symbol: \"AAPL\"\n\n**Document Summary:** When asked to summarize a document, use summarize_document.\nExample: \"Summarize the Alpha Corp NDA\" -> call summarize_document\n\n**Meeting Prep:** When asked to prepare for a meeting, use generate_meeting_prep.\nExample: \"Help me prepare for the investor call tomorrow\" -> call generate_meeting_prep\n\n**Pipeline Analytics:** When asked for pipeline metrics, performance data, or analytics, use get_pipeline_analytics.\nExample: \"What's our win rate this quarter?\" -> call get_pipeline_analytics\n\n**Team Performance:** When asked about team performance, productivity, or individual contributions, use get_team_performance.\nExample: \"How is Sarah performing this month?\" -> call get_team_performance\n\n**Reports:** When asked for a report or data summary, use generate_report.\nExample: \"Generate a pipeline report\" -> call generate_report\n\n## GUIDELINES:\n- Be concise but thorough - investment bankers are busy\n- Use specific data from the platform context when relevant\n- Format responses with clear structure using markdown headers and bullets\n- Proactively mention relevant alerts when they impact the user's work\n- Always express transaction values in millions (e.g., $50M, $150M)\n- For investor matching, prioritize sector alignment, then check size compatibility\n- Reference team members by name for accountability\n- Provide actionable insights with specific next steps\n- When asked to perform an action, ALWAYS use the appropriate function\n- Use professional IB terminology appropriately (DCF, EBITDA, VDR, etc.)\n- When generating documents, auto-populate with deal data when available`;\n      \n      // Define tools for the assistant\n      const tools: any[] = [\n        {\n          type: \"function\",\n          function: {\n            name: \"send_message\",\n            description: \"Send an in-app message to a team member. Use this when the user asks to message, contact, or communicate with someone.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                recipientName: {\n                  type: \"string\",\n                  description: \"The name of the person to send the message to\"\n                },\n                content: {\n                  type: \"string\",\n                  description: \"The message content to send\"\n                }\n              },\n              required: [\"recipientName\", \"content\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"share_file\",\n            description: \"Share a file with a team member. Use this when the user has uploaded a file and asks you to share it with someone.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                recipientName: {\n                  type: \"string\",\n                  description: \"The name of the person to share the file with\"\n                },\n                fileUrl: {\n                  type: \"string\",\n                  description: \"The URL of the file to share\"\n                },\n                filename: {\n                  type: \"string\",\n                  description: \"The name of the file being shared\"\n                },\n                message: {\n                  type: \"string\",\n                  description: \"Optional message to send along with the file\"\n                }\n              },\n              required: [\"recipientName\", \"fileUrl\", \"filename\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"create_task\",\n            description: \"Create a new task and assign it to a team member. Use when user asks to create, add, or assign a task.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                title: {\n                  type: \"string\",\n                  description: \"The title/description of the task\"\n                },\n                assigneeName: {\n                  type: \"string\",\n                  description: \"The name of the person to assign the task to\"\n                },\n                priority: {\n                  type: \"string\",\n                  enum: [\"Low\", \"Medium\", \"High\", \"Urgent\"],\n                  description: \"Priority level of the task\"\n                },\n                dueDate: {\n                  type: \"string\",\n                  description: \"Due date in YYYY-MM-DD format\"\n                },\n                dealName: {\n                  type: \"string\",\n                  description: \"Optional: name of the deal this task is related to\"\n                }\n              },\n              required: [\"title\", \"assigneeName\", \"priority\", \"dueDate\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"schedule_meeting\",\n            description: \"Schedule a new meeting with team members. Use when user asks to schedule, book, or set up a meeting.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                title: {\n                  type: \"string\",\n                  description: \"The title of the meeting\"\n                },\n                date: {\n                  type: \"string\",\n                  description: \"Date of the meeting in YYYY-MM-DD format\"\n                },\n                time: {\n                  type: \"string\",\n                  description: \"Time of the meeting (e.g., '14:00' or '2:00 PM')\"\n                },\n                attendees: {\n                  type: \"array\",\n                  items: { type: \"string\" },\n                  description: \"List of attendee names\"\n                },\n                location: {\n                  type: \"string\",\n                  description: \"Location or meeting room\"\n                },\n                dealName: {\n                  type: \"string\",\n                  description: \"Optional: name of the deal this meeting is about\"\n                },\n                description: {\n                  type: \"string\",\n                  description: \"Optional meeting description or agenda\"\n                }\n              },\n              required: [\"title\", \"date\", \"time\", \"attendees\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"update_deal\",\n            description: \"Update a deal's status, stage, or progress. Use when user asks to update, change, or modify a deal.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                dealName: {\n                  type: \"string\",\n                  description: \"The name of the deal to update\"\n                },\n                stage: {\n                  type: \"string\",\n                  description: \"New stage for the deal (e.g., 'Origination', 'Structuring', 'Diligence', 'Legal', 'Close')\"\n                },\n                status: {\n                  type: \"string\",\n                  enum: [\"Active\", \"On Hold\", \"Closed\", \"Won\", \"Lost\"],\n                  description: \"New status for the deal\"\n                },\n                progress: {\n                  type: \"number\",\n                  description: \"Progress percentage (0-100)\"\n                }\n              },\n              required: [\"dealName\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"update_task\",\n            description: \"Update a task's status, priority, or other details. Use when user asks to mark complete, update, or change a task.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                taskTitle: {\n                  type: \"string\",\n                  description: \"The title of the task to update (partial match supported)\"\n                },\n                status: {\n                  type: \"string\",\n                  enum: [\"Pending\", \"In Progress\", \"Completed\"],\n                  description: \"New status for the task\"\n                },\n                priority: {\n                  type: \"string\",\n                  enum: [\"Low\", \"Medium\", \"High\", \"Urgent\"],\n                  description: \"New priority for the task\"\n                }\n              },\n              required: [\"taskTitle\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"generate_document\",\n            description: \"Generate a document draft such as a term sheet, NDA, deal memo, investor update, or email draft. Use when user asks to create, draft, write, or generate any document.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                documentType: {\n                  type: \"string\",\n                  enum: [\"term_sheet\", \"nda\", \"deal_memo\", \"investor_update\", \"email_draft\", \"loi\", \"due_diligence_checklist\", \"closing_checklist\", \"pitch_deck_outline\"],\n                  description: \"Type of document to generate\"\n                },\n                dealName: {\n                  type: \"string\",\n                  description: \"The deal this document relates to (optional)\"\n                },\n                recipientName: {\n                  type: \"string\",\n                  description: \"For emails/letters, the intended recipient\"\n                },\n                additionalContext: {\n                  type: \"string\",\n                  description: \"Any additional details or requirements for the document\"\n                }\n              },\n              required: [\"documentType\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"get_deal_recommendation\",\n            description: \"Get AI-powered recommendations for next steps on a deal based on its current stage, progress, and historical patterns. Use when user asks for advice, recommendations, or next steps on a deal.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                dealName: {\n                  type: \"string\",\n                  description: \"The name of the deal to get recommendations for\"\n                }\n              },\n              required: [\"dealName\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"analyze_investor_fit\",\n            description: \"Analyze and recommend investors that would be a good fit for a specific deal based on sector, investment size, and preferences. Use when user asks about investor matching, finding investors, or investor recommendations.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                dealName: {\n                  type: \"string\",\n                  description: \"The name of the deal to find investors for\"\n                },\n                limit: {\n                  type: \"number\",\n                  description: \"Maximum number of investors to recommend (default 5)\"\n                }\n              },\n              required: [\"dealName\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"get_market_data\",\n            description: \"Get real-time stock market data including price, change, and company news. Use when user asks about stock prices, market data, or company financial news.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                symbol: {\n                  type: \"string\",\n                  description: \"Stock ticker symbol (e.g., AAPL, GOOGL, MSFT)\"\n                },\n                includeNews: {\n                  type: \"boolean\",\n                  description: \"Whether to include recent company news (default: false)\"\n                }\n              },\n              required: [\"symbol\"]\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"summarize_document\",\n            description: \"Summarize a document from the platform. Use when user asks for a summary, overview, or key points from a document.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                documentId: {\n                  type: \"string\",\n                  description: \"The ID of the document to summarize\"\n                },\n                documentName: {\n                  type: \"string\",\n                  description: \"The name of the document to summarize (alternative to documentId)\"\n                },\n                summaryType: {\n                  type: \"string\",\n                  enum: [\"brief\", \"detailed\", \"executive\", \"bullet_points\"],\n                  description: \"Type of summary to generate (default: brief)\"\n                }\n              }\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"generate_meeting_prep\",\n            description: \"Generate meeting preparation materials including agenda, talking points, and relevant context. Use when user asks to prepare for a meeting.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                meetingId: {\n                  type: \"string\",\n                  description: \"The ID of the meeting to prepare for\"\n                },\n                meetingTitle: {\n                  type: \"string\",\n                  description: \"The title of the meeting (alternative to meetingId)\"\n                },\n                includeContext: {\n                  type: \"boolean\",\n                  description: \"Include related deal context (default: true)\"\n                }\n              }\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"get_pipeline_analytics\",\n            description: \"Get detailed pipeline analytics including conversion rates, stage velocity, sector performance, and deal trends. Use when user asks for pipeline analysis, metrics, or performance data.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                timeframe: {\n                  type: \"string\",\n                  enum: [\"week\", \"month\", \"quarter\", \"year\", \"all\"],\n                  description: \"Time period for analytics (default: quarter)\"\n                },\n                sector: {\n                  type: \"string\",\n                  description: \"Filter by specific sector (optional)\"\n                },\n                metric: {\n                  type: \"string\",\n                  enum: [\"conversion\", \"velocity\", \"value\", \"stage_distribution\", \"all\"],\n                  description: \"Specific metric to analyze (default: all)\"\n                }\n              }\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"get_team_performance\",\n            description: \"Get team performance insights including workload distribution, task completion rates, deal contributions, and productivity trends. Use when user asks about team performance, productivity, or individual contributions.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                userId: {\n                  type: \"string\",\n                  description: \"Specific team member ID to analyze (optional)\"\n                },\n                userName: {\n                  type: \"string\",\n                  description: \"Specific team member name to analyze (optional)\"\n                },\n                timeframe: {\n                  type: \"string\",\n                  enum: [\"week\", \"month\", \"quarter\", \"year\"],\n                  description: \"Time period for analysis (default: month)\"\n                },\n                metric: {\n                  type: \"string\",\n                  enum: [\"tasks\", \"deals\", \"workload\", \"efficiency\", \"all\"],\n                  description: \"Specific metric to analyze (default: all)\"\n                }\n              }\n            }\n          }\n        },\n        {\n          type: \"function\",\n          function: {\n            name: \"generate_report\",\n            description: \"Generate a custom report based on natural language request. Use when user asks for a report, summary, or data export.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                reportType: {\n                  type: \"string\",\n                  enum: [\"pipeline\", \"team\", \"deals\", \"tasks\", \"investors\", \"custom\"],\n                  description: \"Type of report to generate\"\n                },\n                title: {\n                  type: \"string\",\n                  description: \"Title for the report\"\n                },\n                requirements: {\n                  type: \"string\",\n                  description: \"Natural language description of what the report should contain\"\n                },\n                format: {\n                  type: \"string\",\n                  enum: [\"summary\", \"detailed\", \"table\"],\n                  description: \"Report format (default: summary)\"\n                }\n              },\n              required: [\"reportType\", \"requirements\"]\n            }\n          }\n        }\n      ];\n      \n      // Call OpenAI API with function calling\n      try {\n        console.log('[Assistant] Making OpenAI request with model gpt-4o...');\n        const completion = await openai.chat.completions.create({\n          model: \"gpt-4o\",\n          messages: [\n            { role: \"system\", content: systemPrompt },\n            ...conversationHistory,\n            { role: \"user\", content },\n          ],\n          tools,\n          tool_choice: \"auto\",\n          max_completion_tokens: 2048,\n        });\n        \n        console.log('[Assistant] OpenAI response received:', JSON.stringify(completion.choices[0], null, 2).slice(0, 500));\n        const responseMessage = completion.choices[0]?.message;\n        let assistantContent = responseMessage?.content || \"\";\n        console.log('[Assistant] Initial content:', assistantContent ? assistantContent.slice(0, 100) : 'EMPTY');\n        \n        // Handle function calls\n        if (responseMessage?.tool_calls && responseMessage.tool_calls.length > 0) {\n          const toolResults: any[] = [];\n          \n          for (const toolCall of responseMessage.tool_calls) {\n            const functionCall = (toolCall as any).function;\n            if (functionCall?.name === \"send_message\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                \n                // Find recipient user\n                const allUsers = await storage.getAllUsers();\n                const recipient = allUsers.find(u => \n                  u.name.toLowerCase() === args.recipientName.toLowerCase() ||\n                  u.name.toLowerCase().includes(args.recipientName.toLowerCase())\n                );\n                \n                if (recipient && recipient.id !== currentUser.id) {\n                  // Get or create conversation\n                  let conversation = await storage.getConversationBetweenUsers(currentUser.id, recipient.id);\n                  \n                  if (!conversation) {\n                    conversation = await storage.createConversation({\n                      name: recipient.name,\n                      isGroup: false,\n                      createdBy: currentUser.id,\n                    });\n                    \n                    await storage.addConversationMember(conversation.id, currentUser.id);\n                    await storage.addConversationMember(conversation.id, recipient.id);\n                  }\n                  \n                  // Send message\n                  await storage.createMessage({\n                    conversationId: conversation.id,\n                    senderId: currentUser.id,\n                    content: args.content,\n                  });\n                  \n                  // Create notification\n                  await storage.createNotification({\n                    userId: recipient.id,\n                    title: 'New Message',\n                    message: `${currentUser.name}: ${args.content.slice(0, 50)}${args.content.length > 50 ? '...' : ''}`,\n                    type: 'info',\n                    link: '/ceo/chat',\n                  });\n                  \n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Message sent successfully to ${recipient.name}`\n                  });\n                } else if (recipient?.id === currentUser.id) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"Cannot send message to yourself\"\n                  });\n                } else {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `User \"${args.recipientName}\" not found. Available team members: ${allUsers.filter(u => u.id !== currentUser.id).map(u => u.name).join(', ')}`\n                  });\n                }\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to parse message parameters\"\n                });\n              }\n            } else if (functionCall?.name === \"share_file\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                \n                // Find recipient user\n                const allUsers = await storage.getAllUsers();\n                const recipient = allUsers.find(u => \n                  u.name.toLowerCase() === args.recipientName.toLowerCase() ||\n                  u.name.toLowerCase().includes(args.recipientName.toLowerCase())\n                );\n                \n                if (recipient && recipient.id !== currentUser.id) {\n                  // Get or create conversation\n                  let conversation = await storage.getConversationBetweenUsers(currentUser.id, recipient.id);\n                  \n                  if (!conversation) {\n                    conversation = await storage.createConversation({\n                      name: recipient.name,\n                      isGroup: false,\n                      createdBy: currentUser.id,\n                    });\n                    \n                    await storage.addConversationMember(conversation.id, currentUser.id);\n                    await storage.addConversationMember(conversation.id, recipient.id);\n                  }\n                  \n                  // Build message content with file link\n                  const messageContent = args.message \n                    ? `${args.message}\\n\\n Shared file: ${args.filename}`\n                    : ` Shared file: ${args.filename}`;\n                  \n                  // Create attachment object\n                  const attachment = {\n                    id: crypto.randomUUID(),\n                    type: 'file',\n                    filename: args.filename,\n                    url: args.fileUrl,\n                    mimeType: 'application/octet-stream',\n                    size: 0,\n                    uploadedAt: new Date().toISOString(),\n                  };\n                  \n                  // Send message with file attachment\n                  await storage.createMessage({\n                    conversationId: conversation.id,\n                    senderId: currentUser.id,\n                    content: messageContent,\n                    attachments: [attachment],\n                  });\n                  \n                  // Create notification\n                  await storage.createNotification({\n                    userId: recipient.id,\n                    title: 'New File Shared',\n                    message: `${currentUser.name} shared: ${args.filename}`,\n                    type: 'info',\n                    link: '/ceo/chat',\n                  });\n                  \n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `File \"${args.filename}\" shared successfully with ${recipient.name}`\n                  });\n                } else if (recipient?.id === currentUser.id) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"Cannot share file with yourself\"\n                  });\n                } else {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `User \"${args.recipientName}\" not found. Available team members: ${allUsers.filter(u => u.id !== currentUser.id).map(u => u.name).join(', ')}`\n                  });\n                }\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to parse file sharing parameters\"\n                });\n              }\n            } else if (functionCall?.name === \"create_task\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const allUsers = await storage.getAllUsers();\n                \n                // Find assignee\n                const assignee = allUsers.find(u => \n                  u.name.toLowerCase() === args.assigneeName.toLowerCase() ||\n                  u.name.toLowerCase().includes(args.assigneeName.toLowerCase())\n                );\n                \n                if (!assignee) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `User \"${args.assigneeName}\" not found. Available team members: ${allUsers.map(u => u.name).join(', ')}`\n                  });\n                  continue;\n                }\n                \n                // Find deal if specified\n                let dealId: string | undefined;\n                if (args.dealName) {\n                  const deal = deals.find(d => \n                    d.name.toLowerCase().includes(args.dealName.toLowerCase())\n                  );\n                  if (deal) dealId = deal.id;\n                }\n                \n                // Create the task\n                const task = await storage.createTask({\n                  title: args.title,\n                  type: 'General',\n                  priority: args.priority || 'Medium',\n                  status: 'Pending',\n                  dueDate: args.dueDate,\n                  assignedTo: assignee.id,\n                  dealId: dealId,\n                  createdBy: currentUser.id,\n                });\n                \n                // Create notification for assignee\n                await storage.createNotification({\n                  userId: assignee.id,\n                  title: 'New Task Assigned',\n                  message: `${currentUser.name} assigned you: ${args.title}`,\n                  type: 'info',\n                  link: '/employee/my-tasks',\n                });\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: `Task \"${args.title}\" created and assigned to ${assignee.name} with ${args.priority} priority, due ${args.dueDate}${dealId ? ` (linked to deal)` : ''}`\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to create task\"\n                });\n              }\n            } else if (functionCall?.name === \"schedule_meeting\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const allUsers = await storage.getAllUsers();\n                \n                // Find attendees\n                const attendeeNames = args.attendees || [];\n                const foundAttendees: string[] = [];\n                const notFoundAttendees: string[] = [];\n                \n                for (const name of attendeeNames) {\n                  const user = allUsers.find(u => \n                    u.name.toLowerCase() === name.toLowerCase() ||\n                    u.name.toLowerCase().includes(name.toLowerCase())\n                  );\n                  if (user) {\n                    foundAttendees.push(user.name);\n                  } else {\n                    notFoundAttendees.push(name);\n                  }\n                }\n                \n                // Find deal if specified\n                let dealId: string | undefined;\n                if (args.dealName) {\n                  const deal = deals.find(d => \n                    d.name.toLowerCase().includes(args.dealName.toLowerCase())\n                  );\n                  if (deal) dealId = deal.id;\n                }\n                \n                // Create the meeting\n                const meeting = await storage.createMeeting({\n                  title: args.title,\n                  date: args.date,\n                  time: args.time,\n                  attendees: foundAttendees,\n                  location: args.location || 'TBD',\n                  dealId: dealId,\n                  description: args.description || '',\n                  createdBy: currentUser.id,\n                });\n                \n                // Notify attendees\n                for (const attendeeName of foundAttendees) {\n                  const attendee = allUsers.find(u => u.name === attendeeName);\n                  if (attendee && attendee.id !== currentUser.id) {\n                    await storage.createNotification({\n                      userId: attendee.id,\n                      title: 'Meeting Scheduled',\n                      message: `${currentUser.name} scheduled: ${args.title} on ${args.date} at ${args.time}`,\n                      type: 'info',\n                      link: '/ceo/calendar',\n                    });\n                  }\n                }\n                \n                let resultMsg = `Meeting \"${args.title}\" scheduled for ${args.date} at ${args.time} with ${foundAttendees.join(', ')}`;\n                if (notFoundAttendees.length > 0) {\n                  resultMsg += `. Note: Could not find users: ${notFoundAttendees.join(', ')}`;\n                }\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: resultMsg\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to schedule meeting\"\n                });\n              }\n            } else if (functionCall?.name === \"update_deal\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                \n                // Find the deal\n                const deal = deals.find(d => \n                  d.name.toLowerCase().includes(args.dealName.toLowerCase())\n                );\n                \n                if (!deal) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Deal \"${args.dealName}\" not found. Available deals: ${deals.slice(0, 5).map(d => d.name).join(', ')}...`\n                  });\n                  continue;\n                }\n                \n                // Build updates\n                const updates: any = {};\n                if (args.stage) updates.stage = args.stage;\n                if (args.status) updates.status = args.status;\n                if (args.progress !== undefined) updates.progress = args.progress;\n                \n                if (Object.keys(updates).length === 0) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"No updates specified for the deal\"\n                  });\n                  continue;\n                }\n                \n                // Update the deal\n                await storage.updateDeal(deal.id, updates);\n                \n                const updatesList = Object.entries(updates).map(([k, v]) => `${k}: ${v}`).join(', ');\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: `Deal \"${deal.name}\" updated: ${updatesList}`\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to update deal\"\n                });\n              }\n            } else if (functionCall?.name === \"update_task\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                \n                // Find the task\n                const task = allTasks.find(t => \n                  t.title.toLowerCase().includes(args.taskTitle.toLowerCase())\n                );\n                \n                if (!task) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Task \"${args.taskTitle}\" not found. Try being more specific.`\n                  });\n                  continue;\n                }\n                \n                // Build updates\n                const updates: any = {};\n                if (args.status) updates.status = args.status;\n                if (args.priority) updates.priority = args.priority;\n                \n                if (Object.keys(updates).length === 0) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"No updates specified for the task\"\n                  });\n                  continue;\n                }\n                \n                // Update the task\n                await storage.updateTask(task.id, updates);\n                \n                const updatesList = Object.entries(updates).map(([k, v]) => `${k}: ${v}`).join(', ');\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: `Task \"${task.title}\" updated: ${updatesList}`\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to update task\"\n                });\n              }\n            } else if (functionCall?.name === \"generate_document\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const deal = args.dealName ? deals.find(d => d.name.toLowerCase().includes(args.dealName.toLowerCase())) : null;\n                \n                const documentTemplates: Record<string, string> = {\n                  term_sheet: `# TERM SHEET\\n\\n**Transaction:** ${deal?.name || '[Deal Name]'}\\n**Date:** ${new Date().toLocaleDateString()}\\n\\n## 1. PARTIES\\n- **Company:** ${deal?.client || '[Client Name]'}\\n- **Investor(s):** [Investor Names]\\n\\n## 2. INVESTMENT AMOUNT\\n- **Total Investment:** $${deal?.value || '[Amount]'}M\\n- **Type:** ${deal?.dealType || 'Equity'}\\n\\n## 3. VALUATION\\n- **Pre-money Valuation:** $[X]M\\n- **Post-money Valuation:** $[X]M\\n\\n## 4. KEY TERMS\\n- **Board Seats:** [X] investor directors\\n- **Protective Provisions:** Standard\\n- **Information Rights:** Monthly financials, annual audit\\n- **Anti-dilution:** Broad-based weighted average\\n\\n## 5. CONDITIONS PRECEDENT\\n- Satisfactory due diligence\\n- Definitive documentation\\n- Regulatory approvals\\n\\n*This term sheet is non-binding except for confidentiality and exclusivity provisions.*`,\n                  \n                  nda: `# NON-DISCLOSURE AGREEMENT\\n\\n**Date:** ${new Date().toLocaleDateString()}\\n\\n**Between:**\\n1. ${deal?.client || '[Disclosing Party]'} (\"Disclosing Party\")\\n2. [Recipient Party] (\"Receiving Party\")\\n\\n## 1. DEFINITION OF CONFIDENTIAL INFORMATION\\nAll information disclosed by the Disclosing Party relating to ${deal?.name || 'the Transaction'}, including but not limited to financial data, business plans, customer lists, and proprietary technology.\\n\\n## 2. OBLIGATIONS\\nThe Receiving Party agrees to:\\n- Maintain strict confidentiality\\n- Use information solely for evaluating the Transaction\\n- Limit disclosure to necessary personnel\\n- Return or destroy materials upon request\\n\\n## 3. EXCLUSIONS\\nInformation that is:\\n- Publicly available\\n- Previously known\\n- Independently developed\\n- Disclosed by authorized third parties\\n\\n## 4. TERM\\nThis Agreement remains in effect for [2] years from the date above.\\n\\n**SIGNATURES:**\\n\\n_________________________\\nDisclosing Party\\n\\n_________________________\\nReceiving Party`,\n                  \n                  deal_memo: `# DEAL MEMORANDUM\\n\\n**Deal:** ${deal?.name || '[Deal Name]'}\\n**Client:** ${deal?.client || '[Client]'}\\n**Sector:** ${deal?.sector || '[Sector]'}\\n**Date:** ${new Date().toLocaleDateString()}\\n**Deal Lead:** ${deal?.lead || '[Lead Banker]'}\\n\\n## EXECUTIVE SUMMARY\\n${deal?.description || '[Brief description of the transaction and its strategic rationale]'}\\n\\n## TRANSACTION OVERVIEW\\n- **Deal Type:** ${deal?.dealType || 'M&A Advisory'}\\n- **Transaction Value:** $${deal?.value || '[X]'}M\\n- **Current Stage:** ${deal?.stage || 'Origination'}\\n- **Expected Close:** [Date]\\n\\n## KEY CONSIDERATIONS\\n1. **Strategic Fit:** [Analysis]\\n2. **Market Conditions:** [Analysis]\\n3. **Valuation:** [Analysis]\\n4. **Risk Factors:** [Analysis]\\n\\n## NEXT STEPS\\n1. [Action item 1]\\n2. [Action item 2]\\n3. [Action item 3]\\n\\n## TEAM\\n- Deal Lead: ${deal?.lead || '[Name]'}\\n- Associates: [Names]\\n- Analysts: [Names]`,\n                  \n                  investor_update: `# INVESTOR UPDATE\\n\\n**Deal:** ${deal?.name || '[Deal Name]'}\\n**Date:** ${new Date().toLocaleDateString()}\\n**Update Period:** [Month/Quarter]\\n\\n## TRANSACTION STATUS\\n**Current Stage:** ${deal?.stage || '[Stage]'}\\n**Progress:** ${deal?.progress || 0}%\\n\\n## KEY DEVELOPMENTS\\n1. [Development 1]\\n2. [Development 2]\\n3. [Development 3]\\n\\n## UPCOMING MILESTONES\\n- [Milestone 1] - [Target Date]\\n- [Milestone 2] - [Target Date]\\n\\n## ACTION ITEMS\\n- [Item requiring investor attention]\\n\\n## NEXT COMMUNICATION\\nWe will provide the next update on [Date].\\n\\nPlease reach out with any questions.`,\n                  \n                  email_draft: `Subject: ${deal?.name || '[Deal Name]'} - [Subject]\\n\\nDear ${args.recipientName || '[Recipient]'},\\n\\nI hope this email finds you well.\\n\\n[Body of email regarding ${deal?.name || 'the transaction'}]\\n\\nPlease let me know if you have any questions or would like to schedule a call to discuss further.\\n\\nBest regards,\\n${currentUser.name}\\nKronos Investment Banking`,\n                  \n                  loi: `# LETTER OF INTENT\\n\\n**Date:** ${new Date().toLocaleDateString()}\\n\\n**To:** ${deal?.client || '[Target Company]'}\\n**From:** [Acquiring Party]\\n**Re:** Proposed Transaction\\n\\nDear [Name],\\n\\nWe are pleased to submit this non-binding Letter of Intent to acquire ${deal?.client || '[Target]'}.\\n\\n## PROPOSED TERMS\\n- **Purchase Price:** $${deal?.value || '[X]'}M\\n- **Structure:** [Asset/Stock Purchase]\\n- **Financing:** [Cash/Stock/Debt]\\n\\n## DUE DILIGENCE\\nSubject to satisfactory completion of [30-60] day due diligence period.\\n\\n## EXCLUSIVITY\\nWe request a [60] day exclusivity period.\\n\\n## CONFIDENTIALITY\\nThis LOI and all discussions shall remain confidential.\\n\\n*This letter is non-binding except for exclusivity and confidentiality provisions.*\\n\\nSincerely,\\n[Signature]`,\n                  \n                  due_diligence_checklist: `# DUE DILIGENCE CHECKLIST\\n\\n**Deal:** ${deal?.name || '[Deal Name]'}\\n**Client:** ${deal?.client || '[Client]'}\\n**Date:** ${new Date().toLocaleDateString()}\\n\\n## FINANCIAL\\n- [ ] Audited financial statements (3 years)\\n- [ ] Monthly financials (trailing 12 months)\\n- [ ] Budget and projections\\n- [ ] Accounts receivable aging\\n- [ ] Accounts payable aging\\n- [ ] Debt schedule and agreements\\n\\n## LEGAL\\n- [ ] Corporate documents (charter, bylaws)\\n- [ ] Shareholder agreements\\n- [ ] Material contracts\\n- [ ] Litigation history\\n- [ ] Intellectual property\\n- [ ] Regulatory compliance\\n\\n## OPERATIONS\\n- [ ] Key customer list\\n- [ ] Key supplier contracts\\n- [ ] Employee roster and compensation\\n- [ ] Real estate leases\\n- [ ] Equipment list\\n\\n## TAX\\n- [ ] Tax returns (3 years)\\n- [ ] Tax notices and audits\\n- [ ] Transfer pricing documentation\\n\\n## TECHNOLOGY\\n- [ ] IT systems overview\\n- [ ] Cybersecurity assessment\\n- [ ] Data privacy compliance`,\n                  \n                  closing_checklist: `# CLOSING CHECKLIST\\n\\n**Deal:** ${deal?.name || '[Deal Name]'}\\n**Target Close Date:** [Date]\\n\\n## PRE-CLOSING\\n- [ ] Final due diligence complete\\n- [ ] Purchase agreement negotiated and executed\\n- [ ] Disclosure schedules finalized\\n- [ ] Regulatory approvals obtained\\n- [ ] Third-party consents received\\n- [ ] Financing confirmed\\n\\n## CLOSING DAY\\n- [ ] Bring-down of representations\\n- [ ] Funds transfer verification\\n- [ ] Signature pages collected\\n- [ ] Certificate of closing\\n- [ ] Press release approval\\n\\n## POST-CLOSING\\n- [ ] File necessary documents\\n- [ ] Transfer ownership records\\n- [ ] Update corporate books\\n- [ ] Integration kickoff\\n- [ ] Stakeholder notifications`,\n                  \n                  pitch_deck_outline: `# PITCH DECK OUTLINE\\n\\n**Company:** ${deal?.client || '[Client Name]'}\\n**Prepared for:** ${deal?.name || '[Transaction]'}\\n\\n## SLIDE 1: COVER\\n- Company name and logo\\n- Tagline/value proposition\\n- Date and confidentiality notice\\n\\n## SLIDE 2: EXECUTIVE SUMMARY\\n- Company overview\\n- Transaction rationale\\n- Key investment highlights\\n\\n## SLIDE 3: COMPANY OVERVIEW\\n- Business description\\n- History and milestones\\n- Mission and vision\\n\\n## SLIDE 4: MARKET OPPORTUNITY\\n- Total addressable market\\n- Market trends\\n- Competitive landscape\\n\\n## SLIDE 5: PRODUCTS/SERVICES\\n- Product portfolio\\n- Competitive advantages\\n- Technology/IP\\n\\n## SLIDE 6: BUSINESS MODEL\\n- Revenue streams\\n- Customer segments\\n- Go-to-market strategy\\n\\n## SLIDE 7: FINANCIAL HIGHLIGHTS\\n- Historical performance\\n- Key metrics and KPIs\\n- Projections\\n\\n## SLIDE 8: MANAGEMENT TEAM\\n- Key executives\\n- Board of directors\\n- Advisory board\\n\\n## SLIDE 9: INVESTMENT HIGHLIGHTS\\n- Key strengths\\n- Growth opportunities\\n- Transaction value: $${deal?.value || '[X]'}M\\n\\n## SLIDE 10: APPENDIX\\n- Detailed financials\\n- Customer case studies\\n- Additional data`\n                };\n                \n                const docContent = documentTemplates[args.documentType] || \"Document template not found\";\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: `GENERATED_DOCUMENT_START\\n${docContent}\\nGENERATED_DOCUMENT_END\\n\\nDocument type: ${args.documentType.replace(/_/g, ' ').toUpperCase()}`\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to generate document\"\n                });\n              }\n            } else if (functionCall?.name === \"get_deal_recommendation\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const deal = deals.find(d => d.name.toLowerCase().includes(args.dealName.toLowerCase()));\n                \n                if (!deal) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Deal \"${args.dealName}\" not found.`\n                  });\n                  continue;\n                }\n                \n                const stageRecommendations: Record<string, string[]> = {\n                  'Origination': [\n                    'Schedule initial client meeting to understand objectives',\n                    'Prepare preliminary valuation analysis',\n                    'Identify potential buyers/investors based on sector',\n                    'Draft engagement letter and fee proposal',\n                    'Conduct initial market assessment'\n                  ],\n                  'Structuring': [\n                    'Define transaction structure and key terms',\n                    'Prepare confidential information memorandum (CIM)',\n                    'Develop marketing materials and teaser',\n                    'Identify target investor/buyer list',\n                    'Prepare management presentation outline'\n                  ],\n                  'Diligence': [\n                    'Organize virtual data room',\n                    'Coordinate management presentations',\n                    'Address buyer/investor questions promptly',\n                    'Track due diligence request list completion',\n                    'Prepare for potential issues discovered'\n                  ],\n                  'Legal': [\n                    'Review and markup transaction documents',\n                    'Negotiate key commercial terms',\n                    'Complete disclosure schedules',\n                    'Obtain necessary third-party consents',\n                    'Coordinate with legal counsel on documentation'\n                  ],\n                  'Close': [\n                    'Confirm all closing conditions satisfied',\n                    'Coordinate funds flow',\n                    'Execute signature pages',\n                    'Prepare announcement materials',\n                    'Plan post-closing integration'\n                  ]\n                };\n                \n                const recommendations = stageRecommendations[deal.stage] || stageRecommendations['Origination'];\n                const dealTasks = allTasks.filter(t => t.dealId === deal.id);\n                const openTasks = dealTasks.filter(t => t.status !== 'Completed');\n                const overdueTasks = dealTasks.filter(t => new Date(t.dueDate) < new Date() && t.status !== 'Completed');\n                \n                const recommendation = `\nDEAL ANALYSIS: ${deal.name}\nCurrent Stage: ${deal.stage}\nProgress: ${deal.progress}%\nValue: $${deal.value}M\n\nCURRENT STATUS:\n- Open Tasks: ${openTasks.length}\n- Overdue Tasks: ${overdueTasks.length}\n${overdueTasks.length > 0 ? `-  Overdue: ${overdueTasks.map(t => t.title).join(', ')}` : ''}\n\nRECOMMENDED NEXT STEPS FOR ${deal.stage.toUpperCase()} STAGE:\n${recommendations.map((r, i) => `${i + 1}. ${r}`).join('\\n')}\n\nPRIORITY ACTIONS:\n${deal.progress < 25 ? ' Deal is early stage - focus on building momentum' : deal.progress < 50 ? ' Mid-process - maintain timeline discipline' : deal.progress < 75 ? ' Good progress - push toward completion' : ' Final stretch - ensure all conditions are met'}\n                `;\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: recommendation\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to analyze deal\"\n                });\n              }\n            } else if (functionCall?.name === \"analyze_investor_fit\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const deal = deals.find(d => d.name.toLowerCase().includes(args.dealName.toLowerCase()));\n                \n                if (!deal) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Deal \"${args.dealName}\" not found.`\n                  });\n                  continue;\n                }\n                \n                const limit = args.limit || 5;\n                const dealSector = deal.sector?.toLowerCase() || '';\n                \n                // Score investors based on sector match\n                const scoredInvestors = investors\n                  .filter(inv => inv.status === 'Active')\n                  .map(inv => {\n                    let score = 0;\n                    const invSectors = (inv.preferredSectors || []).map(s => s.toLowerCase());\n                    const invFocus = inv.focus?.toLowerCase() || '';\n                    \n                    // Exact sector match\n                    if (invSectors.includes(dealSector) || invFocus.includes(dealSector)) {\n                      score += 50;\n                    }\n                    // Partial match\n                    if (invSectors.some(s => dealSector.includes(s) || s.includes(dealSector))) {\n                      score += 30;\n                    }\n                    // Check size fit\n                    if (inv.minInvestment && inv.maxInvestment) {\n                      if (deal.value >= inv.minInvestment && deal.value <= inv.maxInvestment) {\n                        score += 40;\n                      } else if (deal.value >= inv.minInvestment * 0.5 && deal.value <= inv.maxInvestment * 1.5) {\n                        score += 20;\n                      }\n                    }\n                    // Favorite bonus\n                    if (inv.isFavorite) score += 10;\n                    \n                    return { ...inv, score };\n                  })\n                  .filter(inv => inv.score > 0)\n                  .sort((a, b) => b.score - a.score)\n                  .slice(0, limit);\n                \n                if (scoredInvestors.length === 0) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `No matching investors found for ${deal.name} (${deal.sector} sector). Consider expanding your investor database.`\n                  });\n                  continue;\n                }\n                \n                const analysis = `\nINVESTOR ANALYSIS FOR: ${deal.name}\nSector: ${deal.sector}\nDeal Size: $${deal.value}M\n\nTOP ${scoredInvestors.length} RECOMMENDED INVESTORS:\n${scoredInvestors.map((inv, i) => `\n${i + 1}. ${inv.name} (Match Score: ${inv.score}%)\n   Type: ${inv.type}\n   Focus: ${inv.focus || 'Multi-sector'}\n   Investment Range: $${inv.minInvestment || 0}M - $${inv.maxInvestment || ''}M\n   AUM: ${inv.aum ? `$${inv.aum}B` : 'N/A'}\n`).join('')}\n\nRECOMMENDATION: Start outreach with ${scoredInvestors[0]?.name} - highest match score based on sector alignment and investment criteria.\n                `;\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: analysis\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to analyze investor fit\"\n                });\n              }\n            } else if (functionCall?.name === \"get_market_data\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const symbol = args.symbol.toUpperCase();\n                const includeNews = args.includeNews ?? false;\n                \n                const finnhubKey = process.env.FINNHUB_API_KEY;\n                if (!finnhubKey) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"Market data service is not configured. Please add FINNHUB_API_KEY.\"\n                  });\n                  continue;\n                }\n                \n                // Fetch quote data\n                const quoteResponse = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubKey}`);\n                const quoteData = await quoteResponse.json() as any;\n                \n                let result = `\nMARKET DATA FOR: ${symbol}\nCurrent Price: $${quoteData.c?.toFixed(2) || 'N/A'}\nChange: ${quoteData.d >= 0 ? '+' : ''}${quoteData.d?.toFixed(2) || 'N/A'} (${quoteData.dp >= 0 ? '+' : ''}${quoteData.dp?.toFixed(2) || 'N/A'}%)\nHigh: $${quoteData.h?.toFixed(2) || 'N/A'}\nLow: $${quoteData.l?.toFixed(2) || 'N/A'}\nOpen: $${quoteData.o?.toFixed(2) || 'N/A'}\nPrevious Close: $${quoteData.pc?.toFixed(2) || 'N/A'}\n`;\n                \n                // Fetch news if requested\n                if (includeNews) {\n                  const today = new Date().toISOString().split('T')[0];\n                  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n                  const newsResponse = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${weekAgo}&to=${today}&token=${finnhubKey}`);\n                  const newsData = await newsResponse.json() as any[];\n                  \n                  if (newsData && newsData.length > 0) {\n                    result += `\nRECENT NEWS:\n${newsData.slice(0, 5).map((n, i) => `${i + 1}. ${n.headline} (${new Date(n.datetime * 1000).toLocaleDateString()})`).join('\\n')}\n`;\n                  }\n                }\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to fetch market data\"\n                });\n              }\n            } else if (functionCall?.name === \"summarize_document\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                let document: any;\n                \n                if (args.documentId) {\n                  document = await storage.getDocument(args.documentId);\n                } else if (args.documentName) {\n                  const allDocs = await storage.getAllDocuments();\n                  document = allDocs.find(d => d.filename.toLowerCase().includes(args.documentName.toLowerCase()));\n                }\n                \n                if (!document) {\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: \"Document not found. Please specify a valid document ID or name.\"\n                  });\n                  continue;\n                }\n                \n                const summaryType = args.summaryType || 'brief';\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: `\nDOCUMENT SUMMARY: ${document.filename}\nCategory: ${document.category || 'Uncategorized'}\nDeal: ${document.dealId ? deals.find(d => d.id === document.dealId)?.name || 'Unknown' : 'N/A'}\nTags: ${document.tags?.join(', ') || 'None'}\nUploaded: ${document.uploadedAt ? new Date(document.uploadedAt).toLocaleDateString() : 'Unknown'}\n\nThis is a ${document.category || 'general'} document. To get a full content summary, the document text would need to be processed by the AI. Currently showing metadata summary.\n`\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to summarize document\"\n                });\n              }\n            } else if (functionCall?.name === \"generate_meeting_prep\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                let meeting: any;\n                \n                if (args.meetingId) {\n                  meeting = meetings.find(m => m.id === args.meetingId);\n                } else if (args.meetingTitle) {\n                  meeting = meetings.find(m => m.title.toLowerCase().includes(args.meetingTitle.toLowerCase()));\n                }\n                \n                if (!meeting) {\n                  const upcomingList = meetings\n                    .filter(m => new Date(m.date) >= now)\n                    .slice(0, 5)\n                    .map(m => `- ${m.title} (${new Date(m.date).toLocaleDateString()})`)\n                    .join('\\n');\n                  toolResults.push({\n                    tool_call_id: toolCall.id,\n                    result: `Meeting not found. Upcoming meetings:\\n${upcomingList}`\n                  });\n                  continue;\n                }\n                \n                // Get related deal if any\n                const relatedDeal = meeting.dealId ? deals.find(d => d.id === meeting.dealId) : null;\n                const dealTasks = relatedDeal ? allTasks.filter(t => t.dealId === relatedDeal.id) : [];\n                const dealDocs = relatedDeal ? documents.filter(d => d.dealId === relatedDeal.id) : [];\n                \n                const prep = `\nMEETING PREPARATION: ${meeting.title}\nDate: ${new Date(meeting.date).toLocaleDateString()} at ${meeting.time}\nLocation: ${meeting.location || 'TBD'}\nAttendees: ${meeting.attendees?.join(', ') || 'TBD'}\n\nSUGGESTED AGENDA:\n1. Opening and introductions (5 min)\n2. Review of key topics and objectives (10 min)\n3. Main discussion points (30 min)\n4. Action items and next steps (10 min)\n5. Q&A and closing (5 min)\n\n${relatedDeal ? `\nDEAL CONTEXT: ${relatedDeal.name}\nStage: ${relatedDeal.stage}\nProgress: ${relatedDeal.progress}%\nValue: $${relatedDeal.value}M\nOpen Tasks: ${dealTasks.filter(t => t.status !== 'Completed').length}\nDocuments: ${dealDocs.length}\n` : ''}\n\nTALKING POINTS:\n Review progress since last meeting\n Discuss any blockers or concerns\n Align on priorities and timelines\n Confirm next steps and responsibilities\n\nPREPARATION CHECKLIST:\n Review relevant documents\n Prepare status update\n List questions/concerns to address\n Have data/metrics ready to share\n`;\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: prep\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to generate meeting prep\"\n                });\n              }\n            } else if (functionCall?.name === \"get_pipeline_analytics\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const timeframe = args.timeframe || 'quarter';\n                const sectorFilter = args.sector?.toLowerCase();\n                \n                // Calculate timeframe dates\n                const timeframes: Record<string, number> = {\n                  week: 7,\n                  month: 30,\n                  quarter: 90,\n                  year: 365,\n                  all: 10000\n                };\n                const daysBack = timeframes[timeframe] || 90;\n                const cutoffDate = new Date(now.getTime() - daysBack * 24 * 60 * 60 * 1000);\n                \n                // Filter deals by timeframe\n                let filteredDeals = deals.filter(d => {\n                  const created = d.createdAt ? new Date(d.createdAt) : now;\n                  return created >= cutoffDate;\n                });\n                \n                if (sectorFilter) {\n                  filteredDeals = filteredDeals.filter(d => d.sector?.toLowerCase().includes(sectorFilter));\n                }\n                \n                // Calculate metrics\n                const totalValue = filteredDeals.reduce((sum, d) => sum + d.value, 0);\n                const avgValue = filteredDeals.length > 0 ? totalValue / filteredDeals.length : 0;\n                const wonDeals = filteredDeals.filter(d => d.status === 'Won' || d.status === 'Closed');\n                const winRate = filteredDeals.length > 0 ? (wonDeals.length / filteredDeals.length * 100) : 0;\n                \n                // Stage distribution\n                const stageDistribution = filteredDeals.reduce((acc, d) => {\n                  acc[d.stage] = (acc[d.stage] || 0) + 1;\n                  return acc;\n                }, {} as Record<string, number>);\n                \n                // Sector breakdown\n                const sectorBreakdown = filteredDeals.reduce((acc, d) => {\n                  const sector = d.sector || 'Other';\n                  acc[sector] = (acc[sector] || { count: 0, value: 0 });\n                  acc[sector].count++;\n                  acc[sector].value += d.value;\n                  return acc;\n                }, {} as Record<string, { count: number; value: number }>);\n                \n                const analytics = `\nPIPELINE ANALYTICS (${timeframe.toUpperCase()})\n${sectorFilter ? `Sector: ${sectorFilter}\\n` : ''}\nOVERVIEW:\nTotal Deals: ${filteredDeals.length}\nTotal Pipeline Value: $${totalValue.toFixed(1)}M\nAverage Deal Size: $${avgValue.toFixed(1)}M\nWin Rate: ${winRate.toFixed(1)}%\n\nSTAGE DISTRIBUTION:\n${Object.entries(stageDistribution).map(([stage, count]) => ` ${stage}: ${count} deals (${(count/filteredDeals.length*100).toFixed(0)}%)`).join('\\n')}\n\nSECTOR BREAKDOWN:\n${Object.entries(sectorBreakdown).map(([sector, data]) => ` ${sector}: ${data.count} deals, $${data.value.toFixed(1)}M`).join('\\n')}\n\nKEY INSIGHTS:\n${filteredDeals.filter(d => d.progress >= 75).length > 0 ? ` ${filteredDeals.filter(d => d.progress >= 75).length} deals near completion (75%+ progress)` : ''}\n${stalledDeals.length > 0 ? ` ${stalledDeals.length} stalled deals need attention` : ' No stalled deals'}\n`;\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: analytics\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to generate pipeline analytics\"\n                });\n              }\n            } else if (functionCall?.name === \"get_team_performance\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const timeframe = args.timeframe || 'month';\n                \n                const timeframes: Record<string, number> = {\n                  week: 7,\n                  month: 30,\n                  quarter: 90,\n                  year: 365\n                };\n                const daysBack = timeframes[timeframe] || 30;\n                const cutoffDate = new Date(now.getTime() - daysBack * 24 * 60 * 60 * 1000);\n                \n                // Filter to specific user if requested\n                let targetUsers = users;\n                if (args.userName) {\n                  targetUsers = users.filter(u => u.name.toLowerCase().includes(args.userName.toLowerCase()));\n                } else if (args.userId) {\n                  targetUsers = users.filter(u => u.id === args.userId);\n                }\n                \n                const performanceData = targetUsers.map(u => {\n                  const userTasks = allTasks.filter(t => t.assignedTo === u.id);\n                  const completedTasks = userTasks.filter(t => t.status === 'Completed' && t.updatedAt && new Date(t.updatedAt) >= cutoffDate);\n                  const activeTasks = userTasks.filter(t => t.status !== 'Completed');\n                  const overdueTasks = userTasks.filter(t => new Date(t.dueDate) < now && t.status !== 'Completed');\n                  const userDeals = deals.filter(d => d.lead === u.name);\n                  \n                  return {\n                    name: u.name,\n                    role: u.role,\n                    completedTasks: completedTasks.length,\n                    activeTasks: activeTasks.length,\n                    overdueTasks: overdueTasks.length,\n                    activeDeals: userDeals.filter(d => d.status === 'Active').length,\n                    efficiency: userTasks.length > 0 ? (completedTasks.length / userTasks.length * 100) : 0,\n                    workloadScore: activeTasks.length + (overdueTasks.length * 2),\n                  };\n                }).sort((a, b) => b.efficiency - a.efficiency);\n                \n                const performance = `\nTEAM PERFORMANCE (${timeframe.toUpperCase()})\n\n${performanceData.map(p => `\n${p.name} (${p.role})\n   Completed: ${p.completedTasks} tasks\n   Active: ${p.activeTasks} tasks\n  ${p.overdueTasks > 0 ? ` Overdue: ${p.overdueTasks} tasks` : ' No overdue tasks'}\n   Active Deals: ${p.activeDeals}\n   Efficiency: ${p.efficiency.toFixed(0)}%\n   Workload Score: ${p.workloadScore} ${p.workloadScore > 10 ? '(HIGH)' : p.workloadScore > 5 ? '(MODERATE)' : '(LOW)'}\n`).join('\\n')}\n\nSUMMARY:\n Highest Performer: ${performanceData[0]?.name || 'N/A'} (${performanceData[0]?.efficiency.toFixed(0) || 0}% efficiency)\n Total Completed Tasks: ${performanceData.reduce((sum, p) => sum + p.completedTasks, 0)}\n Team Capacity: ${performanceData.filter(p => p.workloadScore <= 5).length} members with available capacity\n`;\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: performance\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to generate team performance\"\n                });\n              }\n            } else if (functionCall?.name === \"generate_report\") {\n              try {\n                const args = JSON.parse(functionCall.arguments);\n                const reportType = args.reportType;\n                const format = args.format || 'summary';\n                const title = args.title || `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`;\n                \n                let reportContent = `\n# ${title}\nGenerated: ${new Date().toLocaleString()}\nReport Type: ${reportType}\n\n`;\n                \n                switch (reportType) {\n                  case 'pipeline':\n                    reportContent += `\n## Pipeline Overview\n- Total Deals: ${deals.length}\n- Active: ${deals.filter(d => d.status === 'Active').length}\n- Won/Closed: ${deals.filter(d => d.status === 'Won' || d.status === 'Closed').length}\n- Total Value: $${deals.reduce((sum, d) => sum + d.value, 0).toFixed(1)}M\n\n## Stage Distribution\n${Object.entries(dealsByStage).map(([stage, count]) => `- ${stage}: ${count}`).join('\\n')}\n`;\n                    break;\n                  case 'team':\n                    reportContent += `\n## Team Summary\n- Total Members: ${users.length}\n- Active Tasks: ${allTasks.filter(t => t.status !== 'Completed').length}\n- Overdue Tasks: ${allOverdueTasks.length}\n\n## Workload Distribution\n${teamWorkload.slice(0, 10).map(m => `- ${m.name}: ${m.activeTasks} active, ${m.overdueTasks} overdue`).join('\\n')}\n`;\n                    break;\n                  case 'deals':\n                    reportContent += `\n## Deals Summary\n${deals.slice(0, 10).map(d => `\n### ${d.name}\n- Client: ${d.client}\n- Sector: ${d.sector}\n- Stage: ${d.stage}\n- Value: $${d.value}M\n- Progress: ${d.progress}%\n`).join('\\n')}\n`;\n                    break;\n                  case 'tasks':\n                    reportContent += `\n## Tasks Summary\n- Total Tasks: ${allTasks.length}\n- Pending: ${allTasks.filter(t => t.status === 'Pending').length}\n- In Progress: ${allTasks.filter(t => t.status === 'In Progress').length}\n- Completed: ${allTasks.filter(t => t.status === 'Completed').length}\n- Overdue: ${allOverdueTasks.length}\n\n## Upcoming Deadlines\n${upcomingDeadlines.slice(0, 10).map(t => `- ${t.title} (Due: ${new Date(t.dueDate).toLocaleDateString()})`).join('\\n')}\n`;\n                    break;\n                  case 'investors':\n                    reportContent += `\n## Investor Summary\n- Total Investors: ${investors.length}\n- Active: ${investors.filter(i => i.status === 'Active').length}\n\n## By Type\n${Object.entries(investors.reduce((acc, i) => { acc[i.type] = (acc[i.type] || 0) + 1; return acc; }, {} as Record<string, number>)).map(([type, count]) => `- ${type}: ${count}`).join('\\n')}\n`;\n                    break;\n                  default:\n                    reportContent += `Custom report based on: ${args.requirements}\\n\\nNote: For custom reports, please be more specific about what data you need.`;\n                }\n                \n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: reportContent\n                });\n              } catch (parseError) {\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  result: \"Failed to generate report\"\n                });\n              }\n            }\n          }\n          \n          // Get final response after tool execution\n          const toolMessages = responseMessage.tool_calls.map((tc, i) => ({\n            role: \"tool\" as const,\n            tool_call_id: tc.id,\n            content: toolResults[i]?.result || \"Function executed\"\n          }));\n          \n          const followUpCompletion = await openai.chat.completions.create({\n            model: \"gpt-4o\",\n            messages: [\n              { role: \"system\", content: systemPrompt },\n              ...conversationHistory,\n              { role: \"user\", content },\n              { role: \"assistant\", content: null, tool_calls: responseMessage.tool_calls },\n              ...toolMessages,\n            ],\n            max_completion_tokens: 2048,\n          });\n          \n          console.log('[Assistant] Follow-up content:', followUpCompletion.choices[0]?.message?.content?.slice(0, 100) || 'EMPTY');\n          assistantContent = followUpCompletion.choices[0]?.message?.content || \"I've completed the action.\";\n        }\n        \n        if (!assistantContent) {\n          assistantContent = \"I apologize, but I couldn't generate a response. Please try again.\";\n        }\n        \n        // Save assistant response\n        const assistantMessage = await storage.createAssistantMessage({\n          conversationId: req.params.id,\n          role: 'assistant',\n          content: assistantContent,\n          context: platformContext as any,\n        });\n        \n        // Update conversation title if it's the first message\n        if (previousMessages.length === 0) {\n          const titleWords = content.split(' ').slice(0, 5).join(' ');\n          const title = titleWords.length > 30 ? titleWords.substring(0, 30) + '...' : titleWords;\n          await storage.updateAssistantConversationTitle(req.params.id, title);\n        }\n        \n        res.json({\n          userMessage,\n          assistantMessage,\n        });\n      } catch (aiError: any) {\n        console.error('OpenAI API error:', aiError);\n        \n        // Still save a fallback response\n        const fallbackMessage = await storage.createAssistantMessage({\n          conversationId: req.params.id,\n          role: 'assistant',\n          content: \"I'm having trouble connecting right now. Please try again in a moment.\",\n        });\n        \n        res.json({\n          userMessage,\n          assistantMessage: fallbackMessage,\n        });\n      }\n    } catch (error) {\n      console.error('Error in assistant chat:', error);\n      res.status(500).json({ error: \"Failed to process message\" });\n    }\n  });\n  \n  // Update conversation title\n  app.patch(\"/api/assistant/conversations/:id\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getAssistantConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      if (conversation.userId !== currentUser.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const { title } = req.body;\n      if (!title || typeof title !== 'string') {\n        return res.status(400).json({ error: \"Title is required\" });\n      }\n      \n      const updated = await storage.updateAssistantConversationTitle(req.params.id, title);\n      res.json(updated);\n    } catch (error) {\n      console.error('Error updating conversation:', error);\n      res.status(500).json({ error: \"Failed to update conversation\" });\n    }\n  });\n  \n  // Delete conversation\n  app.delete(\"/api/assistant/conversations/:id\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getAssistantConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      if (conversation.userId !== currentUser.id) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      await storage.deleteAssistantConversation(req.params.id);\n      res.json({ message: \"Conversation deleted successfully\" });\n    } catch (error) {\n      console.error('Error deleting conversation:', error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // ===== CHAT SYSTEM ROUTES =====\n  \n  // Get user's conversations\n  app.get(\"/api/chat/conversations\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversations = await storage.getConversationsByUser(currentUser.id);\n      \n      // Enrich conversations with member details and last message\n      const enrichedConversations = await Promise.all(\n        conversations.map(async (conv) => {\n          const members = await storage.getConversationMembers(conv.id);\n          const messages = await storage.getMessages(conv.id);\n          const lastMessage = messages[messages.length - 1];\n          \n          const memberDetails = await Promise.all(\n            members.map(async (m) => {\n              const user = await storage.getUser(m.userId);\n              return user ? { id: user.id, name: user.name, avatar: user.avatar } : null;\n            })\n          );\n          \n          return {\n            ...conv,\n            members: memberDetails.filter(Boolean),\n            lastMessage: lastMessage ? {\n              content: lastMessage.content,\n              senderId: lastMessage.senderId,\n              createdAt: lastMessage.createdAt,\n            } : null,\n            unreadCount: 0, // Will be calculated client-side or enhanced later\n          };\n        })\n      );\n      \n      res.json(enrichedConversations);\n    } catch (error) {\n      console.error('Error fetching conversations:', error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n  \n  // Create new conversation or get existing one\n  app.post(\"/api/chat/conversations\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { participantId, isGroup, name, participantIds } = req.body;\n      \n      if (isGroup) {\n        // Create group conversation\n        if (!participantIds || participantIds.length < 2) {\n          return res.status(400).json({ error: \"Group requires at least 2 participants\" });\n        }\n        \n        const conversation = await storage.createConversation({\n          name: name || 'Group Chat',\n          isGroup: true,\n          createdBy: currentUser.id,\n        });\n        \n        // Add all members including creator\n        await storage.addConversationMember(conversation.id, currentUser.id);\n        for (const pid of participantIds) {\n          if (pid !== currentUser.id) {\n            await storage.addConversationMember(conversation.id, pid);\n          }\n        }\n        \n        res.json(conversation);\n      } else {\n        // Direct message - check if conversation already exists\n        if (!participantId) {\n          return res.status(400).json({ error: \"participantId is required for direct messages\" });\n        }\n        \n        let conversation = await storage.getConversationBetweenUsers(currentUser.id, participantId);\n        \n        if (!conversation) {\n          // Create new conversation\n          const participant = await storage.getUser(participantId);\n          conversation = await storage.createConversation({\n            name: participant?.name || 'Direct Message',\n            isGroup: false,\n            createdBy: currentUser.id,\n          });\n          \n          await storage.addConversationMember(conversation.id, currentUser.id);\n          await storage.addConversationMember(conversation.id, participantId);\n        }\n        \n        res.json(conversation);\n      }\n    } catch (error) {\n      console.error('Error creating conversation:', error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n  \n  // Get messages for a conversation\n  app.get(\"/api/chat/conversations/:id/messages\", requireAuth, requireInternal, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      // Verify user is a member\n      const members = await storage.getConversationMembers(req.params.id);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const messages = await storage.getMessages(req.params.id);\n      \n      // Enrich messages with sender details\n      const enrichedMessages = await Promise.all(\n        messages.map(async (msg) => {\n          const sender = await storage.getUser(msg.senderId);\n          return {\n            ...msg,\n            senderName: sender?.name || 'Unknown',\n            senderAvatar: sender?.avatar,\n          };\n        })\n      );\n      \n      // Mark as read\n      await storage.markMessagesAsRead(req.params.id, currentUser.id);\n      \n      res.json(enrichedMessages);\n    } catch (error) {\n      console.error('Error fetching messages:', error);\n      res.status(500).json({ error: \"Failed to fetch messages\" });\n    }\n  });\n  \n  // Send message\n  app.post(\"/api/chat/conversations/:id/messages\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { content, attachments, mentionedUserIds, replyToMessageId } = req.body;\n      \n      if (!content || typeof content !== 'string' || content.trim().length === 0) {\n        return res.status(400).json({ error: \"Message content is required\" });\n      }\n      \n      const conversation = await storage.getConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      // Verify user is a member\n      const members = await storage.getConversationMembers(req.params.id);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      const message = await storage.createMessage({\n        conversationId: req.params.id,\n        senderId: currentUser.id,\n        content: content.trim(),\n        attachments: attachments || [],\n        replyToMessageId: replyToMessageId || null,\n      });\n      \n      // Create notifications for mentioned users first (higher priority)\n      // Validate mentioned users are actual conversation members for security\n      const memberIds = new Set(members.map(m => m.userId));\n      const validMentionedIds = (mentionedUserIds || []).filter((id: string) => memberIds.has(id));\n      const mentionedSet = new Set(validMentionedIds);\n      \n      for (const mentionedUserId of mentionedSet) {\n        if (mentionedUserId !== currentUser.id) {\n          await storage.createNotification({\n            userId: mentionedUserId,\n            title: 'You were mentioned',\n            message: `${currentUser.name} mentioned you: ${content.slice(0, 50)}${content.length > 50 ? '...' : ''}`,\n            type: 'alert',\n            link: '/ceo/chat',\n          });\n        }\n      }\n      \n      // Create regular notifications for other non-mentioned members\n      for (const member of members) {\n        if (member.userId !== currentUser.id && !mentionedSet.has(member.userId)) {\n          await storage.createNotification({\n            userId: member.userId,\n            title: 'New Message',\n            message: `${currentUser.name}: ${content.slice(0, 50)}${content.length > 50 ? '...' : ''}`,\n            type: 'info',\n            link: '/ceo/chat',\n          });\n        }\n      }\n      \n      res.json({\n        ...message,\n        senderName: currentUser.name,\n        senderAvatar: currentUser.avatar,\n      });\n    } catch (error) {\n      console.error('Error sending message:', error);\n      res.status(500).json({ error: \"Failed to send message\" });\n    }\n  });\n\n  // Delete (unsend) a message - only the sender can delete their own messages\n  app.delete(\"/api/chat/conversations/:conversationId/messages/:messageId\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { conversationId, messageId } = req.params;\n      \n      // Verify conversation exists and user is a member\n      const conversation = await storage.getConversation(conversationId);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      const members = await storage.getConversationMembers(conversationId);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Verify message exists and belongs to this conversation\n      const message = await storage.getMessage(messageId);\n      if (!message) {\n        return res.status(404).json({ error: \"Message not found\" });\n      }\n      \n      if (message.conversationId !== conversationId) {\n        return res.status(400).json({ error: \"Message does not belong to this conversation\" });\n      }\n      \n      // Only the sender can delete their own message\n      if (message.senderId !== currentUser.id) {\n        return res.status(403).json({ error: \"You can only unsend your own messages\" });\n      }\n      \n      await storage.deleteMessage(messageId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting message:', error);\n      res.status(500).json({ error: \"Failed to delete message\" });\n    }\n  });\n  \n  // Add reaction to a message\n  app.post(\"/api/chat/conversations/:conversationId/messages/:messageId/reactions\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { conversationId, messageId } = req.params;\n      const { emoji } = req.body;\n      \n      if (!emoji || typeof emoji !== 'string') {\n        return res.status(400).json({ error: \"Emoji is required\" });\n      }\n      \n      // Verify conversation exists and user is a member\n      const conversation = await storage.getConversation(conversationId);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      const members = await storage.getConversationMembers(conversationId);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Verify message exists\n      const message = await storage.getMessage(messageId);\n      if (!message || message.conversationId !== conversationId) {\n        return res.status(404).json({ error: \"Message not found\" });\n      }\n      \n      // Add reaction\n      const reactions = (message.reactions || []) as any[];\n      const existingIndex = reactions.findIndex(r => r.userId === currentUser.id && r.emoji === emoji);\n      \n      if (existingIndex >= 0) {\n        // Remove reaction if already exists (toggle)\n        reactions.splice(existingIndex, 1);\n      } else {\n        // Add new reaction\n        reactions.push({\n          emoji,\n          userId: currentUser.id,\n          userName: currentUser.name,\n          createdAt: new Date().toISOString(),\n        });\n      }\n      \n      const updated = await storage.updateMessage(messageId, { reactions });\n      res.json(updated);\n    } catch (error) {\n      console.error('Error adding reaction:', error);\n      res.status(500).json({ error: \"Failed to add reaction\" });\n    }\n  });\n  \n  // Update chat conversation (name)\n  app.patch(\"/api/chat/conversations/:id\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { name } = req.body;\n      const conversation = await storage.getConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      // Verify user is a member\n      const members = await storage.getConversationMembers(req.params.id);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      if (!name || typeof name !== 'string' || name.trim().length === 0) {\n        return res.status(400).json({ error: \"Name is required\" });\n      }\n      \n      const updated = await storage.updateConversation(req.params.id, { name: name.trim() });\n      res.json(updated);\n    } catch (error) {\n      console.error('Error updating conversation:', error);\n      res.status(500).json({ error: \"Failed to update conversation\" });\n    }\n  });\n\n  // Delete chat conversation\n  app.delete(\"/api/chat/conversations/:id\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const conversation = await storage.getConversation(req.params.id);\n      \n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      // Verify user is a member\n      const members = await storage.getConversationMembers(req.params.id);\n      if (!members.some(m => m.userId === currentUser.id)) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n      \n      // Delete all messages first, then members, then conversation\n      await storage.deleteConversationMessages(req.params.id);\n      await storage.deleteConversationMembers(req.params.id);\n      await storage.deleteConversation(req.params.id);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting conversation:', error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send message to user by name (for Reaper assistant integration)\n  app.post(\"/api/chat/send-to-user\", requireAuth, async (req, res) => {\n    try {\n      const currentUser = req.user as any;\n      const { recipientName, content, attachments } = req.body;\n      \n      if (!recipientName || typeof recipientName !== 'string') {\n        return res.status(400).json({ error: \"Recipient name is required\" });\n      }\n      \n      if (!content || typeof content !== 'string' || content.trim().length === 0) {\n        return res.status(400).json({ error: \"Message content is required\" });\n      }\n      \n      // Find user by name (case insensitive)\n      const allUsers = await storage.getAllUsers();\n      const recipient = allUsers.find(u => \n        u.name.toLowerCase() === recipientName.toLowerCase() ||\n        u.name.toLowerCase().includes(recipientName.toLowerCase())\n      );\n      \n      if (!recipient) {\n        return res.status(404).json({ error: `User \"${recipientName}\" not found` });\n      }\n      \n      if (recipient.id === currentUser.id) {\n        return res.status(400).json({ error: \"Cannot send message to yourself\" });\n      }\n      \n      // Get or create conversation\n      let conversation = await storage.getConversationBetweenUsers(currentUser.id, recipient.id);\n      \n      if (!conversation) {\n        conversation = await storage.createConversation({\n          name: recipient.name,\n          isGroup: false,\n          createdBy: currentUser.id,\n        });\n        \n        await storage.addConversationMember(conversation.id, currentUser.id);\n        await storage.addConversationMember(conversation.id, recipient.id);\n      }\n      \n      // Send message\n      const message = await storage.createMessage({\n        conversationId: conversation.id,\n        senderId: currentUser.id,\n        content: content.trim(),\n        attachments: attachments || [],\n      });\n      \n      // Create notification for recipient\n      await storage.createNotification({\n        userId: recipient.id,\n        title: 'New Message',\n        message: `${currentUser.name}: ${content.slice(0, 50)}${content.length > 50 ? '...' : ''}`,\n        type: 'info',\n        link: '/ceo/chat',\n      });\n      \n      res.json({\n        success: true,\n        message: {\n          ...message,\n          senderName: currentUser.name,\n          recipientName: recipient.name,\n        },\n        conversationId: conversation.id,\n      });\n    } catch (error) {\n      console.error('Error sending message to user:', error);\n      res.status(500).json({ error: \"Failed to send message\" });\n    }\n  });\n\n  // ===== MARKET DATA ROUTE =====\n  \n  app.get(\"/api/market-data\", requireAuth, async (req, res) => {\n    try {\n      const finnhubKey = process.env.FINNHUB_API_KEY;\n      \n      // Accept symbols from query parameter or use defaults\n      const requestedSymbols = req.query.symbols \n        ? (req.query.symbols as string).split(',').map(s => s.trim().toUpperCase())\n        : ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'SPY'];\n      \n      if (finnhubKey) {\n        // Fetch real data from Finnhub\n        const symbols = requestedSymbols;\n        const quotes = await Promise.all(\n          symbols.map(async (symbol) => {\n            try {\n              const response = await fetch(\n                `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubKey}`\n              );\n              const data = await response.json();\n              return {\n                symbol,\n                name: getSymbolName(symbol),\n                description: getSymbolDescription(symbol),\n                currentPrice: data.c,\n                change: data.d,\n                changePercent: data.dp,\n                high: data.h,\n                low: data.l,\n                open: data.o,\n                previousClose: data.pc,\n              };\n            } catch (err) {\n              return null;\n            }\n          })\n        );\n        \n        const validQuotes = quotes.filter((q): q is NonNullable<typeof q> => q !== null && q.currentPrice > 0);\n        \n        if (validQuotes.length > 0) {\n          const marketData = validQuotes.map(q => ({\n            name: q!.name,\n            symbol: q!.symbol,\n            value: q!.currentPrice < 100 \n              ? `$${q!.currentPrice.toFixed(2)}` \n              : `$${q!.currentPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,\n            change: `${q!.changePercent >= 0 ? '+' : ''}${q!.changePercent.toFixed(2)}%`,\n            trend: q!.changePercent >= 0 ? 'up' : 'down',\n            description: q!.description,\n          }));\n          \n          return res.json({ source: 'live', data: marketData });\n        }\n      }\n      \n      // Fallback to simulated data for requested symbols\n      const baseDataMap: Record<string, { name: string, baseValue: number, description: string }> = {\n        'SPY': { name: 'S&P 500', baseValue: 4567.89, description: 'US Large Cap' },\n        'QQQ': { name: 'NASDAQ', baseValue: 15234.56, description: 'Tech Heavy' },\n        'DIA': { name: 'Dow Jones', baseValue: 35678.90, description: 'Blue Chips' },\n        'AAPL': { name: 'Apple', baseValue: 178.50, description: 'Tech Giant' },\n        'MSFT': { name: 'Microsoft', baseValue: 378.20, description: 'Enterprise Tech' },\n        'TSLA': { name: 'Tesla', baseValue: 245.60, description: 'EV Leader' },\n        'GOOGL': { name: 'Alphabet', baseValue: 138.25, description: 'Search & Cloud' },\n        'AMZN': { name: 'Amazon', baseValue: 185.60, description: 'E-commerce' },\n        'NVDA': { name: 'NVIDIA', baseValue: 480.75, description: 'AI & GPUs' },\n        'META': { name: 'Meta', baseValue: 505.40, description: 'Social Media' },\n        'JPM': { name: 'JPMorgan', baseValue: 195.30, description: 'Banking' },\n        'V': { name: 'Visa', baseValue: 267.80, description: 'Payments' },\n        'GS': { name: 'Goldman Sachs', baseValue: 385.20, description: 'Investment Bank' },\n        'MS': { name: 'Morgan Stanley', baseValue: 95.40, description: 'Investment Bank' },\n        'BRK.B': { name: 'Berkshire', baseValue: 365.50, description: 'Conglomerate' },\n        'WMT': { name: 'Walmart', baseValue: 165.20, description: 'Retail' },\n        'JNJ': { name: 'Johnson & Johnson', baseValue: 158.40, description: 'Healthcare' },\n        'PG': { name: 'Procter & Gamble', baseValue: 156.80, description: 'Consumer Goods' },\n        'UNH': { name: 'UnitedHealth', baseValue: 525.30, description: 'Healthcare' },\n        'XOM': { name: 'Exxon Mobil', baseValue: 105.60, description: 'Energy' },\n      };\n      \n      const simulatedData = requestedSymbols.map(symbol => {\n        const baseData = baseDataMap[symbol] || { name: symbol, baseValue: 100 + Math.random() * 400, description: 'Stock' };\n        const changePercent = (Math.random() - 0.5) * 4;\n        const newValue = baseData.baseValue * (1 + changePercent / 100);\n        \n        return {\n          name: baseData.name,\n          symbol: symbol,\n          value: newValue < 100 \n            ? `$${newValue.toFixed(2)}` \n            : `$${newValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,\n          change: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`,\n          trend: changePercent >= 0 ? 'up' : 'down',\n          description: baseData.description,\n        };\n      });\n      \n      res.json({ source: 'simulated', data: simulatedData });\n    } catch (error) {\n      console.error('Market data error:', error);\n      res.status(500).json({ error: \"Failed to fetch market data\" });\n    }\n  });\n\n  // ===== MARKET NEWS ROUTE =====\n  \n  app.get(\"/api/market-news\", requireAuth, async (req, res) => {\n    try {\n      const finnhubKey = process.env.FINNHUB_API_KEY;\n      const category = (req.query.category as string) || 'general';\n      \n      if (finnhubKey) {\n        // Fetch real news from Finnhub\n        const response = await fetch(\n          `https://finnhub.io/api/v1/news?category=${category}&token=${finnhubKey}`\n        );\n        const news = await response.json();\n        \n        if (Array.isArray(news) && news.length > 0) {\n          const formattedNews = news.slice(0, 10).map((item: any) => ({\n            id: item.id?.toString() || crypto.randomUUID(),\n            headline: item.headline,\n            summary: item.summary,\n            source: item.source,\n            url: item.url,\n            image: item.image,\n            datetime: new Date(item.datetime * 1000).toISOString(),\n            category: item.category,\n            related: item.related,\n          }));\n          \n          return res.json({ source: 'live', data: formattedNews });\n        }\n      }\n      \n      // Fallback to sample news data\n      const sampleNews = [\n        {\n          id: '1',\n          headline: 'Fed Signals Potential Rate Cuts in 2024',\n          summary: 'Federal Reserve officials indicated they may begin cutting interest rates next year as inflation continues to cool.',\n          source: 'Reuters',\n          url: '#',\n          datetime: new Date().toISOString(),\n          category: 'general',\n        },\n        {\n          id: '2',\n          headline: 'Tech Giants Report Strong Q4 Earnings',\n          summary: 'Major technology companies exceeded Wall Street expectations with robust quarterly results.',\n          source: 'Bloomberg',\n          url: '#',\n          datetime: new Date(Date.now() - 3600000).toISOString(),\n          category: 'technology',\n        },\n        {\n          id: '3',\n          headline: 'M&A Activity Surges in Financial Sector',\n          summary: 'Investment banks report increased merger and acquisition activity as market conditions improve.',\n          source: 'WSJ',\n          url: '#',\n          datetime: new Date(Date.now() - 7200000).toISOString(),\n          category: 'merger',\n        },\n        {\n          id: '4',\n          headline: 'Global Markets Rally on Economic Data',\n          summary: 'Stock markets worldwide advance as economic indicators point to continued growth.',\n          source: 'CNBC',\n          url: '#',\n          datetime: new Date(Date.now() - 10800000).toISOString(),\n          category: 'general',\n        },\n        {\n          id: '5',\n          headline: 'IPO Market Shows Signs of Recovery',\n          summary: 'Initial public offerings are gaining momentum as investor confidence returns.',\n          source: 'Financial Times',\n          url: '#',\n          datetime: new Date(Date.now() - 14400000).toISOString(),\n          category: 'ipo',\n        },\n      ];\n      \n      res.json({ source: 'sample', data: sampleNews });\n    } catch (error) {\n      console.error('Market news error:', error);\n      res.status(500).json({ error: \"Failed to fetch market news\" });\n    }\n  });\n\n  // ===== TIME TRACKING ROUTES =====\n  \n  // Get all time entries (admin sees all, others see their own)\n  app.get(\"/api/time-entries\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      let entries;\n      if (user.accessLevel === 'admin') {\n        entries = await storage.getAllTimeEntries();\n      } else {\n        entries = await storage.getTimeEntriesByUser(user.id);\n      }\n      res.json(entries);\n    } catch (error) {\n      console.error('Get time entries error:', error);\n      res.status(500).json({ error: \"Failed to fetch time entries\" });\n    }\n  });\n  \n  // Get time entries for a specific deal\n  app.get(\"/api/time-entries/deal/:dealId\", requireAuth, async (req, res) => {\n    try {\n      const entries = await storage.getTimeEntriesByDeal(req.params.dealId);\n      res.json(entries);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch time entries for deal\" });\n    }\n  });\n  \n  // Create time entry\n  app.post(\"/api/time-entries\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertTimeEntrySchema.safeParse({ ...req.body, userId: user.id });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const entry = await storage.createTimeEntry(result.data);\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'CREATE',\n        entityType: 'TimeEntry',\n        entityId: entry.id,\n        details: `Logged ${result.data.hours} minutes for ${result.data.category}`,\n      });\n      \n      res.status(201).json(entry);\n    } catch (error) {\n      console.error('Create time entry error:', error);\n      res.status(500).json({ error: \"Failed to create time entry\" });\n    }\n  });\n  \n  // Update time entry\n  app.patch(\"/api/time-entries/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const entry = await storage.getTimeEntry(req.params.id);\n      if (!entry) {\n        return res.status(404).json({ error: \"Time entry not found\" });\n      }\n      if (entry.userId !== user.id && user.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Not authorized to update this entry\" });\n      }\n      \n      const updated = await storage.updateTimeEntry(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update time entry\" });\n    }\n  });\n  \n  // Delete time entry\n  app.delete(\"/api/time-entries/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const entry = await storage.getTimeEntry(req.params.id);\n      if (!entry) {\n        return res.status(404).json({ error: \"Time entry not found\" });\n      }\n      if (entry.userId !== user.id && user.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Not authorized to delete this entry\" });\n      }\n      \n      await storage.deleteTimeEntry(req.params.id);\n      res.json({ message: \"Time entry deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete time entry\" });\n    }\n  });\n  \n  // ===== TIME OFF REQUEST ROUTES =====\n  \n  // Get all time off requests\n  app.get(\"/api/time-off-requests\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      let requests;\n      if (user.accessLevel === 'admin') {\n        requests = await storage.getAllTimeOffRequests();\n      } else {\n        requests = await storage.getTimeOffRequestsByUser(user.id);\n      }\n      \n      // Enrich with user info\n      const users = await storage.getAllUsers();\n      const enrichedRequests = requests.map((r: any) => {\n        const requestUser = users.find(u => u.id === r.userId);\n        const approver = r.approvedBy ? users.find(u => u.id === r.approvedBy) : null;\n        return {\n          ...r,\n          userName: requestUser?.name || 'Unknown',\n          userEmail: requestUser?.email,\n          approverName: approver?.name,\n        };\n      });\n      \n      res.json(enrichedRequests);\n    } catch (error) {\n      console.error('Get time off requests error:', error);\n      res.status(500).json({ error: \"Failed to fetch time off requests\" });\n    }\n  });\n  \n  // Create time off request\n  app.post(\"/api/time-off-requests\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertTimeOffRequestSchema.safeParse({ ...req.body, userId: user.id });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const request = await storage.createTimeOffRequest(result.data);\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'CREATE',\n        entityType: 'TimeOffRequest',\n        entityId: request.id,\n        details: `Requested ${result.data.type} from ${result.data.startDate} to ${result.data.endDate}`,\n      });\n      \n      res.status(201).json(request);\n    } catch (error) {\n      console.error('Create time off request error:', error);\n      res.status(500).json({ error: \"Failed to create time off request\" });\n    }\n  });\n  \n  // Update time off request (approve/reject - CEO only, or update own pending request)\n  app.patch(\"/api/time-off-requests/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const request = await storage.getTimeOffRequest(req.params.id);\n      if (!request) {\n        return res.status(404).json({ error: \"Time off request not found\" });\n      }\n      \n      // Admin can approve/reject\n      if (req.body.status && user.accessLevel === 'admin') {\n        const updates = {\n          status: req.body.status,\n          approvedBy: user.id,\n        };\n        const updated = await storage.updateTimeOffRequest(req.params.id, updates);\n        \n        // Create audit log\n        await storage.createAuditLog({\n          userId: user.id,\n          action: 'UPDATE',\n          entityType: 'TimeOffRequest',\n          entityId: request.id,\n          details: `${req.body.status} time off request`,\n        });\n        \n        // Send notification to the employee\n        const isApproved = req.body.status === 'Approved';\n        await storage.createNotification({\n          userId: request.userId,\n          type: isApproved ? 'success' : 'alert',\n          title: `Time Off ${req.body.status}`,\n          message: `Your ${request.type} request from ${request.startDate} to ${request.endDate} has been ${req.body.status.toLowerCase()}.`,\n          link: '/employee/calendar',\n        });\n        \n        return res.json(updated);\n      }\n      \n      // Users can update their own pending requests\n      if (request.userId === user.id && request.status === 'Pending') {\n        const updated = await storage.updateTimeOffRequest(req.params.id, req.body);\n        return res.json(updated);\n      }\n      \n      res.status(403).json({ error: \"Not authorized to update this request\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update time off request\" });\n    }\n  });\n  \n  // Delete time off request\n  app.delete(\"/api/time-off-requests/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const request = await storage.getTimeOffRequest(req.params.id);\n      if (!request) {\n        return res.status(404).json({ error: \"Time off request not found\" });\n      }\n      if (request.userId !== user.id && user.accessLevel !== 'admin') {\n        return res.status(403).json({ error: \"Not authorized to delete this request\" });\n      }\n      \n      await storage.deleteTimeOffRequest(req.params.id);\n      res.json({ message: \"Time off request deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete time off request\" });\n    }\n  });\n  \n  // ===== AUDIT LOG ROUTES =====\n  \n  // Get audit logs (all authenticated users - CEOs see all, employees see their own)\n  app.get(\"/api/audit-logs\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const limit = parseInt(req.query.limit as string) || 500;\n      const logs = await storage.getAuditLogs(limit);\n      \n      // Enrich with user names and add timestamp alias\n      const users = await storage.getAllUsers();\n      const enrichedLogs = logs.map((log: any) => {\n        const logUser = users.find(u => u.id === log.userId);\n        return {\n          ...log,\n          userName: logUser?.name || 'System',\n          timestamp: log.createdAt, // Alias for frontend compatibility\n        };\n      });\n      \n      // Admins see all logs, others see only their own activities\n      const filteredLogs = user.accessLevel === 'admin' \n        ? enrichedLogs \n        : enrichedLogs.filter((log: any) => log.userId === user.id);\n      \n      res.json(filteredLogs);\n    } catch (error) {\n      console.error('Get audit logs error:', error);\n      res.status(500).json({ error: \"Failed to fetch audit logs\" });\n    }\n  });\n  \n  // Get audit logs for specific entity\n  app.get(\"/api/audit-logs/:entityType/:entityId\", requireAuth, async (req, res) => {\n    try {\n      const logs = await storage.getAuditLogsByEntity(req.params.entityType, req.params.entityId);\n      \n      // Enrich with user names and add timestamp alias\n      const users = await storage.getAllUsers();\n      const enrichedLogs = logs.map((log: any) => {\n        const logUser = users.find(u => u.id === log.userId);\n        return {\n          ...log,\n          userName: logUser?.name || 'System',\n          timestamp: log.createdAt, // Alias for frontend compatibility\n        };\n      });\n      \n      res.json(enrichedLogs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch audit logs for entity\" });\n    }\n  });\n  \n  // ===== INVESTOR CRM ROUTES =====\n  \n  // Get all investors\n  app.get(\"/api/investors\", requireAuth, async (req, res) => {\n    try {\n      const investors = await storage.getAllInvestors();\n      res.json(investors);\n    } catch (error) {\n      console.error('Get investors error:', error);\n      res.status(500).json({ error: \"Failed to fetch investors\" });\n    }\n  });\n  \n  // Get single investor with interactions\n  app.get(\"/api/investors/:id\", requireAuth, async (req, res) => {\n    try {\n      const investor = await storage.getInvestor(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      \n      const interactions = await storage.getInvestorInteractions(investor.id);\n      \n      // Enrich interactions with user names\n      const users = await storage.getAllUsers();\n      const enrichedInteractions = interactions.map((i: any) => {\n        const interactionUser = users.find(u => u.id === i.userId);\n        return {\n          ...i,\n          userName: interactionUser?.name || 'Unknown',\n        };\n      });\n      \n      res.json({ ...investor, interactions: enrichedInteractions });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch investor\" });\n    }\n  });\n  \n  // Create investor (CEO only)\n  app.post(\"/api/investors\", generalLimiter, requireCEO, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertInvestorSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const investor = await storage.createInvestor(result.data);\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'CREATE',\n        entityType: 'Investor',\n        entityId: investor.id,\n        details: `Created investor: ${result.data.name} from ${result.data.firm}`,\n      });\n      \n      res.status(201).json(investor);\n    } catch (error) {\n      console.error('Create investor error:', error);\n      res.status(500).json({ error: \"Failed to create investor\" });\n    }\n  });\n  \n  // Update investor\n  app.patch(\"/api/investors/:id\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const investor = await storage.getInvestor(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      \n      const updated = await storage.updateInvestor(req.params.id, req.body);\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'UPDATE',\n        entityType: 'Investor',\n        entityId: investor.id,\n        details: `Updated investor: ${investor.name}`,\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update investor\" });\n    }\n  });\n  \n  // Delete investor (CEO only)\n  app.delete(\"/api/investors/:id\", requireCEO, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const investor = await storage.getInvestor(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      \n      await storage.deleteInvestor(req.params.id);\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'DELETE',\n        entityType: 'Investor',\n        entityId: req.params.id,\n        details: `Deleted investor: ${investor.name}`,\n      });\n      \n      res.json({ message: \"Investor deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete investor\" });\n    }\n  });\n  \n  // Create investor interaction\n  app.post(\"/api/investors/:investorId/interactions\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const investor = await storage.getInvestor(req.params.investorId);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      \n      const result = insertInvestorInteractionSchema.safeParse({\n        ...req.body,\n        investorId: req.params.investorId,\n        userId: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      \n      const interaction = await storage.createInvestorInteraction(result.data);\n      \n      // Update last contact date on investor\n      await storage.updateInvestor(investor.id, { lastContactDate: result.data.date });\n      \n      // Create audit log\n      await storage.createAuditLog({\n        userId: user.id,\n        action: 'CREATE',\n        entityType: 'InvestorInteraction',\n        entityId: interaction.id,\n        details: `Logged ${result.data.type} interaction with ${investor.name}`,\n      });\n      \n      res.status(201).json(interaction);\n    } catch (error) {\n      console.error('Create interaction error:', error);\n      res.status(500).json({ error: \"Failed to create interaction\" });\n    }\n  });\n  \n  // Delete investor interaction\n  app.delete(\"/api/investor-interactions/:id\", requireAuth, async (req, res) => {\n    try {\n      await storage.deleteInvestorInteraction(req.params.id);\n      res.json({ message: \"Interaction deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete interaction\" });\n    }\n  });\n\n  // ===== OKR ROUTES =====\n  \n  // Get all OKRs\n  app.get(\"/api/okrs\", requireAuth, async (req, res) => {\n    try {\n      const okrs = await storage.getAllOkrs();\n      res.json(okrs);\n    } catch (error) {\n      console.error('Get OKRs error:', error);\n      res.status(500).json({ error: \"Failed to fetch OKRs\" });\n    }\n  });\n  \n  // Get single OKR\n  app.get(\"/api/okrs/:id\", requireAuth, async (req, res) => {\n    try {\n      const okr = await storage.getOkr(req.params.id);\n      if (!okr) {\n        return res.status(404).json({ error: \"OKR not found\" });\n      }\n      res.json(okr);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch OKR\" });\n    }\n  });\n  \n  // Create OKR\n  app.post(\"/api/okrs\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertOkrSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const okr = await storage.createOkr(result.data);\n      res.status(201).json(okr);\n    } catch (error) {\n      console.error('Create OKR error:', error);\n      res.status(500).json({ error: \"Failed to create OKR\" });\n    }\n  });\n  \n  // Update OKR\n  app.patch(\"/api/okrs/:id\", requireAuth, async (req, res) => {\n    try {\n      const okr = await storage.getOkr(req.params.id);\n      if (!okr) {\n        return res.status(404).json({ error: \"OKR not found\" });\n      }\n      const updated = await storage.updateOkr(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update OKR\" });\n    }\n  });\n  \n  // Delete OKR\n  app.delete(\"/api/okrs/:id\", requireAuth, async (req, res) => {\n    try {\n      const okr = await storage.getOkr(req.params.id);\n      if (!okr) {\n        return res.status(404).json({ error: \"OKR not found\" });\n      }\n      await storage.deleteOkr(req.params.id);\n      res.json({ message: \"OKR deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete OKR\" });\n    }\n  });\n\n  // ===== STAKEHOLDER ROUTES =====\n  \n  // Get all stakeholders\n  app.get(\"/api/stakeholders\", requireAuth, async (req, res) => {\n    try {\n      // Support pagination via query params with safe defaults\n      const rawPage = parseInt(req.query.page as string);\n      const rawPageSize = parseInt(req.query.pageSize as string);\n      const page = Math.max(1, isNaN(rawPage) ? 1 : rawPage);\n      const pageSize = Math.max(1, Math.min(isNaN(rawPageSize) ? 50 : rawPageSize, 100));\n      const search = req.query.search as string | undefined;\n      const type = req.query.type as string | undefined;\n      \n      // If no pagination params, use paginated with defaults for better performance\n      const result = await storage.getStakeholdersPaginated({\n        page,\n        pageSize,\n        search,\n        type\n      });\n      \n      res.json({\n        stakeholders: result.stakeholders,\n        total: result.total,\n        page,\n        pageSize,\n        totalPages: Math.ceil(result.total / pageSize)\n      });\n    } catch (error) {\n      console.error('Get stakeholders error:', error);\n      res.status(500).json({ error: \"Failed to fetch stakeholders\" });\n    }\n  });\n  \n  // Get stakeholder stats (total counts by type)\n  app.get(\"/api/stakeholders/stats\", requireAuth, async (req, res) => {\n    try {\n      const stats = await storage.getStakeholderStats();\n      res.json(stats);\n    } catch (error) {\n      console.error('Get stakeholder stats error:', error);\n      res.status(500).json({ error: \"Failed to fetch stakeholder stats\" });\n    }\n  });\n  \n  // Get single stakeholder\n  app.get(\"/api/stakeholders/:id\", requireAuth, async (req, res) => {\n    try {\n      const stakeholder = await storage.getStakeholder(req.params.id);\n      if (!stakeholder) {\n        return res.status(404).json({ error: \"Stakeholder not found\" });\n      }\n      res.json(stakeholder);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch stakeholder\" });\n    }\n  });\n  \n  // Create stakeholder\n  app.post(\"/api/stakeholders\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const result = insertStakeholderSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const stakeholder = await storage.createStakeholder(result.data);\n      res.status(201).json(stakeholder);\n    } catch (error) {\n      console.error('Create stakeholder error:', error);\n      res.status(500).json({ error: \"Failed to create stakeholder\" });\n    }\n  });\n  \n  // Parse Excel/CSV file for import (server-side to avoid UI freeze)\n  app.post(\"/api/stakeholders/parse-file\", generalLimiter, requireAuth, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n      \n      const filePath = req.file.path;\n      const ext = path.extname(req.file.originalname).toLowerCase();\n      \n      console.log(`Parsing file: ${req.file.originalname}, size: ${req.file.size} bytes`);\n      \n      let headers: string[] = [];\n      let rows: Record<string, string>[] = [];\n      \n      // Sanitize string values\n      const sanitizeValue = (val: any): string => {\n        if (val === null || val === undefined) return '';\n        const str = String(val);\n        return str.replace(/\\x00/g, '').replace(/[\\x01-\\x08\\x0B\\x0C\\x0E-\\x1F]/g, '').trim();\n      };\n      \n      if (ext === '.xlsx' || ext === '.xls') {\n        // Parse Excel file - read as buffer first\n        const fileBuffer = fs.readFileSync(filePath);\n        const workbook = XLSX.read(fileBuffer, { type: 'buffer' });\n        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];\n        const jsonData = XLSX.utils.sheet_to_json<Record<string, any>>(firstSheet, { defval: '' });\n        \n        if (jsonData.length === 0) {\n          fs.unlinkSync(filePath);\n          return res.status(400).json({ error: \"File is empty or has no data rows\" });\n        }\n        \n        headers = Object.keys(jsonData[0]).map(h => sanitizeValue(h));\n        rows = jsonData.map(row => {\n          const sanitizedRow: Record<string, string> = {};\n          headers.forEach((header, i) => {\n            const originalKey = Object.keys(jsonData[0])[i];\n            sanitizedRow[header] = sanitizeValue(row[originalKey]);\n          });\n          return sanitizedRow;\n        }).filter(row => Object.values(row).some(v => v));\n      } else if (ext === '.csv' || ext === '.tsv' || ext === '.txt') {\n        // Parse CSV/TSV file\n        const content = fs.readFileSync(filePath, 'utf-8');\n        const lines = content.split('\\n').filter(line => line.trim());\n        \n        if (lines.length === 0) {\n          fs.unlinkSync(filePath);\n          return res.status(400).json({ error: \"File is empty\" });\n        }\n        \n        const delimiter = content.includes('\\t') ? '\\t' : ',';\n        headers = lines[0].split(delimiter).map(h => sanitizeValue(h.replace(/^\"|\"$/g, '')));\n        \n        rows = lines.slice(1).map(line => {\n          const values = line.split(delimiter).map(v => sanitizeValue(v.replace(/^\"|\"$/g, '')));\n          const row: Record<string, string> = {};\n          headers.forEach((header, i) => {\n            row[header] = values[i] || '';\n          });\n          return row;\n        }).filter(row => Object.values(row).some(v => v));\n      } else {\n        fs.unlinkSync(filePath);\n        return res.status(400).json({ error: \"Unsupported file format\" });\n      }\n      \n      // Clean up uploaded file\n      fs.unlinkSync(filePath);\n      \n      console.log(`Parsed ${rows.length} rows with ${headers.length} columns`);\n      console.log('Headers:', headers);\n      if (rows.length > 0) {\n        console.log('Sample row keys:', Object.keys(rows[0]));\n        console.log('Sample row:', rows[0]);\n      }\n      \n      res.json({\n        headers,\n        rows,\n        totalRows: rows.length\n      });\n    } catch (error) {\n      console.error('Parse file error:', error);\n      // Clean up file if it exists\n      if (req.file?.path && fs.existsSync(req.file.path)) {\n        fs.unlinkSync(req.file.path);\n      }\n      res.status(500).json({ error: \"Failed to parse file\" });\n    }\n  });\n  \n  // Bulk import stakeholders\n  app.post(\"/api/stakeholders/bulk-import\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const { stakeholders } = req.body;\n      \n      if (!Array.isArray(stakeholders) || stakeholders.length === 0) {\n        return res.status(400).json({ error: \"stakeholders array is required\" });\n      }\n      \n      console.log(`Bulk importing ${stakeholders.length} stakeholders...`);\n      \n      const validTypes = ['investor', 'advisor', 'legal', 'banker', 'consultant', 'client', 'other'];\n      let successCount = 0;\n      let errorCount = 0;\n      const created = [];\n      \n      for (const s of stakeholders) {\n        if (!s.name || !s.company) {\n          errorCount++;\n          continue;\n        }\n        \n        try {\n          const stakeholderType = validTypes.includes(s.type?.toLowerCase()) ? s.type.toLowerCase() : 'other';\n          \n          const result = await storage.createStakeholder({\n            name: s.name,\n            title: s.title || '',\n            company: s.company,\n            type: stakeholderType,\n            email: s.email || null,\n            phone: s.phone || null,\n            linkedin: s.linkedin || null,\n            website: s.website || null,\n            location: s.location || null,\n            focus: s.focus || null,\n            notes: s.notes || null,\n            deals: [],\n            isFavorite: false\n          });\n          created.push(result);\n          successCount++;\n        } catch (err) {\n          console.error('Failed to create stakeholder:', s.name, err);\n          errorCount++;\n        }\n      }\n      \n      console.log(`Bulk import complete: ${successCount} created, ${errorCount} failed`);\n      \n      res.status(201).json({\n        successCount,\n        errorCount,\n        totalProcessed: stakeholders.length,\n        created\n      });\n    } catch (error) {\n      console.error('Bulk import error:', error);\n      res.status(500).json({ error: \"Failed to bulk import stakeholders\" });\n    }\n  });\n  \n  // Update stakeholder\n  app.patch(\"/api/stakeholders/:id\", requireAuth, async (req, res) => {\n    try {\n      const stakeholder = await storage.getStakeholder(req.params.id);\n      if (!stakeholder) {\n        return res.status(404).json({ error: \"Stakeholder not found\" });\n      }\n      const updated = await storage.updateStakeholder(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update stakeholder\" });\n    }\n  });\n  \n  // Delete stakeholder\n  app.delete(\"/api/stakeholders/:id\", requireAuth, async (req, res) => {\n    try {\n      const stakeholder = await storage.getStakeholder(req.params.id);\n      if (!stakeholder) {\n        return res.status(404).json({ error: \"Stakeholder not found\" });\n      }\n      await storage.deleteStakeholder(req.params.id);\n      res.json({ message: \"Stakeholder deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete stakeholder\" });\n    }\n  });\n  \n  // Scan document to extract ALL stakeholder information using AI and auto-create them\n  app.post(\"/api/stakeholders/scan-document\", aiLimiter, requireAuth, async (req, res) => {\n    try {\n      const { documentContent, filename, autoCreate } = req.body;\n      \n      if (!documentContent) {\n        return res.status(400).json({ error: \"Document content is required\" });\n      }\n      \n      console.log(`Scanning document: ${filename}, content length: ${documentContent.length} chars`);\n      \n      // Split CSV content into chunks to handle large files\n      const lines = documentContent.split('\\n');\n      const headerLine = lines[0];\n      const dataLines = lines.slice(1).filter((line: string) => line.trim());\n      const CHUNK_SIZE = 75; // Process 75 rows at a time for reliability\n      \n      console.log(`Document has ${dataLines.length} data rows, processing in chunks of ${CHUNK_SIZE}`);\n      \n      const allStakeholders: any[] = [];\n      const chunks = [];\n      \n      // Create chunks with header included\n      for (let i = 0; i < dataLines.length; i += CHUNK_SIZE) {\n        const chunkLines = dataLines.slice(i, i + CHUNK_SIZE);\n        chunks.push(headerLine + '\\n' + chunkLines.join('\\n'));\n      }\n      \n      console.log(`Processing ${chunks.length} chunks...`);\n      \n      // Process each chunk\n      for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {\n        const chunk = chunks[chunkIndex];\n        console.log(`Processing chunk ${chunkIndex + 1}/${chunks.length}...`);\n        \n        try {\n          const response = await openai.chat.completions.create({\n            model: \"gpt-4o\",\n            messages: [\n              {\n                role: \"system\",\n                content: `You are an expert at extracting stakeholder/contact information from CSV/spreadsheet data.\n\nINSTRUCTIONS:\n1. Process EVERY ROW in this CSV chunk\n2. Each row is a separate stakeholder entry\n3. Map column values to stakeholder fields\n\nColumn mapping:\n- Name/Contact Name/Full Name/Person -> name\n- Company/Firm/Organization/Fund -> company\n- Title/Position/Role -> title\n- Email/E-mail -> email\n- Phone/Tel/Mobile -> phone\n- Focus/Sector/Industry -> focus (extract as comma-separated list)\n- Location/City/Region -> location\n- Type/Category -> type (investor/advisor/legal/banker/consultant/client/other)\n- Website/URL -> website\n- LinkedIn -> linkedin\n- Notes/Comments -> notes\n\nReturn JSON: {\"stakeholders\": [{name, title, company, type, email, phone, linkedin, website, location, focus, notes}, ...]}\nOnly include entries with both name AND company. Extract ALL rows.`\n              },\n              {\n                role: \"user\",\n                content: `Extract ALL contacts from this CSV chunk (chunk ${chunkIndex + 1} of ${chunks.length}):\\n\\n${chunk}`\n              }\n            ],\n            response_format: { type: \"json_object\" },\n            max_completion_tokens: 8192\n          });\n          \n          const content = response.choices[0]?.message?.content;\n          if (content) {\n            try {\n              const extracted = JSON.parse(content);\n              if (extracted.stakeholders && Array.isArray(extracted.stakeholders)) {\n                allStakeholders.push(...extracted.stakeholders);\n                console.log(`Chunk ${chunkIndex + 1}: extracted ${extracted.stakeholders.length} stakeholders`);\n              }\n            } catch (parseErr) {\n              console.error(`Failed to parse chunk ${chunkIndex + 1}:`, parseErr);\n            }\n          }\n        } catch (chunkError: any) {\n          console.error(`Error processing chunk ${chunkIndex + 1}:`, chunkError?.message);\n        }\n      }\n      \n      console.log(`Total extracted: ${allStakeholders.length} stakeholders from ${chunks.length} chunks`);\n      \n      const stakeholders = allStakeholders;\n      \n      // If autoCreate is true, create all stakeholders in the database\n      if (autoCreate && stakeholders.length > 0) {\n        const validTypes = ['investor', 'advisor', 'legal', 'banker', 'consultant', 'client', 'other'];\n        let successCount = 0;\n        let failedCount = 0;\n        let skippedCount = 0;\n        const createdStakeholders = [];\n        const skippedReasons: string[] = [];\n        \n        for (const s of stakeholders) {\n          // Skip entries without required fields\n          if (!s.name || typeof s.name !== 'string' || s.name.trim() === '') {\n            skippedCount++;\n            skippedReasons.push(`Missing name: ${JSON.stringify(s).slice(0, 50)}...`);\n            continue;\n          }\n          if (!s.company || typeof s.company !== 'string' || s.company.trim() === '') {\n            skippedCount++;\n            skippedReasons.push(`Missing company for \"${s.name}\"`);\n            continue;\n          }\n          \n          try {\n            const stakeholderType = validTypes.includes(s.type?.toLowerCase()) ? s.type.toLowerCase() : 'other';\n            \n            // Sanitize all optional fields - convert empty strings to null\n            const sanitizeOptional = (val: any): string | null => {\n              if (!val || typeof val !== 'string' || val.trim() === '') return null;\n              return val.trim();\n            };\n            \n            const created = await storage.createStakeholder({\n              name: s.name.trim(),\n              title: sanitizeOptional(s.title) || '',\n              company: s.company.trim(),\n              type: stakeholderType,\n              email: sanitizeOptional(s.email),\n              phone: sanitizeOptional(s.phone),\n              linkedin: sanitizeOptional(s.linkedin),\n              website: sanitizeOptional(s.website),\n              location: sanitizeOptional(s.location),\n              focus: sanitizeOptional(s.focus),\n              notes: sanitizeOptional(s.notes),\n              deals: [],\n              isFavorite: false\n            });\n            createdStakeholders.push(created);\n            successCount++;\n          } catch (err) {\n            console.error('Failed to create stakeholder:', s.name, err);\n            failedCount++;\n          }\n        }\n        \n        // Log extraction stats for debugging\n        console.log(`Document scan results: ${stakeholders.length} found, ${successCount} created, ${skippedCount} skipped, ${failedCount} failed`);\n        if (skippedReasons.length > 0) {\n          console.log('Skipped reasons (first 5):', skippedReasons.slice(0, 5));\n        }\n        \n        res.json({ \n          stakeholders: createdStakeholders,\n          successCount,\n          failedCount,\n          skippedCount,\n          totalFound: stakeholders.length,\n          message: `Found ${stakeholders.length} entries, created ${successCount}, skipped ${skippedCount} (missing required fields), ${failedCount} failed`\n        });\n      } else {\n        res.json({ stakeholders, totalFound: stakeholders.length });\n      }\n    } catch (error: any) {\n      console.error('Document scan error:', error);\n      // Provide more specific error messages based on the error type\n      if (error?.code === 'context_length_exceeded' || error?.message?.includes('context') || error?.message?.includes('token')) {\n        return res.status(400).json({ \n          error: \"Document is too large to process. Please try splitting it into smaller files (max ~500 rows at a time) or removing unnecessary content.\" \n        });\n      }\n      if (error?.code === 'rate_limit_exceeded') {\n        return res.status(429).json({ \n          error: \"AI processing rate limit reached. Please wait a moment and try again.\" \n        });\n      }\n      if (error?.message?.includes('timeout') || error?.code === 'ETIMEDOUT') {\n        return res.status(408).json({ \n          error: \"Processing took too long. Please try with a smaller document.\" \n        });\n      }\n      res.status(500).json({ error: \"Failed to scan document. Please try again or contact support if the issue persists.\" });\n    }\n  });\n\n  // ===== INVESTORS TABLE ROUTES =====\n  \n  // Get all investors from investors table\n  app.get(\"/api/investors-table\", requireAuth, async (req, res) => {\n    try {\n      const investors = await storage.getAllInvestorsFromTable();\n      res.json(investors);\n    } catch (error) {\n      console.error('Get investors table error:', error);\n      res.status(500).json({ error: \"Failed to fetch investors\" });\n    }\n  });\n  \n  // Get single investor from investors table\n  app.get(\"/api/investors-table/:id\", requireAuth, async (req, res) => {\n    try {\n      const investor = await storage.getInvestorFromTable(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      res.json(investor);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch investor\" });\n    }\n  });\n  \n  // Create investor in investors table\n  app.post(\"/api/investors-table\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const investor = await storage.createInvestorInTable({\n        ...req.body,\n        createdBy: user.id,\n      });\n      res.status(201).json(investor);\n    } catch (error) {\n      console.error('Create investor error:', error);\n      res.status(500).json({ error: \"Failed to create investor\" });\n    }\n  });\n  \n  // Update investor in investors table\n  app.patch(\"/api/investors-table/:id\", requireAuth, async (req, res) => {\n    try {\n      const investor = await storage.getInvestorFromTable(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      const updated = await storage.updateInvestorInTable(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update investor\" });\n    }\n  });\n  \n  // Delete investor from investors table\n  app.delete(\"/api/investors-table/:id\", requireAuth, async (req, res) => {\n    try {\n      const investor = await storage.getInvestorFromTable(req.params.id);\n      if (!investor) {\n        return res.status(404).json({ error: \"Investor not found\" });\n      }\n      await storage.deleteInvestorFromTable(req.params.id);\n      res.json({ message: \"Investor deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete investor\" });\n    }\n  });\n\n  // ===== ANNOUNCEMENT ROUTES =====\n  \n  // Get all announcements\n  app.get(\"/api/announcements\", requireAuth, async (req, res) => {\n    try {\n      const announcements = await storage.getAllAnnouncements();\n      res.json(announcements);\n    } catch (error) {\n      console.error('Get announcements error:', error);\n      res.status(500).json({ error: \"Failed to fetch announcements\" });\n    }\n  });\n  \n  // Get single announcement\n  app.get(\"/api/announcements/:id\", requireAuth, async (req, res) => {\n    try {\n      const announcement = await storage.getAnnouncement(req.params.id);\n      if (!announcement) {\n        return res.status(404).json({ error: \"Announcement not found\" });\n      }\n      res.json(announcement);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch announcement\" });\n    }\n  });\n  \n  // Create announcement\n  app.post(\"/api/announcements\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertAnnouncementSchema.safeParse({\n        ...req.body,\n        authorId: user.id,\n        authorName: user.name,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const announcement = await storage.createAnnouncement(result.data);\n      res.status(201).json(announcement);\n    } catch (error) {\n      console.error('Create announcement error:', error);\n      res.status(500).json({ error: \"Failed to create announcement\" });\n    }\n  });\n  \n  // Update announcement\n  app.patch(\"/api/announcements/:id\", requireAuth, async (req, res) => {\n    try {\n      const announcement = await storage.getAnnouncement(req.params.id);\n      if (!announcement) {\n        return res.status(404).json({ error: \"Announcement not found\" });\n      }\n      const updated = await storage.updateAnnouncement(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update announcement\" });\n    }\n  });\n  \n  // Delete announcement\n  app.delete(\"/api/announcements/:id\", requireAuth, async (req, res) => {\n    try {\n      const announcement = await storage.getAnnouncement(req.params.id);\n      if (!announcement) {\n        return res.status(404).json({ error: \"Announcement not found\" });\n      }\n      await storage.deleteAnnouncement(req.params.id);\n      res.json({ message: \"Announcement deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete announcement\" });\n    }\n  });\n\n  // ===== POLL ROUTES =====\n  \n  // Get all polls\n  app.get(\"/api/polls\", requireAuth, async (req, res) => {\n    try {\n      const polls = await storage.getAllPolls();\n      res.json(polls);\n    } catch (error) {\n      console.error('Get polls error:', error);\n      res.status(500).json({ error: \"Failed to fetch polls\" });\n    }\n  });\n  \n  // Get single poll\n  app.get(\"/api/polls/:id\", requireAuth, async (req, res) => {\n    try {\n      const poll = await storage.getPoll(req.params.id);\n      if (!poll) {\n        return res.status(404).json({ error: \"Poll not found\" });\n      }\n      res.json(poll);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch poll\" });\n    }\n  });\n  \n  // Create poll\n  app.post(\"/api/polls\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertPollSchema.safeParse({\n        ...req.body,\n        creatorId: user.id,\n        creatorName: user.name,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const poll = await storage.createPoll(result.data);\n      res.status(201).json(poll);\n    } catch (error) {\n      console.error('Create poll error:', error);\n      res.status(500).json({ error: \"Failed to create poll\" });\n    }\n  });\n  \n  // Update poll (for voting)\n  app.patch(\"/api/polls/:id\", requireAuth, async (req, res) => {\n    try {\n      const poll = await storage.getPoll(req.params.id);\n      if (!poll) {\n        return res.status(404).json({ error: \"Poll not found\" });\n      }\n      const updated = await storage.updatePoll(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update poll\" });\n    }\n  });\n  \n  // Delete poll\n  app.delete(\"/api/polls/:id\", requireAuth, async (req, res) => {\n    try {\n      const poll = await storage.getPoll(req.params.id);\n      if (!poll) {\n        return res.status(404).json({ error: \"Poll not found\" });\n      }\n      await storage.deletePoll(req.params.id);\n      res.json({ message: \"Poll deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete poll\" });\n    }\n  });\n\n  // ===== MENTORSHIP PAIRING ROUTES =====\n  \n  // Get all mentorship pairings\n  app.get(\"/api/mentorship-pairings\", requireAuth, async (req, res) => {\n    try {\n      const pairings = await storage.getAllMentorshipPairings();\n      res.json(pairings);\n    } catch (error) {\n      console.error('Get mentorship pairings error:', error);\n      res.status(500).json({ error: \"Failed to fetch mentorship pairings\" });\n    }\n  });\n  \n  // Get single mentorship pairing\n  app.get(\"/api/mentorship-pairings/:id\", requireAuth, async (req, res) => {\n    try {\n      const pairing = await storage.getMentorshipPairing(req.params.id);\n      if (!pairing) {\n        return res.status(404).json({ error: \"Mentorship pairing not found\" });\n      }\n      res.json(pairing);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch mentorship pairing\" });\n    }\n  });\n  \n  // Create mentorship pairing (CEO only)\n  app.post(\"/api/mentorship-pairings\", generalLimiter, requireCEO, async (req, res) => {\n    try {\n      const result = insertMentorshipPairingSchema.safeParse(req.body);\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const pairing = await storage.createMentorshipPairing(result.data);\n      \n      const allUsers = await storage.getAllUsers();\n      const mentor = allUsers.find(u => u.id === result.data.mentorId);\n      const mentee = allUsers.find(u => u.id === result.data.menteeId);\n      \n      if (mentor && mentee) {\n        const startDate = new Date();\n        startDate.setDate(startDate.getDate() + 7);\n        startDate.setHours(10, 0, 0, 0);\n        \n        await storage.createMeeting({\n          title: `Mentorship Session: ${mentor.name} & ${mentee.name}`,\n          description: `Initial mentorship meeting between ${mentor.name} (mentor) and ${mentee.name} (mentee). Focus area: ${result.data.focusArea || 'General development'}`,\n          scheduledFor: startDate,\n          duration: 60,\n          location: null,\n          dealId: null,\n          organizerId: (req.user as any)?.id || null,\n          participants: [mentor.email, mentee.email],\n          status: 'scheduled',\n          videoPlatform: null,\n          videoLink: null,\n        });\n        \n        for (const user of [mentor, mentee]) {\n          await storage.createNotification({\n            userId: user.id,\n            title: 'New Mentorship Pairing',\n            message: user.id === mentor.id \n              ? `You have been paired with ${mentee.name} as their mentor. A kickoff meeting has been scheduled.`\n              : `You have been paired with ${mentor.name} as your mentor. A kickoff meeting has been scheduled.`,\n            type: 'info',\n            link: '/ceo/mentorship',\n          });\n        }\n      }\n      \n      res.status(201).json(pairing);\n    } catch (error) {\n      console.error('Create mentorship pairing error:', error);\n      res.status(500).json({ error: \"Failed to create mentorship pairing\" });\n    }\n  });\n  \n  // Update mentorship pairing\n  app.patch(\"/api/mentorship-pairings/:id\", requireAuth, async (req, res) => {\n    try {\n      const pairing = await storage.getMentorshipPairing(req.params.id);\n      if (!pairing) {\n        return res.status(404).json({ error: \"Mentorship pairing not found\" });\n      }\n      const updated = await storage.updateMentorshipPairing(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update mentorship pairing\" });\n    }\n  });\n  \n  // Delete mentorship pairing (CEO only)\n  app.delete(\"/api/mentorship-pairings/:id\", requireCEO, async (req, res) => {\n    try {\n      const pairing = await storage.getMentorshipPairing(req.params.id);\n      if (!pairing) {\n        return res.status(404).json({ error: \"Mentorship pairing not found\" });\n      }\n      await storage.deleteMentorshipPairing(req.params.id);\n      res.json({ message: \"Mentorship pairing deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete mentorship pairing\" });\n    }\n  });\n\n  // ===== CLIENT PORTAL ACCESS ROUTES =====\n  \n  // Get all client portal access entries\n  app.get(\"/api/client-portal-access\", requireAuth, async (req, res) => {\n    try {\n      const access = await storage.getAllClientPortalAccess();\n      res.json(access);\n    } catch (error) {\n      console.error('Get client portal access error:', error);\n      res.status(500).json({ error: \"Failed to fetch client portal access\" });\n    }\n  });\n  \n  // Get client portal access by deal\n  app.get(\"/api/client-portal-access/deal/:dealId\", requireAuth, async (req, res) => {\n    try {\n      const access = await storage.getClientPortalAccessByDeal(req.params.dealId);\n      res.json(access);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch client portal access for deal\" });\n    }\n  });\n  \n  // Get single client portal access\n  app.get(\"/api/client-portal-access/:id\", requireAuth, async (req, res) => {\n    try {\n      const access = await storage.getClientPortalAccess(req.params.id);\n      if (!access) {\n        return res.status(404).json({ error: \"Client portal access not found\" });\n      }\n      res.json(access);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch client portal access\" });\n    }\n  });\n  \n  // Create client portal access\n  app.post(\"/api/client-portal-access\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertClientPortalAccessSchema.safeParse({\n        ...req.body,\n        invitedBy: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const access = await storage.createClientPortalAccess(result.data);\n      res.status(201).json(access);\n    } catch (error) {\n      console.error('Create client portal access error:', error);\n      res.status(500).json({ error: \"Failed to create client portal access\" });\n    }\n  });\n  \n  // Update client portal access\n  app.patch(\"/api/client-portal-access/:id\", requireAuth, async (req, res) => {\n    try {\n      const access = await storage.getClientPortalAccess(req.params.id);\n      if (!access) {\n        return res.status(404).json({ error: \"Client portal access not found\" });\n      }\n      const updated = await storage.updateClientPortalAccess(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update client portal access\" });\n    }\n  });\n  \n  // Delete client portal access\n  app.delete(\"/api/client-portal-access/:id\", requireAuth, async (req, res) => {\n    try {\n      const access = await storage.getClientPortalAccess(req.params.id);\n      if (!access) {\n        return res.status(404).json({ error: \"Client portal access not found\" });\n      }\n      await storage.deleteClientPortalAccess(req.params.id);\n      res.json({ message: \"Client portal access deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete client portal access\" });\n    }\n  });\n\n  // ===== DOCUMENT TEMPLATE ROUTES =====\n  \n  // Get all document templates\n  app.get(\"/api/document-templates\", requireAuth, async (req, res) => {\n    try {\n      const templates = await storage.getAllDocumentTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error('Get document templates error:', error);\n      res.status(500).json({ error: \"Failed to fetch document templates\" });\n    }\n  });\n  \n  // Get single document template\n  app.get(\"/api/document-templates/:id\", requireAuth, async (req, res) => {\n    try {\n      const template = await storage.getDocumentTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Document template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch document template\" });\n    }\n  });\n  \n  // Create document template\n  app.post(\"/api/document-templates\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertDocumentTemplateSchema.safeParse({\n        ...req.body,\n        createdBy: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const template = await storage.createDocumentTemplate(result.data);\n      res.status(201).json(template);\n    } catch (error) {\n      console.error('Create document template error:', error);\n      res.status(500).json({ error: \"Failed to create document template\" });\n    }\n  });\n  \n  // Update document template\n  app.patch(\"/api/document-templates/:id\", requireAuth, async (req, res) => {\n    try {\n      const template = await storage.getDocumentTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Document template not found\" });\n      }\n      const updated = await storage.updateDocumentTemplate(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update document template\" });\n    }\n  });\n  \n  // Delete document template (CEO only)\n  app.delete(\"/api/document-templates/:id\", requireCEO, async (req, res) => {\n    try {\n      const template = await storage.getDocumentTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Document template not found\" });\n      }\n      await storage.deleteDocumentTemplate(req.params.id);\n      res.json({ message: \"Document template deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete document template\" });\n    }\n  });\n\n  // ===== INVESTOR MATCH ROUTES =====\n  \n  // Get investor matches by deal\n  app.get(\"/api/investor-matches/:dealId\", requireAuth, async (req, res) => {\n    try {\n      const matches = await storage.getInvestorMatchesByDeal(req.params.dealId);\n      res.json(matches);\n    } catch (error) {\n      console.error('Get investor matches error:', error);\n      res.status(500).json({ error: \"Failed to fetch investor matches\" });\n    }\n  });\n  \n  // Create investor match\n  app.post(\"/api/investor-matches\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertInvestorMatchSchema.safeParse({\n        ...req.body,\n        matchedBy: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const match = await storage.createInvestorMatch(result.data);\n      \n      await createAuditLog(req, 'investor_matched', 'investor_match', match.id?.toString(), `Investor ${req.body.investorId} - Deal ${req.body.dealId}`, {\n        dealId: req.body.dealId,\n        investorId: req.body.investorId,\n        status: req.body.status\n      });\n      \n      res.status(201).json(match);\n    } catch (error) {\n      console.error('Create investor match error:', error);\n      res.status(500).json({ error: \"Failed to create investor match\" });\n    }\n  });\n  \n  // Delete investor match\n  app.delete(\"/api/investor-matches/:dealId/:investorId\", requireAuth, async (req, res) => {\n    try {\n      await storage.deleteInvestorMatch(req.params.dealId, parseInt(req.params.investorId));\n      \n      await createAuditLog(req, 'investor_match_removed', 'investor_match', undefined, `Investor ${req.params.investorId} - Deal ${req.params.dealId}`, {\n        dealId: req.params.dealId,\n        investorId: req.params.investorId\n      });\n      \n      res.json({ message: \"Investor match deleted\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete investor match\" });\n    }\n  });\n  \n  // Delete all investor matches for a deal\n  app.delete(\"/api/investor-matches/:dealId\", requireAuth, async (req, res) => {\n    try {\n      await storage.deleteInvestorMatchesByDeal(req.params.dealId);\n      res.json({ message: \"All investor matches deleted for deal\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete investor matches\" });\n    }\n  });\n\n  // ===== USER PREFERENCES ROUTES =====\n  \n  // Get user preferences\n  app.get(\"/api/user-preferences\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const prefs = await storage.getUserPreferences(user.id);\n      res.json(prefs || {\n        userId: user.id,\n        dashboardWidgets: [],\n        sidebarCollapsed: false,\n        theme: 'system',\n        complianceDefaults: { sec: false, finra: false, legal: true },\n        marketSymbols: ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'SPY'],\n        hasSeenWelcome: false,\n      });\n    } catch (error) {\n      console.error('Get user preferences error:', error);\n      res.status(500).json({ error: \"Failed to fetch user preferences\" });\n    }\n  });\n  \n  // Upsert user preferences\n  app.post(\"/api/user-preferences\", preferencesLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertUserPreferencesSchema.safeParse({\n        ...req.body,\n        userId: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const prefs = await storage.upsertUserPreferences(result.data);\n      res.json(prefs);\n    } catch (error) {\n      console.error('Upsert user preferences error:', error);\n      res.status(500).json({ error: \"Failed to save user preferences\" });\n    }\n  });\n  \n  // Update specific user preferences fields\n  app.patch(\"/api/user-preferences\", requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      // First ensure preferences exist\n      let prefs = await storage.getUserPreferences(user.id);\n      if (!prefs) {\n        prefs = await storage.upsertUserPreferences({\n          userId: user.id,\n          ...req.body,\n        });\n      } else {\n        prefs = await storage.updateUserPreferencesRecord(user.id, req.body);\n      }\n      res.json(prefs);\n    } catch (error) {\n      console.error('Update user preferences error:', error);\n      res.status(500).json({ error: \"Failed to update user preferences\" });\n    }\n  });\n\n  // ===== DEAL TEMPLATE ROUTES =====\n  \n  // Get all deal templates\n  app.get(\"/api/deal-templates\", requireAuth, async (req, res) => {\n    try {\n      const templates = await storage.getAllDealTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error('Get deal templates error:', error);\n      res.status(500).json({ error: \"Failed to fetch deal templates\" });\n    }\n  });\n  \n  // Get single deal template\n  app.get(\"/api/deal-templates/:id\", requireAuth, async (req, res) => {\n    try {\n      const template = await storage.getDealTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Deal template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch deal template\" });\n    }\n  });\n  \n  // Create deal template\n  app.post(\"/api/deal-templates\", generalLimiter, requireAuth, async (req, res) => {\n    try {\n      const user = req.user as any;\n      const result = insertDealTemplateSchema.safeParse({\n        ...req.body,\n        createdBy: user.id,\n      });\n      if (!result.success) {\n        return res.status(400).json({ error: fromError(result.error).toString() });\n      }\n      const template = await storage.createDealTemplate(result.data);\n      res.status(201).json(template);\n    } catch (error) {\n      console.error('Create deal template error:', error);\n      res.status(500).json({ error: \"Failed to create deal template\" });\n    }\n  });\n  \n  // Update deal template\n  app.patch(\"/api/deal-templates/:id\", requireAuth, async (req, res) => {\n    try {\n      const template = await storage.getDealTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Deal template not found\" });\n      }\n      const updated = await storage.updateDealTemplate(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update deal template\" });\n    }\n  });\n  \n  // Delete deal template (CEO only)\n  app.delete(\"/api/deal-templates/:id\", requireCEO, async (req, res) => {\n    try {\n      const template = await storage.getDealTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Deal template not found\" });\n      }\n      await storage.deleteDealTemplate(req.params.id);\n      res.json({ message: \"Deal template deleted","path":null,"size_bytes":360000,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/item.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction ItemGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      role=\"list\"\n      data-slot=\"item-group\"\n      className={cn(\"group/item-group flex flex-col\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"item-separator\"\n      orientation=\"horizontal\"\n      className={cn(\"my-0\", className)}\n      {...props}\n    />\n  )\n}\n\nconst itemVariants = cva(\n  \"group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline: \"border-border\",\n        muted: \"bg-muted/50\",\n      },\n      size: {\n        default: \"gap-4 p-4 \",\n        sm: \"gap-2.5 px-4 py-3\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction Item({\n  className,\n  variant = \"default\",\n  size = \"default\",\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> &\n  VariantProps<typeof itemVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n  return (\n    <Comp\n      data-slot=\"item\"\n      data-variant={variant}\n      data-size={size}\n      className={cn(itemVariants({ variant, size, className }))}\n      {...props}\n    />\n  )\n}\n\nconst itemMediaVariants = cva(\n  \"flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4\",\n        image:\n          \"size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction ItemMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof itemMediaVariants>) {\n  return (\n    <div\n      data-slot=\"item-media\"\n      data-variant={variant}\n      className={cn(itemMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction ItemContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-content\"\n      className={cn(\n        \"flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-title\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"item-description\"\n      className={cn(\n        \"text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemActions({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-actions\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-header\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-footer\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Item,\n  ItemMedia,\n  ItemContent,\n  ItemActions,\n  ItemGroup,\n  ItemSeparator,\n  ItemTitle,\n  ItemDescription,\n  ItemHeader,\n  ItemFooter,\n}\n","path":null,"size_bytes":4494,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"grid place-content-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1031,"size_tokens":null},"client/src/components/ui/field.tsx":{"content":"\"use client\"\n\nimport { useMemo } from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction FieldSet({ className, ...props }: React.ComponentProps<\"fieldset\">) {\n  return (\n    <fieldset\n      data-slot=\"field-set\"\n      className={cn(\n        \"flex flex-col gap-6\",\n        \"has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLegend({\n  className,\n  variant = \"legend\",\n  ...props\n}: React.ComponentProps<\"legend\"> & { variant?: \"legend\" | \"label\" }) {\n  return (\n    <legend\n      data-slot=\"field-legend\"\n      data-variant={variant}\n      className={cn(\n        \"mb-3 font-medium\",\n        \"data-[variant=legend]:text-base\",\n        \"data-[variant=label]:text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-group\"\n      className={cn(\n        \"group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst fieldVariants = cva(\n  \"group/field data-[invalid=true]:text-destructive flex w-full gap-3\",\n  {\n    variants: {\n      orientation: {\n        vertical: [\"flex-col [&>*]:w-full [&>.sr-only]:w-auto\"],\n        horizontal: [\n          \"flex-row items-center\",\n          \"[&>[data-slot=field-label]]:flex-auto\",\n          \"has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start\",\n        ],\n        responsive: [\n          \"@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto\",\n          \"@md/field-group:[&>[data-slot=field-label]]:flex-auto\",\n          \"@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px\",\n        ],\n      },\n    },\n    defaultVariants: {\n      orientation: \"vertical\",\n    },\n  }\n)\n\nfunction Field({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof fieldVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"field\"\n      data-orientation={orientation}\n      className={cn(fieldVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction FieldContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-content\"\n      className={cn(\n        \"group/field-content flex flex-1 flex-col gap-1.5 leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof Label>) {\n  return (\n    <Label\n      data-slot=\"field-label\"\n      className={cn(\n        \"group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50\",\n        \"has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4\",\n        \"has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-label\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"field-description\"\n      className={cn(\n        \"text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance\",\n        \"nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldSeparator({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  children?: React.ReactNode\n}) {\n  return (\n    <div\n      data-slot=\"field-separator\"\n      data-content={!!children}\n      className={cn(\n        \"relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2\",\n        className\n      )}\n      {...props}\n    >\n      <Separator className=\"absolute inset-0 top-1/2\" />\n      {children && (\n        <span\n          className=\"bg-background text-muted-foreground relative mx-auto block w-fit px-2\"\n          data-slot=\"field-separator-content\"\n        >\n          {children}\n        </span>\n      )}\n    </div>\n  )\n}\n\nfunction FieldError({\n  className,\n  children,\n  errors,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  errors?: Array<{ message?: string } | undefined>\n}) {\n  const content = useMemo(() => {\n    if (children) {\n      return children\n    }\n\n    if (!errors) {\n      return null\n    }\n\n    if (errors?.length === 1 && errors[0]?.message) {\n      return errors[0].message\n    }\n\n    return (\n      <ul className=\"ml-4 flex list-disc flex-col gap-1\">\n        {errors.map(\n          (error, index) =>\n            error?.message && <li key={index}>{error.message}</li>\n        )}\n      </ul>\n    )\n  }, [children, errors])\n\n  if (!content) {\n    return null\n  }\n\n  return (\n    <div\n      role=\"alert\"\n      data-slot=\"field-error\"\n      className={cn(\"text-destructive text-sm font-normal\", className)}\n      {...props}\n    >\n      {content}\n    </div>\n  )\n}\n\nexport {\n  Field,\n  FieldLabel,\n  FieldDescription,\n  FieldError,\n  FieldGroup,\n  FieldLegend,\n  FieldSeparator,\n  FieldSet,\n  FieldContent,\n  FieldTitle,\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"client/src/components/layout/Sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { \n  LayoutDashboard, \n  Briefcase, \n  FileText, \n  Users, \n  PieChart, \n  Bot,\n  CheckSquare,\n  Home,\n  MessageCircle,\n  Calendar,\n  BarChart3,\n  Target,\n  UserCheck,\n  GraduationCap,\n  Megaphone,\n  Building,\n  ChevronDown,\n  ChevronRight,\n  Shield,\n  Database,\n  FileStack,\n  FolderOpen,\n  ClipboardList,\n  ClipboardCheck,\n  Brain\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useUserPreferences, useSaveUserPreferences, useCurrentUser } from \"@/lib/api\";\nimport { useDashboardContext } from \"@/contexts/DashboardContext\";\nimport logo from \"@assets/generated_images/abstract_minimalist_layer_icon_for_fintech_logo.png\";\nimport { useState, useEffect, useRef } from \"react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport type { UserPreferences } from \"@shared/schema\";\n\ntype SidebarProps = {\n  role: 'CEO' | 'Employee';\n  collapsed?: boolean;\n  inMobileDrawer?: boolean; // When true, uses fixed width without responsive classes\n};\n\ntype LinkItem = {\n  icon: any;\n  label: string;\n  path: string;\n};\n\ntype CategoryGroup = {\n  category: string;\n  links: LinkItem[];\n};\n\nexport function Sidebar({ role, collapsed = false, inMobileDrawer = false }: SidebarProps) {\n  const [location, setLocation] = useLocation();\n  const { data: currentUser } = useCurrentUser();\n  const { unreadMessageCount, clearUnreadMessages } = useDashboardContext();\n  const queryClient = useQueryClient();\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  \n  // Expanded categories state - persist to user_preferences.settings.sidebarCategories\n  const [expandedCategories, setExpandedCategories] = useState<Record<string, boolean>>({});\n  const [categoriesInitialized, setCategoriesInitialized] = useState(false);\n  const prevCategoriesRef = useRef<string | null>(null);\n  \n  // Load categories from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !categoriesInitialized) {\n      const savedCategories = (userPrefs?.settings as any)?.sidebarCategories;\n      if (savedCategories && typeof savedCategories === 'object') {\n        setExpandedCategories(savedCategories);\n      }\n      setCategoriesInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, categoriesInitialized]);\n  \n  // Save categories to database (debounced)\n  useEffect(() => {\n    if (!categoriesInitialized || prefsLoading) return;\n    \n    const currentJson = JSON.stringify(expandedCategories);\n    if (prevCategoriesRef.current === currentJson) return;\n    \n    // Skip initial save if values match server state\n    if (prevCategoriesRef.current === null) {\n      const serverCategories = (userPrefs?.settings as any)?.sidebarCategories;\n      if (serverCategories && JSON.stringify(serverCategories) === currentJson) {\n        prevCategoriesRef.current = currentJson;\n        return;\n      }\n    }\n    \n    const timeout = setTimeout(() => {\n      const freshPrefs = queryClient.getQueryData<UserPreferences>(['userPreferences']) || userPrefs;\n      const { id, userId, updatedAt, ...mutablePrefs } = (freshPrefs || {}) as any;\n      const existingSettings = (freshPrefs?.settings as any) || {};\n      saveUserPrefs.mutate({\n        ...mutablePrefs,\n        settings: {\n          ...existingSettings,\n          sidebarCategories: expandedCategories,\n        },\n      });\n      prevCategoriesRef.current = currentJson;\n    }, 2000);\n    \n    return () => clearTimeout(timeout);\n  }, [expandedCategories, categoriesInitialized, prefsLoading, userPrefs]);\n  \n  const toggleCategory = (category: string) => {\n    setExpandedCategories(prev => ({\n      ...prev,\n      [category]: !prev[category]\n    }));\n  };\n  \n  const openAIAssistant = () => {\n    // Dispatch custom event to open the AI assistant\n    window.dispatchEvent(new CustomEvent('openKronosAssistant'));\n  };\n\n  const isActive = (path: string) => location === path;\n  const isMessagesPath = location.includes('/chat');\n  \n  const isCategoryActive = (links: LinkItem[]) => {\n    return links.some(link => isActive(link.path));\n  };\n\n  // Check if user is an admin - for showing Asset Management in CEO view\n  const isAdmin = currentUser?.accessLevel === 'admin';\n  const canAccessForms = currentUser?.name?.toLowerCase().includes('dimitra') || \n                         currentUser?.email?.toLowerCase().includes('dimitra') ||\n                         currentUser?.name?.toLowerCase().includes('charles') || \n                         currentUser?.email?.toLowerCase().includes('charles');\n  const isDimitra = canAccessForms;\n\n  // CEO grouped links - ordered: Dashboard, My Tasks, Opportunities, Deal Management, Asset Management (admin only), Documents\n  const ceoGroups: CategoryGroup[] = [\n    {\n      category: \"Platform\",\n      links: [\n        { icon: LayoutDashboard, label: \"Dashboard\", path: \"/ceo/dashboard\" },\n        { icon: CheckSquare, label: \"My Tasks\", path: \"/ceo/tasks\" },\n        { icon: Target, label: \"Opportunities\", path: \"/ceo/opportunities\" },\n        { icon: Briefcase, label: \"Deal Management\", path: \"/ceo/deals\" },\n        ...(isAdmin ? [{ icon: BarChart3, label: \"Asset Management\", path: \"/ceo/asset-management\" }] : []),\n        { icon: FileText, label: \"Documents\", path: \"/ceo/documents\" },\n      ]\n    },\n    {\n      category: \"People\",\n      links: [\n        { icon: BarChart3, label: \"Team Performance\", path: \"/ceo/team-performance\" },\n        { icon: Brain, label: \"Team Profiles\", path: \"/ceo/team-profiles\" },\n        { icon: Users, label: \"Team Assignment\", path: \"/ceo/team\" },\n        { icon: GraduationCap, label: \"Mentorship\", path: \"/ceo/mentorship\" },\n        { icon: FileText, label: \"Resume Onboarding\", path: \"/ceo/resume-onboarding\" },\n        { icon: Brain, label: \"Personality Profile\", path: \"/ceo/personality-assessment\" },\n      ]\n    },\n    {\n      category: \"Schedule\",\n      links: [\n        { icon: Calendar, label: \"Calendar\", path: \"/ceo/calendar\" },\n        { icon: Target, label: \"Goals & OKRs\", path: \"/ceo/okrs\" },\n      ]\n    },\n    {\n      category: \"Collaboration\",\n      links: [\n        { icon: Megaphone, label: \"Communications\", path: \"/ceo/announcements\" },\n        { icon: MessageCircle, label: \"Messages\", path: \"/ceo/chat\" },\n      ]\n    },\n    {\n      category: \"Clients\",\n      links: [\n        { icon: UserCheck, label: \"Client Portal\", path: \"/ceo/client-portal\" },\n        { icon: PieChart, label: \"Investor Match\", path: \"/ceo/investors\" },\n        { icon: Building, label: \"CRM\", path: \"/ceo/stakeholders\" },\n      ]\n    },\n    {\n      category: \"Administration\",\n      links: [\n        { icon: Shield, label: \"User Management\", path: \"/ceo/admin\" },\n        { icon: ClipboardList, label: \"Audit Logs\", path: \"/ceo/audit-logs\" },\n        { icon: FileStack, label: \"Templates\", path: \"/ceo/deal-templates\" },\n        { icon: FolderOpen, label: \"Document Library\", path: \"/ceo/document-library\" },\n        ...(isDimitra ? [\n          { icon: ClipboardCheck, label: \"Forms\", path: \"/ceo/forms\" },\n          { icon: FileStack, label: \"HR Templates\", path: \"/ceo/task-templates\" },\n        ] : []),\n      ]\n    }\n  ];\n\n  // Check if user can access Asset Management division\n  // Uses database flag hasAssetManagementAccess, plus all admins have access\n  const canAccessAssetManagement = \n    currentUser?.hasAssetManagementAccess === true ||\n    currentUser?.accessLevel === 'admin';\n\n  // Employee grouped links - dynamically filter based on user\n  const employeePlatformLinks = [\n    { icon: Home, label: \"Home\", path: \"/employee/home\" },\n    { icon: CheckSquare, label: \"My Tasks\", path: \"/employee/tasks\" },\n    { icon: Target, label: \"Opportunities\", path: \"/employee/opportunities\" },\n    { icon: Briefcase, label: \"Deal Management\", path: \"/employee/deals\" },\n    ...(canAccessAssetManagement ? [{ icon: BarChart3, label: \"Asset Management\", path: \"/employee/asset-management\" }] : []),\n    { icon: FileText, label: \"Documents\", path: \"/employee/documents\" },\n    { icon: FolderOpen, label: \"Document Library\", path: \"/employee/document-library\" },\n  ];\n\n  const employeeGroups: CategoryGroup[] = [\n    {\n      category: \"Platform\",\n      links: employeePlatformLinks as LinkItem[],\n    },\n    {\n      category: \"People\",\n      links: [\n        { icon: FileText, label: \"Resume Onboarding\", path: \"/employee/resume-onboarding\" },\n        { icon: Brain, label: \"Personality Profile\", path: \"/employee/personality-assessment\" },\n      ]\n    },\n    {\n      category: \"Collaboration\",\n      links: [\n        { icon: Megaphone, label: \"Communications\", path: \"/employee/announcements\" },\n        { icon: MessageCircle, label: \"Messages\", path: \"/employee/chat\" },\n      ]\n    },\n    {\n      category: \"Clients\",\n      links: [\n        { icon: PieChart, label: \"Investor Match\", path: \"/employee/investors\" },\n        { icon: Building, label: \"CRM\", path: \"/employee/stakeholders\" },\n      ]\n    },\n    {\n      category: \"Schedule\",\n      links: [\n        { icon: Calendar, label: \"Calendar\", path: \"/employee/calendar\" },\n        { icon: Target, label: \"Goals & OKRs\", path: \"/employee/okrs\" },\n      ]\n    },\n    {\n      category: \"Compliance\",\n      links: [\n        { icon: ClipboardList, label: \"My Activity Log\", path: \"/employee/audit-logs\" },\n      ]\n    },\n    ...(isDimitra ? [{\n      category: \"Administration\",\n      links: [\n        { icon: ClipboardCheck, label: \"Forms\", path: \"/employee/forms\" },\n        { icon: FileStack, label: \"HR Templates\", path: \"/employee/task-templates\" },\n      ]\n    }] : [])\n  ];\n\n  // Use the role prop to determine navigation (supports preview mode for admins)\n  const groups = role === 'CEO' ? ceoGroups : employeeGroups;\n\n  // Determine if sidebar should show in collapsed state (icons only)\n  // In mobile drawer, always show expanded (labels visible)\n  const showCollapsed = inMobileDrawer ? false : collapsed;\n  \n  return (\n    <div className={cn(\n      \"h-screen bg-sidebar flex flex-col text-sidebar-foreground transition-all duration-300\",\n      // In mobile drawer: no fixed positioning, no border (Sheet handles it)\n      inMobileDrawer ? \"w-64 border-0\" : [\n        \"fixed left-0 top-0 z-50 border-r border-sidebar-border\",\n        // Width: collapsed on md, full on lg, unless explicitly collapsed\n        collapsed ? \"w-20\" : \"w-64\",\n        \"md:w-20 lg:w-64\",\n        collapsed && \"lg:w-20\"\n      ]\n    )}>\n      <div className={cn(\"p-6 flex items-center\", showCollapsed ? \"justify-center\" : \"gap-3\")}>\n        <div className=\"w-8 h-8 rounded bg-primary/20 flex items-center justify-center overflow-hidden flex-shrink-0\">\n            <img src={logo} alt=\"Logo\" className=\"w-full h-full object-cover\" />\n        </div>\n        {!showCollapsed && (\n          <div>\n            <h1 className=\"font-display font-bold text-lg leading-none tracking-tight\">Kronos</h1>\n            <p className=\"text-xs text-muted-foreground mt-0.5\">v2.4</p>\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex-1 px-3 py-4 space-y-1 overflow-y-auto\">\n        {groups.map((group) => {\n          const isGroupActive = isCategoryActive(group.links);\n          const isExpanded = expandedCategories[group.category] !== false;\n          \n          return (\n            <div key={group.category} className=\"mb-2\">\n              {!showCollapsed ? (\n                <>\n                  <button\n                    onClick={() => toggleCategory(group.category)}\n                    className={cn(\n                      \"w-full flex items-center justify-between px-3 py-2 mb-1 text-xs font-semibold uppercase tracking-wider rounded-md transition-colors\",\n                      isGroupActive \n                        ? \"text-primary bg-primary/5\" \n                        : \"text-muted-foreground hover:text-foreground hover:bg-secondary/30\"\n                    )}\n                    data-testid={`sidebar-category-${group.category.toLowerCase()}`}\n                  >\n                    <span>{group.category}</span>\n                    {isExpanded ? (\n                      <ChevronDown className=\"w-3 h-3\" />\n                    ) : (\n                      <ChevronRight className=\"w-3 h-3\" />\n                    )}\n                  </button>\n                  \n                  {isExpanded && (\n                    <div className=\"space-y-0.5 pl-1\">\n                      {group.links.map((link) => {\n                        const isMessageLink = link.path.includes('/chat');\n                        const showBadge = isMessageLink && unreadMessageCount > 0 && !isMessagesPath;\n                        \n                        return (\n                          <Link \n                            key={link.path} \n                            href={link.path}\n                            onClick={() => {\n                              if (isMessageLink) {\n                                clearUnreadMessages();\n                              }\n                            }}\n                          >\n                            <div\n                              className={cn(\n                                \"flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 cursor-pointer group relative\",\n                                isActive(link.path)\n                                  ? \"bg-primary/10 text-primary shadow-[inset_3px_0_0_0_hsl(var(--primary))]\"\n                                  : \"text-muted-foreground hover:bg-sidebar-accent hover:text-foreground\"\n                              )}\n                              data-testid={`sidebar-link-${link.path.split('/').pop()}`}\n                            >\n                              <div className=\"relative\">\n                                <link.icon className={cn(\"w-4 h-4 flex-shrink-0\", isActive(link.path) ? \"text-primary\" : \"text-muted-foreground group-hover:text-foreground\")} />\n                                {showBadge && (\n                                  <div className=\"absolute -top-1.5 -right-1.5 min-w-[16px] h-4 px-1 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-pulse\">\n                                    {unreadMessageCount > 9 ? '9+' : unreadMessageCount}\n                                  </div>\n                                )}\n                              </div>\n                              <span className=\"flex-1\">{link.label}</span>\n                              {showBadge && (\n                                <div className=\"min-w-[20px] h-5 px-1.5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center\">\n                                  {unreadMessageCount > 9 ? '9+' : unreadMessageCount}\n                                </div>\n                              )}\n                            </div>\n                          </Link>\n                        );\n                      })}\n                    </div>\n                  )}\n                </>\n              ) : (\n                <div className=\"space-y-1\">\n                  {group.links.map((link) => {\n                    const isMessageLink = link.path.includes('/chat');\n                    const showBadge = isMessageLink && unreadMessageCount > 0 && !isMessagesPath;\n                    \n                    return (\n                      <Link \n                        key={link.path} \n                        href={link.path}\n                        onClick={() => {\n                          if (isMessageLink) {\n                            clearUnreadMessages();\n                          }\n                        }}\n                      >\n                        <div\n                          className={cn(\n                            \"flex items-center justify-center px-2 py-3 rounded-md text-sm font-medium transition-all duration-200 cursor-pointer group relative\",\n                            isActive(link.path)\n                              ? \"bg-primary/10 text-primary shadow-[inset_3px_0_0_0_hsl(var(--primary))]\"\n                              : \"text-muted-foreground hover:bg-sidebar-accent hover:text-foreground\"\n                          )}\n                          data-testid={`sidebar-link-${link.path.split('/').pop()}`}\n                          title={link.label}\n                        >\n                          <div className=\"relative\">\n                            <link.icon className={cn(\"w-4 h-4 flex-shrink-0\", isActive(link.path) ? \"text-primary\" : \"text-muted-foreground group-hover:text-foreground\")} />\n                            {showBadge && (\n                              <div className=\"absolute -top-1.5 -right-1.5 min-w-[16px] h-4 px-1 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-pulse\">\n                                {unreadMessageCount > 9 ? '9+' : unreadMessageCount}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </Link>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n\n      <div className=\"p-4 border-t border-sidebar-border\">\n        <button\n          onClick={openAIAssistant}\n          className={cn(\n            \"flex items-center rounded-lg text-sm font-semibold bg-gradient-to-r from-primary/20 to-primary/10 hover:from-primary/30 hover:to-primary/20 text-primary cursor-pointer transition-all w-full group shadow-sm hover:shadow-md border border-primary/20\",\n            showCollapsed ? \"justify-center px-2 py-3\" : \"gap-3 px-3 py-3 text-left\"\n          )}\n          data-testid=\"sidebar-ai-assistant\"\n          title={showCollapsed ? \"Ask Kronos AI\" : undefined}\n        >\n          <div className=\"relative\">\n            <Bot className=\"w-5 h-5 flex-shrink-0 group-hover:scale-110 transition-transform\" />\n            <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\n          </div>\n          {!showCollapsed && (\n            <div className=\"flex flex-col\">\n              <span>Ask Kronos AI</span>\n              <span className=\"text-[10px] text-primary/70 font-normal\">Click to chat</span>\n            </div>\n          )}\n        </button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":18359,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1486,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1267,"size_tokens":null},"client/src/contexts/DashboardContext.tsx":{"content":"import React, { createContext, useContext, useState, ReactNode, useCallback, useEffect, useRef } from 'react';\nimport { toast } from 'sonner';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { useUserPreferences, useSaveUserPreferences } from '@/lib/api';\nimport type { UserPreferences } from '@shared/schema';\n\ninterface MessageNotification {\n  id: string;\n  senderName: string;\n  senderAvatar?: string;\n  preview: string;\n  timestamp: Date;\n}\n\ninterface DashboardContextType {\n  showProfileSheet: boolean;\n  setShowProfileSheet: (show: boolean) => void;\n  showSettingsSheet: boolean;\n  setShowSettingsSheet: (show: boolean) => void;\n  showResourcesSheet: boolean;\n  setShowResourcesSheet: (show: boolean) => void;\n  showNotificationsSheet: boolean;\n  setShowNotificationsSheet: (show: boolean) => void;\n  showCustomizeSheet: boolean;\n  setShowCustomizeSheet: (show: boolean) => void;\n  unreadMessageCount: number;\n  setUnreadMessageCount: (count: number) => void;\n  addMessageNotification: (notification: MessageNotification) => void;\n  clearUnreadMessages: () => void;\n}\n\nconst DashboardContext = createContext<DashboardContextType | undefined>(undefined);\n\nexport function DashboardProvider({ children }: { children: ReactNode }) {\n  const [showProfileSheet, setShowProfileSheet] = useState(false);\n  const [showSettingsSheet, setShowSettingsSheet] = useState(false);\n  const [showResourcesSheet, setShowResourcesSheet] = useState(false);\n  const [showNotificationsSheet, setShowNotificationsSheet] = useState(false);\n  const [showCustomizeSheet, setShowCustomizeSheet] = useState(false);\n  const [unreadMessageCount, setUnreadMessageCount] = useState(0);\n  const [countInitialized, setCountInitialized] = useState(false);\n  const prevCountRef = useRef<number | null>(null);\n  \n  const queryClient = useQueryClient();\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  \n  // Load unread count from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !countInitialized) {\n      const savedCount = (userPrefs?.settings as any)?.unreadMessageCount;\n      if (typeof savedCount === 'number') {\n        setUnreadMessageCount(savedCount);\n      }\n      setCountInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, countInitialized]);\n  \n  // Save unread count to database (debounced) - only save when count actually changes\n  useEffect(() => {\n    if (!countInitialized || prefsLoading) return;\n    \n    // Skip if we haven't initialized the previous count yet\n    if (prevCountRef.current === null) {\n      prevCountRef.current = unreadMessageCount;\n      return;\n    }\n    \n    // Skip if count hasn't changed\n    if (prevCountRef.current === unreadMessageCount) return;\n    \n    const timeout = setTimeout(() => {\n      const freshPrefs = queryClient.getQueryData<UserPreferences>(['user-preferences']) || userPrefs;\n      const { id, userId, updatedAt, ...mutablePrefs } = (freshPrefs || {}) as any;\n      const existingSettings = (freshPrefs?.settings as any) || {};\n      saveUserPrefs.mutate({\n        ...mutablePrefs,\n        settings: {\n          ...existingSettings,\n          unreadMessageCount: unreadMessageCount,\n        },\n      });\n      prevCountRef.current = unreadMessageCount;\n    }, 2000);\n    \n    return () => clearTimeout(timeout);\n  }, [unreadMessageCount, countInitialized, prefsLoading]);\n\n  const addMessageNotification = useCallback((notification: MessageNotification) => {\n    setUnreadMessageCount(prev => prev + 1);\n    \n    toast.custom((t) => (\n      <div className=\"bg-card border border-border rounded-lg shadow-xl p-4 max-w-sm animate-in slide-in-from-top-5 duration-300\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-sm font-bold text-primary flex-shrink-0\">\n            {notification.senderName.split(' ').map(n => n[0]).join('').slice(0, 2)}\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"font-semibold text-sm text-foreground\">{notification.senderName}</span>\n              <span className=\"text-xs text-muted-foreground\">now</span>\n            </div>\n            <p className=\"text-sm text-muted-foreground truncate mt-0.5\">{notification.preview}</p>\n          </div>\n        </div>\n      </div>\n    ), {\n      duration: 5000,\n      position: 'top-right',\n    });\n  }, []);\n\n  const clearUnreadMessages = useCallback(() => {\n    setUnreadMessageCount(0);\n  }, []);\n\n  return (\n    <DashboardContext.Provider\n      value={{\n        showProfileSheet,\n        setShowProfileSheet,\n        showSettingsSheet,\n        setShowSettingsSheet,\n        showResourcesSheet,\n        setShowResourcesSheet,\n        showNotificationsSheet,\n        setShowNotificationsSheet,\n        showCustomizeSheet,\n        setShowCustomizeSheet,\n        unreadMessageCount,\n        setUnreadMessageCount,\n        addMessageNotification,\n        clearUnreadMessages,\n      }}\n    >\n      {children}\n    </DashboardContext.Provider>\n  );\n}\n\nexport function useDashboardContext() {\n  const context = useContext(DashboardContext);\n  if (context === undefined) {\n    throw new Error('useDashboardContext must be used within a DashboardProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":5399,"size_tokens":null},"client/src/pages/ceo/Dashboard.tsx":{"content":"import React, { useState, useEffect, useMemo, useRef, useCallback } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { Reorder } from \"framer-motion\";\nimport { \n  ChartContainer, \n  ChartTooltip, \n  ChartTooltipContent,\n} from \"@/components/ui/chart\";\nimport { \n  BarChart, \n  Bar, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  PieChart as RechartsPieChart, \n  Pie, \n  Cell, \n  LineChart, \n  Line, \n  Area, \n  AreaChart,\n  ResponsiveContainer \n} from \"recharts\";\nimport { \n  TrendingUp, \n  TrendingDown, \n  Activity, \n  DollarSign, \n  Briefcase, \n  Users, \n  Clock,\n  ArrowUpRight,\n  Plus,\n  Settings,\n  CheckSquare,\n  User,\n  Bell,\n  BookOpen,\n  Palette,\n  FileText,\n  Download,\n  Calendar,\n  Mail,\n  MapPin,\n  X,\n  ChevronRight,\n  BarChart3,\n  PieChart,\n  Target,\n  Zap,\n  Eye,\n  Trash2,\n  Check,\n  AlertCircle,\n  Info,\n  Paperclip,\n  Search,\n  Lock,\n  Phone,\n  Pencil,\n  GripVertical,\n  LayoutDashboard,\n  Video,\n  Link as LinkIcon,\n  ChevronsUpDown\n} from \"lucide-react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { useCurrentUser, useUsers, useDealsListing, useTasks, useCreateDeal, useNotifications, useCreateMeeting, useMeetings, useUpdateUserPreferences, useMarketData, useMarketNews, useUserPreferences, useSaveUserPreferences, useCalendarEvents, useAllDealFees, useCustomSectors, useCreateCustomSector } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format, subDays, startOfDay, isAfter, isSameDay } from \"date-fns\";\nimport { jsPDF } from \"jspdf\";\nimport type { User as UserType, Deal, Task } from \"@shared/schema\";\nimport { useDashboardContext } from \"@/contexts/DashboardContext\";\n\ntype WidgetConfig = {\n  id: string;\n  name: string;\n  enabled: boolean;\n};\n\nconst DEFAULT_WIDGETS: WidgetConfig[] = [\n  { id: 'quickActions', name: 'Quick Actions', enabled: true },\n  { id: 'activeDeals', name: 'Active Deals Analytics', enabled: true },\n  { id: 'marketPulse', name: 'Market Pulse', enabled: true },\n  { id: 'marketIntelligence', name: 'Market Intelligence', enabled: true },\n  { id: 'teamTaskProgress', name: 'Team Task Progress', enabled: true },\n  { id: 'upcomingMeetings', name: 'Upcoming Meetings', enabled: true },\n  { id: 'recentActivity', name: 'Recent Activity', enabled: true },\n  { id: 'capitalAtWork', name: 'Capital At Work', enabled: true },\n  { id: 'feeSummary', name: 'Fee Summary', enabled: true },\n  { id: 'dealPipeline', name: 'Deal Pipeline Overview', enabled: false },\n  { id: 'performanceMetrics', name: 'Performance Metrics', enabled: false },\n];\n\nexport default function Dashboard() {\n  const [, setLocation] = useLocation();\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [], isLoading: usersLoading } = useUsers();\n  const { data: deals = [], isLoading: dealsLoading } = useDealsListing();\n  const { data: tasks = [], isLoading: tasksLoading } = useTasks();\n  const { data: notifications = [] } = useNotifications();\n  const { data: meetings = [] } = useMeetings();\n  const { data: allDealFees = [] } = useAllDealFees();\n  const { data: calendarEvents = [] } = useCalendarEvents();\n  const createDeal = useCreateDeal();\n  const createMeeting = useCreateMeeting();\n  const updateUserPreferences = useUpdateUserPreferences();\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  const { data: customSectors = [] } = useCustomSectors();\n  const createCustomSector = useCreateCustomSector();\n\n  // Use context for shared sheet states (only Customize is rendered here, others moved to Layout)\n  const {\n    showCustomizeSheet,\n    setShowCustomizeSheet,\n  } = useDashboardContext();\n\n  // Local modal states\n  const [showNewDealModal, setShowNewDealModal] = useState(false);\n  const [showScheduleMeetingModal, setShowScheduleMeetingModal] = useState(false);\n  const [showEmployeeDetailModal, setShowEmployeeDetailModal] = useState(false);\n  const [selectedEmployee, setSelectedEmployee] = useState<UserType | null>(null);\n  const [viewTab, setViewTab] = useState<'dashboard' | 'analytics'>('dashboard');\n  \n  // Widget filter states\n  const [activeDealsFilter, setActiveDealsFilter] = useState<'all' | 'IB' | 'AM'>('all');\n  const [capitalAtWorkFilter, setCapitalAtWorkFilter] = useState<'all' | 'IB' | 'AM'>('all');\n  \n  // Widget configuration - load from user preferences (database)\n  const [widgets, setWidgets] = useState<WidgetConfig[]>(DEFAULT_WIDGETS);\n  const [widgetsInitialized, setWidgetsInitialized] = useState(false);\n  \n  // Normalize widget order: Recent Activity should come before Capital At Work and Fee Summary\n  const normalizeWidgetOrder = (widgets: WidgetConfig[]): WidgetConfig[] => {\n    const recentActivityIndex = widgets.findIndex(w => w.id === 'recentActivity');\n    const capitalAtWorkIndex = widgets.findIndex(w => w.id === 'capitalAtWork');\n    const feeSummaryIndex = widgets.findIndex(w => w.id === 'feeSummary');\n    \n    // If Recent Activity is after Capital At Work or Fee Summary, we need to reorder\n    if (recentActivityIndex > capitalAtWorkIndex || recentActivityIndex > feeSummaryIndex) {\n      // Create a new array with the correct order\n      const result = widgets.filter(w => !['recentActivity', 'capitalAtWork', 'feeSummary'].includes(w.id));\n      \n      // Find the position where we should insert (after upcomingMeetings if it exists)\n      const upcomingMeetingsIndex = result.findIndex(w => w.id === 'upcomingMeetings');\n      const insertPosition = upcomingMeetingsIndex >= 0 ? upcomingMeetingsIndex + 1 : result.length;\n      \n      // Insert in correct order: Recent Activity, then Capital At Work, then Fee Summary\n      const recentActivity = widgets.find(w => w.id === 'recentActivity');\n      const capitalAtWork = widgets.find(w => w.id === 'capitalAtWork');\n      const feeSummary = widgets.find(w => w.id === 'feeSummary');\n      \n      const toInsert = [recentActivity, capitalAtWork, feeSummary].filter(Boolean) as WidgetConfig[];\n      result.splice(insertPosition, 0, ...toInsert);\n      \n      return result;\n    }\n    \n    return widgets;\n  };\n  \n  // Load widget config from user preferences when available\n  useEffect(() => {\n    if (!prefsLoading && userPrefs?.dashboardWidgets && userPrefs.dashboardWidgets.length > 0 && !widgetsInitialized) {\n      // Normalize the order to ensure Recent Activity comes before Capital At Work and Fee Summary\n      const loadedWidgets = userPrefs.dashboardWidgets as WidgetConfig[];\n      const normalizedWidgets = normalizeWidgetOrder(loadedWidgets);\n      setWidgets(normalizedWidgets);\n      setWidgetsInitialized(true);\n      \n      // If order was changed, save the corrected order\n      if (JSON.stringify(loadedWidgets) !== JSON.stringify(normalizedWidgets)) {\n        saveUserPrefs.mutateAsync({ dashboardWidgets: normalizedWidgets });\n      }\n    } else if (!prefsLoading && !widgetsInitialized) {\n      setWidgetsInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, widgetsInitialized]);\n  \n  // Save widget order to database when it changes (debounced with error handling and rollback)\n  const saveWidgetsTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const isMountedRef = useRef(true);\n  const lastSavedWidgetsRef = useRef<WidgetConfig[]>(DEFAULT_WIDGETS);\n  \n  useEffect(() => {\n    isMountedRef.current = true;\n    return () => {\n      isMountedRef.current = false;\n    };\n  }, []);\n  \n  // Store the last successfully saved widgets for rollback\n  useEffect(() => {\n    if (userPrefs?.dashboardWidgets && userPrefs.dashboardWidgets.length > 0) {\n      lastSavedWidgetsRef.current = userPrefs.dashboardWidgets as WidgetConfig[];\n    }\n  }, [userPrefs]);\n  \n  useEffect(() => {\n    if (!widgetsInitialized) return;\n    \n    // Skip if widgets haven't actually changed from last saved state\n    if (JSON.stringify(widgets) === JSON.stringify(lastSavedWidgetsRef.current)) {\n      return;\n    }\n    \n    if (saveWidgetsTimeoutRef.current) {\n      clearTimeout(saveWidgetsTimeoutRef.current);\n    }\n    saveWidgetsTimeoutRef.current = setTimeout(async () => {\n      if (!isMountedRef.current) return;\n      \n      // Double-check we still need to save\n      if (JSON.stringify(widgets) === JSON.stringify(lastSavedWidgetsRef.current)) {\n        return;\n      }\n      \n      try {\n        await saveUserPrefs.mutateAsync({ dashboardWidgets: widgets });\n        lastSavedWidgetsRef.current = widgets;\n      } catch (error: any) {\n        console.error('Failed to save widget preferences:', error);\n        // Only show toast and revert for non-auth errors\n        // 401 errors are typically session timeouts, handle silently\n        if (error?.response?.status !== 401 && error?.status !== 401) {\n          toast.error('Failed to save dashboard preferences - reverting changes');\n          if (isMountedRef.current) {\n            setWidgets(lastSavedWidgetsRef.current);\n          }\n        }\n      }\n    }, 2000);\n    return () => {\n      if (saveWidgetsTimeoutRef.current) {\n        clearTimeout(saveWidgetsTimeoutRef.current);\n      }\n    };\n  }, [widgets, widgetsInitialized]);\n  \n  // Widget detail modals\n  const [activeDealsModalOpen, setActiveDealsModalOpen] = useState(false);\n  const [capitalAtWorkModalOpen, setCapitalAtWorkModalOpen] = useState(false);\n  const [feeSummaryModalOpen, setFeeSummaryModalOpen] = useState(false);\n  \n  // Market symbols - load from preferences with effect for hydration\n  const [marketSymbols, setMarketSymbols] = useState<string[]>(['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'SPY']);\n  const [symbolsInitialized, setSymbolsInitialized] = useState(false);\n  \n  // Hydrate market symbols from user preferences when loaded\n  useEffect(() => {\n    if (!prefsLoading && userPrefs?.marketSymbols && userPrefs.marketSymbols.length > 0 && !symbolsInitialized) {\n      setMarketSymbols(userPrefs.marketSymbols);\n      setSymbolsInitialized(true);\n    } else if (!prefsLoading && !symbolsInitialized) {\n      setSymbolsInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, symbolsInitialized]);\n  const [marketSearchQuery, setMarketSearchQuery] = useState('');\n  const [showMarketSearch, setShowMarketSearch] = useState(false);\n  \n  // New deal form\n  const [newDeal, setNewDeal] = useState({\n    name: '',\n    client: '',\n    sector: 'Technology',\n    customSector: '',\n    value: '',\n    stage: 'Origination',\n    lead: '',\n    status: 'Active',\n    progress: 0,\n    description: '',\n    attachments: [] as File[],\n  });\n  const [sectorOpen, setSectorOpen] = useState(false);\n  \n  const BASE_SECTORS = ['Technology', 'Healthcare', 'Energy', 'Consumer', 'Industrials', 'Financial'];\n  const SECTORS = useMemo(() => {\n    const customNames = customSectors.map((s: any) => s.name);\n    const allSectors = [...BASE_SECTORS, ...customNames.filter((name: string) => !BASE_SECTORS.includes(name))];\n    return [...allSectors, 'Other'];\n  }, [customSectors]);\n\n  // Meeting form\n  const [newMeeting, setNewMeeting] = useState({\n    title: '',\n    description: '',\n    scheduledFor: '',\n    scheduledTime: '09:00',\n    duration: 60,\n    location: '',\n    participants: '',\n    dealId: '',\n    videoPlatform: '' as '' | 'zoom' | 'google_meet' | 'teams',\n    videoLink: '',\n  });\n\n  // Open video conferencing app in new tab\n  const openVideoApp = (platform: 'zoom' | 'google_meet' | 'teams') => {\n    const urls = {\n      zoom: 'https://zoom.us/meeting/schedule',\n      google_meet: 'https://meet.google.com/new',\n      teams: 'https://teams.microsoft.com/l/meeting/new',\n    };\n    window.open(urls[platform], '_blank');\n    setNewMeeting({ ...newMeeting, videoPlatform: platform });\n  };\n\n  // Market data from API (refreshes every 30 seconds)\n  const { data: marketDataResponse, isLoading: marketLoading } = useMarketData(marketSymbols);\n  const marketData = marketDataResponse?.data || [];\n  const marketSource = marketDataResponse?.source || 'simulated';\n  \n  // Market news from API (refreshes every minute)\n  const { data: marketNewsResponse, isLoading: newsLoading } = useMarketNews();\n  const rawMarketNews = marketNewsResponse?.data || [];\n  const newsSource = marketNewsResponse?.source || 'sample';\n  \n  // Filter for investment banking and finance related news - broader filter to ensure content shows\n  const financeKeywords = ['merger', 'm&a', 'acquisition', 'ipo', 'capital', 'deal', 'buyout', 'investment', 'equity', 'debt', 'bond', 'underwriting', 'financing', 'valuation', 'securities', 'advisory', 'banking', 'fund', 'private equity', 'venture', 'syndicate', 'offering', 'raise', 'billion', 'million', 'stock', 'market', 'trading', 'earnings', 'revenue', 'profit', 'growth', 'company', 'business', 'economy', 'financial', 'investor', 'shares', 'nasdaq', 'dow', 's&p', 'fed', 'rate', 'inflation', 'gdp', 'sector', 'industry', 'quarter', 'forecast', 'analyst', 'dividend', 'portfolio'];\n  const filteredNews = rawMarketNews.filter((news: any) => {\n    const headline = news.headline?.toLowerCase() || '';\n    const summary = news.summary?.toLowerCase() || '';\n    return financeKeywords.some(keyword => headline.includes(keyword) || summary.includes(keyword));\n  });\n  // If no news matches the filter, show all news (fallback to raw data)\n  const marketNews = filteredNews.length > 0 ? filteredNews : rawMarketNews;\n\n  // Check if current user is Sergio (Global head of Asset Management)\n  const isAssetManagementHead = currentUser?.name?.toLowerCase().includes('sergio');\n  \n  // Exclude opportunities from all dashboard calculations\n  const nonOpportunityDeals = deals.filter((d: any) => d.dealType !== 'Opportunity');\n  \n  // Split deals by division for breakdown display\n  const amDeals = nonOpportunityDeals.filter((d: any) => d.dealType === 'Asset Management');\n  const ibDeals = nonOpportunityDeals.filter((d: any) => d.dealType !== 'Asset Management');\n  const amActiveDeals = amDeals.filter(d => d.status === 'Active');\n  const ibActiveDeals = ibDeals.filter(d => d.status === 'Active');\n  \n  // Compute analytics using all deals (for general metrics) - excluding opportunities\n  const activeDeals = nonOpportunityDeals.filter(d => d.status === 'Active');\n  const totalValue = nonOpportunityDeals.reduce((sum, deal) => sum + deal.value, 0);\n  const activeValue = activeDeals.reduce((sum, deal) => sum + deal.value, 0);\n  \n  // Division-specific values\n  const ibActiveValue = ibActiveDeals.reduce((sum, deal) => sum + deal.value, 0);\n  const amActiveValue = amActiveDeals.reduce((sum, deal) => sum + deal.value, 0);\n  \n  // Display active deals - show all for combined view\n  const displayActiveDeals = activeDeals;\n  const displayActiveValue = activeValue;\n  \n  // Sector breakdown - All deals\n  const sectorStats = useMemo(() => {\n    const stats: Record<string, { count: number; value: number }> = {};\n    activeDeals.forEach(deal => {\n      if (!stats[deal.sector]) {\n        stats[deal.sector] = { count: 0, value: 0 };\n      }\n      stats[deal.sector].count++;\n      stats[deal.sector].value += deal.value;\n    });\n    return stats;\n  }, [activeDeals]);\n  \n  // Sector breakdown - IB only\n  const ibSectorStats = useMemo(() => {\n    const stats: Record<string, { count: number; value: number }> = {};\n    ibActiveDeals.forEach(deal => {\n      if (!stats[deal.sector]) {\n        stats[deal.sector] = { count: 0, value: 0 };\n      }\n      stats[deal.sector].count++;\n      stats[deal.sector].value += deal.value;\n    });\n    return stats;\n  }, [ibActiveDeals]);\n  \n  // Sector breakdown - AM only\n  const amSectorStats = useMemo(() => {\n    const stats: Record<string, { count: number; value: number }> = {};\n    amActiveDeals.forEach(deal => {\n      if (!stats[deal.sector]) {\n        stats[deal.sector] = { count: 0, value: 0 };\n      }\n      stats[deal.sector].count++;\n      stats[deal.sector].value += deal.value;\n    });\n    return stats;\n  }, [amActiveDeals]);\n\n  // Stage breakdown by division\n  const IB_STAGES = ['Origination', 'Structuring', 'Diligence', 'Legal', 'Close'];\n  const AM_STAGES = ['Reception', 'Initial Review', 'Hard Diligence', 'Structure', 'Negotiation', 'Closing', 'Invested'];\n  \n  // Map legacy IB stages to new stages\n  const mapIBStage = (stage: string) => {\n    const legacyMap: Record<string, string> = {\n      'Due Diligence': 'Diligence',\n      'Negotiation': 'Legal',\n      'Closing': 'Close',\n      'Execution': 'Structuring',\n      'Signing': 'Close',\n      'Qualification': 'Origination',\n      'Pitch': 'Structuring',\n      'Documentation': 'Legal',\n    };\n    return legacyMap[stage] || stage;\n  };\n  \n  const ibStageStats = useMemo(() => {\n    return IB_STAGES.map(stage => ({\n      stage,\n      count: ibActiveDeals.filter(d => mapIBStage(d.stage) === stage).length,\n    }));\n  }, [ibActiveDeals]);\n  \n  const amStageStats = useMemo(() => {\n    return AM_STAGES.map(stage => ({\n      stage,\n      count: amActiveDeals.filter(d => d.stage === stage).length,\n    }));\n  }, [amActiveDeals]);\n\n  // Calculate velocity scores\n  const employeeStats = useMemo(() => {\n    // Filter to only show active users (not pending or suspended)\n    const activeUsers = users.filter(user => user.status === 'active');\n    return activeUsers.map(user => {\n      const userTasks = tasks.filter(t => t.assignedTo === user.id);\n      const completedTasks = userTasks.filter(t => t.status === 'Completed').length;\n      const inProgressTasks = userTasks.filter(t => t.status === 'In Progress').length;\n      const pendingTasks = userTasks.filter(t => t.status === 'Pending').length;\n      \n      // Get tasks by deal with task names\n      const tasksByDeal: Record<string, { \n        dealName: string; \n        completed: number; \n        inProgress: number; \n        pending: number;\n        taskNames: { id: string; name: string; status: string; priority: string; dueDate?: string }[];\n      }> = {};\n      \n      userTasks.forEach(task => {\n        if (task.dealId) {\n          const deal = deals.find(d => d.id === task.dealId);\n          if (deal) {\n            if (!tasksByDeal[task.dealId]) {\n              tasksByDeal[task.dealId] = { \n                dealName: deal.name, \n                completed: 0, \n                inProgress: 0, \n                pending: 0,\n                taskNames: []\n              };\n            }\n            tasksByDeal[task.dealId].taskNames.push({\n              id: task.id,\n              name: task.title,\n              status: task.status,\n              priority: task.priority,\n              dueDate: task.dueDate || undefined,\n            });\n            if (task.status === 'Completed') tasksByDeal[task.dealId].completed++;\n            else if (task.status === 'In Progress') tasksByDeal[task.dealId].inProgress++;\n            else tasksByDeal[task.dealId].pending++;\n          }\n        }\n      });\n\n      // Calculate velocity score based on:\n      // - Completed tasks (40%)\n      // - In-progress efficiency (30%)\n      // - Active deals involvement (30%)\n      const completionRate = userTasks.length > 0 ? (completedTasks / userTasks.length) * 100 : 0;\n      const activeDealsCount = Object.keys(tasksByDeal).length;\n      const velocityScore = Math.round(\n        (completedTasks * 4) + \n        (inProgressTasks * 2) + \n        (activeDealsCount * 5) +\n        (completionRate * 0.5)\n      );\n\n      return {\n        ...user,\n        completedTasks,\n        inProgressTasks,\n        pendingTasks,\n        totalTasks: userTasks.length,\n        tasksByDeal,\n        userTasks,\n        velocityScore: Math.min(velocityScore, 100),\n      };\n    }).sort((a, b) => b.velocityScore - a.velocityScore);\n  }, [users, tasks, deals]);\n\n  const topUsers = employeeStats.slice(0, 5);\n  const unreadNotifications = notifications.filter(n => !n.read);\n\n  const handleCreateDeal = async () => {\n    if (!newDeal.name || !newDeal.client || !newDeal.value) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n    const parsedValue = parseInt(newDeal.value);\n    if (isNaN(parsedValue) || parsedValue <= 0) {\n      toast.error(\"Please enter a valid deal value\");\n      return;\n    }\n    \n    const finalSector = newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector;\n    \n    // Save custom sector if it's a new one not in the existing list\n    const isCustomSector = newDeal.sector === 'Other' && newDeal.customSector;\n    const existingCustomSectorNames = customSectors.map((s: any) => s.name.toLowerCase());\n    const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(newDeal.customSector.toLowerCase()) && !BASE_SECTORS.includes(newDeal.customSector);\n    \n    try {\n      // Save the custom sector first if it's new\n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(newDeal.customSector);\n        } catch (e) {\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      // Convert File objects to serializable metadata\n      const attachmentMeta = newDeal.attachments.map(file => ({\n        name: file.name,\n        size: file.size,\n        type: file.type,\n        uploadedAt: new Date().toISOString(),\n      }));\n      \n      await createDeal.mutateAsync({\n        name: newDeal.name,\n        client: newDeal.client,\n        sector: finalSector,\n        value: parsedValue,\n        stage: newDeal.stage,\n        lead: newDeal.lead || currentUser?.name || 'Unassigned',\n        status: newDeal.status,\n        progress: newDeal.progress || 0,\n        description: newDeal.description || null,\n        dealType: 'M&A',\n        attachments: attachmentMeta,\n        podTeam: [],\n        taggedInvestors: [],\n        auditTrail: [{\n          id: crypto.randomUUID(),\n          timestamp: new Date().toISOString(),\n          action: 'Deal Created',\n          user: currentUser?.name || 'System',\n          details: `Deal \"${newDeal.name}\" created`,\n        }],\n      });\n      toast.success(\"Deal created successfully!\");\n      setShowNewDealModal(false);\n      setNewDeal({ name: '', client: '', sector: 'Technology', customSector: '', value: '', stage: 'Origination', lead: '', status: 'Active', progress: 0, description: '', attachments: [] });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create deal\");\n    }\n  };\n\n  const handleScheduleMeeting = async () => {\n    if (!newMeeting.title || !newMeeting.scheduledFor) {\n      toast.error(\"Please fill in meeting title and date\");\n      return;\n    }\n    try {\n      const scheduledDateTime = new Date(`${newMeeting.scheduledFor}T${newMeeting.scheduledTime}`);\n      const participantEmails = newMeeting.participants.split(',').map(e => e.trim()).filter(e => e);\n      \n      // Get organizer's timezone for email display\n      const organizerTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n      \n      await createMeeting.mutateAsync({\n        title: newMeeting.title,\n        description: newMeeting.description || null,\n        scheduledFor: scheduledDateTime,\n        duration: newMeeting.duration,\n        location: newMeeting.location || null,\n        organizerId: currentUser?.id || null,\n        participants: participantEmails,\n        dealId: newMeeting.dealId || null,\n        status: 'scheduled',\n        videoPlatform: newMeeting.videoPlatform || null,\n        videoLink: newMeeting.videoLink || null,\n        localDate: newMeeting.scheduledFor,\n        localTime: newMeeting.scheduledTime,\n        organizerTimezone,\n      } as any);\n      \n      toast.success(\"Meeting scheduled! Notifications sent to participants.\");\n      setShowScheduleMeetingModal(false);\n      setNewMeeting({ title: '', description: '', scheduledFor: '', scheduledTime: '09:00', duration: 60, location: '', participants: '', dealId: '', videoPlatform: '', videoLink: '' });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to schedule meeting\");\n    }\n  };\n\n  const handleGenerateReport = async () => {\n    toast.info(\"Generating dashboard report...\");\n    \n    try {\n      const doc = new jsPDF();\n      const pageWidth = doc.internal.pageSize.getWidth();\n      const margin = 20;\n      let y = 20;\n      \n      // Colors\n      const primaryColor: [number, number, number] = [26, 26, 46];\n      const accentColor: [number, number, number] = [34, 197, 94];\n      const mutedColor: [number, number, number] = [100, 100, 120];\n      \n      // Header with gradient effect\n      doc.setFillColor(...primaryColor);\n      doc.rect(0, 0, pageWidth, 45, 'F');\n      \n      doc.setTextColor(255, 255, 255);\n      doc.setFontSize(24);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Kronos', margin, 25);\n      \n      doc.setFontSize(12);\n      doc.setFont('helvetica', 'normal');\n      doc.text('Dashboard Report', margin, 35);\n      \n      // Generated info\n      doc.setFontSize(9);\n      doc.text(`Generated: ${format(new Date(), 'PPpp')}`, pageWidth - margin - 60, 25);\n      doc.text(`By: ${currentUser?.name}`, pageWidth - margin - 60, 33);\n      \n      y = 60;\n      \n      // Executive Summary Section\n      doc.setTextColor(...primaryColor);\n      doc.setFontSize(14);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Executive Summary', margin, y);\n      \n      y += 10;\n      doc.setDrawColor(...primaryColor);\n      doc.setLineWidth(0.5);\n      doc.line(margin, y, pageWidth - margin, y);\n      y += 15;\n      \n      // Summary boxes\n      const boxWidth = (pageWidth - margin * 2 - 15) / 4;\n      const summaryData = [\n        { label: 'Active Deals', value: activeDeals.length.toString(), color: accentColor },\n        { label: 'Pipeline Value', value: `$${activeValue.toLocaleString()}M`, color: accentColor },\n        { label: 'Team Members', value: users.length.toString(), color: accentColor },\n        { label: 'Open Tasks', value: tasks.filter(t => t.status !== 'Completed').length.toString(), color: accentColor },\n      ];\n      \n      summaryData.forEach((item, i) => {\n        const x = margin + i * (boxWidth + 5);\n        doc.setFillColor(245, 245, 250);\n        doc.roundedRect(x, y, boxWidth, 25, 3, 3, 'F');\n        \n        doc.setTextColor(...primaryColor);\n        doc.setFontSize(16);\n        doc.setFont('helvetica', 'bold');\n        doc.text(item.value, x + boxWidth / 2, y + 12, { align: 'center' });\n        \n        doc.setTextColor(...mutedColor);\n        doc.setFontSize(8);\n        doc.setFont('helvetica', 'normal');\n        doc.text(item.label, x + boxWidth / 2, y + 20, { align: 'center' });\n      });\n      \n      y += 40;\n      \n      // Deal Analytics by Sector\n      doc.setTextColor(...primaryColor);\n      doc.setFontSize(14);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Deal Analytics by Sector', margin, y);\n      y += 8;\n      doc.line(margin, y, pageWidth - margin, y);\n      y += 10;\n      \n      doc.setFontSize(10);\n      Object.entries(sectorStats).forEach(([sector, stats]) => {\n        doc.setTextColor(...mutedColor);\n        doc.setFont('helvetica', 'normal');\n        doc.text(sector, margin, y);\n        \n        doc.setTextColor(...primaryColor);\n        doc.text(`${stats.count} deals`, margin + 80, y);\n        \n        doc.setTextColor(...accentColor);\n        doc.setFont('helvetica', 'bold');\n        doc.text(`$${stats.value.toLocaleString()}M`, margin + 120, y);\n        y += 8;\n      });\n      \n      y += 10;\n      \n      // Pipeline by Stage\n      doc.setTextColor(...primaryColor);\n      doc.setFontSize(14);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Pipeline by Stage', margin, y);\n      y += 8;\n      doc.line(margin, y, pageWidth - margin, y);\n      y += 10;\n      \n      doc.setFontSize(10);\n      ibStageStats.forEach((s) => {\n        doc.setTextColor(...mutedColor);\n        doc.setFont('helvetica', 'normal');\n        doc.text(s.stage, margin, y);\n        \n        doc.setTextColor(...primaryColor);\n        doc.setFont('helvetica', 'bold');\n        doc.text(`${s.count} deals`, margin + 80, y);\n        y += 8;\n      });\n      \n      y += 10;\n      \n      // Check if we need a new page\n      if (y > 220) {\n        doc.addPage();\n        y = 20;\n      }\n      \n      // Top Performers\n      doc.setTextColor(...primaryColor);\n      doc.setFontSize(14);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Top Performers', margin, y);\n      y += 8;\n      doc.line(margin, y, pageWidth - margin, y);\n      y += 10;\n      \n      doc.setFontSize(10);\n      topUsers.slice(0, 5).forEach((u, i) => {\n        const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : `#${i + 1}`;\n        doc.setTextColor(...primaryColor);\n        doc.setFont('helvetica', 'bold');\n        doc.text(`${medal} ${u.name}`, margin, y);\n        \n        doc.setTextColor(...mutedColor);\n        doc.setFont('helvetica', 'normal');\n        doc.text(`(${u.role})`, margin + 50, y);\n        \n        doc.setTextColor(...accentColor);\n        doc.text(`Score: ${u.velocityScore}`, margin + 100, y);\n        \n        doc.setTextColor(...primaryColor);\n        doc.text(`${u.completedTasks} tasks completed`, margin + 140, y);\n        y += 8;\n      });\n      \n      y += 10;\n      \n      // Market Conditions\n      if (marketData.length > 0) {\n        doc.setTextColor(...primaryColor);\n        doc.setFontSize(14);\n        doc.setFont('helvetica', 'bold');\n        doc.text('Market Conditions', margin, y);\n        y += 8;\n        doc.line(margin, y, pageWidth - margin, y);\n        y += 10;\n        \n        doc.setFontSize(10);\n        marketData.forEach((m) => {\n          doc.setTextColor(...mutedColor);\n          doc.setFont('helvetica', 'normal');\n          doc.text(m.name, margin, y);\n          \n          doc.setTextColor(...primaryColor);\n          doc.setFont('helvetica', 'bold');\n          doc.text(m.value, margin + 60, y);\n          \n          const changeColor: [number, number, number] = m.trend === 'up' ? [34, 197, 94] : [239, 68, 68];\n          doc.setTextColor(...changeColor);\n          doc.text(m.change, margin + 110, y);\n          y += 8;\n        });\n      }\n      \n      // Footer\n      const footerY = doc.internal.pageSize.getHeight() - 15;\n      doc.setTextColor(...mutedColor);\n      doc.setFontSize(8);\n      doc.setFont('helvetica', 'normal');\n      doc.text('Kronos - Investment Banking Operations Platform', pageWidth / 2, footerY, { align: 'center' });\n      doc.text(`Page 1 of 1`, pageWidth - margin, footerY, { align: 'right' });\n      \n      // Save the PDF\n      doc.save(`kronos-dashboard-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`);\n      toast.success(\"Report downloaded successfully!\");\n    } catch (error) {\n      console.error('Failed to generate PDF:', error);\n      toast.error(\"Failed to generate report\");\n    }\n  };\n\n  const handleWidgetToggle = (widgetId: string) => {\n    setWidgets(prev => prev.map(w => \n      w.id === widgetId ? { ...w, enabled: !w.enabled } : w\n    ));\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      const files = Array.from(e.target.files);\n      setNewDeal(prev => ({ ...prev, attachments: [...prev.attachments, ...files] }));\n      toast.success(`${files.length} file(s) attached`);\n    }\n  };\n\n  const removeAttachment = (index: number) => {\n    setNewDeal(prev => ({\n      ...prev,\n      attachments: prev.attachments.filter((_, i) => i !== index)\n    }));\n  };\n\n  const openEmployeeDetail = (employee: any) => {\n    setSelectedEmployee(employee);\n    setShowEmployeeDetailModal(true);\n  };\n\n  // Analytics data preparation - separate IB and AM stage data\n  const ibDealsByStage = ibStageStats.map((s, i) => ({\n    ...s,\n    fill: `hsl(var(--chart-${(i % 5) + 1}))`,\n  }));\n  \n  const amDealsByStage = amStageStats.map((s, i) => ({\n    ...s,\n    fill: `hsl(var(--chart-${(i % 5) + 1}))`,\n  }));\n\n  const dealsBySector = Object.entries(sectorStats).map(([sector, stats], index) => ({\n    sector,\n    count: stats.count,\n    value: stats.value,\n    fill: `hsl(var(--chart-${(index % 5) + 1}))`,\n  }));\n  \n  const ibDealsBySector = Object.entries(ibSectorStats).map(([sector, stats], index) => ({\n    sector,\n    count: stats.count,\n    value: stats.value,\n    fill: `hsl(var(--chart-${(index % 5) + 1}))`,\n  }));\n  \n  const amDealsBySector = Object.entries(amSectorStats).map(([sector, stats], index) => ({\n    sector,\n    count: stats.count,\n    value: stats.value,\n    fill: `hsl(var(--chart-${(index % 5) + 1}))`,\n  }));\n\n  const taskCompletion = useMemo(() => {\n    const completed = tasks.filter(t => t.status === 'Completed').length;\n    const inProgress = tasks.filter(t => t.status === 'In Progress').length;\n    const pending = tasks.filter(t => t.status === 'Pending').length;\n    return [\n      { status: 'Completed', count: completed, fill: 'hsl(var(--chart-3))' },\n      { status: 'In Progress', count: inProgress, fill: 'hsl(var(--chart-2))' },\n      { status: 'Pending', count: pending, fill: 'hsl(var(--chart-1))' },\n    ];\n  }, [tasks]);\n\n  const weeklyDeals = useMemo(() => {\n    return Array.from({ length: 7 }, (_, i) => {\n      const date = subDays(new Date(), 6 - i);\n      const dayStr = format(date, 'EEE');\n      const dateStr = format(date, 'yyyy-MM-dd');\n      \n      // Filter deals by creation date AND division - only count deals with valid createdAt (excluding opportunities)\n      const ibDealsOnDay = nonOpportunityDeals.filter(d => {\n        if (!d.createdAt) return false;\n        const dealDate = new Date(d.createdAt);\n        return format(dealDate, 'yyyy-MM-dd') === dateStr && d.dealType !== 'Asset Management';\n      });\n      const amDealsOnDay = nonOpportunityDeals.filter(d => {\n        if (!d.createdAt) return false;\n        const dealDate = new Date(d.createdAt);\n        return format(dealDate, 'yyyy-MM-dd') === dateStr && d.dealType === 'Asset Management';\n      });\n      \n      return { \n        day: dayStr, \n        ib: ibDealsOnDay.length,\n        am: amDealsOnDay.length,\n        ibValue: ibDealsOnDay.reduce((sum, d) => sum + d.value, 0),\n        amValue: amDealsOnDay.reduce((sum, d) => sum + d.value, 0),\n        total: ibDealsOnDay.length + amDealsOnDay.length\n      };\n    });\n  }, [nonOpportunityDeals]);\n\n  const topPerformers = useMemo(() => {\n    return employeeStats\n      .sort((a, b) => (b.score || 0) - (a.score || 0))\n      .slice(0, 5)\n      .map(e => ({\n        name: e.name.split(' ')[0],\n        score: e.score || 0,\n        tasks: e.completedTasks,\n      }));\n  }, [employeeStats]);\n\n  const chartConfig = {\n    count: { label: 'Count', color: 'hsl(var(--chart-1))' },\n    value: { label: 'Value (M)', color: 'hsl(var(--chart-2))' },\n    deals: { label: 'Deals', color: 'hsl(var(--chart-3))' },\n    score: { label: 'Score', color: 'hsl(var(--chart-4))' },\n    tasks: { label: 'Tasks', color: 'hsl(var(--chart-5))' },\n  };\n\n  const renderAnalyticsView = () => (\n    <div className=\"space-y-6\">\n      {/* Key Metrics */}\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4\">\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-3 md:p-4\">\n            <div className=\"flex items-center gap-2 md:gap-3\">\n              <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                <DollarSign className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-[10px] md:text-xs text-muted-foreground uppercase truncate\">Total Pipeline</p>\n                <p className=\"text-2xl font-bold\">${totalValue.toLocaleString()}M</p>\n                <div className=\"flex gap-2 mt-1 text-[10px]\">\n                  <span className=\"text-blue-400\">IB: ${ibDeals.reduce((s, d) => s + d.value, 0).toLocaleString()}M</span>\n                  <span className=\"text-emerald-400\">AM: ${amDeals.reduce((s, d) => s + d.value, 0).toLocaleString()}M</span>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center\">\n                <Briefcase className=\"w-5 h-5 text-green-500\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"text-xs text-muted-foreground uppercase\">Active Deals</p>\n                <p className=\"text-2xl font-bold\">{activeDeals.length}</p>\n                <div className=\"flex gap-2 mt-1 text-[10px]\">\n                  <span className=\"text-blue-400\">IB: {ibActiveDeals.length}</span>\n                  <span className=\"text-emerald-400\">AM: {amActiveDeals.length}</span>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                <Users className=\"w-5 h-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground uppercase\">Team Members</p>\n                <p className=\"text-2xl font-bold\">{users.length}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-yellow-500/10 flex items-center justify-center\">\n                <CheckSquare className=\"w-5 h-5 text-yellow-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground uppercase\">Task Completion</p>\n                <p className=\"text-2xl font-bold\">{tasks.length > 0 ? Math.round((taskCompletion[0].count / tasks.length) * 100) : 0}%</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Charts Row 1 - IB and AM Stage Pipelines */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* IB Deal Pipeline by Stage */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5 text-blue-500\" />\n              Investment Banking Pipeline\n            </CardTitle>\n            <CardDescription>{ibActiveDeals.length} active deals across {IB_STAGES.length} stages</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ChartContainer config={chartConfig} className=\"h-[200px] w-full\">\n              <BarChart data={ibDealsByStage} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                <XAxis dataKey=\"stage\" stroke=\"hsl(var(--muted-foreground))\" fontSize={9} angle={-20} textAnchor=\"end\" height={50} />\n                <YAxis stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <ChartTooltip content={<ChartTooltipContent />} />\n                <Bar dataKey=\"count\" radius={[4, 4, 0, 0]} fill=\"hsl(217, 91%, 60%)\">\n                  {ibDealsByStage.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={`hsl(217, 91%, ${60 - index * 5}%)`} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ChartContainer>\n          </CardContent>\n        </Card>\n\n        {/* AM Deal Pipeline by Stage */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5 text-emerald-500\" />\n              Asset Management Pipeline\n            </CardTitle>\n            <CardDescription>{amActiveDeals.length} active deals across {AM_STAGES.length} stages</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ChartContainer config={chartConfig} className=\"h-[200px] w-full\">\n              <BarChart data={amDealsByStage} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                <XAxis dataKey=\"stage\" stroke=\"hsl(var(--muted-foreground))\" fontSize={9} angle={-20} textAnchor=\"end\" height={50} />\n                <YAxis stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <ChartTooltip content={<ChartTooltipContent />} />\n                <Bar dataKey=\"count\" radius={[4, 4, 0, 0]} fill=\"hsl(160, 84%, 39%)\">\n                  {amDealsByStage.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={`hsl(160, 84%, ${45 - index * 4}%)`} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ChartContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Deals by Sector Row */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n\n        {/* IB Deals by Sector */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <PieChart className=\"w-5 h-5 text-blue-500\" />\n              IB Deals by Sector\n            </CardTitle>\n            <CardDescription>Investment Banking sector breakdown ({ibActiveDeals.length} active deals, ${ibActiveValue.toLocaleString()}M)</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-col lg:flex-row items-center gap-4\">\n              <ChartContainer config={chartConfig} className=\"h-[180px] w-full lg:w-1/2\">\n                <RechartsPieChart>\n                  <Pie\n                    data={ibDealsBySector}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={50}\n                    outerRadius={75}\n                    paddingAngle={2}\n                    dataKey=\"count\"\n                    nameKey=\"sector\"\n                  >\n                    {ibDealsBySector.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={`hsl(217, 91%, ${60 - index * 8}%)`} />\n                    ))}\n                  </Pie>\n                  <ChartTooltip content={<ChartTooltipContent />} />\n                </RechartsPieChart>\n              </ChartContainer>\n              <div className=\"flex-1 grid grid-cols-2 gap-2 w-full lg:w-1/2\">\n                {ibDealsBySector.filter(s => s.count > 0).map((entry, index) => (\n                  <div key={entry.sector} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div \n                      className=\"w-3 h-3 rounded-full flex-shrink-0\" \n                      style={{ backgroundColor: `hsl(217, 91%, ${60 - index * 8}%)` }}\n                    />\n                    <div className=\"min-w-0 flex-1\">\n                      <div className=\"text-xs font-medium truncate\">{entry.sector}</div>\n                      <div className=\"text-sm font-bold text-blue-400\">{entry.count} deals</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* AM Deals by Sector */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <PieChart className=\"w-5 h-5 text-emerald-500\" />\n              AM Deals by Sector\n            </CardTitle>\n            <CardDescription>Asset Management sector breakdown ({amActiveDeals.length} active deals, ${amActiveValue.toLocaleString()}M)</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-col lg:flex-row items-center gap-4\">\n              <ChartContainer config={chartConfig} className=\"h-[180px] w-full lg:w-1/2\">\n                <RechartsPieChart>\n                  <Pie\n                    data={amDealsBySector}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={50}\n                    outerRadius={75}\n                    paddingAngle={2}\n                    dataKey=\"count\"\n                    nameKey=\"sector\"\n                  >\n                    {amDealsBySector.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={`hsl(160, 84%, ${50 - index * 8}%)`} />\n                    ))}\n                  </Pie>\n                  <ChartTooltip content={<ChartTooltipContent />} />\n                </RechartsPieChart>\n              </ChartContainer>\n              <div className=\"flex-1 grid grid-cols-2 gap-2 w-full lg:w-1/2\">\n                {amDealsBySector.filter(s => s.count > 0).map((entry, index) => (\n                  <div key={entry.sector} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div \n                      className=\"w-3 h-3 rounded-full flex-shrink-0\" \n                      style={{ backgroundColor: `hsl(160, 84%, ${50 - index * 8}%)` }}\n                    />\n                    <div className=\"min-w-0 flex-1\">\n                      <div className=\"text-xs font-medium truncate\">{entry.sector}</div>\n                      <div className=\"text-sm font-bold text-emerald-400\">{entry.count} deals</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Division Distribution */}\n      <Card className=\"bg-card border-border\">\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Briefcase className=\"w-5 h-5 text-primary\" />\n            Division Distribution\n          </CardTitle>\n          <CardDescription>Active deals split by Investment Banking and Asset Management</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 gap-6\">\n            <div className=\"text-center p-6 bg-blue-500/10 rounded-xl border border-blue-500/20\">\n              <div className=\"text-4xl font-bold text-blue-400\">{ibActiveDeals.length}</div>\n              <div className=\"text-sm text-muted-foreground mt-1\">Investment Banking</div>\n              <div className=\"text-lg font-semibold text-blue-300 mt-2\">${ibActiveValue.toLocaleString()}M</div>\n            </div>\n            <div className=\"text-center p-6 bg-emerald-500/10 rounded-xl border border-emerald-500/20\">\n              <div className=\"text-4xl font-bold text-emerald-400\">{amActiveDeals.length}</div>\n              <div className=\"text-sm text-muted-foreground mt-1\">Asset Management</div>\n              <div className=\"text-lg font-semibold text-emerald-300 mt-2\">${amActiveValue.toLocaleString()}M</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Charts Row 2 - Weekly Deal Activity by Division */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Weekly Activity - Split by Division */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Activity className=\"w-5 h-5 text-primary\" />\n              Weekly Deal Activity\n            </CardTitle>\n            <CardDescription>Deal activity by division over the last 7 days</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {/* Legend */}\n              <div className=\"flex gap-4 justify-center text-xs\">\n                <div className=\"flex items-center gap-1\">\n                  <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                  <span>Investment Banking</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                  <span>Asset Management</span>\n                </div>\n              </div>\n              <ChartContainer config={{...chartConfig, ib: { label: 'IB Deals', color: 'hsl(217, 91%, 60%)' }, am: { label: 'AM Deals', color: 'hsl(160, 84%, 39%)' }}} className=\"h-[180px] w-full\">\n                <AreaChart data={weeklyDeals} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\n                  <defs>\n                    <linearGradient id=\"colorIB\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"5%\" stopColor=\"hsl(217, 91%, 60%)\" stopOpacity={0.3}/>\n                      <stop offset=\"95%\" stopColor=\"hsl(217, 91%, 60%)\" stopOpacity={0}/>\n                    </linearGradient>\n                    <linearGradient id=\"colorAM\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"5%\" stopColor=\"hsl(160, 84%, 39%)\" stopOpacity={0.3}/>\n                      <stop offset=\"95%\" stopColor=\"hsl(160, 84%, 39%)\" stopOpacity={0}/>\n                    </linearGradient>\n                  </defs>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"day\" stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                  <ChartTooltip content={<ChartTooltipContent />} />\n                  <Area type=\"monotone\" dataKey=\"ib\" stroke=\"hsl(217, 91%, 60%)\" fillOpacity={1} fill=\"url(#colorIB)\" stackId=\"1\" />\n                  <Area type=\"monotone\" dataKey=\"am\" stroke=\"hsl(160, 84%, 39%)\" fillOpacity={1} fill=\"url(#colorAM)\" stackId=\"1\" />\n                </AreaChart>\n              </ChartContainer>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Task Completion Status - Split by Division */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <CheckSquare className=\"w-5 h-5 text-primary\" />\n              Task Status Overview\n            </CardTitle>\n            <CardDescription>Task status by division</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {/* IB Tasks */}\n              <div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                  <span className=\"text-sm font-medium text-blue-400\">Investment Banking</span>\n                </div>\n                <div className=\"grid grid-cols-4 gap-2 pl-5\">\n                  {(() => {\n                    const ibTasks = tasks.filter((t: Task) => {\n                      const deal = deals.find(d => d.id === t.dealId);\n                      return !deal || deal.dealType !== 'Asset Management';\n                    });\n                    return [\n                      { label: 'Pending', count: ibTasks.filter((t: Task) => t.status === 'Pending').length, color: 'text-yellow-400' },\n                      { label: 'Active', count: ibTasks.filter((t: Task) => t.status === 'In Progress').length, color: 'text-blue-400' },\n                      { label: 'Done', count: ibTasks.filter((t: Task) => t.status === 'Completed').length, color: 'text-green-400' },\n                      { label: 'Blocked', count: ibTasks.filter((t: Task) => t.status === 'Blocked').length, color: 'text-red-400' },\n                    ].map(s => (\n                      <div key={s.label} className=\"p-2 bg-blue-500/5 border border-blue-500/10 rounded text-center\">\n                        <div className={`text-lg font-bold ${s.color}`}>{s.count}</div>\n                        <div className=\"text-[10px] text-muted-foreground\">{s.label}</div>\n                      </div>\n                    ));\n                  })()}\n                </div>\n              </div>\n              \n              {/* AM Tasks */}\n              <div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                  <span className=\"text-sm font-medium text-emerald-400\">Asset Management</span>\n                </div>\n                <div className=\"grid grid-cols-4 gap-2 pl-5\">\n                  {(() => {\n                    const amTasks = tasks.filter((t: Task) => {\n                      const deal = deals.find(d => d.id === t.dealId);\n                      return deal && deal.dealType === 'Asset Management';\n                    });\n                    return [\n                      { label: 'Pending', count: amTasks.filter((t: Task) => t.status === 'Pending').length, color: 'text-yellow-400' },\n                      { label: 'Active', count: amTasks.filter((t: Task) => t.status === 'In Progress').length, color: 'text-emerald-400' },\n                      { label: 'Done', count: amTasks.filter((t: Task) => t.status === 'Completed').length, color: 'text-green-400' },\n                      { label: 'Blocked', count: amTasks.filter((t: Task) => t.status === 'Blocked').length, color: 'text-red-400' },\n                    ].map(s => (\n                      <div key={s.label} className=\"p-2 bg-emerald-500/5 border border-emerald-500/10 rounded text-center\">\n                        <div className={`text-lg font-bold ${s.color}`}>{s.count}</div>\n                        <div className=\"text-[10px] text-muted-foreground\">{s.label}</div>\n                      </div>\n                    ));\n                  })()}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Top Performers */}\n      <Card className=\"bg-card border-border\">\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Zap className=\"w-5 h-5 text-primary\" />\n            Top Performers\n          </CardTitle>\n          <CardDescription>Team members with highest velocity scores</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <ChartContainer config={chartConfig} className=\"h-[200px] w-full\">\n            <BarChart data={topPerformers} margin={{ top: 10, right: 30, left: 40, bottom: 0 }}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n              <XAxis dataKey=\"name\" stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n              <YAxis stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n              <ChartTooltip content={<ChartTooltipContent />} />\n              <Bar dataKey=\"score\" fill=\"hsl(var(--chart-4))\" radius={[4, 4, 0, 0]} />\n            </BarChart>\n          </ChartContainer>\n        </CardContent>\n      </Card>\n    </div>\n  );\n\n  if (usersLoading || dealsLoading || tasksLoading) {\n    return (\n      <Layout role=\"CEO\" pageTitle=\"Dashboard\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading dashboard...</div>\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Dashboard\" userName={currentUser?.name || \"\"}>\n      {/* View Tabs */}\n      <Tabs value={viewTab} onValueChange={(v) => setViewTab(v as 'dashboard' | 'analytics')} className=\"w-full space-y-6\">\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"dashboard\" className=\"gap-2\" data-testid=\"tab-dashboard\">\n            <LayoutDashboard className=\"w-4 h-4\" />\n            Dashboard\n          </TabsTrigger>\n          <TabsTrigger value=\"analytics\" className=\"gap-2\" data-testid=\"tab-analytics\">\n            <BarChart3 className=\"w-4 h-4\" />\n            Analytics\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"dashboard\" className=\"mt-0\">\n          <div className=\"grid grid-cols-12 gap-6\">\n            \n            {/* Left Column: Quick Actions & Active Deals Analytics */}\n            <div className=\"col-span-12 md:col-span-3 space-y-6\">\n          {widgets.find(w => w.id === 'quickActions')?.enabled && (\n              <Card className=\"bg-card border-border\">\n                <CardHeader>\n                  <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Quick Actions</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2\">\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full justify-start gap-2 bg-secondary/50 hover:bg-primary/10 hover:text-primary border-transparent hover:border-primary/20 transition-all\"\n                    onClick={() => isAssetManagementHead ? setLocation('/ceo/asset-management') : setShowNewDealModal(true)}\n                    data-testid=\"button-new-deal\"\n                  >\n                    <Plus className=\"w-4 h-4\" /> {isAssetManagementHead ? 'New AM Deal' : 'New Deal'}\n                  </Button>\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full justify-start gap-2 bg-secondary/50 hover:bg-primary/10 hover:text-primary border-transparent hover:border-primary/20 transition-all\"\n                    onClick={handleGenerateReport}\n                    data-testid=\"button-generate-report\"\n                  >\n                    <FileText className=\"w-4 h-4\" /> Generate Report\n                  </Button>\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full justify-start gap-2 bg-secondary/50 hover:bg-primary/10 hover:text-primary border-transparent hover:border-primary/20 transition-all\"\n                    onClick={() => setLocation('/ceo/team')}\n                    data-testid=\"button-assign-team\"\n                  >\n                    <Users className=\"w-4 h-4\" /> Assign Team\n                  </Button>\n                  <Button \n                    variant=\"outline\" \n                    className=\"w-full justify-start gap-2 bg-secondary/50 hover:bg-primary/10 hover:text-primary border-transparent hover:border-primary/20 transition-all\"\n                    onClick={() => setShowScheduleMeetingModal(true)}\n                    data-testid=\"button-schedule-meeting\"\n                  >\n                    <Calendar className=\"w-4 h-4\" /> Schedule Meeting\n                  </Button>\n                </CardContent>\n              </Card>\n          )}\n\n          {widgets.find(w => w.id === 'activeDeals')?.enabled && (\n              <Card \n                className=\"bg-card border-border overflow-hidden cursor-pointer hover:border-primary/50 transition-colors\"\n                onClick={() => setActiveDealsModalOpen(true)}\n                data-testid=\"card-active-deals\"\n              >\n                <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider truncate\">\n                    Active Deals\n                  </CardTitle>\n                  <div className=\"flex items-center gap-1\">\n                    <div className=\"flex rounded-md overflow-hidden border border-border\" onClick={(e) => e.stopPropagation()}>\n                      <Button \n                        variant={activeDealsFilter === 'IB' ? 'default' : 'ghost'} \n                        size=\"sm\" \n                        className=\"h-6 px-2 rounded-none text-[10px]\"\n                        onClick={(e) => { e.stopPropagation(); setActiveDealsFilter(activeDealsFilter === 'IB' ? 'all' : 'IB'); }}\n                      >\n                        IB\n                      </Button>\n                      <Button \n                        variant={activeDealsFilter === 'AM' ? 'default' : 'ghost'} \n                        size=\"sm\" \n                        className=\"h-6 px-2 rounded-none text-[10px]\"\n                        onClick={(e) => { e.stopPropagation(); setActiveDealsFilter(activeDealsFilter === 'AM' ? 'all' : 'AM'); }}\n                      >\n                        AM\n                      </Button>\n                    </div>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-6 w-6 flex-shrink-0\" \n                      onClick={(e) => { e.stopPropagation(); setLocation(activeDealsFilter === 'AM' ? '/ceo/asset-management' : '/ceo/deals'); }}\n                    >\n                      <ArrowUpRight className=\"w-4 h-4 text-muted-foreground\" />\n                    </Button>\n                  </div>\n                </CardHeader>\n              <CardContent className=\"space-y-4 overflow-hidden\">\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <div className=\"bg-secondary/30 rounded-lg p-2 text-center overflow-hidden\">\n                    <div className=\"text-xl font-bold text-primary truncate\">\n                      {activeDealsFilter === 'IB' ? ibActiveDeals.length : activeDealsFilter === 'AM' ? amActiveDeals.length : displayActiveDeals.length}\n                    </div>\n                    <div className=\"text-[9px] text-muted-foreground uppercase truncate\">Active</div>\n                  </div>\n                  <div className=\"bg-secondary/30 rounded-lg p-2 text-center overflow-hidden\">\n                    <div className=\"text-xl font-bold text-green-400 truncate\">\n                      ${(activeDealsFilter === 'IB' ? ibActiveValue : activeDealsFilter === 'AM' ? amActiveValue : displayActiveValue).toLocaleString()}M\n                    </div>\n                    <div className=\"text-[9px] text-muted-foreground uppercase truncate\">Value</div>\n                  </div>\n                </div>\n\n                <Separator className=\"bg-border/50\" />\n                \n                <div className=\"overflow-hidden\">\n                  <div className=\"text-xs font-medium text-muted-foreground mb-2 flex items-center gap-1\">\n                    <PieChart className=\"w-3 h-3 flex-shrink-0\" /> <span className=\"truncate\">By Sector</span>\n                  </div>\n                  <div className=\"space-y-1.5 max-h-24 overflow-y-auto\">\n                    {Object.entries(activeDealsFilter === 'IB' ? ibSectorStats : activeDealsFilter === 'AM' ? amSectorStats : sectorStats).map(([sector, stats]) => (\n                      <div key={sector} className=\"flex items-center justify-between text-xs gap-1\">\n                        <span className=\"text-muted-foreground truncate flex-1 min-w-0\">{sector}</span>\n                        <div className=\"flex items-center gap-1 flex-shrink-0\">\n                          <Badge variant=\"secondary\" className=\"text-[9px] px-1\">{stats.count}</Badge>\n                          <span className=\"text-green-400 font-mono text-[10px]\">${stats.value}M</span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <Separator className=\"bg-border/50\" />\n                \n                <div className=\"overflow-hidden\">\n                  <div className=\"text-xs font-medium text-muted-foreground mb-2 flex items-center gap-1\">\n                    <BarChart3 className=\"w-3 h-3 flex-shrink-0\" /> <span className=\"truncate\">{activeDealsFilter === 'AM' ? 'AM Stages' : 'IB Stages'}</span>\n                  </div>\n                  <div className=\"space-y-1 max-h-24 overflow-y-auto\">\n                    {(activeDealsFilter === 'AM' ? amStageStats : ibStageStats).map(({ stage, count }: { stage: string; count: number }) => {\n                      const totalDeals = activeDealsFilter === 'AM' ? amActiveDeals.length : ibActiveDeals.length;\n                      return (\n                        <div key={stage} className=\"flex items-center gap-1\">\n                          <span className=\"text-[9px] text-muted-foreground w-16 truncate flex-shrink-0\">{stage}</span>\n                          <div className=\"flex-1 h-1.5 bg-secondary rounded-full overflow-hidden min-w-0\">\n                            <div \n                              className={cn(\"h-full rounded-full transition-all\", activeDealsFilter === 'AM' ? \"bg-emerald-500/60\" : \"bg-blue-500/60\")}\n                              style={{ width: `${totalDeals > 0 ? (count / totalDeals) * 100 : 0}%` }}\n                            />\n                          </div>\n                          <span className=\"text-[10px] font-mono w-4 text-right flex-shrink-0\">{count}</span>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              </CardContent>\n              </Card>\n          )}\n          \n          {widgets.find(w => w.id === 'marketPulse')?.enabled && (\n            <Card className=\"bg-card border-border\">\n               <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Market Pulse</CardTitle>\n                <div className=\"flex items-center gap-2\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    className=\"h-6 w-6 p-0\"\n                    onClick={() => setShowMarketSearch(!showMarketSearch)}\n                    data-testid=\"button-market-search-toggle\"\n                  >\n                    <Search className=\"w-3.5 h-3.5\" />\n                  </Button>\n                  <Badge variant={marketSource === 'live' ? 'default' : 'secondary'} className=\"text-[9px] px-1.5 py-0\">\n                    {marketSource === 'live' ? 'Live' : 'Demo'}\n                  </Badge>\n                  <div className={cn(\"w-2 h-2 rounded-full animate-pulse\", marketSource === 'live' ? \"bg-green-500\" : \"bg-yellow-500\")}></div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {showMarketSearch && (\n                  <div className=\"space-y-2 pb-2 border-b border-border/50\">\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search stock, index, or asset...\"\n                        value={marketSearchQuery}\n                        onChange={(e) => setMarketSearchQuery(e.target.value.toUpperCase())}\n                        className=\"h-8 pl-8 text-xs\"\n                        data-testid=\"input-market-search\"\n                      />\n                    </div>\n                    {marketSearchQuery && (\n                      <div className=\"space-y-1\">\n                        {[\n                          { symbol: marketSearchQuery, name: `Add ${marketSearchQuery}` },\n                          ...([\n                            { symbol: 'AAPL', name: 'Apple Inc.' },\n                            { symbol: 'GOOGL', name: 'Alphabet Inc.' },\n                            { symbol: 'MSFT', name: 'Microsoft Corp.' },\n                            { symbol: 'AMZN', name: 'Amazon.com Inc.' },\n                            { symbol: 'TSLA', name: 'Tesla Inc.' },\n                            { symbol: 'SPY', name: 'S&P 500 ETF' },\n                            { symbol: 'NVDA', name: 'NVIDIA Corp.' },\n                            { symbol: 'META', name: 'Meta Platforms' },\n                            { symbol: 'JPM', name: 'JPMorgan Chase' },\n                            { symbol: 'V', name: 'Visa Inc.' },\n                            { symbol: 'QQQ', name: 'Nasdaq 100 ETF' },\n                            { symbol: 'DIA', name: 'Dow Jones ETF' },\n                            { symbol: 'GS', name: 'Goldman Sachs' },\n                            { symbol: 'MS', name: 'Morgan Stanley' },\n                          ].filter(s => \n                            s.symbol.includes(marketSearchQuery) || \n                            s.name.toUpperCase().includes(marketSearchQuery)\n                          ))\n                        ].slice(0, 5).map((item) => (\n                          <div \n                            key={item.symbol} \n                            className={cn(\n                              \"flex items-center justify-between p-2 rounded text-xs cursor-pointer transition-colors\",\n                              marketSymbols.includes(item.symbol) \n                                ? \"bg-primary/10 text-primary\" \n                                : \"bg-secondary/30 hover:bg-secondary/50\"\n                            )}\n                            onClick={() => {\n                              if (marketSymbols.includes(item.symbol)) {\n                                setMarketSymbols(prev => prev.filter(s => s !== item.symbol));\n                                toast.success(`Removed ${item.symbol} from watchlist`);\n                              } else {\n                                setMarketSymbols(prev => [...prev, item.symbol]);\n                                toast.success(`Added ${item.symbol} to watchlist`);\n                              }\n                              setMarketSearchQuery('');\n                            }}\n                            data-testid={`market-search-result-${item.symbol}`}\n                          >\n                            <div>\n                              <span className=\"font-mono font-bold\">{item.symbol}</span>\n                              <span className=\"text-muted-foreground ml-2\">{item.name}</span>\n                            </div>\n                            {marketSymbols.includes(item.symbol) ? (\n                              <X className=\"w-3 h-3 text-red-400\" />\n                            ) : (\n                              <Plus className=\"w-3 h-3 text-green-400\" />\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    {!marketSearchQuery && marketSymbols.length > 0 && (\n                      <div className=\"flex flex-wrap gap-1\">\n                        {marketSymbols.map(symbol => (\n                          <Badge \n                            key={symbol} \n                            variant=\"secondary\" \n                            className=\"text-[10px] cursor-pointer hover:bg-destructive/20 hover:text-destructive transition-colors\"\n                            onClick={() => {\n                              setMarketSymbols(prev => prev.filter(s => s !== symbol));\n                              toast.success(`Removed ${symbol} from watchlist`);\n                            }}\n                            data-testid={`market-symbol-badge-${symbol}`}\n                          >\n                            {symbol} <X className=\"w-2.5 h-2.5 ml-1\" />\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n                {marketLoading ? (\n                  <div className=\"text-center py-4 text-muted-foreground text-sm\">Loading market data...</div>\n                ) : (\n                  marketData\n                    .filter(metric => marketSymbols.includes(metric.symbol))\n                    .map((metric) => (\n                    <div key={metric.symbol} className=\"flex items-center justify-between hover:bg-secondary/30 p-2 rounded -mx-2 transition-colors group\">\n                      <div className=\"min-w-0 flex-1\">\n                        <div className=\"text-sm font-medium truncate\">{metric.name}</div>\n                        <div className=\"text-[10px] text-muted-foreground truncate\">{metric.description}</div>\n                      </div>\n                      <div className=\"text-right flex-shrink-0 ml-2 flex items-center gap-2\">\n                        <div>\n                          <div className=\"text-sm font-bold\">{metric.value}</div>\n                          <div className={cn(\"text-xs flex items-center gap-1 justify-end\", metric.trend === 'up' ? \"text-green-400\" : \"text-red-400\")}>\n                            {metric.trend === 'up' ? <TrendingUp className=\"w-3 h-3\" /> : <TrendingDown className=\"w-3 h-3\" />}\n                            {metric.change}\n                          </div>\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"h-5 w-5 p-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n                          onClick={() => {\n                            setMarketSymbols(prev => prev.filter(s => s !== metric.symbol));\n                            toast.success(`Removed ${metric.symbol} from watchlist`);\n                          }}\n                          data-testid={`button-remove-market-${metric.symbol}`}\n                        >\n                          <X className=\"w-3 h-3 text-muted-foreground hover:text-destructive\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))\n                )}\n                {!marketLoading && marketData.filter(metric => marketSymbols.includes(metric.symbol)).length === 0 && (\n                  <div className=\"text-center py-4 text-muted-foreground text-xs\">\n                    No symbols tracked. Click the search icon to add stocks.\n                  </div>\n                )}\n                <div className=\"text-[10px] text-muted-foreground text-center pt-2 border-t border-border/50\">\n                  {marketSource === 'simulated' && <span className=\"text-yellow-500\">Add FINNHUB_API_KEY for live data  </span>}\n                  Updated: {format(new Date(), 'HH:mm:ss')}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n        </div>\n\n        {/* Middle Column: Main Content */}\n        <div className=\"col-span-12 md:col-span-6 space-y-6\">\n          {/* Welcome Banner */}\n          <div className=\"bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl p-6 border border-primary/20\">\n            <p className=\"text-sm text-muted-foreground mb-1\">\n              {format(new Date(), 'EEEE, MMMM d, yyyy')}\n            </p>\n            <h1 className=\"text-3xl font-display font-bold\">\n              Welcome back, {currentUser?.name?.split(' ')[0]}!\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">Here's your personalized command center.</p>\n          </div>\n\n          {/* Team Task Progress */}\n          {widgets.find(w => w.id === 'teamTaskProgress')?.enabled && (\n            <Card className=\"bg-card border-border h-[500px] overflow-hidden flex flex-col\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2 border-b border-border/50\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Team Task Progress</CardTitle>\n                <div className=\"text-[10px] text-green-400 flex items-center gap-1\">\n                  <div className=\"w-1.5 h-1.5 rounded-full bg-green-400\"></div> Live\n                </div>\n              </CardHeader>\n              <CardContent className=\"p-0 flex-1 overflow-y-auto\">\n                {employeeStats.map((employee, index) => (\n                  <div \n                    key={employee.id} \n                    className=\"p-4 border-b border-border/50 hover:bg-secondary/30 transition-colors group cursor-pointer\"\n                    onClick={() => openEmployeeDetail(employee)}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className={cn(\n                          \"w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white\",\n                          index === 0 ? \"bg-primary\" : \"bg-secondary border border-border\"\n                        )}>\n                          {employee.name.split(' ').map((n: string) => n[0]).join('')}\n                        </div>\n                        <div>\n                          <h4 className=\"text-sm font-medium text-foreground group-hover:text-primary transition-colors flex items-center gap-1\">\n                            {employee.name}\n                            <ChevronRight className=\"w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity\" />\n                          </h4>\n                          <p className=\"text-xs text-muted-foreground\">{employee.jobTitle || employee.role}</p>\n                        </div>\n                      </div>\n                      <div className=\"text-xs font-medium text-muted-foreground\">\n                        {employee.totalTasks} tasks  {Object.keys(employee.tasksByDeal).length} deals\n                      </div>\n                    </div>\n                    \n                    <div className=\"pl-11\">\n                      <div className=\"flex items-center gap-4 text-[10px] text-muted-foreground\">\n                        <span className=\"flex items-center gap-1 text-green-400\">\n                          <CheckSquare className=\"w-3 h-3\" /> {employee.completedTasks} completed\n                        </span>\n                        <span className=\"flex items-center gap-1 text-yellow-400\">\n                          <Activity className=\"w-3 h-3\" /> {employee.inProgressTasks} in progress\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <Clock className=\"w-3 h-3\" /> {employee.pendingTasks} pending\n                        </span>\n                      </div>\n                      \n                      {/* Mini deal breakdown */}\n                      <div className=\"mt-2 flex flex-wrap gap-1\">\n                        {Object.entries(employee.tasksByDeal).slice(0, 3).map(([dealId, stats]) => (\n                          <Badge key={dealId} variant=\"secondary\" className=\"text-[9px] font-normal\">\n                            {stats.dealName}: {stats.completed}/{stats.completed + stats.inProgress + stats.pending}\n                          </Badge>\n                        ))}\n                        {Object.keys(employee.tasksByDeal).length > 3 && (\n                          <Badge variant=\"outline\" className=\"text-[9px] font-normal\">\n                            +{Object.keys(employee.tasksByDeal).length - 3} more\n                          </Badge>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Market Intelligence Widget - Moved to middle column */}\n          {widgets.find(w => w.id === 'marketIntelligence')?.enabled && (\n            <Card className=\"bg-card border-border\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Market Intelligence</CardTitle>\n                <div className=\"flex items-center gap-2\">\n                  <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0.5\">\n                    {newsSource === 'live' ? (\n                      <span className=\"text-green-400 flex items-center gap-1\">\n                        <div className=\"w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse\"></div> Live\n                      </span>\n                    ) : (\n                      <span className=\"text-yellow-400\">Sample</span>\n                    )}\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {newsLoading ? (\n                  <div className=\"text-center py-4 text-muted-foreground text-sm\">Loading news...</div>\n                ) : (\n                  <ScrollArea className=\"h-[250px]\">\n                    <div className=\"space-y-2 pr-3\">\n                      {marketNews.slice(0, 6).map((news) => (\n                        <a \n                          key={news.id}\n                          href={news.url !== '#' ? news.url : undefined}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"block p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 transition-colors group\"\n                        >\n                          <h4 className=\"text-sm font-medium line-clamp-2 group-hover:text-primary transition-colors\">\n                            {news.headline}\n                          </h4>\n                          <div className=\"flex items-center gap-2 mt-1.5\">\n                            <span className=\"text-xs text-muted-foreground\">{news.source}</span>\n                            <span className=\"text-xs text-muted-foreground\"></span>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {format(new Date(news.datetime), 'h:mm a')}\n                            </span>\n                          </div>\n                        </a>\n                      ))}\n                      {marketNews.length === 0 && (\n                        <div className=\"text-center py-4 text-muted-foreground text-xs\">\n                          No news available\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                )}\n              </CardContent>\n            </Card>\n          )}\n        </div>\n\n        {/* Right Column: Meetings & Activity Widgets */}\n        <div className=\"col-span-12 md:col-span-3 space-y-6\">\n          {/* Upcoming Meetings & Events Widget */}\n          {widgets.find(w => w.id === 'upcomingMeetings')?.enabled && (() => {\n            const today = startOfDay(new Date());\n            const upcomingEvents = calendarEvents\n              .filter(e => {\n                const eventDate = startOfDay(new Date(e.date));\n                return isAfter(eventDate, today) || isSameDay(eventDate, today);\n              })\n              .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n              .slice(0, 3);\n            const upcomingMeetings = meetings.slice(0, 3);\n            const hasItems = upcomingMeetings.length > 0 || upcomingEvents.length > 0;\n            \n            return (\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Upcoming</CardTitle>\n                  <Link href=\"/ceo/calendar\" className=\"hover:text-primary transition-colors\">\n                    <Calendar className=\"w-4 h-4 text-muted-foreground hover:text-primary cursor-pointer\" />\n                  </Link>\n                </CardHeader>\n                <CardContent className=\"space-y-2\">\n                  {!hasItems ? (\n                    <div className=\"text-center py-4 text-muted-foreground text-xs\">No upcoming meetings or events</div>\n                  ) : (\n                    <>\n                      {upcomingMeetings.map((meeting) => (\n                        <div key={meeting.id} className=\"p-2 bg-secondary/30 rounded-lg\">\n                          <div className=\"text-sm font-medium truncate\">{meeting.title}</div>\n                          <div className=\"text-[10px] text-muted-foreground flex items-center gap-1 mt-1\">\n                            <Clock className=\"w-3 h-3\" />\n                            {meeting.scheduledFor ? format(new Date(meeting.scheduledFor), 'MMM d, h:mm a') : 'TBD'}\n                          </div>\n                          {meeting.location && (\n                            <div className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\n                              <MapPin className=\"w-3 h-3\" />\n                              <span className=\"truncate\">{meeting.location}</span>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                      {upcomingEvents.map((event) => (\n                        <div key={event.id} className=\"p-2 bg-primary/10 rounded-lg border border-primary/20\">\n                          <div className=\"flex items-center gap-1\">\n                            <Badge variant=\"outline\" className=\"text-[8px] px-1 py-0\">Event</Badge>\n                            <span className=\"text-sm font-medium truncate\">{event.title}</span>\n                          </div>\n                          <div className=\"text-[10px] text-muted-foreground flex items-center gap-1 mt-1\">\n                            <Clock className=\"w-3 h-3\" />\n                            {event.time \n                              ? `${format(new Date(event.date + 'T00:00:00'), 'MMM d')}, ${event.time.replace(/^(\\d{1,2}):(\\d{2})$/, (_, h, m) => {\n                                  const hour = parseInt(h);\n                                  const ampm = hour >= 12 ? 'PM' : 'AM';\n                                  const displayHour = hour % 12 || 12;\n                                  return `${displayHour}:${m} ${ampm}`;\n                                })}`\n                              : format(new Date(event.date + 'T00:00:00'), 'MMM d')}\n                          </div>\n                          {event.investor && (\n                            <div className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\n                              <Users className=\"w-3 h-3\" />\n                              <span className=\"truncate\">{event.investor}</span>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                    </>\n                  )}\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    className=\"w-full text-xs text-muted-foreground hover:text-primary\"\n                    onClick={() => setShowScheduleMeetingModal(true)}\n                  >\n                    <Plus className=\"w-3 h-3 mr-1\" /> Schedule Meeting\n                  </Button>\n                </CardContent>\n              </Card>\n            );\n          })()}\n\n          {/* Recent Activity Widget */}\n          {widgets.find(w => w.id === 'recentActivity')?.enabled && (\n            <Card className=\"bg-card border-border\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Activity</CardTitle>\n                <Activity className=\"w-4 h-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                {notifications.length === 0 ? (\n                  <div className=\"text-center py-4 text-muted-foreground text-xs\">No recent activity</div>\n                ) : (\n                  notifications.slice(0, 4).map((notification) => (\n                    <div \n                      key={notification.id} \n                      className={cn(\n                        \"p-2 rounded-lg text-xs\",\n                        notification.read ? \"bg-secondary/20\" : \"bg-primary/10 border border-primary/20\"\n                      )}\n                    >\n                      <div className=\"flex items-start gap-2\">\n                        <div className={cn(\n                          \"w-1.5 h-1.5 rounded-full mt-1.5 flex-shrink-0\",\n                          notification.type === 'success' ? \"bg-green-500\" :\n                          notification.type === 'warning' ? \"bg-yellow-500\" :\n                          notification.type === 'alert' ? \"bg-red-500\" : \"bg-blue-500\"\n                        )} />\n                        <div className=\"min-w-0 flex-1\">\n                          <div className=\"font-medium truncate\">{notification.title}</div>\n                          <div className=\"text-muted-foreground text-[10px] truncate\">{notification.message}</div>\n                        </div>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Capital At Work Widget */}\n          {widgets.find(w => w.id === 'capitalAtWork')?.enabled && (\n            <Card \n              className=\"bg-card border-border overflow-hidden cursor-pointer hover:border-primary/50 transition-colors\"\n              onClick={() => setCapitalAtWorkModalOpen(true)}\n              data-testid=\"card-capital-at-work\"\n            >\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                  Capital At Work\n                </CardTitle>\n                <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n                  <div className=\"flex rounded-md overflow-hidden border border-border\">\n                    <Button \n                      variant={capitalAtWorkFilter === 'IB' ? 'default' : 'ghost'} \n                      size=\"sm\" \n                      className=\"h-6 px-2 rounded-none text-[10px]\"\n                      onClick={(e) => { e.stopPropagation(); setCapitalAtWorkFilter(capitalAtWorkFilter === 'IB' ? 'all' : 'IB'); }}\n                    >\n                      IB\n                    </Button>\n                    <Button \n                      variant={capitalAtWorkFilter === 'AM' ? 'default' : 'ghost'} \n                      size=\"sm\" \n                      className=\"h-6 px-2 rounded-none text-[10px]\"\n                      onClick={(e) => { e.stopPropagation(); setCapitalAtWorkFilter(capitalAtWorkFilter === 'AM' ? 'all' : 'AM'); }}\n                    >\n                      AM\n                    </Button>\n                  </div>\n                  <DollarSign className=\"w-4 h-4 text-primary\" />\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"text-center py-2\">\n                  <div className={cn(\"text-3xl font-bold\", capitalAtWorkFilter === 'AM' ? \"text-emerald-400\" : capitalAtWorkFilter === 'IB' ? \"text-blue-400\" : \"text-primary\")}>\n                    ${(capitalAtWorkFilter === 'IB' ? ibActiveValue : capitalAtWorkFilter === 'AM' ? amActiveValue : displayActiveValue).toLocaleString()}M\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {capitalAtWorkFilter === 'IB' ? 'IB' : capitalAtWorkFilter === 'AM' ? 'AM' : 'Total'} Active Deal Value\n                  </div>\n                </div>\n                <Separator className=\"bg-border/50\" />\n                <div className=\"grid grid-cols-3 gap-2 text-center\">\n                  <div>\n                    <div className=\"text-lg font-semibold text-green-400\">\n                      {capitalAtWorkFilter === 'IB' ? ibActiveDeals.length : capitalAtWorkFilter === 'AM' ? amActiveDeals.length : activeDeals.length}\n                    </div>\n                    <div className=\"text-[9px] text-muted-foreground uppercase\">Active</div>\n                  </div>\n                  <div>\n                    <div className=\"text-lg font-semibold text-yellow-400\">\n                      {capitalAtWorkFilter === 'IB' \n                        ? ibDeals.filter(d => d.status === 'On Hold').length \n                        : capitalAtWorkFilter === 'AM' \n                          ? amDeals.filter(d => d.status === 'On Hold').length \n                          : nonOpportunityDeals.filter(d => d.status === 'On Hold').length}\n                    </div>\n                    <div className=\"text-[9px] text-muted-foreground uppercase\">On Hold</div>\n                  </div>\n                  <div>\n                    <div className=\"text-lg font-semibold text-muted-foreground\">\n                      {capitalAtWorkFilter === 'IB' \n                        ? ibDeals.filter(d => d.status === 'Closed').length \n                        : capitalAtWorkFilter === 'AM' \n                          ? amDeals.filter(d => d.status === 'Closed').length \n                          : nonOpportunityDeals.filter(d => d.status === 'Closed').length}\n                    </div>\n                    <div className=\"text-[9px] text-muted-foreground uppercase\">Closed</div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Fee Summary Widget */}\n          {widgets.find(w => w.id === 'feeSummary')?.enabled && (\n            <Card \n              className=\"bg-card border-border overflow-hidden cursor-pointer hover:border-primary/50 transition-colors\"\n              onClick={() => setFeeSummaryModalOpen(true)}\n              data-testid=\"card-fee-summary\"\n            >\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                  Fee Summary\n                </CardTitle>\n                <Briefcase className=\"w-4 h-4 text-primary\" />\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {(() => {\n                  // Calculate fees for IB deals only\n                  const ibDealIds = new Set(ibDeals.map(d => d.id));\n                  const ibFees = allDealFees.filter(fee => ibDealIds.has(fee.dealId));\n                  \n                  const feesByType = ibFees.reduce((acc, fee) => {\n                    const type = fee.feeType || 'other';\n                    if (!acc[type]) acc[type] = { total: 0, count: 0 };\n                    if (fee.amount) {\n                      acc[type].total += fee.amount;\n                      acc[type].count++;\n                    }\n                    return acc;\n                  }, {} as Record<string, { total: number; count: number }>);\n                  \n                  const feeLabels: Record<string, string> = {\n                    engagement: 'Engagement Fees',\n                    monthly: 'Monthly Retainers',\n                    success: 'Success Fees',\n                    transaction: 'Transaction Fees',\n                    spread: 'Spreads'\n                  };\n                  \n                  const totalFees = Object.values(feesByType).reduce((sum, f) => sum + f.total, 0);\n                  \n                  return (\n                    <>\n                      <div className=\"text-center py-2\">\n                        <div className=\"text-2xl font-bold text-green-400\">\n                          ${totalFees.toLocaleString()}\n                        </div>\n                        <div className=\"text-xs text-muted-foreground\">IB Fixed Fees</div>\n                      </div>\n                      <Separator className=\"bg-border/50\" />\n                      <div className=\"space-y-2\">\n                        {Object.entries(feesByType).map(([type, data]) => (\n                          <div key={type} className=\"flex items-center justify-between text-xs\">\n                            <span className=\"text-muted-foreground truncate\">{feeLabels[type] || type}</span>\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"secondary\" className=\"text-[9px] px-1\">{data.count}</Badge>\n                              <span className=\"font-mono text-green-400\">${data.total.toLocaleString()}</span>\n                            </div>\n                          </div>\n                        ))}\n                        {Object.keys(feesByType).length === 0 && (\n                          <div className=\"text-center text-xs text-muted-foreground py-4\">\n                            No IB fees configured yet\n                          </div>\n                        )}\n                      </div>\n                    </>\n                  );\n                })()}\n              </CardContent>\n            </Card>\n          )}\n        </div>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"analytics\" className=\"mt-0\">\n          {renderAnalyticsView()}\n        </TabsContent>\n      </Tabs>\n\n      {/* New Deal Modal */}\n      <Dialog open={showNewDealModal} onOpenChange={setShowNewDealModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Create New Deal</DialogTitle>\n            <DialogDescription>Enter the details for the new deal below.</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4 max-h-[60vh] overflow-y-auto\">\n            <div className=\"space-y-2\">\n              <Label>Deal Name *</Label>\n              <Input \n                placeholder=\"Project Codename\" \n                value={newDeal.name}\n                onChange={(e) => setNewDeal({ ...newDeal, name: e.target.value })}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Client *</Label>\n              <Input \n                placeholder=\"Client Company Name\" \n                value={newDeal.client}\n                onChange={(e) => setNewDeal({ ...newDeal, client: e.target.value })}\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Value (in millions) *</Label>\n                <Input \n                  type=\"number\" \n                  placeholder=\"100\" \n                  value={newDeal.value}\n                  onChange={(e) => setNewDeal({ ...newDeal, value: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Sector</Label>\n                <Popover open={sectorOpen} onOpenChange={setSectorOpen}>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" role=\"combobox\" aria-expanded={sectorOpen} className=\"w-full justify-between\">\n                      {newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector}\n                      <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-full p-0\">\n                    <Command>\n                      <CommandInput placeholder=\"Search sector or type custom...\" />\n                      <CommandList>\n                        <CommandEmpty>\n                          <div className=\"p-2\">\n                            <Input \n                              placeholder=\"Enter custom sector...\"\n                              value={newDeal.customSector}\n                              onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                              onKeyDown={(e) => {\n                                if (e.key === 'Enter' && newDeal.customSector) {\n                                  setNewDeal({ ...newDeal, sector: 'Other' });\n                                  setSectorOpen(false);\n                                }\n                              }}\n                            />\n                          </div>\n                        </CommandEmpty>\n                        <CommandGroup>\n                          {SECTORS.map((sector) => (\n                            <CommandItem\n                              key={sector}\n                              value={sector}\n                              onSelect={() => {\n                                setNewDeal({ ...newDeal, sector, customSector: sector === 'Other' ? newDeal.customSector : '' });\n                                setSectorOpen(false);\n                              }}\n                            >\n                              <Check className={cn(\"mr-2 h-4 w-4\", newDeal.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                              {sector}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              </div>\n            </div>\n            {newDeal.sector === 'Other' && (\n              <div className=\"space-y-2\">\n                <Label>Custom Sector Name</Label>\n                <Input \n                  placeholder=\"Enter custom sector name...\"\n                  value={newDeal.customSector}\n                  onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                />\n              </div>\n            )}\n            <div className=\"space-y-2\">\n              <Label>Stage</Label>\n              <Select value={newDeal.stage} onValueChange={(v) => setNewDeal({ ...newDeal, stage: v })}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Origination\">Origination</SelectItem>\n                  <SelectItem value=\"Structuring\">Structuring</SelectItem>\n                  <SelectItem value=\"Diligence\">Diligence</SelectItem>\n                  <SelectItem value=\"Legal\">Legal</SelectItem>\n                  <SelectItem value=\"Close\">Close</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <Separator />\n            \n            <div className=\"space-y-2\">\n              <Label>Description</Label>\n              <Textarea \n                placeholder=\"Enter deal description, key terms, and notes...\"\n                value={newDeal.description}\n                onChange={(e) => setNewDeal({ ...newDeal, description: e.target.value })}\n                rows={4}\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label className=\"flex items-center gap-2\">\n                <Paperclip className=\"w-4 h-4\" /> Attachments\n              </Label>\n              <div className=\"border border-dashed border-border rounded-lg p-4\">\n                <input\n                  type=\"file\"\n                  multiple\n                  onChange={handleFileSelect}\n                  className=\"hidden\"\n                  id=\"file-upload\"\n                />\n                <label \n                  htmlFor=\"file-upload\" \n                  className=\"flex flex-col items-center cursor-pointer text-muted-foreground hover:text-foreground transition-colors\"\n                >\n                  <FileText className=\"w-8 h-8 mb-2\" />\n                  <span className=\"text-sm\">Click to upload files</span>\n                  <span className=\"text-xs\">PDF, DOC, XLS, PPT up to 10MB</span>\n                </label>\n              </div>\n              {newDeal.attachments.length > 0 && (\n                <div className=\"space-y-2 mt-2\">\n                  {newDeal.attachments.map((file, index) => (\n                    <div key={index} className=\"flex items-center justify-between bg-secondary/30 rounded px-3 py-2\">\n                      <span className=\"text-sm truncate flex-1\">{file.name}</span>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        onClick={() => removeAttachment(index)}\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowNewDealModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateDeal} disabled={createDeal.isPending}>\n              {createDeal.isPending ? \"Creating...\" : \"Create Deal\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Schedule Meeting Modal - Simplified */}\n      <Dialog open={showScheduleMeetingModal} onOpenChange={setShowScheduleMeetingModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Video className=\"w-5 h-5 text-primary\" />\n              Schedule Meeting\n            </DialogTitle>\n            <DialogDescription>Click a platform to create your meeting, then paste the link below.</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-6 py-4\">\n            {/* Platform Icons */}\n            <div className=\"space-y-3\">\n              <Label className=\"text-sm text-muted-foreground\">1. Create meeting on your platform</Label>\n              <div className=\"flex justify-center gap-4\">\n                <button\n                  type=\"button\"\n                  onClick={() => openVideoApp('zoom')}\n                  className={cn(\n                    \"flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all hover:scale-105\",\n                    newMeeting.videoPlatform === 'zoom' \n                      ? \"border-blue-500 bg-blue-500/10\" \n                      : \"border-border hover:border-blue-500/50\"\n                  )}\n                  data-testid=\"button-zoom\"\n                >\n                  <div className=\"w-12 h-12 rounded-lg bg-blue-500 flex items-center justify-center\">\n                    <Video className=\"w-6 h-6 text-white\" />\n                  </div>\n                  <span className=\"text-sm font-medium\">Zoom</span>\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => openVideoApp('google_meet')}\n                  className={cn(\n                    \"flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all hover:scale-105\",\n                    newMeeting.videoPlatform === 'google_meet' \n                      ? \"border-green-500 bg-green-500/10\" \n                      : \"border-border hover:border-green-500/50\"\n                  )}\n                  data-testid=\"button-meet\"\n                >\n                  <div className=\"w-12 h-12 rounded-lg bg-green-500 flex items-center justify-center\">\n                    <Video className=\"w-6 h-6 text-white\" />\n                  </div>\n                  <span className=\"text-sm font-medium\">Google Meet</span>\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => openVideoApp('teams')}\n                  className={cn(\n                    \"flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all hover:scale-105\",\n                    newMeeting.videoPlatform === 'teams' \n                      ? \"border-purple-500 bg-purple-500/10\" \n                      : \"border-border hover:border-purple-500/50\"\n                  )}\n                  data-testid=\"button-teams\"\n                >\n                  <div className=\"w-12 h-12 rounded-lg bg-purple-500 flex items-center justify-center\">\n                    <Video className=\"w-6 h-6 text-white\" />\n                  </div>\n                  <span className=\"text-sm font-medium\">Teams</span>\n                </button>\n              </div>\n            </div>\n            \n            {/* Meeting Link Input */}\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm text-muted-foreground\">2. Paste your meeting link</Label>\n              <Input \n                placeholder=\"https://zoom.us/j/... or https://meet.google.com/...\"\n                value={newMeeting.videoLink}\n                onChange={(e) => setNewMeeting({ ...newMeeting, videoLink: e.target.value })}\n                className=\"text-sm\"\n                data-testid=\"input-video-link\"\n              />\n            </div>\n            \n            {/* Basic Meeting Info */}\n            <div className=\"space-y-4 pt-2 border-t\">\n              <div className=\"space-y-2\">\n                <Label>Meeting Title</Label>\n                <Input \n                  placeholder=\"Q4 Deal Review\" \n                  value={newMeeting.title}\n                  onChange={(e) => setNewMeeting({ ...newMeeting, title: e.target.value })}\n                />\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-2\">\n                  <Label>Date</Label>\n                  <Input \n                    type=\"date\" \n                    value={newMeeting.scheduledFor}\n                    onChange={(e) => setNewMeeting({ ...newMeeting, scheduledFor: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Time</Label>\n                  <Select\n                    value={newMeeting.scheduledTime}\n                    onValueChange={(v) => setNewMeeting({ ...newMeeting, scheduledTime: v })}\n                  >\n                    <SelectTrigger data-testid=\"select-meeting-time\">\n                      <SelectValue placeholder=\"Select time\" />\n                    </SelectTrigger>\n                    <SelectContent className=\"max-h-[200px]\">\n                      {Array.from({ length: 36 }, (_, i) => {\n                        const hour = Math.floor(i / 2) + 6;\n                        const minute = (i % 2) * 30;\n                        const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;\n                        const hour12 = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;\n                        const ampm = hour >= 12 ? 'PM' : 'AM';\n                        const display = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;\n                        return <SelectItem key={time24} value={time24}>{display}</SelectItem>;\n                      })}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Invite Participants (emails, comma-separated)</Label>\n                <Input \n                  placeholder=\"john@company.com, jane@client.com\"\n                  value={newMeeting.participants}\n                  onChange={(e) => setNewMeeting({ ...newMeeting, participants: e.target.value })}\n                />\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowScheduleMeetingModal(false)}>Cancel</Button>\n            <Button \n              onClick={handleScheduleMeeting} \n              disabled={createMeeting.isPending || !newMeeting.title || !newMeeting.scheduledFor}\n            >\n              {createMeeting.isPending ? \"Scheduling...\" : \"Schedule Meeting\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Customize Sheet */}\n      <Sheet open={showCustomizeSheet} onOpenChange={setShowCustomizeSheet}>\n        <SheetContent className=\"bg-card border-border\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <Palette className=\"w-5 h-5 text-primary\" />\n              Customize Dashboard\n            </SheetTitle>\n            <SheetDescription>Show or hide widgets and configure market data.</SheetDescription>\n          </SheetHeader>\n          <ScrollArea className=\"h-[calc(100vh-150px)] mt-6\">\n            <div className=\"space-y-6 pr-4\">\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground mb-3\">WIDGETS (drag to reorder)</h4>\n                <Reorder.Group \n                  axis=\"y\" \n                  values={widgets} \n                  onReorder={setWidgets}\n                  className=\"space-y-2\"\n                >\n                  {widgets.map((widget) => (\n                    <Reorder.Item\n                      key={widget.id}\n                      value={widget}\n                      className=\"flex items-center justify-between p-3 bg-secondary/30 rounded-lg cursor-grab active:cursor-grabbing\"\n                    >\n                      <div className=\"flex items-center gap-2\">\n                        <GripVertical className=\"w-4 h-4 text-muted-foreground\" />\n                        <Label className=\"text-sm cursor-grab\">{widget.name}</Label>\n                      </div>\n                      <Switch \n                        checked={widget.enabled}\n                        onCheckedChange={() => handleWidgetToggle(widget.id)}\n                      />\n                    </Reorder.Item>\n                  ))}\n                </Reorder.Group>\n              </div>\n              \n              <Separator />\n              \n              {/* Dashboard Background Color */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground mb-3\">DASHBOARD THEME</h4>\n                <div className=\"grid grid-cols-4 gap-2\">\n                  {[\n                    { name: 'Default', value: 'default', color: 'bg-background' },\n                    { name: 'Navy', value: 'navy', color: 'bg-[#0f172a]' },\n                    { name: 'Slate', value: 'slate', color: 'bg-[#1e293b]' },\n                    { name: 'Charcoal', value: 'charcoal', color: 'bg-[#18181b]' },\n                    { name: 'Ocean', value: 'ocean', color: 'bg-[#0c4a6e]' },\n                    { name: 'Forest', value: 'forest', color: 'bg-[#14532d]' },\n                    { name: 'Wine', value: 'wine', color: 'bg-[#450a0a]' },\n                    { name: 'Purple', value: 'purple', color: 'bg-[#3b0764]' },\n                  ].map((themeOption) => (\n                    <button\n                      key={themeOption.value}\n                      onClick={() => {\n                        saveUserPrefs.mutate({ theme: themeOption.value });\n                        toast.success(`Theme set to ${themeOption.name}`);\n                      }}\n                      className={cn(\n                        \"w-full aspect-square rounded-lg border-2 transition-all\",\n                        themeOption.color,\n                        userPrefs?.theme === themeOption.value \n                          ? \"border-primary ring-2 ring-primary/30\" \n                          : \"border-border hover:border-primary/50\"\n                      )}\n                      title={themeOption.name}\n                    />\n                  ))}\n                </div>\n              </div>\n              \n              <Separator />\n              \n              <Button \n                variant=\"outline\" \n                className=\"w-full\"\n                onClick={() => {\n                  setWidgets(DEFAULT_WIDGETS);\n                  saveUserPrefs.mutate({ \n                    dashboardWidgets: DEFAULT_WIDGETS,\n                    theme: 'system',\n                    marketSymbols: ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'SPY'],\n                  });\n                  toast.success(\"Dashboard reset to defaults\");\n                }}\n              >\n                Reset to Defaults\n              </Button>\n            </div>\n          </ScrollArea>\n        </SheetContent>\n      </Sheet>\n\n      {/* Employee Detail Modal */}\n      <Dialog open={showEmployeeDetailModal} onOpenChange={setShowEmployeeDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold\">\n                {selectedEmployee?.name?.split(' ').map((n: string) => n[0]).join('') || '?'}\n              </div>\n              <div>\n                <div>{selectedEmployee?.name}</div>\n                <div className=\"text-sm font-normal text-muted-foreground\">{selectedEmployee?.role}</div>\n              </div>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedEmployee && (\n            <div className=\"space-y-6 py-4\">\n              {/* Stats Overview */}\n              <div className=\"grid grid-cols-4 gap-4\">\n                <div className=\"bg-secondary/30 rounded-lg p-4 text-center\">\n                  <div className=\"text-2xl font-bold text-primary\">\n                    <Zap className=\"w-5 h-5 inline mr-1\" />\n                    {(selectedEmployee as any).velocityScore || 0}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">Velocity Score</div>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-4 text-center\">\n                  <div className=\"text-2xl font-bold text-green-400\">{(selectedEmployee as any).completedTasks || 0}</div>\n                  <div className=\"text-xs text-muted-foreground\">Completed</div>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-4 text-center\">\n                  <div className=\"text-2xl font-bold text-yellow-400\">{(selectedEmployee as any).inProgressTasks || 0}</div>\n                  <div className=\"text-xs text-muted-foreground\">In Progress</div>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-4 text-center\">\n                  <div className=\"text-2xl font-bold\">{(selectedEmployee as any).pendingTasks || 0}</div>\n                  <div className=\"text-xs text-muted-foreground\">Pending</div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Tasks by Deal */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-4\">Tasks by Deal</h4>\n                <div className=\"space-y-3\">\n                  {(selectedEmployee as any).tasksByDeal && Object.entries((selectedEmployee as any).tasksByDeal).map(([dealId, stats]: [string, any]) => (\n                    <div key={dealId} className=\"bg-secondary/20 rounded-lg p-4\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <h5 className=\"font-medium\">{stats.dealName}</h5>\n                        <Badge variant=\"secondary\">\n                          {stats.completed + stats.inProgress + stats.pending} total\n                        </Badge>\n                      </div>\n                      <div className=\"flex gap-4 text-sm\">\n                        <span className=\"text-green-400 flex items-center gap-1\">\n                          <Check className=\"w-3 h-3\" /> {stats.completed} done\n                        </span>\n                        <span className=\"text-yellow-400 flex items-center gap-1\">\n                          <Activity className=\"w-3 h-3\" /> {stats.inProgress} active\n                        </span>\n                        <span className=\"text-muted-foreground flex items-center gap-1\">\n                          <Clock className=\"w-3 h-3\" /> {stats.pending} pending\n                        </span>\n                      </div>\n                      <div className=\"mt-2 h-2 w-full bg-secondary rounded-full overflow-hidden\">\n                        <div className=\"h-full flex\">\n                          <div \n                            className=\"bg-green-400 h-full\"\n                            style={{ width: `${(stats.completed / (stats.completed + stats.inProgress + stats.pending)) * 100}%` }}\n                          />\n                          <div \n                            className=\"bg-yellow-400 h-full\"\n                            style={{ width: `${(stats.inProgress / (stats.completed + stats.inProgress + stats.pending)) * 100}%` }}\n                          />\n                        </div>\n                      </div>\n                      \n                      {/* Task Names List */}\n                      {stats.taskNames && stats.taskNames.length > 0 && (\n                        <div className=\"mt-3 space-y-1.5\">\n                          {stats.taskNames.map((task: any) => (\n                            <div \n                              key={task.id} \n                              className=\"flex items-center justify-between text-xs p-2 bg-background/50 rounded border border-border/50\"\n                            >\n                              <div className=\"flex items-center gap-2\">\n                                <div className={cn(\n                                  \"w-2 h-2 rounded-full\",\n                                  task.status === 'Completed' ? \"bg-green-400\" :\n                                  task.status === 'In Progress' ? \"bg-yellow-400\" : \"bg-muted-foreground\"\n                                )} />\n                                <span className={task.status === 'Completed' ? \"line-through text-muted-foreground\" : \"\"}>\n                                  {task.name}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                {task.dueDate && (\n                                  <span className=\"text-muted-foreground text-[10px]\">\n                                    {format(new Date(task.dueDate), 'MMM d')}\n                                  </span>\n                                )}\n                                <Badge variant=\"outline\" className={cn(\n                                  \"text-[9px] h-4\",\n                                  task.priority === 'High' || task.priority === 'Critical' ? \"text-red-400 border-red-400/30\" :\n                                  task.priority === 'Medium' ? \"text-yellow-400 border-yellow-400/30\" : \"\"\n                                )}>\n                                  {task.priority}\n                                </Badge>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                  {(!((selectedEmployee as any).tasksByDeal) || Object.keys((selectedEmployee as any).tasksByDeal).length === 0) && (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      No deals assigned yet\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Progress Overview */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-4\">Progress Overview</h4>\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Task Completion Rate</span>\n                      <span className=\"font-medium text-green-400\">\n                        {(selectedEmployee as any).totalTasks > 0 \n                          ? Math.round(((selectedEmployee as any).completedTasks / (selectedEmployee as any).totalTasks) * 100) \n                          : 0}%\n                      </span>\n                    </div>\n                    <Progress \n                      value={(selectedEmployee as any).totalTasks > 0 \n                        ? ((selectedEmployee as any).completedTasks / (selectedEmployee as any).totalTasks) * 100 \n                        : 0} \n                      className=\"h-2\" \n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <p className=\"text-muted-foreground text-xs\">Active Deals</p>\n                      <p className=\"text-xl font-bold\">{Object.keys((selectedEmployee as any).tasksByDeal || {}).length}</p>\n                    </div>\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <p className=\"text-muted-foreground text-xs\">Workload Status</p>\n                      <p className=\"text-xl font-bold\">\n                        {(selectedEmployee as any).totalTasks > 8 ? 'High' : \n                         (selectedEmployee as any).totalTasks > 4 ? 'Medium' : 'Low'}\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    <p className=\"flex items-center gap-2\">\n                      <Activity className=\"w-4 h-4 text-yellow-400\" />\n                      {(selectedEmployee as any).inProgressTasks} tasks currently in progress\n                    </p>\n                    <p className=\"flex items-center gap-2 mt-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      {(selectedEmployee as any).pendingTasks} tasks pending assignment\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEmployeeDetailModal(false)}>Close</Button>\n            <Button onClick={() => { setShowEmployeeDetailModal(false); setLocation('/ceo/team'); }}>\n              View in Team Management\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Active Deals Detail Modal */}\n      <Dialog open={activeDealsModalOpen} onOpenChange={setActiveDealsModalOpen}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[80vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Briefcase className=\"w-5 h-5 text-primary\" />\n              Active Deals Analytics\n            </DialogTitle>\n            <DialogDescription>\n              Detailed breakdown of all active deals across Investment Banking and Asset Management\n            </DialogDescription>\n          </DialogHeader>\n          <ScrollArea className=\"h-[60vh] pr-4\">\n            <div className=\"space-y-6\">\n              {/* Summary Stats */}\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div className=\"p-4 bg-secondary/30 rounded-lg text-center\">\n                  <div className=\"text-3xl font-bold text-primary\">{activeDeals.length}</div>\n                  <div className=\"text-xs text-muted-foreground uppercase mt-1\">Total Active</div>\n                </div>\n                <div className=\"p-4 bg-secondary/30 rounded-lg text-center\">\n                  <div className=\"text-3xl font-bold text-green-400\">${displayActiveValue.toLocaleString()}M</div>\n                  <div className=\"text-xs text-muted-foreground uppercase mt-1\">Total Value</div>\n                </div>\n                <div className=\"p-4 bg-secondary/30 rounded-lg text-center\">\n                  <div className=\"text-3xl font-bold text-blue-400\">\n                    {activeDeals.length > 0 ? Math.round(displayActiveValue / activeDeals.length) : 0}M\n                  </div>\n                  <div className=\"text-xs text-muted-foreground uppercase mt-1\">Avg Deal Size</div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Division Breakdown */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">By Division</h4>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"text-sm font-medium\">Investment Banking</span>\n                      <Badge className=\"bg-blue-500/20 text-blue-400\">{ibActiveDeals.length} deals</Badge>\n                    </div>\n                    <div className=\"text-2xl font-bold text-blue-400\">${ibActiveValue.toLocaleString()}M</div>\n                  </div>\n                  <div className=\"p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"text-sm font-medium\">Asset Management</span>\n                      <Badge className=\"bg-emerald-500/20 text-emerald-400\">{amActiveDeals.length} deals</Badge>\n                    </div>\n                    <div className=\"text-2xl font-bold text-emerald-400\">${amActiveValue.toLocaleString()}M</div>\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Sector Breakdown - Separated by Division */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">By Sector</h4>\n                \n                {/* IB Sectors */}\n                <div className=\"mb-4\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                    <span className=\"text-sm font-medium text-blue-400\">Investment Banking</span>\n                  </div>\n                  <div className=\"space-y-1 pl-5\">\n                    {(() => {\n                      const ibSectors = ibActiveDeals.reduce((acc, deal) => {\n                        const sector = deal.sector || 'Other';\n                        acc[sector] = acc[sector] || { count: 0, value: 0 };\n                        acc[sector].count++;\n                        acc[sector].value += deal.value;\n                        return acc;\n                      }, {} as Record<string, { count: number; value: number }>);\n                      return Object.entries(ibSectors).length > 0 ? Object.entries(ibSectors).map(([sector, stats]) => (\n                        <div key={sector} className=\"flex items-center justify-between p-2 bg-blue-500/5 border border-blue-500/10 rounded-lg\">\n                          <span className=\"text-sm\">{sector}</span>\n                          <div className=\"flex items-center gap-3\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">{stats.count}</Badge>\n                            <span className=\"text-blue-400 font-mono text-sm\">${stats.value}M</span>\n                          </div>\n                        </div>\n                      )) : <p className=\"text-sm text-muted-foreground py-1\">No IB deals</p>;\n                    })()}\n                  </div>\n                </div>\n                \n                {/* AM Sectors */}\n                <div>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                    <span className=\"text-sm font-medium text-emerald-400\">Asset Management</span>\n                  </div>\n                  <div className=\"space-y-1 pl-5\">\n                    {(() => {\n                      const amSectors = amActiveDeals.reduce((acc, deal) => {\n                        const sector = deal.sector || 'Other';\n                        acc[sector] = acc[sector] || { count: 0, value: 0 };\n                        acc[sector].count++;\n                        acc[sector].value += deal.value;\n                        return acc;\n                      }, {} as Record<string, { count: number; value: number }>);\n                      return Object.entries(amSectors).length > 0 ? Object.entries(amSectors).map(([sector, stats]) => (\n                        <div key={sector} className=\"flex items-center justify-between p-2 bg-emerald-500/5 border border-emerald-500/10 rounded-lg\">\n                          <span className=\"text-sm\">{sector}</span>\n                          <div className=\"flex items-center gap-3\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">{stats.count}</Badge>\n                            <span className=\"text-emerald-400 font-mono text-sm\">${stats.value}M</span>\n                          </div>\n                        </div>\n                      )) : <p className=\"text-sm text-muted-foreground py-1\">No AM deals</p>;\n                    })()}\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Deal List - Separated by Division */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">All Active Deals</h4>\n                \n                {/* Investment Banking Deals */}\n                <div className=\"mb-4\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                    <span className=\"text-sm font-medium text-blue-400\">Investment Banking ({ibActiveDeals.length})</span>\n                  </div>\n                  <div className=\"space-y-2 pl-5\">\n                    {ibActiveDeals.length > 0 ? ibActiveDeals.map((deal) => (\n                      <div key={deal.id} className=\"flex items-center justify-between p-3 bg-blue-500/5 border border-blue-500/10 rounded-lg hover:bg-blue-500/10 transition-colors\">\n                        <div>\n                          <div className=\"font-medium\">{deal.name}</div>\n                          <div className=\"text-xs text-muted-foreground\">{deal.client}  {deal.sector}</div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-green-400 font-mono font-bold\">${deal.value}M</div>\n                          <Badge variant=\"outline\" className=\"text-xs\">{deal.stage}</Badge>\n                        </div>\n                      </div>\n                    )) : (\n                      <p className=\"text-sm text-muted-foreground py-2\">No active IB deals</p>\n                    )}\n                  </div>\n                </div>\n                \n                {/* Asset Management Deals */}\n                <div>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                    <span className=\"text-sm font-medium text-emerald-400\">Asset Management ({amActiveDeals.length})</span>\n                  </div>\n                  <div className=\"space-y-2 pl-5\">\n                    {amActiveDeals.length > 0 ? amActiveDeals.map((deal) => (\n                      <div key={deal.id} className=\"flex items-center justify-between p-3 bg-emerald-500/5 border border-emerald-500/10 rounded-lg hover:bg-emerald-500/10 transition-colors\">\n                        <div>\n                          <div className=\"font-medium\">{deal.name}</div>\n                          <div className=\"text-xs text-muted-foreground\">{deal.client}  {deal.sector}</div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-green-400 font-mono font-bold\">${deal.value}M</div>\n                          <Badge variant=\"outline\" className=\"text-xs\">{deal.stage}</Badge>\n                        </div>\n                      </div>\n                    )) : (\n                      <p className=\"text-sm text-muted-foreground py-2\">No active AM deals</p>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setActiveDealsModalOpen(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Capital At Work Detail Modal */}\n      <Dialog open={capitalAtWorkModalOpen} onOpenChange={setCapitalAtWorkModalOpen}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[80vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <DollarSign className=\"w-5 h-5 text-primary\" />\n              Capital At Work Analysis\n            </DialogTitle>\n            <DialogDescription>\n              Comprehensive view of capital deployment across all active engagements\n            </DialogDescription>\n          </DialogHeader>\n          <ScrollArea className=\"h-[60vh] pr-4\">\n            <div className=\"space-y-6\">\n              {/* Total Capital */}\n              <div className=\"p-6 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg text-center\">\n                <div className=\"text-4xl font-bold text-primary\">${displayActiveValue.toLocaleString()}M</div>\n                <div className=\"text-sm text-muted-foreground mt-2\">Total Capital at Work</div>\n              </div>\n\n              {/* Status Breakdown - Separated by Division */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">Deal Status Distribution</h4>\n                \n                {/* IB Status */}\n                <div className=\"mb-4\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                    <span className=\"text-sm font-medium text-blue-400\">Investment Banking</span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2 pl-5\">\n                    <div className=\"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-blue-400\">{ibActiveDeals.length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">Active</div>\n                    </div>\n                    <div className=\"p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-yellow-400\">{ibDeals.filter(d => d.status === 'On Hold').length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">On Hold</div>\n                    </div>\n                    <div className=\"p-3 bg-secondary/30 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-muted-foreground\">{ibDeals.filter(d => d.status === 'Closed').length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">Closed</div>\n                    </div>\n                  </div>\n                </div>\n                \n                {/* AM Status */}\n                <div>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                    <span className=\"text-sm font-medium text-emerald-400\">Asset Management</span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2 pl-5\">\n                    <div className=\"p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-emerald-400\">{amActiveDeals.length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">Active</div>\n                    </div>\n                    <div className=\"p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-yellow-400\">{amDeals.filter(d => d.status === 'On Hold').length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">On Hold</div>\n                    </div>\n                    <div className=\"p-3 bg-secondary/30 rounded-lg text-center\">\n                      <div className=\"text-xl font-bold text-muted-foreground\">{amDeals.filter(d => d.status === 'Closed').length}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase\">Closed</div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Division Split */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">Division Allocation</h4>\n                <div className=\"space-y-4\">\n                  <div>\n                    <div className=\"flex justify-between text-sm mb-2\">\n                      <span className=\"flex items-center gap-2\">\n                        <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                        Investment Banking\n                      </span>\n                      <span className=\"text-blue-400 font-bold\">${ibActiveValue.toLocaleString()}M ({ibActiveDeals.length} deals)</span>\n                    </div>\n                    <Progress value={displayActiveValue > 0 ? (ibActiveValue / displayActiveValue) * 100 : 0} className=\"h-3\" />\n                  </div>\n                  <div>\n                    <div className=\"flex justify-between text-sm mb-2\">\n                      <span className=\"flex items-center gap-2\">\n                        <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                        Asset Management\n                      </span>\n                      <span className=\"text-emerald-400 font-bold\">${amActiveValue.toLocaleString()}M ({amActiveDeals.length} deals)</span>\n                    </div>\n                    <Progress value={displayActiveValue > 0 ? (amActiveValue / displayActiveValue) * 100 : 0} className=\"h-3\" />\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Stage Distribution - Separated by Division */}\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">Pipeline by Stage</h4>\n                \n                {/* IB Stages */}\n                <div className=\"mb-4\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                    <span className=\"text-sm font-medium text-blue-400\">Investment Banking</span>\n                  </div>\n                  <div className=\"space-y-2 pl-5\">\n                    {['Origination', 'Structuring', 'Diligence', 'Legal', 'Close'].map((stage) => {\n                      const stageDeals = ibActiveDeals.filter(d => mapIBStage(d.stage) === stage);\n                      const stageValue = stageDeals.reduce((sum, d) => sum + d.value, 0);\n                      if (stageDeals.length === 0) return null;\n                      return (\n                        <div key={stage} className=\"flex items-center justify-between p-2 bg-blue-500/5 border border-blue-500/10 rounded-lg\">\n                          <span className=\"text-sm\">{stage}</span>\n                          <div className=\"flex items-center gap-3\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">{stageDeals.length}</Badge>\n                            <span className=\"text-blue-400 font-mono text-sm font-bold\">${stageValue.toLocaleString()}M</span>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n                \n                {/* AM Stages */}\n                <div>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n                    <span className=\"text-sm font-medium text-emerald-400\">Asset Management</span>\n                  </div>\n                  <div className=\"space-y-2 pl-5\">\n                    {['Origination', 'Due Diligence', 'Structuring', 'Negotiation', 'Closing'].map((stage) => {\n                      const stageDeals = amActiveDeals.filter(d => d.stage === stage);\n                      const stageValue = stageDeals.reduce((sum, d) => sum + d.value, 0);\n                      if (stageDeals.length === 0) return null;\n                      return (\n                        <div key={stage} className=\"flex items-center justify-between p-2 bg-emerald-500/5 border border-emerald-500/10 rounded-lg\">\n                          <span className=\"text-sm\">{stage}</span>\n                          <div className=\"flex items-center gap-3\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">{stageDeals.length}</Badge>\n                            <span className=\"text-emerald-400 font-mono text-sm font-bold\">${stageValue.toLocaleString()}M</span>\n                          </div>\n                        </div>\n                      );\n                    })}\n                    {amActiveDeals.length === 0 && (\n                      <p className=\"text-sm text-muted-foreground py-2\">No active AM deals</p>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setCapitalAtWorkModalOpen(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Fee Summary Detail Modal */}\n      <Dialog open={feeSummaryModalOpen} onOpenChange={setFeeSummaryModalOpen}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[80vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Briefcase className=\"w-5 h-5 text-green-400\" />\n              Fee Summary Details\n            </DialogTitle>\n            <DialogDescription>\n              Complete breakdown of fees across all Investment Banking deals\n            </DialogDescription>\n          </DialogHeader>\n          <ScrollArea className=\"h-[60vh] pr-4\">\n            {(() => {\n              const ibDealIds = new Set(ibDeals.map(d => d.id));\n              const ibFees = allDealFees.filter(fee => ibDealIds.has(fee.dealId));\n              \n              const feesByType = ibFees.reduce((acc, fee) => {\n                const type = fee.feeType || 'other';\n                if (!acc[type]) acc[type] = { total: 0, count: 0, fees: [] as typeof ibFees };\n                if (fee.amount) {\n                  acc[type].total += fee.amount;\n                  acc[type].count++;\n                  acc[type].fees.push(fee);\n                }\n                return acc;\n              }, {} as Record<string, { total: number; count: number; fees: typeof ibFees }>);\n              \n              const feeLabels: Record<string, { name: string; description: string }> = {\n                engagement: { name: 'Engagement Fees', description: 'Upfront fees charged at deal initiation' },\n                monthly: { name: 'Monthly Retainers', description: 'Recurring monthly advisory fees' },\n                success: { name: 'Success Fees', description: 'Fees contingent on deal completion' },\n                transaction: { name: 'Transaction Fees', description: 'Fees based on transaction value' },\n                spread: { name: 'Spreads', description: 'Fee spreads on capital raised' }\n              };\n              \n              const totalFees = Object.values(feesByType).reduce((sum, f) => sum + f.total, 0);\n              \n              return (\n                <div className=\"space-y-6\">\n                  {/* Total Fees */}\n                  <div className=\"p-6 bg-gradient-to-br from-green-500/10 to-green-500/5 rounded-lg text-center\">\n                    <div className=\"text-4xl font-bold text-green-400\">${totalFees.toLocaleString()}</div>\n                    <div className=\"text-sm text-muted-foreground mt-2\">Total IB Fixed Fees</div>\n                  </div>\n\n                  <Separator />\n\n                  {/* Fee Type Breakdown */}\n                  <div>\n                    <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">Fee Types</h4>\n                    {Object.entries(feesByType).length > 0 ? (\n                      <div className=\"space-y-4\">\n                        {Object.entries(feesByType).map(([type, data]) => (\n                          <div key={type} className=\"p-4 bg-secondary/20 rounded-lg\">\n                            <div className=\"flex items-center justify-between mb-2\">\n                              <div>\n                                <div className=\"font-medium\">{feeLabels[type]?.name || type}</div>\n                                <div className=\"text-xs text-muted-foreground\">{feeLabels[type]?.description || ''}</div>\n                              </div>\n                              <div className=\"text-right\">\n                                <div className=\"text-xl font-bold text-green-400\">${data.total.toLocaleString()}</div>\n                                <Badge variant=\"secondary\" className=\"mt-1\">{data.count} fees</Badge>\n                              </div>\n                            </div>\n                            {data.fees.length > 0 && (\n                              <div className=\"mt-3 pt-3 border-t border-border/50 space-y-2\">\n                                {data.fees.slice(0, 5).map((fee) => {\n                                  const deal = ibDeals.find(d => d.id === fee.dealId);\n                                  return (\n                                    <div key={fee.id} className=\"flex justify-between text-sm\">\n                                      <span className=\"text-muted-foreground truncate\">{deal?.name || 'Unknown Deal'}</span>\n                                      <span className=\"text-green-400 font-mono\">${fee.amount?.toLocaleString()}</span>\n                                    </div>\n                                  );\n                                })}\n                                {data.fees.length > 5 && (\n                                  <div className=\"text-xs text-muted-foreground text-center\">\n                                    +{data.fees.length - 5} more fees\n                                  </div>\n                                )}\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <Briefcase className=\"w-12 h-12 mx-auto mb-3 opacity-30\" />\n                        <p>No fees configured yet</p>\n                        <p className=\"text-xs mt-1\">Add fees to deals to see them here</p>\n                      </div>\n                    )}\n                  </div>\n\n                  {Object.entries(feesByType).length > 0 && (\n                    <>\n                      <Separator />\n\n                      {/* Fee Distribution Chart Summary */}\n                      <div>\n                        <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">Distribution</h4>\n                        <div className=\"space-y-2\">\n                          {Object.entries(feesByType).map(([type, data]) => {\n                            const percentage = totalFees > 0 ? (data.total / totalFees) * 100 : 0;\n                            return (\n                              <div key={type}>\n                                <div className=\"flex justify-between text-sm mb-1\">\n                                  <span>{feeLabels[type]?.name || type}</span>\n                                  <span className=\"text-muted-foreground\">{percentage.toFixed(1)}%</span>\n                                </div>\n                                <Progress value={percentage} className=\"h-2\" />\n                              </div>\n                            );\n                          })}\n                        </div>\n                      </div>\n                    </>\n                  )}\n                </div>\n              );\n            })()}\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setFeeSummaryModalOpen(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":153459,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1342,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5745,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2143,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"@neondatabase/serverless\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1439,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4887,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport compression from \"compression\";\nimport helmet from \"helmet\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { logger, requestIdMiddleware, requestLoggingMiddleware, errorLoggingMiddleware, logServerStart } from \"./logger\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\n// Security headers - protect against common web vulnerabilities\napp.use(helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      scriptSrc: [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\", \"https://fonts.googleapis.com\"],\n      fontSrc: [\"'self'\", \"https://fonts.gstatic.com\"],\n      imgSrc: [\"'self'\", \"data:\", \"blob:\", \"https:\"],\n      mediaSrc: [\"'self'\", \"data:\", \"blob:\"],\n      connectSrc: [\n        \"'self'\",\n        \"wss:\",\n        \"ws:\",\n        \"https://www.googleapis.com\",\n        \"https://api.openai.com\",\n        \"https://api.resend.com\",\n      ],\n      frameSrc: [\"'self'\"],\n      objectSrc: [\"'none'\"],\n      upgradeInsecureRequests: [],\n    },\n  },\n  crossOriginEmbedderPolicy: false, // Required for some external resources\n  crossOriginResourcePolicy: { policy: \"cross-origin\" },\n}));\n\n// Enable gzip compression for all responses\napp.use(compression());\n\napp.use(requestIdMiddleware);\n\napp.use(\n  express.json({\n    limit: '50mb',\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false, limit: '50mb' }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use(requestLoggingMiddleware);\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use(errorLoggingMiddleware);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      logServerStart(port);\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":3174,"size_tokens":null},"client/src/components/layout/Layout.tsx":{"content":"import { useState, useMemo, useRef, useEffect, ChangeEvent } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Sidebar } from \"./Sidebar\";\nimport { ReaperAssistant } from \"../assistant/ReaperAssistant\";\nimport { DockedChatBoxes } from \"../chat/DockedChatBoxes\";\nimport { Bell, Search, User, BookOpen, Palette, Briefcase, CheckSquare, Users, FileText, X, Settings, BarChart3, Target, Mail, Phone, Lock, Pencil, AlertCircle, Info, Check, Rocket, TrendingUp, UserCheck, ChevronRight, PanelLeftClose, PanelLeft, Camera, Trash2, Calendar, Paperclip, ExternalLink, Loader2, Shield, ShieldCheck, ShieldOff, Copy, Smartphone, QrCode, Eye, EyeOff, Menu } from \"lucide-react\";\nimport { \n  DropdownMenu, \n  DropdownMenuContent, \n  DropdownMenuItem, \n  DropdownMenuLabel, \n  DropdownMenuSeparator, \n  DropdownMenuTrigger \n} from \"@/components/ui/dropdown-menu\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useDashboardContext } from \"@/contexts/DashboardContext\";\nimport { useNotifications, useDealsListing, useTasks, useUsers, useLogout, useCurrentUser, useMarkNotificationRead, useUpdateUserProfile, useChangePassword, useUserPreferences, useSaveUserPreferences, use2FAStatus, useSetup2FA, useVerify2FA, useDisable2FA } from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { cn } from \"@/lib/utils\";\n\ntype LayoutProps = {\n  children: React.ReactNode;\n  role?: 'CEO' | 'Employee';\n  userName?: string;\n  pageTitle?: string;\n};\n\nexport function Layout({ children, role = 'CEO', userName = \"Joshua Orlinsky\", pageTitle }: LayoutProps) {\n  const [, setLocation] = useLocation();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showSearchResults, setShowSearchResults] = useState(false);\n  const searchRef = useRef<HTMLDivElement>(null);\n  const notificationAudioRef = useRef<HTMLAudioElement | null>(null);\n  const seenNotificationIdsRef = useRef<Set<string>>(new Set());\n  const notificationMountTimeRef = useRef(Date.now());\n  const logoutMutation = useLogout();\n  const { data: currentUser } = useCurrentUser();\n  const markNotificationRead = useMarkNotificationRead();\n  const updateUserProfile = useUpdateUserProfile();\n  const changePassword = useChangePassword();\n  \n  // Preview mode for admins to see employee view - persisted in sessionStorage\n  const [isPreviewMode, setIsPreviewMode] = useState(() => {\n    // Only Charles can use preview mode\n    if (typeof window !== 'undefined') {\n      return sessionStorage.getItem('kronos_preview_mode') === 'true';\n    }\n    return false;\n  });\n  \n  // Track pending navigation for preview mode toggle\n  const [pendingPreviewNav, setPendingPreviewNav] = useState<'employee' | 'admin' | null>(null);\n  \n  // Sync preview mode changes to sessionStorage\n  useEffect(() => {\n    if (isPreviewMode) {\n      sessionStorage.setItem('kronos_preview_mode', 'true');\n    } else {\n      sessionStorage.removeItem('kronos_preview_mode');\n    }\n  }, [isPreviewMode]);\n  \n  // Handle navigation after preview mode state has fully updated\n  useEffect(() => {\n    if (pendingPreviewNav === 'employee' && isPreviewMode) {\n      setLocation('/employee/home');\n      toast.info(\"Preview mode enabled - viewing as employee\");\n      setPendingPreviewNav(null);\n    } else if (pendingPreviewNav === 'admin' && !isPreviewMode) {\n      setLocation('/ceo/dashboard');\n      toast.info(\"Preview mode disabled - back to admin view\");\n      setPendingPreviewNav(null);\n    }\n  }, [isPreviewMode, pendingPreviewNav, setLocation]);\n  \n  // Clear preview mode if user is not Charles\n  useEffect(() => {\n    if (currentUser && currentUser.email !== 'cchochos@equiturn.com' && isPreviewMode) {\n      setIsPreviewMode(false);\n    }\n  }, [currentUser]);\n  \n  // Non-admin users should always see Employee view, regardless of role prop\n  // Only admins can see CEO view (or Employee view in preview mode)\n  const effectiveRole = currentUser?.accessLevel === 'admin' \n    ? (isPreviewMode ? 'Employee' : role) \n    : 'Employee';\n  \n  // Profile editing state\n  const [isEditingProfile, setIsEditingProfile] = useState(false);\n  const [profileForm, setProfileForm] = useState({\n    name: '',\n    email: '',\n    phone: '',\n    role: '',\n    jobTitle: '',\n  });\n  \n  // Password change state\n  const [isChangingPassword, setIsChangingPassword] = useState(false);\n  const [passwordForm, setPasswordForm] = useState({\n    currentPassword: '',\n    newPassword: '',\n    confirmPassword: '',\n  });\n  \n  // 2FA state\n  const [isSettingUp2FA, setIsSettingUp2FA] = useState(false);\n  const [isDisabling2FA, setIsDisabling2FA] = useState(false);\n  const [twoFACode, setTwoFACode] = useState('');\n  const [qrCodeData, setQrCodeData] = useState<{ secret: string; qrCode: string } | null>(null);\n  const { data: twoFAStatus, isLoading: twoFALoading } = use2FAStatus();\n  const setup2FA = useSetup2FA();\n  const verify2FA = useVerify2FA();\n  const disable2FA = useDisable2FA();\n  \n  // User preferences from database\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  \n  // Default settings values\n  const DEFAULT_SETTINGS = {\n    dealUpdates: true,\n    taskReminders: true,\n    teamActivity: false,\n    weeklySummary: true,\n    desktopAlerts: false,\n    darkMode: true,\n    compactView: false,\n    animations: true,\n    autoRefresh: true,\n    twoFactorAuth: false,\n  };\n  \n  // Sidebar collapsed state - from database preferences\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [sidebarInitialized, setSidebarInitialized] = useState(false);\n  \n  // Mobile sidebar drawer state\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n  \n  // Settings preferences - from database preferences\n  const [settings, setSettings] = useState(DEFAULT_SETTINGS);\n  const [settingsInitialized, setSettingsInitialized] = useState(false);\n  \n  // Refs for tracking last saved state and mounted status\n  const isMountedRef = useRef(true);\n  const lastSavedSidebarRef = useRef(false);\n  const lastSavedSettingsRef = useRef(DEFAULT_SETTINGS);\n  \n  useEffect(() => {\n    isMountedRef.current = true;\n    return () => {\n      isMountedRef.current = false;\n    };\n  }, []);\n  \n  // Hydrate sidebar state from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !sidebarInitialized) {\n      const savedState = userPrefs?.sidebarCollapsed ?? false;\n      setSidebarCollapsed(savedState);\n      lastSavedSidebarRef.current = savedState;\n      setSidebarInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, sidebarInitialized]);\n  \n  // Hydrate settings from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !settingsInitialized) {\n      const savedSettings = userPrefs?.settings as typeof DEFAULT_SETTINGS | undefined;\n      if (savedSettings && typeof savedSettings === 'object') {\n        const mergedSettings = { ...DEFAULT_SETTINGS, ...savedSettings };\n        setSettings(mergedSettings);\n        lastSavedSettingsRef.current = mergedSettings;\n      }\n      setSettingsInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, settingsInitialized]);\n  \n  // Helper to extract only mutable preference fields (strip readonly columns)\n  const getMutablePrefs = (prefs: any) => {\n    if (!prefs) return {};\n    const { id, userId, updatedAt, ...mutableFields } = prefs;\n    return mutableFields;\n  };\n  \n  // Save sidebar state to database (debounced) - merge with existing preferences\n  const saveSidebarTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  useEffect(() => {\n    if (!sidebarInitialized) return;\n    \n    // Skip save if sidebar state hasn't changed\n    if (sidebarCollapsed === lastSavedSidebarRef.current) return;\n    \n    if (saveSidebarTimeoutRef.current) {\n      clearTimeout(saveSidebarTimeoutRef.current);\n    }\n    saveSidebarTimeoutRef.current = setTimeout(async () => {\n      if (!isMountedRef.current) return;\n      try {\n        await saveUserPrefs.mutateAsync({ sidebarCollapsed });\n        lastSavedSidebarRef.current = sidebarCollapsed;\n      } catch (error) {\n        console.error('Failed to save sidebar state:', error);\n      }\n    }, 2000);\n    return () => {\n      if (saveSidebarTimeoutRef.current) {\n        clearTimeout(saveSidebarTimeoutRef.current);\n      }\n    };\n  }, [sidebarCollapsed, sidebarInitialized]);\n  \n  // Save settings to database (debounced) - merge with existing preferences\n  const saveSettingsTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  useEffect(() => {\n    if (!settingsInitialized) return;\n    \n    // Skip save if settings haven't actually changed\n    if (JSON.stringify(settings) === JSON.stringify(lastSavedSettingsRef.current)) return;\n    \n    if (saveSettingsTimeoutRef.current) {\n      clearTimeout(saveSettingsTimeoutRef.current);\n    }\n    saveSettingsTimeoutRef.current = setTimeout(async () => {\n      if (!isMountedRef.current) return;\n      try {\n        await saveUserPrefs.mutateAsync({ settings });\n        lastSavedSettingsRef.current = settings;\n      } catch (error) {\n        console.error('Failed to save settings:', error);\n      }\n    }, 2000);\n    return () => {\n      if (saveSettingsTimeoutRef.current) {\n        clearTimeout(saveSettingsTimeoutRef.current);\n      }\n    };\n  }, [settings, settingsInitialized]);\n  \n  const updateSetting = (key: string, value: boolean) => {\n    setSettings((prev: any) => ({ ...prev, [key]: value }));\n    toast.success(`Setting updated`);\n  };\n  \n  // Apply display settings to the document\n  useEffect(() => {\n    const root = document.documentElement;\n    \n    // Dark mode - toggle the dark class on html element\n    if (settings.darkMode) {\n      root.classList.add('dark');\n    } else {\n      root.classList.remove('dark');\n    }\n    \n    // Compact view - add/remove compact class\n    if (settings.compactView) {\n      root.classList.add('compact-view');\n      root.style.setProperty('--compact-spacing', '0.5');\n    } else {\n      root.classList.remove('compact-view');\n      root.style.removeProperty('--compact-spacing');\n    }\n    \n    // Animations - disable/enable animations\n    if (settings.animations) {\n      root.classList.remove('no-animations');\n    } else {\n      root.classList.add('no-animations');\n    }\n  }, [settings.darkMode, settings.compactView, settings.animations]);\n  \n  // Photo upload ref\n  const photoInputRef = useRef<HTMLInputElement>(null);\n  const [isUploadingPhoto, setIsUploadingPhoto] = useState(false);\n  \n  // Task detail modal state\n  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);\n  const [selectedSearchTask, setSelectedSearchTask] = useState<any>(null);\n  \n  const { \n    showProfileSheet,\n    setShowProfileSheet, \n    showSettingsSheet,\n    setShowSettingsSheet, \n    showNotificationsSheet,\n    setShowNotificationsSheet,\n    showResourcesSheet,\n    setShowResourcesSheet,\n    showCustomizeSheet,\n    setShowCustomizeSheet\n  } = useDashboardContext();\n  \n  const { data: notifications = [] } = useNotifications();\n  const { data: deals = [] } = useDealsListing();\n  const { data: tasks = [] } = useTasks();\n  const { data: users = [] } = useUsers();\n  const unreadCount = notifications.filter((n: any) => !n.read).length;\n  const unreadNotifications = notifications.filter((n: any) => !n.read);\n  \n  // Initialize notification sound\n  useEffect(() => {\n    notificationAudioRef.current = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQYAJ5rk/+WxOgAAU+b/+9BQAABU7f/61VcAAFLr//bQVAAAT+f/9MxQAABM4//xyEsAAEne/+7ERAD/Rdn/7MBAAP9C1f/qvDsA/z/R/+i4NgD/PNT/57Q0AP8x0P/krS8A/yjM/+KnKgD/H8j/4KElAP8Vw//enhsA/wzA/92VFgD/A73/25ERAP/6uv/ajw0A//a4/9mMCAD/8rb/2IoDAP/vsf/YhP//+6uu/9eA+//+q6z/1n73//+oqv/Ueu7/');\n    notificationAudioRef.current.volume = 0.7;\n  }, []);\n  \n  // Play sound for new direct notifications\n  useEffect(() => {\n    if (!currentUser || notifications.length === 0) return;\n    \n    const directNotificationTypes = ['task_assigned', 'task_mentioned', 'deal_assigned', 'message', 'mention', 'assigned', 'task'];\n    \n    notifications.forEach((notification: any) => {\n      if (seenNotificationIdsRef.current.has(notification.id)) return;\n      \n      const notificationTime = new Date(notification.createdAt).getTime();\n      const isRecent = notificationTime > notificationMountTimeRef.current - 5000;\n      \n      const notificationType = notification.type?.toLowerCase() || '';\n      const notificationTitle = notification.title?.toLowerCase() || '';\n      const isDirectNotification = directNotificationTypes.some(type => \n        notificationType.includes(type) || notificationTitle.includes(type)\n      ) || notificationTitle.includes('assigned') || notificationTitle.includes('mentioned');\n      \n      seenNotificationIdsRef.current.add(notification.id);\n      \n      if (isRecent && isDirectNotification && !notification.read) {\n        if (notificationAudioRef.current) {\n          notificationAudioRef.current.play().catch(() => {});\n        }\n      }\n    });\n  }, [notifications, currentUser]);\n  \n  const handleLogout = async () => {\n    try {\n      await logoutMutation.mutateAsync();\n      toast.success(\"Logged out successfully\");\n      setLocation(\"/\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to log out\");\n    }\n  };\n  \n  // Profile handlers\n  const handleStartEditProfile = () => {\n    setProfileForm({\n      name: currentUser?.name || '',\n      email: currentUser?.email || '',\n      phone: (currentUser as any)?.phone || '',\n      role: currentUser?.role || '',\n      jobTitle: (currentUser as any)?.jobTitle || '',\n    });\n    setIsEditingProfile(true);\n  };\n\n  const handleCancelEditProfile = () => {\n    setIsEditingProfile(false);\n    setProfileForm({ name: '', email: '', phone: '', role: '', jobTitle: '' });\n  };\n\n  const handleSaveProfile = async () => {\n    if (!currentUser?.id) {\n      toast.error(\"User not found\");\n      return;\n    }\n    \n    try {\n      const updates: { name?: string; email?: string; phone?: string; role?: string; jobTitle?: string } = {};\n      \n      // Only include fields that have changed\n      if (profileForm.name && profileForm.name !== currentUser.name) {\n        updates.name = profileForm.name;\n      }\n      if (profileForm.email && profileForm.email !== currentUser.email) {\n        updates.email = profileForm.email;\n      }\n      if (profileForm.phone !== ((currentUser as any)?.phone || '')) {\n        updates.phone = profileForm.phone;\n      }\n      \n      // Only include role if user is not admin and role has changed\n      if (currentUser.accessLevel !== 'admin' && profileForm.role && profileForm.role !== currentUser.role) {\n        updates.role = profileForm.role;\n      }\n      \n      // Include jobTitle for admins or if role is Custom\n      if (currentUser.accessLevel === 'admin') {\n        // Admins can always set their job title\n        if (profileForm.jobTitle !== ((currentUser as any)?.jobTitle || '')) {\n          updates.jobTitle = profileForm.jobTitle;\n        }\n      } else if (profileForm.role === 'Custom' && profileForm.jobTitle) {\n        updates.jobTitle = profileForm.jobTitle;\n      } else if (profileForm.role !== 'Custom' && (currentUser as any)?.jobTitle) {\n        updates.jobTitle = '';\n      }\n      \n      // Check if there are any updates to make\n      if (Object.keys(updates).length === 0) {\n        toast.info(\"No changes to save\");\n        setIsEditingProfile(false);\n        return;\n      }\n      \n      await updateUserProfile.mutateAsync({\n        userId: currentUser.id,\n        updates,\n      });\n      toast.success(\"Profile updated successfully\");\n      setIsEditingProfile(false);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update profile\");\n    }\n  };\n\n  const handleCancelChangePassword = () => {\n    setIsChangingPassword(false);\n    setPasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '' });\n  };\n\n  const handleChangePassword = async () => {\n    if (!passwordForm.currentPassword || !passwordForm.newPassword || !passwordForm.confirmPassword) {\n      toast.error(\"All password fields are required\");\n      return;\n    }\n    \n    if (passwordForm.newPassword !== passwordForm.confirmPassword) {\n      toast.error(\"New passwords don't match\");\n      return;\n    }\n    \n    if (passwordForm.newPassword.length < 6) {\n      toast.error(\"New password must be at least 6 characters\");\n      return;\n    }\n    \n    if (!currentUser?.id) {\n      toast.error(\"User not found\");\n      return;\n    }\n    \n    try {\n      await changePassword.mutateAsync({\n        userId: currentUser.id,\n        currentPassword: passwordForm.currentPassword,\n        newPassword: passwordForm.newPassword,\n      });\n      toast.success(\"Password changed successfully\");\n      setIsChangingPassword(false);\n      setPasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '' });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to change password\");\n    }\n  };\n  \n  // 2FA handlers\n  const handleStart2FASetup = async () => {\n    try {\n      const result = await setup2FA.mutateAsync();\n      setQrCodeData({ secret: result.secret, qrCode: result.qrCode });\n      setIsSettingUp2FA(true);\n      setTwoFACode('');\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to setup 2FA\");\n    }\n  };\n  \n  const handleVerify2FA = async () => {\n    if (twoFACode.length !== 6) {\n      toast.error(\"Please enter a valid 6-digit code\");\n      return;\n    }\n    try {\n      await verify2FA.mutateAsync(twoFACode);\n      toast.success(\"Two-factor authentication enabled successfully!\");\n      setIsSettingUp2FA(false);\n      setQrCodeData(null);\n      setTwoFACode('');\n    } catch (error: any) {\n      toast.error(error.message || \"Invalid verification code\");\n    }\n  };\n  \n  const handleCancel2FASetup = () => {\n    setIsSettingUp2FA(false);\n    setQrCodeData(null);\n    setTwoFACode('');\n  };\n  \n  const handleDisable2FA = async () => {\n    if (twoFACode.length !== 6) {\n      toast.error(\"Please enter a valid 6-digit code\");\n      return;\n    }\n    try {\n      await disable2FA.mutateAsync(twoFACode);\n      toast.success(\"Two-factor authentication disabled\");\n      setIsDisabling2FA(false);\n      setTwoFACode('');\n    } catch (error: any) {\n      toast.error(error.message || \"Invalid verification code\");\n    }\n  };\n  \n  const handleCancelDisable2FA = () => {\n    setIsDisabling2FA(false);\n    setTwoFACode('');\n  };\n  \n  const copySecretToClipboard = () => {\n    if (qrCodeData?.secret) {\n      navigator.clipboard.writeText(qrCodeData.secret);\n      toast.success(\"Secret key copied to clipboard\");\n    }\n  };\n  \n  const handlePhotoUpload = async (e: ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file || !currentUser?.id) return;\n    \n    // Validate file type\n    if (!file.type.startsWith('image/')) {\n      toast.error(\"Please select an image file\");\n      return;\n    }\n    \n    // Validate file size (max 2MB)\n    if (file.size > 2 * 1024 * 1024) {\n      toast.error(\"Image size must be less than 2MB\");\n      return;\n    }\n    \n    setIsUploadingPhoto(true);\n    \n    try {\n      // Convert to base64 for storage\n      const reader = new FileReader();\n      reader.onloadend = async () => {\n        const base64 = reader.result as string;\n        \n        await updateUserProfile.mutateAsync({\n          userId: currentUser.id,\n          updates: { avatar: base64 },\n        });\n        \n        toast.success(\"Photo uploaded successfully\");\n        setIsUploadingPhoto(false);\n      };\n      reader.onerror = () => {\n        toast.error(\"Failed to read image file\");\n        setIsUploadingPhoto(false);\n      };\n      reader.readAsDataURL(file);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to upload photo\");\n      setIsUploadingPhoto(false);\n    }\n  };\n  \n  const handleRemovePhoto = async () => {\n    if (!currentUser?.id) return;\n    \n    try {\n      await updateUserProfile.mutateAsync({\n        userId: currentUser.id,\n        updates: { avatar: '' },\n      });\n      toast.success(\"Photo removed\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove photo\");\n    }\n  };\n  \n  // Get access level based route prefixes\n  // Use effectiveRole for route prefix to support preview mode\n  const rolePrefix = effectiveRole === 'CEO' ? '/ceo' : '/employee';\n  \n  // Close search results when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {\n        setShowSearchResults(false);\n      }\n    };\n    \n    const handleEscape = (event: KeyboardEvent) => {\n      if (event.key === 'Escape') {\n        setShowSearchResults(false);\n      }\n    };\n    \n    document.addEventListener('mousedown', handleClickOutside);\n    document.addEventListener('keydown', handleEscape);\n    \n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n      document.removeEventListener('keydown', handleEscape);\n    };\n  }, []);\n  \n  const searchResults = useMemo(() => {\n    if (!searchQuery.trim()) return { deals: [], tasks: [], users: [], documents: [] };\n    \n    const query = searchQuery.toLowerCase();\n    \n    // For employees (or admins in preview mode), filter to only show deals where they're on the pod team\n    let accessibleDeals = deals as any[];\n    if (effectiveRole === 'Employee' && currentUser) {\n      accessibleDeals = (deals as any[]).filter((deal: any) => {\n        if (!deal.podTeam || !Array.isArray(deal.podTeam)) return false;\n        return deal.podTeam.some((member: any) => \n          (currentUser.id && member.userId === currentUser.id) ||\n          (currentUser.email && member.email === currentUser.email) ||\n          (currentUser.name && member.name === currentUser.name)\n        );\n      });\n    }\n    \n    const filteredDeals = accessibleDeals.filter((deal: any) => \n      deal.name?.toLowerCase().includes(query) ||\n      deal.client?.toLowerCase().includes(query) ||\n      deal.sector?.toLowerCase().includes(query)\n    ).slice(0, 5);\n    \n    // For employees (or admins in preview mode), filter to only show their own tasks\n    let accessibleTasks = tasks as any[];\n    if (effectiveRole === 'Employee' && currentUser) {\n      accessibleTasks = (tasks as any[]).filter((task: any) => \n        task.assignedTo === currentUser.id\n      );\n    }\n    \n    const filteredTasks = accessibleTasks.filter((task: any) => \n      task.title?.toLowerCase().includes(query) ||\n      task.description?.toLowerCase().includes(query)\n    ).slice(0, 5);\n    \n    // For employees (or admins in preview mode), only show team members (not admin search capability)\n    let accessibleUsers = users as any[];\n    if (effectiveRole === 'Employee') {\n      accessibleUsers = (users as any[]).filter((user: any) => \n        user.accessLevel !== 'admin'\n      );\n    }\n    \n    const filteredUsers = accessibleUsers.filter((user: any) => \n      user.name?.toLowerCase().includes(query) ||\n      user.email?.toLowerCase().includes(query) ||\n      user.role?.toLowerCase().includes(query)\n    ).slice(0, 5);\n    \n    // Search documents across accessible deals\n    const documents: { doc: any; deal: any }[] = [];\n    accessibleDeals.forEach((deal: any) => {\n      const attachments = deal.attachments || [];\n      if (Array.isArray(attachments)) {\n        attachments.forEach((doc: any) => {\n          if (doc.filename?.toLowerCase().includes(query)) {\n            documents.push({ doc, deal });\n          }\n        });\n      }\n    });\n    const filteredDocuments = documents.slice(0, 5);\n    \n    return { deals: filteredDeals, tasks: filteredTasks, users: filteredUsers, documents: filteredDocuments };\n  }, [searchQuery, deals, tasks, users, effectiveRole, currentUser]);\n  \n  const hasResults = searchResults.deals.length > 0 || searchResults.tasks.length > 0 || searchResults.users.length > 0 || searchResults.documents.length > 0;\n  \n  return (\n    <div className=\"min-h-screen bg-background text-foreground font-sans\">\n      {/* Desktop Sidebar - hidden on small screens */}\n      <div className=\"hidden md:block\">\n        <Sidebar role={effectiveRole} collapsed={sidebarCollapsed} />\n      </div>\n      \n      {/* Mobile Sidebar Drawer */}\n      <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>\n        <SheetContent side=\"left\" className=\"p-0 w-64 bg-sidebar border-sidebar-border\">\n          <Sidebar role={effectiveRole} collapsed={false} inMobileDrawer={true} />\n        </SheetContent>\n      </Sheet>\n      \n      <div className={cn(\n        \"flex flex-col min-h-screen transition-all duration-300\",\n        // No left padding on mobile (sidebar is hidden/drawer)\n        \"pl-0\",\n        // Medium screens: collapsed sidebar width\n        \"md:pl-20\",\n        // Large screens: full sidebar width (unless explicitly collapsed)\n        sidebarCollapsed ? \"lg:pl-20\" : \"lg:pl-64\"\n      )}>\n        {/* Header */}\n        <header className=\"h-16 border-b border-border bg-background/80 backdrop-blur-md sticky top-0 z-40 px-3 sm:px-4 md:px-6 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2 sm:gap-4\">\n            {/* Mobile menu button - only shown on small screens */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => setMobileMenuOpen(true)}\n              className=\"w-8 h-8 md:hidden\"\n              data-testid=\"button-mobile-menu\"\n            >\n              <Menu className=\"w-5 h-5\" />\n            </Button>\n            {/* Desktop sidebar toggle - hidden on mobile */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => setSidebarCollapsed(!sidebarCollapsed)}\n              className=\"w-8 h-8 hidden md:flex\"\n              data-testid=\"button-toggle-sidebar\"\n            >\n              {sidebarCollapsed ? <PanelLeft className=\"w-4 h-4\" /> : <PanelLeftClose className=\"w-4 h-4\" />}\n            </Button>\n            <h2 className=\"text-base sm:text-lg font-display font-semibold tracking-tight truncate max-w-[150px] sm:max-w-none\">{pageTitle}</h2>\n          </div>\n          \n          <div className=\"flex items-center gap-4\">\n            <div className=\"relative\" ref={searchRef}>\n              <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n              <input \n                type=\"text\" \n                placeholder=\"Search deals, tasks, users...\" \n                value={searchQuery}\n                onChange={(e) => {\n                  setSearchQuery(e.target.value);\n                  setShowSearchResults(e.target.value.length > 0);\n                }}\n                onFocus={() => searchQuery && setShowSearchResults(true)}\n                className=\"bg-secondary/50 border border-border rounded-full pl-9 pr-8 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary w-40 sm:w-48 md:w-56 lg:w-72 transition-all hover:bg-secondary\"\n                data-testid=\"input-search\"\n              />\n              {searchQuery && (\n                <button \n                  onClick={() => { setSearchQuery(\"\"); setShowSearchResults(false); }}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                >\n                  <X className=\"w-3 h-3\" />\n                </button>\n              )}\n              \n              {showSearchResults && searchQuery && (\n                <div className=\"absolute top-full left-0 right-0 mt-2 bg-card border border-border rounded-lg shadow-xl overflow-hidden z-50\">\n                  {hasResults ? (\n                    <div className=\"max-h-80 overflow-y-auto\">\n                      {searchResults.deals.length > 0 && (\n                        <div>\n                          <div className=\"px-3 py-2 bg-secondary/50 text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                            <Briefcase className=\"w-3 h-3\" /> Deals\n                          </div>\n                          {searchResults.deals.map((deal: any) => (\n                            <button\n                              key={deal.id}\n                              onClick={() => { setLocation(`${rolePrefix}/deals?id=${deal.id}`); setShowSearchResults(false); setSearchQuery(\"\"); }}\n                              className=\"w-full px-3 py-2 text-left hover:bg-primary/10 flex items-center gap-3\"\n                              data-testid={`search-result-deal-${deal.id}`}\n                            >\n                              <div className=\"w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                                <Briefcase className=\"w-4 h-4 text-blue-500\" />\n                              </div>\n                              <div>\n                                <p className=\"text-sm font-medium\">{deal.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">{deal.client}  {deal.sector}</p>\n                              </div>\n                            </button>\n                          ))}\n                        </div>\n                      )}\n                      \n                      {searchResults.tasks.length > 0 && (\n                        <div>\n                          <div className=\"px-3 py-2 bg-secondary/50 text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                            <CheckSquare className=\"w-3 h-3\" /> Tasks\n                          </div>\n                          {searchResults.tasks.map((task: any) => {\n                            const taskDeal = deals.find((d: any) => d.id === task.dealId);\n                            return (\n                              <button\n                                key={task.id}\n                                onClick={() => { \n                                  setSelectedSearchTask({ ...task, dealName: taskDeal?.name || 'No Deal' }); \n                                  setShowTaskDetailModal(true); \n                                  setShowSearchResults(false); \n                                  setSearchQuery(\"\"); \n                                }}\n                                className=\"w-full px-3 py-2 text-left hover:bg-primary/10 flex items-center gap-3\"\n                                data-testid={`search-result-task-${task.id}`}\n                              >\n                                <div className=\"w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center\">\n                                  <CheckSquare className=\"w-4 h-4 text-green-500\" />\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"text-sm font-medium\">{task.title}</p>\n                                  <p className=\"text-xs text-muted-foreground truncate\">{taskDeal?.name || 'No Deal'}  {task.status}</p>\n                                </div>\n                                <Badge variant=\"outline\" className={cn(\n                                  \"text-[10px] shrink-0\",\n                                  task.priority === 'High' ? \"bg-red-500/10 text-red-500 border-red-500/20\" : \n                                  task.priority === 'Medium' ? \"bg-yellow-500/10 text-yellow-500 border-yellow-500/20\" :\n                                  \"bg-blue-500/10 text-blue-500 border-blue-500/20\"\n                                )}>\n                                  {task.priority}\n                                </Badge>\n                              </button>\n                            );\n                          })}\n                        </div>\n                      )}\n                      \n                      {searchResults.users.length > 0 && (\n                        <div>\n                          <div className=\"px-3 py-2 bg-secondary/50 text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                            <Users className=\"w-3 h-3\" /> Team Members\n                          </div>\n                          {searchResults.users.map((user: any) => (\n                            <button\n                              key={user.id}\n                              onClick={() => { \n                                if (effectiveRole === 'CEO') {\n                                  setLocation(`/ceo/team?id=${user.id}`);\n                                } else {\n                                  toast.info(`${user.name}`, {\n                                    description: `${user.jobTitle || user.role}  ${user.email}`,\n                                    duration: 3000,\n                                  });\n                                }\n                                setShowSearchResults(false); \n                                setSearchQuery(\"\"); \n                              }}\n                              className=\"w-full px-3 py-2 text-left hover:bg-primary/10 flex items-center gap-3\"\n                              data-testid={`search-result-user-${user.id}`}\n                            >\n                              <Avatar className=\"w-8 h-8\">\n                                <AvatarFallback className=\"bg-purple-500/10 text-purple-500 text-xs\">\n                                  {user.name?.split(' ').map((n: string) => n[0]).join('').slice(0, 2)}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div>\n                                <p className=\"text-sm font-medium\">{user.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">{user.jobTitle || user.role}  {user.email}</p>\n                              </div>\n                            </button>\n                          ))}\n                        </div>\n                      )}\n                      \n                      {searchResults.documents.length > 0 && (\n                        <div>\n                          <div className=\"px-3 py-2 bg-secondary/50 text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2\">\n                            <FileText className=\"w-3 h-3\" /> Documents\n                          </div>\n                          {searchResults.documents.map((item: any, index: number) => (\n                            <button\n                              key={`${item.deal.id}-${item.doc.id || index}`}\n                              onClick={() => { \n                                if (item.doc.url) {\n                                  window.open(item.doc.url, '_blank');\n                                }\n                                setShowSearchResults(false); \n                                setSearchQuery(\"\"); \n                              }}\n                              className=\"w-full px-3 py-2 text-left hover:bg-primary/10 flex items-center gap-3\"\n                              data-testid={`search-result-doc-${item.doc.id || index}`}\n                            >\n                              <div className=\"w-8 h-8 rounded-full bg-orange-500/10 flex items-center justify-center\">\n                                <FileText className=\"w-4 h-4 text-orange-500\" />\n                              </div>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"text-sm font-medium truncate\">{item.doc.filename}</p>\n                                <p className=\"text-xs text-muted-foreground\">{item.deal.name}  {(item.doc.size / 1024).toFixed(1)} KB</p>\n                              </div>\n                            </button>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ) : (\n                    <div className=\"px-4 py-6 text-center text-muted-foreground\">\n                      <Search className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p className=\"text-sm\">No results found for \"{searchQuery}\"</p>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n            \n            <button \n              className=\"relative p-2 rounded-full hover:bg-secondary transition-colors\"\n              onClick={() => setShowNotificationsSheet(true)}\n              data-testid=\"button-notifications\"\n            >\n              <Bell className=\"w-5 h-5 text-muted-foreground\" />\n              {unreadCount > 0 && (\n                <span className=\"absolute top-1 right-1 w-4 h-4 bg-primary rounded-full border-2 border-background text-[10px] font-bold text-white flex items-center justify-center\">\n                  {unreadCount > 9 ? '9+' : unreadCount}\n                </span>\n              )}\n            </button>\n            \n            <DropdownMenu>\n              <DropdownMenuTrigger className=\"focus:outline-none\" data-testid=\"dropdown-user\">\n                <div className=\"flex items-center gap-3 hover:bg-secondary/50 p-1.5 pr-3 rounded-full transition-colors border border-transparent hover:border-border\">\n                  <Avatar className=\"w-8 h-8 border border-border\">\n                    <AvatarImage src={(currentUser as any)?.avatar || undefined} />\n                    <AvatarFallback className=\"bg-primary text-primary-foreground text-xs\">\n                      {currentUser?.name?.split(' ').map(n => n[0]).join('').slice(0, 2) || 'U'}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div className=\"text-left hidden md:block\">\n                    <p className=\"text-sm font-medium leading-none\">{currentUser?.name || userName}</p>\n                    <p className=\"text-xs text-muted-foreground mt-0.5\">\n                      {(currentUser as any)?.jobTitle || currentUser?.role || 'Team Member'}\n                    </p>\n                  </div>\n                </div>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\" className=\"w-56 bg-card border-border text-card-foreground\">\n                <DropdownMenuLabel>My Account</DropdownMenuLabel>\n                <DropdownMenuSeparator className=\"bg-border\" />\n                <DropdownMenuItem \n                  className=\"focus:bg-primary/10 focus:text-primary cursor-pointer\"\n                  onClick={() => setShowSettingsSheet(true)}\n                  data-testid=\"menu-item-settings\"\n                >\n                  Settings\n                </DropdownMenuItem>\n                <DropdownMenuSeparator className=\"bg-border\" />\n                <DropdownMenuItem \n                  className=\"focus:bg-primary/10 focus:text-primary cursor-pointer\"\n                  onClick={() => setShowResourcesSheet(true)}\n                  data-testid=\"menu-item-resources\"\n                >\n                  <BookOpen className=\"w-4 h-4 mr-2\" />\n                  Resources\n                </DropdownMenuItem>\n                {currentUser?.accessLevel === 'admin' && (\n                  <>\n                    <DropdownMenuItem \n                      className=\"focus:bg-primary/10 focus:text-primary cursor-pointer\"\n                      onClick={() => {\n                        setLocation('/ceo/dashboard');\n                        setTimeout(() => setShowCustomizeSheet(true), 100);\n                      }}\n                      data-testid=\"menu-item-customize\"\n                    >\n                      <Palette className=\"w-4 h-4 mr-2\" />\n                      Customize Dashboard\n                    </DropdownMenuItem>\n                    {/* Preview mode only available to Charles (platform developer) */}\n                    {currentUser?.email === 'cchochos@equiturn.com' && (\n                      <DropdownMenuItem \n                        className=\"focus:bg-primary/10 focus:text-primary cursor-pointer\"\n                        onClick={() => {\n                          const newPreviewMode = !isPreviewMode;\n                          // Set pending navigation first, then toggle state\n                          // The effect will navigate once state is fully updated\n                          setPendingPreviewNav(newPreviewMode ? 'employee' : 'admin');\n                          setIsPreviewMode(newPreviewMode);\n                        }}\n                        data-testid=\"menu-item-preview-mode\"\n                      >\n                        {isPreviewMode ? <Eye className=\"w-4 h-4 mr-2\" /> : <Eye className=\"w-4 h-4 mr-2\" />}\n                        {isPreviewMode ? \"View as Admin\" : \"View as Employee\"}\n                      </DropdownMenuItem>\n                    )}\n                    <DropdownMenuSeparator className=\"bg-border\" />\n                  </>\n                )}\n                <DropdownMenuItem \n                  className=\"text-red-400 focus:bg-red-400/10 focus:text-red-400 cursor-pointer\" \n                  onClick={handleLogout}\n                  disabled={logoutMutation.isPending}\n                  data-testid=\"menu-item-logout\"\n                >\n                  {logoutMutation.isPending ? \"Logging out...\" : \"Log out\"}\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </header>\n\n        {/* Content */}\n        <main className=\"flex-1 p-3 sm:p-4 md:p-6 overflow-y-auto bg-background relative\">\n          {/* Background Grid Pattern */}\n          <div className=\"absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none z-0\"></div>\n          <div className=\"relative z-10\">\n            {children}\n          </div>\n        </main>\n      </div>\n\n      {/* Settings Sheet */}\n      <Sheet open={showSettingsSheet} onOpenChange={setShowSettingsSheet}>\n        <SheetContent className=\"bg-card border-border w-[450px] sm:max-w-[450px]\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <Settings className=\"w-5 h-5 text-primary\" />\n              Settings\n            </SheetTitle>\n            <SheetDescription>Manage your account and preferences</SheetDescription>\n          </SheetHeader>\n          \n          <Tabs defaultValue=\"profile\" className=\"mt-6\">\n            <TabsList className=\"grid w-full grid-cols-4 bg-secondary/50\">\n              <TabsTrigger value=\"profile\" className=\"text-xs\">Profile</TabsTrigger>\n              <TabsTrigger value=\"notifications\" className=\"text-xs\">Alerts</TabsTrigger>\n              <TabsTrigger value=\"display\" className=\"text-xs\">Display</TabsTrigger>\n              <TabsTrigger value=\"account\" className=\"text-xs\">Account</TabsTrigger>\n            </TabsList>\n            \n            {/* Profile Tab */}\n            <TabsContent value=\"profile\" className=\"mt-4\">\n              <ScrollArea className=\"h-[calc(100vh-220px)]\">\n                <div className=\"space-y-6 pr-4\">\n                  {/* Profile Header */}\n                  <div className=\"flex flex-col items-center text-center space-y-3 p-4 bg-secondary/30 rounded-lg\">\n                    <div className=\"relative\">\n                      <Avatar className=\"w-20 h-20 border-2 border-primary/30\">\n                        <AvatarImage src={currentUser?.avatar || undefined} />\n                        <AvatarFallback className=\"bg-primary/20 text-primary text-xl font-bold\">\n                          {(currentUser?.name || userName || 'U').split(' ').map(n => n[0]).join('').toUpperCase()}\n                        </AvatarFallback>\n                      </Avatar>\n                      <input\n                        type=\"file\"\n                        ref={photoInputRef}\n                        accept=\"image/*\"\n                        className=\"hidden\"\n                        onChange={handlePhotoUpload}\n                      />\n                      <Button\n                        size=\"sm\"\n                        variant=\"secondary\"\n                        className=\"absolute -bottom-1 -right-1 rounded-full w-7 h-7 p-0\"\n                        onClick={() => photoInputRef.current?.click()}\n                        disabled={isUploadingPhoto}\n                        data-testid=\"button-change-photo\"\n                      >\n                        {isUploadingPhoto ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : <Camera className=\"w-3 h-3\" />}\n                      </Button>\n                    </div>\n                    <div>\n                      <h3 className=\"font-semibold text-lg\">{currentUser?.name || userName}</h3>\n                      <Badge variant=\"outline\" className=\"mt-1 text-primary border-primary/30\">\n                        {(currentUser as any)?.jobTitle || currentUser?.role || 'Team Member'}\n                      </Badge>\n                    </div>\n                  </div>\n\n                  {/* Profile Details */}\n                  {isEditingProfile ? (\n                    <div className=\"space-y-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"profile-name\">Full Name</Label>\n                        <Input\n                          id=\"profile-name\"\n                          value={profileForm.name}\n                          onChange={(e) => setProfileForm({ ...profileForm, name: e.target.value })}\n                          placeholder=\"Enter your name\"\n                          data-testid=\"input-profile-name\"\n                        />\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"profile-email\">Email Address</Label>\n                        <Input\n                          id=\"profile-email\"\n                          type=\"email\"\n                          value={profileForm.email}\n                          onChange={(e) => setProfileForm({ ...profileForm, email: e.target.value })}\n                          placeholder=\"Enter your email\"\n                          data-testid=\"input-profile-email\"\n                        />\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"profile-phone\">Phone Number</Label>\n                        <Input\n                          id=\"profile-phone\"\n                          type=\"tel\"\n                          value={profileForm.phone}\n                          onChange={(e) => setProfileForm({ ...profileForm, phone: e.target.value })}\n                          placeholder=\"Enter phone number\"\n                          data-testid=\"input-profile-phone\"\n                        />\n                      </div>\n                      \n                      {currentUser?.accessLevel !== 'admin' && (\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"profile-role\">Role</Label>\n                          <Select\n                            value={profileForm.role}\n                            onValueChange={(value) => setProfileForm({ ...profileForm, role: value })}\n                          >\n                            <SelectTrigger data-testid=\"select-profile-role\">\n                              <SelectValue placeholder=\"Select role\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"Analyst\">Analyst</SelectItem>\n                              <SelectItem value=\"Associate\">Associate</SelectItem>\n                              <SelectItem value=\"Director\">Director</SelectItem>\n                              <SelectItem value=\"Managing Director\">Managing Director</SelectItem>\n                              <SelectItem value=\"Custom\">Custom Title</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      )}\n                      \n                      {/* Job title field for admins or when role is Custom */}\n                      {(currentUser?.accessLevel === 'admin' || profileForm.role === 'Custom') && (\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"profile-job-title\">Job Title</Label>\n                          <Input\n                            id=\"profile-job-title\"\n                            value={profileForm.jobTitle}\n                            onChange={(e) => setProfileForm({ ...profileForm, jobTitle: e.target.value })}\n                            placeholder={currentUser?.accessLevel === 'admin' ? \"e.g., CEO, CFO, Partner\" : \"Enter your job title\"}\n                            data-testid=\"input-profile-job-title\"\n                          />\n                          {currentUser?.accessLevel === 'admin' && (\n                            <p className=\"text-xs text-muted-foreground\">This title will be displayed under your name</p>\n                          )}\n                        </div>\n                      )}\n                      \n                      <div className=\"flex gap-2 pt-2\">\n                        <Button \n                          variant=\"outline\" \n                          onClick={handleCancelEditProfile}\n                          className=\"flex-1\"\n                          data-testid=\"button-cancel-profile\"\n                        >\n                          Cancel\n                        </Button>\n                        <Button \n                          onClick={handleSaveProfile}\n                          disabled={updateUserProfile.isPending}\n                          className=\"flex-1\"\n                          data-testid=\"button-save-profile\"\n                        >\n                          {updateUserProfile.isPending ? \"Saving...\" : \"Save Changes\"}\n                        </Button>\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <Mail className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Email</p>\n                            <p className=\"text-sm font-medium truncate\">{currentUser?.email || 'Not set'}</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Phone</p>\n                            <p className=\"text-sm font-medium\">{(currentUser as any)?.phone || 'Not set'}</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <Briefcase className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Department</p>\n                            <p className=\"text-sm font-medium\">Investment Banking</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <Target className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Performance Score</p>\n                            <p className=\"text-sm font-medium\">{currentUser?.score || 0}%</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <CheckSquare className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Tasks Completed</p>\n                            <p className=\"text-sm font-medium\">{currentUser?.completedTasks || 0}</p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\">\n                          <Briefcase className=\"w-4 h-4 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs text-muted-foreground\">Active Deals</p>\n                            <p className=\"text-sm font-medium\">{currentUser?.activeDeals || 0}</p>\n                          </div>\n                        </div>\n                      </div>\n                      \n                      <Button \n                        variant=\"outline\" \n                        className=\"w-full\"\n                        onClick={handleStartEditProfile}\n                        data-testid=\"button-edit-profile\"\n                      >\n                        <Pencil className=\"w-4 h-4 mr-2\" />\n                        Edit Profile\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </ScrollArea>\n            </TabsContent>\n            \n            {/* Notifications Tab */}\n            <TabsContent value=\"notifications\" className=\"mt-4 space-y-4\">\n              <div className=\"space-y-4\">\n                <h4 className=\"text-sm font-medium\">Email Preferences</h4>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Deal Updates</Label>\n                      <p className=\"text-xs text-muted-foreground\">Notifications about deals you're assigned to</p>\n                    </div>\n                    <Switch \n                      checked={settings.dealUpdates} \n                      onCheckedChange={(checked) => updateSetting('dealUpdates', checked)} \n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Task Reminders</Label>\n                      <p className=\"text-xs text-muted-foreground\">Reminders for upcoming due dates</p>\n                    </div>\n                    <Switch \n                      checked={settings.taskReminders} \n                      onCheckedChange={(checked) => updateSetting('taskReminders', checked)} \n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Team Activity</Label>\n                      <p className=\"text-xs text-muted-foreground\">Updates when teammates make changes</p>\n                    </div>\n                    <Switch \n                      checked={settings.teamActivity} \n                      onCheckedChange={(checked) => updateSetting('teamActivity', checked)} \n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Weekly Summary</Label>\n                      <p className=\"text-xs text-muted-foreground\">Weekly digest of your activity</p>\n                    </div>\n                    <Switch \n                      checked={settings.weeklySummary} \n                      onCheckedChange={(checked) => updateSetting('weeklySummary', checked)} \n                    />\n                  </div>\n                </div>\n              </div>\n              \n              <Separator />\n              \n              <div className=\"space-y-4\">\n                <h4 className=\"text-sm font-medium\">Push Notifications</h4>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"text-sm\">Desktop Alerts</Label>\n                    <p className=\"text-xs text-muted-foreground\">Browser push notifications</p>\n                  </div>\n                  <Switch \n                    checked={settings.desktopAlerts} \n                    onCheckedChange={(checked) => updateSetting('desktopAlerts', checked)} \n                  />\n                </div>\n              </div>\n            </TabsContent>\n            \n            {/* Display Tab */}\n            <TabsContent value=\"display\" className=\"mt-4 space-y-4\">\n              <div className=\"space-y-4\">\n                <h4 className=\"text-sm font-medium\">Appearance</h4>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Dark Mode</Label>\n                      <p className=\"text-xs text-muted-foreground\">Use dark theme</p>\n                    </div>\n                    <Switch \n                      checked={settings.darkMode} \n                      onCheckedChange={(checked) => updateSetting('darkMode', checked)} \n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Compact View</Label>\n                      <p className=\"text-xs text-muted-foreground\">Show more data in less space</p>\n                    </div>\n                    <Switch \n                      checked={settings.compactView} \n                      onCheckedChange={(checked) => updateSetting('compactView', checked)} \n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-sm\">Animations</Label>\n                      <p className=\"text-xs text-muted-foreground\">Enable UI animations</p>\n                    </div>\n                    <Switch \n                      checked={settings.animations} \n                      onCheckedChange={(checked) => updateSetting('animations', checked)} \n                    />\n                  </div>\n                </div>\n              </div>\n              \n              <Separator />\n              \n              <div className=\"space-y-4\">\n                <h4 className=\"text-sm font-medium\">Data</h4>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"text-sm\">Auto-refresh</Label>\n                    <p className=\"text-xs text-muted-foreground\">Update data automatically</p>\n                  </div>\n                  <Switch \n                    checked={settings.autoRefresh} \n                    onCheckedChange={(checked) => updateSetting('autoRefresh', checked)} \n                  />\n                </div>\n              </div>\n            </TabsContent>\n            \n            {/* Account Tab */}\n            <TabsContent value=\"account\" className=\"mt-4 space-y-4\">\n              {isChangingPassword ? (\n                <div className=\"space-y-4\">\n                  <h4 className=\"text-sm font-medium\">Change Password</h4>\n                  \n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"current-password\">Current Password</Label>\n                    <Input\n                      id=\"current-password\"\n                      type=\"password\"\n                      value={passwordForm.currentPassword}\n                      onChange={(e) => setPasswordForm({ ...passwordForm, currentPassword: e.target.value })}\n                      placeholder=\"Enter current password\"\n                      data-testid=\"input-current-password\"\n                    />\n                  </div>\n                  \n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"new-password\">New Password</Label>\n                    <Input\n                      id=\"new-password\"\n                      type=\"password\"\n                      value={passwordForm.newPassword}\n                      onChange={(e) => setPasswordForm({ ...passwordForm, newPassword: e.target.value })}\n                      placeholder=\"Enter new password (min 6 characters)\"\n                      data-testid=\"input-new-password\"\n                    />\n                  </div>\n                  \n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"confirm-password\">Confirm New Password</Label>\n                    <Input\n                      id=\"confirm-password\"\n                      type=\"password\"\n                      value={passwordForm.confirmPassword}\n                      onChange={(e) => setPasswordForm({ ...passwordForm, confirmPassword: e.target.value })}\n                      placeholder=\"Confirm new password\"\n                      data-testid=\"input-confirm-password\"\n                    />\n                  </div>\n                  \n                  <div className=\"flex gap-2 pt-2\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={handleCancelChangePassword}\n                      className=\"flex-1\"\n                      data-testid=\"button-cancel-password\"\n                    >\n                      Cancel\n                    </Button>\n                    <Button \n                      onClick={handleChangePassword}\n                      disabled={changePassword.isPending}\n                      className=\"flex-1\"\n                      data-testid=\"button-save-password\"\n                    >\n                      {changePassword.isPending ? \"Changing...\" : \"Change Password\"}\n                    </Button>\n                  </div>\n                </div>\n              ) : isSettingUp2FA ? (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <Shield className=\"w-5 h-5 text-primary\" />\n                    <h4 className=\"text-sm font-medium\">Setup Two-Factor Authentication</h4>\n                  </div>\n                  \n                  <div className=\"p-4 bg-secondary/30 rounded-lg space-y-4\">\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-muted-foreground mb-4\">\n                        Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)\n                      </p>\n                      {qrCodeData?.qrCode && (\n                        <div className=\"flex justify-center mb-4\">\n                          <img \n                            src={qrCodeData.qrCode} \n                            alt=\"2FA QR Code\" \n                            className=\"w-48 h-48 bg-white p-2 rounded-lg\"\n                            data-testid=\"img-2fa-qr-code\"\n                          />\n                        </div>\n                      )}\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label className=\"text-xs text-muted-foreground\">Or enter this secret key manually:</Label>\n                      <div className=\"flex items-center gap-2\">\n                        <code className=\"flex-1 p-2 bg-background rounded text-xs font-mono break-all\">\n                          {qrCodeData?.secret}\n                        </code>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={copySecretToClipboard}\n                          data-testid=\"button-copy-2fa-secret\"\n                        >\n                          <Copy className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                    \n                    <Separator />\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"2fa-code\">Enter verification code from your app:</Label>\n                      <Input\n                        id=\"2fa-code\"\n                        type=\"text\"\n                        inputMode=\"numeric\"\n                        pattern=\"[0-9]*\"\n                        maxLength={6}\n                        value={twoFACode}\n                        onChange={(e) => setTwoFACode(e.target.value.replace(/\\D/g, ''))}\n                        placeholder=\"Enter 6-digit code\"\n                        className=\"text-center text-lg tracking-widest font-mono\"\n                        data-testid=\"input-2fa-verify-code\"\n                      />\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex gap-2 pt-2\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={handleCancel2FASetup}\n                      className=\"flex-1\"\n                      data-testid=\"button-cancel-2fa-setup\"\n                    >\n                      Cancel\n                    </Button>\n                    <Button \n                      onClick={handleVerify2FA}\n                      disabled={verify2FA.isPending || twoFACode.length !== 6}\n                      className=\"flex-1\"\n                      data-testid=\"button-verify-2fa\"\n                    >\n                      {verify2FA.isPending ? \"Verifying...\" : \"Enable 2FA\"}\n                    </Button>\n                  </div>\n                </div>\n              ) : isDisabling2FA ? (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <ShieldOff className=\"w-5 h-5 text-red-400\" />\n                    <h4 className=\"text-sm font-medium\">Disable Two-Factor Authentication</h4>\n                  </div>\n                  \n                  <div className=\"p-4 bg-red-500/10 border border-red-500/30 rounded-lg space-y-4\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      To disable two-factor authentication, enter the current code from your authenticator app.\n                    </p>\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"2fa-disable-code\">Verification Code:</Label>\n                      <Input\n                        id=\"2fa-disable-code\"\n                        type=\"text\"\n                        inputMode=\"numeric\"\n                        pattern=\"[0-9]*\"\n                        maxLength={6}\n                        value={twoFACode}\n                        onChange={(e) => setTwoFACode(e.target.value.replace(/\\D/g, ''))}\n                        placeholder=\"Enter 6-digit code\"\n                        className=\"text-center text-lg tracking-widest font-mono\"\n                        data-testid=\"input-2fa-disable-code\"\n                      />\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex gap-2 pt-2\">\n                    <Button \n                      variant=\"outline\" \n                      onClick={handleCancelDisable2FA}\n                      className=\"flex-1\"\n                      data-testid=\"button-cancel-disable-2fa\"\n                    >\n                      Cancel\n                    </Button>\n                    <Button \n                      variant=\"destructive\"\n                      onClick={handleDisable2FA}\n                      disabled={disable2FA.isPending || twoFACode.length !== 6}\n                      className=\"flex-1\"\n                      data-testid=\"button-confirm-disable-2fa\"\n                    >\n                      {disable2FA.isPending ? \"Disabling...\" : \"Disable 2FA\"}\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                <>\n                  <div className=\"space-y-4\">\n                    <h4 className=\"text-sm font-medium\">Security</h4>\n                    <Button variant=\"outline\" className=\"w-full justify-start\" onClick={() => setIsChangingPassword(true)}>\n                      <Lock className=\"w-4 h-4 mr-2\" /> Change Password\n                    </Button>\n                    \n                    {twoFALoading ? (\n                      <div className=\"flex items-center justify-center p-4\">\n                        <Loader2 className=\"w-5 h-5 animate-spin text-muted-foreground\" />\n                      </div>\n                    ) : twoFAStatus?.enabled ? (\n                      <div className=\"p-4 bg-green-500/10 border border-green-500/30 rounded-lg space-y-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <ShieldCheck className=\"w-5 h-5 text-green-500\" />\n                          <div>\n                            <Label className=\"text-sm text-green-400\">Two-Factor Authentication Enabled</Label>\n                            <p className=\"text-xs text-muted-foreground\">Your account is protected with 2FA</p>\n                          </div>\n                        </div>\n                        <Button \n                          variant=\"outline\" \n                          className=\"w-full text-red-400 border-red-400/30 hover:bg-red-500/10\"\n                          onClick={() => setIsDisabling2FA(true)}\n                          data-testid=\"button-start-disable-2fa\"\n                        >\n                          <ShieldOff className=\"w-4 h-4 mr-2\" /> Disable 2FA\n                        </Button>\n                      </div>\n                    ) : (\n                      <div className=\"p-4 bg-secondary/30 rounded-lg space-y-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <Shield className=\"w-5 h-5 text-muted-foreground\" />\n                          <div>\n                            <Label className=\"text-sm\">Two-Factor Authentication</Label>\n                            <p className=\"text-xs text-muted-foreground\">Add an extra layer of security</p>\n                          </div>\n                        </div>\n                        <Button \n                          variant=\"outline\" \n                          className=\"w-full\"\n                          onClick={handleStart2FASetup}\n                          disabled={setup2FA.isPending}\n                          data-testid=\"button-setup-2fa\"\n                        >\n                          {setup2FA.isPending ? (\n                            <>\n                              <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> Setting up...\n                            </>\n                          ) : (\n                            <>\n                              <Smartphone className=\"w-4 h-4 mr-2\" /> Setup 2FA\n                            </>\n                          )}\n                        </Button>\n                      </div>\n                    )}\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div className=\"space-y-4\">\n                    <h4 className=\"text-sm font-medium text-red-400\">Danger Zone</h4>\n                    <Button variant=\"outline\" className=\"w-full justify-start text-yellow-500 border-yellow-500/30 hover:bg-yellow-500/10\">\n                      Deactivate Account\n                    </Button>\n                    <Button variant=\"outline\" className=\"w-full justify-start text-red-500 border-red-500/30 hover:bg-red-500/10\">\n                      Delete Account\n                    </Button>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Deleting your account is permanent and cannot be undone. Contact support if you need assistance.\n                    </p>\n                  </div>\n                </>\n              )}\n            </TabsContent>\n          </Tabs>\n        </SheetContent>\n      </Sheet>\n\n      {/* Resources Sheet */}\n      <Sheet open={showResourcesSheet} onOpenChange={setShowResourcesSheet}>\n        <SheetContent className=\"bg-card border-border w-[500px] sm:max-w-[500px]\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <BookOpen className=\"w-5 h-5 text-primary\" />\n              Resources\n            </SheetTitle>\n            <SheetDescription>Help documentation and useful resources.</SheetDescription>\n          </SheetHeader>\n          <ScrollArea className=\"h-[calc(100vh-120px)] mt-6 pr-4\">\n            <div className=\"space-y-4\">\n              {/* Quick Links */}\n              <div className=\"grid grid-cols-2 gap-3\">\n                <a \n                  href=\"https://www.equiturn.com\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"block p-4 bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors cursor-pointer border border-primary/20\"\n                  data-testid=\"resource-my-organization\"\n                >\n                  <Briefcase className=\"w-5 h-5 text-primary mb-2\" />\n                  <h4 className=\"font-medium text-sm\">My Organization</h4>\n                  <p className=\"text-xs text-muted-foreground mt-1\">Visit Equiturn's website</p>\n                </a>\n                <a \n                  href=\"https://www.equiturn.com/contact\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"block p-4 bg-secondary/30 rounded-lg hover:bg-secondary/50 transition-colors cursor-pointer\"\n                  data-testid=\"resource-contact-support\"\n                >\n                  <Mail className=\"w-5 h-5 text-primary mb-2\" />\n                  <h4 className=\"font-medium text-sm\">Contact Support</h4>\n                  <p className=\"text-xs text-muted-foreground mt-1\">Get help from our team</p>\n                </a>\n              </div>\n\n              <Separator />\n\n              {/* Documentation Sections */}\n              <div>\n                <h4 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3\">Documentation</h4>\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  {/* Get Started */}\n                  <AccordionItem value=\"get-started\" className=\"border-border\">\n                    <AccordionTrigger className=\"hover:no-underline py-3\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center\">\n                          <Rocket className=\"w-4 h-4 text-green-500\" />\n                        </div>\n                        <div className=\"text-left\">\n                          <p className=\"font-medium text-sm\">Get Started with Kronos</p>\n                          <p className=\"text-xs text-muted-foreground\">Learn the basics of the platform</p>\n                        </div>\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"text-sm text-muted-foreground space-y-4 pt-2\">\n                      <div className=\"bg-secondary/30 rounded-lg p-4 space-y-3\">\n                        <h5 className=\"font-medium text-foreground\">Welcome to Kronos</h5>\n                        <p>Kronos is your comprehensive investment banking operations platform designed to streamline deal management, task assignments, and investor relations.</p>\n                        \n                        <h5 className=\"font-medium text-foreground mt-4\">Quick Start Guide</h5>\n                        <ol className=\"list-decimal list-inside space-y-2\">\n                          <li><strong>Dashboard Overview:</strong> Your central hub showing active deals, tasks, and team performance metrics.</li>\n                          <li><strong>Navigation:</strong> Use the left sidebar to access all platform features. Click the collapse button to minimize the sidebar.</li>\n                          <li><strong>Profile Settings:</strong> Click your avatar in the top-right to access profile, settings, and resources.</li>\n                          <li><strong>Search:</strong> Use the search bar to quickly find deals, tasks, or team members.</li>\n                        </ol>\n\n                        <h5 className=\"font-medium text-foreground mt-4\">Key Features</h5>\n                        <ul className=\"list-disc list-inside space-y-1\">\n                          <li>Real-time deal pipeline tracking</li>\n                          <li>AI-powered document generation</li>\n                          <li>Investor matching algorithm</li>\n                          <li>Team task assignment and tracking</li>\n                          <li>In-platform messaging and collaboration</li>\n                        </ul>\n\n                        <h5 className=\"font-medium text-foreground mt-4\">Getting Help</h5>\n                        <p>If you need assistance, click \"Contact Support\" above or reach out to your team administrator.</p>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  {/* Managing Deals */}\n                  <AccordionItem value=\"managing-deals\" className=\"border-border\">\n                    <AccordionTrigger className=\"hover:no-underline py-3\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center\">\n                          <TrendingUp className=\"w-4 h-4 text-blue-500\" />\n                        </div>\n                        <div className=\"text-left\">\n                          <p className=\"font-medium text-sm\">Managing Deals</p>\n                          <p className=\"text-xs text-muted-foreground\">Complete deal lifecycle guide</p>\n                        </div>\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"text-sm text-muted-foreground space-y-4 pt-2\">\n                      <div className=\"bg-secondary/30 rounded-lg p-4 space-y-3\">\n                        <h5 className=\"font-medium text-foreground\">Deal Lifecycle Overview</h5>\n                        <p>Successfully closing a deal requires careful management through five key stages:</p>\n                        \n                        <div className=\"space-y-3 mt-3\">\n                          <div className=\"border-l-2 border-blue-500 pl-3\">\n                            <h6 className=\"font-medium text-foreground\">1. Origination</h6>\n                            <p className=\"text-xs\">Identify and qualify potential deals. Create the deal record with client information, sector, and estimated value. Assign initial team members.</p>\n                          </div>\n                          <div className=\"border-l-2 border-purple-500 pl-3\">\n                            <h6 className=\"font-medium text-foreground\">2. Structuring</h6>\n                            <p className=\"text-xs\">Develop the deal structure, valuation models, and preliminary terms. Generate initial documentation and create task assignments for team members.</p>\n                          </div>\n                          <div className=\"border-l-2 border-yellow-500 pl-3\">\n                            <h6 className=\"font-medium text-foreground\">3. Diligence</h6>\n                            <p className=\"text-xs\">Conduct thorough due diligence. Coordinate information requests, review financials, and identify potential risks. Track progress with milestone tasks.</p>\n                          </div>\n                          <div className=\"border-l-2 border-orange-500 pl-3\">\n                            <h6 className=\"font-medium text-foreground\">4. Legal</h6>\n                            <p className=\"text-xs\">Draft and negotiate legal documents. Coordinate with external counsel, manage document revisions, and ensure compliance requirements are met.</p>\n                          </div>\n                          <div className=\"border-l-2 border-green-500 pl-3\">\n                            <h6 className=\"font-medium text-foreground\">5. Close</h6>\n                            <p className=\"text-xs\">Finalize all documentation, complete closing checklists, and execute the transaction. Update deal status and archive relevant materials.</p>\n                          </div>\n                        </div>\n\n                        <h5 className=\"font-medium text-foreground mt-4\">Best Practices</h5>\n                        <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                          <li>Update deal progress regularly to keep stakeholders informed</li>\n                          <li>Assign clear task owners and deadlines for each milestone</li>\n                          <li>Use the document generator for consistent, professional deliverables</li>\n                          <li>Tag relevant investors early using the Investor Match feature</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  {/* Investor Matching */}\n                  <AccordionItem value=\"investor-matching\" className=\"border-border\">\n                    <AccordionTrigger className=\"hover:no-underline py-3\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center\">\n                          <UserCheck className=\"w-4 h-4 text-purple-500\" />\n                        </div>\n                        <div className=\"text-left\">\n                          <p className=\"font-medium text-sm\">Investor Matching</p>\n                          <p className=\"text-xs text-muted-foreground\">Find the right investors for deals</p>\n                        </div>\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"text-sm text-muted-foreground space-y-4 pt-2\">\n                      <div className=\"bg-secondary/30 rounded-lg p-4 space-y-3\">\n                        <h5 className=\"font-medium text-foreground\">Investor Matching Overview</h5>\n                        <p>Kronos's intelligent investor matching system helps you identify the most suitable investors for each deal based on multiple criteria.</p>\n                        \n                        <h5 className=\"font-medium text-foreground mt-4\">How Matching Works</h5>\n                        <ol className=\"list-decimal list-inside space-y-2 text-xs\">\n                          <li><strong>Sector Alignment:</strong> The system analyzes investor portfolio history and sector preferences.</li>\n                          <li><strong>Investment Size:</strong> Matches based on typical investment ranges and fund capacity.</li>\n                          <li><strong>Geographic Focus:</strong> Considers regional preferences and portfolio concentration.</li>\n                          <li><strong>Stage Preference:</strong> Aligns deal stage with investor maturity preferences.</li>\n                          <li><strong>Historical Performance:</strong> Factors in past successful investments in similar deals.</li>\n                        </ol>\n\n                        <h5 className=\"font-medium text-foreground mt-4\">Using the Investor Match Feature</h5>\n                        <ol className=\"list-decimal list-inside space-y-2 text-xs\">\n                          <li>Navigate to the Investor Match section from the sidebar</li>\n                          <li>Select or create a deal to match investors against</li>\n                          <li>Review the match scores and investor profiles</li>\n                          <li>Tag promising investors directly to the deal</li>\n                          <li>Track investor outreach and response status</li>\n                        </ol>\n\n                        <h5 className=\"font-medium text-foreground mt-4\">Tips for Success</h5>\n                        <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                          <li>Keep investor profiles updated with recent activity</li>\n                          <li>Use match scores as a guide, not absolute rankings</li>\n                          <li>Consider relationship history when prioritizing outreach</li>\n                          <li>Document all investor interactions for team visibility</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n                </Accordion>\n              </div>\n            </div>\n          </ScrollArea>\n        </SheetContent>\n      </Sheet>\n\n      {/* Notifications Sheet */}\n      <Sheet open={showNotificationsSheet} onOpenChange={(open) => {\n        setShowNotificationsSheet(open);\n        if (!open) {\n          unreadNotifications.forEach((notification: any) => {\n            markNotificationRead.mutate(notification.id);\n          });\n        }\n      }}>\n        <SheetContent className=\"bg-card border-border\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <Bell className=\"w-5 h-5 text-primary\" />\n              Notifications\n              {unreadNotifications.length > 0 && (\n                <Badge variant=\"destructive\" className=\"ml-2\">{unreadNotifications.length}</Badge>\n              )}\n            </SheetTitle>\n            <SheetDescription>Recent alerts and updates.</SheetDescription>\n          </SheetHeader>\n          <ScrollArea className=\"mt-6 h-[calc(100vh-200px)]\">\n            {notifications.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Bell className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                <p>No notifications yet</p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {notifications.map((notification: any) => (\n                  <div \n                    key={notification.id} \n                    className={cn(\n                      \"p-4 rounded-lg border transition-colors cursor-pointer hover:bg-primary/10\",\n                      notification.read \n                        ? \"bg-secondary/20 border-border\" \n                        : \"bg-primary/5 border-primary/20\"\n                    )}\n                    onClick={() => {\n                      if (!notification.read) {\n                        markNotificationRead.mutate(notification.id);\n                      }\n                      setShowNotificationsSheet(false);\n                      if (notification.link) {\n                        let link = notification.link;\n                        const isCeoRole = effectiveRole === 'CEO';\n                        const linkMap: Record<string, string> = {\n                          '/ceo/users': '/ceo/admin',\n                          '/mentorship': isCeoRole ? '/ceo/mentorship' : '/employee/home',\n                          '/chat': isCeoRole ? '/ceo/chat' : '/employee/chat',\n                          '/ceo/chat': isCeoRole ? '/ceo/chat' : '/employee/chat',\n                          '/ceo/dashboard': isCeoRole ? '/ceo/dashboard' : '/employee/home',\n                          '/ceo/calendar': isCeoRole ? '/ceo/calendar' : '/employee/calendar',\n                          '/ceo/mentorship': isCeoRole ? '/ceo/mentorship' : '/employee/home',\n                        };\n                        if (linkMap[link]) {\n                          link = linkMap[link];\n                        } else if (!isCeoRole && link.startsWith('/ceo/')) {\n                          link = link.replace('/ceo/', '/employee/');\n                        }\n                        setLocation(link);\n                      } else {\n                        const title = notification.title?.toLowerCase() || '';\n                        const message = notification.message?.toLowerCase() || '';\n                        const isCeoRole = effectiveRole === 'CEO';\n                        if (title.includes('deal') || message.includes('deal')) {\n                          setLocation(isCeoRole ? '/ceo/deals' : '/employee/deals');\n                        } else if (title.includes('task') || message.includes('task')) {\n                          setLocation(isCeoRole ? '/ceo/dashboard' : '/employee/tasks');\n                        } else if (title.includes('meeting') || message.includes('meeting') || title.includes('calendar')) {\n                          setLocation(isCeoRole ? '/ceo/calendar' : '/employee/calendar');\n                        } else if (title.includes('document') || message.includes('document')) {\n                          setLocation(isCeoRole ? '/ceo/document-library' : '/employee/document-library');\n                        } else if (title.includes('user') || message.includes('approved') || message.includes('pending')) {\n                          setLocation('/ceo/team');\n                        } else if (title.includes('investor') || message.includes('investor')) {\n                          setLocation(isCeoRole ? '/ceo/investors' : '/employee/investors');\n                        } else if (title.includes('announcement')) {\n                          setLocation(isCeoRole ? '/ceo/announcements' : '/employee/announcements');\n                        } else {\n                          setLocation(isCeoRole ? '/ceo/dashboard' : '/employee/home');\n                        }\n                      }\n                    }}\n                  >\n                    <div className=\"flex items-start gap-3\">\n                      <div className={cn(\n                        \"w-8 h-8 rounded-full flex items-center justify-center\",\n                        notification.type === 'info' && \"bg-blue-500/10 text-blue-500\",\n                        notification.type === 'success' && \"bg-green-500/10 text-green-500\",\n                        notification.type === 'warning' && \"bg-yellow-500/10 text-yellow-500\",\n                        notification.type === 'error' && \"bg-red-500/10 text-red-500\"\n                      )}>\n                        {notification.type === 'info' && <Info className=\"w-4 h-4\" />}\n                        {notification.type === 'success' && <Check className=\"w-4 h-4\" />}\n                        {notification.type === 'warning' && <AlertCircle className=\"w-4 h-4\" />}\n                        {notification.type === 'error' && <X className=\"w-4 h-4\" />}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between\">\n                          <p className=\"text-sm font-medium\">{notification.title}</p>\n                          <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-1\">{notification.message}</p>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </ScrollArea>\n        </SheetContent>\n      </Sheet>\n\n      {/* Task Detail Modal from Search */}\n      <Dialog open={showTaskDetailModal} onOpenChange={setShowTaskDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{selectedSearchTask?.title}</DialogTitle>\n            <DialogDescription>Task Details</DialogDescription>\n          </DialogHeader>\n          {selectedSearchTask && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <Badge variant=\"outline\" className={cn(\n                  \"text-xs\",\n                  selectedSearchTask.priority === 'High' ? \"bg-red-500/10 text-red-500 border-red-500/20\" : \n                  selectedSearchTask.priority === 'Medium' ? \"bg-yellow-500/10 text-yellow-500 border-yellow-500/20\" :\n                  \"bg-blue-500/10 text-blue-500 border-blue-500/20\"\n                )}>\n                  {selectedSearchTask.priority} Priority\n                </Badge>\n                <Badge variant=\"secondary\">{selectedSearchTask.type}</Badge>\n                <Badge variant={selectedSearchTask.status === 'Completed' ? 'default' : 'outline'}>\n                  {selectedSearchTask.status}\n                </Badge>\n              </div>\n              \n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Description</Label>\n                <p className=\"text-sm mt-1\">{selectedSearchTask.description || 'No description provided'}</p>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Project / Deal</Label>\n                  <p className=\"text-sm mt-1 flex items-center gap-1\">\n                    <Briefcase className=\"w-3 h-3 text-primary\" />\n                    {selectedSearchTask.dealName}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Due Date</Label>\n                  <p className=\"text-sm mt-1 flex items-center gap-1\">\n                    <Calendar className=\"w-3 h-3 text-muted-foreground\" />\n                    {selectedSearchTask.dueDate || 'No due date'}\n                  </p>\n                </div>\n              </div>\n              \n              {selectedSearchTask.assignedTo && (\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Assigned To</Label>\n                  <div className=\"flex items-center gap-2 mt-1\">\n                    <Avatar className=\"w-6 h-6\">\n                      <AvatarFallback className=\"bg-primary/10 text-primary text-xs\">\n                        {users.find((u: any) => u.id === selectedSearchTask.assignedTo)?.name?.charAt(0) || '?'}\n                      </AvatarFallback>\n                    </Avatar>\n                    <span className=\"text-sm\">{users.find((u: any) => u.id === selectedSearchTask.assignedTo)?.name || 'Unknown'}</span>\n                  </div>\n                </div>\n              )}\n              \n              {selectedSearchTask.attachments && Array.isArray(selectedSearchTask.attachments) && selectedSearchTask.attachments.length > 0 && (\n                <div>\n                  <Label className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                    <Paperclip className=\"w-3 h-3\" /> Attachments\n                  </Label>\n                  <div className=\"mt-2 space-y-2\">\n                    {selectedSearchTask.attachments.map((attachment: any, i: number) => (\n                      <div key={i} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                        <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"text-sm flex-1 truncate\">{typeof attachment === 'string' ? attachment : attachment?.name || 'Attachment'}</span>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\n                          <ExternalLink className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter className=\"gap-2\">\n            <Button variant=\"outline\" onClick={() => setShowTaskDetailModal(false)}>\n              Close\n            </Button>\n            <Button onClick={() => {\n              setLocation(`${rolePrefix}/tasks?id=${selectedSearchTask?.id}`);\n              setShowTaskDetailModal(false);\n            }}>\n              Go to Task\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Kronos AI Assistant - Global access */}\n      <ReaperAssistant />\n      \n      {/* Docked Chat Boxes - LinkedIn style */}\n      <DockedChatBoxes />\n    </div>\n  );\n}\n","path":null,"size_bytes":97466,"size_tokens":null},"client/src/lib/api.ts":{"content":"import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport type { User, Deal, Task, InsertUser, Meeting, Notification, TimeEntry, InsertTimeEntry, TimeOffRequest, InsertTimeOffRequest, AuditLog, Investor, InsertInvestor, InvestorInteraction, InsertInvestorInteraction, Okr, InsertOkr, Stakeholder, InsertStakeholder, Announcement, InsertAnnouncement, Poll, InsertPoll, MentorshipPairing, InsertMentorshipPairing, ClientPortalAccess, InsertClientPortalAccess, DocumentTemplate, InsertDocumentTemplate } from \"@shared/schema\";\n\nexport type { User, Deal, Task, Meeting, Notification };\n\n// Session expiration event system\nlet sessionExpiredCallbacks: Array<() => void> = [];\n\nexport function onSessionExpired(callback: () => void) {\n  sessionExpiredCallbacks.push(callback);\n  return () => {\n    sessionExpiredCallbacks = sessionExpiredCallbacks.filter(cb => cb !== callback);\n  };\n}\n\nexport function triggerSessionExpired() {\n  sessionExpiredCallbacks.forEach(cb => cb());\n}\n\n// Check for session expiration (401) and handle it globally\nfunction handleSessionExpiration(res: Response): boolean {\n  if (res.status === 401) {\n    triggerSessionExpired();\n    return true;\n  }\n  return false;\n}\n\n// Generic API request helper with session handling\nexport async function apiRequest(method: string, url: string, body?: any): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: body ? { \"Content-Type\": \"application/json\" } : undefined,\n    body: body ? JSON.stringify(body) : undefined,\n  });\n  if (!res.ok) {\n    if (handleSessionExpiration(res)) {\n      throw new Error(\"Your session has expired. Please log in again.\");\n    }\n    throw new Error(`API request failed: ${res.status}`);\n  }\n  return res;\n}\n\n// Helper to make API calls with retry logic for transient failures\nexport async function apiRequestWithRetry(\n  method: string, \n  url: string, \n  body?: any, \n  maxRetries: number = 3\n): Promise<Response> {\n  let lastError: Error | null = null;\n  \n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      const res = await fetch(url, {\n        method,\n        headers: body ? { \"Content-Type\": \"application/json\" } : undefined,\n        body: body ? JSON.stringify(body) : undefined,\n      });\n      \n      if (res.ok) {\n        return res;\n      }\n      \n      if (handleSessionExpiration(res)) {\n        throw new Error(\"Your session has expired. Please log in again.\");\n      }\n      \n      // Don't retry 4xx errors (except 408 timeout and 429 rate limit)\n      if (res.status >= 400 && res.status < 500 && res.status !== 408 && res.status !== 429) {\n        throw new Error(`API request failed: ${res.status}`);\n      }\n      \n      lastError = new Error(`API request failed: ${res.status}`);\n    } catch (error: any) {\n      lastError = error;\n      // Check if it's a network error (worth retrying)\n      if (error.name !== 'TypeError' && !error.message.includes('network')) {\n        throw error;\n      }\n    }\n    \n    // Wait before retrying with exponential backoff\n    if (attempt < maxRetries - 1) {\n      await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));\n    }\n  }\n  \n  throw lastError || new Error(\"API request failed after retries\");\n}\n\n// Auth API\nexport function useLogin() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (credentials: { email: string; password: string; rememberMe?: boolean }) => {\n      const res = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(credentials),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Login failed\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n      queryClient.invalidateQueries({ queryKey: [\"user-preferences\"] });\n    },\n  });\n}\n\nexport function useSignup() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: InsertUser) => {\n      const res = await fetch(\"/api/auth/signup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Signup failed\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n      queryClient.invalidateQueries({ queryKey: [\"user-preferences\"] });\n    },\n  });\n}\n\nexport function useLogout() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/auth/logout\", {\n        method: \"POST\",\n      });\n      if (!res.ok) throw new Error(\"Logout failed\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n      queryClient.clear();\n    },\n  });\n}\n\nexport function useCurrentUser() {\n  return useQuery({\n    queryKey: [\"auth\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/auth/me\");\n      if (!res.ok) {\n        if (res.status === 401) return null;\n        throw new Error(\"Failed to fetch current user\");\n      }\n      return res.json() as Promise<User>;\n    },\n    retry: false,\n  });\n}\n\n// User API\nexport function useUsers() {\n  return useQuery({\n    queryKey: [\"users\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/users\");\n      if (!res.ok) throw new Error(\"Failed to fetch users\");\n      return res.json() as Promise<User[]>;\n    },\n  });\n}\n\nexport function useUser(id: string) {\n  return useQuery({\n    queryKey: [\"users\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/users/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch user\");\n      return res.json() as Promise<User>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport type OnboardingStatus = Record<string, { hasResume: boolean; hasPersonality: boolean; isComplete: boolean }>;\n\nexport function useOnboardingStatus() {\n  return useQuery({\n    queryKey: [\"onboarding-status\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/users/onboarding-status\", {\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to fetch onboarding status\");\n      return res.json() as Promise<OnboardingStatus>;\n    },\n  });\n}\n\n// Deal API - fetches all deals (paginated by default in production)\nexport function useDeals() {\n  return useQuery({\n    queryKey: [\"deals\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/deals\");\n      if (!res.ok) throw new Error(\"Failed to fetch deals\");\n      return res.json() as Promise<Deal[]>;\n    },\n  });\n}\n\n// Lightweight deal type for listing endpoints (excludes large JSON fields)\nexport type DealListing = Pick<Deal, 'id' | 'name' | 'dealType' | 'stage' | 'value' | 'client' | 'clientContactName' | 'clientContactEmail' | 'sector' | 'lead' | 'progress' | 'status' | 'description' | 'createdAt'>;\n\n// Lightweight deals listing (excludes large JSON fields for performance)\n// Use this for dropdowns, selectors, or simple lists that don't need full data\nexport function useDealsListing() {\n  return useQuery({\n    queryKey: [\"deals-listing\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/deals/listing\");\n      if (!res.ok) throw new Error(\"Failed to fetch deals\");\n      return res.json() as Promise<DealListing[]>;\n    },\n  });\n}\n\nexport function useDeal(id: string) {\n  return useQuery({\n    queryKey: [\"deals\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/deals/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch deal\");\n      return res.json() as Promise<Deal>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport function useCreateDeal() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (deal: Omit<Deal, \"id\" | \"createdAt\">) => {\n      const res = await fetch(\"/api/deals\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(deal),\n      });\n      if (!res.ok) throw new Error(\"Failed to create deal\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\nexport function useApproveOpportunity() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (opportunityId: string) => {\n      const res = await fetch(`/api/opportunities/${opportunityId}/approve`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: \"Failed to approve opportunity\" }));\n        throw new Error(errorData.error || \"Failed to approve opportunity\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n    },\n  });\n}\n\nexport function useUpdateDeal() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, ...updates }: Partial<Deal> & { id: string }) => {\n      const res = await fetch(`/api/deals/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: \"Failed to update deal\" }));\n        throw new Error(errorData.error || \"Failed to update deal\");\n      }\n      return res.json();\n    },\n    onMutate: async ({ id, ...updates }) => {\n      await queryClient.cancelQueries({ queryKey: [\"deals\", id] });\n      const previousDeal = queryClient.getQueryData<Deal>([\"deals\", id]);\n      if (previousDeal) {\n        queryClient.setQueryData<Deal>([\"deals\", id], { ...previousDeal, ...updates });\n      }\n      return { previousDeal, id };\n    },\n    onError: (err, vars, context) => {\n      if (context?.previousDeal) {\n        queryClient.setQueryData([\"deals\", context.id], context.previousDeal);\n      }\n    },\n    onSettled: (_, __, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\", vars.id] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\nexport function useDeleteDeal() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/deals/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!res.ok) throw new Error(\"Failed to delete deal\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\nexport function useMoveDealToOpportunity() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (dealId: string) => {\n      const res = await fetch(`/api/deals/${dealId}/move-to-opportunity`, {\n        method: \"PATCH\",\n      });\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: \"Failed to move deal\" }));\n        throw new Error(errorData.error || \"Failed to move deal to opportunities\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\n// Custom Sectors API\nexport type CustomSector = {\n  id: string;\n  name: string;\n  createdBy: string | null;\n  createdAt: string;\n};\n\nexport function useCustomSectors() {\n  return useQuery({\n    queryKey: [\"custom-sectors\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/custom-sectors\");\n      if (!res.ok) throw new Error(\"Failed to fetch custom sectors\");\n      return res.json() as Promise<CustomSector[]>;\n    },\n  });\n}\n\nexport function useCreateCustomSector() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (name: string) => {\n      const res = await fetch(\"/api/custom-sectors\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name }),\n      });\n      if (!res.ok) {\n        const error = await res.json().catch(() => ({ error: \"Failed to create custom sector\" }));\n        throw new Error(error.error || \"Failed to create custom sector\");\n      }\n      return res.json() as Promise<CustomSector>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"custom-sectors\"] });\n    },\n  });\n}\n\n// Task API\nexport function useTasks(filters?: { userId?: string; dealId?: string }) {\n  return useQuery({\n    queryKey: [\"tasks\", filters],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (filters?.userId) params.set(\"userId\", filters.userId);\n      if (filters?.dealId) params.set(\"dealId\", filters.dealId);\n      const query = params.toString();\n      const res = await fetch(`/api/tasks${query ? `?${query}` : \"\"}`);\n      if (!res.ok) throw new Error(\"Failed to fetch tasks\");\n      return res.json() as Promise<Task[]>;\n    },\n  });\n}\n\nexport function useTask(id: string) {\n  return useQuery({\n    queryKey: [\"tasks\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/tasks/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch task\");\n      return res.json() as Promise<Task>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport function useCreateTask() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (task: Omit<Task, \"id\" | \"createdAt\">) => {\n      const res = await fetch(\"/api/tasks\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(task),\n      });\n      if (!res.ok) throw new Error(\"Failed to create task\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\nexport function useUpdateTask() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, ...updates }: Partial<Task> & { id: string }) => {\n      const res = await fetch(`/api/tasks/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update task\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\nexport function useDeleteTask() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/tasks/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!res.ok) throw new Error(\"Failed to delete task\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\n// Meeting API\nexport function useMeetings() {\n  return useQuery({\n    queryKey: [\"meetings\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/meetings\");\n      if (!res.ok) throw new Error(\"Failed to fetch meetings\");\n      return res.json() as Promise<Meeting[]>;\n    },\n  });\n}\n\nexport function useCreateMeeting() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (meeting: Omit<Meeting, \"id\" | \"createdAt\">) => {\n      const res = await fetch(\"/api/meetings\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(meeting),\n      });\n      if (!res.ok) throw new Error(\"Failed to create meeting\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"meetings\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\nexport function useUpdateMeeting() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, ...updates }: Partial<Meeting> & { id: string }) => {\n      const res = await fetch(`/api/meetings/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update meeting\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"meetings\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\nexport function useDeleteMeeting() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/meetings/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!res.ok) throw new Error(\"Failed to delete meeting\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"meetings\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\n// Notification API\nexport function useNotifications() {\n  return useQuery({\n    queryKey: [\"notifications\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/notifications\");\n      if (!res.ok) throw new Error(\"Failed to fetch notifications\");\n      return res.json() as Promise<Notification[]>;\n    },\n  });\n}\n\nexport function useMarkNotificationRead() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/notifications/${id}/read`, {\n        method: \"PATCH\",\n      });\n      if (!res.ok) throw new Error(\"Failed to mark notification as read\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\nexport function useDeleteNotification() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/notifications/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!res.ok) throw new Error(\"Failed to delete notification\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\n// Tag member on deal/opportunity (with notification)\nexport function useTagDealMember() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, memberId, memberName, memberRole }: { dealId: string; memberId: string; memberName: string; memberRole?: string }) => {\n      const res = await fetch(`/api/deals/${dealId}/tag-member`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ memberId, memberName, memberRole }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to tag member\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\n// Remove member from deal/opportunity\nexport function useRemoveDealMember() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, memberId }: { dealId: string; memberId: string }) => {\n      const res = await fetch(`/api/deals/${dealId}/remove-member`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ memberId }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to remove member\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"deals-listing\"] });\n    },\n  });\n}\n\n// Market Data API\nexport type MarketDataItem = {\n  name: string;\n  symbol: string;\n  value: string;\n  change: string;\n  trend: 'up' | 'down';\n  description: string;\n};\n\nexport type MarketDataResponse = {\n  source: 'live' | 'simulated';\n  data: MarketDataItem[];\n};\n\nexport function useMarketData(symbols?: string[]) {\n  return useQuery({\n    queryKey: [\"market-data\", symbols?.join(',')],\n    queryFn: async () => {\n      const url = symbols && symbols.length > 0 \n        ? `/api/market-data?symbols=${symbols.join(',')}`\n        : \"/api/market-data\";\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch market data\");\n      return res.json() as Promise<MarketDataResponse>;\n    },\n    refetchInterval: 30000, // Refresh every 30 seconds\n    staleTime: 15000, // Consider data stale after 15 seconds\n  });\n}\n\n// Market News API\nexport type MarketNewsItem = {\n  id: string;\n  headline: string;\n  summary: string;\n  source: string;\n  url: string;\n  image?: string;\n  datetime: string;\n  category: string;\n  related?: string;\n};\n\nexport type MarketNewsResponse = {\n  source: 'live' | 'sample';\n  data: MarketNewsItem[];\n};\n\nexport function useMarketNews(category?: string) {\n  return useQuery({\n    queryKey: [\"market-news\", category],\n    queryFn: async () => {\n      const url = category \n        ? `/api/market-news?category=${category}`\n        : \"/api/market-news\";\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch market news\");\n      return res.json() as Promise<MarketNewsResponse>;\n    },\n    refetchInterval: 60000, // Refresh every minute\n    staleTime: 30000, // Consider data stale after 30 seconds\n  });\n}\n\n// AI Document Generation\nexport function useGenerateDocument() {\n  return useMutation({\n    mutationFn: async ({ templateName, dealData, complianceOptions }: { \n      templateName: string; \n      dealData: any; \n      complianceOptions: { sec: boolean; finra: boolean; legal: boolean } \n    }) => {\n      const res = await fetch(\"/api/generate-document\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ templateName, dealData, complianceOptions }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to generate document\");\n      }\n      return res.json() as Promise<{ content: string }>;\n    },\n  });\n}\n\n// User Profile API\nexport function useUpdateUserProfile() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ userId, updates }: { userId: string; updates: { name?: string; email?: string; phone?: string; avatar?: string; role?: string } }) => {\n      const res = await fetch(`/api/users/${userId}/profile`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update profile\");\n      }\n      return res.json() as Promise<User>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n      queryClient.invalidateQueries({ queryKey: [\"users\"] });\n    },\n  });\n}\n\nexport function useChangePassword() {\n  return useMutation({\n    mutationFn: async ({ userId, currentPassword, newPassword }: { userId: string; currentPassword: string; newPassword: string }) => {\n      const res = await fetch(`/api/users/${userId}/password`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ currentPassword, newPassword }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to change password\");\n      }\n      return res.json();\n    },\n  });\n}\n\n// ===== TIME TRACKING API =====\nexport function useTimeEntries() {\n  return useQuery({\n    queryKey: [\"time-entries\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/time-entries\");\n      if (!res.ok) throw new Error(\"Failed to fetch time entries\");\n      return res.json() as Promise<TimeEntry[]>;\n    },\n  });\n}\n\nexport function useCreateTimeEntry() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (entry: Omit<InsertTimeEntry, 'userId'>) => {\n      const res = await fetch(\"/api/time-entries\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(entry),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create time entry\");\n      }\n      return res.json() as Promise<TimeEntry>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"time-entries\"] });\n    },\n  });\n}\n\nexport function useDeleteTimeEntry() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/time-entries/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete time entry\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"time-entries\"] });\n    },\n  });\n}\n\n// ===== TIME OFF REQUESTS API =====\nexport function useTimeOffRequests() {\n  return useQuery({\n    queryKey: [\"time-off-requests\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/time-off-requests\");\n      if (!res.ok) throw new Error(\"Failed to fetch time off requests\");\n      return res.json() as Promise<(TimeOffRequest & { userName?: string; approverName?: string })[]>;\n    },\n  });\n}\n\nexport function useCreateTimeOffRequest() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (request: Omit<InsertTimeOffRequest, 'userId'>) => {\n      const res = await fetch(\"/api/time-off-requests\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(request),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create time off request\");\n      }\n      return res.json() as Promise<TimeOffRequest>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"time-off-requests\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\nexport function useUpdateTimeOffRequest() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<TimeOffRequest> }) => {\n      const res = await fetch(`/api/time-off-requests/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update time off request\");\n      }\n      return res.json() as Promise<TimeOffRequest>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"time-off-requests\"] });\n      queryClient.invalidateQueries({ queryKey: [\"notifications\"] });\n    },\n  });\n}\n\n// ===== GOOGLE CALENDAR API =====\nexport type GoogleCalendarEvent = {\n  id: string;\n  googleEventId: string;\n  title: string;\n  description: string;\n  location: string;\n  start: string;\n  end: string;\n  allDay: boolean;\n  meetLink?: string;\n  attendees: { email: string; name?: string; responseStatus?: string }[];\n  organizer?: string;\n  status?: string;\n  htmlLink?: string;\n  source: 'google';\n};\n\nexport type GoogleCalendarStatus = {\n  configured: boolean;\n  connected: boolean;\n};\n\nexport function useGoogleCalendarStatus() {\n  return useQuery({\n    queryKey: [\"google-calendar-status\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/google-calendar/status\");\n      if (!res.ok) return { configured: false, connected: false };\n      return res.json() as Promise<GoogleCalendarStatus>;\n    },\n    staleTime: 1000 * 60 * 5,\n  });\n}\n\nexport function useConnectGoogleCalendar() {\n  return useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/google-calendar/connect\");\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to get authorization URL\");\n      }\n      const data = await res.json();\n      return data.authUrl as string;\n    },\n  });\n}\n\nexport function useDisconnectGoogleCalendar() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/google-calendar/disconnect\", {\n        method: \"POST\",\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to disconnect Google Calendar\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-events\"] });\n    },\n  });\n}\n\nexport function useSyncGoogleCalendar() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/google-calendar/sync\", {\n        method: \"POST\",\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to sync with Google Calendar\");\n      }\n      return res.json() as Promise<{ message: string; imported: number; skipped: number; totalGoogleEvents: number }>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-events\"] });\n      queryClient.invalidateQueries({ queryKey: [\"meetings\"] });\n    },\n  });\n}\n\nexport function useGoogleCalendarEvents(timeMin?: Date, timeMax?: Date) {\n  return useQuery({\n    queryKey: [\"google-calendar-events\", timeMin?.toISOString(), timeMax?.toISOString()],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (timeMin) params.append('timeMin', timeMin.toISOString());\n      if (timeMax) params.append('timeMax', timeMax.toISOString());\n      \n      const res = await fetch(`/api/google-calendar/events?${params}`);\n      if (!res.ok) {\n        if (res.status === 401) return [];\n        throw new Error(\"Failed to fetch Google Calendar events\");\n      }\n      return res.json() as Promise<GoogleCalendarEvent[]>;\n    },\n    staleTime: 1000 * 60,\n  });\n}\n\nexport function useCreateGoogleCalendarEvent() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (event: {\n      title: string;\n      description?: string;\n      location?: string;\n      start: string;\n      end: string;\n      attendees?: string[];\n      addMeetLink?: boolean;\n    }) => {\n      const res = await fetch(\"/api/google-calendar/events\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(event),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create Google Calendar event\");\n      }\n      return res.json() as Promise<GoogleCalendarEvent>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-events\"] });\n    },\n  });\n}\n\n// ===== AUDIT LOGS API =====\nexport function useAuditLogs(limit?: number) {\n  return useQuery({\n    queryKey: [\"audit-logs\", limit],\n    queryFn: async () => {\n      const url = limit ? `/api/audit-logs?limit=${limit}` : \"/api/audit-logs\";\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch audit logs\");\n      return res.json() as Promise<(AuditLog & { userName?: string })[]>;\n    },\n  });\n}\n\n// ===== INVESTOR CRM API =====\nexport function useInvestors() {\n  return useQuery({\n    queryKey: [\"investors\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/investors\");\n      if (!res.ok) throw new Error(\"Failed to fetch investors\");\n      return res.json() as Promise<Investor[]>;\n    },\n  });\n}\n\nexport function useInvestor(id: string) {\n  return useQuery({\n    queryKey: [\"investors\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/investors/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch investor\");\n      return res.json() as Promise<Investor & { interactions: InvestorInteraction[] }>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport function useCreateInvestor() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (investor: InsertInvestor) => {\n      const res = await fetch(\"/api/investors\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(investor),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create investor\");\n      }\n      return res.json() as Promise<Investor>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"investor-matches\"] });\n    },\n  });\n}\n\nexport function useUpdateInvestor() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertInvestor> }) => {\n      const res = await fetch(`/api/investors/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update investor\");\n      }\n      return res.json() as Promise<Investor>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"investor-matches\"] });\n    },\n  });\n}\n\nexport function useDeleteInvestor() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/investors/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete investor\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"investor-matches\"] });\n    },\n  });\n}\n\nexport function useCreateInvestorInteraction() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ investorId, interaction }: { investorId: string; interaction: Omit<InsertInvestorInteraction, 'investorId' | 'userId'> }) => {\n      const res = await fetch(`/api/investors/${investorId}/interactions`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(interaction),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create interaction\");\n      }\n      return res.json() as Promise<InvestorInteraction>;\n    },\n    onSuccess: (_, { investorId }) => {\n      queryClient.invalidateQueries({ queryKey: [\"investors\", investorId] });\n      queryClient.invalidateQueries({ queryKey: [\"investors\"] });\n    },\n  });\n}\n\n// ===== OKR API =====\nexport function useOkrs() {\n  return useQuery({\n    queryKey: [\"okrs\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/okrs\");\n      if (!res.ok) throw new Error(\"Failed to fetch OKRs\");\n      return res.json() as Promise<Okr[]>;\n    },\n  });\n}\n\nexport function useCreateOkr() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (okr: InsertOkr) => {\n      const res = await fetch(\"/api/okrs\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(okr),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create OKR\");\n      }\n      return res.json() as Promise<Okr>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"okrs\"] });\n    },\n  });\n}\n\nexport function useUpdateOkr() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertOkr> }) => {\n      const res = await fetch(`/api/okrs/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update OKR\");\n      }\n      return res.json() as Promise<Okr>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"okrs\"] });\n    },\n  });\n}\n\nexport function useDeleteOkr() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/okrs/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete OKR\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"okrs\"] });\n    },\n  });\n}\n\n// ===== STAKEHOLDER API =====\nexport interface StakeholdersResponse {\n  stakeholders: Stakeholder[];\n  total: number;\n  page: number;\n  pageSize: number;\n  totalPages: number;\n}\n\nexport function useStakeholders(options?: {\n  page?: number;\n  pageSize?: number;\n  search?: string;\n  type?: string;\n}) {\n  const { page = 1, pageSize = 50, search, type } = options || {};\n  \n  return useQuery({\n    queryKey: [\"stakeholders\", { page, pageSize, search, type }],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      params.set('page', String(page));\n      params.set('pageSize', String(pageSize));\n      if (search) params.set('search', search);\n      if (type && type !== 'all') params.set('type', type);\n      \n      const res = await fetch(`/api/stakeholders?${params.toString()}`);\n      if (!res.ok) throw new Error(\"Failed to fetch stakeholders\");\n      return res.json() as Promise<StakeholdersResponse>;\n    },\n    placeholderData: (previousData) => previousData,\n  });\n}\n\n// Hook to fetch all investors (for investor matching pages)\nexport function useAllInvestors() {\n  return useQuery({\n    queryKey: [\"stakeholders\", \"allInvestors\"],\n    queryFn: async () => {\n      // Fetch investors with a large page size to get all of them\n      const res = await fetch(`/api/stakeholders?type=investor&pageSize=10000`);\n      if (!res.ok) throw new Error(\"Failed to fetch investors\");\n      const data = await res.json() as StakeholdersResponse;\n      return data.stakeholders;\n    },\n  });\n}\n\n// Hook to fetch stakeholder stats (totals by type for summary display)\nexport interface StakeholderStatsResponse {\n  total: number;\n  typeCounts: Record<string, number>;\n  favoriteCount: number;\n}\n\nexport function useStakeholderStats() {\n  return useQuery({\n    queryKey: [\"stakeholders\", \"stats\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/stakeholders/stats`);\n      if (!res.ok) throw new Error(\"Failed to fetch stakeholder stats\");\n      return res.json() as Promise<StakeholderStatsResponse>;\n    },\n  });\n}\n\nexport function useCreateStakeholder() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (stakeholder: InsertStakeholder) => {\n      const res = await fetch(\"/api/stakeholders\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(stakeholder),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create stakeholder\");\n      }\n      return res.json() as Promise<Stakeholder>;\n    },\n    onSuccess: () => {\n      // Invalidate all stakeholder queries (including paginated)\n      queryClient.invalidateQueries({ queryKey: [\"stakeholders\"], refetchType: 'all' });\n    },\n  });\n}\n\nexport function useUpdateStakeholder() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertStakeholder> }) => {\n      const res = await fetch(`/api/stakeholders/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update stakeholder\");\n      }\n      return res.json() as Promise<Stakeholder>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"stakeholders\"], refetchType: 'all' });\n    },\n  });\n}\n\nexport function useDeleteStakeholder() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/stakeholders/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete stakeholder\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"stakeholders\"], refetchType: 'all' });\n    },\n  });\n}\n\n// ===== INVESTORS TABLE API =====\nexport type InvestorTable = {\n  id: string;\n  name: string;\n  firm: string;\n  type: string;\n  focus: string | null;\n  aum: string | null;\n  checkSize: string | null;\n  preferredStage: string | null;\n  location: string | null;\n  website: string | null;\n  email: string | null;\n  phone: string | null;\n  linkedIn: string | null;\n  notes: string | null;\n  tags: string[] | null;\n  isActive: boolean | null;\n  createdBy: string | null;\n  createdAt: Date | null;\n  updatedAt: Date | null;\n};\n\nexport function useInvestorsTable() {\n  return useQuery({\n    queryKey: [\"investors-table\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/investors-table\");\n      if (!res.ok) throw new Error(\"Failed to fetch investors\");\n      return res.json() as Promise<InvestorTable[]>;\n    },\n  });\n}\n\nexport function useCreateInvestorTable() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (investor: Partial<InvestorTable>) => {\n      const res = await fetch(\"/api/investors-table\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(investor),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create investor\");\n      }\n      return res.json() as Promise<InvestorTable>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors-table\"] });\n    },\n  });\n}\n\nexport function useUpdateInvestorTable() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InvestorTable> }) => {\n      const res = await fetch(`/api/investors-table/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update investor\");\n      }\n      return res.json() as Promise<InvestorTable>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors-table\"] });\n    },\n  });\n}\n\nexport function useDeleteInvestorTable() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/investors-table/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete investor\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"investors-table\"] });\n    },\n  });\n}\n\n// ===== ANNOUNCEMENT API =====\nexport function useAnnouncements() {\n  return useQuery({\n    queryKey: [\"announcements\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/announcements\");\n      if (!res.ok) throw new Error(\"Failed to fetch announcements\");\n      return res.json() as Promise<Announcement[]>;\n    },\n  });\n}\n\nexport function useCreateAnnouncement() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (announcement: Omit<InsertAnnouncement, 'authorId' | 'authorName'>) => {\n      const res = await fetch(\"/api/announcements\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(announcement),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create announcement\");\n      }\n      return res.json() as Promise<Announcement>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"announcements\"] });\n    },\n  });\n}\n\nexport function useUpdateAnnouncement() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertAnnouncement> }) => {\n      const res = await fetch(`/api/announcements/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update announcement\");\n      }\n      return res.json() as Promise<Announcement>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"announcements\"] });\n    },\n  });\n}\n\nexport function useDeleteAnnouncement() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/announcements/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete announcement\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"announcements\"] });\n    },\n  });\n}\n\n// ===== POLL API =====\nexport function usePolls() {\n  return useQuery({\n    queryKey: [\"polls\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/polls\");\n      if (!res.ok) throw new Error(\"Failed to fetch polls\");\n      return res.json() as Promise<Poll[]>;\n    },\n  });\n}\n\nexport function useCreatePoll() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (poll: Omit<InsertPoll, 'creatorId' | 'creatorName'>) => {\n      const res = await fetch(\"/api/polls\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(poll),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create poll\");\n      }\n      return res.json() as Promise<Poll>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"polls\"] });\n    },\n  });\n}\n\nexport function useUpdatePoll() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertPoll> }) => {\n      const res = await fetch(`/api/polls/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update poll\");\n      }\n      return res.json() as Promise<Poll>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"polls\"] });\n    },\n  });\n}\n\nexport function useDeletePoll() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/polls/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete poll\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"polls\"] });\n    },\n  });\n}\n\n// ===== MENTORSHIP PAIRING API =====\nexport function useMentorshipPairings() {\n  return useQuery({\n    queryKey: [\"mentorship-pairings\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/mentorship-pairings\");\n      if (!res.ok) throw new Error(\"Failed to fetch mentorship pairings\");\n      return res.json() as Promise<MentorshipPairing[]>;\n    },\n  });\n}\n\nexport function useCreateMentorshipPairing() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (pairing: InsertMentorshipPairing) => {\n      const res = await fetch(\"/api/mentorship-pairings\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(pairing),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create mentorship pairing\");\n      }\n      return res.json() as Promise<MentorshipPairing>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"mentorship-pairings\"] });\n    },\n  });\n}\n\nexport function useUpdateMentorshipPairing() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertMentorshipPairing> }) => {\n      const res = await fetch(`/api/mentorship-pairings/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update mentorship pairing\");\n      }\n      return res.json() as Promise<MentorshipPairing>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"mentorship-pairings\"] });\n    },\n  });\n}\n\nexport function useDeleteMentorshipPairing() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/mentorship-pairings/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete mentorship pairing\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"mentorship-pairings\"] });\n    },\n  });\n}\n\n// ===== CLIENT PORTAL ACCESS API =====\nexport function useClientPortalAccess() {\n  return useQuery({\n    queryKey: [\"client-portal-access\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/client-portal-access\");\n      if (!res.ok) throw new Error(\"Failed to fetch client portal access\");\n      return res.json() as Promise<ClientPortalAccess[]>;\n    },\n  });\n}\n\nexport function useCreateClientPortalAccess() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (access: Omit<InsertClientPortalAccess, 'invitedBy'>) => {\n      const res = await fetch(\"/api/client-portal-access\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(access),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create client portal access\");\n      }\n      return res.json() as Promise<ClientPortalAccess>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"client-portal-access\"] });\n    },\n  });\n}\n\nexport function useUpdateClientPortalAccess() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertClientPortalAccess> }) => {\n      const res = await fetch(`/api/client-portal-access/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update client portal access\");\n      }\n      return res.json() as Promise<ClientPortalAccess>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"client-portal-access\"] });\n    },\n  });\n}\n\nexport function useDeleteClientPortalAccess() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/client-portal-access/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete client portal access\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"client-portal-access\"] });\n    },\n  });\n}\n\n// ===== DOCUMENT TEMPLATE API =====\nexport function useDocumentTemplates() {\n  return useQuery({\n    queryKey: [\"document-templates\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/document-templates\");\n      if (!res.ok) throw new Error(\"Failed to fetch document templates\");\n      return res.json() as Promise<DocumentTemplate[]>;\n    },\n  });\n}\n\nexport function useCreateDocumentTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (template: Omit<InsertDocumentTemplate, 'createdBy'>) => {\n      const res = await fetch(\"/api/document-templates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(template),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create document template\");\n      }\n      return res.json() as Promise<DocumentTemplate>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"document-templates\"] });\n    },\n  });\n}\n\nexport function useUpdateDocumentTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<InsertDocumentTemplate> }) => {\n      const res = await fetch(`/api/document-templates/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update document template\");\n      }\n      return res.json() as Promise<DocumentTemplate>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"document-templates\"] });\n    },\n  });\n}\n\nexport function useDeleteDocumentTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/document-templates/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete document template\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"document-templates\"] });\n    },\n  });\n}\n\n// ===== DOCUMENT STORAGE API =====\nexport type DocumentRecord = {\n  id: string;\n  title: string;\n  type: string;\n  category: string;\n  filename: string;\n  originalName?: string;\n  mimeType?: string;\n  size?: number;\n  content?: string;\n  dealId?: string;\n  dealName?: string;\n  uploadedBy?: string;\n  uploaderName?: string;\n  tags?: string[];\n  isArchived: boolean;\n  createdAt: string;\n  updatedAt: string;\n};\n\nexport function useDocuments() {\n  return useQuery({\n    queryKey: [\"documents\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/documents\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch documents\");\n      return res.json() as Promise<DocumentRecord[]>;\n    },\n    staleTime: 0, // Always refetch on invalidation for immediate updates\n  });\n}\n\nexport function useDocumentsByDeal(dealId: string | null) {\n  return useQuery({\n    queryKey: [\"documents\", \"deal\", dealId],\n    queryFn: async () => {\n      if (!dealId) return [];\n      const res = await fetch(`/api/documents/deal/${dealId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch deal documents\");\n      return res.json() as Promise<DocumentRecord[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateDocument() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (doc: {\n      title: string;\n      type: string;\n      category?: string;\n      filename: string;\n      originalName?: string;\n      mimeType?: string;\n      size?: number;\n      content?: string;\n      dealId?: string;\n      dealName?: string;\n      tags?: string[];\n    }) => {\n      const res = await fetch(\"/api/documents\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(doc),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create document\");\n      }\n      return res.json() as Promise<DocumentRecord>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"documents\"], refetchType: 'all' });\n    },\n  });\n}\n\nexport function useUpdateDocument() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<DocumentRecord> }) => {\n      const res = await fetch(`/api/documents/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update document\");\n      }\n      return res.json() as Promise<DocumentRecord>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"documents\"], refetchType: 'all' });\n    },\n  });\n}\n\nexport function useDeleteDocument() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/documents/${id}`, { method: \"DELETE\", credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to delete document\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"documents\"], refetchType: 'all' });\n    },\n  });\n}\n\n// ===== INVESTOR MATCH HOOKS =====\n\nexport type InvestorMatch = {\n  id: string;\n  dealId: string;\n  investorId: string;\n  status: string;\n  matchedBy: string | null;\n  matchedAt: string;\n};\n\nexport function useInvestorMatches(dealId: string | null) {\n  return useQuery({\n    queryKey: [\"investor-matches\", dealId],\n    queryFn: async () => {\n      if (!dealId) return [];\n      const res = await fetch(`/api/investor-matches/${dealId}`);\n      if (!res.ok) throw new Error(\"Failed to fetch investor matches\");\n      return res.json() as Promise<InvestorMatch[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateInvestorMatch() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (match: { dealId: string; investorId: string; status: string }) => {\n      const res = await fetch(\"/api/investor-matches\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(match),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create investor match\");\n      }\n      return res.json() as Promise<InvestorMatch>;\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"investor-matches\", variables.dealId] });\n    },\n  });\n}\n\nexport function useDeleteInvestorMatch() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, investorId }: { dealId: string; investorId: string }) => {\n      const res = await fetch(`/api/investor-matches/${dealId}/${investorId}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete investor match\");\n      return res.json();\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"investor-matches\", variables.dealId] });\n    },\n  });\n}\n\n// ===== USER PREFERENCES HOOKS =====\n\nexport type UserPreferencesType = {\n  id?: string;\n  userId: string;\n  dashboardWidgets: any[];\n  sidebarCollapsed: boolean;\n  theme: string;\n  complianceDefaults: { sec: boolean; finra: boolean; legal: boolean };\n  marketSymbols: string[];\n  settings?: Record<string, any>; // General settings (notifications, display, account preferences)\n  hasSeenWelcome?: boolean;\n  updatedAt?: string;\n};\n\nexport function useUserPreferences(options?: { enabled?: boolean }) {\n  return useQuery({\n    queryKey: [\"user-preferences\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/user-preferences\");\n      if (res.status === 401) {\n        return null;\n      }\n      if (!res.ok) throw new Error(`Failed to fetch user preferences: ${res.status}`);\n      return res.json() as Promise<UserPreferencesType>;\n    },\n    enabled: options?.enabled !== false,\n    retry: 1,\n    staleTime: 1000 * 60 * 5,\n    refetchOnMount: true,\n  });\n}\n\nexport function useSaveUserPreferences() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (prefs: Partial<UserPreferencesType>) => {\n      const res = await fetch(\"/api/user-preferences\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(prefs),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to save user preferences\");\n      }\n      return res.json() as Promise<UserPreferencesType>;\n    },\n    onMutate: async (newPrefs) => {\n      // Cancel any outgoing refetches\n      await queryClient.cancelQueries({ queryKey: [\"user-preferences\"] });\n      // Snapshot current value\n      const previousPrefs = queryClient.getQueryData<UserPreferencesType>([\"user-preferences\"]);\n      // Optimistically update cache\n      if (previousPrefs) {\n        queryClient.setQueryData<UserPreferencesType>([\"user-preferences\"], {\n          ...previousPrefs,\n          ...newPrefs,\n          settings: { ...(previousPrefs.settings || {}), ...(newPrefs.settings || {}) },\n        });\n      }\n      return { previousPrefs };\n    },\n    onError: (_err, _newPrefs, context) => {\n      // Rollback on error\n      if (context?.previousPrefs) {\n        queryClient.setQueryData([\"user-preferences\"], context.previousPrefs);\n      }\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: [\"user-preferences\"] });\n    },\n  });\n}\n\nexport function useUpdateUserPreferences() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (updates: Partial<UserPreferencesType>) => {\n      const res = await fetch(\"/api/user-preferences\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update user preferences\");\n      }\n      return res.json() as Promise<UserPreferencesType>;\n    },\n    onMutate: async (newPrefs) => {\n      await queryClient.cancelQueries({ queryKey: [\"user-preferences\"] });\n      const previousPrefs = queryClient.getQueryData<UserPreferencesType>([\"user-preferences\"]);\n      if (previousPrefs) {\n        queryClient.setQueryData<UserPreferencesType>([\"user-preferences\"], {\n          ...previousPrefs,\n          ...newPrefs,\n          settings: { ...(previousPrefs.settings || {}), ...(newPrefs.settings || {}) },\n        });\n      }\n      return { previousPrefs };\n    },\n    onError: (_err, _newPrefs, context) => {\n      if (context?.previousPrefs) {\n        queryClient.setQueryData([\"user-preferences\"], context.previousPrefs);\n      }\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: [\"user-preferences\"] });\n    },\n  });\n}\n\n// ===== DEAL TEMPLATE HOOKS =====\n\nexport type DealTemplateType = {\n  id: string;\n  name: string;\n  description: string | null;\n  sector: string;\n  dealType: string;\n  stages: string[];\n  defaultTasks: { title: string; type: string; priority: string }[];\n  estimatedDuration: number | null;\n  checklistItems: string[];\n  isFavorite: boolean | null;\n  usageCount: number | null;\n  createdBy: string | null;\n  createdAt: string;\n  updatedAt: string;\n};\n\nexport function useDealTemplates() {\n  return useQuery({\n    queryKey: [\"deal-templates\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/deal-templates\");\n      if (!res.ok) throw new Error(\"Failed to fetch deal templates\");\n      return res.json() as Promise<DealTemplateType[]>;\n    },\n  });\n}\n\nexport function useCreateDealTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (template: Omit<DealTemplateType, 'id' | 'createdBy' | 'createdAt' | 'updatedAt'>) => {\n      const res = await fetch(\"/api/deal-templates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(template),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create deal template\");\n      }\n      return res.json() as Promise<DealTemplateType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-templates\"] });\n    },\n  });\n}\n\nexport function useUpdateDealTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<DealTemplateType> }) => {\n      const res = await fetch(`/api/deal-templates/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update deal template\");\n      }\n      return res.json() as Promise<DealTemplateType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-templates\"] });\n    },\n  });\n}\n\nexport function useDeleteDealTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/deal-templates/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete deal template\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-templates\"] });\n    },\n  });\n}\n\n// ===== CALENDAR EVENT HOOKS =====\n\nexport type CalendarEventType = {\n  id: string;\n  title: string;\n  type: string;\n  date: string;\n  time: string | null;\n  description: string | null;\n  dealId: string | null;\n  dealName: string | null;\n  location: string | null;\n  participants: string[];\n  isAllDay: boolean | null;\n  color: string | null;\n  investor: string | null;\n  status: string | null;\n  notes: string | null;\n  createdBy: string | null;\n  createdAt: string;\n};\n\nexport function useCalendarEvents() {\n  return useQuery({\n    queryKey: [\"calendar-events\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/calendar-events\");\n      if (!res.ok) throw new Error(\"Failed to fetch calendar events\");\n      return res.json() as Promise<CalendarEventType[]>;\n    },\n  });\n}\n\nexport function useCreateCalendarEvent() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (event: Omit<CalendarEventType, 'id' | 'createdBy' | 'createdAt'>) => {\n      const res = await fetch(\"/api/calendar-events\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(event),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create calendar event\");\n      }\n      return res.json() as Promise<CalendarEventType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\nexport function useUpdateCalendarEvent() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<CalendarEventType> }) => {\n      const res = await fetch(`/api/calendar-events/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to update calendar event\");\n      }\n      return res.json() as Promise<CalendarEventType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\nexport function useDeleteCalendarEvent() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/calendar-events/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete calendar event\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"calendar-events\"] });\n    },\n  });\n}\n\n// ===== TASK ATTACHMENT HOOKS =====\n\nexport type TaskAttachmentType = {\n  id: string;\n  taskId: string;\n  filename: string;\n  originalName: string;\n  mimeType: string | null;\n  size: number | null;\n  uploadedBy: string | null;\n  uploadedAt: string;\n};\n\nexport function useTaskAttachments(taskId: string) {\n  return useQuery({\n    queryKey: [\"task-attachments\", taskId],\n    queryFn: async () => {\n      const res = await fetch(`/api/task-attachments/${taskId}`);\n      if (!res.ok) throw new Error(\"Failed to fetch task attachments\");\n      return res.json() as Promise<TaskAttachmentType[]>;\n    },\n    enabled: !!taskId,\n  });\n}\n\nexport function useCreateTaskAttachment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (attachment: Omit<TaskAttachmentType, 'id' | 'uploadedBy' | 'uploadedAt'>) => {\n      const res = await fetch(\"/api/task-attachments\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(attachment),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create task attachment\");\n      }\n      return res.json() as Promise<TaskAttachmentType>;\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"task-attachments\", data.taskId] });\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n    },\n  });\n}\n\nexport function useDeleteTaskAttachment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/task-attachments/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete task attachment\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"task-attachments\"] });\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n    },\n  });\n}\n\n// 2FA API\nexport function use2FAStatus() {\n  return useQuery({\n    queryKey: [\"2fa-status\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/auth/2fa/status\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch 2FA status\");\n      return res.json() as Promise<{ enabled: boolean; hasSecret: boolean }>;\n    },\n  });\n}\n\nexport function useSetup2FA() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/auth/2fa/setup\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to setup 2FA\");\n      }\n      return res.json() as Promise<{ secret: string; qrCode: string; otpauthUrl: string }>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"2fa-status\"] });\n    },\n  });\n}\n\nexport function useVerify2FA() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (code: string) => {\n      const res = await fetch(\"/api/auth/2fa/verify\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ code }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Invalid verification code\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"2fa-status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n    },\n  });\n}\n\nexport function useDisable2FA() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (code: string) => {\n      const res = await fetch(\"/api/auth/2fa/disable\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ code }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to disable 2FA\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"2fa-status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n    },\n  });\n}\n\n// ===== CLIENT PORTAL API =====\n\nexport type PortalInvite = {\n  id: string;\n  email: string;\n  name: string;\n  organization?: string;\n  token: string;\n  dealIds: string[];\n  accessLevel: string;\n  invitedBy: string;\n  inviterName: string;\n  message?: string;\n  status: string;\n  expiresAt: string;\n  acceptedAt?: string;\n  userId?: string;\n  createdAt: string;\n};\n\nexport type PortalUpdate = {\n  id: string;\n  dealId: string;\n  title: string;\n  content: string;\n  type: string;\n  authorId: string;\n  authorName: string;\n  isPublic: boolean;\n  createdAt: string;\n};\n\nexport type PortalMessage = {\n  id: string;\n  dealId: string;\n  senderId: string;\n  senderName: string;\n  isExternal: boolean;\n  content: string;\n  createdAt: string;\n};\n\n// Get all portal invites (CEO only)\nexport function usePortalInvites() {\n  return useQuery({\n    queryKey: [\"portal-invites\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/portal/invites\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch portal invites\");\n      return res.json() as Promise<PortalInvite[]>;\n    },\n  });\n}\n\n// Create portal invite\nexport function useCreatePortalInvite() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: {\n      email: string;\n      name: string;\n      organization?: string;\n      dealIds: string[];\n      accessLevel?: string;\n      message?: string;\n    }) => {\n      const res = await fetch(\"/api/portal/invites\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create invite\");\n      }\n      return res.json() as Promise<PortalInvite>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"portal-invites\"] });\n    },\n  });\n}\n\n// Revoke portal invite\nexport function useRevokePortalInvite() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/portal/invites/${id}/revoke`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to revoke invite\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"portal-invites\"] });\n    },\n  });\n}\n\n// Get invite details by token (public)\nexport function usePortalInviteByToken(token: string | null) {\n  return useQuery({\n    queryKey: [\"portal-invite-token\", token],\n    queryFn: async () => {\n      if (!token) return null;\n      const res = await fetch(`/api/portal/register/${token}`);\n      if (!res.ok) {\n        if (res.status === 404) return null;\n        throw new Error(\"Failed to fetch invite\");\n      }\n      return res.json() as Promise<{\n        email: string;\n        name: string;\n        organization?: string;\n        inviterName: string;\n        accessLevel: string;\n        dealNames: string[];\n        expiresAt: string;\n      }>;\n    },\n    enabled: !!token,\n  });\n}\n\n// Complete portal registration\nexport function usePortalRegister() {\n  return useMutation({\n    mutationFn: async ({ token, password, phone }: { token: string; password: string; phone?: string }) => {\n      const res = await fetch(`/api/portal/register/${token}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ password, phone }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Registration failed\");\n      }\n      return res.json();\n    },\n  });\n}\n\n// Portal login (external users)\nexport function usePortalLogin() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ email, password }: { email: string; password: string }) => {\n      const res = await fetch(\"/api/portal/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ email, password }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Login failed\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"auth\"] });\n    },\n  });\n}\n\n// Get external user's deals\nexport function usePortalDeals() {\n  return useQuery({\n    queryKey: [\"portal-my-deals\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/portal/my-deals\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch deals\");\n      return res.json() as Promise<Deal[]>;\n    },\n  });\n}\n\n// Get portal updates for a deal\nexport function usePortalUpdates(dealId: string | null) {\n  return useQuery({\n    queryKey: [\"portal-updates\", dealId],\n    queryFn: async () => {\n      if (!dealId) return [];\n      const res = await fetch(`/api/portal/deals/${dealId}/updates`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch updates\");\n      return res.json() as Promise<PortalUpdate[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\n// Create portal update (internal users)\nexport function useCreatePortalUpdate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: {\n      dealId: string;\n      title: string;\n      content: string;\n      type?: string;\n      isPublic?: boolean;\n    }) => {\n      const res = await fetch(`/api/portal/deals/${data.dealId}/updates`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create update\");\n      }\n      return res.json() as Promise<PortalUpdate>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"portal-updates\", vars.dealId] });\n    },\n  });\n}\n\n// Get portal messages for a deal\nexport function usePortalMessages(dealId: string | null) {\n  return useQuery({\n    queryKey: [\"portal-messages\", dealId],\n    queryFn: async () => {\n      if (!dealId) return [];\n      const res = await fetch(`/api/portal/deals/${dealId}/messages`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch messages\");\n      return res.json() as Promise<PortalMessage[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\n// Send portal message\nexport function useSendPortalMessage() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: { dealId: string; content: string }) => {\n      const res = await fetch(`/api/portal/deals/${data.dealId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ content: data.content }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to send message\");\n      }\n      return res.json() as Promise<PortalMessage>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"portal-messages\", vars.dealId] });\n    },\n  });\n}\n\n// Get all external users (CEO only)\nexport function useExternalUsers() {\n  return useQuery({\n    queryKey: [\"external-users\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/portal/users\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch external users\");\n      return res.json();\n    },\n  });\n}\n\n// ===== DEAL FEES HOOKS =====\n\nexport type DealFeeType = {\n  id: string;\n  dealId: string;\n  feeType: string;\n  amount: number | null;\n  percentage: number | null;\n  currency: string | null;\n  description: string | null;\n  billingFrequency: string | null;\n  createdAt: string;\n};\n\nexport function useDealFees(dealId: string) {\n  return useQuery({\n    queryKey: [\"deal-fees\", dealId],\n    queryFn: async () => {\n      const res = await fetch(`/api/deals/${dealId}/fees`);\n      if (!res.ok) throw new Error(\"Failed to fetch deal fees\");\n      return res.json() as Promise<DealFeeType[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useAllDealFees() {\n  return useQuery({\n    queryKey: [\"all-deal-fees\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/deal-fees\");\n      if (!res.ok) throw new Error(\"Failed to fetch all deal fees\");\n      return res.json() as Promise<DealFeeType[]>;\n    },\n  });\n}\n\nexport function useCreateDealFee() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, fee }: { dealId: string; fee: Omit<DealFeeType, 'id' | 'dealId' | 'createdAt'> }) => {\n      const res = await fetch(`/api/deals/${dealId}/fees`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(fee),\n      });\n      if (!res.ok) throw new Error(\"Failed to create deal fee\");\n      return res.json() as Promise<DealFeeType>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-fees\", vars.dealId] });\n      queryClient.invalidateQueries({ queryKey: [\"all-deal-fees\"] });\n    },\n  });\n}\n\nexport function useUpdateDealFee() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<DealFeeType> }) => {\n      const res = await fetch(`/api/deal-fees/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update deal fee\");\n      return res.json() as Promise<DealFeeType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-fees\"] });\n      queryClient.invalidateQueries({ queryKey: [\"all-deal-fees\"] });\n    },\n  });\n}\n\nexport function useDeleteDealFee() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/deal-fees/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete deal fee\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-fees\"] });\n      queryClient.invalidateQueries({ queryKey: [\"all-deal-fees\"] });\n    },\n  });\n}\n\n// ===== STAGE DOCUMENTS HOOKS =====\n\nexport type StageDocumentType = {\n  id: string;\n  dealId: string;\n  stage: string;\n  documentId: string | null;\n  title: string;\n  filename: string | null;\n  url: string | null;\n  mimeType: string | null;\n  size: number | null;\n  uploadedBy: string | null;\n  uploaderName: string | null;\n  createdAt: string;\n};\n\nexport function useStageDocuments(dealId: string, stage?: string) {\n  return useQuery({\n    queryKey: [\"stage-documents\", dealId, stage],\n    queryFn: async () => {\n      const url = stage \n        ? `/api/deals/${dealId}/stage-documents?stage=${encodeURIComponent(stage)}`\n        : `/api/deals/${dealId}/stage-documents`;\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch stage documents\");\n      return res.json() as Promise<StageDocumentType[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateStageDocument() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, doc }: { dealId: string; doc: Omit<StageDocumentType, 'id' | 'dealId' | 'uploadedBy' | 'uploaderName' | 'createdAt'> }) => {\n      const res = await fetch(`/api/deals/${dealId}/stage-documents`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(doc),\n      });\n      if (!res.ok) throw new Error(\"Failed to create stage document\");\n      return res.json() as Promise<StageDocumentType>;\n    },\n    onMutate: async ({ dealId, doc }) => {\n      await queryClient.cancelQueries({ queryKey: [\"stage-documents\", dealId, doc.stage] });\n      const previousDocs = queryClient.getQueryData<StageDocumentType[]>([\"stage-documents\", dealId, doc.stage]);\n      const optimisticDoc: StageDocumentType = {\n        id: `temp-${Date.now()}`,\n        dealId,\n        documentId: null,\n        uploadedBy: null,\n        uploaderName: null,\n        createdAt: new Date().toISOString(),\n        ...doc,\n      };\n      queryClient.setQueryData<StageDocumentType[]>(\n        [\"stage-documents\", dealId, doc.stage],\n        (old) => [...(old || []), optimisticDoc]\n      );\n      return { previousDocs };\n    },\n    onError: (err, vars, context) => {\n      if (context?.previousDocs) {\n        queryClient.setQueryData([\"stage-documents\", vars.dealId, vars.doc.stage], context.previousDocs);\n      }\n    },\n    onSettled: (_, __, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-documents\", vars.dealId, vars.doc.stage] });\n    },\n  });\n}\n\nexport function useDeleteStageDocument() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, dealId, stage }: { id: string; dealId?: string; stage?: string }) => {\n      const res = await fetch(`/api/stage-documents/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete stage document\");\n      return res.json();\n    },\n    onMutate: async ({ id, dealId, stage }) => {\n      if (dealId && stage) {\n        await queryClient.cancelQueries({ queryKey: [\"stage-documents\", dealId, stage] });\n        const previousDocs = queryClient.getQueryData<StageDocumentType[]>([\"stage-documents\", dealId, stage]);\n        queryClient.setQueryData<StageDocumentType[]>(\n          [\"stage-documents\", dealId, stage],\n          (old) => (old || []).filter(doc => doc.id !== id)\n        );\n        return { previousDocs, dealId, stage };\n      }\n      return {};\n    },\n    onError: (err, vars, context) => {\n      if (context?.previousDocs && context?.dealId && context?.stage) {\n        queryClient.setQueryData([\"stage-documents\", context.dealId, context.stage], context.previousDocs);\n      }\n    },\n    onSettled: (_, __, vars) => {\n      if (vars.dealId && vars.stage) {\n        queryClient.invalidateQueries({ queryKey: [\"stage-documents\", vars.dealId, vars.stage] });\n      } else {\n        queryClient.invalidateQueries({ queryKey: [\"stage-documents\"] });\n      }\n    },\n  });\n}\n\n// ===== STAGE POD MEMBERS HOOKS =====\n\nexport type StagePodMemberType = {\n  id: string;\n  dealId: string;\n  stage: string;\n  userId: string;\n  userName: string;\n  role: string;\n  email: string | null;\n  phone: string | null;\n  isLead: boolean | null;\n  createdAt: string;\n};\n\nexport function useStagePodMembers(dealId: string, stage?: string) {\n  return useQuery({\n    queryKey: [\"stage-pod-members\", dealId, stage],\n    queryFn: async () => {\n      const url = stage \n        ? `/api/deals/${dealId}/stage-pod-members?stage=${encodeURIComponent(stage)}`\n        : `/api/deals/${dealId}/stage-pod-members`;\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch stage pod members\");\n      return res.json() as Promise<StagePodMemberType[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateStagePodMember() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, member }: { dealId: string; member: Omit<StagePodMemberType, 'id' | 'dealId' | 'createdAt'> }) => {\n      const res = await fetch(`/api/deals/${dealId}/stage-pod-members`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(member),\n      });\n      if (!res.ok) throw new Error(\"Failed to add stage pod member\");\n      return res.json() as Promise<StagePodMemberType>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-pod-members\", vars.dealId] });\n    },\n  });\n}\n\nexport function useUpdateStagePodMember() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<StagePodMemberType> }) => {\n      const res = await fetch(`/api/stage-pod-members/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update stage pod member\");\n      return res.json() as Promise<StagePodMemberType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-pod-members\"] });\n    },\n  });\n}\n\nexport function useDeleteStagePodMember() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/stage-pod-members/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to remove stage pod member\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-pod-members\"] });\n    },\n  });\n}\n\n// ===== STAGE VOICE NOTES HOOKS =====\n\nexport type StageVoiceNoteType = {\n  id: string;\n  dealId: string;\n  stage: string;\n  title: string;\n  filename: string;\n  url: string | null;\n  duration: number | null;\n  transcript: string | null;\n  recordedBy: string | null;\n  recorderName: string | null;\n  createdAt: string;\n};\n\nexport function useStageVoiceNotes(dealId: string, stage?: string) {\n  return useQuery({\n    queryKey: [\"stage-voice-notes\", dealId, stage],\n    queryFn: async () => {\n      const url = stage \n        ? `/api/deals/${dealId}/stage-voice-notes?stage=${encodeURIComponent(stage)}`\n        : `/api/deals/${dealId}/stage-voice-notes`;\n      const res = await fetch(url);\n      if (!res.ok) throw new Error(\"Failed to fetch stage voice notes\");\n      return res.json() as Promise<StageVoiceNoteType[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateStageVoiceNote() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, note }: { dealId: string; note: Omit<StageVoiceNoteType, 'id' | 'dealId' | 'recordedBy' | 'recorderName' | 'createdAt'> }) => {\n      const res = await fetch(`/api/deals/${dealId}/stage-voice-notes`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(note),\n      });\n      if (!res.ok) throw new Error(\"Failed to create stage voice note\");\n      return res.json() as Promise<StageVoiceNoteType>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-voice-notes\", vars.dealId] });\n    },\n  });\n}\n\nexport function useDeleteStageVoiceNote() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/stage-voice-notes/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete stage voice note\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"stage-voice-notes\"] });\n    },\n  });\n}\n\n// ===== TASK COMMENTS HOOKS =====\n\nexport type TaskCommentType = {\n  id: string;\n  taskId: string;\n  userId: string;\n  userName: string;\n  userAvatar: string | null;\n  content: string;\n  createdAt: string;\n  updatedAt: string;\n};\n\nexport function useTaskComments(taskId: string) {\n  return useQuery({\n    queryKey: [\"task-comments\", taskId],\n    queryFn: async () => {\n      const res = await fetch(`/api/tasks/${taskId}/comments`);\n      if (!res.ok) throw new Error(\"Failed to fetch task comments\");\n      return res.json() as Promise<TaskCommentType[]>;\n    },\n    enabled: !!taskId,\n  });\n}\n\nexport function useCreateTaskComment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ taskId, content }: { taskId: string; content: string }) => {\n      const res = await fetch(`/api/tasks/${taskId}/comments`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to create task comment\");\n      return res.json() as Promise<TaskCommentType>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"task-comments\", vars.taskId] });\n    },\n  });\n}\n\nexport function useUpdateTaskComment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, content }: { id: string; content: string }) => {\n      const res = await fetch(`/api/task-comments/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to update task comment\");\n      return res.json() as Promise<TaskCommentType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"task-comments\"] });\n    },\n  });\n}\n\nexport function useDeleteTaskComment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/task-comments/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete task comment\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"task-comments\"] });\n    },\n  });\n}\n\n// ===== DEAL NOTES HOOKS =====\n\nexport type DealNoteType = {\n  id: string;\n  dealId: string;\n  userId: string;\n  userName: string;\n  userAvatar: string | null;\n  content: string;\n  createdAt: string;\n  updatedAt: string;\n};\n\nexport function useDealNotes(dealId: string) {\n  return useQuery({\n    queryKey: [\"deal-notes\", dealId],\n    queryFn: async () => {\n      const res = await fetch(`/api/deals/${dealId}/notes`);\n      if (!res.ok) throw new Error(\"Failed to fetch deal notes\");\n      return res.json() as Promise<DealNoteType[]>;\n    },\n    enabled: !!dealId,\n  });\n}\n\nexport function useCreateDealNote() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ dealId, content }: { dealId: string; content: string }) => {\n      const res = await fetch(`/api/deals/${dealId}/notes`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to create deal note\");\n      return res.json() as Promise<DealNoteType>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-notes\", vars.dealId] });\n    },\n  });\n}\n\nexport function useUpdateDealNote() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, content }: { id: string; content: string }) => {\n      const res = await fetch(`/api/deal-notes/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to update deal note\");\n      return res.json() as Promise<DealNoteType>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-notes\"] });\n    },\n  });\n}\n\nexport function useDeleteDealNote() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/deal-notes/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete deal note\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"deal-notes\"] });\n    },\n  });\n}\n\n// ===== USER SEARCH HOOK =====\n\nexport type UserSearchResult = {\n  id: string;\n  name: string;\n  email: string;\n  phone: string | null;\n  role: string;\n  avatar: string | null;\n};\n\nexport function useUserSearch(query: string) {\n  return useQuery({\n    queryKey: [\"user-search\", query],\n    queryFn: async () => {\n      if (!query || query.length < 2) return [];\n      const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);\n      if (!res.ok) throw new Error(\"Failed to search users\");\n      return res.json() as Promise<UserSearchResult[]>;\n    },\n    enabled: query.length >= 2,\n  });\n}\n\n// ===== FORMS API =====\n\n// Branching condition - show field when another field has specific value\nexport interface FormBranchCondition {\n  fieldId: string;\n  operator: 'equals' | 'not_equals' | 'contains';\n  value: string;\n}\n\n// Table column definition\nexport interface FormTableColumn {\n  id: string;\n  header: string;\n}\n\n// Table cell\nexport interface FormTableCell {\n  value: string;\n}\n\n// Content block for rich text\nexport interface FormContentBlock {\n  type: 'paragraph' | 'heading' | 'list' | 'link';\n  text?: string;\n  items?: string[];\n  url?: string;\n  linkText?: string;\n}\n\nexport interface FormField {\n  id: string;\n  type: 'text' | 'email' | 'single-select' | 'multi-select' | 'date' | 'number' | 'file' | 'heading' | 'textarea' | 'table' | 'content';\n  label: string;\n  required: boolean;\n  options?: string[];\n  description?: string;\n  placeholder?: string;\n  // Branching support\n  showWhen?: FormBranchCondition;\n  // Table support\n  tableColumns?: FormTableColumn[];\n  tableRows?: FormTableCell[][];\n  // Rich content support\n  contentBlocks?: FormContentBlock[];\n}\n\nexport interface Form {\n  id: string;\n  title: string;\n  description: string | null;\n  coverImage: string | null;\n  fields: FormField[];\n  status: 'draft' | 'published' | 'archived';\n  shareToken: string | null;\n  createdBy: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface FormSubmission {\n  id: string;\n  formId: string;\n  formTitle: string;\n  submitterName: string | null;\n  submitterEmail: string | null;\n  submitterId: string | null;\n  responses: Array<{ fieldId: string; value: any }>;\n  taskId: string | null;\n  status: string;\n  createdAt: string;\n}\n\nexport function useForms() {\n  return useQuery({\n    queryKey: [\"forms\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/forms\");\n      if (!res.ok) {\n        if (res.status === 403) return [];\n        throw new Error(\"Failed to fetch forms\");\n      }\n      return res.json() as Promise<Form[]>;\n    },\n  });\n}\n\nexport function useForm(id: string | undefined) {\n  return useQuery({\n    queryKey: [\"forms\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/forms/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch form\");\n      return res.json() as Promise<Form>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport function useCreateForm() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: { title: string; description?: string; fields?: FormField[] }) => {\n      const res = await fetch(\"/api/forms\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create form\");\n      }\n      return res.json() as Promise<Form>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"forms\"] });\n    },\n  });\n}\n\nexport function useUpdateForm() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, ...data }: { id: string; title?: string; description?: string; coverImage?: string | null; fields?: FormField[]; status?: string }) => {\n      const res = await fetch(`/api/forms/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error(\"Failed to update form\");\n      return res.json() as Promise<Form>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"forms\"] });\n      queryClient.invalidateQueries({ queryKey: [\"forms\", vars.id] });\n    },\n  });\n}\n\nexport function usePublishForm() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/forms/${id}/publish`, { method: \"POST\" });\n      if (!res.ok) throw new Error(\"Failed to publish form\");\n      return res.json() as Promise<Form>;\n    },\n    onSuccess: (_, id) => {\n      queryClient.invalidateQueries({ queryKey: [\"forms\"] });\n      queryClient.invalidateQueries({ queryKey: [\"forms\", id] });\n    },\n  });\n}\n\nexport function useDeleteForm() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/forms/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete form\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"forms\"] });\n    },\n  });\n}\n\nexport function useUnpublishForm() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/forms/${id}/unpublish`, { method: \"POST\" });\n      if (!res.ok) throw new Error(\"Failed to unpublish form\");\n      return res.json() as Promise<Form>;\n    },\n    onSuccess: (_, id) => {\n      queryClient.invalidateQueries({ queryKey: [\"forms\"] });\n      queryClient.invalidateQueries({ queryKey: [\"forms\", id] });\n    },\n  });\n}\n\nexport function useShareForm() {\n  return useMutation({\n    mutationFn: async ({ id, emails, message }: { id: string; emails: string[]; message?: string }) => {\n      const res = await fetch(`/api/forms/${id}/share`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ emails, message }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to share form\");\n      }\n      return res.json() as Promise<{ success: boolean; results: any[]; formLink: string }>;\n    },\n  });\n}\n\nexport function useFormSubmissions(formId: string | undefined) {\n  return useQuery({\n    queryKey: [\"form-submissions\", formId],\n    queryFn: async () => {\n      const res = await fetch(`/api/forms/${formId}/submissions`);\n      if (!res.ok) throw new Error(\"Failed to fetch submissions\");\n      return res.json() as Promise<FormSubmission[]>;\n    },\n    enabled: !!formId,\n  });\n}\n\nexport function usePublicForm(shareToken: string | undefined) {\n  return useQuery({\n    queryKey: [\"public-form\", shareToken],\n    queryFn: async () => {\n      const res = await fetch(`/api/public/forms/${shareToken}`);\n      if (!res.ok) throw new Error(\"Failed to fetch form\");\n      return res.json() as Promise<Partial<Form>>;\n    },\n    enabled: !!shareToken,\n  });\n}\n\nexport function useSubmitPublicForm() {\n  return useMutation({\n    mutationFn: async ({ shareToken, responses, submitterName, submitterEmail }: {\n      shareToken: string;\n      responses: Array<{ fieldId: string; value: any }>;\n      submitterName?: string;\n      submitterEmail?: string;\n    }) => {\n      const res = await fetch(`/api/public/forms/${shareToken}/submit`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ responses, submitterName, submitterEmail }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to submit form\");\n      }\n      return res.json();\n    },\n  });\n}\n\n// ===== TASK TEMPLATES =====\n\nexport interface TemplateTask {\n  id: string;\n  title: string;\n  description?: string;\n  assigneeId?: string;\n  relativeDueDays?: number;\n  position: number;\n}\n\nexport interface TemplateSection {\n  id: string;\n  title: string;\n  position: number;\n  tasks: TemplateTask[];\n}\n\nexport interface TaskTemplate {\n  id: string;\n  name: string;\n  description: string | null;\n  category: string;\n  sections: TemplateSection[];\n  isArchived: boolean | null;\n  usageCount: number | null;\n  createdBy: string | null;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface TaskTemplateUsage {\n  id: string;\n  templateId: string;\n  templateName: string;\n  appliedBy: string;\n  contextType: string | null;\n  contextName: string | null;\n  tasksCreated: number | null;\n  startDate: string;\n  createdAt: string;\n}\n\nexport function useTaskTemplates() {\n  return useQuery({\n    queryKey: [\"task-templates\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/task-templates\");\n      if (!res.ok) {\n        if (res.status === 403) return [];\n        throw new Error(\"Failed to fetch task templates\");\n      }\n      return res.json() as Promise<TaskTemplate[]>;\n    },\n  });\n}\n\nexport function useTaskTemplate(id: string | undefined) {\n  return useQuery({\n    queryKey: [\"task-templates\", id],\n    queryFn: async () => {\n      const res = await fetch(`/api/task-templates/${id}`);\n      if (!res.ok) throw new Error(\"Failed to fetch task template\");\n      return res.json() as Promise<TaskTemplate>;\n    },\n    enabled: !!id,\n  });\n}\n\nexport function useCreateTaskTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (data: { name: string; description?: string; category?: string; sections?: TemplateSection[] }) => {\n      const res = await fetch(\"/api/task-templates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create task template\");\n      }\n      return res.json() as Promise<TaskTemplate>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"task-templates\"] });\n    },\n  });\n}\n\nexport function useUpdateTaskTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, ...data }: { id: string; name?: string; description?: string; category?: string; sections?: TemplateSection[]; isArchived?: boolean }) => {\n      const res = await fetch(`/api/task-templates/${id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error(\"Failed to update task template\");\n      return res.json() as Promise<TaskTemplate>;\n    },\n    onSuccess: (_, vars) => {\n      queryClient.invalidateQueries({ queryKey: [\"task-templates\"] });\n      queryClient.invalidateQueries({ queryKey: [\"task-templates\", vars.id] });\n    },\n  });\n}\n\nexport function useDeleteTaskTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/task-templates/${id}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete task template\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"task-templates\"] });\n    },\n  });\n}\n\nexport function useApplyTaskTemplate() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ id, startDate, contextType, contextName, assigneeOverrides }: {\n      id: string;\n      startDate?: string;\n      contextType?: string;\n      contextName?: string;\n      assigneeOverrides?: Record<string, string>;\n    }) => {\n      const res = await fetch(`/api/task-templates/${id}/apply`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ startDate, contextType, contextName, assigneeOverrides }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to apply task template\");\n      }\n      return res.json() as Promise<{ success: boolean; tasksCreated: number; tasks: any[] }>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"task-templates\"] });\n    },\n  });\n}\n\nexport function useTaskTemplateUsage(templateId: string | undefined) {\n  return useQuery({\n    queryKey: [\"task-template-usage\", templateId],\n    queryFn: async () => {\n      const res = await fetch(`/api/task-templates/${templateId}/usage`);\n      if (!res.ok) throw new Error(\"Failed to fetch template usage\");\n      return res.json() as Promise<TaskTemplateUsage[]>;\n    },\n    enabled: !!templateId,\n  });\n}\n\n// ===== PERSONALITY ASSESSMENT =====\n\nexport type PersonalityQuestion = {\n  id: number;\n  question: string;\n  optionA: string;\n  optionB: string;\n};\n\nexport type PersonalityScore = {\n  profile: string;\n  score: number;\n};\n\nexport type DeploymentTags = {\n  dealTeamStatus: string;\n  primaryVertical: string;\n  secondaryVertical: string;\n  primaryDealPhase: string;\n  secondaryDealPhase: string;\n  topFiveArchetypes: string[];\n  riskFlag: string | null;\n};\n\nexport type AIAnalysis = {\n  employeeSnapshot: string;\n  scoreDistribution: string;\n  primaryArchetype: string;\n  secondaryTraits: string;\n  supportingTraits: string;\n  lowSignalTags: string;\n  absentTraits: string;\n  dealPhaseFit: string;\n  dealTypeProficiency: string;\n  managerialNotes: string;\n  deploymentTags: DeploymentTags;\n  rawResponse: string;\n};\n\nexport type PersonalityAssessment = {\n  id: string;\n  userId: string;\n  answers: Record<number, 'A' | 'B'>;\n  allScores: PersonalityScore[];\n  topThreeProfiles: PersonalityScore[];\n  aiAnalysis: AIAnalysis | null;\n  status: string; // 'pending' | 'analyzing' | 'completed' | 'failed'\n  completedAt: string | null;\n  createdAt: string;\n};\n\nexport function usePersonalityQuestions() {\n  return useQuery({\n    queryKey: [\"personality-questions\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/personality/questions\");\n      if (!res.ok) throw new Error(\"Failed to fetch personality questions\");\n      return res.json() as Promise<PersonalityQuestion[]>;\n    },\n  });\n}\n\nexport function usePersonalityAssessment() {\n  return useQuery({\n    queryKey: [\"personality-assessment\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/personality/assessment\");\n      if (!res.ok) throw new Error(\"Failed to fetch personality assessment\");\n      return res.json() as Promise<PersonalityAssessment | null>;\n    },\n    refetchInterval: (query) => {\n      // Poll every 2 seconds while analyzing\n      if (query.state.data?.status === 'analyzing') return 2000;\n      return false;\n    },\n  });\n}\n\nexport function useUserPersonalityAssessment(userId: string | undefined) {\n  return useQuery({\n    queryKey: [\"personality-assessment\", userId],\n    queryFn: async () => {\n      const res = await fetch(`/api/personality/assessment/${userId}`);\n      if (!res.ok) throw new Error(\"Failed to fetch personality assessment\");\n      return res.json() as Promise<PersonalityAssessment | null>;\n    },\n    enabled: !!userId,\n  });\n}\n\nexport function useSubmitPersonalityAssessment() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async ({ answers, dealTeamStatus }: { answers: Record<number, 'A' | 'B'>; dealTeamStatus?: string }) => {\n      const res = await fetch(\"/api/personality/assessment\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ answers, dealTeamStatus }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to submit assessment\");\n      }\n      return res.json() as Promise<PersonalityAssessment>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"personality-assessment\"] });\n    },\n  });\n}\n\n// ===== RESUME ANALYSIS =====\n\nexport type OnboardingPlacement = {\n  assignedDealTeam: string;\n  primaryVertical: string;\n  secondaryVertical: string;\n  primaryDealPhase: string;\n  secondaryDealPhase: string;\n  initialSeatRecommendation: string;\n  topFiveInferredTags: string[];\n  coverageGaps: string;\n};\n\nexport type ResumeAIAnalysis = {\n  candidateSnapshot: string;\n  evidenceAnchors: string;\n  transactionProfile: string;\n  roleElevationAutonomy: string;\n  dealPhaseFit: string;\n  dealTypeProficiency: string;\n  resumeInferredTags: string;\n  managerialNotes: string;\n  onboardingPlacement: OnboardingPlacement;\n  rawResponse: string;\n};\n\nexport type ResumeAnalysis = {\n  id: string;\n  userId: string;\n  fileName: string;\n  fileContent: string | null;\n  aiAnalysis: ResumeAIAnalysis | null;\n  assignedDealTeam: string | null;\n  status: string; // 'pending' | 'analyzing' | 'completed' | 'failed'\n  completedAt: string | null;\n  createdAt: string;\n};\n\nexport function useResumeAnalysis() {\n  return useQuery({\n    queryKey: [\"resume-analysis\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/resume/analysis\");\n      if (!res.ok) throw new Error(\"Failed to fetch resume analysis\");\n      return res.json() as Promise<ResumeAnalysis | null>;\n    },\n    refetchInterval: (query) => {\n      if (query.state.data?.status === 'analyzing') return 2000;\n      return false;\n    },\n  });\n}\n\nexport function useUploadResume() {\n  const queryClient = useQueryClient();\n  return useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('resume', file);\n      \n      const res = await fetch(\"/api/resume/analyze\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to upload resume\");\n      }\n      return res.json() as Promise<ResumeAnalysis>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"resume-analysis\"] });\n    },\n  });\n}\n","path":null,"size_bytes":116388,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":724,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // @replit\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \",\n  {\n    variants: {\n      variant: {\n        default:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary:\n          // @replit no hover because we use hover-elevate\n          \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n          // @replit shadow-xs\" - use badge outline variable\n        outline: \"text-foreground border [border-color:var(--badge-outline)]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1522,"size_tokens":null},"server/email.ts":{"content":"// Resend email service integration\n// Uses Replit Connectors for secure API key management\n\nimport { Resend } from 'resend';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || (!connectionSettings.settings.api_key)) {\n    throw new Error('Resend not connected');\n  }\n  return { apiKey: connectionSettings.settings.api_key, fromEmail: connectionSettings.settings.from_email };\n}\n\nasync function getUncachableResendClient() {\n  const credentials = await getCredentials();\n  // Use Resend's test sender for development\n  // For production: verify your domain at https://resend.com/domains\n  // Then update the Resend connector settings with your verified from_email\n  const configuredEmail = credentials.fromEmail;\n  \n  // If using an unverified custom domain, fallback to test sender\n  // The test sender only works for emails to the Resend account owner\n  const isVerifiedDomain = configuredEmail && (\n    configuredEmail.endsWith('@resend.dev') ||\n    configuredEmail.endsWith('.replit.dev') ||\n    process.env.RESEND_DOMAIN_VERIFIED === 'true'\n  );\n  \n  const fromEmail = isVerifiedDomain ? configuredEmail : 'Kronos <onboarding@resend.dev>';\n  \n  return {\n    client: new Resend(credentials.apiKey),\n    fromEmail: fromEmail,\n    isTestMode: !isVerifiedDomain\n  };\n}\n\nexport interface MeetingInviteData {\n  title: string;\n  description?: string;\n  scheduledFor: Date;\n  location?: string;\n  videoLink?: string;\n  videoPlatform?: string;\n  attendeeEmails: string[];\n  organizerName: string;\n  localDate?: string;\n  localTime?: string;\n  organizerTimezone?: string;\n}\n\nexport async function sendMeetingInvite(data: MeetingInviteData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    let formattedDate: string;\n    let formattedTime: string;\n    \n    // Use the original local date/time strings if provided (preserves organizer's intent)\n    if (data.localDate && data.localTime) {\n      // Parse the date string (YYYY-MM-DD format)\n      const [year, month, day] = data.localDate.split('-').map(Number);\n      const months = ['January', 'February', 'March', 'April', 'May', 'June',\n                      'July', 'August', 'September', 'October', 'November', 'December'];\n      const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n      \n      // Create a date object to get the day of week\n      const dateObj = new Date(year, month - 1, day);\n      formattedDate = `${weekdays[dateObj.getDay()]}, ${months[month - 1]} ${day}, ${year}`;\n      \n      // Parse and format time (HH:MM format)\n      const [hours, mins] = data.localTime.split(':').map(Number);\n      const hour12 = hours % 12 || 12;\n      const ampm = hours >= 12 ? 'PM' : 'AM';\n      formattedTime = `${hour12}:${mins.toString().padStart(2, '0')} ${ampm}`;\n      \n      // Add timezone if available\n      if (data.organizerTimezone) {\n        formattedTime += ` (${data.organizerTimezone})`;\n      }\n    } else {\n      // Fallback: format from UTC timestamp\n      const meetingDate = new Date(data.scheduledFor);\n      const months = ['January', 'February', 'March', 'April', 'May', 'June',\n                      'July', 'August', 'September', 'October', 'November', 'December'];\n      const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n      formattedDate = `${weekdays[meetingDate.getUTCDay()]}, ${months[meetingDate.getUTCMonth()]} ${meetingDate.getUTCDate()}, ${meetingDate.getUTCFullYear()}`;\n      \n      const hours = meetingDate.getUTCHours();\n      const minutes = meetingDate.getUTCMinutes();\n      const hour12 = hours % 12 || 12;\n      const ampm = hours >= 12 ? 'PM' : 'AM';\n      formattedTime = `${hour12}:${minutes.toString().padStart(2, '0')} ${ampm} UTC`;\n    }\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .meeting-details { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .detail-row { display: flex; margin: 12px 0; }\n            .detail-label { font-weight: 600; width: 100px; color: #666; }\n            .detail-value { color: #1a1a2e; }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n            .btn { display: inline-block; background: #1a1a2e; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin-top: 20px; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Meeting Invitation</h1>\n              <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">You've been invited to a meeting</p>\n            </div>\n            <div class=\"content\">\n              <p>Hi,</p>\n              <p><strong>${data.organizerName}</strong> has invited you to the following meeting:</p>\n              \n              <div class=\"meeting-details\">\n                <h2 style=\"margin: 0 0 15px 0; color: #1a1a2e;\">${data.title}</h2>\n                ${data.description ? `<p style=\"color: #666; margin-bottom: 20px;\">${data.description}</p>` : ''}\n                \n                <div class=\"detail-row\">\n                  <span class=\"detail-label\">Date:</span>\n                  <span class=\"detail-value\">${formattedDate}</span>\n                </div>\n                <div class=\"detail-row\">\n                  <span class=\"detail-label\">Time:</span>\n                  <span class=\"detail-value\">${formattedTime}</span>\n                </div>\n                ${data.location ? `\n                <div class=\"detail-row\">\n                  <span class=\"detail-label\">Location:</span>\n                  <span class=\"detail-value\">${data.location}</span>\n                </div>\n                ` : ''}\n                ${data.videoLink ? `\n                <div class=\"detail-row\">\n                  <span class=\"detail-label\">Video:</span>\n                  <span class=\"detail-value\">\n                    <a href=\"${data.videoLink}\" style=\"color: #1a1a2e;\">${\n                      data.videoPlatform === 'zoom' ? 'Join Zoom Meeting' :\n                      data.videoPlatform === 'google_meet' ? 'Join Google Meet' :\n                      data.videoPlatform === 'teams' ? 'Join Microsoft Teams' : 'Join Video Call'\n                    }</a>\n                  </span>\n                </div>\n                ` : ''}\n              </div>\n              \n              ${data.videoLink ? `\n              <a href=\"${data.videoLink}\" class=\"btn\" style=\"color: white; text-decoration: none;\">Join Video Meeting</a>\n              ` : ''}\n              \n              <p>Please add this to your calendar and be prepared to join at the scheduled time.</p>\n            </div>\n            <div class=\"footer\">\n              <p>This invitation was sent via Kronos</p>\n              <p>Investment Banking Operations Platform</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const emailText = `\nMeeting Invitation\n\nYou've been invited to a meeting by ${data.organizerName}.\n\nTitle: ${data.title}\n${data.description ? `Description: ${data.description}` : ''}\nDate: ${formattedDate}\nTime: ${formattedTime}\n${data.location ? `Location: ${data.location}` : ''}\n${data.videoLink ? `Video Conference: ${data.videoLink}` : ''}\n\nPlease add this to your calendar and be prepared to join at the scheduled time.\n\n---\nThis invitation was sent via Kronos\nInvestment Banking Operations Platform\n    `.trim();\n\n    const results = await Promise.all(\n      data.attendeeEmails.map(email =>\n        client.emails.send({\n          from: fromEmail,\n          to: email,\n          subject: `Meeting Invitation: ${data.title}`,\n          html: emailHtml,\n          text: emailText,\n        })\n      )\n    );\n\n    const failed = results.filter(r => r.error);\n    if (failed.length > 0) {\n      console.error('Some emails failed to send:', failed);\n      return { success: false, error: `Failed to send ${failed.length} of ${results.length} emails` };\n    }\n\n    console.log(`Successfully sent ${results.length} meeting invites for: ${data.title}`);\n    return { success: true };\n  } catch (error) {\n    console.error('Failed to send meeting invite:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport async function sendNotificationEmail(\n  to: string,\n  subject: string,\n  message: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n\n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .message { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Kronos Notification</h1>\n            </div>\n            <div class=\"content\">\n              <div class=\"message\">\n                <p>${message}</p>\n              </div>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to,\n      subject,\n      html: emailHtml,\n      text: message,\n    });\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error('Failed to send notification email:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport interface PasswordResetEmailData {\n  email: string;\n  userName: string;\n  resetLink: string;\n}\n\nexport async function sendPasswordResetEmail(data: PasswordResetEmailData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; margin: 0; padding: 0; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .message { background: white; border-radius: 8px; padding: 25px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .button { display: inline-block; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 20px 0; }\n            .button:hover { opacity: 0.9; }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n            .warning { color: #666; font-size: 13px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Password Reset Request</h1>\n            </div>\n            <div class=\"content\">\n              <div class=\"message\">\n                <p>Hi ${data.userName},</p>\n                <p>We received a request to reset your password for your Kronos account. Click the button below to create a new password:</p>\n                <p style=\"text-align: center;\">\n                  <a href=\"${data.resetLink}\" class=\"button\">Reset Password</a>\n                </p>\n                <p class=\"warning\">\n                  <strong>Security Notice:</strong> This link will expire in 1 hour. If you didn't request a password reset, you can safely ignore this email - your password will remain unchanged.\n                </p>\n              </div>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n              <p>This is an automated message, please do not reply.</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: data.email,\n      subject: 'Reset Your Kronos Password',\n      html: emailHtml,\n      text: `Hi ${data.userName}, We received a request to reset your password. Visit this link to reset it: ${data.resetLink}. This link expires in 1 hour. If you didn't request this, you can ignore this email.`,\n    });\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error('Failed to send password reset email:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport interface PortalInviteEmailData {\n  to: string;\n  recipientName: string;\n  inviterName: string;\n  organization?: string;\n  message?: string;\n  token: string;\n  expiresAt: Date;\n}\n\nexport async function sendPortalInviteEmail(data: PortalInviteEmailData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    // Build the registration URL\n    const baseUrl = process.env.REPLIT_DEV_DOMAIN \n      ? `https://${process.env.REPLIT_DEV_DOMAIN}`\n      : process.env.REPLIT_DOMAINS\n        ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n        : 'http://localhost:5000';\n    const registerUrl = `${baseUrl}/portal/register/${data.token}`;\n    \n    // Format expiration date\n    const expiresDate = new Date(data.expiresAt);\n    const months = ['January', 'February', 'March', 'April', 'May', 'June',\n                    'July', 'August', 'September', 'October', 'November', 'December'];\n    const formattedExpiry = `${months[expiresDate.getMonth()]} ${expiresDate.getDate()}, ${expiresDate.getFullYear()}`;\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; margin: 0; padding: 0; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .message-box { background: white; border-radius: 8px; padding: 25px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .button { display: inline-block; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 20px 0; }\n            .button:hover { opacity: 0.9; }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n            .personal-message { background: #f0f4ff; border-left: 4px solid #1a1a2e; padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }\n            .expiry { color: #666; font-size: 13px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Client Portal Invitation</h1>\n              <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">You've been invited to Kronos</p>\n            </div>\n            <div class=\"content\">\n              <div class=\"message-box\">\n                <p>Hi ${data.recipientName},</p>\n                <p><strong>${data.inviterName}</strong> has invited you to access the Kronos Client Portal${data.organization ? ` for <strong>${data.organization}</strong>` : ''}.</p>\n                \n                ${data.message ? `\n                <div class=\"personal-message\">\n                  <p style=\"margin: 0; font-style: italic;\">\"${data.message}\"</p>\n                  <p style=\"margin: 10px 0 0 0; font-size: 12px; color: #666;\"> ${data.inviterName}</p>\n                </div>\n                ` : ''}\n                \n                <p>Through the portal, you'll be able to:</p>\n                <ul>\n                  <li>View deal progress and updates</li>\n                  <li>Access shared documents</li>\n                  <li>Communicate with the team</li>\n                </ul>\n                \n                <p style=\"text-align: center;\">\n                  <a href=\"${registerUrl}\" class=\"button\">Accept Invitation</a>\n                </p>\n                \n                <p class=\"expiry\">\n                  <strong>Note:</strong> This invitation expires on ${formattedExpiry}. If you have any questions, please reach out to ${data.inviterName}.\n                </p>\n              </div>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n              <p>This is an automated message from Kronos.</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const emailText = `\nClient Portal Invitation\n\nHi ${data.recipientName},\n\n${data.inviterName} has invited you to access the Kronos Client Portal${data.organization ? ` for ${data.organization}` : ''}.\n\n${data.message ? `Personal message from ${data.inviterName}: \"${data.message}\"` : ''}\n\nThrough the portal, you'll be able to:\n- View deal progress and updates\n- Access shared documents\n- Communicate with the team\n\nTo accept this invitation, visit: ${registerUrl}\n\nThis invitation expires on ${formattedExpiry}.\n\n---\nKronos - Investment Banking Operations Platform\n    `.trim();\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: data.to,\n      subject: `${data.inviterName} invited you to Kronos Client Portal`,\n      html: emailHtml,\n      text: emailText,\n    });\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    console.log(`Successfully sent portal invite to: ${data.to}`);\n    return { success: true };\n  } catch (error) {\n    console.error('Failed to send portal invite email:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport interface UserInviteEmailData {\n  email: string;\n  userName: string;\n  inviterName: string;\n  accessLevel: string;\n  jobTitle?: string;\n  setupLink: string;\n}\n\nexport async function sendUserInviteEmail(data: UserInviteEmailData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const accessLevelDisplay = data.accessLevel === 'admin' ? 'Admin' : 'Standard';\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; margin: 0; padding: 0; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; text-align: center; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .message-box { background: white; border-radius: 8px; padding: 25px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .button { display: inline-block; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white !important; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 20px 0; }\n            .button:hover { opacity: 0.9; }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n            .details { background: #f0f4ff; border-left: 4px solid #1a1a2e; padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }\n            .expiry { color: #666; font-size: 13px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Welcome to Kronos</h1>\n              <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">You've been invited to join the team</p>\n            </div>\n            <div class=\"content\">\n              <div class=\"message-box\">\n                <p>Hi ${data.userName},</p>\n                <p><strong>${data.inviterName}</strong> has invited you to join Kronos, our investment banking operations platform.</p>\n                \n                <div class=\"details\">\n                  <p style=\"margin: 0;\"><strong>Your Account Details:</strong></p>\n                  <p style=\"margin: 5px 0;\">Access Level: <strong>${accessLevelDisplay}</strong></p>\n                  ${data.jobTitle ? `<p style=\"margin: 5px 0;\">Job Title: <strong>${data.jobTitle}</strong></p>` : ''}\n                </div>\n                \n                <p>Click the button below to set up your password and activate your account:</p>\n                \n                <p style=\"text-align: center;\">\n                  <a href=\"${data.setupLink}\" class=\"button\">Set Up Your Account</a>\n                </p>\n                \n                <p class=\"expiry\">\n                  <strong>Note:</strong> This invitation link expires in 24 hours. If you have any questions, please reach out to ${data.inviterName}.\n                </p>\n              </div>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n              <p>This is an automated message from Kronos.</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const emailText = `\nWelcome to Kronos\n\nHi ${data.userName},\n\n${data.inviterName} has invited you to join Kronos, our investment banking operations platform.\n\nYour Account Details:\n- Access Level: ${accessLevelDisplay}\n${data.jobTitle ? `- Job Title: ${data.jobTitle}` : ''}\n\nTo set up your password and activate your account, visit: ${data.setupLink}\n\nThis invitation link expires in 24 hours.\n\n---\nKronos - Investment Banking Operations Platform\n    `.trim();\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: data.email,\n      subject: `${data.inviterName} invited you to join Kronos`,\n      html: emailHtml,\n      text: emailText,\n    });\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    console.log(`Successfully sent user invite to: ${data.email}`);\n    return { success: true };\n  } catch (error) {\n    console.error('Failed to send user invite email:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport interface ExternalWorkEmailData {\n  recipientEmail: string;\n  recipientName: string;\n  senderName: string;\n  taskTitle: string;\n  message: string;\n  attachments?: { filename: string; url: string }[];\n}\n\nexport async function sendExternalWorkEmail(data: ExternalWorkEmailData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const attachmentLinks = data.attachments && data.attachments.length > 0\n      ? data.attachments.map(a => `<li><a href=\"${a.url}\" style=\"color: #1a1a2e;\">${a.filename}</a></li>`).join('')\n      : '';\n    \n    const attachmentSection = attachmentLinks \n      ? `\n        <div style=\"background: #f0f4ff; border-left: 4px solid #1a1a2e; padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0;\">\n          <p style=\"margin: 0 0 10px 0;\"><strong>Attachments:</strong></p>\n          <ul style=\"margin: 0; padding-left: 20px;\">${attachmentLinks}</ul>\n        </div>\n      `\n      : '';\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; margin: 0; padding: 0; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 12px 12px; }\n            .message-box { background: white; border-radius: 8px; padding: 25px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n            .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>${data.taskTitle}</h1>\n              <p style=\"margin: 10px 0 0 0; opacity: 0.9;\">Work delivery from ${data.senderName}</p>\n            </div>\n            <div class=\"content\">\n              <div class=\"message-box\">\n                <p>Hi ${data.recipientName},</p>\n                <p><strong>${data.senderName}</strong> has sent you completed work regarding: <strong>${data.taskTitle}</strong></p>\n                \n                ${data.message ? `\n                <div style=\"background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;\">\n                  <p style=\"margin: 0; white-space: pre-wrap;\">${data.message}</p>\n                </div>\n                ` : ''}\n                \n                ${attachmentSection}\n                \n                <p style=\"color: #666; font-size: 13px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;\">\n                  This email was sent from the Kronos platform. Please reply directly to this email if you have any questions.\n                </p>\n              </div>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n              <p>Equiturn &copy; ${new Date().getFullYear()}</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const attachmentTextList = data.attachments && data.attachments.length > 0\n      ? data.attachments.map(a => `- ${a.filename}: ${a.url}`).join('\\n')\n      : '';\n\n    const emailText = `\n${data.taskTitle}\n\nHi ${data.recipientName},\n\n${data.senderName} has sent you completed work regarding: ${data.taskTitle}\n\n${data.message ? `Message:\\n${data.message}\\n` : ''}\n${attachmentTextList ? `\\nAttachments:\\n${attachmentTextList}` : ''}\n\n---\nKronos - Investment Banking Operations Platform\n    `.trim();\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: data.recipientEmail,\n      subject: `Work Delivery: ${data.taskTitle} from ${data.senderName}`,\n      html: emailHtml,\n      text: emailText,\n    });\n\n    if (result.error) {\n      // Check if it's a domain verification error\n      const errorMsg = result.error.message || '';\n      if (errorMsg.includes('domain is not verified') || errorMsg.includes('not verified')) {\n        return { \n          success: false, \n          error: 'Email domain not verified. For production use, verify your domain at https://resend.com/domains. In test mode, you can only send emails to the Resend account owner.' \n        };\n      }\n      return { success: false, error: result.error.message };\n    }\n\n    console.log(`Successfully sent external work email to: ${data.recipientEmail}`);\n    return { success: true };\n  } catch (error: any) {\n    console.error('Failed to send external work email:', error);\n    const errorMsg = error?.message || '';\n    if (errorMsg.includes('domain is not verified') || errorMsg.includes('not verified')) {\n      return { \n        success: false, \n        error: 'Email domain not verified. For production use, verify your domain at https://resend.com/domains. In test mode, you can only send emails to the Resend account owner.' \n      };\n    }\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n\nexport interface FormInvitationData {\n  email: string;\n  formTitle: string;\n  senderName: string;\n  formLink: string;\n  message?: string;\n}\n\nexport async function sendFormInvitationEmail(data: FormInvitationData): Promise<{ success: boolean; error?: string }> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    \n    const emailHtml = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <style>\n            body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #1a1a2e; background: #f5f5f5; margin: 0; padding: 20px; }\n            .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n            .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 30px; text-align: center; }\n            .header h1 { margin: 0; font-size: 24px; }\n            .content { padding: 30px; }\n            .message { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6; }\n            .cta-button { display: inline-block; background: #3b82f6; color: white !important; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 20px 0; }\n            .cta-button:hover { background: #2563eb; }\n            .footer { padding: 20px 30px; background: #f8f9fa; text-align: center; font-size: 12px; color: #666; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>Form Request</h1>\n            </div>\n            <div class=\"content\">\n              <p>Hello,</p>\n              <p><strong>${data.senderName}</strong> has requested you to complete a form:</p>\n              <h2 style=\"color: #1a1a2e;\">${data.formTitle}</h2>\n              ${data.message ? `<div class=\"message\"><strong>Message:</strong><br>${data.message}</div>` : ''}\n              <p>Please click the button below to access and complete the form:</p>\n              <div style=\"text-align: center;\">\n                <a href=\"${data.formLink}\" class=\"cta-button\">Complete Form</a>\n              </div>\n              <p style=\"font-size: 12px; color: #666; margin-top: 20px;\">\n                If the button doesn't work, copy and paste this link into your browser:<br>\n                <a href=\"${data.formLink}\" style=\"color: #3b82f6;\">${data.formLink}</a>\n              </p>\n            </div>\n            <div class=\"footer\">\n              <p>Kronos - Investment Banking Operations Platform</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n\n    const emailText = `\nForm Request: ${data.formTitle}\n\nHello,\n\n${data.senderName} has requested you to complete a form: ${data.formTitle}\n\n${data.message ? `Message: ${data.message}\\n` : ''}\nPlease click the link below to access and complete the form:\n${data.formLink}\n\n---\nKronos - Investment Banking Operations Platform\n    `.trim();\n\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: data.email,\n      subject: `Form Request: ${data.formTitle}`,\n      html: emailHtml,\n      text: emailText,\n    });\n\n    if (result.error) {\n      console.error('Error sending form invitation email:', result.error);\n      return { success: false, error: result.error.message };\n    }\n\n    console.log(`Successfully sent form invitation email to: ${data.email}`);\n    return { success: true };\n  } catch (error: any) {\n    console.error('Failed to send form invitation email:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Unknown error' };\n  }\n}\n","path":null,"size_bytes":33745,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue | null>(null)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  if (!itemContext) {\n    throw new Error(\"useFormField should be used within <FormItem>\")\n  }\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue | null>(null)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4175,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":649,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload\n            .filter((item) => item.type !== \"none\")\n            .map((item, index) => {\n              const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n              const itemConfig = getPayloadConfigFromPayload(config, item, key)\n              const indicatorColor = color || item.payload.fill || item.color\n\n              return (\n                <div\n                  key={item.dataKey}\n                  className={cn(\n                    \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                    indicator === \"dot\" && \"items-center\"\n                  )}\n                >\n                  {formatter && item?.value !== undefined && item.name ? (\n                    formatter(item.value, item.name, item, index, item.payload)\n                  ) : (\n                    <>\n                      {itemConfig?.icon ? (\n                        <itemConfig.icon />\n                      ) : (\n                        !hideIndicator && (\n                          <div\n                            className={cn(\n                              \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                              {\n                                \"h-2.5 w-2.5\": indicator === \"dot\",\n                                \"w-1\": indicator === \"line\",\n                                \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                  indicator === \"dashed\",\n                                \"my-0.5\": nestLabel && indicator === \"dashed\",\n                              }\n                            )}\n                            style={\n                              {\n                                \"--color-bg\": indicatorColor,\n                                \"--color-border\": indicatorColor,\n                              } as React.CSSProperties\n                            }\n                          />\n                        )\n                      )}\n                      <div\n                        className={cn(\n                          \"flex flex-1 justify-between leading-none\",\n                          nestLabel ? \"items-end\" : \"items-center\"\n                        )}\n                      >\n                        <div className=\"grid gap-1.5\">\n                          {nestLabel ? tooltipLabel : null}\n                          <span className=\"text-muted-foreground\">\n                            {itemConfig?.label || item.name}\n                          </span>\n                        </div>\n                        {item.value && (\n                          <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                            {item.value.toLocaleString()}\n                          </span>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              )\n            })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload\n          .filter((item) => item.type !== \"none\")\n          .map((item) => {\n            const key = `${nameKey || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n            return (\n              <div\n                key={item.value}\n                className={cn(\n                  \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n                )}\n              >\n                {itemConfig?.icon && !hideIcon ? (\n                  <itemConfig.icon />\n                ) : (\n                  <div\n                    className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                    style={{\n                      backgroundColor: item.color,\n                    }}\n                  />\n                )}\n                {itemConfig?.label}\n              </div>\n            )\n          })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10763,"size_tokens":null},"client/src/components/ui/spinner.tsx":{"content":"import { Loader2Icon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Spinner({ className, ...props }: React.ComponentProps<\"svg\">) {\n  return (\n    <Loader2Icon\n      role=\"status\"\n      aria-label=\"Loading\"\n      className={cn(\"size-4 animate-spin\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Spinner }\n","path":null,"size_bytes":331,"size_tokens":null},"server/storage.ts":{"content":"import { eq, and, desc, gt, lt, or, ilike, count, isNull } from \"drizzle-orm\";\nimport { neon } from \"@neondatabase/serverless\";\nimport { drizzle } from \"drizzle-orm/neon-http\";\nimport * as schema from \"@shared/schema\";\nimport type { User, InsertUser, Deal, InsertDeal, Task, InsertTask, Meeting, InsertMeeting, Notification, InsertNotification, PasswordResetToken, AssistantConversation, InsertAssistantConversation, AssistantMessage, InsertAssistantMessage, Conversation, InsertConversation, ConversationMember, InsertConversationMember, Message, InsertMessage, TimeEntry, InsertTimeEntry, TimeOffRequest, InsertTimeOffRequest, AuditLog, InsertAuditLog, Investor, InsertInvestor, InvestorInteraction, InsertInvestorInteraction, Okr, InsertOkr, Stakeholder, InsertStakeholder, Announcement, InsertAnnouncement, Poll, InsertPoll, MentorshipPairing, InsertMentorshipPairing, ClientPortalAccess, InsertClientPortalAccess, DocumentTemplate, InsertDocumentTemplate, InvestorMatch, InsertInvestorMatch, UserPreferences, InsertUserPreferences, DealTemplate, InsertDealTemplate, CalendarEvent, InsertCalendarEvent, TaskAttachmentRecord, InsertTaskAttachmentRecord, ClientPortalInvite, InsertClientPortalInvite, ClientPortalMessage, InsertClientPortalMessage, ClientPortalUpdate, InsertClientPortalUpdate, DealFee, InsertDealFee, StageDocument, InsertStageDocument, StagePodMember, InsertStagePodMember, StageVoiceNote, InsertStageVoiceNote, TaskComment, InsertTaskComment, DealNote, InsertDealNote } from \"@shared/schema\";\nimport bcrypt from \"bcryptjs\";\n\n// Always prefer PRODUCTION_DATABASE_URL if set, otherwise use DATABASE_URL\n// This ensures both dev and production use the same database when PRODUCTION_DATABASE_URL is configured\nconst databaseUrl = process.env.PRODUCTION_DATABASE_URL || process.env.DATABASE_URL!;\n\n// Debug logging for database connection\nconsole.log(`[Storage] PRODUCTION_DATABASE_URL exists: ${!!process.env.PRODUCTION_DATABASE_URL}`);\nconsole.log(`[Storage] DATABASE_URL exists: ${!!process.env.DATABASE_URL}`);\nconsole.log(`[Storage] Using PRODUCTION_DATABASE_URL: ${!!process.env.PRODUCTION_DATABASE_URL}`);\n\nconst sql = neon(databaseUrl);\nconst db = drizzle(sql, { schema });\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUserScore(id: string, score: number): Promise<void>;\n  updateUserStats(id: string, activeDeals: number, completedTasks: number): Promise<void>;\n  updateUserProfile(id: string, updates: { name?: string; email?: string; phone?: string; avatar?: string; role?: string }): Promise<User | undefined>;\n  updateUserPassword(id: string, newPassword: string): Promise<void>;\n  getAllUsers(): Promise<User[]>;\n  \n  // Deal operations\n  getDeal(id: string): Promise<Deal | undefined>;\n  getAllDeals(): Promise<Deal[]>;\n  getDealsListing(): Promise<Pick<Deal, 'id' | 'name' | 'dealType' | 'stage' | 'value' | 'client' | 'clientContactName' | 'clientContactEmail' | 'sector' | 'lead' | 'progress' | 'status' | 'description' | 'createdAt' | 'podTeam'>[]>;\n  createDeal(deal: InsertDeal): Promise<Deal>;\n  updateDeal(id: string, updates: Partial<InsertDeal>): Promise<Deal | undefined>;\n  deleteDeal(id: string): Promise<void>;\n  \n  // Task operations\n  getTask(id: string): Promise<Task | undefined>;\n  getAllTasks(): Promise<Task[]>;\n  getTasksByUser(userId: string): Promise<Task[]>;\n  getTasksByDeal(dealId: string): Promise<Task[]>;\n  createTask(task: InsertTask): Promise<Task>;\n  updateTask(id: string, updates: Partial<InsertTask>): Promise<Task | undefined>;\n  deleteTask(id: string): Promise<void>;\n  \n  // Meeting operations\n  getMeeting(id: string): Promise<Meeting | undefined>;\n  getAllMeetings(): Promise<Meeting[]>;\n  getMeetingsByOrganizer(organizerId: string): Promise<Meeting[]>;\n  createMeeting(meeting: InsertMeeting): Promise<Meeting>;\n  updateMeeting(id: string, updates: Partial<InsertMeeting>): Promise<Meeting | undefined>;\n  deleteMeeting(id: string): Promise<void>;\n  \n  // Notification operations\n  getNotification(id: string): Promise<Notification | undefined>;\n  getNotificationsByUser(userId: string): Promise<Notification[]>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  markNotificationRead(id: string): Promise<void>;\n  deleteNotification(id: string): Promise<void>;\n  \n  // User preferences\n  updateUserPreferences(id: string, preferences: any): Promise<void>;\n  \n  // Password reset token operations\n  createPasswordResetToken(userId: string, token: string, expiresAt: Date): Promise<PasswordResetToken>;\n  getValidPasswordResetToken(token: string): Promise<PasswordResetToken | undefined>;\n  markPasswordResetTokenUsed(id: string): Promise<void>;\n  \n  // Assistant conversation operations\n  getAssistantConversation(id: string): Promise<AssistantConversation | undefined>;\n  getAssistantConversationsByUser(userId: string): Promise<AssistantConversation[]>;\n  createAssistantConversation(conversation: InsertAssistantConversation): Promise<AssistantConversation>;\n  updateAssistantConversationTitle(id: string, title: string): Promise<AssistantConversation | undefined>;\n  deleteAssistantConversation(id: string): Promise<void>;\n  \n  // Assistant message operations\n  getAssistantMessages(conversationId: string): Promise<AssistantMessage[]>;\n  createAssistantMessage(message: InsertAssistantMessage): Promise<AssistantMessage>;\n  \n  // Chat conversation operations\n  getConversation(id: string): Promise<Conversation | undefined>;\n  getConversationsByUser(userId: string): Promise<Conversation[]>;\n  getConversationBetweenUsers(userId1: string, userId2: string): Promise<Conversation | undefined>;\n  createConversation(conversation: InsertConversation): Promise<Conversation>;\n  updateConversation(id: string, updates: Partial<InsertConversation>): Promise<Conversation | undefined>;\n  addConversationMember(conversationId: string, userId: string): Promise<ConversationMember>;\n  getConversationMembers(conversationId: string): Promise<ConversationMember[]>;\n  \n  // Chat message operations\n  getMessages(conversationId: string): Promise<Message[]>;\n  getMessage(id: string): Promise<Message | undefined>;\n  createMessage(message: InsertMessage): Promise<Message>;\n  updateMessage(id: string, updates: Partial<Message>): Promise<Message | undefined>;\n  deleteMessage(id: string): Promise<void>;\n  getUnreadMessageCount(userId: string): Promise<number>;\n  markMessagesAsRead(conversationId: string, userId: string): Promise<void>;\n  deleteConversation(id: string): Promise<void>;\n  deleteConversationMessages(conversationId: string): Promise<void>;\n  deleteConversationMembers(conversationId: string): Promise<void>;\n  \n  // Time Entry operations\n  getTimeEntry(id: string): Promise<TimeEntry | undefined>;\n  getTimeEntriesByUser(userId: string): Promise<TimeEntry[]>;\n  getTimeEntriesByDeal(dealId: string): Promise<TimeEntry[]>;\n  getAllTimeEntries(): Promise<TimeEntry[]>;\n  createTimeEntry(entry: InsertTimeEntry): Promise<TimeEntry>;\n  updateTimeEntry(id: string, updates: Partial<InsertTimeEntry>): Promise<TimeEntry | undefined>;\n  deleteTimeEntry(id: string): Promise<void>;\n  \n  // Time Off Request operations\n  getTimeOffRequest(id: string): Promise<TimeOffRequest | undefined>;\n  getTimeOffRequestsByUser(userId: string): Promise<TimeOffRequest[]>;\n  getAllTimeOffRequests(): Promise<TimeOffRequest[]>;\n  createTimeOffRequest(request: InsertTimeOffRequest): Promise<TimeOffRequest>;\n  updateTimeOffRequest(id: string, updates: Partial<InsertTimeOffRequest>): Promise<TimeOffRequest | undefined>;\n  deleteTimeOffRequest(id: string): Promise<void>;\n  \n  // Audit Log operations\n  getAuditLogs(limit?: number): Promise<AuditLog[]>;\n  getAuditLogsByUser(userId: string): Promise<AuditLog[]>;\n  getAuditLogsByEntity(entityType: string, entityId: string): Promise<AuditLog[]>;\n  createAuditLog(log: InsertAuditLog): Promise<AuditLog>;\n  \n  // Investor operations\n  getInvestor(id: string): Promise<Investor | undefined>;\n  getAllInvestors(): Promise<Investor[]>;\n  createInvestor(investor: InsertInvestor): Promise<Investor>;\n  updateInvestor(id: string, updates: Partial<InsertInvestor>): Promise<Investor | undefined>;\n  deleteInvestor(id: string): Promise<void>;\n  \n  // Investor Interaction operations\n  getInvestorInteractions(investorId: string): Promise<InvestorInteraction[]>;\n  createInvestorInteraction(interaction: InsertInvestorInteraction): Promise<InvestorInteraction>;\n  deleteInvestorInteraction(id: string): Promise<void>;\n  \n  // OKR operations\n  getOkr(id: string): Promise<Okr | undefined>;\n  getAllOkrs(): Promise<Okr[]>;\n  createOkr(okr: InsertOkr): Promise<Okr>;\n  updateOkr(id: string, updates: Partial<InsertOkr>): Promise<Okr | undefined>;\n  deleteOkr(id: string): Promise<void>;\n  \n  // Stakeholder operations\n  getStakeholder(id: string): Promise<Stakeholder | undefined>;\n  getAllStakeholders(): Promise<Stakeholder[]>;\n  getStakeholdersPaginated(options: {\n    page: number;\n    pageSize: number;\n    search?: string;\n    type?: string;\n  }): Promise<{ stakeholders: Stakeholder[]; total: number }>;\n  getStakeholderStats(): Promise<{ total: number; typeCounts: Record<string, number>; favoriteCount: number }>;\n  createStakeholder(stakeholder: InsertStakeholder): Promise<Stakeholder>;\n  updateStakeholder(id: string, updates: Partial<InsertStakeholder>): Promise<Stakeholder | undefined>;\n  deleteStakeholder(id: string): Promise<void>;\n  \n  // Announcement operations\n  getAnnouncement(id: string): Promise<Announcement | undefined>;\n  getAllAnnouncements(): Promise<Announcement[]>;\n  createAnnouncement(announcement: InsertAnnouncement): Promise<Announcement>;\n  updateAnnouncement(id: string, updates: Partial<InsertAnnouncement>): Promise<Announcement | undefined>;\n  deleteAnnouncement(id: string): Promise<void>;\n  \n  // Poll operations\n  getPoll(id: string): Promise<Poll | undefined>;\n  getAllPolls(): Promise<Poll[]>;\n  createPoll(poll: InsertPoll): Promise<Poll>;\n  updatePoll(id: string, updates: Partial<InsertPoll>): Promise<Poll | undefined>;\n  deletePoll(id: string): Promise<void>;\n  \n  // Mentorship Pairing operations\n  getMentorshipPairing(id: string): Promise<MentorshipPairing | undefined>;\n  getAllMentorshipPairings(): Promise<MentorshipPairing[]>;\n  createMentorshipPairing(pairing: InsertMentorshipPairing): Promise<MentorshipPairing>;\n  updateMentorshipPairing(id: string, updates: Partial<InsertMentorshipPairing>): Promise<MentorshipPairing | undefined>;\n  deleteMentorshipPairing(id: string): Promise<void>;\n  \n  // Client Portal Access operations\n  getClientPortalAccess(id: string): Promise<ClientPortalAccess | undefined>;\n  getAllClientPortalAccess(): Promise<ClientPortalAccess[]>;\n  getClientPortalAccessByDeal(dealId: string): Promise<ClientPortalAccess[]>;\n  createClientPortalAccess(access: InsertClientPortalAccess): Promise<ClientPortalAccess>;\n  updateClientPortalAccess(id: string, updates: Partial<InsertClientPortalAccess>): Promise<ClientPortalAccess | undefined>;\n  deleteClientPortalAccess(id: string): Promise<void>;\n  \n  // Document Template operations\n  getDocumentTemplate(id: string): Promise<DocumentTemplate | undefined>;\n  getAllDocumentTemplates(): Promise<DocumentTemplate[]>;\n  createDocumentTemplate(template: InsertDocumentTemplate): Promise<DocumentTemplate>;\n  updateDocumentTemplate(id: string, updates: Partial<InsertDocumentTemplate>): Promise<DocumentTemplate | undefined>;\n  deleteDocumentTemplate(id: string): Promise<void>;\n  \n  // Investor Match operations\n  getInvestorMatchesByDeal(dealId: string): Promise<InvestorMatch[]>;\n  createInvestorMatch(match: InsertInvestorMatch): Promise<InvestorMatch>;\n  deleteInvestorMatch(dealId: string, investorId: number): Promise<void>;\n  deleteInvestorMatchesByDeal(dealId: string): Promise<void>;\n  \n  // User Preferences operations\n  getUserPreferences(userId: string): Promise<UserPreferences | undefined>;\n  upsertUserPreferences(prefs: InsertUserPreferences): Promise<UserPreferences>;\n  updateUserPreferencesRecord(userId: string, updates: Partial<InsertUserPreferences>): Promise<UserPreferences | undefined>;\n  \n  // Deal Template operations\n  getDealTemplate(id: string): Promise<DealTemplate | undefined>;\n  getAllDealTemplates(): Promise<DealTemplate[]>;\n  createDealTemplate(template: InsertDealTemplate): Promise<DealTemplate>;\n  updateDealTemplate(id: string, updates: Partial<InsertDealTemplate>): Promise<DealTemplate | undefined>;\n  deleteDealTemplate(id: string): Promise<void>;\n  \n  // Calendar Event operations\n  getCalendarEvent(id: string): Promise<CalendarEvent | undefined>;\n  getAllCalendarEvents(): Promise<CalendarEvent[]>;\n  getCalendarEventsByDeal(dealId: string): Promise<CalendarEvent[]>;\n  createCalendarEvent(event: InsertCalendarEvent): Promise<CalendarEvent>;\n  updateCalendarEvent(id: string, updates: Partial<InsertCalendarEvent>): Promise<CalendarEvent | undefined>;\n  deleteCalendarEvent(id: string): Promise<void>;\n  \n  // Task Attachment Record operations\n  getTaskAttachmentRecords(taskId: string): Promise<TaskAttachmentRecord[]>;\n  createTaskAttachmentRecord(attachment: InsertTaskAttachmentRecord): Promise<TaskAttachmentRecord>;\n  deleteTaskAttachmentRecord(id: string): Promise<void>;\n  \n  // User Status Management operations\n  updateUserStatus(id: string, status: string): Promise<User | undefined>;\n  updateUserAccessLevel(id: string, accessLevel: string): Promise<User | undefined>;\n  getUsersByStatus(status: string): Promise<User[]>;\n  updateUserTwoFactor(id: string, enabled: boolean, secret?: string): Promise<User | undefined>;\n  \n  // Audit Log Table operations (new compliance logs)\n  getAuditLogTableEntries(limit?: number): Promise<schema.AuditLogTable[]>;\n  createAuditLogTableEntry(log: schema.InsertAuditLogTable): Promise<schema.AuditLogTable>;\n  \n  // Database-backed Investors operations\n  getInvestorFromTable(id: string): Promise<schema.InvestorTable | undefined>;\n  getAllInvestorsFromTable(): Promise<schema.InvestorTable[]>;\n  createInvestorInTable(investor: schema.InsertInvestorTable): Promise<schema.InvestorTable>;\n  updateInvestorInTable(id: string, updates: Partial<schema.InsertInvestorTable>): Promise<schema.InvestorTable | undefined>;\n  deleteInvestorFromTable(id: string): Promise<void>;\n  \n  // Document Table operations\n  getDocument(id: string): Promise<schema.DocumentTable | undefined>;\n  getAllDocuments(): Promise<schema.DocumentTable[]>;\n  getDocumentsList(): Promise<Omit<schema.DocumentTable, 'fileData'>[]>; // Lightweight version without file data\n  getDocumentsByDeal(dealId: string): Promise<schema.DocumentTable[]>;\n  getDocumentsByUser(userId: string): Promise<schema.DocumentTable[]>;\n  createDocument(doc: schema.InsertDocumentTable): Promise<schema.DocumentTable>;\n  updateDocument(id: string, updates: Partial<schema.InsertDocumentTable>): Promise<schema.DocumentTable | undefined>;\n  deleteDocument(id: string): Promise<void>;\n  \n  // Client Portal Invite operations\n  getClientPortalInvite(id: string): Promise<ClientPortalInvite | undefined>;\n  getClientPortalInviteByToken(token: string): Promise<ClientPortalInvite | undefined>;\n  getClientPortalInvitesByInviter(inviterId: string): Promise<ClientPortalInvite[]>;\n  getAllClientPortalInvites(): Promise<ClientPortalInvite[]>;\n  createClientPortalInvite(invite: InsertClientPortalInvite): Promise<ClientPortalInvite>;\n  updateClientPortalInvite(id: string, updates: Partial<InsertClientPortalInvite & { acceptedAt?: Date; userId?: string; status?: string }>): Promise<ClientPortalInvite | undefined>;\n  deleteClientPortalInvite(id: string): Promise<void>;\n  \n  // Client Portal Message operations\n  getClientPortalMessagesByDeal(dealId: string): Promise<ClientPortalMessage[]>;\n  createClientPortalMessage(message: InsertClientPortalMessage): Promise<ClientPortalMessage>;\n  \n  // Client Portal Update operations\n  getClientPortalUpdatesByDeal(dealId: string): Promise<ClientPortalUpdate[]>;\n  createClientPortalUpdate(update: InsertClientPortalUpdate): Promise<ClientPortalUpdate>;\n  \n  // External User operations\n  getExternalUsers(): Promise<User[]>;\n  createExternalUser(user: InsertUser & { isExternal: boolean; externalOrganization?: string; invitedBy?: string }): Promise<User>;\n  getExternalUserDeals(userId: string): Promise<Deal[]>;\n  \n  // Deal Fee operations\n  getDealFees(dealId: string): Promise<DealFee[]>;\n  createDealFee(fee: InsertDealFee): Promise<DealFee>;\n  updateDealFee(id: string, updates: Partial<InsertDealFee>): Promise<DealFee | undefined>;\n  deleteDealFee(id: string): Promise<void>;\n  getAllDealFees(): Promise<DealFee[]>;\n  \n  // Stage Document operations\n  getStageDocuments(dealId: string, stage?: string): Promise<StageDocument[]>;\n  createStageDocument(doc: InsertStageDocument): Promise<StageDocument>;\n  deleteStageDocument(id: string): Promise<void>;\n  \n  // Stage Pod Member operations\n  getStagePodMembers(dealId: string, stage?: string): Promise<StagePodMember[]>;\n  createStagePodMember(member: InsertStagePodMember): Promise<StagePodMember>;\n  updateStagePodMember(id: string, updates: Partial<InsertStagePodMember>): Promise<StagePodMember | undefined>;\n  deleteStagePodMember(id: string): Promise<void>;\n  \n  // Stage Voice Note operations\n  getStageVoiceNotes(dealId: string, stage?: string): Promise<StageVoiceNote[]>;\n  createStageVoiceNote(note: InsertStageVoiceNote): Promise<StageVoiceNote>;\n  deleteStageVoiceNote(id: string): Promise<void>;\n  \n  // Task Comment operations\n  getTaskComments(taskId: string): Promise<TaskComment[]>;\n  createTaskComment(comment: InsertTaskComment): Promise<TaskComment>;\n  updateTaskComment(id: string, content: string): Promise<TaskComment | undefined>;\n  deleteTaskComment(id: string): Promise<void>;\n  \n  // Deal Notes operations\n  getDealNotes(dealId: string): Promise<DealNote[]>;\n  createDealNote(note: InsertDealNote): Promise<DealNote>;\n  updateDealNote(id: string, content: string): Promise<DealNote | undefined>;\n  deleteDealNote(id: string): Promise<void>;\n  \n  // User search for autocomplete\n  searchUsers(query: string): Promise<User[]>;\n  \n  // Custom Sector operations\n  getAllCustomSectors(): Promise<schema.CustomSector[]>;\n  createCustomSector(sector: schema.InsertCustomSector): Promise<schema.CustomSector>;\n  \n  // Pending form upload operations\n  createPendingFormUpload(upload: schema.InsertPendingFormUpload): Promise<schema.PendingFormUpload>;\n  getPendingFormUpload(shareToken: string, objectPath: string): Promise<schema.PendingFormUpload | undefined>;\n  confirmAndDeletePendingFormUpload(shareToken: string, objectPath: string): Promise<boolean>;\n  getExpiredPendingUploads(): Promise<schema.PendingFormUpload[]>;\n  deletePendingFormUpload(id: string): Promise<void>;\n  \n  // Task Template operations\n  getTaskTemplate(id: string): Promise<schema.TaskTemplate | undefined>;\n  getAllTaskTemplates(): Promise<schema.TaskTemplate[]>;\n  createTaskTemplate(template: schema.InsertTaskTemplate): Promise<schema.TaskTemplate>;\n  updateTaskTemplate(id: string, updates: Partial<schema.InsertTaskTemplate>): Promise<schema.TaskTemplate | undefined>;\n  deleteTaskTemplate(id: string): Promise<void>;\n  incrementTaskTemplateUsage(id: string): Promise<void>;\n  \n  // Task Template Usage operations\n  createTaskTemplateUsage(usage: schema.InsertTaskTemplateUsage): Promise<schema.TaskTemplateUsage>;\n  getTaskTemplateUsageByTemplate(templateId: string): Promise<schema.TaskTemplateUsage[]>;\n  \n  // Personality Assessment operations\n  getPersonalityAssessment(userId: string): Promise<schema.PersonalityAssessment | undefined>;\n  createPersonalityAssessment(assessment: schema.InsertPersonalityAssessment): Promise<schema.PersonalityAssessment>;\n  updatePersonalityAssessment(id: string, updates: Partial<schema.InsertPersonalityAssessment>): Promise<schema.PersonalityAssessment | undefined>;\n  \n  // Resume Analysis operations\n  getResumeAnalysis(userId: string): Promise<schema.ResumeAnalysis | undefined>;\n  createResumeAnalysis(analysis: schema.InsertResumeAnalysis): Promise<schema.ResumeAnalysis>;\n  updateResumeAnalysis(id: string, updates: Partial<schema.InsertResumeAnalysis>): Promise<schema.ResumeAnalysis | undefined>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(schema.users).where(eq(schema.users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(schema.users).where(eq(schema.users.email, email));\n    return user;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const hashedPassword = await bcrypt.hash(insertUser.password, 10);\n    const [user] = await db.insert(schema.users)\n      .values({ ...insertUser, password: hashedPassword })\n      .returning();\n    return user;\n  }\n\n  async updateUserScore(id: string, score: number): Promise<void> {\n    await db.update(schema.users)\n      .set({ score })\n      .where(eq(schema.users.id, id));\n  }\n\n  async updateUserStats(id: string, activeDeals: number, completedTasks: number): Promise<void> {\n    await db.update(schema.users)\n      .set({ activeDeals, completedTasks })\n      .where(eq(schema.users.id, id));\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(schema.users);\n  }\n\n  async updateUserProfile(id: string, updates: { name?: string; email?: string; phone?: string; avatar?: string; role?: string }): Promise<User | undefined> {\n    const [user] = await db.update(schema.users)\n      .set(updates)\n      .where(eq(schema.users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updateUserPassword(id: string, newPassword: string): Promise<void> {\n    const hashedPassword = await bcrypt.hash(newPassword, 10);\n    await db.update(schema.users)\n      .set({ password: hashedPassword })\n      .where(eq(schema.users.id, id));\n  }\n\n  // Deal operations\n  async getDeal(id: string): Promise<Deal | undefined> {\n    const [deal] = await db.select().from(schema.deals).where(eq(schema.deals.id, id));\n    return deal;\n  }\n\n  async getAllDeals(): Promise<Deal[]> {\n    return await db.select().from(schema.deals);\n  }\n\n  async getDealsListing(): Promise<Pick<Deal, 'id' | 'name' | 'dealType' | 'stage' | 'value' | 'client' | 'clientContactName' | 'clientContactEmail' | 'sector' | 'lead' | 'progress' | 'status' | 'description' | 'createdAt' | 'podTeam'>[]> {\n    // Return essential fields for listing - includes podTeam for filtering, excludes very large JSON fields like attachments\n    return await db.select({\n      id: schema.deals.id,\n      name: schema.deals.name,\n      dealType: schema.deals.dealType,\n      stage: schema.deals.stage,\n      value: schema.deals.value,\n      client: schema.deals.client,\n      clientContactName: schema.deals.clientContactName,\n      clientContactEmail: schema.deals.clientContactEmail,\n      sector: schema.deals.sector,\n      lead: schema.deals.lead,\n      progress: schema.deals.progress,\n      status: schema.deals.status,\n      description: schema.deals.description,\n      createdAt: schema.deals.createdAt,\n      podTeam: schema.deals.podTeam,\n    }).from(schema.deals);\n  }\n\n  async createDeal(insertDeal: InsertDeal): Promise<Deal> {\n    const [deal] = await db.insert(schema.deals)\n      .values(insertDeal)\n      .returning();\n    return deal;\n  }\n\n  async updateDeal(id: string, updates: Partial<InsertDeal>): Promise<Deal | undefined> {\n    const [deal] = await db.update(schema.deals)\n      .set(updates)\n      .where(eq(schema.deals.id, id))\n      .returning();\n    return deal;\n  }\n\n  async deleteDeal(id: string): Promise<void> {\n    // First, get all tasks for this deal to delete their related records\n    const dealTasks = await db.select({ id: schema.tasks.id }).from(schema.tasks).where(eq(schema.tasks.dealId, id));\n    const taskIds = dealTasks.map(t => t.id);\n    \n    // Delete task-related records first (they reference tasks)\n    for (const taskId of taskIds) {\n      await db.delete(schema.taskComments).where(eq(schema.taskComments.taskId, taskId));\n      await db.delete(schema.taskAttachmentsTable).where(eq(schema.taskAttachmentsTable.taskId, taskId));\n    }\n    \n    // Get all deal pods for this deal to delete their related records\n    const dealPodsList = await db.select({ id: schema.dealPods.id }).from(schema.dealPods).where(eq(schema.dealPods.dealId, id));\n    const podIds = dealPodsList.map(p => p.id);\n    \n    // Delete records that reference dealPods first\n    for (const podId of podIds) {\n      await db.delete(schema.podMembers).where(eq(schema.podMembers.podId, podId));\n    }\n    \n    // Delete podMovementTasks FIRST (references dealMilestones via milestone_id FK)\n    await db.delete(schema.podMovementTasks).where(eq(schema.podMovementTasks.dealId, id));\n    \n    // Delete dealMilestones (references dealPods and deals)\n    await db.delete(schema.dealMilestones).where(eq(schema.dealMilestones.dealId, id));\n    \n    // Delete dealContextUpdates (references deals)\n    await db.delete(schema.dealContextUpdates).where(eq(schema.dealContextUpdates.dealId, id));\n    \n    // Now delete deal pods\n    await db.delete(schema.dealPods).where(eq(schema.dealPods.dealId, id));\n    \n    // Delete all deal-related records (foreign key constraints)\n    await db.delete(schema.tasks).where(eq(schema.tasks.dealId, id));\n    await db.delete(schema.meetings).where(eq(schema.meetings.dealId, id));\n    await db.delete(schema.dealFees).where(eq(schema.dealFees.dealId, id));\n    await db.delete(schema.stageDocuments).where(eq(schema.stageDocuments.dealId, id));\n    await db.delete(schema.stagePodMembers).where(eq(schema.stagePodMembers.dealId, id));\n    await db.delete(schema.stageVoiceNotes).where(eq(schema.stageVoiceNotes.dealId, id));\n    await db.delete(schema.investorMatches).where(eq(schema.investorMatches.dealId, id));\n    await db.delete(schema.calendarEvents).where(eq(schema.calendarEvents.dealId, id));\n    await db.delete(schema.clientPortalMessages).where(eq(schema.clientPortalMessages.dealId, id));\n    await db.delete(schema.clientPortalUpdates).where(eq(schema.clientPortalUpdates.dealId, id));\n    await db.delete(schema.clientPortalAccess).where(eq(schema.clientPortalAccess.dealId, id));\n    await db.delete(schema.documentsTable).where(eq(schema.documentsTable.dealId, id));\n    await db.delete(schema.dealNotes).where(eq(schema.dealNotes.dealId, id));\n    \n    // Set dealId to null for related records with nullable FK\n    await db.update(schema.investorInteractions).set({ dealId: null }).where(eq(schema.investorInteractions.dealId, id));\n    await db.update(schema.timeEntries).set({ dealId: null }).where(eq(schema.timeEntries.dealId, id));\n    await db.update(schema.announcements).set({ dealId: null }).where(eq(schema.announcements.dealId, id));\n    \n    // Now delete the deal\n    await db.delete(schema.deals).where(eq(schema.deals.id, id));\n  }\n\n  // Task operations\n  async getTask(id: string): Promise<Task | undefined> {\n    const [task] = await db.select().from(schema.tasks).where(eq(schema.tasks.id, id));\n    return task;\n  }\n\n  async getAllTasks(): Promise<Task[]> {\n    return await db.select().from(schema.tasks);\n  }\n\n  async getTasksByUser(userId: string): Promise<Task[]> {\n    return await db.select().from(schema.tasks).where(eq(schema.tasks.assignedTo, userId));\n  }\n\n  async getTasksByDeal(dealId: string): Promise<Task[]> {\n    return await db.select().from(schema.tasks).where(eq(schema.tasks.dealId, dealId));\n  }\n\n  async createTask(insertTask: InsertTask): Promise<Task> {\n    const [task] = await db.insert(schema.tasks)\n      .values(insertTask)\n      .returning();\n    return task;\n  }\n\n  async updateTask(id: string, updates: Partial<InsertTask>): Promise<Task | undefined> {\n    const [task] = await db.update(schema.tasks)\n      .set(updates)\n      .where(eq(schema.tasks.id, id))\n      .returning();\n    return task;\n  }\n\n  async deleteTask(id: string): Promise<void> {\n    // Delete related records first to avoid foreign key constraint violations\n    await db.delete(schema.taskComments).where(eq(schema.taskComments.taskId, id));\n    await db.delete(schema.taskAttachmentsTable).where(eq(schema.taskAttachmentsTable.taskId, id));\n    await db.update(schema.timeEntries).set({ taskId: null }).where(eq(schema.timeEntries.taskId, id));\n    await db.delete(schema.tasks).where(eq(schema.tasks.id, id));\n  }\n  \n  // Meeting operations\n  async getMeeting(id: string): Promise<Meeting | undefined> {\n    const [meeting] = await db.select().from(schema.meetings).where(eq(schema.meetings.id, id));\n    return meeting;\n  }\n\n  async getAllMeetings(): Promise<Meeting[]> {\n    return await db.select().from(schema.meetings).orderBy(desc(schema.meetings.scheduledFor));\n  }\n\n  async getMeetingsByOrganizer(organizerId: string): Promise<Meeting[]> {\n    return await db.select().from(schema.meetings).where(eq(schema.meetings.organizerId, organizerId));\n  }\n\n  async createMeeting(insertMeeting: InsertMeeting): Promise<Meeting> {\n    const [meeting] = await db.insert(schema.meetings)\n      .values(insertMeeting)\n      .returning();\n    return meeting;\n  }\n\n  async updateMeeting(id: string, updates: Partial<InsertMeeting>): Promise<Meeting | undefined> {\n    const [meeting] = await db.update(schema.meetings)\n      .set(updates)\n      .where(eq(schema.meetings.id, id))\n      .returning();\n    return meeting;\n  }\n\n  async deleteMeeting(id: string): Promise<void> {\n    await db.delete(schema.meetings).where(eq(schema.meetings.id, id));\n  }\n\n  // Notification operations\n  async getNotification(id: string): Promise<Notification | undefined> {\n    const [notification] = await db.select().from(schema.notifications).where(eq(schema.notifications.id, id));\n    return notification;\n  }\n\n  async getNotificationsByUser(userId: string): Promise<Notification[]> {\n    return await db.select().from(schema.notifications)\n      .where(eq(schema.notifications.userId, userId))\n      .orderBy(desc(schema.notifications.createdAt));\n  }\n\n  async createNotification(insertNotification: InsertNotification): Promise<Notification> {\n    const [notification] = await db.insert(schema.notifications)\n      .values(insertNotification)\n      .returning();\n    return notification;\n  }\n\n  async markNotificationRead(id: string): Promise<void> {\n    await db.update(schema.notifications)\n      .set({ read: true })\n      .where(eq(schema.notifications.id, id));\n  }\n\n  async deleteNotification(id: string): Promise<void> {\n    await db.delete(schema.notifications).where(eq(schema.notifications.id, id));\n  }\n\n  // User preferences\n  async updateUserPreferences(id: string, preferences: any): Promise<void> {\n    await db.update(schema.users)\n      .set({ preferences })\n      .where(eq(schema.users.id, id));\n  }\n  \n  // Password reset token operations\n  async createPasswordResetToken(userId: string, token: string, expiresAt: Date): Promise<PasswordResetToken> {\n    const [resetToken] = await db.insert(schema.passwordResetTokens)\n      .values({ userId, token, expiresAt })\n      .returning();\n    return resetToken;\n  }\n  \n  async getValidPasswordResetToken(token: string): Promise<PasswordResetToken | undefined> {\n    const [resetToken] = await db.select()\n      .from(schema.passwordResetTokens)\n      .where(\n        and(\n          eq(schema.passwordResetTokens.token, token),\n          eq(schema.passwordResetTokens.used, false),\n          gt(schema.passwordResetTokens.expiresAt, new Date())\n        )\n      );\n    return resetToken;\n  }\n  \n  async markPasswordResetTokenUsed(id: string): Promise<void> {\n    await db.update(schema.passwordResetTokens)\n      .set({ used: true })\n      .where(eq(schema.passwordResetTokens.id, id));\n  }\n  \n  // Assistant conversation operations\n  async getAssistantConversation(id: string): Promise<AssistantConversation | undefined> {\n    const [conversation] = await db.select().from(schema.assistantConversations).where(eq(schema.assistantConversations.id, id));\n    return conversation;\n  }\n  \n  async getAssistantConversationsByUser(userId: string): Promise<AssistantConversation[]> {\n    return await db.select().from(schema.assistantConversations)\n      .where(eq(schema.assistantConversations.userId, userId))\n      .orderBy(desc(schema.assistantConversations.updatedAt));\n  }\n  \n  async createAssistantConversation(conversation: InsertAssistantConversation): Promise<AssistantConversation> {\n    const [created] = await db.insert(schema.assistantConversations)\n      .values(conversation)\n      .returning();\n    return created;\n  }\n  \n  async updateAssistantConversationTitle(id: string, title: string): Promise<AssistantConversation | undefined> {\n    const [updated] = await db.update(schema.assistantConversations)\n      .set({ title, updatedAt: new Date() })\n      .where(eq(schema.assistantConversations.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteAssistantConversation(id: string): Promise<void> {\n    await db.delete(schema.assistantMessages).where(eq(schema.assistantMessages.conversationId, id));\n    await db.delete(schema.assistantConversations).where(eq(schema.assistantConversations.id, id));\n  }\n  \n  // Assistant message operations\n  async getAssistantMessages(conversationId: string): Promise<AssistantMessage[]> {\n    return await db.select().from(schema.assistantMessages)\n      .where(eq(schema.assistantMessages.conversationId, conversationId))\n      .orderBy(schema.assistantMessages.createdAt);\n  }\n  \n  async createAssistantMessage(message: InsertAssistantMessage): Promise<AssistantMessage> {\n    const [created] = await db.insert(schema.assistantMessages)\n      .values(message)\n      .returning();\n    await db.update(schema.assistantConversations)\n      .set({ updatedAt: new Date() })\n      .where(eq(schema.assistantConversations.id, message.conversationId));\n    return created;\n  }\n  \n  // Chat conversation operations\n  async getConversation(id: string): Promise<Conversation | undefined> {\n    const [conversation] = await db.select().from(schema.conversations).where(eq(schema.conversations.id, id));\n    return conversation;\n  }\n  \n  async getConversationsByUser(userId: string): Promise<Conversation[]> {\n    const memberships = await db.select()\n      .from(schema.conversationMembers)\n      .where(eq(schema.conversationMembers.userId, userId));\n    \n    if (memberships.length === 0) return [];\n    \n    const conversationIds = memberships.map(m => m.conversationId);\n    const conversations: Conversation[] = [];\n    \n    for (const convId of conversationIds) {\n      const [conv] = await db.select().from(schema.conversations).where(eq(schema.conversations.id, convId));\n      if (conv) conversations.push(conv);\n    }\n    \n    return conversations.sort((a, b) => \n      (b.updatedAt?.getTime() || 0) - (a.updatedAt?.getTime() || 0)\n    );\n  }\n  \n  async getConversationBetweenUsers(userId1: string, userId2: string): Promise<Conversation | undefined> {\n    const user1Convs = await this.getConversationsByUser(userId1);\n    \n    for (const conv of user1Convs) {\n      if (conv.isGroup) continue;\n      const members = await this.getConversationMembers(conv.id);\n      const memberIds = members.map(m => m.userId);\n      if (memberIds.includes(userId2) && memberIds.length === 2) {\n        return conv;\n      }\n    }\n    return undefined;\n  }\n  \n  async createConversation(conversation: InsertConversation): Promise<Conversation> {\n    const [created] = await db.insert(schema.conversations)\n      .values(conversation)\n      .returning();\n    return created;\n  }\n\n  async updateConversation(id: string, updates: Partial<InsertConversation>): Promise<Conversation | undefined> {\n    const [updated] = await db.update(schema.conversations)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.conversations.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async addConversationMember(conversationId: string, userId: string): Promise<ConversationMember> {\n    const [member] = await db.insert(schema.conversationMembers)\n      .values({ conversationId, userId })\n      .returning();\n    return member;\n  }\n  \n  async getConversationMembers(conversationId: string): Promise<ConversationMember[]> {\n    return await db.select()\n      .from(schema.conversationMembers)\n      .where(eq(schema.conversationMembers.conversationId, conversationId));\n  }\n  \n  // Chat message operations\n  async getMessages(conversationId: string): Promise<Message[]> {\n    return await db.select()\n      .from(schema.messages)\n      .where(eq(schema.messages.conversationId, conversationId))\n      .orderBy(schema.messages.createdAt);\n  }\n  \n  async getMessage(id: string): Promise<Message | undefined> {\n    const [message] = await db.select().from(schema.messages).where(eq(schema.messages.id, id));\n    return message;\n  }\n  \n  async createMessage(message: InsertMessage): Promise<Message> {\n    const [created] = await db.insert(schema.messages)\n      .values(message)\n      .returning();\n    await db.update(schema.conversations)\n      .set({ updatedAt: new Date() })\n      .where(eq(schema.conversations.id, message.conversationId));\n    return created;\n  }\n  \n  async deleteMessage(id: string): Promise<void> {\n    await db.delete(schema.messages).where(eq(schema.messages.id, id));\n  }\n  \n  async updateMessage(id: string, updates: Partial<Message>): Promise<Message | undefined> {\n    const [updated] = await db.update(schema.messages)\n      .set(updates as any)\n      .where(eq(schema.messages.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async getUnreadMessageCount(userId: string): Promise<number> {\n    const memberships = await db.select()\n      .from(schema.conversationMembers)\n      .where(eq(schema.conversationMembers.userId, userId));\n    \n    let unreadCount = 0;\n    for (const membership of memberships) {\n      const lastRead = membership.lastReadAt || new Date(0);\n      const messages = await db.select()\n        .from(schema.messages)\n        .where(\n          and(\n            eq(schema.messages.conversationId, membership.conversationId),\n            gt(schema.messages.createdAt, lastRead)\n          )\n        );\n      unreadCount += messages.filter(m => m.senderId !== userId).length;\n    }\n    return unreadCount;\n  }\n  \n  async markMessagesAsRead(conversationId: string, userId: string): Promise<void> {\n    await db.update(schema.conversationMembers)\n      .set({ lastReadAt: new Date() })\n      .where(\n        and(\n          eq(schema.conversationMembers.conversationId, conversationId),\n          eq(schema.conversationMembers.userId, userId)\n        )\n      );\n  }\n  \n  async deleteConversation(id: string): Promise<void> {\n    await db.delete(schema.conversations).where(eq(schema.conversations.id, id));\n  }\n  \n  async deleteConversationMessages(conversationId: string): Promise<void> {\n    await db.delete(schema.messages).where(eq(schema.messages.conversationId, conversationId));\n  }\n  \n  async deleteConversationMembers(conversationId: string): Promise<void> {\n    await db.delete(schema.conversationMembers).where(eq(schema.conversationMembers.conversationId, conversationId));\n  }\n  \n  // Time Entry operations\n  async getTimeEntry(id: string): Promise<TimeEntry | undefined> {\n    const [entry] = await db.select().from(schema.timeEntries).where(eq(schema.timeEntries.id, id));\n    return entry;\n  }\n  \n  async getTimeEntriesByUser(userId: string): Promise<TimeEntry[]> {\n    return await db.select().from(schema.timeEntries)\n      .where(eq(schema.timeEntries.userId, userId))\n      .orderBy(desc(schema.timeEntries.date));\n  }\n  \n  async getTimeEntriesByDeal(dealId: string): Promise<TimeEntry[]> {\n    return await db.select().from(schema.timeEntries)\n      .where(eq(schema.timeEntries.dealId, dealId))\n      .orderBy(desc(schema.timeEntries.date));\n  }\n  \n  async getAllTimeEntries(): Promise<TimeEntry[]> {\n    return await db.select().from(schema.timeEntries).orderBy(desc(schema.timeEntries.date));\n  }\n  \n  async createTimeEntry(entry: InsertTimeEntry): Promise<TimeEntry> {\n    const [created] = await db.insert(schema.timeEntries).values(entry).returning();\n    return created;\n  }\n  \n  async updateTimeEntry(id: string, updates: Partial<InsertTimeEntry>): Promise<TimeEntry | undefined> {\n    const [updated] = await db.update(schema.timeEntries)\n      .set(updates)\n      .where(eq(schema.timeEntries.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteTimeEntry(id: string): Promise<void> {\n    await db.delete(schema.timeEntries).where(eq(schema.timeEntries.id, id));\n  }\n  \n  // Time Off Request operations\n  async getTimeOffRequest(id: string): Promise<TimeOffRequest | undefined> {\n    const [request] = await db.select().from(schema.timeOffRequests).where(eq(schema.timeOffRequests.id, id));\n    return request;\n  }\n  \n  async getTimeOffRequestsByUser(userId: string): Promise<TimeOffRequest[]> {\n    return await db.select().from(schema.timeOffRequests)\n      .where(eq(schema.timeOffRequests.userId, userId))\n      .orderBy(desc(schema.timeOffRequests.startDate));\n  }\n  \n  async getAllTimeOffRequests(): Promise<TimeOffRequest[]> {\n    return await db.select().from(schema.timeOffRequests).orderBy(desc(schema.timeOffRequests.startDate));\n  }\n  \n  async createTimeOffRequest(request: InsertTimeOffRequest): Promise<TimeOffRequest> {\n    const [created] = await db.insert(schema.timeOffRequests).values(request).returning();\n    return created;\n  }\n  \n  async updateTimeOffRequest(id: string, updates: Partial<InsertTimeOffRequest>): Promise<TimeOffRequest | undefined> {\n    const [updated] = await db.update(schema.timeOffRequests)\n      .set(updates)\n      .where(eq(schema.timeOffRequests.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteTimeOffRequest(id: string): Promise<void> {\n    await db.delete(schema.timeOffRequests).where(eq(schema.timeOffRequests.id, id));\n  }\n  \n  // Audit Log operations\n  async getAuditLogs(limit?: number): Promise<AuditLog[]> {\n    const query = db.select().from(schema.auditLogs).orderBy(desc(schema.auditLogs.createdAt));\n    if (limit) {\n      return await query.limit(limit);\n    }\n    return await query;\n  }\n  \n  async getAuditLogsByUser(userId: string): Promise<AuditLog[]> {\n    return await db.select().from(schema.auditLogs)\n      .where(eq(schema.auditLogs.userId, userId))\n      .orderBy(desc(schema.auditLogs.createdAt));\n  }\n  \n  async getAuditLogsByEntity(entityType: string, entityId: string): Promise<AuditLog[]> {\n    return await db.select().from(schema.auditLogs)\n      .where(and(\n        eq(schema.auditLogs.entityType, entityType),\n        eq(schema.auditLogs.entityId, entityId)\n      ))\n      .orderBy(desc(schema.auditLogs.createdAt));\n  }\n  \n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const [created] = await db.insert(schema.auditLogs).values(log).returning();\n    return created;\n  }\n  \n  // Investor operations\n  async getInvestor(id: string): Promise<Investor | undefined> {\n    const [investor] = await db.select().from(schema.investors).where(eq(schema.investors.id, id));\n    return investor;\n  }\n  \n  async getAllInvestors(): Promise<Investor[]> {\n    return await db.select().from(schema.investors).orderBy(schema.investors.name);\n  }\n  \n  async createInvestor(investor: InsertInvestor): Promise<Investor> {\n    const [created] = await db.insert(schema.investors).values(investor).returning();\n    return created;\n  }\n  \n  async updateInvestor(id: string, updates: Partial<InsertInvestor>): Promise<Investor | undefined> {\n    const [updated] = await db.update(schema.investors)\n      .set(updates)\n      .where(eq(schema.investors.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteInvestor(id: string): Promise<void> {\n    await db.delete(schema.investorInteractions).where(eq(schema.investorInteractions.investorId, id));\n    await db.delete(schema.investors).where(eq(schema.investors.id, id));\n  }\n  \n  // Investor Interaction operations\n  async getInvestorInteractions(investorId: string): Promise<InvestorInteraction[]> {\n    return await db.select().from(schema.investorInteractions)\n      .where(eq(schema.investorInteractions.investorId, investorId))\n      .orderBy(desc(schema.investorInteractions.date));\n  }\n  \n  async createInvestorInteraction(interaction: InsertInvestorInteraction): Promise<InvestorInteraction> {\n    const [created] = await db.insert(schema.investorInteractions).values(interaction).returning();\n    return created;\n  }\n  \n  async deleteInvestorInteraction(id: string): Promise<void> {\n    await db.delete(schema.investorInteractions).where(eq(schema.investorInteractions.id, id));\n  }\n  \n  // OKR operations\n  async getOkr(id: string): Promise<Okr | undefined> {\n    const [okr] = await db.select().from(schema.okrs).where(eq(schema.okrs.id, id));\n    return okr;\n  }\n  \n  async getAllOkrs(): Promise<Okr[]> {\n    return await db.select().from(schema.okrs).orderBy(desc(schema.okrs.createdAt));\n  }\n  \n  async createOkr(okr: InsertOkr): Promise<Okr> {\n    const [created] = await db.insert(schema.okrs).values(okr).returning();\n    return created;\n  }\n  \n  async updateOkr(id: string, updates: Partial<InsertOkr>): Promise<Okr | undefined> {\n    const [updated] = await db.update(schema.okrs)\n      .set(updates)\n      .where(eq(schema.okrs.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteOkr(id: string): Promise<void> {\n    await db.delete(schema.okrs).where(eq(schema.okrs.id, id));\n  }\n  \n  // Stakeholder operations\n  async getStakeholder(id: string): Promise<Stakeholder | undefined> {\n    const [stakeholder] = await db.select().from(schema.stakeholders).where(eq(schema.stakeholders.id, id));\n    return stakeholder;\n  }\n  \n  async getAllStakeholders(): Promise<Stakeholder[]> {\n    return await db.select().from(schema.stakeholders).orderBy(schema.stakeholders.name);\n  }\n  \n  async getStakeholdersPaginated(options: {\n    page: number;\n    pageSize: number;\n    search?: string;\n    type?: string;\n  }): Promise<{ stakeholders: Stakeholder[]; total: number }> {\n    const { page, pageSize, search, type } = options;\n    const offset = (page - 1) * pageSize;\n    \n    // Build conditions array\n    const conditions = [];\n    \n    if (search) {\n      const searchLower = `%${search.toLowerCase()}%`;\n      conditions.push(\n        or(\n          ilike(schema.stakeholders.name, searchLower),\n          ilike(schema.stakeholders.company, searchLower),\n          ilike(schema.stakeholders.location, searchLower)\n        )\n      );\n    }\n    \n    if (type && type !== 'all') {\n      conditions.push(eq(schema.stakeholders.type, type));\n    }\n    \n    // Get total count\n    const countQuery = conditions.length > 0\n      ? db.select({ count: count() }).from(schema.stakeholders).where(and(...conditions))\n      : db.select({ count: count() }).from(schema.stakeholders);\n    \n    const [{ count: total }] = await countQuery;\n    \n    // Get paginated results\n    const dataQuery = conditions.length > 0\n      ? db.select().from(schema.stakeholders)\n          .where(and(...conditions))\n          .orderBy(schema.stakeholders.name)\n          .limit(pageSize)\n          .offset(offset)\n      : db.select().from(schema.stakeholders)\n          .orderBy(schema.stakeholders.name)\n          .limit(pageSize)\n          .offset(offset);\n    \n    const stakeholders = await dataQuery;\n    \n    return { stakeholders, total: Number(total) };\n  }\n  \n  async getStakeholderStats(): Promise<{ total: number; typeCounts: Record<string, number>; favoriteCount: number }> {\n    // Get total count\n    const [{ count: total }] = await db.select({ count: count() }).from(schema.stakeholders);\n    \n    // Get count by type\n    const typeResults = await db\n      .select({ type: schema.stakeholders.type, count: count() })\n      .from(schema.stakeholders)\n      .groupBy(schema.stakeholders.type);\n    \n    const typeCounts: Record<string, number> = {};\n    for (const row of typeResults) {\n      typeCounts[row.type] = Number(row.count);\n    }\n    \n    // Get favorite count\n    const [{ count: favoriteCount }] = await db\n      .select({ count: count() })\n      .from(schema.stakeholders)\n      .where(eq(schema.stakeholders.isFavorite, true));\n    \n    return { total: Number(total), typeCounts, favoriteCount: Number(favoriteCount) };\n  }\n  \n  async createStakeholder(stakeholder: InsertStakeholder): Promise<Stakeholder> {\n    const [created] = await db.insert(schema.stakeholders).values(stakeholder).returning();\n    return created;\n  }\n  \n  async updateStakeholder(id: string, updates: Partial<InsertStakeholder>): Promise<Stakeholder | undefined> {\n    const [updated] = await db.update(schema.stakeholders)\n      .set(updates)\n      .where(eq(schema.stakeholders.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteStakeholder(id: string): Promise<void> {\n    await db.delete(schema.stakeholders).where(eq(schema.stakeholders.id, id));\n  }\n  \n  // Announcement operations\n  async getAnnouncement(id: string): Promise<Announcement | undefined> {\n    const [announcement] = await db.select().from(schema.announcements).where(eq(schema.announcements.id, id));\n    return announcement;\n  }\n  \n  async getAllAnnouncements(): Promise<Announcement[]> {\n    return await db.select().from(schema.announcements).orderBy(desc(schema.announcements.createdAt));\n  }\n  \n  async createAnnouncement(announcement: InsertAnnouncement): Promise<Announcement> {\n    const [created] = await db.insert(schema.announcements).values(announcement).returning();\n    return created;\n  }\n  \n  async updateAnnouncement(id: string, updates: Partial<InsertAnnouncement>): Promise<Announcement | undefined> {\n    const [updated] = await db.update(schema.announcements)\n      .set(updates)\n      .where(eq(schema.announcements.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteAnnouncement(id: string): Promise<void> {\n    await db.delete(schema.announcements).where(eq(schema.announcements.id, id));\n  }\n  \n  // Poll operations\n  async getPoll(id: string): Promise<Poll | undefined> {\n    const [poll] = await db.select().from(schema.polls).where(eq(schema.polls.id, id));\n    return poll;\n  }\n  \n  async getAllPolls(): Promise<Poll[]> {\n    return await db.select().from(schema.polls).orderBy(desc(schema.polls.createdAt));\n  }\n  \n  async createPoll(poll: InsertPoll): Promise<Poll> {\n    const [created] = await db.insert(schema.polls).values(poll).returning();\n    return created;\n  }\n  \n  async updatePoll(id: string, updates: Partial<InsertPoll>): Promise<Poll | undefined> {\n    const [updated] = await db.update(schema.polls)\n      .set(updates)\n      .where(eq(schema.polls.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deletePoll(id: string): Promise<void> {\n    await db.delete(schema.polls).where(eq(schema.polls.id, id));\n  }\n  \n  // Mentorship Pairing operations\n  async getMentorshipPairing(id: string): Promise<MentorshipPairing | undefined> {\n    const [pairing] = await db.select().from(schema.mentorshipPairings).where(eq(schema.mentorshipPairings.id, id));\n    return pairing;\n  }\n  \n  async getAllMentorshipPairings(): Promise<MentorshipPairing[]> {\n    return await db.select().from(schema.mentorshipPairings).orderBy(desc(schema.mentorshipPairings.createdAt));\n  }\n  \n  async createMentorshipPairing(pairing: InsertMentorshipPairing): Promise<MentorshipPairing> {\n    const [created] = await db.insert(schema.mentorshipPairings).values(pairing).returning();\n    return created;\n  }\n  \n  async updateMentorshipPairing(id: string, updates: Partial<InsertMentorshipPairing>): Promise<MentorshipPairing | undefined> {\n    const [updated] = await db.update(schema.mentorshipPairings)\n      .set(updates)\n      .where(eq(schema.mentorshipPairings.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteMentorshipPairing(id: string): Promise<void> {\n    await db.delete(schema.mentorshipPairings).where(eq(schema.mentorshipPairings.id, id));\n  }\n  \n  // Client Portal Access operations\n  async getClientPortalAccess(id: string): Promise<ClientPortalAccess | undefined> {\n    const [access] = await db.select().from(schema.clientPortalAccess).where(eq(schema.clientPortalAccess.id, id));\n    return access;\n  }\n  \n  async getAllClientPortalAccess(): Promise<ClientPortalAccess[]> {\n    return await db.select().from(schema.clientPortalAccess).orderBy(desc(schema.clientPortalAccess.createdAt));\n  }\n  \n  async getClientPortalAccessByDeal(dealId: string): Promise<ClientPortalAccess[]> {\n    return await db.select().from(schema.clientPortalAccess)\n      .where(eq(schema.clientPortalAccess.dealId, dealId))\n      .orderBy(desc(schema.clientPortalAccess.createdAt));\n  }\n  \n  async createClientPortalAccess(access: InsertClientPortalAccess): Promise<ClientPortalAccess> {\n    const [created] = await db.insert(schema.clientPortalAccess).values(access).returning();\n    return created;\n  }\n  \n  async updateClientPortalAccess(id: string, updates: Partial<InsertClientPortalAccess>): Promise<ClientPortalAccess | undefined> {\n    const [updated] = await db.update(schema.clientPortalAccess)\n      .set(updates)\n      .where(eq(schema.clientPortalAccess.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteClientPortalAccess(id: string): Promise<void> {\n    await db.delete(schema.clientPortalAccess).where(eq(schema.clientPortalAccess.id, id));\n  }\n  \n  // Document Template operations\n  async getDocumentTemplate(id: string): Promise<DocumentTemplate | undefined> {\n    const [template] = await db.select().from(schema.documentTemplates).where(eq(schema.documentTemplates.id, id));\n    return template;\n  }\n  \n  async getAllDocumentTemplates(): Promise<DocumentTemplate[]> {\n    return await db.select().from(schema.documentTemplates).orderBy(schema.documentTemplates.name);\n  }\n  \n  async createDocumentTemplate(template: InsertDocumentTemplate): Promise<DocumentTemplate> {\n    const [created] = await db.insert(schema.documentTemplates).values(template).returning();\n    return created;\n  }\n  \n  async updateDocumentTemplate(id: string, updates: Partial<InsertDocumentTemplate>): Promise<DocumentTemplate | undefined> {\n    const [updated] = await db.update(schema.documentTemplates)\n      .set(updates)\n      .where(eq(schema.documentTemplates.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteDocumentTemplate(id: string): Promise<void> {\n    await db.delete(schema.documentTemplates).where(eq(schema.documentTemplates.id, id));\n  }\n  \n  // Investor Match operations\n  async getInvestorMatchesByDeal(dealId: string): Promise<InvestorMatch[]> {\n    return await db.select().from(schema.investorMatches)\n      .where(eq(schema.investorMatches.dealId, dealId))\n      .orderBy(desc(schema.investorMatches.matchedAt));\n  }\n  \n  async createInvestorMatch(match: InsertInvestorMatch): Promise<InvestorMatch> {\n    const [created] = await db.insert(schema.investorMatches).values(match).returning();\n    return created;\n  }\n  \n  async deleteInvestorMatch(dealId: string, investorId: number): Promise<void> {\n    await db.delete(schema.investorMatches)\n      .where(and(\n        eq(schema.investorMatches.dealId, dealId),\n        eq(schema.investorMatches.investorId, investorId)\n      ));\n  }\n  \n  async deleteInvestorMatchesByDeal(dealId: string): Promise<void> {\n    await db.delete(schema.investorMatches).where(eq(schema.investorMatches.dealId, dealId));\n  }\n  \n  // User Preferences operations\n  async getUserPreferences(userId: string): Promise<UserPreferences | undefined> {\n    const [prefs] = await db.select().from(schema.userPreferences).where(eq(schema.userPreferences.userId, userId));\n    return prefs;\n  }\n  \n  async upsertUserPreferences(prefs: InsertUserPreferences): Promise<UserPreferences> {\n    try {\n      const [result] = await db.insert(schema.userPreferences)\n        .values(prefs)\n        .onConflictDoUpdate({\n          target: schema.userPreferences.userId,\n          set: { ...prefs, updatedAt: new Date() }\n        })\n        .returning();\n      return result;\n    } catch (error) {\n      console.error('Upsert user preferences error:', error);\n      const existing = await this.getUserPreferences(prefs.userId);\n      if (existing) {\n        const [updated] = await db.update(schema.userPreferences)\n          .set({ ...prefs, updatedAt: new Date() })\n          .where(eq(schema.userPreferences.userId, prefs.userId))\n          .returning();\n        return updated;\n      }\n      throw error;\n    }\n  }\n  \n  async updateUserPreferencesRecord(userId: string, updates: Partial<InsertUserPreferences>): Promise<UserPreferences | undefined> {\n    const [updated] = await db.update(schema.userPreferences)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.userPreferences.userId, userId))\n      .returning();\n    return updated;\n  }\n  \n  // Deal Template operations\n  async getDealTemplate(id: string): Promise<DealTemplate | undefined> {\n    const [template] = await db.select().from(schema.dealTemplates).where(eq(schema.dealTemplates.id, id));\n    return template;\n  }\n  \n  async getAllDealTemplates(): Promise<DealTemplate[]> {\n    return await db.select().from(schema.dealTemplates).orderBy(desc(schema.dealTemplates.usageCount));\n  }\n  \n  async createDealTemplate(template: InsertDealTemplate): Promise<DealTemplate> {\n    const [created] = await db.insert(schema.dealTemplates).values(template).returning();\n    return created;\n  }\n  \n  async updateDealTemplate(id: string, updates: Partial<InsertDealTemplate>): Promise<DealTemplate | undefined> {\n    const [updated] = await db.update(schema.dealTemplates)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.dealTemplates.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteDealTemplate(id: string): Promise<void> {\n    await db.delete(schema.dealTemplates).where(eq(schema.dealTemplates.id, id));\n  }\n  \n  // Calendar Event operations\n  async getCalendarEvent(id: string): Promise<CalendarEvent | undefined> {\n    const [event] = await db.select().from(schema.calendarEvents).where(eq(schema.calendarEvents.id, id));\n    return event;\n  }\n  \n  async getAllCalendarEvents(): Promise<CalendarEvent[]> {\n    return await db.select().from(schema.calendarEvents).orderBy(schema.calendarEvents.date);\n  }\n  \n  async getCalendarEventsByDeal(dealId: string): Promise<CalendarEvent[]> {\n    return await db.select().from(schema.calendarEvents)\n      .where(eq(schema.calendarEvents.dealId, dealId))\n      .orderBy(schema.calendarEvents.date);\n  }\n  \n  async createCalendarEvent(event: InsertCalendarEvent): Promise<CalendarEvent> {\n    const [created] = await db.insert(schema.calendarEvents).values(event).returning();\n    return created;\n  }\n  \n  async updateCalendarEvent(id: string, updates: Partial<InsertCalendarEvent>): Promise<CalendarEvent | undefined> {\n    const [updated] = await db.update(schema.calendarEvents)\n      .set(updates)\n      .where(eq(schema.calendarEvents.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteCalendarEvent(id: string): Promise<void> {\n    await db.delete(schema.calendarEvents).where(eq(schema.calendarEvents.id, id));\n  }\n  \n  // Task Attachment Record operations\n  async getTaskAttachmentRecords(taskId: string): Promise<TaskAttachmentRecord[]> {\n    return await db.select().from(schema.taskAttachmentsTable)\n      .where(eq(schema.taskAttachmentsTable.taskId, taskId))\n      .orderBy(desc(schema.taskAttachmentsTable.uploadedAt));\n  }\n  \n  async createTaskAttachmentRecord(attachment: InsertTaskAttachmentRecord): Promise<TaskAttachmentRecord> {\n    const [created] = await db.insert(schema.taskAttachmentsTable).values(attachment).returning();\n    return created;\n  }\n  \n  async deleteTaskAttachmentRecord(id: string): Promise<void> {\n    await db.delete(schema.taskAttachmentsTable).where(eq(schema.taskAttachmentsTable.id, id));\n  }\n  \n  // User Status Management operations\n  async updateUserStatus(id: string, status: string): Promise<User | undefined> {\n    const [user] = await db.update(schema.users)\n      .set({ status })\n      .where(eq(schema.users.id, id))\n      .returning();\n    return user;\n  }\n  \n  async getUsersByStatus(status: string): Promise<User[]> {\n    return await db.select().from(schema.users)\n      .where(eq(schema.users.status, status))\n      .orderBy(desc(schema.users.createdAt));\n  }\n  \n  async updateUserAccessLevel(id: string, accessLevel: string): Promise<User | undefined> {\n    const [user] = await db.update(schema.users)\n      .set({ accessLevel })\n      .where(eq(schema.users.id, id))\n      .returning();\n    return user;\n  }\n  \n  async updateUserTwoFactor(id: string, enabled: boolean, secret?: string): Promise<User | undefined> {\n    const [user] = await db.update(schema.users)\n      .set({ twoFactorEnabled: enabled, twoFactorSecret: secret || null })\n      .where(eq(schema.users.id, id))\n      .returning();\n    return user;\n  }\n  \n  // Audit Log Table operations\n  async getAuditLogTableEntries(limit: number = 100): Promise<schema.AuditLogTable[]> {\n    return await db.select().from(schema.auditLogsTable)\n      .orderBy(desc(schema.auditLogsTable.createdAt))\n      .limit(limit);\n  }\n  \n  async createAuditLogTableEntry(log: schema.InsertAuditLogTable): Promise<schema.AuditLogTable> {\n    const [created] = await db.insert(schema.auditLogsTable).values(log).returning();\n    return created;\n  }\n  \n  // Database-backed Investors operations\n  async getInvestorFromTable(id: string): Promise<schema.InvestorTable | undefined> {\n    const [investor] = await db.select().from(schema.investorsTable).where(eq(schema.investorsTable.id, id));\n    return investor;\n  }\n  \n  async getAllInvestorsFromTable(): Promise<schema.InvestorTable[]> {\n    return await db.select().from(schema.investorsTable)\n      .where(eq(schema.investorsTable.isActive, true))\n      .orderBy(schema.investorsTable.name);\n  }\n  \n  async createInvestorInTable(investor: schema.InsertInvestorTable): Promise<schema.InvestorTable> {\n    const [created] = await db.insert(schema.investorsTable).values(investor).returning();\n    return created;\n  }\n  \n  async updateInvestorInTable(id: string, updates: Partial<schema.InsertInvestorTable>): Promise<schema.InvestorTable | undefined> {\n    const [updated] = await db.update(schema.investorsTable)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.investorsTable.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteInvestorFromTable(id: string): Promise<void> {\n    await db.update(schema.investorsTable)\n      .set({ isActive: false })\n      .where(eq(schema.investorsTable.id, id));\n  }\n  \n  // Document Table operations\n  async getDocument(id: string): Promise<schema.DocumentTable | undefined> {\n    const [doc] = await db.select().from(schema.documentsTable).where(eq(schema.documentsTable.id, id));\n    return doc;\n  }\n  \n  async getAllDocuments(): Promise<schema.DocumentTable[]> {\n    return await db.select().from(schema.documentsTable)\n      .where(eq(schema.documentsTable.isArchived, false))\n      .orderBy(desc(schema.documentsTable.createdAt));\n  }\n  \n  async getDocumentsList(): Promise<Omit<schema.DocumentTable, 'fileData'>[]> {\n    // Lightweight version that excludes file data to avoid 507 errors\n    return await db.select({\n      id: schema.documentsTable.id,\n      filename: schema.documentsTable.filename,\n      category: schema.documentsTable.category,\n      dealId: schema.documentsTable.dealId,\n      tags: schema.documentsTable.tags,\n      uploadedBy: schema.documentsTable.uploadedBy,\n      isArchived: schema.documentsTable.isArchived,\n      createdAt: schema.documentsTable.createdAt,\n      updatedAt: schema.documentsTable.updatedAt,\n    }).from(schema.documentsTable)\n      .where(eq(schema.documentsTable.isArchived, false))\n      .orderBy(desc(schema.documentsTable.createdAt));\n  }\n  \n  async getDocumentsByDeal(dealId: string): Promise<schema.DocumentTable[]> {\n    return await db.select().from(schema.documentsTable)\n      .where(and(eq(schema.documentsTable.dealId, dealId), eq(schema.documentsTable.isArchived, false)))\n      .orderBy(desc(schema.documentsTable.createdAt));\n  }\n  \n  async getDocumentsByUser(userId: string): Promise<schema.DocumentTable[]> {\n    return await db.select().from(schema.documentsTable)\n      .where(and(eq(schema.documentsTable.uploadedBy, userId), eq(schema.documentsTable.isArchived, false)))\n      .orderBy(desc(schema.documentsTable.createdAt));\n  }\n  \n  async createDocument(doc: schema.InsertDocumentTable): Promise<schema.DocumentTable> {\n    const [created] = await db.insert(schema.documentsTable).values(doc).returning();\n    return created;\n  }\n  \n  async updateDocument(id: string, updates: Partial<schema.InsertDocumentTable>): Promise<schema.DocumentTable | undefined> {\n    const [updated] = await db.update(schema.documentsTable)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.documentsTable.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteDocument(id: string): Promise<void> {\n    await db.update(schema.documentsTable)\n      .set({ isArchived: true })\n      .where(eq(schema.documentsTable.id, id));\n  }\n  \n  // Client Portal Invite operations\n  async getClientPortalInvite(id: string): Promise<ClientPortalInvite | undefined> {\n    const [invite] = await db.select().from(schema.clientPortalInvites).where(eq(schema.clientPortalInvites.id, id));\n    return invite;\n  }\n  \n  async getClientPortalInviteByToken(token: string): Promise<ClientPortalInvite | undefined> {\n    const [invite] = await db.select().from(schema.clientPortalInvites)\n      .where(and(\n        eq(schema.clientPortalInvites.token, token),\n        eq(schema.clientPortalInvites.status, 'pending'),\n        gt(schema.clientPortalInvites.expiresAt, new Date())\n      ));\n    return invite;\n  }\n  \n  async getClientPortalInvitesByInviter(inviterId: string): Promise<ClientPortalInvite[]> {\n    return await db.select().from(schema.clientPortalInvites)\n      .where(eq(schema.clientPortalInvites.invitedBy, inviterId))\n      .orderBy(desc(schema.clientPortalInvites.createdAt));\n  }\n  \n  async getAllClientPortalInvites(): Promise<ClientPortalInvite[]> {\n    return await db.select().from(schema.clientPortalInvites)\n      .orderBy(desc(schema.clientPortalInvites.createdAt));\n  }\n  \n  async createClientPortalInvite(invite: InsertClientPortalInvite): Promise<ClientPortalInvite> {\n    const [created] = await db.insert(schema.clientPortalInvites).values(invite).returning();\n    return created;\n  }\n  \n  async updateClientPortalInvite(id: string, updates: Partial<InsertClientPortalInvite & { acceptedAt?: Date; userId?: string; status?: string }>): Promise<ClientPortalInvite | undefined> {\n    const [updated] = await db.update(schema.clientPortalInvites)\n      .set(updates)\n      .where(eq(schema.clientPortalInvites.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteClientPortalInvite(id: string): Promise<void> {\n    await db.delete(schema.clientPortalInvites).where(eq(schema.clientPortalInvites.id, id));\n  }\n  \n  // Client Portal Message operations\n  async getClientPortalMessagesByDeal(dealId: string): Promise<ClientPortalMessage[]> {\n    return await db.select().from(schema.clientPortalMessages)\n      .where(eq(schema.clientPortalMessages.dealId, dealId))\n      .orderBy(schema.clientPortalMessages.createdAt);\n  }\n  \n  async createClientPortalMessage(message: InsertClientPortalMessage): Promise<ClientPortalMessage> {\n    const [created] = await db.insert(schema.clientPortalMessages).values(message).returning();\n    return created;\n  }\n  \n  // Client Portal Update operations\n  async getClientPortalUpdatesByDeal(dealId: string): Promise<ClientPortalUpdate[]> {\n    return await db.select().from(schema.clientPortalUpdates)\n      .where(eq(schema.clientPortalUpdates.dealId, dealId))\n      .orderBy(desc(schema.clientPortalUpdates.createdAt));\n  }\n  \n  async createClientPortalUpdate(update: InsertClientPortalUpdate): Promise<ClientPortalUpdate> {\n    const [created] = await db.insert(schema.clientPortalUpdates).values(update).returning();\n    return created;\n  }\n  \n  // External User operations\n  async getExternalUsers(): Promise<User[]> {\n    return await db.select().from(schema.users)\n      .where(eq(schema.users.isExternal, true))\n      .orderBy(desc(schema.users.createdAt));\n  }\n  \n  async createExternalUser(user: InsertUser & { isExternal: boolean; externalOrganization?: string; invitedBy?: string }): Promise<User> {\n    const hashedPassword = await bcrypt.hash(user.password, 10);\n    const [created] = await db.insert(schema.users)\n      .values({ ...user, password: hashedPassword, role: 'External', status: 'active' })\n      .returning();\n    return created;\n  }\n  \n  async getExternalUserDeals(userId: string): Promise<Deal[]> {\n    // Get deals from portal invites for this user\n    const invites = await db.select().from(schema.clientPortalInvites)\n      .where(and(\n        eq(schema.clientPortalInvites.userId, userId),\n        eq(schema.clientPortalInvites.status, 'accepted')\n      ));\n    \n    if (invites.length === 0) return [];\n    \n    // Collect all deal IDs from invites\n    const dealIds = new Set<string>();\n    for (const invite of invites) {\n      const ids = invite.dealIds as string[] || [];\n      ids.forEach(id => dealIds.add(id));\n    }\n    \n    // Fetch deals\n    const deals: Deal[] = [];\n    for (const dealId of dealIds) {\n      const [deal] = await db.select().from(schema.deals).where(eq(schema.deals.id, dealId));\n      if (deal) deals.push(deal);\n    }\n    \n    return deals;\n  }\n  \n  // Deal Fee operations\n  async getDealFees(dealId: string): Promise<DealFee[]> {\n    return await db.select().from(schema.dealFees)\n      .where(eq(schema.dealFees.dealId, dealId))\n      .orderBy(schema.dealFees.createdAt);\n  }\n  \n  async createDealFee(fee: InsertDealFee): Promise<DealFee> {\n    const [created] = await db.insert(schema.dealFees).values(fee).returning();\n    return created;\n  }\n  \n  async updateDealFee(id: string, updates: Partial<InsertDealFee>): Promise<DealFee | undefined> {\n    const [updated] = await db.update(schema.dealFees)\n      .set(updates)\n      .where(eq(schema.dealFees.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteDealFee(id: string): Promise<void> {\n    await db.delete(schema.dealFees).where(eq(schema.dealFees.id, id));\n  }\n  \n  async getAllDealFees(): Promise<DealFee[]> {\n    return await db.select().from(schema.dealFees).orderBy(desc(schema.dealFees.createdAt));\n  }\n  \n  // Stage Document operations\n  async getStageDocuments(dealId: string, stage?: string): Promise<StageDocument[]> {\n    if (stage) {\n      return await db.select().from(schema.stageDocuments)\n        .where(and(\n          eq(schema.stageDocuments.dealId, dealId),\n          eq(schema.stageDocuments.stage, stage)\n        ))\n        .orderBy(desc(schema.stageDocuments.createdAt));\n    }\n    return await db.select().from(schema.stageDocuments)\n      .where(eq(schema.stageDocuments.dealId, dealId))\n      .orderBy(desc(schema.stageDocuments.createdAt));\n  }\n  \n  async createStageDocument(doc: InsertStageDocument): Promise<StageDocument> {\n    const [created] = await db.insert(schema.stageDocuments).values(doc).returning();\n    return created;\n  }\n  \n  async deleteStageDocument(id: string): Promise<void> {\n    await db.delete(schema.stageDocuments).where(eq(schema.stageDocuments.id, id));\n  }\n  \n  // Stage Pod Member operations\n  async getStagePodMembers(dealId: string, stage?: string): Promise<StagePodMember[]> {\n    if (stage) {\n      return await db.select().from(schema.stagePodMembers)\n        .where(and(\n          eq(schema.stagePodMembers.dealId, dealId),\n          eq(schema.stagePodMembers.stage, stage)\n        ))\n        .orderBy(schema.stagePodMembers.createdAt);\n    }\n    return await db.select().from(schema.stagePodMembers)\n      .where(eq(schema.stagePodMembers.dealId, dealId))\n      .orderBy(schema.stagePodMembers.createdAt);\n  }\n  \n  async createStagePodMember(member: InsertStagePodMember): Promise<StagePodMember> {\n    const [created] = await db.insert(schema.stagePodMembers).values(member).returning();\n    return created;\n  }\n  \n  async updateStagePodMember(id: string, updates: Partial<InsertStagePodMember>): Promise<StagePodMember | undefined> {\n    const [updated] = await db.update(schema.stagePodMembers)\n      .set(updates)\n      .where(eq(schema.stagePodMembers.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteStagePodMember(id: string): Promise<void> {\n    await db.delete(schema.stagePodMembers).where(eq(schema.stagePodMembers.id, id));\n  }\n  \n  // Stage Voice Note operations\n  async getStageVoiceNotes(dealId: string, stage?: string): Promise<StageVoiceNote[]> {\n    if (stage) {\n      return await db.select().from(schema.stageVoiceNotes)\n        .where(and(\n          eq(schema.stageVoiceNotes.dealId, dealId),\n          eq(schema.stageVoiceNotes.stage, stage)\n        ))\n        .orderBy(desc(schema.stageVoiceNotes.createdAt));\n    }\n    return await db.select().from(schema.stageVoiceNotes)\n      .where(eq(schema.stageVoiceNotes.dealId, dealId))\n      .orderBy(desc(schema.stageVoiceNotes.createdAt));\n  }\n  \n  async createStageVoiceNote(note: InsertStageVoiceNote): Promise<StageVoiceNote> {\n    const [created] = await db.insert(schema.stageVoiceNotes).values(note).returning();\n    return created;\n  }\n  \n  async deleteStageVoiceNote(id: string): Promise<void> {\n    await db.delete(schema.stageVoiceNotes).where(eq(schema.stageVoiceNotes.id, id));\n  }\n  \n  // Task Comment operations\n  async getTaskComments(taskId: string): Promise<TaskComment[]> {\n    return await db.select().from(schema.taskComments)\n      .where(eq(schema.taskComments.taskId, taskId))\n      .orderBy(schema.taskComments.createdAt);\n  }\n  \n  async createTaskComment(comment: InsertTaskComment): Promise<TaskComment> {\n    const [created] = await db.insert(schema.taskComments).values(comment).returning();\n    return created;\n  }\n  \n  async updateTaskComment(id: string, content: string): Promise<TaskComment | undefined> {\n    const [updated] = await db.update(schema.taskComments)\n      .set({ content, updatedAt: new Date() })\n      .where(eq(schema.taskComments.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteTaskComment(id: string): Promise<void> {\n    await db.delete(schema.taskComments).where(eq(schema.taskComments.id, id));\n  }\n  \n  // Deal Notes operations\n  async getDealNotes(dealId: string): Promise<DealNote[]> {\n    return await db.select().from(schema.dealNotes)\n      .where(eq(schema.dealNotes.dealId, dealId))\n      .orderBy(desc(schema.dealNotes.createdAt));\n  }\n  \n  async createDealNote(note: InsertDealNote): Promise<DealNote> {\n    const [created] = await db.insert(schema.dealNotes).values(note).returning();\n    return created;\n  }\n  \n  async updateDealNote(id: string, content: string): Promise<DealNote | undefined> {\n    const [updated] = await db.update(schema.dealNotes)\n      .set({ content, updatedAt: new Date() })\n      .where(eq(schema.dealNotes.id, id))\n      .returning();\n    return updated;\n  }\n  \n  async deleteDealNote(id: string): Promise<void> {\n    await db.delete(schema.dealNotes).where(eq(schema.dealNotes.id, id));\n  }\n  \n  // User search for autocomplete\n  async searchUsers(query: string): Promise<User[]> {\n    const allUsers = await db.select().from(schema.users)\n      .where(eq(schema.users.status, 'active'));\n    \n    const lowerQuery = query.toLowerCase();\n    return allUsers.filter(user => \n      user.name.toLowerCase().includes(lowerQuery) ||\n      user.email.toLowerCase().includes(lowerQuery)\n    );\n  }\n  \n  // Custom Sector operations\n  async getAllCustomSectors(): Promise<schema.CustomSector[]> {\n    return await db.select().from(schema.customSectors).orderBy(schema.customSectors.name);\n  }\n  \n  async createCustomSector(sector: schema.InsertCustomSector): Promise<schema.CustomSector> {\n    const [created] = await db.insert(schema.customSectors).values(sector).returning();\n    return created;\n  }\n\n  // Google Calendar Token operations\n  async getGoogleCalendarToken(userId: string): Promise<schema.GoogleCalendarToken | undefined> {\n    const [token] = await db.select().from(schema.googleCalendarTokens).where(eq(schema.googleCalendarTokens.userId, userId));\n    return token;\n  }\n\n  async saveGoogleCalendarToken(token: schema.InsertGoogleCalendarToken): Promise<schema.GoogleCalendarToken> {\n    const existing = await this.getGoogleCalendarToken(token.userId);\n    if (existing) {\n      const [updated] = await db\n        .update(schema.googleCalendarTokens)\n        .set({ ...token, updatedAt: new Date() })\n        .where(eq(schema.googleCalendarTokens.userId, token.userId))\n        .returning();\n      return updated;\n    }\n    const [created] = await db.insert(schema.googleCalendarTokens).values(token).returning();\n    return created;\n  }\n\n  async deleteGoogleCalendarToken(userId: string): Promise<void> {\n    await db.delete(schema.googleCalendarTokens).where(eq(schema.googleCalendarTokens.userId, userId));\n  }\n\n  // Forms operations\n  async getForm(id: string): Promise<schema.Form | undefined> {\n    const [form] = await db.select().from(schema.forms).where(eq(schema.forms.id, id));\n    return form;\n  }\n\n  async getFormByShareToken(shareToken: string): Promise<schema.Form | undefined> {\n    const [form] = await db.select().from(schema.forms).where(eq(schema.forms.shareToken, shareToken));\n    return form;\n  }\n\n  async getFormsByCreator(createdBy: string): Promise<schema.Form[]> {\n    return await db.select().from(schema.forms)\n      .where(eq(schema.forms.createdBy, createdBy))\n      .orderBy(schema.forms.createdAt);\n  }\n\n  async createForm(form: schema.InsertForm): Promise<schema.Form> {\n    const [created] = await db.insert(schema.forms).values(form).returning();\n    return created;\n  }\n\n  async updateForm(id: string, updates: Partial<schema.InsertForm>): Promise<schema.Form | undefined> {\n    const [updated] = await db.update(schema.forms)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.forms.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteForm(id: string): Promise<void> {\n    // Delete related records first\n    await db.delete(schema.formInvitations).where(eq(schema.formInvitations.formId, id));\n    await db.delete(schema.formSubmissions).where(eq(schema.formSubmissions.formId, id));\n    await db.delete(schema.forms).where(eq(schema.forms.id, id));\n  }\n\n  // Form Submissions operations\n  async getFormSubmission(id: string): Promise<schema.FormSubmission | undefined> {\n    const [submission] = await db.select().from(schema.formSubmissions).where(eq(schema.formSubmissions.id, id));\n    return submission;\n  }\n\n  async getFormSubmissions(formId: string): Promise<schema.FormSubmission[]> {\n    return await db.select().from(schema.formSubmissions)\n      .where(eq(schema.formSubmissions.formId, formId))\n      .orderBy(schema.formSubmissions.createdAt);\n  }\n\n  async createFormSubmission(submission: schema.InsertFormSubmission): Promise<schema.FormSubmission> {\n    const [created] = await db.insert(schema.formSubmissions).values(submission).returning();\n    return created;\n  }\n\n  async updateFormSubmission(id: string, updates: Partial<schema.InsertFormSubmission>): Promise<schema.FormSubmission | undefined> {\n    const [updated] = await db.update(schema.formSubmissions)\n      .set(updates)\n      .where(eq(schema.formSubmissions.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Form Invitations operations\n  async getFormInvitations(formId: string): Promise<schema.FormInvitation[]> {\n    return await db.select().from(schema.formInvitations)\n      .where(eq(schema.formInvitations.formId, formId))\n      .orderBy(schema.formInvitations.createdAt);\n  }\n\n  async createFormInvitation(invitation: schema.InsertFormInvitation): Promise<schema.FormInvitation> {\n    const [created] = await db.insert(schema.formInvitations).values(invitation).returning();\n    return created;\n  }\n\n  async updateFormInvitation(id: string, updates: Partial<schema.InsertFormInvitation>): Promise<schema.FormInvitation | undefined> {\n    const [updated] = await db.update(schema.formInvitations)\n      .set(updates)\n      .where(eq(schema.formInvitations.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Pending form upload operations\n  async createPendingFormUpload(upload: schema.InsertPendingFormUpload): Promise<schema.PendingFormUpload> {\n    const [created] = await db.insert(schema.pendingFormUploads).values(upload).returning();\n    return created;\n  }\n\n  async getPendingFormUpload(shareToken: string, objectPath: string): Promise<schema.PendingFormUpload | undefined> {\n    const [record] = await db.select().from(schema.pendingFormUploads)\n      .where(\n        and(\n          eq(schema.pendingFormUploads.shareToken, shareToken),\n          eq(schema.pendingFormUploads.objectPath, objectPath),\n          gt(schema.pendingFormUploads.expiresAt, new Date()),\n          isNull(schema.pendingFormUploads.confirmedAt)\n        )\n      );\n    return record;\n  }\n\n  async confirmAndDeletePendingFormUpload(shareToken: string, objectPath: string): Promise<boolean> {\n    const deleted = await db.delete(schema.pendingFormUploads)\n      .where(\n        and(\n          eq(schema.pendingFormUploads.shareToken, shareToken),\n          eq(schema.pendingFormUploads.objectPath, objectPath),\n          gt(schema.pendingFormUploads.expiresAt, new Date()),\n          isNull(schema.pendingFormUploads.confirmedAt)\n        )\n      )\n      .returning();\n    return deleted.length > 0;\n  }\n\n  async getExpiredPendingUploads(): Promise<schema.PendingFormUpload[]> {\n    return await db.select().from(schema.pendingFormUploads)\n      .where(\n        and(\n          lt(schema.pendingFormUploads.expiresAt, new Date()),\n          isNull(schema.pendingFormUploads.confirmedAt)\n        )\n      );\n  }\n\n  async deletePendingFormUpload(id: string): Promise<void> {\n    await db.delete(schema.pendingFormUploads).where(eq(schema.pendingFormUploads.id, id));\n  }\n\n  // Task Template operations\n  async getTaskTemplate(id: string): Promise<schema.TaskTemplate | undefined> {\n    const [template] = await db.select().from(schema.taskTemplates).where(eq(schema.taskTemplates.id, id));\n    return template;\n  }\n\n  async getAllTaskTemplates(): Promise<schema.TaskTemplate[]> {\n    return await db.select().from(schema.taskTemplates)\n      .where(eq(schema.taskTemplates.isArchived, false))\n      .orderBy(desc(schema.taskTemplates.createdAt));\n  }\n\n  async createTaskTemplate(template: schema.InsertTaskTemplate): Promise<schema.TaskTemplate> {\n    const [created] = await db.insert(schema.taskTemplates).values(template).returning();\n    return created;\n  }\n\n  async updateTaskTemplate(id: string, updates: Partial<schema.InsertTaskTemplate>): Promise<schema.TaskTemplate | undefined> {\n    const [updated] = await db.update(schema.taskTemplates)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(schema.taskTemplates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTaskTemplate(id: string): Promise<void> {\n    await db.delete(schema.taskTemplates).where(eq(schema.taskTemplates.id, id));\n  }\n\n  async incrementTaskTemplateUsage(id: string): Promise<void> {\n    const template = await this.getTaskTemplate(id);\n    if (template) {\n      await db.update(schema.taskTemplates)\n        .set({ usageCount: (template.usageCount || 0) + 1 })\n        .where(eq(schema.taskTemplates.id, id));\n    }\n  }\n\n  // Task Template Usage operations\n  async createTaskTemplateUsage(usage: schema.InsertTaskTemplateUsage): Promise<schema.TaskTemplateUsage> {\n    const [created] = await db.insert(schema.taskTemplateUsage).values(usage).returning();\n    return created;\n  }\n\n  async getTaskTemplateUsageByTemplate(templateId: string): Promise<schema.TaskTemplateUsage[]> {\n    return await db.select().from(schema.taskTemplateUsage)\n      .where(eq(schema.taskTemplateUsage.templateId, templateId))\n      .orderBy(desc(schema.taskTemplateUsage.createdAt));\n  }\n\n  // Personality Assessment operations\n  async getPersonalityAssessment(userId: string): Promise<schema.PersonalityAssessment | undefined> {\n    const [assessment] = await db.select().from(schema.personalityAssessments)\n      .where(eq(schema.personalityAssessments.userId, userId))\n      .orderBy(desc(schema.personalityAssessments.createdAt))\n      .limit(1);\n    return assessment;\n  }\n\n  async createPersonalityAssessment(assessment: schema.InsertPersonalityAssessment): Promise<schema.PersonalityAssessment> {\n    const [created] = await db.insert(schema.personalityAssessments).values(assessment).returning();\n    return created;\n  }\n\n  async updatePersonalityAssessment(id: string, updates: Partial<schema.InsertPersonalityAssessment>): Promise<schema.PersonalityAssessment | undefined> {\n    const [updated] = await db.update(schema.personalityAssessments)\n      .set(updates)\n      .where(eq(schema.personalityAssessments.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Resume Analysis operations\n  async getResumeAnalysis(userId: string): Promise<schema.ResumeAnalysis | undefined> {\n    const [analysis] = await db.select().from(schema.resumeAnalyses)\n      .where(eq(schema.resumeAnalyses.userId, userId))\n      .orderBy(desc(schema.resumeAnalyses.createdAt))\n      .limit(1);\n    return analysis;\n  }\n\n  async createResumeAnalysis(analysis: schema.InsertResumeAnalysis): Promise<schema.ResumeAnalysis> {\n    const [created] = await db.insert(schema.resumeAnalyses).values(analysis).returning();\n    return created;\n  }\n\n  async updateResumeAnalysis(id: string, updates: Partial<schema.InsertResumeAnalysis>): Promise<schema.ResumeAnalysis | undefined> {\n    const [updated] = await db.update(schema.resumeAnalyses)\n      .set(updates)\n      .where(eq(schema.resumeAnalyses.id, id))\n      .returning();\n    return updated;\n  }\n\n  // ================================\n  // DEAL POD OPERATIONS\n  // ================================\n\n  async getDealPod(id: string): Promise<schema.DealPod | undefined> {\n    const [pod] = await db.select().from(schema.dealPods)\n      .where(eq(schema.dealPods.id, id));\n    return pod;\n  }\n\n  async getDealPodsByDeal(dealId: string): Promise<schema.DealPod[]> {\n    return await db.select().from(schema.dealPods)\n      .where(eq(schema.dealPods.dealId, dealId))\n      .orderBy(desc(schema.dealPods.createdAt));\n  }\n\n  async getActivePodForDeal(dealId: string): Promise<schema.DealPod | undefined> {\n    const [pod] = await db.select().from(schema.dealPods)\n      .where(and(\n        eq(schema.dealPods.dealId, dealId),\n        eq(schema.dealPods.status, 'active')\n      ))\n      .orderBy(desc(schema.dealPods.createdAt))\n      .limit(1);\n    return pod;\n  }\n\n  async createDealPod(pod: schema.InsertDealPod): Promise<schema.DealPod> {\n    const [created] = await db.insert(schema.dealPods).values(pod).returning();\n    return created;\n  }\n\n  async updateDealPod(id: string, updates: Partial<schema.InsertDealPod>): Promise<schema.DealPod | undefined> {\n    const [updated] = await db.update(schema.dealPods)\n      .set(updates)\n      .where(eq(schema.dealPods.id, id))\n      .returning();\n    return updated;\n  }\n\n  // ================================\n  // POD MEMBER OPERATIONS\n  // ================================\n\n  async getPodMembers(podId: string): Promise<schema.PodMember[]> {\n    return await db.select().from(schema.podMembers)\n      .where(eq(schema.podMembers.podId, podId))\n      .orderBy(schema.podMembers.position);\n  }\n\n  async createPodMember(member: schema.InsertPodMember): Promise<schema.PodMember> {\n    const [created] = await db.insert(schema.podMembers).values(member).returning();\n    return created;\n  }\n\n  async getPodMembersByUser(userId: string): Promise<schema.PodMember[]> {\n    return await db.select().from(schema.podMembers)\n      .where(eq(schema.podMembers.userId, userId));\n  }\n\n  async getUserCurrentStageAssignments(userId: string): Promise<string[]> {\n    const activePodMemberships = await db.select({\n      stage: schema.dealPods.stage\n    })\n    .from(schema.podMembers)\n    .innerJoin(schema.dealPods, eq(schema.podMembers.podId, schema.dealPods.id))\n    .where(and(\n      eq(schema.podMembers.userId, userId),\n      eq(schema.dealPods.status, 'active')\n    ));\n    \n    return [...new Set(activePodMemberships.map(m => m.stage))];\n  }\n\n  // ================================\n  // DEAL MILESTONE OPERATIONS\n  // ================================\n\n  async getDealMilestones(dealId: string): Promise<schema.DealMilestone[]> {\n    return await db.select().from(schema.dealMilestones)\n      .where(eq(schema.dealMilestones.dealId, dealId))\n      .orderBy(schema.dealMilestones.orderIndex);\n  }\n\n  async getDealMilestonesByStage(dealId: string, stage: string): Promise<schema.DealMilestone[]> {\n    return await db.select().from(schema.dealMilestones)\n      .where(and(\n        eq(schema.dealMilestones.dealId, dealId),\n        eq(schema.dealMilestones.stage, stage)\n      ))\n      .orderBy(schema.dealMilestones.orderIndex);\n  }\n\n  async createDealMilestone(milestone: schema.InsertDealMilestone): Promise<schema.DealMilestone> {\n    const [created] = await db.insert(schema.dealMilestones).values(milestone).returning();\n    return created;\n  }\n\n  async updateDealMilestone(id: string, updates: Partial<schema.InsertDealMilestone>): Promise<schema.DealMilestone | undefined> {\n    const [updated] = await db.update(schema.dealMilestones)\n      .set(updates)\n      .where(eq(schema.dealMilestones.id, id))\n      .returning();\n    return updated;\n  }\n\n  // ================================\n  // POD MOVEMENT TASK OPERATIONS\n  // ================================\n\n  async getPodMovementTasks(dealId: string): Promise<schema.PodMovementTask[]> {\n    return await db.select().from(schema.podMovementTasks)\n      .where(eq(schema.podMovementTasks.dealId, dealId));\n  }\n\n  async getPodMovementTasksByMilestone(milestoneId: string): Promise<schema.PodMovementTask[]> {\n    return await db.select().from(schema.podMovementTasks)\n      .where(eq(schema.podMovementTasks.milestoneId, milestoneId));\n  }\n\n  async createPodMovementTask(task: schema.InsertPodMovementTask): Promise<schema.PodMovementTask> {\n    const [created] = await db.insert(schema.podMovementTasks).values(task).returning();\n    return created;\n  }\n\n  async updatePodMovementTask(id: string, updates: Partial<schema.InsertPodMovementTask>): Promise<schema.PodMovementTask | undefined> {\n    const [updated] = await db.update(schema.podMovementTasks)\n      .set(updates)\n      .where(eq(schema.podMovementTasks.id, id))\n      .returning();\n    return updated;\n  }\n\n  // ================================\n  // DEAL CONTEXT UPDATE OPERATIONS\n  // ================================\n\n  async getDealContextUpdates(dealId: string): Promise<schema.DealContextUpdate[]> {\n    return await db.select().from(schema.dealContextUpdates)\n      .where(eq(schema.dealContextUpdates.dealId, dealId))\n      .orderBy(desc(schema.dealContextUpdates.createdAt));\n  }\n\n  async createDealContextUpdate(update: schema.InsertDealContextUpdate): Promise<schema.DealContextUpdate> {\n    const [created] = await db.insert(schema.dealContextUpdates).values(update).returning();\n    return created;\n  }\n\n  async markDealContextIndexed(id: string): Promise<void> {\n    await db.update(schema.dealContextUpdates)\n      .set({ indexedForAI: true, indexedAt: new Date() })\n      .where(eq(schema.dealContextUpdates.id, id));\n  }\n\n  async getUnindexedDealContext(dealId: string): Promise<schema.DealContextUpdate[]> {\n    return await db.select().from(schema.dealContextUpdates)\n      .where(and(\n        eq(schema.dealContextUpdates.dealId, dealId),\n        eq(schema.dealContextUpdates.indexedForAI, false)\n      ))\n      .orderBy(schema.dealContextUpdates.createdAt);\n  }\n\n  // ================================\n  // WORKLOAD TRACKING\n  // ================================\n\n  async getUserWorkload(userId: string): Promise<{ activeTasks: number; pendingTasks: number; completedThisWeek: number }> {\n    const oneWeekAgo = new Date();\n    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);\n\n    const allTasks = await db.select().from(schema.tasks)\n      .where(eq(schema.tasks.assignedTo, userId));\n\n    const activeTasks = allTasks.filter(t => t.status === 'In Progress').length;\n    const pendingTasks = allTasks.filter(t => t.status === 'Pending').length;\n    const completedThisWeek = allTasks.filter(t => \n      t.status === 'Completed' && \n      t.completedAt && \n      new Date(t.completedAt) >= oneWeekAgo\n    ).length;\n\n    return { activeTasks, pendingTasks, completedThisWeek };\n  }\n\n  async getAllUsersWithProfiles(): Promise<Array<{\n    user: schema.User;\n    resumeAnalysis: schema.ResumeAnalysis | null;\n    personalityAssessment: schema.PersonalityAssessment | null;\n    workload: { activeTasks: number; pendingTasks: number; completedThisWeek: number };\n  }>> {\n    const users = await this.getAllUsers();\n    const results = [];\n\n    for (const user of users) {\n      // Skip external users and non-deal-eligible users (HR, AI Engineer, etc.)\n      if (!schema.isDealEligibleUser(user)) continue;\n\n      const resumeAnalysis = await this.getResumeAnalysis(user.id);\n      const personalityAssessment = await this.getPersonalityAssessment(user.id);\n      const workload = await this.getUserWorkload(user.id);\n\n      results.push({\n        user,\n        resumeAnalysis: resumeAnalysis || null,\n        personalityAssessment: personalityAssessment || null,\n        workload\n      });\n    }\n\n    return results;\n  }\n\n  async getAllResumeAnalyses(): Promise<schema.ResumeAnalysis[]> {\n    return await db.select().from(schema.resumeAnalyses)\n      .where(eq(schema.resumeAnalyses.status, 'completed'));\n  }\n\n  async getAllPersonalityAssessments(): Promise<schema.PersonalityAssessment[]> {\n    return await db.select().from(schema.personalityAssessments)\n      .where(eq(schema.personalityAssessments.status, 'completed'));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":94405,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8608,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, timestamp, boolean, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  phone: text(\"phone\"),\n  avatar: text(\"avatar\"),\n  role: text(\"role\").notNull().default('Employee'), // Legacy field - kept for compatibility\n  accessLevel: text(\"access_level\").notNull().default('standard'), // admin or standard\n  jobTitle: text(\"job_title\"),\n  status: text(\"status\").notNull().default('pending'), // pending, active, suspended\n  score: integer(\"score\").default(0),\n  activeDeals: integer(\"active_deals\").default(0),\n  completedTasks: integer(\"completed_tasks\").default(0),\n  preferences: jsonb(\"preferences\").default({}),\n  twoFactorEnabled: boolean(\"two_factor_enabled\").default(false),\n  twoFactorSecret: text(\"two_factor_secret\"),\n  // External user fields (for Client Portal access)\n  isExternal: boolean(\"is_external\").default(false),\n  externalOrganization: text(\"external_organization\"), // Company/org name for external users\n  invitedBy: varchar(\"invited_by\"), // User ID who invited this external user\n  // Asset Management access flag (for standard users who need AM visibility)\n  hasAssetManagementAccess: boolean(\"has_asset_management_access\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Password Reset Tokens table\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  token: text(\"token\").notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  used: boolean(\"used\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\n// Pod Team Member type\nexport type PodTeamMember = {\n  userId?: string;\n  name: string;\n  role: string;\n  email?: string;\n  phone?: string;\n  slack?: string;\n};\n\n// Investor type\nexport type TaggedInvestor = {\n  id: string;\n  name: string;\n  firm: string;\n  type: string; // e.g., 'PE', 'VC', 'Strategic', 'Family Office'\n  status: string; // e.g., 'Contacted', 'Interested', 'Passed', 'In DD'\n  notes?: string;\n  email?: string;\n  phone?: string;\n  website?: string;\n};\n\n// Audit Trail Entry type\nexport type AuditEntry = {\n  id: string;\n  timestamp: string;\n  action: string;\n  user: string;\n  details: string;\n};\n\n// Deal Types: 'M&A', 'Capital Raising', 'Asset Management', 'Opportunity'\n// Opportunity deals are pending approval before becoming active deals\n\n// Deals table\nexport const deals = pgTable(\"deals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  dealType: text(\"deal_type\").notNull().default('M&A'), // M&A, Capital Raising, Asset Management, Opportunity\n  stage: text(\"stage\").notNull().default('Origination'),\n  value: integer(\"value\").notNull(), // in millions\n  client: text(\"client\").notNull(),\n  clientContactName: text(\"client_contact_name\"),\n  clientContactEmail: text(\"client_contact_email\"),\n  clientContactPhone: text(\"client_contact_phone\"),\n  clientContactRole: text(\"client_contact_role\"),\n  sector: text(\"sector\").notNull(),\n  lead: text(\"lead\").notNull(),\n  progress: integer(\"progress\").default(0),\n  status: text(\"status\").notNull().default('Active'),\n  description: text(\"description\"),\n  attachments: jsonb(\"attachments\").default([]),\n  podTeam: jsonb(\"pod_team\").default([]).$type<PodTeamMember[]>(),\n  taggedInvestors: jsonb(\"tagged_investors\").default([]).$type<TaggedInvestor[]>(),\n  auditTrail: jsonb(\"audit_trail\").default([]).$type<AuditEntry[]>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDealSchema = createInsertSchema(deals).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDeal = z.infer<typeof insertDealSchema>;\nexport type Deal = typeof deals.$inferSelect;\n\n// Task Attachment type\nexport type TaskAttachment = {\n  id: string;\n  filename: string;\n  url: string;\n  size: number;\n  uploadedAt: string;\n};\n\n// Tasks table\nexport const tasks = pgTable(\"tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  dealStage: text(\"deal_stage\"), // Stage this task belongs to\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  assignedBy: varchar(\"assigned_by\").references(() => users.id),\n  priority: text(\"priority\").notNull().default('Medium'),\n  dueDate: text(\"due_date\"), // Optional - tasks without due dates are valid\n  status: text(\"status\").notNull().default('Pending'),\n  type: text(\"type\").default('General'), // Optional with default\n  attachments: jsonb(\"attachments\").default([]).$type<TaskAttachment[]>(),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTaskSchema = createInsertSchema(tasks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type Task = typeof tasks.$inferSelect;\n\n// Meetings table\nexport const meetings = pgTable(\"meetings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  scheduledFor: timestamp(\"scheduled_for\").notNull(),\n  duration: integer(\"duration\").notNull().default(60), // in minutes\n  location: text(\"location\"),\n  videoPlatform: text(\"video_platform\"), // zoom, google_meet, teams, or null\n  videoLink: text(\"video_link\"), // auto-generated placeholder link\n  organizerId: varchar(\"organizer_id\").references(() => users.id),\n  participants: jsonb(\"participants\").default([]), // array of email strings\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  status: text(\"status\").notNull().default('scheduled'), // scheduled, completed, cancelled\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertMeetingSchema = createInsertSchema(meetings).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertMeeting = z.infer<typeof insertMeetingSchema>;\nexport type Meeting = typeof meetings.$inferSelect;\n\n// Notifications table\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  type: text(\"type\").notNull().default('info'), // info, success, warning, error\n  read: boolean(\"read\").default(false),\n  link: text(\"link\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\n// Conversations table for chat\nexport const conversations = pgTable(\"conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\"),\n  isGroup: boolean(\"is_group\").default(false),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertConversationSchema = createInsertSchema(conversations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertConversation = z.infer<typeof insertConversationSchema>;\nexport type Conversation = typeof conversations.$inferSelect;\n\n// Conversation Members table\nexport const conversationMembers = pgTable(\"conversation_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").references(() => conversations.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n  lastReadAt: timestamp(\"last_read_at\"),\n});\n\nexport const insertConversationMemberSchema = createInsertSchema(conversationMembers).omit({\n  id: true,\n  joinedAt: true,\n});\n\nexport type InsertConversationMember = z.infer<typeof insertConversationMemberSchema>;\nexport type ConversationMember = typeof conversationMembers.$inferSelect;\n\n// Message Attachment type\nexport type MessageAttachment = {\n  id: string;\n  filename: string;\n  url: string;\n  size: number;\n  type: string;\n};\n\n// Message Reaction type\nexport type MessageReaction = {\n  emoji: string;\n  userId: string;\n  userName: string;\n  createdAt: string;\n};\n\n// Messages table\nexport const messages = pgTable(\"messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").references(() => conversations.id).notNull(),\n  senderId: varchar(\"sender_id\").references(() => users.id).notNull(),\n  content: text(\"content\").notNull(),\n  attachments: jsonb(\"attachments\").default([]).$type<MessageAttachment[]>(),\n  reactions: jsonb(\"reactions\").default([]).$type<MessageReaction[]>(),\n  replyToMessageId: varchar(\"reply_to_message_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\nexport type Message = typeof messages.$inferSelect;\n\n// Reaper Assistant Conversations table\nexport const assistantConversations = pgTable(\"assistant_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  title: text(\"title\").default('New Conversation'),\n  isShared: boolean(\"is_shared\").default(false),\n  sharedWith: text(\"shared_with\").array(), // Array of user IDs who can access\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAssistantConversationSchema = createInsertSchema(assistantConversations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertAssistantConversation = z.infer<typeof insertAssistantConversationSchema>;\nexport type AssistantConversation = typeof assistantConversations.$inferSelect;\n\n// Assistant Message Attachment type\nexport type AssistantAttachment = {\n  id: string;\n  filename: string;\n  url: string;\n  mimeType: string;\n  size: number;\n  uploadedAt: string;\n};\n\n// Assistant Message Mention type\nexport type AssistantMention = {\n  userId: string;\n  userName: string;\n  notified: boolean;\n};\n\n// Reaper Assistant Messages table\nexport const assistantMessages = pgTable(\"assistant_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").references(() => assistantConversations.id).notNull(),\n  role: text(\"role\").notNull(), // 'user' or 'assistant'\n  content: text(\"content\").notNull(),\n  attachments: jsonb(\"attachments\").default([]).$type<AssistantAttachment[]>(),\n  mentions: jsonb(\"mentions\").default([]).$type<AssistantMention[]>(), // @ mentions in the message\n  context: jsonb(\"context\").default({}), // stores any context used for the response\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAssistantMessageSchema = createInsertSchema(assistantMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAssistantMessage = z.infer<typeof insertAssistantMessageSchema>;\nexport type AssistantMessage = typeof assistantMessages.$inferSelect;\n\n// Time Entries table (for Time Tracking)\nexport const timeEntries = pgTable(\"time_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  taskId: varchar(\"task_id\").references(() => tasks.id),\n  description: text(\"description\"),\n  hours: integer(\"hours\").notNull().default(0), // stored as minutes for precision\n  date: text(\"date\").notNull(), // YYYY-MM-DD format\n  category: text(\"category\").notNull().default('General'), // Meetings, Research, Document Review, Client Calls, etc.\n  billable: boolean(\"billable\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTimeEntrySchema = createInsertSchema(timeEntries).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTimeEntry = z.infer<typeof insertTimeEntrySchema>;\nexport type TimeEntry = typeof timeEntries.$inferSelect;\n\n// Time Off Requests table (for Vacation Calendar)\nexport const timeOffRequests = pgTable(\"time_off_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  type: text(\"type\").notNull().default('Vacation'), // Vacation, Sick, Personal, WFH\n  startDate: text(\"start_date\").notNull(), // YYYY-MM-DD\n  endDate: text(\"end_date\").notNull(), // YYYY-MM-DD\n  notes: text(\"notes\"),\n  status: text(\"status\").notNull().default('Pending'), // Pending, Approved, Denied\n  approvedBy: varchar(\"approved_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTimeOffRequestSchema = createInsertSchema(timeOffRequests).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTimeOffRequest = z.infer<typeof insertTimeOffRequestSchema>;\nexport type TimeOffRequest = typeof timeOffRequests.$inferSelect;\n\n// Audit Logs table (for Audit Trail)\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(), // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT, etc.\n  entityType: text(\"entity_type\").notNull(), // Deal, Task, Document, User, etc.\n  entityId: varchar(\"entity_id\"),\n  details: text(\"details\"),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\n\n// Investors table (for Investor CRM)\nexport const investors = pgTable(\"investors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  firm: text(\"firm\").notNull(),\n  type: text(\"type\").notNull().default('PE'), // PE, VC, Strategic, Family Office, Sovereign Wealth, Hedge Fund\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  linkedIn: text(\"linkedin\"),\n  location: text(\"location\"),\n  sectors: jsonb(\"sectors\").default([]).$type<string[]>(), // Array of sector interests\n  minDealSize: integer(\"min_deal_size\"), // Minimum deal size in millions\n  maxDealSize: integer(\"max_deal_size\"), // Maximum deal size in millions\n  status: text(\"status\").notNull().default('Active'), // Active, Warm, Cold, Inactive\n  relationshipScore: integer(\"relationship_score\").default(50), // 0-100\n  dealsParticipated: integer(\"deals_participated\").default(0),\n  notes: text(\"notes\"),\n  lastContactDate: text(\"last_contact_date\"), // YYYY-MM-DD\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertInvestorSchema = createInsertSchema(investors).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertInvestor = z.infer<typeof insertInvestorSchema>;\nexport type Investor = typeof investors.$inferSelect;\n\n// Investor Interactions table (for tracking touchpoints)\nexport const investorInteractions = pgTable(\"investor_interactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  investorId: varchar(\"investor_id\").references(() => investors.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  type: text(\"type\").notNull().default('Call'), // Call, Email, Meeting, Conference, Introduction\n  date: text(\"date\").notNull(), // YYYY-MM-DD\n  notes: text(\"notes\"),\n  outcome: text(\"outcome\"), // Positive, Neutral, Negative\n  followUpDate: text(\"follow_up_date\"), // YYYY-MM-DD\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertInvestorInteractionSchema = createInsertSchema(investorInteractions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertInvestorInteraction = z.infer<typeof insertInvestorInteractionSchema>;\nexport type InvestorInteraction = typeof investorInteractions.$inferSelect;\n\n// Sessions table (for PostgreSQL session storage)\nexport const sessions = pgTable(\"sessions\", {\n  sid: varchar(\"sid\").primaryKey(),\n  sess: jsonb(\"sess\").notNull(),\n  expire: timestamp(\"expire\", { precision: 6 }).notNull(),\n});\n\n// Key Result type for OKRs\nexport type KeyResult = {\n  id: string;\n  title: string;\n  targetValue: number;\n  currentValue: number;\n  unit: string;\n  progress: number;\n};\n\n// OKRs table (Objectives and Key Results)\nexport const okrs = pgTable(\"okrs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  objective: text(\"objective\").notNull(),\n  description: text(\"description\"),\n  ownerId: varchar(\"owner_id\").references(() => users.id),\n  ownerName: text(\"owner_name\").notNull(),\n  quarter: text(\"quarter\").notNull(), // Q1, Q2, Q3, Q4\n  year: integer(\"year\").notNull(),\n  keyResults: jsonb(\"key_results\").default([]).$type<KeyResult[]>(),\n  status: text(\"status\").notNull().default('on-track'), // on-track, at-risk, behind, completed\n  overallProgress: integer(\"overall_progress\").default(0),\n  type: text(\"type\").notNull().default('individual'), // individual, team\n  teamName: text(\"team_name\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertOkrSchema = createInsertSchema(okrs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertOkr = z.infer<typeof insertOkrSchema>;\nexport type Okr = typeof okrs.$inferSelect;\n\n// Stakeholders table\nexport const stakeholders = pgTable(\"stakeholders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  title: text(\"title\").notNull(),\n  company: text(\"company\").notNull(),\n  type: text(\"type\").notNull().default('other'), // investor, advisor, legal, banker, consultant, client, other\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  linkedin: text(\"linkedin\"),\n  website: text(\"website\"),\n  location: text(\"location\"),\n  focus: text(\"focus\"), // Sector interest for investors (Technology, Healthcare, Consumer, etc.)\n  notes: text(\"notes\"),\n  deals: jsonb(\"deals\").default([]).$type<string[]>(),\n  isFavorite: boolean(\"is_favorite\").default(false),\n  lastContact: text(\"last_contact\"), // ISO date string\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertStakeholderSchema = createInsertSchema(stakeholders).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertStakeholder = z.infer<typeof insertStakeholderSchema>;\nexport type Stakeholder = typeof stakeholders.$inferSelect;\n\n// Announcement Reaction type\nexport type AnnouncementReaction = {\n  emoji: string;\n  count: number;\n  userIds: string[];\n};\n\n// Announcement Comment type\nexport type AnnouncementComment = {\n  id: string;\n  authorId: string;\n  authorName: string;\n  content: string;\n  createdAt: string;\n};\n\n// Announcements table\nexport const announcements = pgTable(\"announcements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  type: text(\"type\").notNull().default('general'), // deal-closed, milestone, team-update, celebration, general\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  dealName: text(\"deal_name\"),\n  authorId: varchar(\"author_id\").references(() => users.id).notNull(),\n  authorName: text(\"author_name\").notNull(),\n  isPinned: boolean(\"is_pinned\").default(false),\n  reactions: jsonb(\"reactions\").default([]).$type<AnnouncementReaction[]>(),\n  comments: jsonb(\"comments\").default([]).$type<AnnouncementComment[]>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAnnouncementSchema = createInsertSchema(announcements).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAnnouncement = z.infer<typeof insertAnnouncementSchema>;\nexport type Announcement = typeof announcements.$inferSelect;\n\n// Poll Option type\nexport type PollOption = {\n  id: string;\n  text: string;\n  votes: string[]; // array of user IDs who voted\n};\n\n// Polls table\nexport const polls = pgTable(\"polls\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  question: text(\"question\").notNull(),\n  options: jsonb(\"options\").default([]).$type<PollOption[]>(),\n  creatorId: varchar(\"creator_id\").references(() => users.id).notNull(),\n  creatorName: text(\"creator_name\").notNull(),\n  expiresAt: text(\"expires_at\").notNull(), // ISO date string\n  isAnonymous: boolean(\"is_anonymous\").default(false),\n  allowMultiple: boolean(\"allow_multiple\").default(false),\n  status: text(\"status\").notNull().default('active'), // active, closed\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPollSchema = createInsertSchema(polls).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPoll = z.infer<typeof insertPollSchema>;\nexport type Poll = typeof polls.$inferSelect;\n\n// Mentorship Pairings table\nexport const mentorshipPairings = pgTable(\"mentorship_pairings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  mentorId: varchar(\"mentor_id\").references(() => users.id).notNull(),\n  mentorName: text(\"mentor_name\").notNull(),\n  menteeId: varchar(\"mentee_id\").references(() => users.id).notNull(),\n  menteeName: text(\"mentee_name\").notNull(),\n  focusAreas: jsonb(\"focus_areas\").default([]).$type<string[]>(),\n  goals: jsonb(\"goals\").default([]).$type<string[]>(),\n  status: text(\"status\").notNull().default('active'), // active, completed, paused\n  startDate: text(\"start_date\").notNull(), // ISO date string\n  endDate: text(\"end_date\"),\n  meetingFrequency: text(\"meeting_frequency\").default('Weekly'), // Weekly, Bi-weekly, Monthly\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertMentorshipPairingSchema = createInsertSchema(mentorshipPairings).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertMentorshipPairing = z.infer<typeof insertMentorshipPairingSchema>;\nexport type MentorshipPairing = typeof mentorshipPairings.$inferSelect;\n\n// Client Portal Access table\nexport const clientPortalAccess = pgTable(\"client_portal_access\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientName: text(\"client_name\").notNull(),\n  clientEmail: text(\"client_email\").notNull(),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  accessLevel: text(\"access_level\").notNull().default('view'), // view, comment, edit\n  isActive: boolean(\"is_active\").default(true),\n  lastAccess: text(\"last_access\"), // ISO date string\n  invitedBy: varchar(\"invited_by\").references(() => users.id),\n  accessToken: text(\"access_token\"),\n  expiresAt: text(\"expires_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertClientPortalAccessSchema = createInsertSchema(clientPortalAccess).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertClientPortalAccess = z.infer<typeof insertClientPortalAccessSchema>;\nexport type ClientPortalAccess = typeof clientPortalAccess.$inferSelect;\n\n// Document Templates table\nexport const documentTemplates = pgTable(\"document_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  category: text(\"category\").notNull().default('General'), // Legal, Deal, Analysis, Governance, General\n  complexity: text(\"complexity\").notNull().default('Medium'), // Low, Medium, High\n  content: text(\"content\"), // Template content/structure\n  lastUsed: text(\"last_used\"), // ISO date string\n  usageCount: integer(\"usage_count\").default(0),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  isDefault: boolean(\"is_default\").default(false), // System default templates\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDocumentTemplateSchema = createInsertSchema(documentTemplates).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDocumentTemplate = z.infer<typeof insertDocumentTemplateSchema>;\nexport type DocumentTemplate = typeof documentTemplates.$inferSelect;\n\n// Investor Matches table - tracks matched/rejected investors per deal\nexport const investorMatches = pgTable(\"investor_matches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  investorId: varchar(\"investor_id\").notNull(), // Stakeholder ID (type='investor')\n  status: text(\"status\").notNull().default('matched'), // matched, rejected\n  matchedBy: varchar(\"matched_by\").references(() => users.id),\n  matchedAt: timestamp(\"matched_at\").defaultNow(),\n});\n\nexport const insertInvestorMatchSchema = createInsertSchema(investorMatches).omit({\n  id: true,\n  matchedAt: true,\n});\n\nexport type InsertInvestorMatch = z.infer<typeof insertInvestorMatchSchema>;\nexport type InvestorMatch = typeof investorMatches.$inferSelect;\n\n// User Preferences table - stores dashboard widgets, sidebar state, theme, etc.\nexport const userPreferences = pgTable(\"user_preferences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull().unique(),\n  dashboardWidgets: jsonb(\"dashboard_widgets\").default([]), // Widget configuration array\n  sidebarCollapsed: boolean(\"sidebar_collapsed\").default(false),\n  theme: text(\"theme\").default('system'), // light, dark, system\n  complianceDefaults: jsonb(\"compliance_defaults\").default({ sec: false, finra: false, legal: true }),\n  marketSymbols: jsonb(\"market_symbols\").default(['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'SPY']),\n  settings: jsonb(\"settings\").default({}), // General settings (notifications, display, account preferences)\n  hasSeenWelcome: boolean(\"has_seen_welcome\").default(false), // Track if user has seen welcome modal\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserPreferencesSchema = createInsertSchema(userPreferences).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertUserPreferences = z.infer<typeof insertUserPreferencesSchema>;\nexport type UserPreferences = typeof userPreferences.$inferSelect;\n\n// Deal Template Task type\nexport type DealTemplateTask = {\n  title: string;\n  type: string;\n  priority: string;\n};\n\n// Deal Templates table - workflow templates for creating deals\nexport const dealTemplates = pgTable(\"deal_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  sector: text(\"sector\").notNull().default('All'),\n  dealType: text(\"deal_type\").notNull().default('M&A'), // M&A, Capital Raising, Divestiture, etc.\n  stages: jsonb(\"stages\").default([]).$type<string[]>(),\n  defaultTasks: jsonb(\"default_tasks\").default([]).$type<DealTemplateTask[]>(),\n  estimatedDuration: integer(\"estimated_duration\").default(90), // in days\n  checklistItems: jsonb(\"checklist_items\").default([]).$type<string[]>(),\n  isFavorite: boolean(\"is_favorite\").default(false),\n  usageCount: integer(\"usage_count\").default(0),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDealTemplateSchema = createInsertSchema(dealTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertDealTemplate = z.infer<typeof insertDealTemplateSchema>;\nexport type DealTemplate = typeof dealTemplates.$inferSelect;\n\n// Calendar Events table - for capital raising calendar and other events\nexport const calendarEvents = pgTable(\"calendar_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  type: text(\"type\").notNull().default('deadline'), // deadline, meeting, milestone, filing, call, followup, presentation\n  date: text(\"date\").notNull(), // ISO date string\n  time: text(\"time\"), // HH:MM format\n  description: text(\"description\"),\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  dealName: text(\"deal_name\"),\n  location: text(\"location\"),\n  participants: jsonb(\"participants\").default([]).$type<string[]>(),\n  isAllDay: boolean(\"is_all_day\").default(false),\n  color: text(\"color\"), // Hex color for calendar display\n  investor: text(\"investor\"), // For capital raising events - investor name\n  status: text(\"status\").default('scheduled'), // scheduled, completed, pending\n  notes: text(\"notes\"), // Additional notes\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  googleCalendarEventId: text(\"google_calendar_event_id\"), // For Google Calendar sync\n  googleCalendarSyncedAt: timestamp(\"google_calendar_synced_at\"), // Last sync timestamp\n  syncSource: text(\"sync_source\").default('platform'), // 'platform' or 'google' - where event originated\n});\n\nexport const insertCalendarEventSchema = createInsertSchema(calendarEvents).omit({\n  id: true,\n  createdAt: true,\n  googleCalendarSyncedAt: true,\n});\n\nexport type InsertCalendarEvent = z.infer<typeof insertCalendarEventSchema>;\nexport type CalendarEvent = typeof calendarEvents.$inferSelect;\n\n// Task Attachments table - metadata for uploaded files (DB table)\nexport const taskAttachmentsTable = pgTable(\"task_attachments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  taskId: varchar(\"task_id\").references(() => tasks.id).notNull(),\n  filename: text(\"filename\").notNull(),\n  originalName: text(\"original_name\").notNull(),\n  mimeType: text(\"mime_type\"),\n  size: integer(\"size\"), // in bytes\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow(),\n});\n\nexport const insertTaskAttachmentRecordSchema = createInsertSchema(taskAttachmentsTable).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport type InsertTaskAttachmentRecord = z.infer<typeof insertTaskAttachmentRecordSchema>;\nexport type TaskAttachmentRecord = typeof taskAttachmentsTable.$inferSelect;\n\n// Audit Logs table - tracks important actions for compliance\nexport const auditLogsTable = pgTable(\"audit_logs_table\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  userName: text(\"user_name\"),\n  action: text(\"action\").notNull(), // user_approved, user_suspended, role_changed, deal_created, deal_updated, etc.\n  entityType: text(\"entity_type\").notNull(), // user, deal, task, meeting, etc.\n  entityId: varchar(\"entity_id\"),\n  entityName: text(\"entity_name\"),\n  details: jsonb(\"details\").default({}), // Additional context like old/new values\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAuditLogTableSchema = createInsertSchema(auditLogsTable).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAuditLogTable = z.infer<typeof insertAuditLogTableSchema>;\nexport type AuditLogTable = typeof auditLogsTable.$inferSelect;\n\n// Database-backed Investors table (replacing static investors.ts)\nexport const investorsTable = pgTable(\"investors_table\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  firm: text(\"firm\").notNull(),\n  type: text(\"type\").notNull(), // PE, VC, Strategic, Family Office, Hedge Fund, etc.\n  focus: text(\"focus\").default('Multi-sector'), // Technology, Healthcare, Consumer, etc.\n  aum: text(\"aum\"), // Assets Under Management\n  checkSize: text(\"check_size\"), // Typical investment size range\n  preferredStage: text(\"preferred_stage\"), // Growth, Late Stage, Buyout, etc.\n  location: text(\"location\"),\n  website: text(\"website\"),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  linkedIn: text(\"linkedin\"),\n  notes: text(\"notes\"),\n  tags: jsonb(\"tags\").default([]).$type<string[]>(),\n  isActive: boolean(\"is_active\").default(true),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertInvestorTableSchema = createInsertSchema(investorsTable).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertInvestorTable = z.infer<typeof insertInvestorTableSchema>;\nexport type InvestorTable = typeof investorsTable.$inferSelect;\n\n// Documents table - persistent storage for generated and uploaded documents\nexport const documentsTable = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  type: text(\"type\").notNull(), // teaser, cim, nda, loi, term_sheet, sba, sba_addendum, uploaded, etc.\n  category: text(\"category\").default('general'), // deal_document, compliance, template, etc.\n  filename: text(\"filename\").notNull(),\n  originalName: text(\"original_name\"),\n  mimeType: text(\"mime_type\"),\n  size: integer(\"size\"), // in bytes\n  content: text(\"content\"), // For generated documents, store the content\n  dealId: varchar(\"deal_id\").references(() => deals.id),\n  dealName: text(\"deal_name\"),\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  uploaderName: text(\"uploader_name\"),\n  tags: jsonb(\"tags\").default([]).$type<string[]>(),\n  isArchived: boolean(\"is_archived\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDocumentTableSchema = createInsertSchema(documentsTable).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertDocumentTable = z.infer<typeof insertDocumentTableSchema>;\nexport type DocumentTable = typeof documentsTable.$inferSelect;\n\n// Client Portal Invites table - for inviting external users to access the portal\nexport const clientPortalInvites = pgTable(\"client_portal_invites\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: text(\"email\").notNull(),\n  name: text(\"name\").notNull(),\n  organization: text(\"organization\"), // Client/investor company name\n  token: text(\"token\").notNull().unique(), // Secure invite token\n  dealIds: jsonb(\"deal_ids\").default([]).$type<string[]>(), // Deals they'll have access to\n  accessLevel: text(\"access_level\").notNull().default('view'), // view, comment, edit\n  invitedBy: varchar(\"invited_by\").references(() => users.id).notNull(),\n  inviterName: text(\"inviter_name\").notNull(),\n  message: text(\"message\"), // Optional personal message in invite email\n  status: text(\"status\").notNull().default('pending'), // pending, accepted, expired, revoked\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  acceptedAt: timestamp(\"accepted_at\"),\n  userId: varchar(\"user_id\").references(() => users.id), // Set when invite is accepted and user is created\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertClientPortalInviteSchema = createInsertSchema(clientPortalInvites).omit({\n  id: true,\n  createdAt: true,\n  acceptedAt: true,\n  userId: true,\n});\n\nexport type InsertClientPortalInvite = z.infer<typeof insertClientPortalInviteSchema>;\nexport type ClientPortalInvite = typeof clientPortalInvites.$inferSelect;\n\n// Client Portal Messages table - for communication between external clients and internal team\nexport const clientPortalMessages = pgTable(\"client_portal_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  senderId: varchar(\"sender_id\").references(() => users.id).notNull(),\n  senderName: text(\"sender_name\").notNull(),\n  isExternal: boolean(\"is_external\").default(false), // True if sent by external client\n  content: text(\"content\").notNull(),\n  attachments: jsonb(\"attachments\").default([]).$type<{ filename: string; url: string; size: number }[]>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertClientPortalMessageSchema = createInsertSchema(clientPortalMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertClientPortalMessage = z.infer<typeof insertClientPortalMessageSchema>;\nexport type ClientPortalMessage = typeof clientPortalMessages.$inferSelect;\n\n// Client Portal Updates table - progress updates visible to external clients\nexport const clientPortalUpdates = pgTable(\"client_portal_updates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  type: text(\"type\").notNull().default('update'), // update, milestone, document, meeting\n  authorId: varchar(\"author_id\").references(() => users.id).notNull(),\n  authorName: text(\"author_name\").notNull(),\n  isPublic: boolean(\"is_public\").default(true), // Whether visible to external clients\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertClientPortalUpdateSchema = createInsertSchema(clientPortalUpdates).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertClientPortalUpdate = z.infer<typeof insertClientPortalUpdateSchema>;\nexport type ClientPortalUpdate = typeof clientPortalUpdates.$inferSelect;\n\n// Deal Fees table - tracks different fee types per deal\nexport const dealFees = pgTable(\"deal_fees\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  feeType: text(\"fee_type\").notNull(), // engagement, monthly, success, transaction, spread\n  amount: integer(\"amount\"), // Fixed amount in dollars (for engagement, monthly)\n  percentage: integer(\"percentage\"), // Percentage x100 (e.g., 250 = 2.5%) for success, transaction, spread\n  currency: text(\"currency\").default('USD'),\n  description: text(\"description\"),\n  billingFrequency: text(\"billing_frequency\"), // one-time, monthly, on-close\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDealFeeSchema = createInsertSchema(dealFees).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDealFee = z.infer<typeof insertDealFeeSchema>;\nexport type DealFee = typeof dealFees.$inferSelect;\n\n// Stage Documents table - documents attached to specific deal stages\nexport const stageDocuments = pgTable(\"stage_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  stage: text(\"stage\").notNull(), // Origination, Structuring, Diligence, Legal, Close\n  documentId: varchar(\"document_id\").references(() => documentsTable.id),\n  title: text(\"title\").notNull(),\n  filename: text(\"filename\"),\n  url: text(\"url\"),\n  mimeType: text(\"mime_type\"),\n  size: integer(\"size\"),\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  uploaderName: text(\"uploader_name\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertStageDocumentSchema = createInsertSchema(stageDocuments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertStageDocument = z.infer<typeof insertStageDocumentSchema>;\nexport type StageDocument = typeof stageDocuments.$inferSelect;\n\n// Stage Pod Members table - pod team assignments per deal stage (leader may change)\nexport const stagePodMembers = pgTable(\"stage_pod_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  stage: text(\"stage\").notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  userName: text(\"user_name\").notNull(),\n  role: text(\"role\").notNull(), // Lead, Analyst, Associate, Director, etc.\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  isLead: boolean(\"is_lead\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertStagePodMemberSchema = createInsertSchema(stagePodMembers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertStagePodMember = z.infer<typeof insertStagePodMemberSchema>;\nexport type StagePodMember = typeof stagePodMembers.$inferSelect;\n\n// Stage Voice Notes table - voice recordings attached to stages\nexport const stageVoiceNotes = pgTable(\"stage_voice_notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  stage: text(\"stage\").notNull(),\n  title: text(\"title\").notNull(),\n  filename: text(\"filename\").notNull(),\n  url: text(\"url\"),\n  duration: integer(\"duration\"), // in seconds\n  transcript: text(\"transcript\"),\n  recordedBy: varchar(\"recorded_by\").references(() => users.id),\n  recorderName: text(\"recorder_name\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertStageVoiceNoteSchema = createInsertSchema(stageVoiceNotes).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertStageVoiceNote = z.infer<typeof insertStageVoiceNoteSchema>;\nexport type StageVoiceNote = typeof stageVoiceNotes.$inferSelect;\n\n// Task Comments table - comments on tasks for discussion\nexport const taskComments = pgTable(\"task_comments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  taskId: varchar(\"task_id\").references(() => tasks.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  userName: text(\"user_name\").notNull(),\n  userAvatar: text(\"user_avatar\"),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTaskCommentSchema = createInsertSchema(taskComments).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTaskComment = z.infer<typeof insertTaskCommentSchema>;\nexport type TaskComment = typeof taskComments.$inferSelect;\n\n// Deal Notes table - comments/notes on deals for discussion\nexport const dealNotes = pgTable(\"deal_notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  userName: text(\"user_name\").notNull(),\n  userAvatar: text(\"user_avatar\"),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDealNoteSchema = createInsertSchema(dealNotes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertDealNote = z.infer<typeof insertDealNoteSchema>;\nexport type DealNote = typeof dealNotes.$inferSelect;\n\n// Custom Sectors table - user-defined sectors for deals\nexport const customSectors = pgTable(\"custom_sectors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertCustomSectorSchema = createInsertSchema(customSectors).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCustomSector = z.infer<typeof insertCustomSectorSchema>;\nexport type CustomSector = typeof customSectors.$inferSelect;\n\n// Google Calendar Tokens table - per-user OAuth tokens for Google Calendar\nexport const googleCalendarTokens = pgTable(\"google_calendar_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull().unique(),\n  accessToken: text(\"access_token\").notNull(),\n  refreshToken: text(\"refresh_token\"),\n  expiresAt: timestamp(\"expires_at\"),\n  scope: text(\"scope\"),\n  tokenType: text(\"token_type\").default('Bearer'),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertGoogleCalendarTokenSchema = createInsertSchema(googleCalendarTokens).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertGoogleCalendarToken = z.infer<typeof insertGoogleCalendarTokenSchema>;\nexport type GoogleCalendarToken = typeof googleCalendarTokens.$inferSelect;\n\n// Form Field Type - includes new types for tables and rich content\nexport type FormFieldType = 'text' | 'email' | 'single_select' | 'multi_select' | 'date' | 'number' | 'attachment' | 'heading' | 'textarea' | 'table' | 'content';\n\nexport type FormFieldOption = {\n  id: string;\n  label: string;\n};\n\n// Branching condition - show field when another field has specific value\nexport type FormBranchCondition = {\n  fieldId: string;       // The field to check\n  operator: 'equals' | 'not_equals' | 'contains';\n  value: string;         // The value to match\n};\n\n// Table cell for static table data\nexport type FormTableCell = {\n  value: string;\n};\n\n// Table column definition\nexport type FormTableColumn = {\n  id: string;\n  header: string;\n};\n\n// Content block for rich text (markdown-like)\nexport type FormContentBlock = {\n  type: 'paragraph' | 'heading' | 'list' | 'link';\n  text?: string;\n  items?: string[];      // For list type\n  url?: string;          // For link type\n  linkText?: string;     // For link type\n};\n\nexport type FormField = {\n  id: string;\n  type: FormFieldType;\n  label: string;\n  description?: string;            // Help text below label\n  placeholder?: string;            // Placeholder text for input fields\n  required: boolean;\n  options?: FormFieldOption[];     // For single_select and multi_select\n  order: number;\n  // Branching support\n  showWhen?: FormBranchCondition;  // Only show this field when condition is met\n  branchFields?: FormField[];      // Nested fields to show based on this field's value (legacy)\n  // Table support\n  tableColumns?: FormTableColumn[];  // Column definitions for table type\n  tableRows?: FormTableCell[][];     // Row data for table type\n  // Rich content support\n  contentBlocks?: FormContentBlock[];  // For content type\n};\n\n// Forms table - stores form definitions\nexport const forms = pgTable(\"forms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  coverImage: text(\"cover_image\"),\n  fields: jsonb(\"fields\").default([]).$type<FormField[]>(),\n  createdBy: varchar(\"created_by\").references(() => users.id).notNull(),\n  shareToken: text(\"share_token\").unique(), // Unique token for public access\n  status: text(\"status\").notNull().default('draft'), // draft, published\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertFormSchema = createInsertSchema(forms).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertForm = z.infer<typeof insertFormSchema>;\nexport type Form = typeof forms.$inferSelect;\n\n// Form Submission Response type\nexport type FormSubmissionResponse = {\n  fieldId: string;\n  fieldLabel: string;\n  fieldType: FormFieldType;\n  value: string | string[] | null; // string for most, array for multi_select\n};\n\n// Form Submissions table - stores submitted form responses\nexport const formSubmissions = pgTable(\"form_submissions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  formId: varchar(\"form_id\").references(() => forms.id).notNull(),\n  formTitle: text(\"form_title\").notNull(), // Snapshot of form title at submission time\n  submitterName: text(\"submitter_name\"),\n  submitterEmail: text(\"submitter_email\"),\n  submitterId: varchar(\"submitter_id\").references(() => users.id), // If submitter is a platform user\n  responses: jsonb(\"responses\").default([]).$type<FormSubmissionResponse[]>(),\n  taskId: varchar(\"task_id\").references(() => tasks.id), // Created task for Dimitra\n  status: text(\"status\").notNull().default('pending'), // pending, reviewed, completed\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertFormSubmissionSchema = createInsertSchema(formSubmissions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertFormSubmission = z.infer<typeof insertFormSubmissionSchema>;\nexport type FormSubmission = typeof formSubmissions.$inferSelect;\n\n// Form Invitations table - tracks who forms are shared with\nexport const formInvitations = pgTable(\"form_invitations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  formId: varchar(\"form_id\").references(() => forms.id).notNull(),\n  email: text(\"email\").notNull(),\n  userId: varchar(\"user_id\").references(() => users.id), // If invitee is a platform user\n  message: text(\"message\"), // Custom message for the invitation\n  status: text(\"status\").notNull().default('pending'), // pending, completed\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertFormInvitationSchema = createInsertSchema(formInvitations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertFormInvitation = z.infer<typeof insertFormInvitationSchema>;\nexport type FormInvitation = typeof formInvitations.$inferSelect;\n\n// Pending form upload tokens - tracks presigned uploads for cleanup\nexport const pendingFormUploads = pgTable(\"pending_form_uploads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  shareToken: text(\"share_token\").notNull(),\n  objectPath: text(\"object_path\").notNull(),\n  filename: text(\"filename\").notNull(),\n  maxSize: integer(\"max_size\").notNull().default(10485760), // 10MB default\n  confirmedAt: timestamp(\"confirmed_at\"),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPendingFormUploadSchema = createInsertSchema(pendingFormUploads).omit({\n  id: true,\n  createdAt: true,\n  confirmedAt: true,\n});\n\nexport type InsertPendingFormUpload = z.infer<typeof insertPendingFormUploadSchema>;\nexport type PendingFormUpload = typeof pendingFormUploads.$inferSelect;\n\n// ================================\n// HR Task Templates\n// ================================\n\n// Template Task type - defines tasks within a section\nexport type TemplateTask = {\n  id: string;\n  title: string;\n  description?: string;\n  assigneeId?: string; // User ID for default assignee\n  relativeDueDays?: number; // Days after template application\n  position: number;\n};\n\n// Template Section type - groups tasks\nexport type TemplateSection = {\n  id: string;\n  title: string;\n  position: number;\n  tasks: TemplateTask[];\n};\n\n// Task Templates table - reusable task templates for HR\nexport const taskTemplates = pgTable(\"task_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  category: text(\"category\").notNull().default('HR'), // HR, Onboarding, General\n  sections: jsonb(\"sections\").default([]).$type<TemplateSection[]>(),\n  isArchived: boolean(\"is_archived\").default(false),\n  usageCount: integer(\"usage_count\").default(0),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTaskTemplateSchema = createInsertSchema(taskTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  usageCount: true,\n});\n\nexport type InsertTaskTemplate = z.infer<typeof insertTaskTemplateSchema>;\nexport type TaskTemplate = typeof taskTemplates.$inferSelect;\n\n// Task Template Usage Log - tracks when templates are applied\nexport const taskTemplateUsage = pgTable(\"task_template_usage\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  templateId: varchar(\"template_id\").references(() => taskTemplates.id).notNull(),\n  templateName: text(\"template_name\").notNull(), // Snapshot at time of use\n  appliedBy: varchar(\"applied_by\").references(() => users.id).notNull(),\n  contextType: text(\"context_type\"), // e.g., 'onboarding', 'project'\n  contextName: text(\"context_name\"), // e.g., 'New Hire: John Smith'\n  tasksCreated: integer(\"tasks_created\").default(0),\n  startDate: text(\"start_date\").notNull(), // ISO date string for due date calculation\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertTaskTemplateUsageSchema = createInsertSchema(taskTemplateUsage).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTaskTemplateUsage = z.infer<typeof insertTaskTemplateUsageSchema>;\nexport type TaskTemplateUsage = typeof taskTemplateUsage.$inferSelect;\n\n// ================================\n// PERSONALITY ASSESSMENT SYSTEM\n// ================================\n\n// Personality Profile types - the 16 personality archetypes (canonical Equiturn tags)\nexport const PERSONALITY_PROFILES = [\n  'Politician', 'Rainmaker', 'Mayor', 'Creative', 'Deal Junkie', 'Closer',\n  'Grandmaster', 'Architect', 'Guru', 'Sherpa', 'Firefighter', 'Legal',\n  'Liaison', 'Auditor', 'Regulatory', 'Misfit'\n] as const;\n\nexport type PersonalityProfileType = typeof PERSONALITY_PROFILES[number];\n\n// Individual personality score\nexport type PersonalityScore = {\n  profile: string;\n  score: number;\n};\n\n// AI-generated deployment profile structure\nexport type DeploymentTags = {\n  dealTeamStatus: string;\n  primaryVertical: string;\n  secondaryVertical: string;\n  primaryDealPhase: string;\n  secondaryDealPhase: string;\n  topFiveArchetypes: string[];\n  riskFlag: string | null;\n};\n\nexport type AIAnalysis = {\n  employeeSnapshot: string;\n  scoreDistribution: string;\n  primaryArchetype: string;\n  secondaryTraits: string;\n  supportingTraits: string;\n  lowSignalTags: string;\n  absentTraits: string;\n  dealPhaseFit: string;\n  dealTypeProficiency: string;\n  managerialNotes: string;\n  deploymentTags: DeploymentTags;\n  rawResponse: string; // Full AI response for reference\n};\n\n// Personality Assessment Responses table - stores user's questionnaire answers and AI analysis\nexport const personalityAssessments = pgTable(\"personality_assessments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  answers: jsonb(\"answers\").notNull().$type<Record<number, 'A' | 'B'>>(), // Question number -> answer\n  allScores: jsonb(\"all_scores\").default([]).$type<PersonalityScore[]>(), // All profile scores (raw calculation)\n  topThreeProfiles: jsonb(\"top_three_profiles\").default([]).$type<PersonalityScore[]>(), // Top 3 profiles\n  aiAnalysis: jsonb(\"ai_analysis\").$type<AIAnalysis | null>(), // Full AI-generated deployment profile\n  status: text(\"status\").notNull().default('pending'), // pending, analyzing, completed, failed\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPersonalityAssessmentSchema = createInsertSchema(personalityAssessments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPersonalityAssessment = z.infer<typeof insertPersonalityAssessmentSchema>;\nexport type PersonalityAssessment = typeof personalityAssessments.$inferSelect;\n\n// Resume Analysis types for onboarding placement\nexport type OnboardingPlacement = {\n  assignedDealTeam: string;\n  primaryVertical: string;\n  secondaryVertical: string;\n  primaryDealPhase: string;\n  secondaryDealPhase: string;\n  initialSeatRecommendation: string;\n  topFiveInferredTags: string[];\n  coverageGaps: string;\n};\n\nexport type ResumeAIAnalysis = {\n  candidateSnapshot: string;\n  evidenceAnchors: string;\n  transactionProfile: string;\n  roleElevationAutonomy: string;\n  dealPhaseFit: string;\n  dealTypeProficiency: string;\n  resumeInferredTags: string;\n  managerialNotes: string;\n  onboardingPlacement: OnboardingPlacement;\n  rawResponse: string;\n};\n\n// Resume Analysis table - stores AI-analyzed resume for Deal Team placement\nexport const resumeAnalyses = pgTable(\"resume_analyses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  fileName: text(\"file_name\").notNull(),\n  fileContent: text(\"file_content\"), // Extracted text content from resume\n  aiAnalysis: jsonb(\"ai_analysis\").$type<ResumeAIAnalysis | null>(),\n  assignedDealTeam: text(\"assigned_deal_team\"), // Extracted for quick access\n  status: text(\"status\").notNull().default('pending'), // pending, analyzing, completed, failed\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertResumeAnalysisSchema = createInsertSchema(resumeAnalyses).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertResumeAnalysis = z.infer<typeof insertResumeAnalysisSchema>;\nexport type ResumeAnalysis = typeof resumeAnalyses.$inferSelect;\n\n// ================================\n// AUTOMATED DEAL PIPELINE SYSTEM\n// ================================\n\n// Deal stages for pod formation\nexport const DEAL_STAGES = [\n  'Origination', 'Structuring', 'Execution', 'Closing', 'Integration'\n] as const;\n\nexport type DealStageType = typeof DEAL_STAGES[number];\n\n// Pod roles based on deal size\nexport const POD_ROLES_LARGE = ['Pod Lead', 'Origination Lead', 'Structuring Lead', 'Execution Lead', 'Closing Lead'] as const;\nexport const POD_ROLES_SMALL = ['Pod Lead', 'Structuring Lead', 'Execution Lead'] as const;\n\n// Deal Pods table - tracks pod teams per deal and stage\nexport const dealPods = pgTable(\"deal_pods\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  stage: text(\"stage\").notNull(), // Current stage this pod was formed for\n  podSize: integer(\"pod_size\").notNull(), // 3 or 5 based on deal value\n  leadUserId: varchar(\"lead_user_id\").references(() => users.id), // Pod lead stays constant\n  aiFormationRationale: text(\"ai_formation_rationale\"), // Why AI chose this team\n  aiRawResponse: text(\"ai_raw_response\"), // Full AI response for reference\n  status: text(\"status\").notNull().default('active'), // active, completed, disbanded\n  formedAt: timestamp(\"formed_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDealPodSchema = createInsertSchema(dealPods).omit({\n  id: true,\n  createdAt: true,\n  formedAt: true,\n});\n\nexport type InsertDealPod = z.infer<typeof insertDealPodSchema>;\nexport type DealPod = typeof dealPods.$inferSelect;\n\n// Pod Members table - individual pod member assignments\nexport const podMembers = pgTable(\"pod_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  podId: varchar(\"pod_id\").references(() => dealPods.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  role: text(\"role\").notNull(), // Pod Lead, Origination Lead, Structuring Lead, etc.\n  position: integer(\"position\").notNull(), // 1-5 based on hierarchy\n  dealTeamStatus: text(\"deal_team_status\"), // User's Deal Team at time of assignment\n  requiredTags: jsonb(\"required_tags\").default([]).$type<string[]>(), // Tags required for this role\n  matchedTags: jsonb(\"matched_tags\").default([]).$type<string[]>(), // User's matching tags\n  assignmentRationale: text(\"assignment_rationale\"), // Why AI chose this person\n  isLead: boolean(\"is_lead\").default(false),\n  assignedAt: timestamp(\"assigned_at\").defaultNow(),\n});\n\nexport const insertPodMemberSchema = createInsertSchema(podMembers).omit({\n  id: true,\n  assignedAt: true,\n});\n\nexport type InsertPodMember = z.infer<typeof insertPodMemberSchema>;\nexport type PodMember = typeof podMembers.$inferSelect;\n\n// Deal Milestones table - phase milestones for deals\nexport const dealMilestones = pgTable(\"deal_milestones\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  podId: varchar(\"pod_id\").references(() => dealPods.id),\n  stage: text(\"stage\").notNull(), // Which deal stage this milestone belongs to\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  orderIndex: integer(\"order_index\").notNull().default(0),\n  isCompleted: boolean(\"is_completed\").default(false),\n  completedAt: timestamp(\"completed_at\"),\n  completedBy: varchar(\"completed_by\").references(() => users.id),\n  dueDate: text(\"due_date\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDealMilestoneSchema = createInsertSchema(dealMilestones).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDealMilestone = z.infer<typeof insertDealMilestoneSchema>;\nexport type DealMilestone = typeof dealMilestones.$inferSelect;\n\n// Pod Movement Tasks table - tasks that complete milestones\nexport const podMovementTasks = pgTable(\"pod_movement_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  milestoneId: varchar(\"milestone_id\").references(() => dealMilestones.id),\n  podId: varchar(\"pod_id\").references(() => dealPods.id),\n  title: text(\"title\").notNull(),\n  ownerRole: text(\"owner_role\"), // Which pod role owns this task\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  dependencies: jsonb(\"dependencies\").default([]).$type<string[]>(), // IDs of dependent tasks\n  definitionOfDone: text(\"definition_of_done\"),\n  qualityGates: text(\"quality_gates\"),\n  escalationTriggers: text(\"escalation_triggers\"),\n  status: text(\"status\").notNull().default('pending'), // pending, in_progress, completed\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPodMovementTaskSchema = createInsertSchema(podMovementTasks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPodMovementTask = z.infer<typeof insertPodMovementTaskSchema>;\nexport type PodMovementTask = typeof podMovementTasks.$inferSelect;\n\n// Deal Context Updates table - tracks all updates/docs for AI learning\nexport const dealContextUpdates = pgTable(\"deal_context_updates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dealId: varchar(\"deal_id\").references(() => deals.id).notNull(),\n  updateType: text(\"update_type\").notNull(), // document, note, status_change, task_complete, communication\n  title: text(\"title\").notNull(),\n  content: text(\"content\"), // Text content for AI ingestion\n  documentId: varchar(\"document_id\"), // Reference to documents table if applicable\n  metadata: jsonb(\"metadata\").default({}), // Additional structured data\n  indexedForAI: boolean(\"indexed_for_ai\").default(false), // Whether AI has processed this\n  indexedAt: timestamp(\"indexed_at\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDealContextUpdateSchema = createInsertSchema(dealContextUpdates).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertDealContextUpdate = z.infer<typeof insertDealContextUpdateSchema>;\nexport type DealContextUpdate = typeof dealContextUpdates.$inferSelect;\n\n// User Workload Snapshot - for tracking capacity\nexport type UserWorkloadSnapshot = {\n  userId: string;\n  userName: string;\n  dealTeamStatus: string;\n  personalityTags: string[];\n  activeTasks: number;\n  pendingTasks: number;\n  completedThisWeek: number;\n  activeDeals: number;\n  capacityScore: number; // 0-100, lower = more available\n  currentStages: { dealId: string; dealName: string; stage: string }[];\n};\n\n// AI Pod Formation Request type\nexport type AIPodFormationRequest = {\n  dealId: string;\n  dealName: string;\n  dealValue: number;\n  dealType: string;\n  sector: string;\n  client: string;\n  stage: string;\n  dealDocuments: { name: string; content: string }[];\n  availableUsers: UserWorkloadSnapshot[];\n  existingPodLeadId?: string; // For stage transitions, keep the same lead\n};\n\n// AI Pod Formation Response type\nexport type AIPodFormationResponse = {\n  podSize: number;\n  podMembers: {\n    position: number;\n    role: string;\n    userId: string | null;\n    userName: string | null;\n    dealTeamStatus: string | null;\n    requiredTags: string[];\n    matchedTags: string[];\n    rationale: string;\n  }[];\n  milestones: {\n    stage: string;\n    title: string;\n    description: string;\n    orderIndex: number;\n  }[];\n  podMovementTasks: {\n    milestoneTitle: string;\n    title: string;\n    ownerRole: string;\n    definitionOfDone: string;\n    qualityGates: string;\n    escalationTriggers: string;\n  }[];\n  dailySubtasks: {\n    parentTaskTitle: string;\n    title: string;\n    assignedRole: string;\n    frequency: 'daily' | 'weekly' | 'monthly';\n  }[];\n  formationRationale: string;\n  dataIntegrityNotes: string;\n};\n\n// Job titles that are NOT eligible for deal work (support roles)\nexport const NON_DEAL_ELIGIBLE_JOB_TITLES = [\n  'AI Engineer',\n  'Head of Human Resources',\n  'HR Manager',\n  'HR Specialist',\n  'Software Engineer',\n  'IT Support',\n  'Office Manager',\n  'Administrative Assistant',\n  'Receptionist',\n];\n\n// Helper function to check if a user is eligible for deal work\nexport function isDealEligibleUser(user: User): boolean {\n  // External users are not eligible\n  if (user.isExternal) return false;\n  \n  // Check if job title is in the non-eligible list (case-insensitive)\n  if (user.jobTitle) {\n    const normalizedJobTitle = user.jobTitle.trim().toLowerCase();\n    const isNonEligible = NON_DEAL_ELIGIBLE_JOB_TITLES.some(\n      title => normalizedJobTitle === title.toLowerCase()\n    );\n    if (isNonEligible) return false;\n  }\n  \n  return true;\n}\n","path":null,"size_bytes":66055,"size_tokens":null},"client/src/pages/ceo/InvestorMatching.tsx":{"content":"import { useState, useCallback, useEffect, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { \n  Check, \n  X, \n  Building2,\n  Target,\n  Mail,\n  Phone,\n  Globe,\n  Heart,\n  Users\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing, useUpdateDeal, useInvestorMatches, useCreateInvestorMatch, useDeleteInvestorMatch, useAllInvestors } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { motion, useMotionValue, useTransform, PanInfo } from \"framer-motion\";\nimport type { TaggedInvestor } from \"@shared/schema\";\nimport { Link } from \"wouter\";\n\ntype InvestorData = {\n  id: string;\n  numericId: number;\n  name: string;\n  type: string;\n  focus: string;\n  checkSize: string;\n  matchScore: number;\n  tags: string[];\n  email: string;\n  phone: string;\n  website: string;\n};\n\nexport default function InvestorMatching() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [], isLoading } = useDealsListing();\n  const { data: investors = [], isLoading: stakeholdersLoading } = useAllInvestors();\n  const updateDeal = useUpdateDeal();\n  \n  const [dealCategory, setDealCategory] = useState<'Investment Banking' | 'Asset Management'>('Investment Banking');\n  const [selectedDeal, setSelectedDeal] = useState<string>('');\n  const [showContactModal, setShowContactModal] = useState<InvestorData | null>(null);\n  const [isAnimating, setIsAnimating] = useState(false);\n  \n  const { data: investorMatches = [] } = useInvestorMatches(selectedDeal || null);\n  const createMatch = useCreateInvestorMatch();\n  const deleteMatch = useDeleteInvestorMatch();\n  \n  const [rejectedInvestors, setRejectedInvestors] = useState<string[]>([]);\n  \n  // Convert investors from Stakeholder Directory to InvestorData format\n  // Uses the stakeholder's focus field for sector matching\n  const INVESTORS: InvestorData[] = useMemo(() => {\n    return investors.map((s, index) => ({\n        id: s.id,\n        numericId: index + 1,\n        name: s.name,\n        type: s.title || 'Investor',\n        focus: s.focus || 'Multi-sector',\n        checkSize: s.notes?.match(/Check size: ([^|,]+)/)?.[1] || 'Flexible',\n        matchScore: s.isFavorite ? 95 : 80,\n        tags: s.notes?.match(/Tags: (.+)/)?.[1]?.split(', ') || [],\n        email: s.email || '',\n        phone: s.phone || '',\n        website: s.website || '',\n      }));\n  }, [investors]);\n  \n  const matchedInvestors = useMemo(() => {\n    const matchedIds = investorMatches\n      .filter(m => m.status === 'matched')\n      .map(m => String(m.investorId));\n    return INVESTORS.filter(inv => matchedIds.includes(inv.id));\n  }, [investorMatches, INVESTORS]);\n  \n  useEffect(() => {\n    if (selectedDeal) {\n      const rejectedIds = investorMatches\n        .filter(m => m.status === 'rejected')\n        .map(m => String(m.investorId));\n      setRejectedInvestors(rejectedIds);\n    } else {\n      setRejectedInvestors([]);\n    }\n  }, [selectedDeal, investorMatches]);\n  \n  const x = useMotionValue(0);\n  const rotate = useTransform(x, [-200, 200], [-25, 25]);\n  const opacity = useTransform(x, [-200, -100, 0, 100, 200], [0.5, 1, 1, 1, 0.5]);\n  const likeOpacity = useTransform(x, [0, 100], [0, 1]);\n  const nopeOpacity = useTransform(x, [-100, 0], [1, 0]);\n  \n  // Filter deals by category (with fallback for missing dealType)\n  const filteredDeals = useMemo(() => {\n    return deals.filter(deal => {\n      const dealType = (deal as any).dealType || 'Investment Banking';\n      if (dealCategory === 'Investment Banking') {\n        // Investment Banking includes M&A, Capital Raising, Debt Financing, IPO, etc.\n        return ['Investment Banking', 'M&A', 'Capital Raising', 'Debt Financing', 'IPO', 'Restructuring', 'Advisory'].includes(dealType);\n      }\n      return dealType === dealCategory;\n    });\n  }, [deals, dealCategory]);\n\n  // Set initial deal once data loads or when deals/category changes\n  useEffect(() => {\n    if (filteredDeals.length > 0) {\n      setSelectedDeal(filteredDeals[0].id);\n    } else {\n      setSelectedDeal('');\n    }\n  }, [filteredDeals.length, dealCategory]);\n\n  const currentDeal = deals.find(d => d.id === selectedDeal);\n  \n  // Get deal sector for matching\n  const dealSector = currentDeal?.sector?.toLowerCase().trim() || '';\n  \n  // Helper function to check if investor's focus matches or is similar to deal sector\n  const calculateSectorMatchScore = (investorFocus: string, dealSector: string): number => {\n    if (!investorFocus || !dealSector) return 0;\n    \n    const investorSectors = investorFocus.toLowerCase().split(',').map(s => s.trim());\n    const dealSectorLower = dealSector.toLowerCase().trim();\n    \n    // Check for exact match\n    if (investorSectors.some(s => s === dealSectorLower)) return 100;\n    \n    // Check for partial/similar matches\n    for (const sector of investorSectors) {\n      // Check if one contains the other\n      if (sector.includes(dealSectorLower) || dealSectorLower.includes(sector)) return 90;\n      \n      // Common sector aliases and related terms\n      const sectorMappings: Record<string, string[]> = {\n        'technology': ['tech', 'software', 'saas', 'it', 'digital', 'ai', 'ml', 'fintech', 'edtech', 'healthtech', 'proptech'],\n        'healthcare': ['health', 'medical', 'pharma', 'biotech', 'medtech', 'life sciences', 'healthtech'],\n        'financial services': ['finance', 'fintech', 'banking', 'insurance', 'insurtech', 'wealth management', 'asset management'],\n        'consumer': ['retail', 'e-commerce', 'ecommerce', 'cpg', 'consumer goods', 'fmcg', 'd2c', 'dtc'],\n        'real estate': ['property', 'proptech', 'reit', 'commercial real estate', 'residential'],\n        'energy': ['cleantech', 'clean energy', 'renewable', 'oil', 'gas', 'utilities', 'power'],\n        'industrials': ['industrial', 'manufacturing', 'logistics', 'supply chain', 'aerospace', 'defense'],\n        'media': ['entertainment', 'gaming', 'streaming', 'advertising', 'publishing', 'content'],\n        'telecommunications': ['telecom', 'communications', 'infrastructure'],\n        'education': ['edtech', 'e-learning', 'training'],\n      };\n      \n      // Find related sectors\n      for (const [key, aliases] of Object.entries(sectorMappings)) {\n        const allTerms = [key, ...aliases];\n        const sectorMatchesGroup = allTerms.some(term => sector.includes(term) || term.includes(sector));\n        const dealMatchesGroup = allTerms.some(term => dealSectorLower.includes(term) || term.includes(dealSectorLower));\n        \n        if (sectorMatchesGroup && dealMatchesGroup) return 80;\n      }\n    }\n    \n    return 0; // No match\n  };\n  \n  // Filter investors: must not be matched/rejected AND must have sector match (exact or similar)\n  const availableInvestors = useMemo(() => {\n    if (!dealSector) return [];\n    \n    return INVESTORS\n      .map(inv => ({\n        ...inv,\n        sectorScore: calculateSectorMatchScore(inv.focus, dealSector),\n        matchScore: calculateSectorMatchScore(inv.focus, dealSector) >= 90 ? 95 : \n                    calculateSectorMatchScore(inv.focus, dealSector) >= 80 ? 85 : 70\n      }))\n      .filter(inv => {\n        const isNotMatched = !matchedInvestors.some(m => m.id === inv.id);\n        const isNotRejected = !rejectedInvestors.includes(inv.id);\n        const sectorMatches = inv.sectorScore >= 80; // 80+ means at least similar\n        \n        return isNotMatched && isNotRejected && sectorMatches;\n      })\n      .sort((a, b) => b.sectorScore - a.sectorScore); // Best matches first\n  }, [dealSector, matchedInvestors, rejectedInvestors, INVESTORS]);\n    \n  const currentInvestor = availableInvestors[0];\n\n  const addInvestorToTaggedList = async (investor: InvestorData) => {\n    if (!selectedDeal) return;\n    \n    const latestDeal = deals.find(d => d.id === selectedDeal);\n    if (!latestDeal) return;\n    \n    const existingTagged = latestDeal.taggedInvestors || [];\n    \n    const alreadyExists = existingTagged.some(\n      (inv) => inv.name === investor.name && inv.firm === investor.name\n    );\n    \n    if (alreadyExists) {\n      return;\n    }\n    \n    const newTaggedInvestor: TaggedInvestor = {\n      id: crypto.randomUUID(),\n      name: investor.name,\n      firm: investor.name,\n      type: investor.type,\n      status: 'Contacted',\n      notes: `Check size: ${investor.checkSize}, Focus: ${investor.focus}`,\n      email: investor.email,\n      phone: investor.phone,\n      website: investor.website,\n    };\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal,\n        taggedInvestors: [...existingTagged, newTaggedInvestor],\n      });\n    } catch (error) {\n      console.error('Failed to add investor to deal:', error);\n    }\n  };\n\n  const handleSwipe = useCallback(async (direction: 'left' | 'right') => {\n    if (!currentInvestor || isAnimating || !selectedDeal) return;\n    \n    setIsAnimating(true);\n    \n    try {\n      if (direction === 'right') {\n        await createMatch.mutateAsync({\n          dealId: selectedDeal,\n          investorId: currentInvestor.id,\n          status: 'matched',\n        });\n        await addInvestorToTaggedList(currentInvestor);\n        toast.success(`Matched with ${currentInvestor.name}! Added to deal.`);\n      } else {\n        await createMatch.mutateAsync({\n          dealId: selectedDeal,\n          investorId: currentInvestor.id,\n          status: 'rejected',\n        });\n        toast.info(`Passed on ${currentInvestor.name}`);\n      }\n    } catch (error) {\n      console.error('Failed to save match:', error);\n      toast.error('Failed to save decision');\n    }\n    \n    x.set(0);\n    setIsAnimating(false);\n  }, [currentInvestor, isAnimating, selectedDeal, createMatch]);\n\n  const handleDragEnd = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    const threshold = 100;\n    if (info.offset.x > threshold) {\n      handleSwipe('right');\n    } else if (info.offset.x < -threshold) {\n      handleSwipe('left');\n    }\n  };\n\n  const handleContact = (investor: typeof INVESTORS[0]) => {\n    setShowContactModal(investor);\n  };\n\n  const handleSendEmail = () => {\n    if (showContactModal) {\n      const dealName = deals.find(d => d.id === selectedDeal)?.name || 'Investment Opportunity';\n      window.open(`mailto:${showContactModal.email}?subject=Investment Opportunity - ${dealName}`);\n      toast.success(\"Opening email client...\");\n      setShowContactModal(null);\n    }\n  };\n\n  const handleCallPhone = () => {\n    if (showContactModal) {\n      window.open(`tel:${showContactModal.phone}`);\n      toast.info(\"Initiating call...\");\n    }\n  };\n\n  const handleVisitWebsite = () => {\n    if (showContactModal) {\n      window.open(`https://${showContactModal.website}`, '_blank');\n      toast.info(\"Opening website...\");\n    }\n  };\n\n  const resetMatches = async () => {\n    if (!selectedDeal) return;\n    try {\n      const res = await fetch(`/api/investor-matches/${selectedDeal}`, { method: 'DELETE' });\n      if (!res.ok) throw new Error('Failed to reset matches');\n      setRejectedInvestors([]);\n      toast.info(\"Matches reset\");\n    } catch (error) {\n      console.error('Failed to reset matches:', error);\n      toast.error(\"Failed to reset matches\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role=\"CEO\" pageTitle=\"Investor Match Deck\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading...</div>\n        </div>\n      </Layout>\n    );\n  }\n  \n  return (\n    <Layout role=\"CEO\" pageTitle=\"Investor Match Deck\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Category and Deal Selector */}\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex gap-4 flex-1\">\n            <div className=\"w-48\">\n              <label className=\"text-xs font-medium text-muted-foreground mb-1.5 block\">Deal Type</label>\n              <select \n                  className=\"w-full bg-card border border-border rounded-md p-2 text-sm focus:ring-1 focus:ring-primary outline-none\"\n                  value={dealCategory}\n                  onChange={(e) => setDealCategory(e.target.value as 'Investment Banking' | 'Asset Management')}\n                  data-testid=\"select-deal-category\"\n              >\n                  <option value=\"Investment Banking\">Investment Banking</option>\n                  <option value=\"Asset Management\">Asset Management</option>\n              </select>\n            </div>\n            <div className=\"flex-1 max-w-md\">\n              <label className=\"text-xs font-medium text-muted-foreground mb-1.5 block\">Select Deal to Match</label>\n              <select \n                  className=\"w-full bg-card border border-border rounded-md p-2 text-sm focus:ring-1 focus:ring-primary outline-none\"\n                  value={selectedDeal}\n                  onChange={(e) => setSelectedDeal(e.target.value)}\n                  data-testid=\"select-deal\"\n              >\n                  {filteredDeals.length === 0 && (\n                    <option value=\"\">No {dealCategory} deals available</option>\n                  )}\n                  {filteredDeals.map(deal => (\n                      <option key={deal.id} value={deal.id}>{deal.name} - ${deal.value}M ({deal.sector})</option>\n                  ))}\n              </select>\n            </div>\n          </div>\n          <Button variant=\"outline\" size=\"sm\" onClick={resetMatches}>\n            Reset All\n          </Button>\n        </div>\n\n        {/* Tinder-style Match Interface */}\n        <div className=\"flex flex-col items-center justify-center py-6\">\n            {currentInvestor ? (\n              <div className=\"relative w-full max-w-lg aspect-[3/4] md:aspect-[4/3]\">\n                  {/* Background cards for stack effect */}\n                  {availableInvestors.length > 2 && (\n                    <motion.div \n                      className=\"absolute top-4 left-4 right-4 bottom-[-16px] bg-card/30 rounded-2xl border border-border z-0\"\n                      initial={{ scale: 0.92 }}\n                      animate={{ scale: 0.95 }}\n                      transition={{ duration: 0.3 }}\n                    />\n                  )}\n                  {availableInvestors.length > 1 && (\n                    <motion.div \n                      className=\"absolute top-2 left-2 right-2 bottom-[-8px] bg-card/60 rounded-2xl border border-border z-10\"\n                      initial={{ scale: 0.95 }}\n                      animate={{ scale: 0.98 }}\n                      transition={{ duration: 0.3 }}\n                    />\n                  )}\n                  \n                  {/* Main Draggable Card */}\n                  <motion.div\n                    className=\"absolute inset-0 z-20 cursor-grab active:cursor-grabbing\"\n                    drag=\"x\"\n                    dragConstraints={{ left: 0, right: 0 }}\n                    dragElastic={0.7}\n                    onDragEnd={handleDragEnd}\n                    style={{ x, rotate, opacity }}\n                    whileTap={{ scale: 1.02 }}\n                    data-testid=\"swipe-card\"\n                  >\n                    {/* Like/Nope Indicators */}\n                    <motion.div \n                      className=\"absolute top-8 right-8 z-30 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-xl rotate-12 border-4 border-green-400\"\n                      style={{ opacity: likeOpacity }}\n                    >\n                      <Heart className=\"w-6 h-6 inline mr-2\" />\n                      MATCH\n                    </motion.div>\n                    <motion.div \n                      className=\"absolute top-8 left-8 z-30 bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-xl -rotate-12 border-4 border-red-400\"\n                      style={{ opacity: nopeOpacity }}\n                    >\n                      PASS\n                    </motion.div>\n                    \n                    <Card className=\"h-full bg-card border-border shadow-2xl flex flex-col items-center justify-center text-center p-8 hover:shadow-primary/10 transition-all\">\n                      <div className=\"w-24 h-24 rounded-full bg-secondary flex items-center justify-center mb-6 shadow-inner\">\n                          <Building2 className=\"w-10 h-10 text-primary\" />\n                      </div>\n                      \n                      <h2 className=\"text-3xl font-display font-bold mb-2\">{currentInvestor.name}</h2>\n                      <Badge variant=\"secondary\" className=\"mb-4\">{currentInvestor.type}</Badge>\n                      \n                      <div className=\"grid grid-cols-2 gap-4 w-full max-w-xs mb-6\">\n                          <div className=\"text-center\">\n                              <div className=\"text-xs text-muted-foreground uppercase tracking-wider mb-1\">Focus</div>\n                              <div className=\"font-medium text-sm line-clamp-2 max-h-10 overflow-hidden\" title={currentInvestor.focus}>\n                                {currentInvestor.focus.split(',').slice(0, 3).join(', ')}{currentInvestor.focus.split(',').length > 3 ? '...' : ''}\n                              </div>\n                          </div>\n                          <div className=\"text-center\">\n                              <div className=\"text-xs text-muted-foreground uppercase tracking-wider mb-1\">Check Size</div>\n                              <div className=\"font-medium text-sm\">{currentInvestor.checkSize}</div>\n                          </div>\n                      </div>\n\n                      <div className=\"flex gap-2 mb-8\">\n                          {currentInvestor.tags.map(tag => (\n                              <Badge key={tag} variant=\"outline\" className=\"bg-secondary/30\">{tag}</Badge>\n                          ))}\n                      </div>\n\n                      <div className=\"w-full bg-secondary/30 rounded-full h-12 flex items-center px-4 mb-6 relative overflow-hidden\">\n                           <div \n                             className={cn(\n                               \"absolute left-0 top-0 h-full border-r-2\",\n                               currentInvestor.matchScore >= 90 ? \"bg-green-500/10 border-green-500\" :\n                               currentInvestor.matchScore >= 80 ? \"bg-yellow-500/10 border-yellow-500\" :\n                               \"bg-orange-500/10 border-orange-500\"\n                             )} \n                             style={{ width: `${currentInvestor.matchScore}%` }}\n                           ></div>\n                           <div className=\"relative z-10 flex justify-between w-full items-center\">\n                              <span className={cn(\n                                \"text-xs font-bold\",\n                                currentInvestor.matchScore >= 90 ? \"text-green-500\" :\n                                currentInvestor.matchScore >= 80 ? \"text-yellow-500\" :\n                                \"text-orange-500\"\n                              )}>\n                                {currentInvestor.matchScore}% MATCH SCORE\n                              </span>\n                              <Target className={cn(\n                                \"w-4 h-4\",\n                                currentInvestor.matchScore >= 90 ? \"text-green-500\" :\n                                currentInvestor.matchScore >= 80 ? \"text-yellow-500\" :\n                                \"text-orange-500\"\n                              )} />\n                           </div>\n                      </div>\n\n                      <p className=\"text-xs text-muted-foreground mb-4\">Drag card to swipe or use buttons below</p>\n\n                      <div className=\"flex items-center gap-8 w-full max-w-xs mt-auto\">\n                          <Button \n                            size=\"lg\" \n                            variant=\"outline\" \n                            className=\"flex-1 rounded-full h-14 border-2 border-red-500/20 text-red-500 hover:bg-red-500/10 hover:border-red-500\"\n                            onClick={() => handleSwipe('left')}\n                            disabled={isAnimating}\n                            data-testid=\"button-reject\"\n                          >\n                              <X className=\"w-6 h-6\" />\n                          </Button>\n                          <Button \n                            size=\"lg\" \n                            className=\"flex-1 rounded-full h-14 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/20\"\n                            onClick={() => handleSwipe('right')}\n                            disabled={isAnimating}\n                            data-testid=\"button-approve\"\n                          >\n                              <Check className=\"w-6 h-6\" />\n                          </Button>\n                      </div>\n                      \n                      <div className=\"flex justify-between w-full max-w-xs mt-4 text-[10px] text-muted-foreground uppercase tracking-widest\">\n                          <span>Pass</span>\n                          <span>Match</span>\n                      </div>\n                    </Card>\n                  </motion.div>\n              </div>\n            ) : (\n              <Card className=\"w-full max-w-lg p-12 text-center\">\n                {/* Check if there are ANY investors with matching sector (before filtering by matched/rejected) */}\n                {dealSector && INVESTORS.some(inv => calculateSectorMatchScore(inv.focus, dealSector) >= 80) ? (\n                  <>\n                    <div className=\"w-16 h-16 rounded-full bg-secondary flex items-center justify-center mx-auto mb-4\">\n                      <Check className=\"w-8 h-8 text-green-500\" />\n                    </div>\n                    <h3 className=\"text-xl font-bold mb-2\">All Caught Up!</h3>\n                    <p className=\"text-muted-foreground mb-4\">You've reviewed all available investors for this deal.</p>\n                    <Button onClick={resetMatches}>Review Again</Button>\n                  </>\n                ) : INVESTORS.length === 0 ? (\n                  <>\n                    <div className=\"w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto mb-4\">\n                      <Users className=\"w-8 h-8 text-blue-500\" />\n                    </div>\n                    <h3 className=\"text-xl font-bold mb-2\">No Investors Yet</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      Add investors to your Stakeholder Directory to start matching them with deals.\n                    </p>\n                  </>\n                ) : (\n                  <>\n                    <div className=\"w-16 h-16 rounded-full bg-orange-500/20 flex items-center justify-center mx-auto mb-4\">\n                      <Target className=\"w-8 h-8 text-orange-500\" />\n                    </div>\n                    <h3 className=\"text-xl font-bold mb-2\">No Matching Investors Found</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      No investors in your Stakeholder Directory match or are similar to the <span className=\"font-medium text-foreground\">{currentDeal?.sector}</span> sector.\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Try selecting a different deal, or ensure investors in your directory have relevant sector focus defined.\n                    </p>\n                  </>\n                )}\n              </Card>\n            )}\n        </div>\n        \n        {/* Matched List */}\n        <Card className=\"bg-card border-border mt-8\">\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n                <CardTitle className=\"text-lg\">Matched Investors ({matchedInvestors.length})</CardTitle>\n                {matchedInvestors.length > 0 && (\n                  <Badge variant=\"secondary\">{matchedInvestors.length} matches</Badge>\n                )}\n            </CardHeader>\n            <CardContent>\n                {matchedInvestors.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    No matches yet. Swipe right on investors you want to connect with.\n                  </div>\n                ) : (\n                  <div className=\"space-y-2\">\n                      {matchedInvestors.map(inv => (\n                          <div key={inv.id} className=\"flex items-center justify-between p-3 rounded-lg border border-border/50 bg-secondary/10 hover:bg-secondary/20 transition-colors\">\n                              <div className=\"flex items-center gap-4\">\n                                  <div className=\"w-10 h-10 rounded bg-primary/10 flex items-center justify-center font-bold text-primary\">\n                                      {inv.name[0]}\n                                  </div>\n                                  <div>\n                                      <div className=\"font-medium\">{inv.name}</div>\n                                      <div className=\"text-xs text-muted-foreground\">{inv.type}  {inv.focus}</div>\n                                  </div>\n                              </div>\n                              <div className=\"flex items-center gap-4\">\n                                  <Badge className=\"bg-green-500/10 text-green-500 border-green-500/20\">{inv.matchScore}% Match</Badge>\n                                  <Button \n                                    size=\"sm\" \n                                    variant=\"outline\"\n                                    onClick={() => handleContact(inv)}\n                                    data-testid={`button-contact-${inv.id}`}\n                                  >\n                                    Contact\n                                  </Button>\n                              </div>\n                          </div>\n                      ))}\n                  </div>\n                )}\n            </CardContent>\n        </Card>\n      </div>\n\n      {/* Contact Modal */}\n      <Dialog open={!!showContactModal} onOpenChange={() => setShowContactModal(null)}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Contact {showContactModal?.name}</DialogTitle>\n          </DialogHeader>\n          {showContactModal && (\n            <div className=\"space-y-4 py-4\">\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleSendEmail}\n                data-testid=\"button-contact-email\"\n              >\n                <Mail className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Email</div>\n                  <div className=\"font-medium truncate\">{showContactModal.email}</div>\n                </div>\n              </button>\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleCallPhone}\n                data-testid=\"button-contact-phone\"\n              >\n                <Phone className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Phone</div>\n                  <div className=\"font-medium\">{showContactModal.phone}</div>\n                </div>\n              </button>\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleVisitWebsite}\n                data-testid=\"button-contact-website\"\n              >\n                <Globe className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Website</div>\n                  <div className=\"font-medium\">{showContactModal.website}</div>\n                </div>\n              </button>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowContactModal(null)}>Close</Button>\n            <Button onClick={handleSendEmail}>\n              <Mail className=\"w-4 h-4 mr-2\" /> Send Email\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n    </Layout>\n  );\n}\n","path":null,"size_bytes":29027,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":768,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-primary/10\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":266,"size_tokens":null},"client/src/components/ui/empty.tsx":{"content":"import { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Empty({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty\"\n      className={cn(\n        \"flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-header\"\n      className={cn(\n        \"flex max-w-sm flex-col items-center gap-2 text-center\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst emptyMediaVariants = cva(\n  \"mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction EmptyMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof emptyMediaVariants>) {\n  return (\n    <div\n      data-slot=\"empty-icon\"\n      data-variant={variant}\n      className={cn(emptyMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-title\"\n      className={cn(\"text-lg font-medium tracking-tight\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <div\n      data-slot=\"empty-description\"\n      className={cn(\n        \"text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-content\"\n      className={cn(\n        \"flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Empty,\n  EmptyHeader,\n  EmptyTitle,\n  EmptyDescription,\n  EmptyContent,\n  EmptyMedia,\n}\n","path":null,"size_bytes":2396,"size_tokens":null},"client/src/pages/ceo/TeamAssignment.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useSearch } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle, AlertDialogDescription, AlertDialogFooter, AlertDialogCancel, AlertDialogAction } from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  Search, \n  Filter, \n  Users, \n  MoreHorizontal,\n  Calendar,\n  UserPlus,\n  CheckCircle,\n  Clock,\n  Paperclip,\n  X,\n  FileText,\n  Loader2,\n  Upload\n} from \"lucide-react\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useCurrentUser, useUsers, useDealsListing, useTasks, useCreateTask, useCreateTaskAttachment, useUpdateDeal, useOnboardingStatus } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport type { Deal, User } from \"@shared/schema\";\nimport { isDealEligibleUser } from \"@shared/schema\";\n\ntype PodTeamMember = {\n  name: string;\n  role: string;\n  userId?: string;\n};\n\ntype UploadedFile = {\n  id: string;\n  filename: string;\n  url: string;\n  size: number;\n  type: string;\n  uploadedAt: string;\n};\n\nexport default function TeamAssignment() {\n  const searchString = useSearch();\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [], isLoading: usersLoading } = useUsers();\n  const { data: deals = [], isLoading: dealsLoading } = useDealsListing();\n  const { data: tasks = [] } = useTasks();\n  const createTask = useCreateTask();\n  const createAttachment = useCreateTaskAttachment();\n  const updateDeal = useUpdateDeal();\n  const { data: onboardingStatus = {} } = useOnboardingStatus();\n  const [highlightedUserId, setHighlightedUserId] = useState<string | null>(null);\n  const [showOnboardingWarning, setShowOnboardingWarning] = useState(false);\n  const [pendingAssignment, setPendingAssignment] = useState<{ \n    userId: string; \n    userName: string; \n    missingResume: boolean; \n    missingPersonality: boolean; \n    onConfirm?: () => void \n  } | null>(null);\n  const userRefs = useRef<{ [key: string]: HTMLDivElement | null }>({});\n  const [taskDealId, setTaskDealId] = useState<string | null>(null);\n\n  const [selectedDeal, setSelectedDeal] = useState<string | null>(null);\n  \n  // Handle URL query parameter for highlighting a specific user\n  useEffect(() => {\n    if (searchString && users.length > 0) {\n      const params = new URLSearchParams(searchString);\n      const userId = params.get('id');\n      if (userId) {\n        setHighlightedUserId(userId);\n        setTimeout(() => {\n          const element = userRefs.current[userId];\n          if (element) {\n            element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n          }\n        }, 100);\n        setTimeout(() => setHighlightedUserId(null), 3000);\n      }\n    }\n  }, [searchString, users]);\n  const [filterAvailability, setFilterAvailability] = useState<string | null>(null);\n  const [dealSearchQuery, setDealSearchQuery] = useState(\"\");\n  const [memberSearchQuery, setMemberSearchQuery] = useState(\"\");\n  const [showAssignModal, setShowAssignModal] = useState(false);\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [newTask, setNewTask] = useState({\n    title: '',\n    description: '',\n    priority: 'Medium',\n    type: 'Analysis',\n    dueDate: new Date().toISOString().split('T')[0],\n    dueTime: '',\n  });\n  const [uploadedFiles, setUploadedFiles] = useState<UploadedFile[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [isDragging, setIsDragging] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const getUserTaskCount = (userId: string) => tasks.filter(t => t.assignedTo === userId && t.status !== 'Completed').length;\n  const getUserAvailability = (userId: string) => {\n    const taskCount = getUserTaskCount(userId);\n    if (taskCount === 0) return 'Available';\n    if (taskCount <= 2) return 'Light';\n    return 'Busy';\n  };\n\n  const filteredUsers = users.filter(user => {\n    // Only show active users\n    if (user.status !== 'active') return false;\n    // Only show deal-eligible users (exclude HR, AI Engineer, etc.)\n    if (!isDealEligibleUser(user)) return false;\n    // Filter by availability\n    if (filterAvailability && getUserAvailability(user.id) !== filterAvailability) return false;\n    // Filter by search query\n    if (memberSearchQuery) {\n      const searchLower = memberSearchQuery.toLowerCase();\n      return (\n        user.name.toLowerCase().includes(searchLower) ||\n        (user.email?.toLowerCase() || '').includes(searchLower) ||\n        (user.role?.toLowerCase() || '').includes(searchLower) ||\n        (user.jobTitle?.toLowerCase() || '').includes(searchLower)\n      );\n    }\n    return true;\n  });\n\n  const filteredDeals = deals.filter(deal => {\n    if (!deal.status || deal.status !== 'Active') return false;\n    if (!dealSearchQuery) return true;\n    const searchLower = dealSearchQuery.toLowerCase();\n    return (\n      deal.name.toLowerCase().includes(searchLower) ||\n      (deal.client?.toLowerCase() || '').includes(searchLower) ||\n      (deal.sector?.toLowerCase() || '').includes(searchLower) ||\n      (deal.stage?.toLowerCase() || '').includes(searchLower)\n    );\n  });\n\n  const uploadFiles = async (fileList: FileList | File[]) => {\n    const files = Array.from(fileList);\n    if (files.length === 0) return;\n    \n    setIsUploading(true);\n    \n    try {\n      for (const file of files) {\n        const formData = new FormData();\n        formData.append('file', file);\n        \n        const response = await fetch('/api/upload', {\n          method: 'POST',\n          body: formData,\n        });\n        \n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Failed to upload file');\n        }\n        \n        const uploadedFile: UploadedFile = await response.json();\n        setUploadedFiles(prev => [...prev, uploadedFile]);\n      }\n      toast.success(`${files.length} file(s) uploaded successfully`);\n    } catch (error: any) {\n      toast.error(error.message || 'Failed to upload file');\n    } finally {\n      setIsUploading(false);\n      if (fileInputRef.current) {\n        fileInputRef.current.value = '';\n      }\n    }\n  };\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      await uploadFiles(e.target.files);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n  };\n\n  const handleDrop = async (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n    \n    const files = e.dataTransfer.files;\n    if (files.length > 0) {\n      await uploadFiles(files);\n    }\n  };\n\n  const removeAttachment = async (index: number) => {\n    const file = uploadedFiles[index];\n    if (file) {\n      try {\n        const filename = file.url.replace('/uploads/', '');\n        await fetch(`/api/upload/${filename}`, { method: 'DELETE' });\n      } catch (error) {\n        console.error('Failed to delete file:', error);\n      }\n    }\n    setUploadedFiles(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const handleAssignTask = async () => {\n    if (!selectedUser || !newTask.title) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n    try {\n      const attachmentObjects = uploadedFiles.map(file => ({\n        id: file.id,\n        filename: file.filename,\n        url: file.url,\n        size: file.size,\n        uploadedAt: file.uploadedAt,\n      }));\n\n      // Combine date and time for full datetime\n      const fullDueDate = newTask.dueTime \n        ? `${newTask.dueDate}T${newTask.dueTime}` \n        : newTask.dueDate;\n      \n      const createdTask = await createTask.mutateAsync({\n        title: newTask.title,\n        description: newTask.description || null,\n        dealId: taskDealId || undefined,\n        assignedTo: selectedUser.id,\n        assignedBy: currentUser?.id || null,\n        priority: newTask.priority,\n        type: newTask.type,\n        dueDate: fullDueDate,\n        status: 'Pending',\n        attachments: attachmentObjects.length > 0 ? attachmentObjects : [],\n      });\n      \n      for (const file of uploadedFiles) {\n        await createAttachment.mutateAsync({\n          taskId: createdTask.id,\n          filename: file.url.split('/').pop() || file.filename,\n          originalName: file.filename,\n          mimeType: file.type || null,\n          size: file.size,\n        });\n      }\n      \n      toast.success(`Task assigned to ${selectedUser.name}!`);\n      setShowAssignModal(false);\n      setNewTask({ title: '', description: '', priority: 'Medium', type: 'Analysis', dueDate: new Date().toISOString().split('T')[0], dueTime: '' });\n      setUploadedFiles([]);\n      setSelectedUser(null);\n      setTaskDealId(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to assign task\");\n    }\n  };\n\n  const openAssignModal = (user: User) => {\n    const userOnboarding = onboardingStatus[user.id];\n    const isOnboardingComplete = userOnboarding?.isComplete ?? false;\n    \n    if (!isOnboardingComplete) {\n      setPendingAssignment({\n        userId: user.id,\n        userName: user.name,\n        missingResume: !userOnboarding?.hasResume,\n        missingPersonality: !userOnboarding?.hasPersonality,\n        onConfirm: () => {\n          setSelectedUser(user);\n          setTaskDealId(selectedDeal);\n          setShowAssignModal(true);\n        }\n      });\n      setShowOnboardingWarning(true);\n      return;\n    }\n    \n    setSelectedUser(user);\n    setTaskDealId(selectedDeal);\n    setShowAssignModal(true);\n  };\n\n  const isUserInDealTeam = (userId: string, dealId: string) => {\n    const deal = deals.find(d => d.id === dealId);\n    if (!deal) return false;\n    const podTeam = (deal.podTeam as PodTeamMember[]) || [];\n    return podTeam.some(m => m.userId === userId);\n  };\n\n  const performAddToTeam = async (user: User) => {\n    if (!selectedDeal) {\n      toast.error(\"Please select a deal first\");\n      return;\n    }\n    const deal = deals.find(d => d.id === selectedDeal);\n    if (!deal) return;\n    \n    const currentPodTeam = (deal.podTeam as PodTeamMember[]) || [];\n    if (currentPodTeam.some(m => m.userId === user.id)) {\n      toast.info(`${user.name} is already on this deal team`);\n      return;\n    }\n    \n    const newMember: PodTeamMember = {\n      name: user.name,\n      role: user.jobTitle || user.role,\n      userId: user.id,\n    };\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: deal.id,\n        podTeam: [...currentPodTeam, newMember],\n      });\n      toast.success(`${user.name} added to ${deal.name} team`);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add team member\");\n    }\n  };\n\n  const handleAddToTeam = (user: User) => {\n    const userOnboarding = onboardingStatus[user.id];\n    const isOnboardingComplete = userOnboarding?.isComplete ?? false;\n    \n    if (!isOnboardingComplete) {\n      setPendingAssignment({\n        userId: user.id,\n        userName: user.name,\n        missingResume: !userOnboarding?.hasResume,\n        missingPersonality: !userOnboarding?.hasPersonality,\n        onConfirm: () => performAddToTeam(user)\n      });\n      setShowOnboardingWarning(true);\n      return;\n    }\n    \n    performAddToTeam(user);\n  };\n\n  const handleRemoveFromTeam = async (user: User) => {\n    if (!selectedDeal) return;\n    const deal = deals.find(d => d.id === selectedDeal);\n    if (!deal) return;\n    \n    const currentPodTeam = (deal.podTeam as PodTeamMember[]) || [];\n    const updatedTeam = currentPodTeam.filter(m => m.userId !== user.id);\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: deal.id,\n        podTeam: updatedTeam,\n      });\n      toast.success(`${user.name} removed from ${deal.name} team`);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove team member\");\n    }\n  };\n\n\n  if (usersLoading || dealsLoading) {\n    return (\n      <Layout role=\"CEO\" pageTitle=\"Team Assignment\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading team data...</div>\n        </div>\n      </Layout>\n    );\n  }\n\n  const currentDeal = deals.find(d => d.id === selectedDeal);\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Team Assignment\" userName={currentUser?.name || \"\"}>\n      <div className=\"grid grid-cols-12 gap-6 h-[calc(100vh-8rem)]\">\n        \n        {/* Left: Filters */}\n        <div className=\"col-span-12 md:col-span-3 space-y-6\">\n             <Card className=\"bg-card border-border h-full overflow-auto\">\n                <CardHeader>\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Team Filters</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                    <Button \n                      variant={filterAvailability === null ? \"secondary\" : \"ghost\"} \n                      className={cn(\"w-full justify-start\", filterAvailability === null && \"bg-accent text-accent-foreground\")}\n                      onClick={() => setFilterAvailability(null)}\n                    >\n                        <Users className=\"w-4 h-4 mr-2\" /> All Teams ({users.filter(u => u.status === 'active').length})\n                    </Button>\n                    <Button \n                      variant={filterAvailability === 'Available' ? \"secondary\" : \"ghost\"} \n                      className=\"w-full justify-start hover:bg-secondary/50\"\n                      onClick={() => setFilterAvailability('Available')}\n                    >\n                        <div className=\"w-2 h-2 rounded-full bg-green-500 mr-2\"></div> Available ({users.filter(u => u.status === 'active' && getUserAvailability(u.id) === 'Available').length})\n                    </Button>\n                    <Button \n                      variant={filterAvailability === 'Light' ? \"secondary\" : \"ghost\"} \n                      className=\"w-full justify-start hover:bg-secondary/50\"\n                      onClick={() => setFilterAvailability('Light')}\n                    >\n                        <div className=\"w-2 h-2 rounded-full bg-yellow-500 mr-2\"></div> Light Load ({users.filter(u => u.status === 'active' && getUserAvailability(u.id) === 'Light').length})\n                    </Button>\n                    <Button \n                      variant={filterAvailability === 'Busy' ? \"secondary\" : \"ghost\"} \n                      className=\"w-full justify-start hover:bg-secondary/50\"\n                      onClick={() => setFilterAvailability('Busy')}\n                    >\n                         <div className=\"w-2 h-2 rounded-full bg-red-500 mr-2\"></div> Busy ({users.filter(u => u.status === 'active' && getUserAvailability(u.id) === 'Busy').length})\n                    </Button>\n                    \n                    <div className=\"pt-4 border-t border-border\">\n                        <h4 className=\"text-xs font-medium text-muted-foreground mb-3 uppercase\">Active Deals</h4>\n                        <div className=\"relative mb-3\">\n                          <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                          <Input\n                            placeholder=\"Search deals...\"\n                            value={dealSearchQuery}\n                            onChange={(e) => setDealSearchQuery(e.target.value)}\n                            className=\"pl-9 h-9\"\n                            data-testid=\"input-search-deals\"\n                          />\n                        </div>\n                        {selectedDeal && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"w-full mb-2 text-muted-foreground hover:text-foreground\"\n                            onClick={() => setSelectedDeal(null)}\n                            data-testid=\"button-clear-deal-selection\"\n                          >\n                            <X className=\"w-3 h-3 mr-1\" /> Clear deal selection\n                          </Button>\n                        )}\n                        <div className=\"space-y-2 max-h-[300px] overflow-y-auto\">\n                            {filteredDeals.map(deal => (\n                                <div \n                                  key={deal.id} \n                                  className={cn(\n                                    \"p-3 rounded cursor-pointer transition-all\",\n                                    selectedDeal === deal.id \n                                      ? \"bg-primary/20 border border-primary\" \n                                      : \"bg-secondary/30 border border-border/50 hover:border-primary/50\"\n                                  )}\n                                  onClick={() => setSelectedDeal(selectedDeal === deal.id ? null : deal.id)}\n                                  data-testid={`deal-select-${deal.id}`}\n                                >\n                                    <div className=\"font-medium mb-1 text-sm\">{deal.name}</div>\n                                    <div className=\"flex justify-between text-xs text-muted-foreground\">\n                                        <span>{deal.stage}</span>\n                                        <span>${deal.value}M</span>\n                                    </div>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                </CardContent>\n             </Card>\n        </div>\n\n        {/* Main: Team Assignment Area */}\n        <div className=\"col-span-12 md:col-span-9\">\n            <div className=\"flex justify-between items-center mb-4\">\n                <h2 className=\"text-sm font-medium text-muted-foreground\">\n                  {selectedDeal ? `Assigning team for: ${currentDeal?.name}` : 'All Team Members (select a deal to manage team)'}\n                </h2>\n            </div>\n            \n            <Card className=\"bg-card border-border h-[calc(100%-3rem)] flex flex-col\">\n                <div className=\"p-4 border-b border-border bg-secondary/10\">\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <span className=\"text-sm font-medium\">Team Members</span>\n                      <Badge variant=\"secondary\">{filteredUsers.length} members</Badge>\n                    </div>\n                    <div className=\"relative\">\n                      <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search members by name, email, role...\"\n                        value={memberSearchQuery}\n                        onChange={(e) => setMemberSearchQuery(e.target.value)}\n                        className=\"pl-9 h-9\"\n                        data-testid=\"input-search-members\"\n                      />\n                    </div>\n                </div>\n                \n                <div className=\"flex-1 p-4 overflow-y-auto\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {filteredUsers.map(user => {\n                      const availability = getUserAvailability(user.id);\n                      const taskCount = getUserTaskCount(user.id);\n                      return (\n                        <Card \n                          key={user.id}\n                          ref={(el) => { userRefs.current[user.id] = el; }}\n                          className={cn(\n                            \"bg-secondary/20 border-border hover:border-primary/50 transition-all\",\n                            highlightedUserId === user.id && \"ring-2 ring-primary border-primary animate-pulse\"\n                          )}\n                        >\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start justify-between mb-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center font-bold text-primary\">\n                                  {user.name.split(' ').map((n: string) => n[0]).join('')}\n                                </div>\n                                <div>\n                                  <h4 className=\"font-medium\">{user.name}</h4>\n                                  <p className=\"text-xs text-muted-foreground\">{user.jobTitle || user.role}</p>\n                                </div>\n                              </div>\n                              <Badge className={cn(\n                                \"text-xs\",\n                                availability === 'Available' ? \"bg-green-500/20 text-green-400\" :\n                                availability === 'Light' ? \"bg-yellow-500/20 text-yellow-400\" :\n                                \"bg-red-500/20 text-red-400\"\n                              )}>\n                                {availability}\n                              </Badge>\n                            </div>\n                            \n                            <div className=\"grid grid-cols-3 gap-2 mb-3 text-center text-xs\">\n                              <div className=\"bg-secondary/50 rounded p-2\">\n                                <div className=\"font-bold\">{taskCount}</div>\n                                <div className=\"text-muted-foreground\">Active</div>\n                              </div>\n                              <div className=\"bg-secondary/50 rounded p-2\">\n                                <div className=\"font-bold\">{user.completedTasks || 0}</div>\n                                <div className=\"text-muted-foreground\">Done</div>\n                              </div>\n                              <div className=\"bg-secondary/50 rounded p-2\">\n                                <div className=\"font-bold\">{user.score || 0}</div>\n                                <div className=\"text-muted-foreground\">Score</div>\n                              </div>\n                            </div>\n                            \n                            <div className=\"flex gap-2\">\n                              {selectedDeal && isUserInDealTeam(user.id, selectedDeal) ? (\n                                <Button \n                                  variant=\"outline\"\n                                  className=\"flex-1 border-red-500/30 text-red-400 hover:bg-red-500/10\" \n                                  size=\"sm\"\n                                  onClick={() => handleRemoveFromTeam(user)}\n                                  disabled={updateDeal.isPending}\n                                  data-testid={`button-remove-team-${user.id}`}\n                                >\n                                  <X className=\"w-4 h-4 mr-1\" /> Remove\n                                </Button>\n                              ) : selectedDeal ? (\n                                <Button \n                                  variant=\"outline\"\n                                  className=\"flex-1 border-green-500/30 text-green-400 hover:bg-green-500/10\" \n                                  size=\"sm\"\n                                  onClick={() => handleAddToTeam(user)}\n                                  disabled={updateDeal.isPending}\n                                  data-testid={`button-add-team-${user.id}`}\n                                >\n                                  <UserPlus className=\"w-4 h-4 mr-1\" /> Add\n                                </Button>\n                              ) : null}\n                              <Button \n                                className={cn(\"flex-1\", !selectedDeal && \"w-full\")} \n                                size=\"sm\"\n                                onClick={() => openAssignModal(user)}\n                                data-testid={`button-assign-${user.id}`}\n                              >\n                                <CheckCircle className=\"w-4 h-4 mr-1\" /> Assign Task\n                              </Button>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                </div>\n            </Card>\n        </div>\n      </div>\n\n      {/* Assign Task Modal */}\n      <Dialog open={showAssignModal} onOpenChange={setShowAssignModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Assign Task to {selectedUser?.name}</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4 max-h-[60vh] overflow-y-auto\">\n            <div className=\"space-y-2\">\n              <Label>Related Deal (optional)</Label>\n              <Select value={taskDealId || \"none\"} onValueChange={(v) => setTaskDealId(v === \"none\" ? null : v)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"No deal - general task\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">No deal - general task</SelectItem>\n                  {deals.filter(d => d.status === 'Active').map(deal => (\n                    <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Task Title *</Label>\n              <Input \n                placeholder=\"e.g., Review financial model\" \n                value={newTask.title}\n                onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Description</Label>\n              <Textarea \n                placeholder=\"Provide detailed instructions for the task...\"\n                value={newTask.description}\n                onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}\n                rows={3}\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Priority</Label>\n                <Select value={newTask.priority} onValueChange={(v) => setNewTask({ ...newTask, priority: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"High\">High</SelectItem>\n                    <SelectItem value=\"Medium\">Medium</SelectItem>\n                    <SelectItem value=\"Low\">Low</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Type</Label>\n                <Select value={newTask.type} onValueChange={(v) => setNewTask({ ...newTask, type: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Analysis\">Analysis</SelectItem>\n                    <SelectItem value=\"Document\">Document</SelectItem>\n                    <SelectItem value=\"Meeting\">Meeting</SelectItem>\n                    <SelectItem value=\"Review\">Review</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Due Date & Time</Label>\n              <div className=\"flex gap-2\">\n                <Input \n                  type=\"date\" \n                  value={newTask.dueDate}\n                  onChange={(e) => setNewTask({ ...newTask, dueDate: e.target.value })}\n                  className=\"flex-1\"\n                />\n                <Select value={newTask.dueTime || \"none\"} onValueChange={(v) => setNewTask({ ...newTask, dueTime: v === \"none\" ? \"\" : v })}>\n                  <SelectTrigger className=\"w-32\">\n                    <SelectValue placeholder=\"Time\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">No time</SelectItem>\n                    <SelectItem value=\"08:00\">8:00 AM</SelectItem>\n                    <SelectItem value=\"08:30\">8:30 AM</SelectItem>\n                    <SelectItem value=\"09:00\">9:00 AM</SelectItem>\n                    <SelectItem value=\"09:30\">9:30 AM</SelectItem>\n                    <SelectItem value=\"10:00\">10:00 AM</SelectItem>\n                    <SelectItem value=\"10:30\">10:30 AM</SelectItem>\n                    <SelectItem value=\"11:00\">11:00 AM</SelectItem>\n                    <SelectItem value=\"11:30\">11:30 AM</SelectItem>\n                    <SelectItem value=\"12:00\">12:00 PM</SelectItem>\n                    <SelectItem value=\"12:30\">12:30 PM</SelectItem>\n                    <SelectItem value=\"13:00\">1:00 PM</SelectItem>\n                    <SelectItem value=\"13:30\">1:30 PM</SelectItem>\n                    <SelectItem value=\"14:00\">2:00 PM</SelectItem>\n                    <SelectItem value=\"14:30\">2:30 PM</SelectItem>\n                    <SelectItem value=\"15:00\">3:00 PM</SelectItem>\n                    <SelectItem value=\"15:30\">3:30 PM</SelectItem>\n                    <SelectItem value=\"16:00\">4:00 PM</SelectItem>\n                    <SelectItem value=\"16:30\">4:30 PM</SelectItem>\n                    <SelectItem value=\"17:00\">5:00 PM</SelectItem>\n                    <SelectItem value=\"17:30\">5:30 PM</SelectItem>\n                    <SelectItem value=\"18:00\">6:00 PM</SelectItem>\n                    <SelectItem value=\"18:30\">6:30 PM</SelectItem>\n                    <SelectItem value=\"19:00\">7:00 PM</SelectItem>\n                    <SelectItem value=\"20:00\">8:00 PM</SelectItem>\n                    <SelectItem value=\"21:00\">9:00 PM</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">Time is optional - leave blank for end of day</p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Attachments</Label>\n              <div\n                onDragOver={handleDragOver}\n                onDragLeave={handleDragLeave}\n                onDrop={handleDrop}\n                className={cn(\n                  \"border-2 border-dashed rounded-lg p-4 transition-colors cursor-pointer\",\n                  isDragging ? \"border-primary bg-primary/10\" : \"border-border hover:border-primary/50\"\n                )}\n                onClick={() => fileInputRef.current?.click()}\n              >\n                <input\n                  type=\"file\"\n                  ref={fileInputRef}\n                  onChange={handleFileSelect}\n                  multiple\n                  className=\"hidden\"\n                />\n                <div className=\"flex flex-col items-center gap-2 text-center\">\n                  {isUploading ? (\n                    <>\n                      <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n                      <span className=\"text-sm text-muted-foreground\">Uploading...</span>\n                    </>\n                  ) : (\n                    <>\n                      <Upload className=\"w-8 h-8 text-muted-foreground\" />\n                      <span className=\"text-sm text-muted-foreground\">\n                        Drag & drop files here, or click to browse\n                      </span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        Supports documents, images, videos up to 500MB\n                      </span>\n                    </>\n                  )}\n                </div>\n              </div>\n              {uploadedFiles.length > 0 && (\n                <div className=\"space-y-2 mt-2\">\n                  {uploadedFiles.map((file, index) => (\n                    <div key={file.id} className=\"flex items-center justify-between p-2 bg-secondary/30 rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <FileText className=\"w-4 h-4 text-primary\" />\n                        <span className=\"text-sm truncate max-w-48\">{file.filename}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {file.size >= 1024 * 1024 \n                            ? `(${(file.size / (1024 * 1024)).toFixed(1)} MB)`\n                            : `(${(file.size / 1024).toFixed(1)} KB)`\n                          }\n                        </span>\n                      </div>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          removeAttachment(index);\n                        }}\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAssignModal(false)}>Cancel</Button>\n            <Button onClick={handleAssignTask} disabled={createTask.isPending}>\n              {createTask.isPending ? \"Assigning...\" : \"Assign Task\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showOnboardingWarning} onOpenChange={setShowOnboardingWarning}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Incomplete Onboarding</AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-2\">\n              <p>\n                <strong>{pendingAssignment?.userName}</strong> has not completed their onboarding process:\n              </p>\n              <ul className=\"list-disc list-inside mt-2 space-y-1\">\n                {pendingAssignment?.missingResume && (\n                  <li>Resume Analysis not completed</li>\n                )}\n                {pendingAssignment?.missingPersonality && (\n                  <li>Personality Assessment not completed</li>\n                )}\n              </ul>\n              <p className=\"mt-3 text-muted-foreground\">\n                This may affect optimal team formation and task assignments. You can still proceed, but for best results, have them complete onboarding first.\n              </p>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => {\n              setShowOnboardingWarning(false);\n              setPendingAssignment(null);\n            }}>\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction onClick={() => {\n              pendingAssignment?.onConfirm?.();\n              setShowOnboardingWarning(false);\n              setPendingAssignment(null);\n            }}>\n              Assign Anyway\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":36025,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1877,"size_tokens":null},"client/src/components/ui/sonner.tsx":{"content":"\"use client\"\n\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\ntype ToasterProps = React.ComponentProps<typeof Sonner>\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props}\n    />\n  )\n}\n\nexport { Toaster }\n","path":null,"size_bytes":894,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2859,"size_tokens":null},"client/src/pages/shared/DocumentGenerator.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  FileText, \n  Search, \n  Clock, \n  Eye, \n  CheckCircle, \n  Archive, \n  Download, \n  Share2,\n  Bot,\n  Sparkles,\n  ChevronRight,\n  Loader2\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing, useGenerateDocument, useDocumentTemplates, useUpdateDocumentTemplate, useUserPreferences, useSaveUserPreferences } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { jsPDF } from \"jspdf\";\nimport type { DocumentTemplate } from \"@shared/schema\";\n\ntype DocumentGeneratorProps = {\n  role?: 'CEO' | 'Employee';\n};\n\nexport default function DocumentGenerator({ role = 'CEO' }: DocumentGeneratorProps) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [], isLoading: isLoadingDeals } = useDealsListing();\n  const { data: templates = [], isLoading: isLoadingTemplates } = useDocumentTemplates();\n  const { data: userPrefs, isLoading: isLoadingPrefs } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  const generateDocument = useGenerateDocument();\n  const updateTemplate = useUpdateDocumentTemplate();\n  \n  const [selectedTemplate, setSelectedTemplate] = useState<string | null>(null);\n  const [generatedContent, setGeneratedContent] = useState<string | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedDeal, setSelectedDeal] = useState<string>(\"\");\n  const [complianceOptions, setComplianceOptions] = useState({\n    sec: false,\n    finra: false,\n    legal: true,\n  });\n  const [complianceInitialized, setComplianceInitialized] = useState(false);\n\n  // Load compliance options from user preferences\n  useEffect(() => {\n    if (!isLoadingPrefs && !complianceInitialized) {\n      if (userPrefs?.complianceDefaults) {\n        const defaults = userPrefs.complianceDefaults as { sec?: boolean; finra?: boolean; legal?: boolean };\n        setComplianceOptions({\n          sec: defaults.sec ?? false,\n          finra: defaults.finra ?? false,\n          legal: defaults.legal ?? true,\n        });\n      }\n      setComplianceInitialized(true);\n    }\n  }, [isLoadingPrefs, userPrefs, complianceInitialized]);\n\n  // Track previous compliance options to avoid unnecessary saves\n  const prevComplianceRef = useRef<string | null>(null);\n  \n  // Save compliance options to database (debounced)\n  useEffect(() => {\n    if (!complianceInitialized || isLoadingPrefs) return;\n    \n    const currentJson = JSON.stringify(complianceOptions);\n    \n    // Skip save if values haven't changed from last save\n    if (prevComplianceRef.current === currentJson) return;\n    \n    // Skip initial save if values match server state\n    if (prevComplianceRef.current === null && userPrefs?.complianceDefaults) {\n      const serverJson = JSON.stringify({\n        sec: (userPrefs.complianceDefaults as any).sec ?? false,\n        finra: (userPrefs.complianceDefaults as any).finra ?? false,\n        legal: (userPrefs.complianceDefaults as any).legal ?? true,\n      });\n      if (currentJson === serverJson) {\n        prevComplianceRef.current = currentJson;\n        return;\n      }\n    }\n    \n    const timeout = setTimeout(() => {\n      // Extract only mutable fields from userPrefs\n      const { id, userId, updatedAt, ...mutablePrefs } = (userPrefs || {}) as any;\n      saveUserPrefs.mutate({\n        ...mutablePrefs,\n        complianceDefaults: complianceOptions,\n      });\n      prevComplianceRef.current = currentJson;\n    }, 2000);\n    \n    return () => clearTimeout(timeout);\n  }, [complianceOptions, complianceInitialized, isLoadingPrefs, userPrefs]);\n\n  // Set initial deal once data loads or when deals change\n  useEffect(() => {\n    if (deals.length > 0 && !selectedDeal) {\n      setSelectedDeal(deals[0].id);\n    } else if (deals.length === 0 && selectedDeal) {\n      setSelectedDeal('');\n    }\n  }, [deals]);\n\n  // Filter templates based on search query (only show default/active ones)\n  const filteredTemplates = templates.filter(t => \n    t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    (t.description || '').toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const handleGenerate = async () => {\n    if (!selectedTemplate) {\n      toast.error(\"Please select a template first\");\n      return;\n    }\n    \n    setGeneratedContent(null);\n    \n    const template = templates.find(t => t.id === selectedTemplate);\n    const deal = deals.find(d => d.id === selectedDeal);\n    \n    try {\n      const result = await generateDocument.mutateAsync({\n        templateName: template?.name || '',\n        dealData: deal ? {\n          name: deal.name,\n          client: deal.client,\n          sector: deal.sector,\n          value: deal.value,\n          stage: deal.stage,\n          description: deal.description,\n        } : null,\n        complianceOptions,\n      });\n      \n      setGeneratedContent(result.content);\n      \n      // Update template usage stats in database\n      if (template) {\n        updateTemplate.mutate({\n          id: template.id,\n          updates: {\n            lastUsed: new Date().toISOString().split('T')[0],\n            usageCount: (template.usageCount || 0) + 1,\n          },\n        });\n      }\n      \n      toast.success(\"Document generated with AI!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to generate document\");\n    }\n  };\n\n  const handleExport = (format: 'pdf' | 'word') => {\n    if (!generatedContent) {\n      toast.error(\"Generate a document first\");\n      return;\n    }\n    \n    const templateName = templates.find(t => t.id === selectedTemplate)?.name || 'document';\n    const fileName = templateName.replace(/\\s+/g, '_');\n    \n    if (format === 'pdf') {\n      const doc = new jsPDF();\n      const pageWidth = doc.internal.pageSize.getWidth();\n      const margin = 20;\n      const maxWidth = pageWidth - margin * 2;\n      \n      doc.setFillColor(26, 26, 46);\n      doc.rect(0, 0, pageWidth, 30, 'F');\n      \n      doc.setTextColor(255, 255, 255);\n      doc.setFontSize(16);\n      doc.setFont('helvetica', 'bold');\n      doc.text(templateName.toUpperCase(), margin, 20);\n      \n      doc.setTextColor(0, 0, 0);\n      doc.setFontSize(10);\n      doc.setFont('helvetica', 'normal');\n      \n      const lines = doc.splitTextToSize(generatedContent, maxWidth);\n      let y = 45;\n      const lineHeight = 5;\n      \n      const addHeader = () => {\n        doc.setFillColor(26, 26, 46);\n        doc.rect(0, 0, pageWidth, 25, 'F');\n        doc.setTextColor(255, 255, 255);\n        doc.setFontSize(12);\n        doc.setFont('helvetica', 'bold');\n        doc.text(templateName.toUpperCase(), margin, 16);\n        doc.setTextColor(0, 0, 0);\n        doc.setFontSize(10);\n        doc.setFont('helvetica', 'normal');\n      };\n      \n      for (const line of lines) {\n        if (y > doc.internal.pageSize.getHeight() - margin) {\n          doc.addPage();\n          addHeader();\n          y = 35;\n        }\n        doc.text(line, margin, y);\n        y += lineHeight;\n      }\n      \n      doc.setFontSize(8);\n      doc.setTextColor(128, 128, 128);\n      doc.text(`Generated by Kronos - ${new Date().toLocaleDateString()}`, margin, doc.internal.pageSize.getHeight() - 10);\n      \n      doc.save(`${fileName}.pdf`);\n      toast.success(\"PDF exported successfully!\");\n    } else {\n      const htmlContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>${templateName}</title>\n  <style>\n    body { font-family: 'Calibri', sans-serif; margin: 40px; line-height: 1.6; }\n    h1 { color: #1a1a2e; border-bottom: 2px solid #1a1a2e; padding-bottom: 10px; }\n    pre { white-space: pre-wrap; font-family: 'Calibri', sans-serif; }\n    .footer { margin-top: 40px; color: #888; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <h1>${templateName}</h1>\n  <pre>${generatedContent}</pre>\n  <div class=\"footer\">Generated by Kronos - ${new Date().toLocaleDateString()}</div>\n</body>\n</html>`;\n      \n      const blob = new Blob([htmlContent], { type: 'application/msword' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${fileName}.doc`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast.success(\"Word document exported successfully!\");\n    }\n  };\n\n  const handlePreview = () => {\n    if (generatedContent) {\n      const win = window.open('', '_blank');\n      if (win) {\n        win.document.write(`<pre style=\"font-family: monospace; padding: 40px; max-width: 800px; margin: 0 auto;\">${generatedContent}</pre>`);\n      }\n    }\n  };\n\n  const isDataLoading = isLoadingDeals || isLoadingTemplates || isLoadingPrefs;\n\n  if (isDataLoading) {\n    return (\n      <Layout role={role} pageTitle=\"Document Generator\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role} pageTitle=\"Document Generator\" userName={currentUser?.name || \"\"}>\n      <div className=\"grid grid-cols-12 gap-6 h-[calc(100vh-8rem)]\">\n        \n        {/* Left Sidebar: Templates */}\n        <div className=\"col-span-12 md:col-span-3 flex flex-col gap-6\">\n          <Card className=\"bg-card border-border flex-1 flex flex-col\">\n             <CardHeader className=\"pb-4\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Templates</CardTitle>\n                <div className=\"relative mt-2\">\n                    <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-muted-foreground\" />\n                    <Input \n                      placeholder=\"Search templates...\" \n                      className=\"pl-8 h-8 text-xs bg-secondary/50 border-transparent focus:border-primary\" \n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      data-testid=\"input-search-templates\"\n                    />\n                </div>\n             </CardHeader>\n             <ScrollArea className=\"flex-1\">\n                <div className=\"px-4 pb-4 space-y-2\">\n                    {filteredTemplates.map((template) => (\n                        <div \n                            key={template.id}\n                            onClick={() => { setSelectedTemplate(template.id); setGeneratedContent(null); }}\n                            className={cn(\n                                \"p-3 rounded-lg border cursor-pointer transition-all duration-200 group\",\n                                selectedTemplate === template.id \n                                    ? \"bg-primary/10 border-primary shadow-sm\" \n                                    : \"bg-transparent border-transparent hover:bg-secondary/50 hover:border-border\"\n                            )}\n                            data-testid={`template-${template.id}`}\n                        >\n                            <div className=\"flex justify-between items-start mb-1\">\n                                <h4 className={cn(\"font-medium text-sm\", selectedTemplate === template.id ? \"text-primary\" : \"text-foreground\")}>\n                                    {template.name}\n                                </h4>\n                                <Badge variant=\"outline\" className={cn(\n                                    \"text-[9px] px-1 h-4\",\n                                    template.complexity === 'High' ? \"border-red-500/50 text-red-400\" :\n                                    template.complexity === 'Medium' ? \"border-yellow-500/50 text-yellow-400\" :\n                                    \"border-green-500/50 text-green-400\"\n                                )}>\n                                    {template.complexity}\n                                </Badge>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground line-clamp-2 mb-2\">{template.description}</p>\n                            <div className=\"flex items-center text-[10px] text-muted-foreground/60\">\n                                <Clock className=\"w-3 h-3 mr-1\" /> Last used: {template.lastUsed}\n                                <ChevronRight className={cn(\"w-3 h-3 ml-auto opacity-0 transition-opacity\", selectedTemplate === template.id && \"opacity-100 text-primary\")} />\n                            </div>\n                        </div>\n                    ))}\n                </div>\n             </ScrollArea>\n          </Card>\n        </div>\n\n        {/* Center: Preview / Generator Area */}\n        <div className=\"col-span-12 md:col-span-6\">\n            <Card className=\"h-full bg-card border-border flex flex-col relative overflow-hidden\">\n                {selectedTemplate ? (\n                    <>\n                        <div className=\"absolute top-0 left-0 w-full h-1 bg-primary/20\">\n                            {generateDocument.isPending && <div className=\"h-full bg-primary animate-pulse w-full\"></div>}\n                        </div>\n                        <CardHeader className=\"border-b border-border/50 pb-4\">\n                            <div className=\"flex justify-between items-center\">\n                                <div>\n                                    <CardTitle className=\"text-xl\">{templates.find(t => t.id === selectedTemplate)?.name}</CardTitle>\n                                    <CardDescription>\n                                      {generatedContent ? 'Document generated - ready for review' : 'AI-assisted generation ready'}\n                                    </CardDescription>\n                                </div>\n                                <div className=\"flex gap-2\">\n                                    <Button \n                                      variant=\"outline\" \n                                      size=\"sm\" \n                                      className=\"gap-2\"\n                                      onClick={handlePreview}\n                                      disabled={!generatedContent}\n                                    >\n                                        <Eye className=\"w-4 h-4\" /> Preview\n                                    </Button>\n                                    <Button \n                                      size=\"sm\" \n                                      className=\"gap-2\" \n                                      onClick={handleGenerate} \n                                      disabled={generateDocument.isPending}\n                                      data-testid=\"button-generate\"\n                                    >\n                                        {generateDocument.isPending ? (\n                                            <><Loader2 className=\"w-4 h-4 animate-spin\" /> Generating...</>\n                                        ) : (\n                                            <><Sparkles className=\"w-4 h-4\" /> Generate with AI</>\n                                        )}\n                                    </Button>\n                                </div>\n                            </div>\n                        </CardHeader>\n                        <CardContent className=\"flex-1 bg-secondary/20 p-8 overflow-y-auto\">\n                             {/* Document View */}\n                             <div className=\"bg-white text-black p-10 shadow-lg min-h-[600px] w-full max-w-2xl mx-auto rounded-sm\">\n                                <div className=\"mb-8\">\n                                    <h1 className=\"text-2xl font-bold text-center mb-2\">{templates.find(t => t.id === selectedTemplate)?.name.toUpperCase()}</h1>\n                                    <p className=\"text-center text-gray-500 text-sm\">Generated via Kronos</p>\n                                </div>\n                                \n                                <div className=\"space-y-4 text-sm leading-relaxed font-serif text-gray-800 whitespace-pre-wrap\">\n                                    {generatedContent ? (\n                                      generatedContent\n                                    ) : generateDocument.isPending ? (\n                                        <div className=\"space-y-2 mt-4 animate-pulse\">\n                                            <div className=\"h-2 bg-gray-200 rounded w-full\"></div>\n                                            <div className=\"h-2 bg-gray-200 rounded w-5/6\"></div>\n                                            <div className=\"h-2 bg-gray-200 rounded w-4/6\"></div>\n                                            <div className=\"h-2 bg-gray-200 rounded w-full\"></div>\n                                            <div className=\"h-2 bg-gray-200 rounded w-3/4\"></div>\n                                        </div>\n                                    ) : (\n                                      <p className=\"text-gray-400 italic\">Select parameters on the right and click \"Generate with AI\" to populate this document...</p>\n                                    )}\n                                </div>\n                             </div>\n                        </CardContent>\n                    </>\n                ) : (\n                    <div className=\"flex-1 flex flex-col items-center justify-center text-muted-foreground\">\n                        <div className=\"w-16 h-16 rounded-2xl bg-secondary flex items-center justify-center mb-4\">\n                            <FileText className=\"w-8 h-8 opacity-50\" />\n                        </div>\n                        <h3 className=\"text-lg font-medium\">Select a Template</h3>\n                        <p className=\"text-sm max-w-xs text-center mt-2\">Choose a document template from the left panel to begin the generation process.</p>\n                    </div>\n                )}\n            </Card>\n        </div>\n\n        {/* Right Sidebar: Controls */}\n        <div className=\"col-span-12 md:col-span-3 space-y-6\">\n            <Card className=\"bg-card border-border h-full\">\n                <CardHeader>\n                    <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Document Controls</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <div className=\"space-y-2\">\n                        <label className=\"text-xs font-medium flex items-center gap-2\"><Bot className=\"w-3 h-3 text-primary\" /> Deal Reference</label>\n                        {deals.length > 0 ? (\n                          <Select value={selectedDeal || undefined} onValueChange={setSelectedDeal}>\n                            <SelectTrigger className=\"h-8 text-sm bg-secondary/50\">\n                              <SelectValue placeholder=\"Select a deal...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {deals.map(deal => (\n                                <SelectItem key={deal.id} value={deal.id}>\n                                  {deal.name} - {deal.client}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        ) : (\n                          <div className=\"h-8 px-3 text-sm bg-secondary/50 border border-border rounded-md flex items-center text-muted-foreground\">\n                            No deals available\n                          </div>\n                        )}\n                    </div>\n\n                    <Separator className=\"bg-border/50\" />\n\n                    <div className=\"space-y-3\">\n                        <label className=\"text-xs font-medium\">Compliance Routing</label>\n                        \n                        <div className=\"flex items-start gap-2\">\n                            <Checkbox \n                              checked={complianceOptions.sec}\n                              onCheckedChange={(checked) => setComplianceOptions({ ...complianceOptions, sec: !!checked })}\n                            />\n                            <div>\n                                <div className=\"text-xs font-medium\">SEC Review</div>\n                                <div className=\"text-[10px] text-muted-foreground\">Securities and Exchange Commission compliance</div>\n                            </div>\n                        </div>\n                        <div className=\"flex items-start gap-2\">\n                            <Checkbox \n                              checked={complianceOptions.finra}\n                              onCheckedChange={(checked) => setComplianceOptions({ ...complianceOptions, finra: !!checked })}\n                            />\n                            <div>\n                                <div className=\"text-xs font-medium\">FINRA Review</div>\n                                <div className=\"text-[10px] text-muted-foreground\">Financial Industry Regulatory Authority</div>\n                            </div>\n                        </div>\n                        <div className=\"flex items-start gap-2\">\n                             <Checkbox \n                               checked={complianceOptions.legal}\n                               onCheckedChange={(checked) => setComplianceOptions({ ...complianceOptions, legal: !!checked })}\n                             />\n                             <div>\n                                <div className=\"text-xs font-medium\">Legal Review</div>\n                                <div className=\"text-[10px] text-muted-foreground\">Internal legal counsel review</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <Separator className=\"bg-border/50\" />\n\n                    <div className=\"space-y-2\">\n                        <label className=\"text-xs font-medium\">Export Options</label>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\" \n                              className=\"text-xs h-8 bg-secondary/30\"\n                              onClick={() => handleExport('pdf')}\n                              disabled={!generatedContent}\n                              data-testid=\"button-export-pdf\"\n                            >\n                                <Download className=\"w-3 h-3 mr-1\" /> PDF\n                            </Button>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\" \n                              className=\"text-xs h-8 bg-secondary/30\"\n                              onClick={() => handleExport('word')}\n                              disabled={!generatedContent}\n                              data-testid=\"button-export-word\"\n                            >\n                                <Download className=\"w-3 h-3 mr-1\" /> Word\n                            </Button>\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":23685,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7406,"size_tokens":null},"client/src/pages/employee/Home.tsx":{"content":"import React, { useState, useEffect, useRef } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Reorder } from \"framer-motion\";\nimport { \n  ChartContainer, \n  ChartTooltip, \n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent \n} from \"@/components/ui/chart\";\nimport { \n  BarChart, \n  Bar, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  PieChart, \n  Pie, \n  Cell, \n  LineChart, \n  Line, \n  Area, \n  AreaChart,\n  ResponsiveContainer \n} from \"recharts\";\nimport { \n  CheckSquare, \n  Clock, \n  AlertCircle,\n  Briefcase,\n  FileText,\n  TrendingUp,\n  Calendar,\n  ArrowRight,\n  CheckCircle2,\n  Target,\n  User,\n  Paperclip,\n  ExternalLink,\n  MessageSquare,\n  Settings2,\n  Palette,\n  GripVertical,\n  BarChart3,\n  PieChartIcon,\n  Activity\n} from \"lucide-react\";\nimport { useCurrentUser, useTasks, useDealsListing, useMeetings, useNotifications, useUsers, useUpdateTask, useUserPreferences, useSaveUserPreferences, useCalendarEvents } from \"@/lib/api\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport type { UserPreferences, Deal } from \"@shared/schema\";\nimport { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { format, isToday, isTomorrow, parseISO, subDays, startOfDay, isSameDay } from \"date-fns\";\nimport { toast } from \"sonner\";\nimport type { PodTeamMember, Task } from \"@shared/schema\";\n\nexport default function EmployeeHome() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: allTasks = [] } = useTasks();\n  const { data: allDeals = [] } = useDealsListing();\n  const { data: meetings = [] } = useMeetings();\n  const { data: notifications = [] } = useNotifications();\n  const { data: users = [] } = useUsers();\n  const { data: calendarEvents = [] } = useCalendarEvents();\n  const updateTask = useUpdateTask();\n  const queryClient = useQueryClient();\n  const { data: userPrefs, isLoading: prefsLoading } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  const [, setLocation] = useLocation();\n  \n  const [selectedTask, setSelectedTask] = useState<Task | null>(null);\n  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);\n  const [showCustomizePopover, setShowCustomizePopover] = useState(false);\n  const [viewTab, setViewTab] = useState<'overview' | 'analytics'>('overview');\n  \n  // My Projects widget state\n  const [projectFilter, setProjectFilter] = useState<'IB' | 'AM'>('IB');\n  const [selectedDeal, setSelectedDeal] = useState<Deal | null>(null);\n  const [showDealDetailModal, setShowDealDetailModal] = useState(false);\n  \n  // Check if user has Asset Management access\n  const hasAssetManagementAccess = currentUser?.hasAssetManagementAccess === true || currentUser?.accessLevel === 'admin';\n  \n  // Widget definitions for drag and drop\n  type WidgetId = 'quickStats' | 'myTasks' | 'myProjects' | 'schedule' | 'quickActions';\n  const defaultWidgetOrder: WidgetId[] = ['quickStats', 'myTasks', 'myProjects', 'schedule', 'quickActions'];\n  const defaultWidgetSettings = {\n    showQuickStats: true,\n    showMyTasks: true,\n    showMyProjects: true,\n    showSchedule: true,\n    showQuickActions: true,\n  };\n  \n  // State for employee home settings\n  const [widgetOrder, setWidgetOrder] = useState<WidgetId[]>(defaultWidgetOrder);\n  const [widgetSettings, setWidgetSettings] = useState(defaultWidgetSettings);\n  const [bgColor, setBgColor] = useState<string>('default');\n  const [settingsInitialized, setSettingsInitialized] = useState(false);\n  const prevSettingsRef = useRef<string | null>(null);\n  \n  // Get job-title based default widget configuration\n  const getJobTitleDefaults = (jobTitle: string | undefined) => {\n    const seniorTitles = ['VP', 'Senior Associate'];\n    const midTitles = ['Associate'];\n    const juniorTitles = ['Analyst', 'Junior Analyst'];\n    \n    if (seniorTitles.includes(jobTitle || '')) {\n      return {\n        widgetOrder: ['quickStats', 'myProjects', 'myTasks', 'schedule', 'quickActions'] as WidgetId[],\n        widgetSettings: {\n          showQuickStats: true,\n          showMyTasks: true,\n          showMyProjects: true,\n          showSchedule: true,\n          showQuickActions: true,\n        },\n      };\n    } else if (juniorTitles.includes(jobTitle || '')) {\n      return {\n        widgetOrder: ['myTasks', 'schedule', 'quickStats', 'myProjects', 'quickActions'] as WidgetId[],\n        widgetSettings: {\n          showQuickStats: true,\n          showMyTasks: true,\n          showMyProjects: true,\n          showSchedule: true,\n          showQuickActions: true,\n        },\n      };\n    }\n    return {\n      widgetOrder: defaultWidgetOrder,\n      widgetSettings: defaultWidgetSettings,\n    };\n  };\n  \n  // Load settings from user preferences\n  useEffect(() => {\n    if (!prefsLoading && !settingsInitialized) {\n      const employeeSettings = (userPrefs?.settings as any)?.employeeHome;\n      if (employeeSettings) {\n        if (employeeSettings.widgetOrder) setWidgetOrder(employeeSettings.widgetOrder);\n        if (employeeSettings.widgetSettings) setWidgetSettings(employeeSettings.widgetSettings);\n        if (employeeSettings.bgColor) setBgColor(employeeSettings.bgColor);\n      } else if (currentUser?.jobTitle) {\n        const defaults = getJobTitleDefaults(currentUser.jobTitle);\n        setWidgetOrder(defaults.widgetOrder);\n        setWidgetSettings(defaults.widgetSettings);\n      }\n      setSettingsInitialized(true);\n    }\n  }, [prefsLoading, userPrefs, settingsInitialized, currentUser?.jobTitle]);\n  \n  // Save settings to database (debounced)\n  useEffect(() => {\n    if (!settingsInitialized || prefsLoading) return;\n    \n    const currentSettings = { widgetOrder, widgetSettings, bgColor };\n    const currentJson = JSON.stringify(currentSettings);\n    \n    if (prevSettingsRef.current === currentJson) return;\n    \n    // Skip initial save if values match server state\n    if (prevSettingsRef.current === null) {\n      const serverSettings = (userPrefs?.settings as any)?.employeeHome;\n      if (serverSettings && JSON.stringify(serverSettings) === currentJson) {\n        prevSettingsRef.current = currentJson;\n        return;\n      }\n    }\n    \n    const timeout = setTimeout(() => {\n      const freshPrefs = queryClient.getQueryData<UserPreferences>(['userPreferences']) || userPrefs;\n      const { id, userId, updatedAt, ...mutablePrefs } = (freshPrefs || {}) as any;\n      const existingSettings = (freshPrefs?.settings as any) || {};\n      saveUserPrefs.mutate({\n        ...mutablePrefs,\n        settings: {\n          ...existingSettings,\n          employeeHome: currentSettings,\n        },\n      });\n      prevSettingsRef.current = currentJson;\n    }, 2000);\n    \n    return () => clearTimeout(timeout);\n  }, [widgetOrder, widgetSettings, bgColor, settingsInitialized, prefsLoading, userPrefs]);\n\n  const openTaskDetail = (task: Task) => {\n    setSelectedTask(task);\n    setShowTaskDetailModal(true);\n  };\n\n  const getAssignerName = (assignerId: string | null) => {\n    if (!assignerId) return \"System\";\n    const user = users.find((u: any) => u.id === assignerId);\n    return user?.name || \"Unknown\";\n  };\n\n  const getDealName = (dealId: string | null) => {\n    if (!dealId) return null;\n    const deal = allDeals.find((d: any) => d.id === dealId);\n    return deal?.name || null;\n  };\n\n  const handleUpdateTaskStatus = async (taskId: string, newStatus: string) => {\n    try {\n      await updateTask.mutateAsync({ id: taskId, status: newStatus });\n      toast.success(`Task marked as ${newStatus}`);\n      setShowTaskDetailModal(false);\n    } catch (error) {\n      toast.error(\"Failed to update task status\");\n    }\n  };\n\n  // Filter tasks assigned to current user\n  const myTasks = allTasks.filter((task: any) => task.assignedTo === currentUser?.id);\n  const completedTasks = myTasks.filter((t: any) => t.status === 'Completed');\n  \n  // Task categorization for tabs\n  const now = new Date();\n  const activeTasks = myTasks.filter((t: any) => t.status === 'In Progress');\n  const upcomingTasksAll = myTasks.filter((t: any) => {\n    if (t.status === 'Completed') return false;\n    const dueDate = new Date(t.dueDate);\n    return dueDate > now;\n  }).sort((a: any, b: any) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());\n  const overdueTasks = myTasks.filter((t: any) => {\n    if (t.status === 'Completed') return false;\n    const dueDate = new Date(t.dueDate);\n    return dueDate < now;\n  });\n  const pendingTasks = myTasks.filter((t: any) => t.status === 'Pending');\n  const inProgressTasks = activeTasks;\n  \n  // Calculate task completion rate\n  const taskCompletionRate = myTasks.length > 0 \n    ? Math.round((completedTasks.length / myTasks.length) * 100) \n    : 0;\n    \n  // Background color classes\n  const getBackgroundClass = () => {\n    switch (bgColor) {\n      case 'blue': return 'bg-blue-950/20';\n      case 'purple': return 'bg-purple-950/20';\n      case 'green': return 'bg-green-950/20';\n      case 'orange': return 'bg-orange-950/20';\n      case 'red': return 'bg-red-950/20';\n      case 'pink': return 'bg-pink-950/20';\n      case 'cyan': return 'bg-cyan-950/20';\n      case 'amber': return 'bg-amber-950/20';\n      case 'emerald': return 'bg-emerald-950/20';\n      case 'indigo': return 'bg-indigo-950/20';\n      case 'rose': return 'bg-rose-950/20';\n      case 'slate': return 'bg-slate-800/30';\n      default: return '';\n    }\n  };\n\n  // Filter deals where user is on the pod team\n  const myDeals = allDeals.filter((deal: any) => {\n    if (!deal.podTeam || !Array.isArray(deal.podTeam)) return false;\n    return deal.podTeam.some((member: PodTeamMember) => \n      (currentUser?.id && member.userId === currentUser.id) ||\n      (currentUser?.email && member.email === currentUser.email) ||\n      (currentUser?.name && member.name === currentUser.name)\n    );\n  });\n\n  // Get upcoming tasks (due within next 7 days)\n  const upcomingTasks = myTasks\n    .filter((t: any) => t.status !== 'Completed')\n    .sort((a: any, b: any) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime())\n    .slice(0, 5);\n\n  // Get unread notifications\n  const unreadNotifications = notifications.filter((n: any) => !n.read).slice(0, 3);\n\n  // Get today's meetings\n  const todayMeetings = meetings.filter((m: any) => {\n    const meetingDate = new Date(m.scheduledFor);\n    return isToday(meetingDate);\n  });\n\n  const getGreeting = () => {\n    const hour = new Date().getHours();\n    if (hour < 12) return \"Good morning\";\n    if (hour < 18) return \"Good afternoon\";\n    return \"Good evening\";\n  };\n\n  const getJobTitleMessage = () => {\n    const jobTitle = currentUser?.jobTitle;\n    if (!jobTitle) return null;\n    \n    const seniorTitles = ['VP', 'Senior Associate'];\n    const midTitles = ['Associate'];\n    const juniorTitles = ['Analyst', 'Junior Analyst'];\n    \n    if (seniorTitles.includes(jobTitle)) {\n      return \"Your dashboard is optimized for portfolio oversight.\";\n    } else if (juniorTitles.includes(jobTitle)) {\n      return \"Your dashboard is focused on tasks and learning.\";\n    } else if (midTitles.includes(jobTitle)) {\n      return \"Your dashboard balances tasks and project work.\";\n    }\n    return null;\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'High': return 'text-red-400 bg-red-500/10';\n      case 'Medium': return 'text-yellow-400 bg-yellow-500/10';\n      case 'Low': return 'text-green-400 bg-green-500/10';\n      default: return 'text-muted-foreground bg-secondary';\n    }\n  };\n\n  const formatDueDate = (dateStr: string) => {\n    const date = parseISO(dateStr);\n    if (isToday(date)) return 'Today';\n    if (isTomorrow(date)) return 'Tomorrow';\n    return format(date, 'MMM d');\n  };\n  \n  const renderQuickStats = () => widgetSettings.showQuickStats && (\n    <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4\" key=\"quickStats\">\n      <Card className=\"bg-card border-border\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Active</p>\n              <p className=\"text-2xl font-bold mt-1\">{activeTasks.length}</p>\n            </div>\n            <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n              <TrendingUp className=\"w-5 h-5 text-blue-500\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-card border-border\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Upcoming</p>\n              <p className=\"text-2xl font-bold mt-1\">{upcomingTasksAll.length}</p>\n            </div>\n            <div className=\"w-10 h-10 rounded-full bg-yellow-500/10 flex items-center justify-center\">\n              <Clock className=\"w-5 h-5 text-yellow-500\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-card border-border\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Overdue</p>\n              <p className=\"text-2xl font-bold mt-1 text-red-400\">{overdueTasks.length}</p>\n            </div>\n            <div className=\"w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center\">\n              <AlertCircle className=\"w-5 h-5 text-red-500\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-card border-border\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Completed</p>\n              <p className=\"text-2xl font-bold mt-1\">{completedTasks.length}</p>\n            </div>\n            <div className=\"w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center\">\n              <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-card border-border\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">My Deals</p>\n              <p className=\"text-2xl font-bold mt-1\">{myDeals.length}</p>\n            </div>\n            <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n              <Briefcase className=\"w-5 h-5 text-primary\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n\n  const renderMyTasks = () => widgetSettings.showMyTasks && (\n      <Card className=\"bg-card border-border\" key=\"myTasks\">\n        <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n          <div>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <CheckSquare className=\"w-5 h-5 text-primary\" />\n              My Tasks\n            </CardTitle>\n            <CardDescription>Your tasks organized by status</CardDescription>\n          </div>\n          <Link href=\"/employee/tasks\">\n            <Button variant=\"ghost\" size=\"sm\">\n              View All <ArrowRight className=\"w-4 h-4 ml-1\" />\n            </Button>\n          </Link>\n        </CardHeader>\n      <CardContent>\n        <Tabs defaultValue=\"active\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-4 mb-4\">\n            <TabsTrigger value=\"active\" className=\"text-xs\">\n              Active ({activeTasks.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"upcoming\" className=\"text-xs\">\n              Upcoming ({upcomingTasksAll.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"overdue\" className=\"text-xs\">\n              Overdue ({overdueTasks.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"completed\" className=\"text-xs\">\n              Completed ({completedTasks.length})\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"active\">\n            <ScrollArea className=\"h-[200px]\">\n              {activeTasks.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {activeTasks.map((task: any) => (\n                    <div \n                      key={task.id} \n                      className=\"flex items-center justify-between p-3 bg-secondary/20 rounded-lg hover:bg-secondary/30 transition-colors cursor-pointer group\"\n                      onClick={() => openTaskDetail(task)}\n                      data-testid={`task-active-${task.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-2 h-2 rounded-full bg-blue-500\" />\n                        <div>\n                          <p className=\"font-medium text-sm group-hover:text-primary transition-colors\">{task.title}</p>\n                          <p className=\"text-xs text-muted-foreground\">{task.type}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge className={cn(\"text-xs\", getPriorityColor(task.priority))}>\n                          {task.priority}\n                        </Badge>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {formatDueDate(task.dueDate)}\n                        </span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <TrendingUp className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                  <p>No active tasks</p>\n                </div>\n              )}\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"upcoming\">\n            <ScrollArea className=\"h-[200px]\">\n              {upcomingTasksAll.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {upcomingTasksAll.map((task: any) => (\n                    <div \n                      key={task.id} \n                      className=\"flex items-center justify-between p-3 bg-secondary/20 rounded-lg hover:bg-secondary/30 transition-colors cursor-pointer group\"\n                      onClick={() => openTaskDetail(task)}\n                      data-testid={`task-upcoming-${task.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-2 h-2 rounded-full bg-yellow-500\" />\n                        <div>\n                          <p className=\"font-medium text-sm group-hover:text-primary transition-colors\">{task.title}</p>\n                          <p className=\"text-xs text-muted-foreground\">{task.type}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge className={cn(\"text-xs\", getPriorityColor(task.priority))}>\n                          {task.priority}\n                        </Badge>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {formatDueDate(task.dueDate)}\n                        </span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Clock className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                  <p>No upcoming tasks</p>\n                </div>\n              )}\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"overdue\">\n            <ScrollArea className=\"h-[200px]\">\n              {overdueTasks.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {overdueTasks.map((task: any) => (\n                    <div \n                      key={task.id} \n                      className=\"flex items-center justify-between p-3 bg-red-500/5 border border-red-500/20 rounded-lg hover:bg-red-500/10 transition-colors cursor-pointer group\"\n                      onClick={() => openTaskDetail(task)}\n                      data-testid={`task-overdue-${task.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-2 h-2 rounded-full bg-red-500\" />\n                        <div>\n                          <p className=\"font-medium text-sm group-hover:text-primary transition-colors\">{task.title}</p>\n                          <p className=\"text-xs text-muted-foreground\">{task.type}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge className=\"text-xs text-red-400 bg-red-500/10\">\n                          Overdue\n                        </Badge>\n                        <span className=\"text-xs text-red-400\">\n                          {formatDueDate(task.dueDate)}\n                        </span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CheckCircle2 className=\"w-8 h-8 mx-auto mb-2 opacity-50 text-green-500\" />\n                  <p>No overdue tasks</p>\n                </div>\n              )}\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"completed\">\n            <ScrollArea className=\"h-[200px]\">\n              {completedTasks.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {completedTasks.slice(0, 10).map((task: any) => (\n                    <div \n                      key={task.id} \n                      className=\"flex items-center justify-between p-3 bg-green-500/5 border border-green-500/20 rounded-lg cursor-pointer group\"\n                      onClick={() => openTaskDetail(task)}\n                      data-testid={`task-completed-${task.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                        <div>\n                          <p className=\"font-medium text-sm line-through opacity-70\">{task.title}</p>\n                          <p className=\"text-xs text-muted-foreground\">{task.type}</p>\n                        </div>\n                      </div>\n                      <Badge className=\"text-xs text-green-400 bg-green-500/10\">\n                        Completed\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CheckSquare className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                  <p>No completed tasks yet</p>\n                </div>\n              )}\n            </ScrollArea>\n          </TabsContent>\n        </Tabs>\n\n        <div className=\"mt-4 pt-4 border-t border-border\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <span className=\"text-sm text-muted-foreground\">Task Completion Rate</span>\n            <span className=\"text-sm font-medium\">{taskCompletionRate}%</span>\n          </div>\n          <Progress value={taskCompletionRate} className=\"h-2\" />\n        </div>\n      </CardContent>\n      </Card>\n  );\n\n  const renderMyProjects = () => {\n    // Filter deals based on division\n    const ibDeals = myDeals.filter((d: any) => d.dealType !== 'Asset Management');\n    const amDeals = myDeals.filter((d: any) => d.dealType === 'Asset Management');\n    \n    // Apply filter (if no AM access, always show IB deals only)\n    let filteredDeals = ibDeals;\n    if (hasAssetManagementAccess) {\n      filteredDeals = projectFilter === 'AM' ? amDeals : ibDeals;\n    }\n    \n    // Determine View All destination\n    const viewAllPath = hasAssetManagementAccess && projectFilter === 'AM' \n      ? '/employee/asset-management' \n      : '/employee/deals';\n    \n    const openDealDetail = (deal: Deal) => {\n      setSelectedDeal(deal);\n      setShowDealDetailModal(true);\n    };\n    \n    return widgetSettings.showMyProjects && (\n      <Card className=\"bg-card border-border\" key=\"myProjects\">\n        <CardHeader className=\"flex flex-row items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Briefcase className=\"w-5 h-5 text-primary\" />\n              My Projects\n            </CardTitle>\n            <CardDescription>Deals you're assigned to</CardDescription>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {hasAssetManagementAccess && (\n              <div className=\"flex rounded-md overflow-hidden border border-border\">\n                <Button \n                  variant={projectFilter === 'IB' ? 'default' : 'ghost'} \n                  size=\"sm\" \n                  className=\"h-7 px-2 rounded-none text-xs\"\n                  onClick={() => setProjectFilter('IB')}\n                  data-testid=\"button-filter-ib\"\n                >\n                  IB\n                </Button>\n                <Button \n                  variant={projectFilter === 'AM' ? 'default' : 'ghost'} \n                  size=\"sm\" \n                  className=\"h-7 px-2 rounded-none text-xs\"\n                  onClick={() => setProjectFilter('AM')}\n                  data-testid=\"button-filter-am\"\n                >\n                  AM\n                </Button>\n              </div>\n            )}\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={() => setLocation(viewAllPath)}\n              data-testid=\"button-view-all-projects\"\n            >\n              View All <ArrowRight className=\"w-4 h-4 ml-1\" />\n            </Button>\n          </div>\n        </CardHeader>\n      <CardContent>\n        {filteredDeals.length > 0 ? (\n          <div className=\"space-y-3\">\n            {filteredDeals.slice(0, 4).map((deal: any) => (\n              <div \n                key={deal.id} \n                className=\"p-3 bg-secondary/20 rounded-lg hover:bg-secondary/30 transition-colors cursor-pointer\"\n                onClick={() => openDealDetail(deal)}\n                data-testid={`card-project-${deal.id}`}\n              >\n                <div className=\"flex items-center justify-between mb-2\">\n                  <p className=\"font-medium text-sm\">{deal.name}</p>\n                  <div className=\"flex items-center gap-2\">\n                    {deal.dealType === 'Asset Management' && (\n                      <Badge className=\"text-[10px] bg-emerald-500/20 text-emerald-400\">AM</Badge>\n                    )}\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {deal.stage}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                  <span>{deal.client}</span>\n                  <span>${deal.value}M</span>\n                </div>\n                <Progress value={deal.progress || 0} className=\"h-1.5 mt-2\" />\n              </div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Briefcase className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n            <p>No assigned {hasAssetManagementAccess ? (projectFilter === 'AM' ? 'AM ' : 'IB ') : ''}projects</p>\n          </div>\n        )}\n      </CardContent>\n      </Card>\n    );\n  };\n\n  const renderSchedule = () => {\n    const today = startOfDay(new Date());\n    const todayCalendarEvents = calendarEvents.filter(e => {\n      const eventDate = startOfDay(new Date(e.date));\n      return isSameDay(eventDate, today);\n    });\n    const hasItems = todayMeetings.length > 0 || todayCalendarEvents.length > 0;\n    \n    return widgetSettings.showSchedule && (\n      <Card className=\"bg-card border-border\" key=\"schedule\">\n        <CardHeader className=\"flex flex-row items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5 text-primary\" />\n              Today's Schedule\n            </CardTitle>\n            <CardDescription>Your meetings and events for today</CardDescription>\n          </div>\n          <Link href=\"/employee/calendar\" className=\"hover:text-primary transition-colors\">\n            <Calendar className=\"w-5 h-5 text-muted-foreground hover:text-primary cursor-pointer\" />\n          </Link>\n        </CardHeader>\n        <CardContent>\n          {hasItems ? (\n            <div className=\"space-y-3\">\n              {todayMeetings.map((meeting: any) => (\n                <div \n                  key={meeting.id} \n                  className=\"flex items-center gap-3 p-3 bg-secondary/20 rounded-lg\"\n                >\n                  <div className=\"w-12 h-12 rounded-lg bg-primary/10 flex flex-col items-center justify-center\">\n                    <span className=\"text-xs font-bold text-primary\">\n                      {format(new Date(meeting.scheduledFor), 'HH:mm')}\n                    </span>\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-sm\">{meeting.title}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {meeting.location || 'No location'}  {meeting.duration} min\n                    </p>\n                  </div>\n                </div>\n              ))}\n              {todayCalendarEvents.map((event: any) => (\n                <div \n                  key={event.id} \n                  className=\"flex items-center gap-3 p-3 bg-primary/10 rounded-lg border border-primary/20\"\n                >\n                  <div className=\"w-12 h-12 rounded-lg bg-primary/20 flex flex-col items-center justify-center\">\n                    <span className=\"text-xs font-bold text-primary\">\n                      {event.time || '--:--'}\n                    </span>\n                  </div>\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-[10px] bg-primary/20 text-primary px-1.5 py-0.5 rounded\">Event</span>\n                      <p className=\"font-medium text-sm\">{event.title}</p>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {event.investor || event.deal || 'General event'}\n                    </p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n              <p>No meetings or events scheduled for today</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    );\n  };\n\n  const renderQuickActions = () => widgetSettings.showQuickActions && (\n    <Card className=\"bg-card border-border\" key=\"quickActions\">\n      <CardHeader>\n        <CardTitle className=\"text-lg flex items-center gap-2\">\n          <Target className=\"w-5 h-5 text-primary\" />\n          Quick Actions\n        </CardTitle>\n        <CardDescription>Frequently used features</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-2 gap-3\">\n          <Link href=\"/employee/tasks\">\n            <Button variant=\"outline\" className=\"w-full h-auto py-4 flex flex-col gap-2\">\n              <CheckSquare className=\"w-5 h-5\" />\n              <span className=\"text-xs\">View Tasks</span>\n            </Button>\n          </Link>\n          <Link href=\"/employee/documents\">\n            <Button variant=\"outline\" className=\"w-full h-auto py-4 flex flex-col gap-2\">\n              <FileText className=\"w-5 h-5\" />\n              <span className=\"text-xs\">Documents</span>\n            </Button>\n          </Link>\n          {hasAssetManagementAccess ? (\n            <Popover>\n              <PopoverTrigger asChild>\n                <Button variant=\"outline\" className=\"w-full h-auto py-4 flex flex-col gap-2\">\n                  <Briefcase className=\"w-5 h-5\" />\n                  <span className=\"text-xs\">My Deals</span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-48 p-2\" align=\"center\">\n                <div className=\"space-y-1\">\n                  <Button\n                    variant=\"ghost\"\n                    className=\"w-full justify-start gap-2 text-blue-400 hover:bg-blue-500/10\"\n                    onClick={() => setLocation('/employee/deals')}\n                    data-testid=\"button-my-deals-ib\"\n                  >\n                    <div className=\"w-2 h-2 rounded-full bg-blue-500\" />\n                    Investment Banking\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    className=\"w-full justify-start gap-2 text-emerald-400 hover:bg-emerald-500/10\"\n                    onClick={() => setLocation('/employee/asset-management')}\n                    data-testid=\"button-my-deals-am\"\n                  >\n                    <div className=\"w-2 h-2 rounded-full bg-emerald-500\" />\n                    Asset Management\n                  </Button>\n                </div>\n              </PopoverContent>\n            </Popover>\n          ) : (\n            <Link href=\"/employee/deals\">\n              <Button variant=\"outline\" className=\"w-full h-auto py-4 flex flex-col gap-2\">\n                <Briefcase className=\"w-5 h-5\" />\n                <span className=\"text-xs\">My Deals</span>\n              </Button>\n            </Link>\n          )}\n          <Link href=\"/employee/chat\">\n            <Button variant=\"outline\" className=\"w-full h-auto py-4 flex flex-col gap-2\">\n              <MessageSquare className=\"w-5 h-5\" />\n              <span className=\"text-xs\">Messages</span>\n            </Button>\n          </Link>\n        </div>\n\n        {unreadNotifications.length > 0 && (\n          <div className=\"mt-4 pt-4 border-t border-border\">\n            <p className=\"text-xs text-muted-foreground uppercase tracking-wider mb-3\">Recent Notifications</p>\n            <div className=\"space-y-2\">\n              {unreadNotifications.map((notification: any) => (\n                <div key={notification.id} className=\"flex items-start gap-2 text-sm\">\n                  <div className=\"w-2 h-2 rounded-full bg-primary mt-1.5\" />\n                  <div>\n                    <p className=\"font-medium\">{notification.title}</p>\n                    <p className=\"text-xs text-muted-foreground\">{notification.message}</p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n\n  const widgetRenderers: Record<WidgetId, () => React.ReactNode> = {\n    quickStats: renderQuickStats,\n    myTasks: renderMyTasks,\n    myProjects: renderMyProjects,\n    schedule: renderSchedule,\n    quickActions: renderQuickActions,\n  };\n\n  // Analytics data preparation\n  const tasksByStatus = [\n    { status: 'Pending', count: pendingTasks.length, fill: 'hsl(var(--chart-1))' },\n    { status: 'In Progress', count: inProgressTasks.length, fill: 'hsl(var(--chart-2))' },\n    { status: 'Completed', count: completedTasks.length, fill: 'hsl(var(--chart-3))' },\n    { status: 'Overdue', count: overdueTasks.length, fill: 'hsl(var(--chart-4))' },\n  ];\n\n  const tasksByPriority = [\n    { priority: 'High', count: myTasks.filter((t: any) => t.priority === 'High').length, fill: 'hsl(var(--destructive))' },\n    { priority: 'Medium', count: myTasks.filter((t: any) => t.priority === 'Medium').length, fill: 'hsl(var(--chart-5))' },\n    { priority: 'Low', count: myTasks.filter((t: any) => t.priority === 'Low').length, fill: 'hsl(var(--chart-3))' },\n  ];\n\n  // Generate weekly activity data (last 7 days)\n  const weeklyActivity = Array.from({ length: 7 }, (_, i) => {\n    const date = subDays(new Date(), 6 - i);\n    const dayStr = format(date, 'EEE');\n    const completedOnDay = completedTasks.filter((t: any) => {\n      const taskDate = new Date(t.updatedAt || t.dueDate);\n      return format(taskDate, 'yyyy-MM-dd') === format(date, 'yyyy-MM-dd');\n    }).length;\n    return { day: dayStr, completed: completedOnDay, assigned: Math.floor(Math.random() * 3) + 1 };\n  });\n\n  const dealProgress = myDeals.slice(0, 5).map((deal: any) => ({\n    name: deal.name?.substring(0, 15) + (deal.name?.length > 15 ? '...' : ''),\n    progress: deal.progress || 0,\n    value: deal.dealValue ? deal.dealValue / 1000000 : 0,\n  }));\n\n  const chartConfig = {\n    completed: { label: 'Completed', color: 'hsl(var(--chart-3))' },\n    assigned: { label: 'Assigned', color: 'hsl(var(--chart-2))' },\n    count: { label: 'Tasks', color: 'hsl(var(--chart-1))' },\n    progress: { label: 'Progress', color: 'hsl(var(--chart-2))' },\n    value: { label: 'Value (M)', color: 'hsl(var(--chart-4))' },\n  };\n\n  const renderAnalyticsView = () => (\n    <div className=\"space-y-6\">\n      {/* Summary Stats */}\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4\">\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-3 md:p-4\">\n            <div className=\"flex items-center gap-2 md:gap-3\">\n              <div className=\"w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                <Activity className=\"w-4 h-4 md:w-5 md:h-5 text-primary\" />\n              </div>\n              <div className=\"min-w-0\">\n                <p className=\"text-[10px] md:text-xs text-muted-foreground uppercase truncate\">Completion Rate</p>\n                <p className=\"text-2xl font-bold\">{taskCompletionRate}%</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center\">\n                <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground uppercase\">Completed</p>\n                <p className=\"text-2xl font-bold\">{completedTasks.length}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                <Briefcase className=\"w-5 h-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground uppercase\">Active Deals</p>\n                <p className=\"text-2xl font-bold\">{myDeals.length}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-10 h-10 rounded-full bg-yellow-500/10 flex items-center justify-center\">\n                <Calendar className=\"w-5 h-5 text-yellow-500\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground uppercase\">Meetings Today</p>\n                <p className=\"text-2xl font-bold\">{todayMeetings.length}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Charts Row 1 */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Weekly Activity */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5 text-primary\" />\n              Weekly Activity\n            </CardTitle>\n            <CardDescription>Tasks completed over the last 7 days</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ChartContainer config={chartConfig} className=\"h-[250px] w-full\">\n              <AreaChart data={weeklyActivity} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>\n                <defs>\n                  <linearGradient id=\"colorCompleted\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                    <stop offset=\"5%\" stopColor=\"hsl(var(--chart-3))\" stopOpacity={0.3}/>\n                    <stop offset=\"95%\" stopColor=\"hsl(var(--chart-3))\" stopOpacity={0}/>\n                  </linearGradient>\n                </defs>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                <XAxis dataKey=\"day\" stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <YAxis stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <ChartTooltip content={<ChartTooltipContent />} />\n                <Area type=\"monotone\" dataKey=\"completed\" stroke=\"hsl(var(--chart-3))\" fillOpacity={1} fill=\"url(#colorCompleted)\" />\n              </AreaChart>\n            </ChartContainer>\n          </CardContent>\n        </Card>\n\n        {/* Tasks by Status */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <PieChartIcon className=\"w-5 h-5 text-primary\" />\n              Tasks by Status\n            </CardTitle>\n            <CardDescription>Distribution of your current tasks</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ChartContainer config={chartConfig} className=\"h-[250px] w-full\">\n              <PieChart>\n                <Pie\n                  data={tasksByStatus}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  innerRadius={60}\n                  outerRadius={90}\n                  paddingAngle={2}\n                  dataKey=\"count\"\n                  nameKey=\"status\"\n                  label={({ status, count }) => count > 0 ? `${status}: ${count}` : ''}\n                  labelLine={false}\n                >\n                  {tasksByStatus.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.fill} />\n                  ))}\n                </Pie>\n                <ChartTooltip content={<ChartTooltipContent />} />\n              </PieChart>\n            </ChartContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Charts Row 2 */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Tasks by Priority */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Target className=\"w-5 h-5 text-primary\" />\n              Tasks by Priority\n            </CardTitle>\n            <CardDescription>Task breakdown by priority level</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <ChartContainer config={chartConfig} className=\"h-[200px] w-full\">\n              <BarChart data={tasksByPriority} layout=\"vertical\" margin={{ top: 10, right: 30, left: 60, bottom: 0 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                <XAxis type=\"number\" stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <YAxis dataKey=\"priority\" type=\"category\" stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                <ChartTooltip content={<ChartTooltipContent />} />\n                <Bar dataKey=\"count\" radius={[0, 4, 4, 0]}>\n                  {tasksByPriority.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.fill} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ChartContainer>\n          </CardContent>\n        </Card>\n\n        {/* Deal Progress */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Briefcase className=\"w-5 h-5 text-primary\" />\n              Deal Progress\n            </CardTitle>\n            <CardDescription>Progress on your active deals</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {dealProgress.length > 0 ? (\n              <ChartContainer config={chartConfig} className=\"h-[200px] w-full\">\n                <BarChart data={dealProgress} layout=\"vertical\" margin={{ top: 10, right: 30, left: 80, bottom: 0 }}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis type=\"number\" domain={[0, 100]} stroke=\"hsl(var(--muted-foreground))\" fontSize={12} />\n                  <YAxis dataKey=\"name\" type=\"category\" stroke=\"hsl(var(--muted-foreground))\" fontSize={11} width={75} />\n                  <ChartTooltip content={<ChartTooltipContent />} />\n                  <Bar dataKey=\"progress\" fill=\"hsl(var(--chart-2))\" radius={[0, 4, 4, 0]} />\n                </BarChart>\n              </ChartContainer>\n            ) : (\n              <div className=\"h-[200px] flex items-center justify-center text-muted-foreground\">\n                <p>No active deals to display</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n\n  return (\n    <Layout role=\"Employee\" pageTitle=\"Home\" userName={currentUser?.name || \"\"}>\n      <div className={cn(\"space-y-6 min-h-full\", getBackgroundClass())}>\n        {/* Welcome Header */}\n        <div className=\"bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl p-6 border border-primary/20\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm text-muted-foreground mb-1\">\n                {format(new Date(), 'EEEE, MMMM d, yyyy')}\n              </p>\n              <h1 className=\"text-2xl font-bold\">\n                {getGreeting()}, {currentUser?.name?.split(' ')[0] || 'User'}!\n              </h1>\n              <p className=\"text-muted-foreground mt-1\">\n                Here's an overview of your work today. You have {pendingTasks.length + inProgressTasks.length} active tasks.\n                {getJobTitleMessage() && (\n                  <span className=\"block text-xs text-primary/70 mt-1\">{getJobTitleMessage()}</span>\n                )}\n              </p>\n            </div>\n            <Popover open={showCustomizePopover} onOpenChange={setShowCustomizePopover}>\n              <PopoverTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                  <Settings2 className=\"w-4 h-4\" />\n                  Customize\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-80 bg-card border-border\" align=\"end\">\n                <div className=\"space-y-4\">\n                  <div>\n                    <h4 className=\"font-medium text-sm mb-3\">Background Color</h4>\n                    <div className=\"grid grid-cols-7 gap-2\">\n                      <button\n                        onClick={() => setBgColor('default')}\n                        className={cn(\"w-8 h-8 rounded-full bg-background border-2 transition-all\", bgColor === 'default' ? \"border-primary ring-2 ring-primary/20\" : \"border-border\")}\n                        title=\"Default\"\n                      />\n                      <button\n                        onClick={() => setBgColor('blue')}\n                        className={cn(\"w-8 h-8 rounded-full bg-blue-950/50 border-2 transition-all\", bgColor === 'blue' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Blue\"\n                      />\n                      <button\n                        onClick={() => setBgColor('purple')}\n                        className={cn(\"w-8 h-8 rounded-full bg-purple-950/50 border-2 transition-all\", bgColor === 'purple' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Purple\"\n                      />\n                      <button\n                        onClick={() => setBgColor('green')}\n                        className={cn(\"w-8 h-8 rounded-full bg-green-950/50 border-2 transition-all\", bgColor === 'green' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Green\"\n                      />\n                      <button\n                        onClick={() => setBgColor('orange')}\n                        className={cn(\"w-8 h-8 rounded-full bg-orange-950/50 border-2 transition-all\", bgColor === 'orange' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Orange\"\n                      />\n                      <button\n                        onClick={() => setBgColor('red')}\n                        className={cn(\"w-8 h-8 rounded-full bg-red-950/50 border-2 transition-all\", bgColor === 'red' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Red\"\n                      />\n                      <button\n                        onClick={() => setBgColor('pink')}\n                        className={cn(\"w-8 h-8 rounded-full bg-pink-950/50 border-2 transition-all\", bgColor === 'pink' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Pink\"\n                      />\n                      <button\n                        onClick={() => setBgColor('cyan')}\n                        className={cn(\"w-8 h-8 rounded-full bg-cyan-950/50 border-2 transition-all\", bgColor === 'cyan' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Cyan\"\n                      />\n                      <button\n                        onClick={() => setBgColor('amber')}\n                        className={cn(\"w-8 h-8 rounded-full bg-amber-950/50 border-2 transition-all\", bgColor === 'amber' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Amber\"\n                      />\n                      <button\n                        onClick={() => setBgColor('emerald')}\n                        className={cn(\"w-8 h-8 rounded-full bg-emerald-950/50 border-2 transition-all\", bgColor === 'emerald' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Emerald\"\n                      />\n                      <button\n                        onClick={() => setBgColor('indigo')}\n                        className={cn(\"w-8 h-8 rounded-full bg-indigo-950/50 border-2 transition-all\", bgColor === 'indigo' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Indigo\"\n                      />\n                      <button\n                        onClick={() => setBgColor('rose')}\n                        className={cn(\"w-8 h-8 rounded-full bg-rose-950/50 border-2 transition-all\", bgColor === 'rose' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Rose\"\n                      />\n                      <button\n                        onClick={() => setBgColor('slate')}\n                        className={cn(\"w-8 h-8 rounded-full bg-slate-700/50 border-2 transition-all\", bgColor === 'slate' ? \"border-primary ring-2 ring-primary/20\" : \"border-transparent\")}\n                        title=\"Slate\"\n                      />\n                    </div>\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div>\n                    <h4 className=\"font-medium text-sm mb-3\">Widgets (drag to reorder)</h4>\n                    <Reorder.Group \n                      axis=\"y\" \n                      values={widgetOrder} \n                      onReorder={setWidgetOrder}\n                      className=\"space-y-2\"\n                    >\n                      {widgetOrder.map((widgetId) => {\n                        const widgetLabels: Record<WidgetId, string> = {\n                          quickStats: 'Quick Stats',\n                          myTasks: 'My Tasks',\n                          myProjects: 'My Projects',\n                          schedule: \"Today's Schedule\",\n                          quickActions: 'Quick Actions',\n                        };\n                        const settingsKey: Record<WidgetId, keyof typeof widgetSettings> = {\n                          quickStats: 'showQuickStats',\n                          myTasks: 'showMyTasks',\n                          myProjects: 'showMyProjects',\n                          schedule: 'showSchedule',\n                          quickActions: 'showQuickActions',\n                        };\n                        return (\n                          <Reorder.Item\n                            key={widgetId}\n                            value={widgetId}\n                            className=\"flex items-center justify-between p-2 bg-secondary/30 rounded-lg cursor-grab active:cursor-grabbing\"\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <GripVertical className=\"w-4 h-4 text-muted-foreground\" />\n                              <Label className=\"text-sm cursor-grab\">{widgetLabels[widgetId]}</Label>\n                            </div>\n                            <Switch \n                              checked={widgetSettings[settingsKey[widgetId]]} \n                              onCheckedChange={(c) => setWidgetSettings((prev: typeof widgetSettings) => ({ ...prev, [settingsKey[widgetId]]: c }))} \n                            />\n                          </Reorder.Item>\n                        );\n                      })}\n                    </Reorder.Group>\n                  </div>\n                </div>\n              </PopoverContent>\n            </Popover>\n          </div>\n        </div>\n\n        {/* View Tabs */}\n        <Tabs value={viewTab} onValueChange={(v) => setViewTab(v as 'overview' | 'analytics')} className=\"w-full\">\n          <TabsList className=\"grid w-full max-w-md grid-cols-2 mb-6\">\n            <TabsTrigger value=\"overview\" className=\"gap-2\" data-testid=\"tab-overview\">\n              <Target className=\"w-4 h-4\" />\n              Overview\n            </TabsTrigger>\n            <TabsTrigger value=\"analytics\" className=\"gap-2\" data-testid=\"tab-analytics\">\n              <BarChart3 className=\"w-4 h-4\" />\n              Analytics\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"overview\" className=\"mt-0\">\n            {/* Widgets rendered in custom order - drag enabled on canvas */}\n            <Reorder.Group \n              axis=\"y\" \n              values={widgetOrder} \n              onReorder={setWidgetOrder}\n              className=\"space-y-6\"\n            >\n              {widgetOrder.map((widgetId) => (\n                <Reorder.Item\n                  key={widgetId}\n                  value={widgetId}\n                  className=\"relative group\"\n                  whileDrag={{ scale: 1.02, boxShadow: \"0 10px 30px rgba(0,0,0,0.2)\" }}\n                >\n                  <div className=\"absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing z-10\">\n                    <div className=\"p-1.5 rounded-md bg-secondary/80 border border-border hover:bg-secondary\">\n                      <GripVertical className=\"w-4 h-4 text-muted-foreground\" />\n                    </div>\n                  </div>\n                  {widgetRenderers[widgetId]()}\n                </Reorder.Item>\n              ))}\n            </Reorder.Group>\n          </TabsContent>\n\n          <TabsContent value=\"analytics\" className=\"mt-0\">\n            {renderAnalyticsView()}\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      {/* Task Detail Modal */}\n      <Dialog open={showTaskDetailModal} onOpenChange={setShowTaskDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckSquare className=\"w-5 h-5 text-primary\" />\n              Task Details\n            </DialogTitle>\n            <DialogDescription>View and manage your task</DialogDescription>\n          </DialogHeader>\n          \n          {selectedTask && (\n            <ScrollArea className=\"max-h-[60vh]\">\n              <div className=\"space-y-4 py-4 pr-4\">\n                {/* Task Title & Status */}\n                <div>\n                  <h3 className=\"text-lg font-semibold\">{selectedTask.title}</h3>\n                  <div className=\"flex items-center gap-2 mt-2\">\n                    <Badge className={cn(\n                      selectedTask.status === 'Completed' ? 'bg-green-500/20 text-green-400' :\n                      selectedTask.status === 'In Progress' ? 'bg-blue-500/20 text-blue-400' :\n                      'bg-yellow-500/20 text-yellow-400'\n                    )}>\n                      {selectedTask.status}\n                    </Badge>\n                    <Badge className={cn(\"text-xs\", getPriorityColor(selectedTask.priority))}>\n                      {selectedTask.priority} Priority\n                    </Badge>\n                    <Badge variant=\"outline\">{selectedTask.type}</Badge>\n                  </div>\n                </div>\n                \n                <Separator />\n                \n                {/* Task Info */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Due Date</p>\n                    <div className=\"flex items-center gap-2\">\n                      <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm\">\n                        {selectedTask.dueDate ? format(parseISO(selectedTask.dueDate), 'MMM d, yyyy') : 'No due date'}\n                      </span>\n                    </div>\n                  </div>\n                  \n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Assigned By</p>\n                    <div className=\"flex items-center gap-2\">\n                      <User className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"text-sm\">{getAssignerName(selectedTask.assignedBy)}</span>\n                    </div>\n                  </div>\n                </div>\n                \n                {/* Related Deal */}\n                {getDealName(selectedTask.dealId) && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-1\">\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Related Deal</p>\n                      <Link href=\"/employee/deals\">\n                        <div className=\"flex items-center gap-2 p-3 bg-secondary/30 rounded-lg hover:bg-secondary/50 transition-colors cursor-pointer\">\n                          <Briefcase className=\"w-4 h-4 text-primary\" />\n                          <span className=\"text-sm font-medium\">{getDealName(selectedTask.dealId)}</span>\n                          <ExternalLink className=\"w-3 h-3 text-muted-foreground ml-auto\" />\n                        </div>\n                      </Link>\n                    </div>\n                  </>\n                )}\n                \n                {/* Description */}\n                {selectedTask.description && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-2\">\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Description</p>\n                      <div className=\"p-3 bg-secondary/20 rounded-lg\">\n                        <p className=\"text-sm whitespace-pre-wrap\">{selectedTask.description}</p>\n                      </div>\n                    </div>\n                  </>\n                )}\n                \n                {/* Attachments */}\n                {selectedTask.attachments && selectedTask.attachments.length > 0 && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-2\">\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Attachments</p>\n                      <div className=\"space-y-2\">\n                        {selectedTask.attachments.map((attachment: any, idx: number) => (\n                          <div \n                            key={idx} \n                            className=\"flex items-center gap-2 p-2 bg-secondary/20 rounded-lg hover:bg-secondary/30 transition-colors cursor-pointer\"\n                          >\n                            <Paperclip className=\"w-4 h-4 text-muted-foreground\" />\n                            <span className=\"text-sm truncate flex-1\">{attachment.name}</span>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {Math.round(attachment.size / 1024)}KB\n                            </span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  </>\n                )}\n              </div>\n            </ScrollArea>\n          )}\n          \n          <DialogFooter className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={() => setShowTaskDetailModal(false)}>\n              Close\n            </Button>\n            {selectedTask && selectedTask.status === 'Pending' && (\n              <Button onClick={() => handleUpdateTaskStatus(selectedTask.id, 'In Progress')}>\n                Start Task\n              </Button>\n            )}\n            {selectedTask && selectedTask.status === 'In Progress' && (\n              <Button onClick={() => handleUpdateTaskStatus(selectedTask.id, 'Completed')} className=\"bg-green-600 hover:bg-green-700\">\n                Mark Complete\n              </Button>\n            )}\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Deal Detail Modal */}\n      <Dialog open={showDealDetailModal} onOpenChange={setShowDealDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[85vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Briefcase className=\"w-5 h-5 text-primary\" />\n              Project Details\n            </DialogTitle>\n            <DialogDescription>Comprehensive view of the selected deal</DialogDescription>\n          </DialogHeader>\n          \n          {selectedDeal && (\n            <ScrollArea className=\"max-h-[60vh] pr-4\">\n              <div className=\"space-y-6 py-4\">\n                {/* Deal Header */}\n                <div>\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"text-xl font-semibold\">{selectedDeal.name}</h3>\n                    <div className=\"flex items-center gap-2\">\n                      {selectedDeal.dealType === 'Asset Management' && (\n                        <Badge className=\"bg-emerald-500/20 text-emerald-400\">AM</Badge>\n                      )}\n                      {selectedDeal.dealType !== 'Asset Management' && (\n                        <Badge className=\"bg-blue-500/20 text-blue-400\">IB</Badge>\n                      )}\n                      <Badge variant=\"outline\">{selectedDeal.stage}</Badge>\n                    </div>\n                  </div>\n                  <p className=\"text-muted-foreground mt-1\">{selectedDeal.client}</p>\n                </div>\n\n                <Separator />\n\n                {/* Key Metrics */}\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div className=\"p-4 bg-secondary/20 rounded-lg text-center\">\n                    <div className=\"text-2xl font-bold text-green-400\">${selectedDeal.value}M</div>\n                    <div className=\"text-xs text-muted-foreground uppercase mt-1\">Deal Value</div>\n                  </div>\n                  <div className=\"p-4 bg-secondary/20 rounded-lg text-center\">\n                    <div className=\"text-2xl font-bold text-primary\">{selectedDeal.progress || 0}%</div>\n                    <div className=\"text-xs text-muted-foreground uppercase mt-1\">Progress</div>\n                  </div>\n                  <div className=\"p-4 bg-secondary/20 rounded-lg text-center\">\n                    <Badge className={cn(\n                      \"text-sm\",\n                      selectedDeal.status === 'Active' ? 'bg-green-500/20 text-green-400' :\n                      selectedDeal.status === 'On Hold' ? 'bg-yellow-500/20 text-yellow-400' :\n                      'bg-secondary'\n                    )}>\n                      {selectedDeal.status}\n                    </Badge>\n                    <div className=\"text-xs text-muted-foreground uppercase mt-2\">Status</div>\n                  </div>\n                </div>\n\n                {/* Progress Bar */}\n                <div>\n                  <div className=\"flex justify-between text-sm mb-2\">\n                    <span className=\"text-muted-foreground\">Deal Progress</span>\n                    <span className=\"font-medium\">{selectedDeal.progress || 0}%</span>\n                  </div>\n                  <Progress value={selectedDeal.progress || 0} className=\"h-3\" />\n                </div>\n\n                <Separator />\n\n                {/* Deal Information */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Sector</p>\n                    <p className=\"font-medium\">{selectedDeal.sector}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Deal Type</p>\n                    <p className=\"font-medium\">{selectedDeal.dealType}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Lead</p>\n                    <p className=\"font-medium\">{selectedDeal.lead}</p>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Created</p>\n                    <p className=\"font-medium\">\n                      {selectedDeal.createdAt ? format(new Date(selectedDeal.createdAt), 'MMM d, yyyy') : 'N/A'}\n                    </p>\n                  </div>\n                </div>\n\n                {/* Client Contact */}\n                {(selectedDeal.clientContactName || selectedDeal.clientContactEmail) && (\n                  <>\n                    <Separator />\n                    <div>\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider mb-3\">Client Contact</p>\n                      <div className=\"p-4 bg-secondary/20 rounded-lg space-y-2\">\n                        {selectedDeal.clientContactName && (\n                          <div className=\"flex items-center gap-2\">\n                            <User className=\"w-4 h-4 text-muted-foreground\" />\n                            <span>{selectedDeal.clientContactName}</span>\n                            {selectedDeal.clientContactRole && (\n                              <Badge variant=\"outline\" className=\"text-xs\">{selectedDeal.clientContactRole}</Badge>\n                            )}\n                          </div>\n                        )}\n                        {selectedDeal.clientContactEmail && (\n                          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                            <span>{selectedDeal.clientContactEmail}</span>\n                          </div>\n                        )}\n                        {selectedDeal.clientContactPhone && (\n                          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                            <span>{selectedDeal.clientContactPhone}</span>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                {/* Description */}\n                {selectedDeal.description && (\n                  <>\n                    <Separator />\n                    <div>\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider mb-2\">Description</p>\n                      <div className=\"p-4 bg-secondary/20 rounded-lg\">\n                        <p className=\"text-sm whitespace-pre-wrap\">{selectedDeal.description}</p>\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                {/* Pod Team */}\n                {selectedDeal.podTeam && (selectedDeal.podTeam as any[]).length > 0 && (\n                  <>\n                    <Separator />\n                    <div>\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider mb-3\">Team Members</p>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {(selectedDeal.podTeam as PodTeamMember[]).map((member, idx) => (\n                          <div key={idx} className=\"flex items-center gap-2 p-2 bg-secondary/20 rounded-lg\">\n                            <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-xs font-medium\">\n                              {member.name.split(' ').map(n => n[0]).join('')}\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"text-sm font-medium truncate\">{member.name}</p>\n                              <p className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                {/* My Tasks for this Deal */}\n                {(() => {\n                  const dealTasks = myTasks.filter((t: any) => t.dealId === selectedDeal.id);\n                  if (dealTasks.length === 0) return null;\n                  return (\n                    <>\n                      <Separator />\n                      <div>\n                        <p className=\"text-xs text-muted-foreground uppercase tracking-wider mb-3\">My Tasks for This Deal</p>\n                        <div className=\"space-y-2\">\n                          {dealTasks.slice(0, 5).map((task: any) => (\n                            <div key={task.id} className=\"flex items-center justify-between p-3 bg-secondary/20 rounded-lg\">\n                              <div className=\"flex items-center gap-2\">\n                                {task.status === 'Completed' ? (\n                                  <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                                ) : task.status === 'In Progress' ? (\n                                  <TrendingUp className=\"w-4 h-4 text-blue-500\" />\n                                ) : (\n                                  <Clock className=\"w-4 h-4 text-yellow-500\" />\n                                )}\n                                <span className=\"text-sm\">{task.title}</span>\n                              </div>\n                              <Badge variant=\"outline\" className=\"text-xs\">{task.status}</Badge>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    </>\n                  );\n                })()}\n              </div>\n            </ScrollArea>\n          )}\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowDealDetailModal(false)}>\n              Close\n            </Button>\n            <Button onClick={() => {\n              setShowDealDetailModal(false);\n              const path = selectedDeal?.dealType === 'Asset Management' \n                ? '/employee/asset-management' \n                : '/employee/deals';\n              setLocation(path);\n            }}>\n              Go to {selectedDeal?.dealType === 'Asset Management' ? 'Asset Management' : 'Deal Management'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":73865,"size_tokens":null},"client/src/pages/shared/Chat.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Send, \n  Plus, \n  Search, \n  MoreVertical,\n  Paperclip,\n  Image,\n  File,\n  Users,\n  MessageCircle,\n  X,\n  Check,\n  Loader2,\n  Download,\n  Trash2,\n  Settings,\n  Pencil,\n  Type,\n  Bell,\n  Smile,\n  AtSign,\n  Mic,\n  Square,\n  Play,\n  Pause,\n  Pin,\n  ImageIcon,\n  Link,\n  FileText,\n  Sticker,\n  ChevronDown,\n  Volume2\n} from \"lucide-react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { useCurrentUser, useUsers } from \"@/lib/api\";\nimport { useDashboardContext } from \"@/contexts/DashboardContext\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\n\ntype ChatProps = {\n  role: 'CEO' | 'Employee';\n};\n\ntype MessageReaction = {\n  emoji: string;\n  userId: string;\n  userName: string;\n  createdAt: string;\n};\n\ntype Message = {\n  id: string;\n  senderId: string;\n  senderName: string;\n  senderAvatar?: string;\n  content: string;\n  createdAt: string;\n  attachments?: { id: string; filename: string; url: string; size: number; type: string }[];\n  reactions?: MessageReaction[];\n  replyToMessageId?: string | null;\n};\n\ntype ConversationMember = {\n  id: string;\n  name: string;\n  avatar?: string;\n};\n\ntype Conversation = {\n  id: string;\n  name: string | null;\n  isGroup: boolean | null;\n  createdBy: string | null;\n  members: ConversationMember[];\n  lastMessage: {\n    content: string;\n    senderId: string;\n    createdAt: string;\n  } | null;\n  unreadCount: number;\n};\n\nexport default function Chat({ role }: ChatProps) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: allUsers = [] } = useUsers();\n  const { clearUnreadMessages } = useDashboardContext();\n  const queryClient = useQueryClient();\n  \n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [messageInput, setMessageInput] = useState(\"\");\n  const [selectedConversationId, setSelectedConversationId] = useState<string | null>(null);\n  const [showNewChatModal, setShowNewChatModal] = useState(false);\n  const [showNewGroupModal, setShowNewGroupModal] = useState(false);\n  const [selectedUsers, setSelectedUsers] = useState<string[]>([]);\n  const [groupName, setGroupName] = useState(\"\");\n  const [showSettingsSheet, setShowSettingsSheet] = useState(false);\n  const [editingName, setEditingName] = useState(false);\n  const [newConversationName, setNewConversationName] = useState(\"\");\n  const [newChatSearch, setNewChatSearch] = useState(\"\");\n  const [chatSettings, setChatSettings] = useState({\n    fontSize: \"medium\",\n    notifications: true,\n    soundEnabled: true,\n    showTimestamps: true,\n    chatTheme: \"default\" as \"default\" | \"dark\" | \"light\" | \"gradient\" | \"ocean\" | \"forest\",\n  });\n  \n  // @ Mention functionality\n  const [showMentionDropdown, setShowMentionDropdown] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [mentionStartIndex, setMentionStartIndex] = useState<number | null>(null);\n  const [selectedMentionIndex, setSelectedMentionIndex] = useState(0);\n  const inputRef = useRef<HTMLInputElement>(null);\n  \n  // Reply functionality\n  const [replyToMessage, setReplyToMessage] = useState<Message | null>(null);\n  \n  // Emoji picker for reactions\n  const [showEmojiPicker, setShowEmojiPicker] = useState<string | null>(null);\n  const QUICK_EMOJIS = [\"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"];\n  \n  // Voice message recording\n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingTime, setRecordingTime] = useState(0);\n  const [audioBlob, setAudioBlob] = useState<Blob | null>(null);\n  const [isPlayingVoice, setIsPlayingVoice] = useState<string | null>(null);\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const audioChunksRef = useRef<Blob[]>([]);\n  const recordingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Stickers\n  const [showStickerPicker, setShowStickerPicker] = useState(false);\n  const STICKERS = [\n    { id: 'thumbsup', emoji: '', label: 'Thumbs Up' },\n    { id: 'heart', emoji: '', label: 'Heart' },\n    { id: 'celebrate', emoji: '', label: 'Celebrate' },\n    { id: 'fire', emoji: '', label: 'Fire' },\n    { id: 'clap', emoji: '', label: 'Clap' },\n    { id: 'rocket', emoji: '', label: 'Rocket' },\n    { id: 'star', emoji: '', label: 'Star' },\n    { id: 'check', emoji: '', label: 'Check' },\n    { id: 'thinking', emoji: '', label: 'Thinking' },\n    { id: 'laugh', emoji: '', label: 'Laugh' },\n    { id: 'cool', emoji: '', label: 'Cool' },\n    { id: 'love', emoji: '', label: 'Love' },\n  ];\n  \n  // Search in conversation\n  const [showConversationSearch, setShowConversationSearch] = useState(false);\n  const [conversationSearchQuery, setConversationSearchQuery] = useState(\"\");\n  const [searchResults, setSearchResults] = useState<Message[]>([]);\n  \n  // Pinned messages\n  const [pinnedMessages, setPinnedMessages] = useState<Message[]>([]);\n  const [showPinnedMessages, setShowPinnedMessages] = useState(false);\n  \n  // Media gallery\n  const [showMediaGallery, setShowMediaGallery] = useState(false);\n  const [mediaGalleryTab, setMediaGalleryTab] = useState<'media' | 'files' | 'links'>('media');\n  \n  // Reaction details popover\n  const [showReactionDetails, setShowReactionDetails] = useState<string | null>(null);\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // Fetch conversations from database\n  const { data: conversations = [], isLoading: conversationsLoading } = useQuery<Conversation[]>({\n    queryKey: [\"/api/chat/conversations\"],\n  });\n\n  // Fetch messages for selected conversation\n  const { data: messages = [], isLoading: messagesLoading } = useQuery<Message[]>({\n    queryKey: [`/api/chat/conversations/${selectedConversationId}/messages`],\n    enabled: !!selectedConversationId,\n  });\n\n  // Create conversation mutation\n  const createConversationMutation = useMutation({\n    mutationFn: async (data: { participantId?: string; isGroup?: boolean; name?: string; participantIds?: string[] }) => {\n      const res = await fetch(\"/api/chat/conversations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error(\"Failed to create conversation\");\n      return res.json();\n    },\n    onSuccess: (conversation) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setSelectedConversationId(conversation.id);\n      setShowNewChatModal(false);\n      setShowNewGroupModal(false);\n      setGroupName(\"\");\n      setSelectedUsers([]);\n    },\n  });\n\n  // Send message mutation\n  const sendMessageMutation = useMutation({\n    mutationFn: async ({ conversationId, content, attachments, mentionedUserIds, replyToMessageId }: { conversationId: string; content: string; attachments?: any[]; mentionedUserIds?: string[]; replyToMessageId?: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content, attachments, mentionedUserIds, replyToMessageId }),\n      });\n      if (!res.ok) throw new Error(\"Failed to send message\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${selectedConversationId}/messages`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setMessageInput(\"\");\n    },\n  });\n\n  // Delete conversation mutation\n  const deleteConversationMutation = useMutation({\n    mutationFn: async (conversationId: string) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}`, { method: \"DELETE\" });\n      if (!res.ok) throw new Error(\"Failed to delete conversation\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setSelectedConversationId(null);\n      toast.success(\"Conversation deleted\");\n    },\n  });\n\n  // Update conversation mutation\n  const updateConversationMutation = useMutation({\n    mutationFn: async ({ conversationId, name }: { conversationId: string; name: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}`, { \n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name }),\n      });\n      if (!res.ok) throw new Error(\"Failed to update conversation\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setEditingName(false);\n      toast.success(\"Conversation updated\");\n    },\n  });\n\n  // Delete message mutation (unsend)\n  const deleteMessageMutation = useMutation({\n    mutationFn: async ({ conversationId, messageId }: { conversationId: string; messageId: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages/${messageId}`, { \n        method: \"DELETE\" \n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to unsend message\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${selectedConversationId}/messages`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      toast.success(\"Message unsent\");\n    },\n  });\n\n  // Reaction mutation\n  const reactionMutation = useMutation({\n    mutationFn: async ({ conversationId, messageId, emoji }: { conversationId: string; messageId: string; emoji: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages/${messageId}/reactions`, { \n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ emoji }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to add reaction\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${selectedConversationId}/messages`] });\n    },\n  });\n\n  const handleUnsendMessage = async (messageId: string) => {\n    if (!selectedConversationId) return;\n    try {\n      await deleteMessageMutation.mutateAsync({ \n        conversationId: selectedConversationId, \n        messageId \n      });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to unsend message\");\n    }\n  };\n\n  const handleUpdateConversationName = async () => {\n    if (!selectedConversationId || !newConversationName.trim()) return;\n    try {\n      await updateConversationMutation.mutateAsync({\n        conversationId: selectedConversationId,\n        name: newConversationName.trim(),\n      });\n    } catch (error) {\n      toast.error(\"Failed to update name\");\n    }\n  };\n\n  const handleDeleteConversation = async (conversationId: string) => {\n    if (!confirm(\"Are you sure you want to delete this conversation?\")) return;\n    try {\n      await deleteConversationMutation.mutateAsync(conversationId);\n    } catch (error) {\n      toast.error(\"Failed to delete conversation\");\n    }\n  };\n\n  // Handle adding/removing reaction\n  const handleReaction = async (messageId: string, emoji: string) => {\n    if (!selectedConversationId) return;\n    try {\n      await reactionMutation.mutateAsync({\n        conversationId: selectedConversationId,\n        messageId,\n        emoji,\n      });\n      setShowEmojiPicker(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add reaction\");\n    }\n  };\n\n  // Group reactions by emoji for display\n  const groupReactions = (reactions: MessageReaction[] | undefined) => {\n    if (!reactions || reactions.length === 0) return [];\n    const grouped: Record<string, { emoji: string; users: string[]; count: number; hasCurrentUser: boolean }> = {};\n    for (const r of reactions) {\n      if (!grouped[r.emoji]) {\n        grouped[r.emoji] = { emoji: r.emoji, users: [], count: 0, hasCurrentUser: false };\n      }\n      grouped[r.emoji].users.push(r.userName);\n      grouped[r.emoji].count++;\n      if (r.userId === currentUser?.id) {\n        grouped[r.emoji].hasCurrentUser = true;\n      }\n    }\n    return Object.values(grouped);\n  };\n\n  // Get replied message content\n  const getReplyMessage = (replyToMessageId: string | null | undefined) => {\n    if (!replyToMessageId) return null;\n    return messages.find(m => m.id === replyToMessageId);\n  };\n\n  // Voice recording handlers\n  const startRecording = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      const mediaRecorder = new MediaRecorder(stream);\n      mediaRecorderRef.current = mediaRecorder;\n      audioChunksRef.current = [];\n      \n      mediaRecorder.ondataavailable = (e) => {\n        audioChunksRef.current.push(e.data);\n      };\n      \n      mediaRecorder.onstop = () => {\n        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });\n        setAudioBlob(audioBlob);\n        stream.getTracks().forEach(track => track.stop());\n      };\n      \n      mediaRecorder.start();\n      setIsRecording(true);\n      setRecordingTime(0);\n      \n      recordingIntervalRef.current = setInterval(() => {\n        setRecordingTime(prev => prev + 1);\n      }, 1000);\n    } catch (error) {\n      toast.error(\"Could not access microphone\");\n    }\n  };\n  \n  const stopRecording = () => {\n    if (mediaRecorderRef.current && isRecording) {\n      mediaRecorderRef.current.stop();\n      setIsRecording(false);\n      if (recordingIntervalRef.current) {\n        clearInterval(recordingIntervalRef.current);\n      }\n    }\n  };\n  \n  const cancelRecording = () => {\n    if (mediaRecorderRef.current && isRecording) {\n      mediaRecorderRef.current.stop();\n    }\n    setIsRecording(false);\n    setAudioBlob(null);\n    setRecordingTime(0);\n    if (recordingIntervalRef.current) {\n      clearInterval(recordingIntervalRef.current);\n    }\n  };\n  \n  const sendVoiceMessage = async () => {\n    if (!audioBlob || !selectedConversationId) return;\n    \n    const reader = new FileReader();\n    reader.onloadend = async () => {\n      const base64Audio = reader.result as string;\n      try {\n        await sendMessageMutation.mutateAsync({\n          conversationId: selectedConversationId,\n          content: \" Voice message\",\n          attachments: [{\n            id: crypto.randomUUID(),\n            filename: `voice_${Date.now()}.webm`,\n            url: base64Audio,\n            size: audioBlob.size,\n            type: 'audio/webm'\n          }]\n        });\n        setAudioBlob(null);\n        setRecordingTime(0);\n      } catch (error) {\n        toast.error(\"Failed to send voice message\");\n      }\n    };\n    reader.readAsDataURL(audioBlob);\n  };\n  \n  const formatRecordingTime = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n  \n  // Send sticker\n  const handleSendSticker = async (sticker: typeof STICKERS[0]) => {\n    if (!selectedConversationId) return;\n    try {\n      await sendMessageMutation.mutateAsync({\n        conversationId: selectedConversationId,\n        content: sticker.emoji,\n        attachments: [{\n          id: crypto.randomUUID(),\n          filename: `sticker_${sticker.id}`,\n          url: '',\n          size: 0,\n          type: 'sticker'\n        }]\n      });\n      setShowStickerPicker(false);\n    } catch (error) {\n      toast.error(\"Failed to send sticker\");\n    }\n  };\n  \n  // Search in conversation\n  const handleConversationSearch = (query: string) => {\n    setConversationSearchQuery(query);\n    if (query.trim()) {\n      const results = messages.filter(m => \n        m.content.toLowerCase().includes(query.toLowerCase())\n      );\n      setSearchResults(results);\n    } else {\n      setSearchResults([]);\n    }\n  };\n  \n  // Pin/unpin message (local state for now)\n  const handlePinMessage = (message: Message) => {\n    const isPinned = pinnedMessages.some(m => m.id === message.id);\n    if (isPinned) {\n      setPinnedMessages(prev => prev.filter(m => m.id !== message.id));\n      toast.success(\"Message unpinned\");\n    } else {\n      setPinnedMessages(prev => [...prev, message]);\n      toast.success(\"Message pinned\");\n    }\n  };\n  \n  // Get media items from conversation\n  const mediaItems = useMemo(() => {\n    const items: { images: Message[]; files: Message[]; links: { message: Message; url: string }[] } = {\n      images: [],\n      files: [],\n      links: []\n    };\n    \n    messages.forEach(msg => {\n      // Check for image attachments\n      msg.attachments?.forEach(att => {\n        if (att.type?.startsWith('image/')) {\n          items.images.push(msg);\n        } else if (att.type && att.type !== 'sticker' && att.type !== 'audio/webm') {\n          items.files.push(msg);\n        }\n      });\n      \n      // Check for links in content\n      const urlRegex = /(https?:\\/\\/[^\\s]+)/g;\n      const matches = msg.content.match(urlRegex);\n      if (matches) {\n        matches.forEach(url => {\n          items.links.push({ message: msg, url });\n        });\n      }\n    });\n    \n    return items;\n  }, [messages]);\n\n  // Filter users excluding current user\n  const availableUsers = allUsers.filter(u => u.id !== currentUser?.id);\n\n  // Filtered users for @ mention dropdown\n  const mentionableUsers = useMemo(() => {\n    if (!mentionQuery) return availableUsers;\n    return availableUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    );\n  }, [availableUsers, mentionQuery]);\n\n  // Handle message input change with @ mention detection\n  const handleMessageInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    const cursorPos = e.target.selectionStart || 0;\n    \n    setMessageInput(value);\n    \n    // Find the @ symbol before cursor\n    const textBeforeCursor = value.substring(0, cursorPos);\n    const atIndex = textBeforeCursor.lastIndexOf('@');\n    \n    if (atIndex !== -1) {\n      // Check if there's a space before @ or it's at the start\n      const charBeforeAt = atIndex > 0 ? value[atIndex - 1] : ' ';\n      if (charBeforeAt === ' ' || atIndex === 0) {\n        const query = textBeforeCursor.substring(atIndex + 1);\n        // Only show dropdown if query doesn't contain spaces (not complete mention)\n        if (!query.includes(' ')) {\n          setMentionQuery(query);\n          setMentionStartIndex(atIndex);\n          setShowMentionDropdown(true);\n          setSelectedMentionIndex(0);\n          return;\n        }\n      }\n    }\n    \n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n  };\n\n  // Insert mention into message\n  const insertMention = (user: typeof availableUsers[0]) => {\n    if (mentionStartIndex === null) return;\n    \n    const beforeMention = messageInput.substring(0, mentionStartIndex);\n    const afterMention = messageInput.substring(mentionStartIndex + mentionQuery.length + 1);\n    const newMessage = `${beforeMention}@${user.name} ${afterMention}`;\n    \n    setMessageInput(newMessage);\n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n    \n    // Focus back on input\n    inputRef.current?.focus();\n  };\n\n  // Handle keyboard navigation in mention dropdown\n  const handleMentionKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (!showMentionDropdown) {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        handleSendMessage();\n      }\n      return;\n    }\n    \n    if (e.key === 'ArrowDown') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => \n        prev < mentionableUsers.length - 1 ? prev + 1 : prev\n      );\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => prev > 0 ? prev - 1 : 0);\n    } else if (e.key === 'Enter' || e.key === 'Tab') {\n      e.preventDefault();\n      if (mentionableUsers[selectedMentionIndex]) {\n        insertMention(mentionableUsers[selectedMentionIndex]);\n      }\n    } else if (e.key === 'Escape') {\n      setShowMentionDropdown(false);\n    }\n  };\n\n  // Extract mentioned user IDs from message\n  const extractMentions = (content: string): string[] => {\n    const mentionedIds: string[] = [];\n    allUsers.forEach(user => {\n      if (content.includes(`@${user.name}`)) {\n        mentionedIds.push(user.id);\n      }\n    });\n    return mentionedIds;\n  };\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  useEffect(() => {\n    clearUnreadMessages();\n  }, [clearUnreadMessages]);\n\n  // Auto-select first conversation if none selected\n  useEffect(() => {\n    if (conversations.length > 0 && !selectedConversationId) {\n      setSelectedConversationId(conversations[0].id);\n    }\n  }, [conversations, selectedConversationId]);\n\n  const handleSendMessage = async () => {\n    if (!messageInput.trim() || !selectedConversationId) return;\n\n    try {\n      // Extract mentioned users before sending\n      const mentionedUserIds = extractMentions(messageInput);\n      \n      await sendMessageMutation.mutateAsync({\n        conversationId: selectedConversationId,\n        content: messageInput.trim(),\n        mentionedUserIds,\n        replyToMessageId: replyToMessage?.id || undefined,\n      });\n      \n      // Clear reply state after sending\n      setReplyToMessage(null);\n      \n      // Show notification if users were mentioned\n      if (mentionedUserIds.length > 0) {\n        const mentionedNames = mentionedUserIds\n          .map(id => allUsers.find(u => u.id === id)?.name)\n          .filter(Boolean);\n        toast.success(`Notified ${mentionedNames.join(', ')}`);\n      }\n    } catch (error) {\n      toast.error(\"Failed to send message\");\n    }\n  };\n\n  const handleCreateChat = async (userId: string) => {\n    const user = availableUsers.find(u => u.id === userId);\n    if (!user) return;\n\n    try {\n      await createConversationMutation.mutateAsync({ participantId: userId });\n      toast.success(`Started conversation with ${user.name}`);\n    } catch (error) {\n      toast.error(\"Failed to create conversation\");\n    }\n  };\n\n  const handleCreateGroup = async () => {\n    if (!groupName.trim() || selectedUsers.length < 2) {\n      toast.error(\"Please enter a group name and select at least 2 members\");\n      return;\n    }\n\n    try {\n      await createConversationMutation.mutateAsync({\n        isGroup: true,\n        name: groupName.trim(),\n        participantIds: selectedUsers,\n      });\n      toast.success(`Created group: ${groupName}`);\n    } catch (error) {\n      toast.error(\"Failed to create group\");\n    }\n  };\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || !selectedConversationId) return;\n\n    for (const file of Array.from(files)) {\n      try {\n        // Upload file to server first\n        const formData = new FormData();\n        formData.append('file', file);\n        \n        const uploadRes = await fetch('/api/upload', {\n          method: 'POST',\n          body: formData,\n        });\n        \n        if (!uploadRes.ok) {\n          const error = await uploadRes.json();\n          throw new Error(error.error || 'Upload failed');\n        }\n        \n        const uploadedFile = await uploadRes.json();\n        \n        await sendMessageMutation.mutateAsync({\n          conversationId: selectedConversationId,\n          content: `Shared a file: ${file.name}`,\n          attachments: [{ \n            id: uploadedFile.id,\n            filename: uploadedFile.filename, \n            type: uploadedFile.type, \n            size: uploadedFile.size,\n            url: uploadedFile.url // Server URL for download\n          }],\n        });\n        toast.success(\"File shared successfully\");\n      } catch (error: any) {\n        toast.error(error.message || \"Failed to share file\");\n      }\n    }\n  };\n\n  const filteredConversations = conversations.filter(conv =>\n    (conv.name || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n    conv.members.some(m => m.name.toLowerCase().includes(searchQuery.toLowerCase()))\n  );\n\n  const selectedConversation = conversations.find(c => c.id === selectedConversationId);\n\n  const getConversationDisplayName = (conv: Conversation) => {\n    if (conv.isGroup) return conv.name || \"Group Chat\";\n    const otherMember = conv.members.find(m => m.id !== currentUser?.id);\n    return otherMember?.name || conv.name || \"Direct Message\";\n  };\n\n  return (\n    <Layout role={role} pageTitle=\"Messages\" userName={currentUser?.name || \"\"}>\n      <div className=\"flex gap-4 h-[calc(100vh-8rem)]\">\n        {/* Conversations List */}\n        <Card className=\"w-80 bg-card border-border flex flex-col\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <MessageCircle className=\"w-5 h-5 text-primary\" />\n                Chats\n              </CardTitle>\n              <div className=\"flex gap-1\">\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\" \n                  className=\"h-8 w-8\"\n                  onClick={() => setShowNewChatModal(true)}\n                  data-testid=\"button-new-chat\"\n                >\n                  <Plus className=\"w-4 h-4\" />\n                </Button>\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\" \n                  className=\"h-8 w-8\"\n                  onClick={() => setShowNewGroupModal(true)}\n                  data-testid=\"button-new-group\"\n                >\n                  <Users className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </div>\n            <div className=\"relative mt-2\">\n              <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search conversations...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9 bg-secondary/50\"\n                data-testid=\"input-search-conversations\"\n              />\n            </div>\n          </CardHeader>\n          <CardContent className=\"flex-1 overflow-hidden p-0\">\n            <ScrollArea className=\"h-full\">\n              <div className=\"px-2 pb-2\">\n                {conversationsLoading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : filteredConversations.length > 0 ? (\n                  filteredConversations.map(conv => (\n                    <button\n                      key={conv.id}\n                      onClick={() => setSelectedConversationId(conv.id)}\n                      className={cn(\n                        \"w-full p-3 rounded-lg flex items-start gap-3 transition-colors text-left\",\n                        selectedConversationId === conv.id \n                          ? \"bg-primary/10 border border-primary/20\" \n                          : \"hover:bg-secondary/50\"\n                      )}\n                      data-testid={`conversation-item-${conv.id}`}\n                    >\n                      <Avatar className=\"w-10 h-10\">\n                        <AvatarFallback className={cn(\n                          \"text-xs\",\n                          conv.isGroup ? \"bg-primary/20 text-primary\" : \"bg-blue-500/20 text-blue-500\"\n                        )}>\n                          {getConversationDisplayName(conv).split(' ').map(n => n[0]).join('').slice(0, 2)}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between\">\n                          <p className=\"font-medium text-sm truncate\">{getConversationDisplayName(conv)}</p>\n                          {conv.lastMessage?.createdAt && (\n                            <span className=\"text-xs text-muted-foreground\">\n                              {format(new Date(conv.lastMessage.createdAt), 'HH:mm')}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-xs text-muted-foreground truncate mt-0.5\">\n                          {conv.lastMessage?.content || \"No messages yet\"}\n                        </p>\n                        {conv.isGroup && (\n                          <div className=\"flex items-center gap-1 mt-1\">\n                            <Users className=\"w-3 h-3 text-muted-foreground\" />\n                            <span className=\"text-xs text-muted-foreground\">\n                              {conv.members.length} members\n                            </span>\n                          </div>\n                        )}\n                      </div>\n                      {conv.unreadCount > 0 && (\n                        <Badge variant=\"default\" className=\"h-5 min-w-5 text-xs px-1.5\">\n                          {conv.unreadCount}\n                        </Badge>\n                      )}\n                    </button>\n                  ))\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <MessageCircle className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                    <p className=\"text-sm\">No conversations yet</p>\n                    <Button \n                      variant=\"link\" \n                      size=\"sm\" \n                      className=\"mt-2\"\n                      onClick={() => setShowNewChatModal(true)}\n                    >\n                      Start a new chat\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n\n        {/* Chat Window */}\n        <Card className=\"flex-1 bg-card border-border flex flex-col\">\n          {selectedConversation ? (\n            <>\n              {/* Chat Header */}\n              <CardHeader className=\"pb-3 border-b border-border\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <Avatar className=\"w-10 h-10\">\n                      <AvatarFallback className={cn(\n                        \"text-xs\",\n                        selectedConversation.isGroup \n                          ? \"bg-primary/20 text-primary\" \n                          : \"bg-blue-500/20 text-blue-500\"\n                      )}>\n                        {getConversationDisplayName(selectedConversation).split(' ').map(n => n[0]).join('').slice(0, 2)}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div>\n                      <p className=\"font-medium\">{getConversationDisplayName(selectedConversation)}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {selectedConversation.isGroup \n                          ? `${selectedConversation.members.length} members`\n                          : \"Direct message\"\n                        }\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    {/* Search in conversation */}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => setShowConversationSearch(!showConversationSearch)}\n                      className={cn(\n                        \"text-muted-foreground\",\n                        showConversationSearch && \"text-primary bg-primary/10\"\n                      )}\n                      data-testid=\"button-conversation-search\"\n                    >\n                      <Search className=\"w-4 h-4\" />\n                    </Button>\n                    \n                    {/* Pinned messages */}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => setShowPinnedMessages(!showPinnedMessages)}\n                      className={cn(\n                        \"text-muted-foreground relative\",\n                        showPinnedMessages && \"text-yellow-500 bg-yellow-500/10\"\n                      )}\n                      data-testid=\"button-pinned-messages\"\n                    >\n                      <Pin className=\"w-4 h-4\" />\n                      {pinnedMessages.length > 0 && (\n                        <span className=\"absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 text-[10px] text-white rounded-full flex items-center justify-center\">\n                          {pinnedMessages.length}\n                        </span>\n                      )}\n                    </Button>\n                    \n                    {/* Media gallery */}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => setShowMediaGallery(true)}\n                      className=\"text-muted-foreground hover:text-primary\"\n                      data-testid=\"button-media-gallery\"\n                    >\n                      <ImageIcon className=\"w-4 h-4\" />\n                    </Button>\n                    \n                    {selectedConversation && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        onClick={() => {\n                          setNewConversationName(getConversationDisplayName(selectedConversation));\n                          setShowSettingsSheet(true);\n                        }}\n                        className=\"text-muted-foreground hover:text-primary\"\n                        data-testid=\"button-chat-settings\"\n                      >\n                        <Settings className=\"w-4 h-4\" />\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => handleDeleteConversation(selectedConversation.id)}\n                      className=\"text-muted-foreground hover:text-destructive\"\n                      data-testid=\"button-delete-conversation\"\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n                \n                {/* Search panel */}\n                {showConversationSearch && (\n                  <div className=\"mt-3 pt-3 border-t border-border\">\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search in conversation...\"\n                        value={conversationSearchQuery}\n                        onChange={(e) => handleConversationSearch(e.target.value)}\n                        className=\"pl-9\"\n                        data-testid=\"input-conversation-search\"\n                      />\n                    </div>\n                    {searchResults.length > 0 && (\n                      <div className=\"mt-2 max-h-32 overflow-y-auto\">\n                        <p className=\"text-xs text-muted-foreground mb-1\">{searchResults.length} results found</p>\n                        {searchResults.slice(0, 5).map(msg => (\n                          <div \n                            key={msg.id} \n                            className=\"text-xs p-2 hover:bg-secondary rounded cursor-pointer\"\n                            onClick={() => {\n                              const el = document.querySelector(`[data-message-id=\"${msg.id}\"]`);\n                              el?.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                            }}\n                          >\n                            <span className=\"font-medium\">{msg.senderName}: </span>\n                            <span className=\"text-muted-foreground\">{msg.content.slice(0, 50)}...</span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n                \n                {/* Pinned messages panel */}\n                {showPinnedMessages && pinnedMessages.length > 0 && (\n                  <div className=\"mt-3 pt-3 border-t border-border\">\n                    <p className=\"text-xs font-medium text-yellow-500 mb-2 flex items-center gap-1\">\n                      <Pin className=\"w-3 h-3\" />\n                      Pinned Messages ({pinnedMessages.length})\n                    </p>\n                    <div className=\"max-h-32 overflow-y-auto space-y-2\">\n                      {pinnedMessages.map(msg => (\n                        <div \n                          key={msg.id} \n                          className=\"text-xs p-2 bg-yellow-500/10 rounded flex items-center justify-between gap-2\"\n                        >\n                          <div className=\"min-w-0 flex-1\">\n                            <span className=\"font-medium\">{msg.senderName}: </span>\n                            <span className=\"text-muted-foreground truncate\">{msg.content.slice(0, 40)}...</span>\n                          </div>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-5 w-5 flex-shrink-0\"\n                            onClick={() => handlePinMessage(msg)}\n                          >\n                            <X className=\"w-3 h-3\" />\n                          </Button>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </CardHeader>\n\n              {/* Messages */}\n              <CardContent className={cn(\n                \"flex-1 overflow-hidden p-0 transition-colors\",\n                chatSettings.chatTheme === \"default\" && \"bg-card\",\n                chatSettings.chatTheme === \"dark\" && \"bg-zinc-900\",\n                chatSettings.chatTheme === \"light\" && \"bg-slate-50\",\n                chatSettings.chatTheme === \"gradient\" && \"bg-gradient-to-br from-indigo-500/10 via-purple-500/10 to-pink-500/10\",\n                chatSettings.chatTheme === \"ocean\" && \"bg-gradient-to-br from-cyan-500/10 via-blue-500/10 to-teal-500/10\",\n                chatSettings.chatTheme === \"forest\" && \"bg-gradient-to-br from-green-500/10 via-emerald-500/10 to-lime-500/10\"\n              )}>\n                <ScrollArea className=\"h-full p-4\">\n                  {messagesLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : messages.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {messages.map(message => {\n                        const isOwnMessage = message.senderId === currentUser?.id;\n                        const replyMessage = getReplyMessage(message.replyToMessageId);\n                        const groupedReactions = groupReactions(message.reactions);\n                        return (\n                          <div \n                            key={message.id} \n                            data-message-id={message.id}\n                            className={cn(\"flex gap-3\", isOwnMessage && \"flex-row-reverse\")}\n                          >\n                            <Avatar className=\"w-8 h-8\">\n                              <AvatarFallback className=\"text-xs bg-secondary\">\n                                {message.senderName?.split(' ').map(n => n[0]).join('').slice(0, 2) || '??'}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div className={cn(\"max-w-[70%] group\", isOwnMessage && \"text-right\")}>\n                              <div className=\"relative\">\n                                <div className={cn(\n                                  \"rounded-lg p-3\",\n                                  isOwnMessage \n                                    ? \"bg-primary text-primary-foreground\" \n                                    : \"bg-secondary\"\n                                )}>\n                                  {/* Reply indicator */}\n                                  {replyMessage && (\n                                    <div className={cn(\n                                      \"text-xs mb-2 pb-2 border-b border-border/50 opacity-70\",\n                                      isOwnMessage ? \"border-primary-foreground/30\" : \"border-border\"\n                                    )}>\n                                      <span className=\"font-medium\"> Reply to {replyMessage.senderName}:</span>\n                                      <p className=\"truncate\">{replyMessage.content.slice(0, 50)}{replyMessage.content.length > 50 ? '...' : ''}</p>\n                                    </div>\n                                  )}\n                                  {!isOwnMessage && (\n                                    <p className=\"text-xs font-medium mb-1 opacity-70\">{message.senderName}</p>\n                                  )}\n                                  <p className={cn(\n                                    chatSettings.fontSize === \"small\" && \"text-xs\",\n                                    chatSettings.fontSize === \"medium\" && \"text-sm\",\n                                    chatSettings.fontSize === \"large\" && \"text-base\"\n                                  )}>{message.content}</p>\n                                {message.attachments && message.attachments.length > 0 && (\n                                  <div className=\"mt-2 space-y-1.5\">\n                                    {message.attachments.map((att, idx) => (\n                                      <div \n                                        key={idx} \n                                        className={cn(\n                                          \"flex items-center gap-2 p-2 rounded-md cursor-pointer transition-colors\",\n                                          isOwnMessage \n                                            ? \"bg-primary-foreground/10 hover:bg-primary-foreground/20\" \n                                            : \"bg-background/50 hover:bg-background/80\"\n                                        )}\n                                        onClick={() => {\n                                          if (att.url) {\n                                            // Create download link for base64 data URLs\n                                            const link = document.createElement('a');\n                                            link.href = att.url;\n                                            link.download = att.filename || 'download';\n                                            document.body.appendChild(link);\n                                            link.click();\n                                            document.body.removeChild(link);\n                                          } else {\n                                            toast.info(\"File not available for download\");\n                                          }\n                                        }}\n                                        data-testid={`attachment-${att.id || idx}`}\n                                      >\n                                        <File className=\"w-4 h-4 flex-shrink-0\" />\n                                        <div className=\"flex-1 min-w-0\">\n                                          <span className=\"text-xs font-medium truncate block\">{att.filename}</span>\n                                          <span className=\"text-[10px] opacity-70\">\n                                            {att.size ? `${(att.size / 1024).toFixed(1)} KB` : ''} \n                                            {att.type ? `  ${att.type.split('/')[1]?.toUpperCase() || att.type}` : ''}\n                                          </span>\n                                        </div>\n                                        <Download className=\"w-3 h-3 opacity-60\" />\n                                      </div>\n                                    ))}\n                                  </div>\n                                )}\n                                </div>\n                                \n                                {/* Message actions (reply, react, unsend) */}\n                                <div className={cn(\n                                  \"absolute top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\",\n                                  isOwnMessage ? \"-left-20\" : \"-right-20\"\n                                )}>\n                                  {/* Reply button */}\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    className=\"h-6 w-6 text-muted-foreground hover:text-primary\"\n                                    onClick={() => setReplyToMessage(message)}\n                                    data-testid={`button-reply-${message.id}`}\n                                  >\n                                    <MessageCircle className=\"w-3 h-3\" />\n                                  </Button>\n                                  \n                                  {/* Reaction button */}\n                                  <Popover open={showEmojiPicker === message.id} onOpenChange={(open) => setShowEmojiPicker(open ? message.id : null)}>\n                                    <PopoverTrigger asChild>\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"icon\"\n                                        className=\"h-6 w-6 text-muted-foreground hover:text-primary\"\n                                        data-testid={`button-react-${message.id}`}\n                                      >\n                                        <Smile className=\"w-3 h-3\" />\n                                      </Button>\n                                    </PopoverTrigger>\n                                    <PopoverContent className=\"w-auto p-2\" side=\"top\">\n                                      <div className=\"flex gap-1\">\n                                        {QUICK_EMOJIS.map(emoji => (\n                                          <Button\n                                            key={emoji}\n                                            variant=\"ghost\"\n                                            size=\"icon\"\n                                            className=\"h-8 w-8 text-lg hover:bg-secondary\"\n                                            onClick={() => handleReaction(message.id, emoji)}\n                                            data-testid={`button-emoji-${emoji}`}\n                                          >\n                                            {emoji}\n                                          </Button>\n                                        ))}\n                                      </div>\n                                    </PopoverContent>\n                                  </Popover>\n                                  \n                                  {/* Pin button */}\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    className={cn(\n                                      \"h-6 w-6\",\n                                      pinnedMessages.some(m => m.id === message.id) \n                                        ? \"text-yellow-500 hover:text-yellow-600\" \n                                        : \"text-muted-foreground hover:text-yellow-500\"\n                                    )}\n                                    onClick={() => handlePinMessage(message)}\n                                    data-testid={`button-pin-${message.id}`}\n                                  >\n                                    <Pin className=\"w-3 h-3\" />\n                                  </Button>\n                                  \n                                  {/* Unsend button (own messages only) */}\n                                  {isOwnMessage && (\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"icon\"\n                                      className=\"h-6 w-6 text-muted-foreground hover:text-destructive\"\n                                      onClick={() => handleUnsendMessage(message.id)}\n                                      disabled={deleteMessageMutation.isPending}\n                                      data-testid={`button-unsend-${message.id}`}\n                                    >\n                                      <X className=\"w-3 h-3\" />\n                                    </Button>\n                                  )}\n                                </div>\n                              </div>\n                              \n                              {/* Reactions display with user details */}\n                              {groupedReactions.length > 0 && (\n                                <div className={cn(\"flex flex-wrap gap-1 mt-1\", isOwnMessage && \"justify-end\")}>\n                                  {groupedReactions.map(({ emoji, count, hasCurrentUser, users }) => (\n                                    <Popover key={emoji}>\n                                      <PopoverTrigger asChild>\n                                        <button\n                                          className={cn(\n                                            \"inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded-full text-xs transition-colors\",\n                                            hasCurrentUser \n                                              ? \"bg-primary/20 text-primary border border-primary/30\" \n                                              : \"bg-secondary hover:bg-secondary/80\"\n                                          )}\n                                          data-testid={`reaction-${emoji}-${message.id}`}\n                                        >\n                                          <span>{emoji}</span>\n                                          {count > 1 && <span className=\"text-[10px]\">{count}</span>}\n                                        </button>\n                                      </PopoverTrigger>\n                                      <PopoverContent className=\"w-48 p-2\" side=\"top\">\n                                        <div className=\"space-y-1\">\n                                          <p className=\"text-xs font-medium text-muted-foreground mb-2\">Reacted with {emoji}</p>\n                                          {users.map((userName, idx) => (\n                                            <div key={idx} className=\"flex items-center gap-2 text-sm\">\n                                              <Avatar className=\"w-5 h-5\">\n                                                <AvatarFallback className=\"text-[8px] bg-secondary\">\n                                                  {userName.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                                                </AvatarFallback>\n                                              </Avatar>\n                                              <span>{userName}</span>\n                                            </div>\n                                          ))}\n                                          <Button\n                                            variant=\"ghost\"\n                                            size=\"sm\"\n                                            className=\"w-full mt-2 text-xs\"\n                                            onClick={() => handleReaction(message.id, emoji)}\n                                          >\n                                            {hasCurrentUser ? 'Remove reaction' : 'Add reaction'}\n                                          </Button>\n                                        </div>\n                                      </PopoverContent>\n                                    </Popover>\n                                  ))}\n                                </div>\n                              )}\n                              \n                              {chatSettings.showTimestamps && (\n                                <p className={cn(\n                                  \"text-xs text-muted-foreground mt-1\",\n                                  isOwnMessage && \"text-right\"\n                                )}>\n                                  {format(new Date(message.createdAt), 'HH:mm')}\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                      <div ref={messagesEndRef} />\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center justify-center h-full text-muted-foreground\">\n                      <MessageCircle className=\"w-12 h-12 mb-2 opacity-50\" />\n                      <p>No messages yet</p>\n                      <p className=\"text-sm\">Send a message to start the conversation</p>\n                    </div>\n                  )}\n                </ScrollArea>\n              </CardContent>\n\n              {/* Message Input */}\n              <div className=\"p-4 border-t border-border\">\n                {/* Reply indicator */}\n                {replyToMessage && (\n                  <div className=\"flex items-center justify-between bg-secondary/50 rounded-lg px-3 py-2 mb-2\">\n                    <div className=\"flex items-center gap-2 text-sm\">\n                      <MessageCircle className=\"w-4 h-4 text-primary\" />\n                      <span className=\"text-muted-foreground\">Replying to</span>\n                      <span className=\"font-medium\">{replyToMessage.senderName}</span>\n                      <span className=\"text-muted-foreground truncate max-w-[200px]\">\n                        {replyToMessage.content.slice(0, 40)}{replyToMessage.content.length > 40 ? '...' : ''}\n                      </span>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-6 w-6\"\n                      onClick={() => setReplyToMessage(null)}\n                      data-testid=\"button-cancel-reply\"\n                    >\n                      <X className=\"w-3 h-3\" />\n                    </Button>\n                  </div>\n                )}\n                <div className=\"flex gap-2\">\n                  <input\n                    ref={fileInputRef}\n                    type=\"file\"\n                    className=\"hidden\"\n                    onChange={handleFileUpload}\n                    multiple\n                    accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp,.heic,.bmp,image/*\"\n                  />\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\"\n                    onClick={() => fileInputRef.current?.click()}\n                    data-testid=\"button-attach-file\"\n                  >\n                    <Paperclip className=\"w-4 h-4\" />\n                  </Button>\n                  \n                  {/* Emoji Picker */}\n                  <Popover>\n                    <PopoverTrigger asChild>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        data-testid=\"button-emoji-picker\"\n                      >\n                        <Smile className=\"w-4 h-4\" />\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-80 p-2\" align=\"start\">\n                      <div className=\"grid grid-cols-8 gap-1\">\n                        {['', '', '', '', '', '', '', '', \n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', '',\n                          '', '', '', '', '', '', '', ''].map((emoji) => (\n                          <button\n                            key={emoji}\n                            className=\"p-1.5 hover:bg-secondary rounded text-xl transition-colors\"\n                            onClick={() => {\n                              setMessageInput(prev => prev + emoji);\n                              inputRef.current?.focus();\n                            }}\n                            data-testid={`emoji-${emoji}`}\n                          >\n                            {emoji}\n                          </button>\n                        ))}\n                      </div>\n                    </PopoverContent>\n                  </Popover>\n                  \n                  {/* @ Mention Button */}\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\"\n                    onClick={() => {\n                      setMessageInput(prev => prev + '@');\n                      setShowMentionDropdown(true);\n                      setMentionQuery(\"\");\n                      setMentionStartIndex(messageInput.length);\n                      inputRef.current?.focus();\n                    }}\n                    data-testid=\"button-mention\"\n                  >\n                    <AtSign className=\"w-4 h-4\" />\n                  </Button>\n                  \n                  {/* Sticker Picker */}\n                  <Popover open={showStickerPicker} onOpenChange={setShowStickerPicker}>\n                    <PopoverTrigger asChild>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        data-testid=\"button-sticker-picker\"\n                      >\n                        <Sticker className=\"w-4 h-4\" />\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-72 p-3\" align=\"start\">\n                      <p className=\"text-sm font-medium mb-2\">Stickers</p>\n                      <div className=\"grid grid-cols-4 gap-2\">\n                        {STICKERS.map((sticker) => (\n                          <button\n                            key={sticker.id}\n                            className=\"p-3 hover:bg-secondary rounded-lg text-3xl transition-all hover:scale-110\"\n                            onClick={() => handleSendSticker(sticker)}\n                            title={sticker.label}\n                            data-testid={`sticker-${sticker.id}`}\n                          >\n                            {sticker.emoji}\n                          </button>\n                        ))}\n                      </div>\n                    </PopoverContent>\n                  </Popover>\n                  \n                  <div className=\"flex-1 relative\">\n                    <Input\n                      ref={inputRef}\n                      placeholder=\"Type a message...\"\n                      value={messageInput}\n                      onChange={handleMessageInputChange}\n                      onKeyDown={handleMentionKeyDown}\n                      className=\"w-full\"\n                      data-testid=\"input-message\"\n                    />\n                    \n                    {/* @ Mention Dropdown */}\n                    {showMentionDropdown && mentionableUsers.length > 0 && (\n                      <div className=\"absolute bottom-full left-0 mb-1 w-64 bg-card border border-border rounded-lg shadow-lg z-50 max-h-48 overflow-y-auto\">\n                        <div className=\"p-1\">\n                          <div className=\"px-2 py-1 text-xs text-muted-foreground\">\n                            Mention a team member\n                          </div>\n                          {mentionableUsers.map((user, index) => (\n                            <button\n                              key={user.id}\n                              className={cn(\n                                \"w-full flex items-center gap-2 p-2 rounded-md text-left transition-colors\",\n                                index === selectedMentionIndex ? \"bg-primary/10\" : \"hover:bg-secondary\"\n                              )}\n                              onClick={() => insertMention(user)}\n                              data-testid={`mention-user-${user.id}`}\n                            >\n                              <Avatar className=\"w-6 h-6\">\n                                <AvatarFallback className=\"bg-blue-500/20 text-blue-500 text-xs\">\n                                  {user.name.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div className=\"min-w-0\">\n                                <p className=\"text-sm font-medium truncate\">{user.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">{user.jobTitle || user.role}</p>\n                              </div>\n                            </button>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                  {/* Voice Message */}\n                  {!isRecording && !audioBlob ? (\n                    <Button \n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={startRecording}\n                      data-testid=\"button-start-recording\"\n                    >\n                      <Mic className=\"w-4 h-4\" />\n                    </Button>\n                  ) : isRecording ? (\n                    <div className=\"flex items-center gap-2 px-2 py-1 bg-red-500/10 rounded-lg\">\n                      <div className=\"w-2 h-2 bg-red-500 rounded-full animate-pulse\" />\n                      <span className=\"text-sm text-red-500 font-mono\">{formatRecordingTime(recordingTime)}</span>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-7 w-7 text-red-500\"\n                        onClick={stopRecording}\n                        data-testid=\"button-stop-recording\"\n                      >\n                        <Square className=\"w-3 h-3\" />\n                      </Button>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-7 w-7\"\n                        onClick={cancelRecording}\n                        data-testid=\"button-cancel-recording\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ) : audioBlob ? (\n                    <div className=\"flex items-center gap-2 px-2 py-1 bg-primary/10 rounded-lg\">\n                      <Volume2 className=\"w-4 h-4 text-primary\" />\n                      <span className=\"text-sm text-primary\">{formatRecordingTime(recordingTime)}</span>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-7 w-7 text-primary\"\n                        onClick={sendVoiceMessage}\n                        disabled={sendMessageMutation.isPending}\n                        data-testid=\"button-send-voice\"\n                      >\n                        <Send className=\"w-3 h-3\" />\n                      </Button>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-7 w-7\"\n                        onClick={cancelRecording}\n                        data-testid=\"button-discard-voice\"\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  ) : null}\n                  \n                  <Button \n                    onClick={handleSendMessage}\n                    disabled={!messageInput.trim() || sendMessageMutation.isPending}\n                    data-testid=\"button-send-message\"\n                  >\n                    {sendMessageMutation.isPending ? (\n                      <Loader2 className=\"w-4 h-4 animate-spin\" />\n                    ) : (\n                      <Send className=\"w-4 h-4\" />\n                    )}\n                  </Button>\n                </div>\n              </div>\n            </>\n          ) : (\n            <div className=\"flex flex-col items-center justify-center h-full text-muted-foreground\">\n              <MessageCircle className=\"w-16 h-16 mb-4 opacity-50\" />\n              <p className=\"text-lg font-medium\">Select a conversation</p>\n              <p className=\"text-sm\">Choose from your existing chats or start a new one</p>\n              <Button \n                variant=\"outline\" \n                className=\"mt-4\"\n                onClick={() => setShowNewChatModal(true)}\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                New Chat\n              </Button>\n            </div>\n          )}\n        </Card>\n      </div>\n\n      {/* New Chat Modal */}\n      <Dialog open={showNewChatModal} onOpenChange={(open) => { \n        setShowNewChatModal(open); \n        if (!open) setNewChatSearch(\"\"); \n      }}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>New Conversation</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"relative\">\n              <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search for a team member...\"\n                value={newChatSearch}\n                onChange={(e) => setNewChatSearch(e.target.value)}\n                className=\"pl-9 bg-secondary/50\"\n                data-testid=\"input-search-new-chat\"\n              />\n            </div>\n            <ScrollArea className=\"h-60\">\n              <div className=\"space-y-2\">\n                {availableUsers\n                  .filter(user => \n                    user.name.toLowerCase().includes(newChatSearch.toLowerCase()) ||\n                    user.email?.toLowerCase().includes(newChatSearch.toLowerCase()) ||\n                    user.role?.toLowerCase().includes(newChatSearch.toLowerCase())\n                  )\n                  .map(user => (\n                  <button\n                    key={user.id}\n                    onClick={() => handleCreateChat(user.id)}\n                    className=\"w-full p-3 rounded-lg flex items-center gap-3 hover:bg-secondary transition-colors\"\n                    data-testid={`select-user-${user.id}`}\n                  >\n                    <Avatar className=\"w-10 h-10\">\n                      <AvatarFallback className=\"bg-blue-500/20 text-blue-500 text-sm\">\n                        {user.name.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"text-left\">\n                      <p className=\"font-medium text-sm\">{user.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">{user.jobTitle || user.role}</p>\n                    </div>\n                  </button>\n                ))}\n                {availableUsers.filter(user => \n                  user.name.toLowerCase().includes(newChatSearch.toLowerCase()) ||\n                  user.email?.toLowerCase().includes(newChatSearch.toLowerCase()) ||\n                  user.role?.toLowerCase().includes(newChatSearch.toLowerCase())\n                ).length === 0 && (\n                  <p className=\"text-center text-sm text-muted-foreground py-4\">No users found</p>\n                )}\n              </div>\n            </ScrollArea>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* New Group Modal */}\n      <Dialog open={showNewGroupModal} onOpenChange={setShowNewGroupModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Group Chat</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"groupName\">Group Name</Label>\n              <Input\n                id=\"groupName\"\n                placeholder=\"Enter group name...\"\n                value={groupName}\n                onChange={(e) => setGroupName(e.target.value)}\n                data-testid=\"input-group-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Select Members ({selectedUsers.length} selected, need at least 2)</Label>\n              <ScrollArea className=\"h-48 border rounded-lg p-2\">\n                {availableUsers.map(user => {\n                  const isSelected = selectedUsers.includes(user.id);\n                  return (\n                    <label \n                      key={user.id} \n                      className={cn(\n                        \"flex items-center gap-3 p-2 rounded cursor-pointer\",\n                        isSelected ? \"bg-primary/10\" : \"hover:bg-secondary\"\n                      )}\n                      data-testid={`select-group-user-${user.id}`}\n                    >\n                      <Checkbox\n                        checked={isSelected}\n                        onCheckedChange={(checked) => {\n                          if (checked) {\n                            setSelectedUsers([...selectedUsers, user.id]);\n                          } else {\n                            setSelectedUsers(selectedUsers.filter(id => id !== user.id));\n                          }\n                        }}\n                        data-testid={`checkbox-group-user-${user.id}`}\n                      />\n                      <Avatar className=\"w-8 h-8\">\n                        <AvatarFallback className=\"bg-blue-500/20 text-blue-500 text-xs\">\n                          {user.name.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                        </AvatarFallback>\n                      </Avatar>\n                      <span className=\"text-sm\">{user.name}</span>\n                    </label>\n                  );\n                })}\n              </ScrollArea>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowNewGroupModal(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleCreateGroup}\n              disabled={!groupName.trim() || selectedUsers.length < 2 || createConversationMutation.isPending}\n              data-testid=\"button-create-group\"\n            >\n              {createConversationMutation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : null}\n              Create Group\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Chat Settings Sheet */}\n      <Sheet open={showSettingsSheet} onOpenChange={setShowSettingsSheet}>\n        <SheetContent className=\"w-[400px] sm:w-[540px]\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <Settings className=\"w-5 h-5\" />\n              Chat Settings\n            </SheetTitle>\n            <SheetDescription>\n              Customize your conversation preferences\n            </SheetDescription>\n          </SheetHeader>\n          \n          <div className=\"mt-6 space-y-6\">\n            {/* Conversation Name */}\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center gap-2\">\n                <Pencil className=\"w-4 h-4 text-muted-foreground\" />\n                <Label className=\"font-medium\">Conversation Name</Label>\n              </div>\n              <div className=\"flex gap-2\">\n                <Input\n                  value={newConversationName}\n                  onChange={(e) => setNewConversationName(e.target.value)}\n                  placeholder=\"Enter conversation name...\"\n                  data-testid=\"input-conversation-name\"\n                />\n                <Button \n                  onClick={handleUpdateConversationName}\n                  disabled={updateConversationMutation.isPending || !newConversationName.trim()}\n                  data-testid=\"button-save-name\"\n                >\n                  {updateConversationMutation.isPending ? (\n                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  ) : (\n                    <Check className=\"w-4 h-4\" />\n                  )}\n                </Button>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Display Settings */}\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Type className=\"w-4 h-4 text-muted-foreground\" />\n                <Label className=\"font-medium\">Display Settings</Label>\n              </div>\n              \n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"fontSize\" className=\"text-sm text-muted-foreground\">\n                    Font Size\n                  </Label>\n                  <Select \n                    value={chatSettings.fontSize} \n                    onValueChange={(value) => setChatSettings({ ...chatSettings, fontSize: value })}\n                  >\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-font-size\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"small\">Small</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"large\">Large</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm text-muted-foreground\">\n                    Show Timestamps\n                  </Label>\n                  <Switch\n                    checked={chatSettings.showTimestamps}\n                    onCheckedChange={(checked) => setChatSettings({ ...chatSettings, showTimestamps: checked })}\n                    data-testid=\"switch-timestamps\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"chatTheme\" className=\"text-sm text-muted-foreground\">\n                    Chat Background\n                  </Label>\n                  <Select \n                    value={chatSettings.chatTheme} \n                    onValueChange={(value: \"default\" | \"dark\" | \"light\" | \"gradient\" | \"ocean\" | \"forest\") => \n                      setChatSettings({ ...chatSettings, chatTheme: value })\n                    }\n                  >\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-chat-theme\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"default\">Default</SelectItem>\n                      <SelectItem value=\"dark\">Dark</SelectItem>\n                      <SelectItem value=\"light\">Light</SelectItem>\n                      <SelectItem value=\"gradient\">Gradient</SelectItem>\n                      <SelectItem value=\"ocean\">Ocean</SelectItem>\n                      <SelectItem value=\"forest\">Forest</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Notification Settings */}\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Bell className=\"w-4 h-4 text-muted-foreground\" />\n                <Label className=\"font-medium\">Notifications</Label>\n              </div>\n              \n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm text-muted-foreground\">\n                    Enable Notifications\n                  </Label>\n                  <Switch\n                    checked={chatSettings.notifications}\n                    onCheckedChange={(checked) => setChatSettings({ ...chatSettings, notifications: checked })}\n                    data-testid=\"switch-notifications\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm text-muted-foreground\">\n                    Sound Effects\n                  </Label>\n                  <Switch\n                    checked={chatSettings.soundEnabled}\n                    onCheckedChange={(checked) => setChatSettings({ ...chatSettings, soundEnabled: checked })}\n                    data-testid=\"switch-sound\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Conversation Info */}\n            {selectedConversation && (\n              <div className=\"space-y-3\">\n                <Label className=\"font-medium\">Conversation Info</Label>\n                <div className=\"bg-secondary/30 rounded-lg p-4 space-y-2\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Type</span>\n                    <span>{selectedConversation.isGroup ? \"Group Chat\" : \"Direct Message\"}</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Members</span>\n                    <span>{selectedConversation.members.length}</span>\n                  </div>\n                  {selectedConversation.isGroup && (\n                    <div className=\"pt-2\">\n                      <span className=\"text-sm text-muted-foreground\">Participants:</span>\n                      <div className=\"flex flex-wrap gap-2 mt-2\">\n                        {selectedConversation.members.map(member => (\n                          <Badge key={member.id} variant=\"secondary\" className=\"text-xs\">\n                            {member.name}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        </SheetContent>\n      </Sheet>\n      \n      {/* Media Gallery Sheet */}\n      <Sheet open={showMediaGallery} onOpenChange={setShowMediaGallery}>\n        <SheetContent className=\"w-[400px] sm:w-[540px]\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <ImageIcon className=\"w-5 h-5\" />\n              Media Gallery\n            </SheetTitle>\n            <SheetDescription>\n              View all shared media, files, and links\n            </SheetDescription>\n          </SheetHeader>\n          \n          <div className=\"mt-4\">\n            {/* Tabs for Media/Files/Links */}\n            <div className=\"flex gap-2 mb-4\">\n              <Button\n                variant={mediaGalleryTab === 'media' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setMediaGalleryTab('media')}\n                className=\"flex-1\"\n              >\n                <ImageIcon className=\"w-4 h-4 mr-1\" />\n                Media ({mediaItems.images.length})\n              </Button>\n              <Button\n                variant={mediaGalleryTab === 'files' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setMediaGalleryTab('files')}\n                className=\"flex-1\"\n              >\n                <FileText className=\"w-4 h-4 mr-1\" />\n                Files ({mediaItems.files.length})\n              </Button>\n              <Button\n                variant={mediaGalleryTab === 'links' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setMediaGalleryTab('links')}\n                className=\"flex-1\"\n              >\n                <Link className=\"w-4 h-4 mr-1\" />\n                Links ({mediaItems.links.length})\n              </Button>\n            </div>\n            \n            <ScrollArea className=\"h-[calc(100vh-200px)]\">\n              {mediaGalleryTab === 'media' && (\n                <div className=\"grid grid-cols-3 gap-2\">\n                  {mediaItems.images.length > 0 ? (\n                    mediaItems.images.map(msg => \n                      msg.attachments?.filter(a => a.type?.startsWith('image/')).map((att, idx) => (\n                        <div \n                          key={`${msg.id}-${idx}`}\n                          className=\"aspect-square rounded-lg overflow-hidden bg-secondary cursor-pointer hover:opacity-80 transition-opacity\"\n                          onClick={() => {\n                            if (att.url) window.open(att.url, '_blank');\n                          }}\n                        >\n                          <img \n                            src={att.url || ''} \n                            alt={att.filename || 'Image'} \n                            className=\"w-full h-full object-cover\"\n                          />\n                        </div>\n                      ))\n                    )\n                  ) : (\n                    <div className=\"col-span-3 text-center py-8 text-muted-foreground\">\n                      <ImageIcon className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p className=\"text-sm\">No images shared yet</p>\n                    </div>\n                  )}\n                </div>\n              )}\n              \n              {mediaGalleryTab === 'files' && (\n                <div className=\"space-y-2\">\n                  {mediaItems.files.length > 0 ? (\n                    mediaItems.files.map(msg =>\n                      msg.attachments?.filter(a => a.type && !a.type.startsWith('image/') && a.type !== 'sticker' && a.type !== 'audio/webm').map((att, idx) => (\n                        <div \n                          key={`${msg.id}-${idx}`}\n                          className=\"flex items-center gap-3 p-3 rounded-lg bg-secondary/50 hover:bg-secondary cursor-pointer transition-colors\"\n                          onClick={() => {\n                            if (att.url) {\n                              const link = document.createElement('a');\n                              link.href = att.url;\n                              link.download = att.filename || 'download';\n                              link.click();\n                            }\n                          }}\n                        >\n                          <File className=\"w-8 h-8 text-muted-foreground\" />\n                          <div className=\"min-w-0 flex-1\">\n                            <p className=\"text-sm font-medium truncate\">{att.filename}</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {att.size ? `${(att.size / 1024).toFixed(1)} KB` : 'Unknown size'}\n                            </p>\n                          </div>\n                          <Download className=\"w-4 h-4 text-muted-foreground\" />\n                        </div>\n                      ))\n                    )\n                  ) : (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <File className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p className=\"text-sm\">No files shared yet</p>\n                    </div>\n                  )}\n                </div>\n              )}\n              \n              {mediaGalleryTab === 'links' && (\n                <div className=\"space-y-2\">\n                  {mediaItems.links.length > 0 ? (\n                    mediaItems.links.map(({ message, url }, idx) => (\n                      <a \n                        key={`${message.id}-${idx}`}\n                        href={url}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"flex items-center gap-3 p-3 rounded-lg bg-secondary/50 hover:bg-secondary transition-colors\"\n                      >\n                        <Link className=\"w-8 h-8 text-blue-500\" />\n                        <div className=\"min-w-0 flex-1\">\n                          <p className=\"text-sm font-medium text-blue-500 truncate\">{url}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            Shared by {message.senderName}\n                          </p>\n                        </div>\n                      </a>\n                    ))\n                  ) : (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <Link className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p className=\"text-sm\">No links shared yet</p>\n                    </div>\n                  )}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n        </SheetContent>\n      </Sheet>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":87557,"size_tokens":null},"client/src/pages/employee/InvestorMatching.tsx":{"content":"import { useState, useCallback, useEffect, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { \n  Check, \n  X, \n  Building2,\n  Target,\n  Mail,\n  Phone,\n  Globe,\n  Heart,\n  Users\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing, useUpdateDeal, useInvestorMatches, useCreateInvestorMatch, useDeleteInvestorMatch, useAllInvestors } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { motion, useMotionValue, useTransform, PanInfo } from \"framer-motion\";\nimport type { TaggedInvestor } from \"@shared/schema\";\nimport { Link } from \"wouter\";\n\ntype InvestorData = {\n  id: string;\n  numericId: number;\n  name: string;\n  type: string;\n  focus: string;\n  checkSize: string;\n  matchScore: number;\n  tags: string[];\n  email: string;\n  phone: string;\n  website: string;\n};\n\nexport default function InvestorMatching() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: allDeals = [], isLoading } = useDealsListing();\n  const { data: investors = [], isLoading: stakeholdersLoading } = useAllInvestors();\n  const updateDeal = useUpdateDeal();\n  \n  const deals = allDeals.filter(deal => {\n    if (!currentUser?.id && !currentUser?.email && !currentUser?.name) return false;\n    const podTeam = (deal as any).podTeam || [];\n    return podTeam.some((member: any) => \n      (currentUser.id && member.userId === currentUser.id) ||\n      (currentUser.email && member.email === currentUser.email) ||\n      (currentUser.name && member.name === currentUser.name)\n    );\n  });\n  \n  const [dealCategory, setDealCategory] = useState<'Investment Banking' | 'Asset Management'>('Investment Banking');\n  const [selectedDeal, setSelectedDeal] = useState<string>('');\n  const [showContactModal, setShowContactModal] = useState<InvestorData | null>(null);\n  const [isAnimating, setIsAnimating] = useState(false);\n  \n  const { data: investorMatches = [] } = useInvestorMatches(selectedDeal || null);\n  const createMatch = useCreateInvestorMatch();\n  const deleteMatch = useDeleteInvestorMatch();\n  \n  const [rejectedInvestors, setRejectedInvestors] = useState<string[]>([]);\n  \n  // Convert investors to InvestorData format\n  // Use stakeholder's actual database ID for stable identification\n  const INVESTORS: InvestorData[] = useMemo(() => {\n    return investors.map((s, index) => ({\n        id: s.id,\n        numericId: index + 1,\n        name: s.name,\n        type: s.title || 'Investor',\n        focus: s.location || 'Diversified',\n        checkSize: s.notes?.match(/Check size: ([^|,]+)/)?.[1] || 'Flexible',\n        matchScore: s.isFavorite ? 95 : 80,\n        tags: s.notes?.match(/Tags: (.+)/)?.[1]?.split(', ') || [],\n        email: s.email || '',\n        phone: s.phone || '',\n        website: s.website || '',\n      }));\n  }, [investors]);\n  \n  const matchedInvestors = useMemo(() => {\n    const matchedIds = investorMatches\n      .filter(m => m.status === 'matched')\n      .map(m => m.investorId);\n    return INVESTORS.filter(inv => matchedIds.includes(inv.id));\n  }, [investorMatches, INVESTORS]);\n  \n  useEffect(() => {\n    if (selectedDeal) {\n      const rejectedIds = investorMatches\n        .filter(m => m.status === 'rejected')\n        .map(m => m.investorId);\n      setRejectedInvestors(rejectedIds);\n    } else {\n      setRejectedInvestors([]);\n    }\n  }, [selectedDeal, investorMatches]);\n  \n  const x = useMotionValue(0);\n  const rotate = useTransform(x, [-200, 200], [-25, 25]);\n  const opacity = useTransform(x, [-200, -100, 0, 100, 200], [0.5, 1, 1, 1, 0.5]);\n  const likeOpacity = useTransform(x, [0, 100], [0, 1]);\n  const nopeOpacity = useTransform(x, [-100, 0], [1, 0]);\n  \n  // Filter deals by category (with fallback for missing dealType)\n  const filteredDeals = useMemo(() => {\n    return deals.filter(deal => {\n      const dealType = (deal as any).dealType || 'Investment Banking';\n      if (dealCategory === 'Investment Banking') {\n        // Investment Banking includes M&A, Capital Raising, Debt Financing, IPO, etc.\n        return ['Investment Banking', 'M&A', 'Capital Raising', 'Debt Financing', 'IPO', 'Restructuring', 'Advisory'].includes(dealType);\n      }\n      return dealType === dealCategory;\n    });\n  }, [deals, dealCategory]);\n\n  // Set initial deal once data loads or when deals/category changes\n  useEffect(() => {\n    if (filteredDeals.length > 0) {\n      setSelectedDeal(filteredDeals[0].id);\n    } else {\n      setSelectedDeal('');\n    }\n  }, [filteredDeals.length, dealCategory]);\n\n  const availableInvestors = INVESTORS.filter(inv => \n    !matchedInvestors.some(m => m.id === inv.id) && \n    !rejectedInvestors.includes(inv.id)\n  );\n  const currentInvestor = availableInvestors[0];\n  const currentDeal = deals.find(d => d.id === selectedDeal);\n\n  const addInvestorToTaggedList = async (investor: InvestorData) => {\n    if (!selectedDeal) return;\n    \n    const latestDeal = deals.find(d => d.id === selectedDeal);\n    if (!latestDeal) return;\n    \n    const existingTagged = latestDeal.taggedInvestors || [];\n    \n    const alreadyExists = existingTagged.some(\n      (inv) => inv.name === investor.name && inv.firm === investor.name\n    );\n    \n    if (alreadyExists) {\n      return;\n    }\n    \n    const newTaggedInvestor: TaggedInvestor = {\n      id: crypto.randomUUID(),\n      name: investor.name,\n      firm: investor.name,\n      type: investor.type,\n      status: 'Contacted',\n      notes: `Check size: ${investor.checkSize}, Focus: ${investor.focus}`,\n      email: investor.email,\n      phone: investor.phone,\n      website: investor.website,\n    };\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal,\n        taggedInvestors: [...existingTagged, newTaggedInvestor],\n      });\n    } catch (error) {\n      console.error('Failed to add investor to deal:', error);\n    }\n  };\n\n  const handleSwipe = useCallback(async (direction: 'left' | 'right') => {\n    if (!currentInvestor || isAnimating || !selectedDeal) return;\n    \n    setIsAnimating(true);\n    \n    try {\n      if (direction === 'right') {\n        await createMatch.mutateAsync({\n          dealId: selectedDeal,\n          investorId: currentInvestor.id,\n          status: 'matched',\n        });\n        await addInvestorToTaggedList(currentInvestor);\n        toast.success(`Matched with ${currentInvestor.name}! Added to deal.`);\n      } else {\n        await createMatch.mutateAsync({\n          dealId: selectedDeal,\n          investorId: currentInvestor.id,\n          status: 'rejected',\n        });\n        toast.info(`Passed on ${currentInvestor.name}`);\n      }\n    } catch (error) {\n      console.error('Failed to save match:', error);\n      toast.error('Failed to save decision');\n    }\n    \n    x.set(0);\n    setIsAnimating(false);\n  }, [currentInvestor, isAnimating, selectedDeal, createMatch]);\n\n  const handleDragEnd = (event: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {\n    const threshold = 100;\n    if (info.offset.x > threshold) {\n      handleSwipe('right');\n    } else if (info.offset.x < -threshold) {\n      handleSwipe('left');\n    }\n  };\n\n  const handleContact = (investor: typeof INVESTORS[0]) => {\n    setShowContactModal(investor);\n  };\n\n  const handleSendEmail = () => {\n    if (showContactModal) {\n      const dealName = deals.find(d => d.id === selectedDeal)?.name || 'Investment Opportunity';\n      window.open(`mailto:${showContactModal.email}?subject=Investment Opportunity - ${dealName}`);\n      toast.success(\"Opening email client...\");\n      setShowContactModal(null);\n    }\n  };\n\n  const handleCallPhone = () => {\n    if (showContactModal) {\n      window.open(`tel:${showContactModal.phone}`);\n      toast.info(\"Initiating call...\");\n    }\n  };\n\n  const handleVisitWebsite = () => {\n    if (showContactModal) {\n      window.open(`https://${showContactModal.website}`, '_blank');\n      toast.info(\"Opening website...\");\n    }\n  };\n\n  const resetMatches = async () => {\n    if (!selectedDeal) return;\n    try {\n      const res = await fetch(`/api/investor-matches/${selectedDeal}`, { method: 'DELETE' });\n      if (!res.ok) throw new Error('Failed to reset matches');\n      setRejectedInvestors([]);\n      toast.info(\"Matches reset\");\n    } catch (error) {\n      console.error('Failed to reset matches:', error);\n      toast.error(\"Failed to reset matches\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role=\"Employee\" pageTitle=\"Investor Match Deck\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading...</div>\n        </div>\n      </Layout>\n    );\n  }\n  \n  return (\n    <Layout role=\"Employee\" pageTitle=\"Investor Match Deck\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Category and Deal Selector */}\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex gap-4 flex-1\">\n            <div className=\"w-48\">\n              <label className=\"text-xs font-medium text-muted-foreground mb-1.5 block\">Deal Type</label>\n              <select \n                  className=\"w-full bg-card border border-border rounded-md p-2 text-sm focus:ring-1 focus:ring-primary outline-none\"\n                  value={dealCategory}\n                  onChange={(e) => setDealCategory(e.target.value as 'Investment Banking' | 'Asset Management')}\n                  data-testid=\"select-deal-category\"\n              >\n                  <option value=\"Investment Banking\">Investment Banking</option>\n                  <option value=\"Asset Management\">Asset Management</option>\n              </select>\n            </div>\n            <div className=\"flex-1 max-w-md\">\n              <label className=\"text-xs font-medium text-muted-foreground mb-1.5 block\">Select Deal to Match</label>\n              <select \n                  className=\"w-full bg-card border border-border rounded-md p-2 text-sm focus:ring-1 focus:ring-primary outline-none\"\n                  value={selectedDeal}\n                  onChange={(e) => setSelectedDeal(e.target.value)}\n                  data-testid=\"select-deal\"\n              >\n                  {filteredDeals.length === 0 && (\n                    <option value=\"\">No {dealCategory} deals available</option>\n                  )}\n                  {filteredDeals.map(deal => (\n                      <option key={deal.id} value={deal.id}>{deal.name} - ${deal.value}M ({deal.sector})</option>\n                  ))}\n              </select>\n            </div>\n          </div>\n          <Button variant=\"outline\" size=\"sm\" onClick={resetMatches}>\n            Reset All\n          </Button>\n        </div>\n\n        {/* Tinder-style Match Interface */}\n        <div className=\"flex flex-col items-center justify-center py-6\">\n            {currentInvestor ? (\n              <div className=\"relative w-full max-w-lg aspect-[3/4] md:aspect-[4/3]\">\n                  {/* Background cards for stack effect */}\n                  {availableInvestors.length > 2 && (\n                    <motion.div \n                      className=\"absolute top-4 left-4 right-4 bottom-[-16px] bg-card/30 rounded-2xl border border-border z-0\"\n                      initial={{ scale: 0.92 }}\n                      animate={{ scale: 0.95 }}\n                      transition={{ duration: 0.3 }}\n                    />\n                  )}\n                  {availableInvestors.length > 1 && (\n                    <motion.div \n                      className=\"absolute top-2 left-2 right-2 bottom-[-8px] bg-card/60 rounded-2xl border border-border z-10\"\n                      initial={{ scale: 0.95 }}\n                      animate={{ scale: 0.98 }}\n                      transition={{ duration: 0.3 }}\n                    />\n                  )}\n                  \n                  {/* Main Draggable Card */}\n                  <motion.div\n                    className=\"absolute inset-0 z-20 cursor-grab active:cursor-grabbing\"\n                    drag=\"x\"\n                    dragConstraints={{ left: 0, right: 0 }}\n                    dragElastic={0.7}\n                    onDragEnd={handleDragEnd}\n                    style={{ x, rotate, opacity }}\n                    whileTap={{ scale: 1.02 }}\n                    data-testid=\"swipe-card\"\n                  >\n                    {/* Like/Nope Indicators */}\n                    <motion.div \n                      className=\"absolute top-8 right-8 z-30 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-xl rotate-12 border-4 border-green-400\"\n                      style={{ opacity: likeOpacity }}\n                    >\n                      <Heart className=\"w-6 h-6 inline mr-2\" />\n                      MATCH\n                    </motion.div>\n                    <motion.div \n                      className=\"absolute top-8 left-8 z-30 bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-xl -rotate-12 border-4 border-red-400\"\n                      style={{ opacity: nopeOpacity }}\n                    >\n                      PASS\n                    </motion.div>\n                    \n                    <Card className=\"h-full bg-card border-border shadow-2xl flex flex-col items-center justify-center text-center p-8 hover:shadow-primary/10 transition-all\">\n                      <div className=\"w-24 h-24 rounded-full bg-secondary flex items-center justify-center mb-6 shadow-inner\">\n                          <Building2 className=\"w-10 h-10 text-primary\" />\n                      </div>\n                      \n                      <h2 className=\"text-3xl font-display font-bold mb-2\">{currentInvestor.name}</h2>\n                      <Badge variant=\"secondary\" className=\"mb-4\">{currentInvestor.type}</Badge>\n                      \n                      <div className=\"grid grid-cols-2 gap-4 w-full max-w-xs mb-6\">\n                          <div className=\"text-center\">\n                              <div className=\"text-xs text-muted-foreground uppercase tracking-wider mb-1\">Focus</div>\n                              <div className=\"font-medium text-sm line-clamp-2 max-h-10 overflow-hidden\" title={currentInvestor.focus}>\n                                {currentInvestor.focus.split(',').slice(0, 3).join(', ')}{currentInvestor.focus.split(',').length > 3 ? '...' : ''}\n                              </div>\n                          </div>\n                          <div className=\"text-center\">\n                              <div className=\"text-xs text-muted-foreground uppercase tracking-wider mb-1\">Check Size</div>\n                              <div className=\"font-medium text-sm\">{currentInvestor.checkSize}</div>\n                          </div>\n                      </div>\n\n                      <div className=\"flex gap-2 mb-8\">\n                          {currentInvestor.tags.map(tag => (\n                              <Badge key={tag} variant=\"outline\" className=\"bg-secondary/30\">{tag}</Badge>\n                          ))}\n                      </div>\n\n                      <div className=\"w-full bg-secondary/30 rounded-full h-12 flex items-center px-4 mb-6 relative overflow-hidden\">\n                           <div \n                             className={cn(\n                               \"absolute left-0 top-0 h-full border-r-2\",\n                               currentInvestor.matchScore >= 90 ? \"bg-green-500/10 border-green-500\" :\n                               currentInvestor.matchScore >= 80 ? \"bg-yellow-500/10 border-yellow-500\" :\n                               \"bg-orange-500/10 border-orange-500\"\n                             )} \n                             style={{ width: `${currentInvestor.matchScore}%` }}\n                           ></div>\n                           <div className=\"relative z-10 flex justify-between w-full items-center\">\n                              <span className={cn(\n                                \"text-xs font-bold\",\n                                currentInvestor.matchScore >= 90 ? \"text-green-500\" :\n                                currentInvestor.matchScore >= 80 ? \"text-yellow-500\" :\n                                \"text-orange-500\"\n                              )}>\n                                {currentInvestor.matchScore}% MATCH SCORE\n                              </span>\n                              <Target className={cn(\n                                \"w-4 h-4\",\n                                currentInvestor.matchScore >= 90 ? \"text-green-500\" :\n                                currentInvestor.matchScore >= 80 ? \"text-yellow-500\" :\n                                \"text-orange-500\"\n                              )} />\n                           </div>\n                      </div>\n\n                      <p className=\"text-xs text-muted-foreground mb-4\">Drag card to swipe or use buttons below</p>\n\n                      <div className=\"flex items-center gap-8 w-full max-w-xs mt-auto\">\n                          <Button \n                            size=\"lg\" \n                            variant=\"outline\" \n                            className=\"flex-1 rounded-full h-14 border-2 border-red-500/20 text-red-500 hover:bg-red-500/10 hover:border-red-500\"\n                            onClick={() => handleSwipe('left')}\n                            disabled={isAnimating}\n                            data-testid=\"button-reject\"\n                          >\n                              <X className=\"w-6 h-6\" />\n                          </Button>\n                          <Button \n                            size=\"lg\" \n                            className=\"flex-1 rounded-full h-14 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/20\"\n                            onClick={() => handleSwipe('right')}\n                            disabled={isAnimating}\n                            data-testid=\"button-approve\"\n                          >\n                              <Check className=\"w-6 h-6\" />\n                          </Button>\n                      </div>\n                      \n                      <div className=\"flex justify-between w-full max-w-xs mt-4 text-[10px] text-muted-foreground uppercase tracking-widest\">\n                          <span>Pass</span>\n                          <span>Match</span>\n                      </div>\n                    </Card>\n                  </motion.div>\n              </div>\n            ) : INVESTORS.length === 0 ? (\n              <Card className=\"w-full max-w-lg p-12 text-center\">\n                <div className=\"w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto mb-4\">\n                  <Users className=\"w-8 h-8 text-blue-500\" />\n                </div>\n                <h3 className=\"text-xl font-bold mb-2\">No Investors Yet</h3>\n                <p className=\"text-muted-foreground mb-4\">\n                  Investors need to be added to the Stakeholder Directory before matching.\n                </p>\n              </Card>\n            ) : (\n              <Card className=\"w-full max-w-lg p-12 text-center\">\n                <div className=\"w-16 h-16 rounded-full bg-secondary flex items-center justify-center mx-auto mb-4\">\n                  <Check className=\"w-8 h-8 text-green-500\" />\n                </div>\n                <h3 className=\"text-xl font-bold mb-2\">All Caught Up!</h3>\n                <p className=\"text-muted-foreground mb-4\">You've reviewed all available investors for this deal.</p>\n                <Button onClick={resetMatches}>Review Again</Button>\n              </Card>\n            )}\n        </div>\n        \n        {/* Matched List */}\n        <Card className=\"bg-card border-border mt-8\">\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n                <CardTitle className=\"text-lg\">Matched Investors ({matchedInvestors.length})</CardTitle>\n                {matchedInvestors.length > 0 && (\n                  <Badge variant=\"secondary\">{matchedInvestors.length} matches</Badge>\n                )}\n            </CardHeader>\n            <CardContent>\n                {matchedInvestors.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    No matches yet. Swipe right on investors you want to connect with.\n                  </div>\n                ) : (\n                  <div className=\"space-y-2\">\n                      {matchedInvestors.map(inv => (\n                          <div key={inv.id} className=\"flex items-center justify-between p-3 rounded-lg border border-border/50 bg-secondary/10 hover:bg-secondary/20 transition-colors\">\n                              <div className=\"flex items-center gap-4\">\n                                  <div className=\"w-10 h-10 rounded bg-primary/10 flex items-center justify-center font-bold text-primary\">\n                                      {inv.name[0]}\n                                  </div>\n                                  <div>\n                                      <div className=\"font-medium\">{inv.name}</div>\n                                      <div className=\"text-xs text-muted-foreground\">{inv.type}  {inv.focus}</div>\n                                  </div>\n                              </div>\n                              <div className=\"flex items-center gap-4\">\n                                  <Badge className=\"bg-green-500/10 text-green-500 border-green-500/20\">{inv.matchScore}% Match</Badge>\n                                  <Button \n                                    size=\"sm\" \n                                    variant=\"outline\"\n                                    onClick={() => handleContact(inv)}\n                                    data-testid={`button-contact-${inv.id}`}\n                                  >\n                                    Contact\n                                  </Button>\n                              </div>\n                          </div>\n                      ))}\n                  </div>\n                )}\n            </CardContent>\n        </Card>\n      </div>\n\n      {/* Contact Modal */}\n      <Dialog open={!!showContactModal} onOpenChange={() => setShowContactModal(null)}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Contact {showContactModal?.name}</DialogTitle>\n          </DialogHeader>\n          {showContactModal && (\n            <div className=\"space-y-4 py-4\">\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleSendEmail}\n                data-testid=\"button-contact-email\"\n              >\n                <Mail className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Email</div>\n                  <div className=\"font-medium truncate\">{showContactModal.email}</div>\n                </div>\n              </button>\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleCallPhone}\n                data-testid=\"button-contact-phone\"\n              >\n                <Phone className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Phone</div>\n                  <div className=\"font-medium\">{showContactModal.phone}</div>\n                </div>\n              </button>\n              <button \n                type=\"button\"\n                className=\"w-full flex items-center gap-3 p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors text-left\"\n                onClick={handleVisitWebsite}\n                data-testid=\"button-contact-website\"\n              >\n                <Globe className=\"w-5 h-5 text-primary flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">Website</div>\n                  <div className=\"font-medium\">{showContactModal.website}</div>\n                </div>\n              </button>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowContactModal(null)}>Close</Button>\n            <Button onClick={handleSendEmail}>\n              <Mail className=\"w-4 h-4 mr-2\" /> Send Email\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n    </Layout>\n  );\n}\n","path":null,"size_bytes":24990,"size_tokens":null},"client/src/pages/auth/ResetPassword.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { toast } from \"sonner\";\nimport { Lock, CheckCircle, AlertCircle, Loader2 } from \"lucide-react\";\nimport logo from \"@assets/generated_images/abstract_minimalist_layer_icon_for_fintech_logo.png\";\n\nexport default function ResetPassword() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const token = new URLSearchParams(searchString).get('token');\n  \n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isVerifying, setIsVerifying] = useState(true);\n  const [isValidToken, setIsValidToken] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n\n  useEffect(() => {\n    const verifyToken = async () => {\n      if (!token) {\n        setIsVerifying(false);\n        return;\n      }\n\n      try {\n        const response = await fetch(`/api/auth/verify-reset-token?token=${token}`);\n        const data = await response.json();\n        setIsValidToken(data.valid);\n      } catch (error) {\n        setIsValidToken(false);\n      } finally {\n        setIsVerifying(false);\n      }\n    };\n\n    verifyToken();\n  }, [token]);\n\n  const handleResetPassword = async () => {\n    if (newPassword.length < 6) {\n      toast.error(\"Password must be at least 6 characters long\");\n      return;\n    }\n\n    if (newPassword !== confirmPassword) {\n      toast.error(\"Passwords do not match\");\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await fetch('/api/auth/reset-password', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ token, newPassword }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        setIsSuccess(true);\n        toast.success(\"Password reset successfully!\");\n      } else {\n        toast.error(data.error || \"Failed to reset password\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to reset password. Please try again.\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isVerifying) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-background to-secondary/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md border border-border/50 shadow-2xl\">\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-primary mb-4\" />\n            <p className=\"text-muted-foreground\">Verifying your reset link...</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!token || !isValidToken) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-background to-secondary/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md border border-border/50 shadow-2xl\">\n          <CardHeader className=\"text-center space-y-4\">\n            <div className=\"mx-auto w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center\">\n              <AlertCircle className=\"w-8 h-8 text-red-500\" />\n            </div>\n            <CardTitle className=\"text-xl\">Invalid or Expired Link</CardTitle>\n            <CardDescription>\n              This password reset link is invalid or has expired. Please request a new one.\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button \n              className=\"w-full\" \n              onClick={() => setLocation('/auth')}\n              data-testid=\"button-back-to-login\"\n            >\n              Back to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isSuccess) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-b from-background to-secondary/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md border border-border/50 shadow-2xl\">\n          <CardHeader className=\"text-center space-y-4\">\n            <div className=\"mx-auto w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center\">\n              <CheckCircle className=\"w-8 h-8 text-green-500\" />\n            </div>\n            <CardTitle className=\"text-xl\">Password Reset Complete</CardTitle>\n            <CardDescription>\n              Your password has been reset successfully. You can now log in with your new password.\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button \n              className=\"w-full\" \n              onClick={() => setLocation('/auth')}\n              data-testid=\"button-go-to-login\"\n            >\n              Go to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-background to-secondary/30 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md border border-border/50 shadow-2xl\">\n        <CardHeader className=\"text-center space-y-4\">\n          <div className=\"flex justify-center\">\n            <img \n              src={logo} \n              alt=\"Kronos Logo\" \n              className=\"w-16 h-16 object-contain\"\n            />\n          </div>\n          <div>\n            <CardTitle className=\"text-2xl font-bold tracking-tight flex items-center justify-center gap-2\">\n              <Lock className=\"w-5 h-5\" />\n              Reset Your Password\n            </CardTitle>\n            <CardDescription className=\"text-muted-foreground mt-2\">\n              Enter your new password below\n            </CardDescription>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <label htmlFor=\"new-password\" className=\"text-sm font-medium\">\n              New Password\n            </label>\n            <Input\n              id=\"new-password\"\n              type=\"password\"\n              placeholder=\"\"\n              value={newPassword}\n              onChange={(e) => setNewPassword(e.target.value)}\n              className=\"bg-secondary/50 border-border\"\n              data-testid=\"input-new-password\"\n            />\n          </div>\n          <div className=\"space-y-2\">\n            <label htmlFor=\"confirm-password\" className=\"text-sm font-medium\">\n              Confirm Password\n            </label>\n            <Input\n              id=\"confirm-password\"\n              type=\"password\"\n              placeholder=\"\"\n              value={confirmPassword}\n              onChange={(e) => setConfirmPassword(e.target.value)}\n              className=\"bg-secondary/50 border-border\"\n              data-testid=\"input-confirm-new-password\"\n            />\n          </div>\n          <Button \n            className=\"w-full\" \n            onClick={handleResetPassword}\n            disabled={isLoading}\n            data-testid=\"button-reset-password\"\n          >\n            {isLoading ? \"Resetting...\" : \"Reset Password\"}\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":7363,"size_tokens":null},"client/src/components/GridLayout.tsx":{"content":"import React from \"react\";\nimport GridLayout, { Layout, WidthProvider } from \"react-grid-layout\";\nimport \"react-grid-layout/css/styles.css\";\nimport \"react-resizable/css/styles.css\";\nimport { cn } from \"@/lib/utils\";\n\nconst ResponsiveGridLayout = WidthProvider(GridLayout);\n\ninterface DraggableGridLayoutProps {\n  children: React.ReactNode[];\n  layout: Layout[];\n  onLayoutChange: (layout: Layout[]) => void;\n  cols?: number;\n  rowHeight?: number;\n  className?: string;\n  isDraggable?: boolean;\n  isResizable?: boolean;\n  margin?: [number, number];\n  containerPadding?: [number, number];\n  compactType?: \"vertical\" | \"horizontal\" | null;\n}\n\nexport default function DraggableGridLayout({\n  children,\n  layout,\n  onLayoutChange,\n  cols = 12,\n  rowHeight = 30,\n  className = \"\",\n  isDraggable = true,\n  isResizable = true,\n  margin = [16, 16],\n  containerPadding = [0, 0],\n  compactType = \"vertical\",\n}: DraggableGridLayoutProps) {\n  return (\n    <ResponsiveGridLayout\n      className={cn(\"layout\", className)}\n      layout={layout}\n      cols={cols}\n      rowHeight={rowHeight}\n      onLayoutChange={onLayoutChange}\n      isDraggable={isDraggable}\n      isResizable={isResizable}\n      margin={margin}\n      containerPadding={containerPadding}\n      compactType={compactType}\n      useCSSTransforms={true}\n      draggableHandle=\".drag-handle\"\n      resizeHandles={[\"se\", \"sw\", \"ne\", \"nw\", \"e\", \"w\", \"n\", \"s\"]}\n    >\n      {children}\n    </ResponsiveGridLayout>\n  );\n}\n\nexport function DragHandle({ className = \"\" }: { className?: string }) {\n  return (\n    <div \n      className={cn(\n        \"drag-handle cursor-move opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-muted/50 rounded\",\n        className\n      )}\n    >\n      <svg \n        className=\"w-4 h-4 text-muted-foreground\"\n        viewBox=\"0 0 24 24\" \n        fill=\"currentColor\"\n      >\n        <path d=\"M8 6h2v2H8V6zm6 0h2v2h-2V6zM8 11h2v2H8v-2zm6 0h2v2h-2v-2zm-6 5h2v2H8v-2zm6 0h2v2h-2v-2z\" />\n      </svg>\n    </div>\n  );\n}\n","path":null,"size_bytes":1999,"size_tokens":null},"client/src/components/assistant/ReaperAssistant.tsx":{"content":"import { useState, useRef, useEffect, useCallback, useMemo } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { MessageCircle, X, Send, Plus, Trash2, ChevronLeft, Loader2, Bot, User, Sparkles, Paperclip, FileText, Download, Settings, Mic, MicOff, Volume2, VolumeX, Maximize2, Minimize2, Share2, Copy, Check, Pencil, Save } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { cn } from \"@/lib/utils\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { toast } from \"sonner\";\nimport { useCurrentUser, useUserPreferences, useSaveUserPreferences } from \"@/lib/api\";\nimport type { UserPreferences } from \"@shared/schema\";\n\ntype AssistantConversation = {\n  id: string;\n  userId: string;\n  title: string | null;\n  createdAt: string;\n  updatedAt: string;\n};\n\ntype AssistantAttachment = {\n  id: string;\n  filename: string;\n  url: string;\n  mimeType: string;\n  size: number;\n  uploadedAt: string;\n};\n\ntype AssistantMessage = {\n  id: string;\n  conversationId: string;\n  role: 'user' | 'assistant';\n  content: string;\n  attachments?: AssistantAttachment[];\n  context?: any;\n  createdAt: string;\n};\n\ntype WindowSize = 'compact' | 'normal' | 'expanded';\n\nconst WINDOW_SIZES: Record<WindowSize, { width: string; height: string }> = {\n  compact: { width: '350px', height: '500px' },\n  normal: { width: '400px', height: '600px' },\n  expanded: { width: '550px', height: '80vh' },\n};\n\nexport function ReaperAssistant() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [showConversations, setShowConversations] = useState(true);\n  const [activeConversationId, setActiveConversationId] = useState<string | null>(null);\n  const [inputValue, setInputValue] = useState(\"\");\n  const [isTyping, setIsTyping] = useState(false);\n  const [pendingFiles, setPendingFiles] = useState<AssistantAttachment[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  \n  // Settings state\n  const [showSettings, setShowSettings] = useState(false);\n  const [voiceEnabled, setVoiceEnabled] = useState(false);\n  const [textToSpeechEnabled, setTextToSpeechEnabled] = useState(false);\n  const [windowSize, setWindowSize] = useState<WindowSize>('normal');\n  const [responseStyle, setResponseStyle] = useState<'concise' | 'detailed' | 'technical'>('concise');\n  const [autoSuggest, setAutoSuggest] = useState(true);\n  const [soundNotifications, setSoundNotifications] = useState(true);\n  const [isListening, setIsListening] = useState(false);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n  const [showShareDialog, setShowShareDialog] = useState(false);\n  const [copiedToClipboard, setCopiedToClipboard] = useState(false);\n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [mentionIndex, setMentionIndex] = useState(0);\n  \n  // Conversation editing state\n  const [editingConversationId, setEditingConversationId] = useState<string | null>(null);\n  const [editingTitle, setEditingTitle] = useState(\"\");\n  const [showRenameDialog, setShowRenameDialog] = useState(false);\n  \n  // Get current user for role-based prompts\n  const { data: currentUser } = useCurrentUser();\n  const isAdmin = currentUser?.accessLevel === 'admin';\n  const queryClient = useQueryClient();\n  \n  // User preferences for persistence\n  const { data: userPrefs } = useUserPreferences();\n  const saveUserPrefs = useSaveUserPreferences();\n  const [prefsInitialized, setPrefsInitialized] = useState(false);\n  \n  // Load preferences on mount\n  useEffect(() => {\n    if (userPrefs && !prefsInitialized) {\n      const assistantSettings = (userPrefs?.settings as any)?.assistantSettings;\n      if (assistantSettings) {\n        setVoiceEnabled(assistantSettings.voiceEnabled ?? false);\n        setTextToSpeechEnabled(assistantSettings.textToSpeechEnabled ?? false);\n        setWindowSize(assistantSettings.windowSize ?? 'normal');\n        setResponseStyle(assistantSettings.responseStyle ?? 'concise');\n        setAutoSuggest(assistantSettings.autoSuggest ?? true);\n        setSoundNotifications(assistantSettings.soundNotifications ?? true);\n      }\n      setPrefsInitialized(true);\n    }\n  }, [userPrefs, prefsInitialized]);\n  \n  // Save preferences when they change\n  const saveAssistantPreferences = useCallback(() => {\n    if (!prefsInitialized) return;\n    \n    const freshPrefs = queryClient.getQueryData<UserPreferences>(['userPreferences']) || userPrefs;\n    const { id, userId, updatedAt, ...mutablePrefs } = (freshPrefs || {}) as any;\n    const existingSettings = (freshPrefs?.settings as any) || {};\n    \n    saveUserPrefs.mutate({\n      ...mutablePrefs,\n      settings: {\n        ...existingSettings,\n        assistantSettings: {\n          voiceEnabled,\n          textToSpeechEnabled,\n          windowSize,\n          responseStyle,\n          autoSuggest,\n          soundNotifications,\n        },\n      },\n    });\n  }, [prefsInitialized, userPrefs, queryClient, voiceEnabled, textToSpeechEnabled, windowSize, responseStyle, autoSuggest, soundNotifications, saveUserPrefs]);\n  \n  // Role-based quick prompts\n  const quickPrompts = useMemo(() => ({\n    actions: isAdmin ? [\n      { text: \"What deals need attention?\", icon: \"\" },\n      { text: \"Recommend next steps for...\", icon: \"\" },\n      { text: \"Find investors for...\", icon: \"\" },\n    ] : [\n      { text: \"Create a task for...\", icon: \"\" },\n      { text: \"Schedule a meeting with...\", icon: \"\" },\n      { text: \"What are my priorities today?\", icon: \"\" },\n    ],\n    insights: isAdmin ? [\n      { text: \"Pipeline overview\", icon: \"\" },\n      { text: \"Team workload summary\", icon: \"\" },\n      { text: \"Which deals are stalled?\", icon: \"\" },\n    ] : [\n      { text: \"What's overdue?\", icon: \"\" },\n      { text: \"My upcoming meetings\", icon: \"\" },\n      { text: \"My task summary\", icon: \"\" },\n    ],\n    documents: isAdmin ? [\n      { text: \"Generate a term sheet for...\", icon: \"\" },\n      { text: \"Draft an investor update for...\", icon: \"\" },\n      { text: \"Create a deal memo for...\", icon: \"\" },\n    ] : [\n      { text: \"Draft an NDA for...\", icon: \"\" },\n      { text: \"Create a due diligence checklist\", icon: \"\" },\n      { text: \"Draft an email for...\", icon: \"\" },\n    ],\n  }), [isAdmin]);\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLTextAreaElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const recognitionRef = useRef<any>(null);\n  \n  // Listen for custom event to open the assistant from sidebar\n  useEffect(() => {\n    const handleOpenAssistant = () => {\n      setIsOpen(true);\n    };\n    \n    window.addEventListener('openKronosAssistant', handleOpenAssistant);\n    return () => {\n      window.removeEventListener('openKronosAssistant', handleOpenAssistant);\n    };\n  }, []);\n  \n  // Initialize speech recognition (supports both webkit and standard)\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n    \n    const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n    if (!SpeechRecognition) return;\n    \n    recognitionRef.current = new SpeechRecognition();\n    recognitionRef.current.continuous = false;\n    recognitionRef.current.interimResults = true;\n    recognitionRef.current.lang = 'en-US';\n    \n    recognitionRef.current.onresult = (event: any) => {\n      const transcript = Array.from(event.results)\n        .map((result: any) => result[0].transcript)\n        .join('');\n      setInputValue(transcript);\n    };\n    \n    recognitionRef.current.onend = () => {\n      setIsListening(false);\n    };\n    \n    recognitionRef.current.onerror = (event: any) => {\n      console.error('Speech recognition error:', event.error);\n      setIsListening(false);\n      if (event.error === 'not-allowed') {\n        toast.error('Microphone access denied. Please allow microphone access in your browser settings.');\n      }\n    };\n  }, []);\n  \n  const toggleListening = useCallback(() => {\n    if (!recognitionRef.current) {\n      toast.error('Speech recognition is not supported in your browser');\n      return;\n    }\n    \n    if (isListening) {\n      recognitionRef.current.stop();\n      setIsListening(false);\n    } else {\n      recognitionRef.current.start();\n      setIsListening(true);\n      toast.success('Listening... Speak now');\n    }\n  }, [isListening]);\n  \n  const stopSpeaking = useCallback(() => {\n    if (typeof window !== 'undefined' && 'speechSynthesis' in window) {\n      window.speechSynthesis.cancel();\n      setIsSpeaking(false);\n    }\n  }, []);\n  \n  const speakText = useCallback((text: string) => {\n    if (typeof window === 'undefined') return;\n    if (!textToSpeechEnabled || !('speechSynthesis' in window)) return;\n    \n    // Stop any ongoing speech\n    window.speechSynthesis.cancel();\n    \n    const utterance = new SpeechSynthesisUtterance(text);\n    utterance.rate = 1;\n    utterance.pitch = 1;\n    utterance.volume = 1;\n    \n    utterance.onstart = () => setIsSpeaking(true);\n    utterance.onend = () => setIsSpeaking(false);\n    utterance.onerror = () => setIsSpeaking(false);\n    \n    window.speechSynthesis.speak(utterance);\n  }, [textToSpeechEnabled]);\n  \n  // Cancel speech when TTS is disabled\n  useEffect(() => {\n    if (!textToSpeechEnabled && isSpeaking) {\n      stopSpeaking();\n    }\n  }, [textToSpeechEnabled, isSpeaking, stopSpeaking]);\n  \n  const cycleWindowSize = useCallback(() => {\n    setWindowSize(prev => {\n      if (prev === 'compact') return 'normal';\n      if (prev === 'normal') return 'expanded';\n      return 'compact';\n    });\n  }, []);\n\n  const { data: conversations = [], isLoading: conversationsLoading } = useQuery<AssistantConversation[]>({\n    queryKey: [\"/api/assistant/conversations\"],\n    enabled: isOpen,\n  });\n\n  // Query team members for @ mentions\n  const { data: teamMembers = [] } = useQuery<{ id: string; name: string; role: string }[]>({\n    queryKey: [\"/api/users\"],\n    enabled: isOpen,\n    select: (data: any[]) => data.filter((u: any) => u.id !== currentUser?.id).map((u: any) => ({\n      id: u.id,\n      name: u.name,\n      role: u.role || 'Team Member',\n    })),\n  });\n\n  // Filter team members based on mention query\n  const filteredMentions = useMemo(() => {\n    if (!mentionQuery) return teamMembers.slice(0, 5);\n    return teamMembers\n      .filter(m => m.name.toLowerCase().includes(mentionQuery.toLowerCase()))\n      .slice(0, 5);\n  }, [teamMembers, mentionQuery]);\n\n  // Handle input change for @ mentions\n  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    setInputValue(value);\n    \n    // Check for @ mentions\n    const cursorPos = e.target.selectionStart || 0;\n    const textBeforeCursor = value.slice(0, cursorPos);\n    const mentionMatch = textBeforeCursor.match(/@(\\w*)$/);\n    \n    if (mentionMatch) {\n      setShowMentions(true);\n      setMentionQuery(mentionMatch[1]);\n      setMentionIndex(0);\n    } else {\n      setShowMentions(false);\n      setMentionQuery(\"\");\n    }\n  }, []);\n\n  // Track pending mentions with their user IDs - keyed by unique mention token\n  const [pendingMentions, setPendingMentions] = useState<Map<string, { userId: string; userName: string }>>(new Map());\n\n  // Insert mention into input\n  const insertMention = useCallback((member: { id: string; name: string }) => {\n    const cursorPos = inputRef.current?.selectionStart || inputValue.length;\n    const textBeforeCursor = inputValue.slice(0, cursorPos);\n    const textAfterCursor = inputValue.slice(cursorPos);\n    \n    // Replace the @query with @[name:id] (embed ID to ensure uniqueness)\n    const mentionMatch = textBeforeCursor.match(/@(\\w*)$/);\n    if (mentionMatch) {\n      const newTextBefore = textBeforeCursor.slice(0, -mentionMatch[0].length);\n      const mentionToken = `@[${member.name}:${member.id}]`;\n      const newValue = `${newTextBefore}${mentionToken} ${textAfterCursor}`;\n      setInputValue(newValue);\n      \n      // Track this mention with its user ID - key by ID for uniqueness\n      setPendingMentions(prev => {\n        const updated = new Map(prev);\n        updated.set(member.id, { userId: member.id, userName: member.name });\n        return updated;\n      });\n    }\n    \n    setShowMentions(false);\n    setMentionQuery(\"\");\n    inputRef.current?.focus();\n  }, [inputValue]);\n\n  // Handle keyboard navigation for mentions\n  const handleMentionKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (!showMentions || filteredMentions.length === 0) return;\n    \n    if (e.key === 'ArrowDown') {\n      e.preventDefault();\n      setMentionIndex(prev => (prev + 1) % filteredMentions.length);\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault();\n      setMentionIndex(prev => (prev - 1 + filteredMentions.length) % filteredMentions.length);\n    } else if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      insertMention(filteredMentions[mentionIndex]);\n    } else if (e.key === 'Escape') {\n      setShowMentions(false);\n    }\n  }, [showMentions, filteredMentions, mentionIndex, insertMention]);\n\n  // State to track if we need to create a conversation (used by useEffect below)\n  const [shouldCreateConversation, setShouldCreateConversation] = useState(false);\n  // Track if we just deleted a conversation to prevent auto-create\n  const [justDeleted, setJustDeleted] = useState(false);\n\n  const { data: messages = [], isLoading: messagesLoading } = useQuery<AssistantMessage[]>({\n    queryKey: [`/api/assistant/conversations/${activeConversationId}/messages`],\n    enabled: !!activeConversationId,\n  });\n\n  const generateConversationSummary = useCallback(() => {\n    if (messages.length === 0) return '';\n    \n    const summary = messages.map(msg => {\n      const role = msg.role === 'user' ? 'You' : 'Kronos';\n      return `**${role}:** ${msg.content}`;\n    }).join('\\n\\n---\\n\\n');\n    \n    const activeConv = conversations.find(c => c.id === activeConversationId);\n    const header = `# Kronos AI Assistant - Conversation Summary\\n\\n**Topic:** ${activeConv?.title || 'Conversation'}\\n**Date:** ${new Date().toLocaleDateString()}\\n\\n---\\n\\n`;\n    \n    return header + summary;\n  }, [messages, conversations, activeConversationId]);\n  \n  const copyConversationToClipboard = useCallback(async () => {\n    const summary = generateConversationSummary();\n    try {\n      await navigator.clipboard.writeText(summary);\n      setCopiedToClipboard(true);\n      toast.success('Conversation copied to clipboard');\n      setTimeout(() => setCopiedToClipboard(false), 2000);\n    } catch (err) {\n      toast.error('Failed to copy to clipboard');\n    }\n  }, [generateConversationSummary]);\n\n  const exportToPDF = useCallback(async () => {\n    try {\n      const jsPDF = (await import('jspdf')).default;\n      const doc = new jsPDF();\n      \n      const activeConv = conversations.find(c => c.id === activeConversationId);\n      const title = activeConv?.title || 'Kronos Conversation';\n      \n      // Set up document\n      doc.setFontSize(18);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Kronos AI Assistant', 20, 20);\n      \n      doc.setFontSize(12);\n      doc.setFont('helvetica', 'normal');\n      doc.text(`Topic: ${title}`, 20, 30);\n      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 38);\n      doc.text(`Exported by: ${currentUser?.name || 'User'}`, 20, 46);\n      \n      // Draw separator line\n      doc.setDrawColor(200);\n      doc.line(20, 52, 190, 52);\n      \n      let yPosition = 62;\n      const pageHeight = 280;\n      const lineHeight = 6;\n      const maxWidth = 170;\n      \n      for (const msg of messages) {\n        const role = msg.role === 'user' ? 'You' : 'Kronos';\n        \n        // Check if we need a new page\n        if (yPosition > pageHeight - 30) {\n          doc.addPage();\n          yPosition = 20;\n        }\n        \n        // Role header\n        doc.setFont('helvetica', 'bold');\n        doc.setFontSize(10);\n        doc.setTextColor(msg.role === 'user' ? 70 : 30, 100, 170);\n        doc.text(`${role}:`, 20, yPosition);\n        yPosition += lineHeight;\n        \n        // Message content\n        doc.setFont('helvetica', 'normal');\n        doc.setFontSize(10);\n        doc.setTextColor(60, 60, 60);\n        \n        // Clean up markdown formatting for PDF\n        const cleanContent = msg.content\n          .replace(/\\*\\*/g, '')\n          .replace(/\\*/g, '')\n          .replace(/#{1,6}\\s/g, '')\n          .replace(/```[\\s\\S]*?```/g, '[Code Block]');\n        \n        const lines = doc.splitTextToSize(cleanContent, maxWidth);\n        for (const line of lines) {\n          if (yPosition > pageHeight - 20) {\n            doc.addPage();\n            yPosition = 20;\n          }\n          doc.text(line, 20, yPosition);\n          yPosition += lineHeight;\n        }\n        \n        yPosition += lineHeight; // Space between messages\n      }\n      \n      // Footer\n      const pageCount = doc.getNumberOfPages();\n      for (let i = 1; i <= pageCount; i++) {\n        doc.setPage(i);\n        doc.setFontSize(8);\n        doc.setTextColor(150);\n        doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });\n        doc.text('Equiturn - Kronos Platform', 105, 295, { align: 'center' });\n      }\n      \n      // Download the PDF\n      doc.save(`kronos-conversation-${new Date().toISOString().slice(0, 10)}.pdf`);\n      toast.success('PDF exported successfully');\n    } catch (err) {\n      console.error('PDF export error:', err);\n      toast.error('Failed to export PDF');\n    }\n  }, [messages, conversations, activeConversationId, currentUser]);\n\n  const createConversation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/assistant/conversations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ title: \"New Conversation\" }),\n      });\n      if (!response.ok) throw new Error(\"Failed to create conversation\");\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/assistant/conversations\"] });\n      setActiveConversationId(data.id);\n      setShowConversations(false);\n      setShouldCreateConversation(false);\n    },\n  });\n\n  // Auto-select most recent conversation or create new one when opening\n  useEffect(() => {\n    // Don't auto-create if we just deleted a conversation\n    if (justDeleted) return;\n    \n    if (isOpen && !conversationsLoading && !activeConversationId && !createConversation.isPending) {\n      if (conversations.length > 0) {\n        setActiveConversationId(conversations[0].id);\n        setShowConversations(false);\n      } else {\n        // No conversations exist, create one automatically\n        setShouldCreateConversation(true);\n      }\n    }\n  }, [isOpen, conversationsLoading, conversations, activeConversationId, createConversation.isPending, justDeleted]);\n\n  // Handle the actual creation after state is set (to avoid hoisting issues)\n  useEffect(() => {\n    if (shouldCreateConversation && !createConversation.isPending) {\n      createConversation.mutate();\n    }\n  }, [shouldCreateConversation, createConversation.isPending]);\n\n  const sendMessage = useMutation({\n    mutationFn: async ({ content, attachments, mentions }: { \n      content: string; \n      attachments?: AssistantAttachment[];\n      mentions?: { userId: string; userName: string; notified: boolean }[];\n    }) => {\n      if (!activeConversationId) throw new Error(\"No active conversation\");\n      const response = await fetch(`/api/assistant/conversations/${activeConversationId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ content, attachments, mentions }),\n      });\n      if (!response.ok) throw new Error(\"Failed to send message\");\n      return response.json();\n    },\n    onMutate: () => {\n      setIsTyping(true);\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [`/api/assistant/conversations/${activeConversationId}/messages`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/assistant/conversations\"] });\n      setInputValue(\"\");\n      setPendingFiles([]);\n      // Speak the assistant's response if text-to-speech is enabled\n      if (data?.assistantMessage?.content && textToSpeechEnabled) {\n        speakText(data.assistantMessage.content);\n      }\n    },\n    onSettled: () => {\n      setIsTyping(false);\n    },\n  });\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n\n    setIsUploading(true);\n    const newAttachments: AssistantAttachment[] = [];\n\n    for (const file of Array.from(files)) {\n      try {\n        const formData = new FormData();\n        formData.append('file', file);\n\n        const response = await fetch('/api/upload', {\n          method: 'POST',\n          credentials: 'include',\n          body: formData,\n        });\n\n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Upload failed');\n        }\n\n        const data = await response.json();\n        newAttachments.push({\n          id: data.id,\n          filename: data.filename,\n          url: data.url,\n          mimeType: data.type,\n          size: data.size,\n          uploadedAt: data.uploadedAt,\n        });\n      } catch (error: any) {\n        toast.error(`Failed to upload ${file.name}: ${error.message}`);\n      }\n    }\n\n    if (newAttachments.length > 0) {\n      setPendingFiles(prev => [...prev, ...newAttachments]);\n      toast.success(`${newAttachments.length} file(s) attached`);\n    }\n\n    setIsUploading(false);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  };\n\n  const removePendingFile = (fileId: string) => {\n    setPendingFiles(prev => prev.filter(f => f.id !== fileId));\n  };\n\n  const deleteConversation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/assistant/conversations/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete conversation\");\n      return { deletedId: id };\n    },\n    onSuccess: (data) => {\n      setJustDeleted(true);\n      queryClient.invalidateQueries({ queryKey: [\"/api/assistant/conversations\"] });\n      if (activeConversationId === data.deletedId) {\n        setActiveConversationId(null);\n        setShowConversations(true);\n      }\n      toast.success(\"Conversation deleted\");\n      // Reset justDeleted after a short delay\n      setTimeout(() => setJustDeleted(false), 1000);\n    },\n  });\n  \n  const renameConversation = useMutation({\n    mutationFn: async ({ id, title }: { id: string; title: string }) => {\n      const response = await fetch(`/api/assistant/conversations/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ title }),\n      });\n      if (!response.ok) throw new Error(\"Failed to rename conversation\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/assistant/conversations\"] });\n      setShowRenameDialog(false);\n      setEditingConversationId(null);\n      setEditingTitle(\"\");\n      toast.success(\"Conversation renamed\");\n    },\n    onError: () => {\n      toast.error(\"Failed to rename conversation\");\n    },\n  });\n\n  useEffect(() => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [messages, isTyping]);\n\n  useEffect(() => {\n    if (isOpen && !showConversations && inputRef.current) {\n      inputRef.current.focus();\n    }\n  }, [isOpen, showConversations]);\n\n  const handleSend = () => {\n    if ((!inputValue.trim() && pendingFiles.length === 0) || sendMessage.isPending) return;\n    \n    // Build message content with file references for AI context\n    let messageContent = inputValue.trim();\n    if (pendingFiles.length > 0) {\n      const fileInfo = pendingFiles.map(f => `[Attached file: ${f.filename} (${f.url})]`).join('\\n');\n      messageContent = messageContent ? `${messageContent}\\n\\n${fileInfo}` : fileInfo;\n    }\n    \n    // Extract @ mentions from the message - pattern: @[Name:userId]\n    const mentionMatches = messageContent.match(/@\\[([^:\\]]+):([^\\]]+)\\]/g) || [];\n    const mentions = mentionMatches\n      .map(match => {\n        // Parse @[Name:userId] format\n        const innerMatch = match.match(/@\\[([^:\\]]+):([^\\]]+)\\]/);\n        if (innerMatch) {\n          const [, name, userId] = innerMatch;\n          return { userId, userName: name, notified: false };\n        }\n        return null;\n      })\n      .filter((m): m is { userId: string; userName: string; notified: boolean } => m !== null);\n    \n    // Clean up the message content: replace @[Name:id] with @Name for display\n    const cleanedContent = messageContent.replace(/@\\[([^:\\]]+):[^\\]]+\\]/g, '@$1');\n    \n    sendMessage.mutate({ \n      content: cleanedContent,\n      attachments: pendingFiles.length > 0 ? pendingFiles : undefined,\n      mentions: mentions.length > 0 ? mentions : undefined,\n    });\n    \n    // Clear pending mentions after sending\n    setPendingMentions(new Map());\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  const startNewChat = () => {\n    createConversation.mutate();\n  };\n\n  const selectConversation = (id: string) => {\n    setActiveConversationId(id);\n    setShowConversations(false);\n  };\n\n  const formatMessageContent = (content: string) => {\n    const lines = content.split('\\n');\n    return lines.map((line, i) => {\n      if (line.startsWith('# ')) {\n        return <h3 key={i} className=\"text-base font-semibold mt-2 mb-1\">{line.slice(2)}</h3>;\n      }\n      if (line.startsWith('## ')) {\n        return <h4 key={i} className=\"text-sm font-semibold mt-2 mb-1\">{line.slice(3)}</h4>;\n      }\n      if (line.startsWith('### ')) {\n        return <h5 key={i} className=\"text-sm font-medium mt-1 mb-0.5\">{line.slice(4)}</h5>;\n      }\n      if (line.startsWith('- ') || line.startsWith('* ')) {\n        return <li key={i} className=\"ml-4 text-sm\">{line.slice(2)}</li>;\n      }\n      if (line.match(/^\\d+\\. /)) {\n        return <li key={i} className=\"ml-4 text-sm list-decimal\">{line.replace(/^\\d+\\. /, '')}</li>;\n      }\n      if (line.startsWith('**') && line.endsWith('**')) {\n        return <p key={i} className=\"text-sm font-semibold\">{line.slice(2, -2)}</p>;\n      }\n      if (line.trim() === '') {\n        return <br key={i} />;\n      }\n      return <p key={i} className=\"text-sm\">{line}</p>;\n    });\n  };\n\n  const currentSize = WINDOW_SIZES[windowSize];\n  \n  return (\n    <>\n      {/* Share Dialog */}\n      <Dialog open={showShareDialog} onOpenChange={setShowShareDialog}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle>Share Conversation</DialogTitle>\n            <DialogDescription>Copy or share this conversation summary with your team</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"bg-secondary/30 rounded-lg p-3 max-h-[300px] overflow-y-auto\">\n              <pre className=\"text-xs whitespace-pre-wrap font-mono\">\n                {generateConversationSummary()}\n              </pre>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={copyConversationToClipboard}\n                className=\"flex-1 gap-2\"\n                variant=\"outline\"\n                data-testid=\"button-copy-conversation\"\n              >\n                {copiedToClipboard ? (\n                  <>\n                    <Check className=\"w-4 h-4\" />\n                    Copied!\n                  </>\n                ) : (\n                  <>\n                    <Copy className=\"w-4 h-4\" />\n                    Copy\n                  </>\n                )}\n              </Button>\n              <Button\n                onClick={exportToPDF}\n                className=\"flex-1 gap-2\"\n                data-testid=\"button-export-pdf\"\n              >\n                <Download className=\"w-4 h-4\" />\n                Export PDF\n              </Button>\n            </div>\n            <p className=\"text-xs text-muted-foreground text-center\">\n              Copy to clipboard or download as a formatted PDF document.\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Settings Dialog */}\n      <Dialog open={showSettings} onOpenChange={setShowSettings}>\n        <DialogContent className=\"sm:max-w-[450px]\">\n          <DialogHeader>\n            <DialogTitle>Kronos Settings</DialogTitle>\n            <DialogDescription>Configure your AI assistant preferences</DialogDescription>\n          </DialogHeader>\n          <Tabs defaultValue=\"general\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"general\">General</TabsTrigger>\n              <TabsTrigger value=\"voice\">Voice</TabsTrigger>\n              <TabsTrigger value=\"display\">Display</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"general\" className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Response Style</Label>\n                <Select value={responseStyle} onValueChange={(v) => setResponseStyle(v as any)}>\n                  <SelectTrigger data-testid=\"select-response-style\">\n                    <SelectValue placeholder=\"Select style\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"concise\">Concise - Brief, to-the-point answers</SelectItem>\n                    <SelectItem value=\"detailed\">Detailed - Comprehensive explanations</SelectItem>\n                    <SelectItem value=\"technical\">Technical - Include technical details</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"auto-suggest\">Auto-Suggest</Label>\n                  <p className=\"text-xs text-muted-foreground\">Show suggested prompts on new conversations</p>\n                </div>\n                <Switch\n                  id=\"auto-suggest\"\n                  checked={autoSuggest}\n                  onCheckedChange={setAutoSuggest}\n                  data-testid=\"switch-auto-suggest\"\n                />\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"sound-notifications\">Sound Notifications</Label>\n                  <p className=\"text-xs text-muted-foreground\">Play sound when receiving responses</p>\n                </div>\n                <Switch\n                  id=\"sound-notifications\"\n                  checked={soundNotifications}\n                  onCheckedChange={setSoundNotifications}\n                  data-testid=\"switch-sound-notifications\"\n                />\n              </div>\n            </TabsContent>\n            \n            <TabsContent value=\"voice\" className=\"space-y-4 py-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"voice-input\">Voice Input</Label>\n                  <p className=\"text-xs text-muted-foreground\">Use microphone to speak to Kronos</p>\n                </div>\n                <Switch\n                  id=\"voice-input\"\n                  checked={voiceEnabled}\n                  onCheckedChange={setVoiceEnabled}\n                  data-testid=\"switch-voice-input\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"text-to-speech\">Text-to-Speech</Label>\n                  <p className=\"text-xs text-muted-foreground\">Have Kronos read responses aloud</p>\n                </div>\n                <Switch\n                  id=\"text-to-speech\"\n                  checked={textToSpeechEnabled}\n                  onCheckedChange={setTextToSpeechEnabled}\n                  data-testid=\"switch-text-to-speech\"\n                />\n              </div>\n              <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                <p className=\"text-xs text-muted-foreground\">\n                  Voice features use your browser's built-in speech recognition and synthesis. \n                  Availability may vary by browser.\n                </p>\n              </div>\n            </TabsContent>\n            \n            <TabsContent value=\"display\" className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Window Size</Label>\n                <div className=\"flex gap-2\">\n                  {(['compact', 'normal', 'expanded'] as WindowSize[]).map((size) => (\n                    <Button\n                      key={size}\n                      variant={windowSize === size ? 'default' : 'outline'}\n                      size=\"sm\"\n                      onClick={() => setWindowSize(size)}\n                      className=\"flex-1 capitalize\"\n                      data-testid={`button-size-${size}`}\n                    >\n                      {size}\n                    </Button>\n                  ))}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Choose how large the assistant window appears\n                </p>\n              </div>\n            </TabsContent>\n          </Tabs>\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowSettings(false)}>\n              Cancel\n            </Button>\n            <Button onClick={() => {\n              saveAssistantPreferences();\n              setShowSettings(false);\n              toast.success(\"Settings saved\");\n            }}>\n              <Save className=\"w-4 h-4 mr-2\" />\n              Save Settings\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Rename Conversation Dialog */}\n      <Dialog open={showRenameDialog} onOpenChange={setShowRenameDialog}>\n        <DialogContent className=\"sm:max-w-[400px]\">\n          <DialogHeader>\n            <DialogTitle>Rename Conversation</DialogTitle>\n            <DialogDescription>Give this conversation a descriptive name</DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Label htmlFor=\"conversation-name\">Conversation Name</Label>\n            <Input\n              id=\"conversation-name\"\n              value={editingTitle}\n              onChange={(e) => setEditingTitle(e.target.value)}\n              placeholder=\"Enter a name...\"\n              className=\"mt-2\"\n              data-testid=\"input-conversation-name\"\n              onKeyDown={(e) => {\n                if (e.key === 'Enter' && editingTitle.trim() && editingConversationId) {\n                  renameConversation.mutate({ id: editingConversationId, title: editingTitle.trim() });\n                }\n              }}\n            />\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => {\n              setShowRenameDialog(false);\n              setEditingConversationId(null);\n              setEditingTitle(\"\");\n            }}>\n              Cancel\n            </Button>\n            <Button \n              onClick={() => {\n                if (editingConversationId && editingTitle.trim()) {\n                  renameConversation.mutate({ id: editingConversationId, title: editingTitle.trim() });\n                }\n              }}\n              disabled={!editingTitle.trim() || renameConversation.isPending}\n            >\n              {renameConversation.isPending ? (\n                <Loader2 className=\"w-4 h-4 animate-spin\" />\n              ) : (\n                \"Save\"\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      <AnimatePresence>\n        {isOpen && (\n          <motion.div\n            initial={{ opacity: 0, y: 20, scale: 0.95 }}\n            animate={{ opacity: 1, y: 0, scale: 1 }}\n            exit={{ opacity: 0, y: 20, scale: 0.95 }}\n            transition={{ duration: 0.2 }}\n            style={{ width: currentSize.width, height: currentSize.height }}\n            className=\"fixed bottom-20 left-20 bg-card border border-border rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden transition-all duration-200\"\n            data-testid=\"reaper-assistant-panel\"\n          >\n            <div className=\"flex items-center justify-between px-4 py-3 border-b border-border bg-gradient-to-r from-primary/10 to-primary/5\">\n              <div className=\"flex items-center gap-2\">\n                {!showConversations && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-7 w-7 -ml-1\"\n                    onClick={() => setShowConversations(true)}\n                    data-testid=\"button-back-conversations\"\n                  >\n                    <ChevronLeft className=\"w-4 h-4\" />\n                  </Button>\n                )}\n                <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center\">\n                  <Sparkles className=\"w-4 h-4 text-primary\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-sm\">Kronos</h3>\n                  <p className=\"text-[10px] text-muted-foreground\">AI Assistant</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-1\">\n                {isSpeaking && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-7 w-7\"\n                    onClick={stopSpeaking}\n                    data-testid=\"button-stop-speaking\"\n                  >\n                    <VolumeX className=\"w-4 h-4 text-primary animate-pulse\" />\n                  </Button>\n                )}\n                {messages.length > 0 && !showConversations && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-7 w-7\"\n                    onClick={() => setShowShareDialog(true)}\n                    title=\"Share conversation\"\n                    data-testid=\"button-share-conversation\"\n                  >\n                    <Share2 className=\"w-4 h-4\" />\n                  </Button>\n                )}\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-7 w-7\"\n                  onClick={cycleWindowSize}\n                  title={`Current: ${windowSize}`}\n                  data-testid=\"button-resize-window\"\n                >\n                  {windowSize === 'expanded' ? <Minimize2 className=\"w-4 h-4\" /> : <Maximize2 className=\"w-4 h-4\" />}\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-7 w-7\"\n                  onClick={() => setShowSettings(true)}\n                  data-testid=\"button-open-settings\"\n                >\n                  <Settings className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-7 w-7\"\n                  onClick={() => setIsOpen(false)}\n                  data-testid=\"button-close-assistant\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </div>\n\n            <div className=\"flex-1 overflow-hidden\">\n              {showConversations ? (\n                <div className=\"h-full flex flex-col\">\n                  <div className=\"p-3 border-b border-border\">\n                    <Button\n                      onClick={startNewChat}\n                      disabled={createConversation.isPending}\n                      className=\"w-full gap-2\"\n                      data-testid=\"button-new-conversation\"\n                    >\n                      {createConversation.isPending ? (\n                        <Loader2 className=\"w-4 h-4 animate-spin\" />\n                      ) : (\n                        <Plus className=\"w-4 h-4\" />\n                      )}\n                      New Conversation\n                    </Button>\n                  </div>\n                  <ScrollArea className=\"flex-1\">\n                    {conversationsLoading ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"w-5 h-5 animate-spin text-muted-foreground\" />\n                      </div>\n                    ) : conversations.length === 0 ? (\n                      <div className=\"text-center py-8 px-4\">\n                        <div className=\"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-3\">\n                          <MessageCircle className=\"w-6 h-6 text-primary/50\" />\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">No conversations yet</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Start a new chat to get help with deals, tasks, and more</p>\n                      </div>\n                    ) : (\n                      <div className=\"p-2 space-y-1\">\n                        {conversations.map((conv) => (\n                          <div\n                            key={conv.id}\n                            className=\"group flex items-center gap-2 p-2.5 rounded-lg hover:bg-secondary/50 cursor-pointer transition-colors\"\n                            onClick={() => selectConversation(conv.id)}\n                            data-testid={`conversation-${conv.id}`}\n                          >\n                            <div className=\"w-8 h-8 rounded-full bg-secondary flex items-center justify-center flex-shrink-0\">\n                              <MessageCircle className=\"w-4 h-4 text-muted-foreground\" />\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"text-sm font-medium truncate\">{conv.title || 'New Conversation'}</p>\n                              <p className=\"text-[10px] text-muted-foreground\">\n                                {new Date(conv.updatedAt).toLocaleDateString()}\n                              </p>\n                            </div>\n                            <div className=\"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"h-6 w-6\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  setEditingConversationId(conv.id);\n                                  setEditingTitle(conv.title || '');\n                                  setShowRenameDialog(true);\n                                }}\n                                title=\"Rename\"\n                                data-testid={`rename-conversation-${conv.id}`}\n                              >\n                                <Pencil className=\"w-3 h-3 text-muted-foreground\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"h-6 w-6\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  deleteConversation.mutate(conv.id);\n                                }}\n                                title=\"Delete\"\n                                data-testid={`delete-conversation-${conv.id}`}\n                              >\n                                <Trash2 className=\"w-3 h-3 text-destructive\" />\n                              </Button>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </ScrollArea>\n                </div>\n              ) : (\n                <div className=\"h-full flex flex-col\">\n                  <ScrollArea className=\"flex-1 p-3\">\n                    {messagesLoading ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"w-5 h-5 animate-spin text-muted-foreground\" />\n                      </div>\n                    ) : messages.length === 0 ? (\n                      <div className=\"text-center py-4 px-4\">\n                        <div className=\"w-16 h-16 rounded-full bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center mx-auto mb-4\">\n                          <Bot className=\"w-8 h-8 text-primary\" />\n                        </div>\n                        <h4 className=\"font-semibold mb-1\">How can I help you?</h4>\n                        <p className=\"text-xs text-muted-foreground mb-4\">Ask about deals, tasks, or let me take actions for you.</p>\n                        \n                        <div className=\"text-left space-y-3\">\n                          <div>\n                            <p className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium mb-1.5\">\n                              {isAdmin ? 'Executive Actions' : 'Quick Actions'}\n                            </p>\n                            <div className=\"grid gap-1.5\">\n                              {quickPrompts.actions.map((suggestion) => (\n                                <button\n                                  key={suggestion.text}\n                                  onClick={() => {\n                                    setInputValue(suggestion.text);\n                                    inputRef.current?.focus();\n                                  }}\n                                  className=\"text-xs px-3 py-2 rounded-lg bg-primary/5 hover:bg-primary/10 text-left transition-colors flex items-center gap-2 border border-primary/10\"\n                                  data-testid={`action-${suggestion.text.slice(0, 10)}`}\n                                >\n                                  <span>{suggestion.icon}</span>\n                                  <span>{suggestion.text}</span>\n                                </button>\n                              ))}\n                            </div>\n                          </div>\n                          \n                          <div>\n                            <p className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium mb-1.5\">\n                              {isAdmin ? 'Portfolio Insights' : 'My Insights'}\n                            </p>\n                            <div className=\"grid gap-1.5\">\n                              {quickPrompts.insights.map((suggestion) => (\n                                <button\n                                  key={suggestion.text}\n                                  onClick={() => {\n                                    setInputValue(suggestion.text);\n                                    inputRef.current?.focus();\n                                  }}\n                                  className=\"text-xs px-3 py-2 rounded-lg bg-secondary/50 hover:bg-secondary text-left transition-colors flex items-center gap-2\"\n                                  data-testid={`insight-${suggestion.text.slice(0, 10)}`}\n                                >\n                                  <span>{suggestion.icon}</span>\n                                  <span>{suggestion.text}</span>\n                                </button>\n                              ))}\n                            </div>\n                          </div>\n                          \n                          <div>\n                            <p className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium mb-1.5\">Documents</p>\n                            <div className=\"grid gap-1.5\">\n                              {quickPrompts.documents.map((suggestion) => (\n                                <button\n                                  key={suggestion.text}\n                                  onClick={() => {\n                                    setInputValue(suggestion.text);\n                                    inputRef.current?.focus();\n                                  }}\n                                  className=\"text-xs px-3 py-2 rounded-lg bg-secondary/50 hover:bg-secondary text-left transition-colors flex items-center gap-2\"\n                                  data-testid={`doc-${suggestion.text.slice(0, 10)}`}\n                                >\n                                  <span>{suggestion.icon}</span>\n                                  <span>{suggestion.text}</span>\n                                </button>\n                              ))}\n                            </div>\n                          </div>\n                          \n                          <div>\n                            <p className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium mb-1.5\">Deal Intelligence</p>\n                            <div className=\"grid gap-1.5\">\n                              {[\n                                { text: \"Recommend next steps for...\", icon: \"\" },\n                                { text: \"Find matching investors for...\", icon: \"\" },\n                              ].map((suggestion) => (\n                                <button\n                                  key={suggestion.text}\n                                  onClick={() => {\n                                    setInputValue(suggestion.text);\n                                    inputRef.current?.focus();\n                                  }}\n                                  className=\"text-xs px-3 py-2 rounded-lg bg-secondary/50 hover:bg-secondary text-left transition-colors flex items-center gap-2\"\n                                  data-testid={`intel-${suggestion.text.slice(0, 10)}`}\n                                >\n                                  <span>{suggestion.icon}</span>\n                                  <span>{suggestion.text}</span>\n                                </button>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"space-y-4\">\n                        {messages.map((msg) => (\n                          <div\n                            key={msg.id}\n                            className={cn(\n                              \"flex gap-2\",\n                              msg.role === 'user' ? \"flex-row-reverse\" : \"flex-row\"\n                            )}\n                          >\n                            <div className={cn(\n                              \"w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0\",\n                              msg.role === 'user' ? \"bg-primary\" : \"bg-primary/20\"\n                            )}>\n                              {msg.role === 'user' ? (\n                                <User className=\"w-3.5 h-3.5 text-primary-foreground\" />\n                              ) : (\n                                <Sparkles className=\"w-3.5 h-3.5 text-primary\" />\n                              )}\n                            </div>\n                            <div className={cn(\n                              \"max-w-[80%] rounded-lg px-3 py-2\",\n                              msg.role === 'user' \n                                ? \"bg-primary text-primary-foreground\" \n                                : \"bg-secondary/50\"\n                            )}>\n                              {msg.role === 'user' ? (\n                                <div>\n                                  <p className=\"text-sm\">{msg.content.replace(/\\[Attached file: [^\\]]+\\]/g, '').trim()}</p>\n                                  {msg.attachments && msg.attachments.length > 0 && (\n                                    <div className=\"mt-2 space-y-1\">\n                                      {msg.attachments.map((att) => (\n                                        <a\n                                          key={att.id}\n                                          href={att.url}\n                                          target=\"_blank\"\n                                          rel=\"noopener noreferrer\"\n                                          className=\"flex items-center gap-1.5 text-xs bg-primary-foreground/10 px-2 py-1 rounded hover:bg-primary-foreground/20 transition-colors\"\n                                          data-testid={`attachment-${att.id}`}\n                                        >\n                                          <FileText className=\"w-3 h-3\" />\n                                          <span className=\"truncate max-w-[150px]\">{att.filename}</span>\n                                          <Download className=\"w-3 h-3 ml-auto\" />\n                                        </a>\n                                      ))}\n                                    </div>\n                                  )}\n                                </div>\n                              ) : (\n                                <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                                  {formatMessageContent(msg.content)}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                        {isTyping && (\n                          <div className=\"flex gap-2\">\n                            <div className=\"w-7 h-7 rounded-full bg-primary/20 flex items-center justify-center\">\n                              <Sparkles className=\"w-3.5 h-3.5 text-primary\" />\n                            </div>\n                            <div className=\"bg-secondary/50 rounded-lg px-3 py-2\">\n                              <div className=\"flex gap-1\">\n                                <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: \"0ms\" }} />\n                                <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: \"150ms\" }} />\n                                <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: \"300ms\" }} />\n                              </div>\n                            </div>\n                          </div>\n                        )}\n                        <div ref={messagesEndRef} />\n                      </div>\n                    )}\n                  </ScrollArea>\n                  \n                  <div className=\"p-3 border-t border-border\">\n                    <input\n                      type=\"file\"\n                      ref={fileInputRef}\n                      onChange={handleFileUpload}\n                      className=\"hidden\"\n                      accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp,.heic,.bmp,image/*\"\n                      multiple\n                      data-testid=\"input-file-upload\"\n                    />\n                    \n                    {pendingFiles.length > 0 && (\n                      <div className=\"mb-2 flex flex-wrap gap-1\">\n                        {pendingFiles.map((file) => (\n                          <div\n                            key={file.id}\n                            className=\"flex items-center gap-1 bg-secondary/50 text-xs px-2 py-1 rounded-md group\"\n                          >\n                            <FileText className=\"w-3 h-3 text-muted-foreground\" />\n                            <span className=\"truncate max-w-[120px]\">{file.filename}</span>\n                            <button\n                              onClick={() => removePendingFile(file.id)}\n                              className=\"ml-1 text-muted-foreground hover:text-destructive opacity-0 group-hover:opacity-100 transition-opacity\"\n                              data-testid={`remove-file-${file.id}`}\n                            >\n                              <X className=\"w-3 h-3\" />\n                            </button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    <div className=\"flex gap-2 relative\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        className=\"h-11 w-11 flex-shrink-0\"\n                        onClick={() => fileInputRef.current?.click()}\n                        disabled={sendMessage.isPending || isUploading}\n                        data-testid=\"button-attach-file\"\n                      >\n                        {isUploading ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          <Paperclip className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                      {voiceEnabled && (\n                        <Button\n                          variant={isListening ? \"default\" : \"outline\"}\n                          size=\"icon\"\n                          className={cn(\"h-11 w-11 flex-shrink-0\", isListening && \"bg-red-500 hover:bg-red-600\")}\n                          onClick={toggleListening}\n                          disabled={sendMessage.isPending}\n                          data-testid=\"button-voice-input\"\n                        >\n                          {isListening ? (\n                            <MicOff className=\"w-4 h-4 animate-pulse\" />\n                          ) : (\n                            <Mic className=\"w-4 h-4\" />\n                          )}\n                        </Button>\n                      )}\n                      <Textarea\n                        ref={inputRef}\n                        value={inputValue}\n                        onChange={handleInputChange}\n                        onKeyDown={(e) => {\n                          if (showMentions) {\n                            handleMentionKeyDown(e);\n                            if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape'].includes(e.key)) return;\n                          }\n                          handleKeyDown(e);\n                        }}\n                        placeholder={isListening ? \"Listening...\" : \"Ask Kronos anything... (@ to mention)\"}\n                        className=\"resize-none min-h-[44px] max-h-[120px]\"\n                        disabled={sendMessage.isPending}\n                        data-testid=\"input-assistant-message\"\n                      />\n                      {/* @ Mentions popup */}\n                      {showMentions && filteredMentions.length > 0 && (\n                        <div className=\"absolute bottom-full left-0 mb-1 w-64 bg-popover border border-border rounded-lg shadow-lg overflow-hidden z-50\">\n                          <div className=\"p-1 text-xs text-muted-foreground border-b border-border px-2 py-1\">\n                            Tag a team member\n                          </div>\n                          {filteredMentions.map((member, idx) => (\n                            <button\n                              key={member.id}\n                              onClick={() => insertMention(member)}\n                              className={cn(\n                                \"w-full text-left px-3 py-2 text-sm flex items-center gap-2 hover:bg-accent transition-colors\",\n                                idx === mentionIndex && \"bg-accent\"\n                              )}\n                              data-testid={`mention-${member.id}`}\n                            >\n                              <div className=\"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-xs font-medium\">\n                                {member.name.charAt(0)}\n                              </div>\n                              <div>\n                                <div className=\"font-medium\">{member.name}</div>\n                                <div className=\"text-xs text-muted-foreground\">{member.jobTitle || member.role}</div>\n                              </div>\n                            </button>\n                          ))}\n                        </div>\n                      )}\n                      <Button\n                        onClick={handleSend}\n                        disabled={(!inputValue.trim() && pendingFiles.length === 0) || sendMessage.isPending}\n                        size=\"icon\"\n                        className=\"h-11 w-11 flex-shrink-0\"\n                        data-testid=\"button-send-message\"\n                      >\n                        {sendMessage.isPending ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          <Send className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n    </>\n  );\n}\n","path":null,"size_bytes":62519,"size_tokens":null},"client/src/pages/ceo/InvestorCRM.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Building,\n  Search,\n  Plus,\n  Mail,\n  Phone,\n  MapPin,\n  Clock,\n  DollarSign,\n  TrendingUp,\n  Star,\n  MessageSquare,\n  Users,\n  Briefcase,\n  Loader2,\n  Trash2,\n  CheckSquare,\n  Square,\n  X\n} from \"lucide-react\";\nimport { useCurrentUser, useInvestors, useInvestor, useCreateInvestor, useCreateInvestorInteraction, useDeleteInvestor } from \"@/lib/api\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\nimport { format, parseISO, differenceInDays } from \"date-fns\";\nimport { toast } from \"sonner\";\n\nconst statusColors: Record<string, string> = {\n  'Active': 'bg-green-500',\n  'Warm': 'bg-yellow-500',\n  'Cold': 'bg-blue-500',\n  'Inactive': 'bg-gray-500',\n};\n\nexport default function InvestorCRM() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: investors = [], isLoading } = useInvestors();\n  const queryClient = useQueryClient();\n  \n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [selectedInvestorId, setSelectedInvestorId] = useState<string | null>(null);\n  const [showAddInvestor, setShowAddInvestor] = useState(false);\n  const [showAddInteraction, setShowAddInteraction] = useState(false);\n  const [selectedInvestorIds, setSelectedInvestorIds] = useState<Set<string>>(new Set());\n  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);\n  \n  const { data: selectedInvestorData } = useInvestor(selectedInvestorId || '');\n  const createInvestor = useCreateInvestor();\n  const createInteraction = useCreateInvestorInteraction();\n  const deleteInvestor = useDeleteInvestor();\n\n  const [newInvestor, setNewInvestor] = useState({\n    name: '',\n    firm: '',\n    type: 'PE' as string,\n    email: '',\n    phone: '',\n    location: '',\n    sectors: '',\n    minDealSize: '',\n    maxDealSize: '',\n    status: 'Active' as string,\n    notes: '',\n  });\n\n  const [newInteraction, setNewInteraction] = useState({ type: 'Call', notes: '' });\n\n  const filteredInvestors = useMemo(() => {\n    return investors.filter(inv => {\n      if (searchQuery) {\n        const query = searchQuery.toLowerCase();\n        if (!inv.name.toLowerCase().includes(query) && \n            !inv.firm.toLowerCase().includes(query) &&\n            !(inv.sectors || []).some((s: string) => s.toLowerCase().includes(query))) {\n          return false;\n        }\n      }\n      if (filterType !== 'all' && inv.type !== filterType) return false;\n      if (filterStatus !== 'all' && inv.status !== filterStatus) return false;\n      return true;\n    });\n  }, [investors, searchQuery, filterType, filterStatus]);\n\n  const stats = useMemo(() => {\n    const now = new Date();\n    return {\n      total: investors.length,\n      active: investors.filter(i => i.status === 'Active').length,\n      avgScore: investors.length > 0 \n        ? Math.round(investors.reduce((sum, i) => sum + (i.relationshipScore || 0), 0) / investors.length)\n        : 0,\n      recentContacts: investors.filter(i => {\n        if (!i.lastContactDate) return false;\n        const daysSince = differenceInDays(now, parseISO(i.lastContactDate));\n        return daysSince <= 7;\n      }).length,\n    };\n  }, [investors]);\n\n  const handleAddInvestor = async () => {\n    if (!newInvestor.name || !newInvestor.firm) {\n      toast.error('Please enter name and firm');\n      return;\n    }\n    \n    try {\n      await createInvestor.mutateAsync({\n        name: newInvestor.name,\n        firm: newInvestor.firm,\n        type: newInvestor.type,\n        email: newInvestor.email || undefined,\n        phone: newInvestor.phone || undefined,\n        location: newInvestor.location || undefined,\n        sectors: newInvestor.sectors ? newInvestor.sectors.split(',').map(s => s.trim()) : undefined,\n        minDealSize: newInvestor.minDealSize ? parseInt(newInvestor.minDealSize) : undefined,\n        maxDealSize: newInvestor.maxDealSize ? parseInt(newInvestor.maxDealSize) : undefined,\n        status: newInvestor.status,\n        notes: newInvestor.notes || undefined,\n      });\n      toast.success('Investor added');\n      setShowAddInvestor(false);\n      setNewInvestor({\n        name: '', firm: '', type: 'PE', email: '', phone: '', location: '',\n        sectors: '', minDealSize: '', maxDealSize: '', status: 'Active', notes: '',\n      });\n    } catch (error) {\n      toast.error('Failed to add investor');\n    }\n  };\n\n  const handleAddInteraction = async () => {\n    if (!selectedInvestorId || !newInteraction.notes) {\n      toast.error('Please enter interaction details');\n      return;\n    }\n    \n    try {\n      await createInteraction.mutateAsync({\n        investorId: selectedInvestorId,\n        interaction: {\n          type: newInteraction.type,\n          date: format(new Date(), 'yyyy-MM-dd'),\n          notes: newInteraction.notes,\n        },\n      });\n      toast.success('Interaction logged');\n      setShowAddInteraction(false);\n      setNewInteraction({ type: 'Call', notes: '' });\n    } catch (error) {\n      toast.error('Failed to log interaction');\n    }\n  };\n\n  const handleDeleteInvestor = async () => {\n    if (!selectedInvestorId) return;\n    \n    try {\n      await deleteInvestor.mutateAsync(selectedInvestorId);\n      toast.success('Investor deleted');\n      setSelectedInvestorId(null);\n    } catch (error) {\n      toast.error('Failed to delete investor');\n    }\n  };\n\n  const toggleInvestorSelection = (investorId: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    const newSet = new Set(selectedInvestorIds);\n    if (newSet.has(investorId)) {\n      newSet.delete(investorId);\n    } else {\n      newSet.add(investorId);\n    }\n    setSelectedInvestorIds(newSet);\n  };\n\n  const toggleSelectAll = () => {\n    if (selectedInvestorIds.size === filteredInvestors.length) {\n      setSelectedInvestorIds(new Set());\n    } else {\n      setSelectedInvestorIds(new Set(filteredInvestors.map(i => i.id)));\n    }\n  };\n\n  const handleBulkDelete = async () => {\n    if (selectedInvestorIds.size === 0) return;\n    \n    const idsToDelete = Array.from(selectedInvestorIds);\n    const results = await Promise.allSettled(\n      idsToDelete.map(id => deleteInvestor.mutateAsync(id))\n    );\n    \n    const successful = results.filter(r => r.status === 'fulfilled').length;\n    const failed = results.filter(r => r.status === 'rejected').length;\n    \n    if (failed === 0) {\n      toast.success(`${successful} investor(s) deleted`);\n    } else if (successful > 0) {\n      toast.warning(`${successful} deleted, ${failed} failed`);\n    } else {\n      toast.error('Failed to delete investors');\n    }\n    \n    // Force refresh the investors list\n    await queryClient.invalidateQueries({ queryKey: [\"investors\"] });\n    \n    setSelectedInvestorIds(new Set());\n    setShowBulkDeleteDialog(false);\n    if (selectedInvestorId && idsToDelete.includes(selectedInvestorId)) {\n      setSelectedInvestorId(null);\n    }\n  };\n\n  const handleBulkEmail = () => {\n    const selectedEmails = investors\n      .filter(i => selectedInvestorIds.has(i.id) && i.email)\n      .map(i => i.email)\n      .join(',');\n    if (selectedEmails) {\n      window.location.href = `mailto:${selectedEmails}`;\n    } else {\n      toast.error('No email addresses found for selected investors');\n    }\n  };\n\n  const selectedInvestor = selectedInvestorData || investors.find(i => i.id === selectedInvestorId);\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Investor CRM\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Users className=\"w-6 h-6 text-primary\" />\n              Investor CRM\n            </h1>\n            <p className=\"text-muted-foreground\">Manage investor relationships and interactions</p>\n          </div>\n          <Button onClick={() => setShowAddInvestor(true)} data-testid=\"button-add-investor\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Investor\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Investors</p>\n                  <p className=\"text-2xl font-bold\">{stats.total}</p>\n                </div>\n                <Users className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Active Relationships</p>\n                  <p className=\"text-2xl font-bold text-green-500\">{stats.active}</p>\n                </div>\n                <TrendingUp className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Avg Relationship Score</p>\n                  <p className=\"text-2xl font-bold text-blue-500\">{stats.avgScore}</p>\n                </div>\n                <Star className=\"w-5 h-5 text-blue-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Recent Contacts (7d)</p>\n                  <p className=\"text-2xl font-bold text-purple-500\">{stats.recentContacts}</p>\n                </div>\n                <MessageSquare className=\"w-5 h-5 text-purple-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          <Card className=\"lg:col-span-1 bg-card border-border\">\n            <CardHeader className=\"pb-2\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"relative flex-1\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search investors...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-investors\"\n                  />\n                </div>\n              </div>\n              \n              {/* Bulk Actions Bar */}\n              {selectedInvestorIds.size > 0 && (\n                <div className=\"flex items-center justify-between p-2 mt-2 bg-primary/10 rounded-lg border border-primary/20\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button variant=\"ghost\" size=\"sm\" onClick={() => setSelectedInvestorIds(new Set())} className=\"h-7 px-2\">\n                      <X className=\"w-3 h-3\" />\n                    </Button>\n                    <span className=\"text-sm font-medium\">{selectedInvestorIds.size} selected</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Button variant=\"ghost\" size=\"sm\" onClick={handleBulkEmail} className=\"h-7 text-xs\" data-testid=\"button-bulk-email\">\n                      <Mail className=\"w-3 h-3 mr-1\" /> Email\n                    </Button>\n                    <AlertDialog open={showBulkDeleteDialog} onOpenChange={setShowBulkDeleteDialog}>\n                      <AlertDialogTrigger asChild>\n                        <Button variant=\"ghost\" size=\"sm\" className=\"h-7 text-xs text-red-500 hover:text-red-600\" data-testid=\"button-bulk-delete\">\n                          <Trash2 className=\"w-3 h-3 mr-1\" /> Delete\n                        </Button>\n                      </AlertDialogTrigger>\n                      <AlertDialogContent>\n                        <AlertDialogHeader>\n                          <AlertDialogTitle>Delete {selectedInvestorIds.size} investor(s)?</AlertDialogTitle>\n                          <AlertDialogDescription>\n                            This will permanently delete the selected investors. This action cannot be undone.\n                          </AlertDialogDescription>\n                        </AlertDialogHeader>\n                        <AlertDialogFooter>\n                          <AlertDialogCancel>Cancel</AlertDialogCancel>\n                          <AlertDialogAction onClick={handleBulkDelete} className=\"bg-red-500 hover:bg-red-600\">\n                            Delete All\n                          </AlertDialogAction>\n                        </AlertDialogFooter>\n                      </AlertDialogContent>\n                    </AlertDialog>\n                  </div>\n                </div>\n              )}\n              \n              <div className=\"flex gap-2 mt-2\">\n                <Select value={filterType} onValueChange={setFilterType}>\n                  <SelectTrigger className=\"flex-1\" data-testid=\"select-filter-type\">\n                    <SelectValue placeholder=\"Type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Types</SelectItem>\n                    <SelectItem value=\"PE\">PE</SelectItem>\n                    <SelectItem value=\"VC\">VC</SelectItem>\n                    <SelectItem value=\"Strategic\">Strategic</SelectItem>\n                    <SelectItem value=\"Family Office\">Family Office</SelectItem>\n                    <SelectItem value=\"Hedge Fund\">Hedge Fund</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Select value={filterStatus} onValueChange={setFilterStatus}>\n                  <SelectTrigger className=\"flex-1\" data-testid=\"select-filter-status\">\n                    <SelectValue placeholder=\"Status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Status</SelectItem>\n                    <SelectItem value=\"Active\">Active</SelectItem>\n                    <SelectItem value=\"Warm\">Warm</SelectItem>\n                    <SelectItem value=\"Cold\">Cold</SelectItem>\n                    <SelectItem value=\"Inactive\">Inactive</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n              {isLoading ? (\n                <div className=\"flex items-center justify-center py-12\">\n                  <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\n                </div>\n              ) : (\n                <ScrollArea className=\"h-[600px]\">\n                  <div className=\"p-2 space-y-2\">\n                    {filteredInvestors.length > 0 && (\n                      <button\n                        onClick={toggleSelectAll}\n                        className=\"w-full p-2 rounded-lg border border-dashed border-border hover:bg-secondary/50 flex items-center gap-2 text-sm text-muted-foreground\"\n                        data-testid=\"button-select-all\"\n                      >\n                        {selectedInvestorIds.size === filteredInvestors.length ? (\n                          <CheckSquare className=\"w-4 h-4 text-primary\" />\n                        ) : (\n                          <Square className=\"w-4 h-4\" />\n                        )}\n                        {selectedInvestorIds.size === filteredInvestors.length ? 'Deselect all' : 'Select all'}\n                      </button>\n                    )}\n                    {filteredInvestors.length === 0 ? (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <Users className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                        <p>No investors found</p>\n                        <p className=\"text-sm mt-1\">Add your first investor to get started</p>\n                      </div>\n                    ) : (\n                      filteredInvestors.map(investor => (\n                        <div\n                          key={investor.id}\n                          className={cn(\n                            \"w-full p-3 rounded-lg border text-left transition-colors flex items-start gap-3\",\n                            selectedInvestorId === investor.id \n                              ? \"border-primary bg-primary/10\" \n                              : \"border-border hover:bg-secondary/50\",\n                            selectedInvestorIds.has(investor.id) && \"bg-primary/5 border-primary/50\"\n                          )}\n                          data-testid={`investor-card-${investor.id}`}\n                        >\n                          <div className=\"flex items-center pt-1\">\n                            <Checkbox\n                              checked={selectedInvestorIds.has(investor.id)}\n                              onCheckedChange={() => {\n                                const newSet = new Set(selectedInvestorIds);\n                                if (newSet.has(investor.id)) {\n                                  newSet.delete(investor.id);\n                                } else {\n                                  newSet.add(investor.id);\n                                }\n                                setSelectedInvestorIds(newSet);\n                              }}\n                              data-testid={`checkbox-investor-${investor.id}`}\n                              className=\"h-5 w-5 border-2\"\n                            />\n                          </div>\n                          <button \n                            onClick={() => setSelectedInvestorId(investor.id)}\n                            className=\"flex-1 text-left\"\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <Avatar className=\"w-10 h-10\">\n                                <AvatarFallback className=\"bg-primary/20 text-primary\">\n                                  {investor.name.split(' ').map(n => n[0]).join('')}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"font-medium truncate\">{investor.name}</p>\n                                <p className=\"text-sm text-muted-foreground truncate\">{investor.firm}</p>\n                              </div>\n                              <div className={cn(\"w-2 h-2 rounded-full\", statusColors[investor.status] || 'bg-gray-500')} />\n                            </div>\n                            <div className=\"flex items-center gap-2 mt-2\">\n                              <Badge variant=\"secondary\" className=\"text-xs\">{investor.type}</Badge>\n                              <span className=\"text-xs text-muted-foreground\">\n                                Score: {investor.relationshipScore || 0}\n                              </span>\n                            </div>\n                          </button>\n                        </div>\n                      ))\n                    )}\n                  </div>\n                </ScrollArea>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card className=\"lg:col-span-2 bg-card border-border\">\n            {selectedInvestor ? (\n              <>\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex items-center gap-4\">\n                      <Avatar className=\"w-16 h-16\">\n                        <AvatarFallback className=\"text-xl bg-primary/20 text-primary\">\n                          {selectedInvestor.name.split(' ').map(n => n[0]).join('')}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div>\n                        <h2 className=\"text-xl font-bold\">{selectedInvestor.name}</h2>\n                        <p className=\"text-muted-foreground\">{selectedInvestor.firm}</p>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"secondary\">{selectedInvestor.type}</Badge>\n                          <Badge className={cn(\"text-white\", statusColors[selectedInvestor.status] || 'bg-gray-500')}>\n                            {selectedInvestor.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button variant=\"outline\" size=\"sm\" onClick={() => setShowAddInteraction(true)}>\n                        <Plus className=\"w-4 h-4 mr-1\" />\n                        Log Interaction\n                      </Button>\n                      <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                          <Button \n                            variant=\"outline\" \n                            size=\"sm\" \n                            disabled={deleteInvestor.isPending}\n                            className=\"border-red-500/30 text-red-400 hover:bg-red-500/10\"\n                            data-testid=\"button-delete-investor\"\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                          <AlertDialogHeader>\n                            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                            <AlertDialogDescription>\n                              This action cannot be undone. This will permanently delete {selectedInvestor.name} from {selectedInvestor.firm} and all their interaction history.\n                            </AlertDialogDescription>\n                          </AlertDialogHeader>\n                          <AlertDialogFooter>\n                            <AlertDialogCancel>Cancel</AlertDialogCancel>\n                            <AlertDialogAction onClick={handleDeleteInvestor}>\n                              Delete Investor\n                            </AlertDialogAction>\n                          </AlertDialogFooter>\n                        </AlertDialogContent>\n                      </AlertDialog>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <Tabs defaultValue=\"overview\">\n                    <TabsList className=\"grid w-full grid-cols-3\">\n                      <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n                      <TabsTrigger value=\"interactions\">Interactions</TabsTrigger>\n                      <TabsTrigger value=\"deals\">Deals</TabsTrigger>\n                    </TabsList>\n                    \n                    <TabsContent value=\"overview\" className=\"mt-4\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"space-y-4\">\n                          {selectedInvestor.email && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <Mail className=\"w-4 h-4\" /> Email\n                              </p>\n                              <p className=\"font-medium\">{selectedInvestor.email}</p>\n                            </div>\n                          )}\n                          {selectedInvestor.phone && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <Phone className=\"w-4 h-4\" /> Phone\n                              </p>\n                              <p className=\"font-medium\">{selectedInvestor.phone}</p>\n                            </div>\n                          )}\n                          {selectedInvestor.location && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <MapPin className=\"w-4 h-4\" /> Location\n                              </p>\n                              <p className=\"font-medium\">{selectedInvestor.location}</p>\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"space-y-4\">\n                          {(selectedInvestor.minDealSize || selectedInvestor.maxDealSize) && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <DollarSign className=\"w-4 h-4\" /> Deal Size Range\n                              </p>\n                              <p className=\"font-medium\">\n                                ${selectedInvestor.minDealSize || 0}M - ${selectedInvestor.maxDealSize || ''}M\n                              </p>\n                            </div>\n                          )}\n                          {selectedInvestor.sectors && selectedInvestor.sectors.length > 0 && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <Building className=\"w-4 h-4\" /> Sectors\n                              </p>\n                              <div className=\"flex flex-wrap gap-1 mt-1\">\n                                {selectedInvestor.sectors.map((sector: string) => (\n                                  <Badge key={sector} variant=\"outline\" className=\"text-xs\">{sector}</Badge>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                          {selectedInvestor.lastContactDate && (\n                            <div className=\"p-3 rounded-lg bg-secondary/30\">\n                              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                                <Clock className=\"w-4 h-4\" /> Last Contact\n                              </p>\n                              <p className=\"font-medium\">\n                                {format(parseISO(selectedInvestor.lastContactDate), 'MMM d, yyyy')}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      \n                      {selectedInvestor.notes && (\n                        <div className=\"mt-4 p-4 rounded-lg bg-secondary/30\">\n                          <p className=\"text-sm text-muted-foreground mb-2\">Notes</p>\n                          <p>{selectedInvestor.notes}</p>\n                        </div>\n                      )}\n                      \n                      <div className=\"mt-4 grid grid-cols-2 gap-4\">\n                        <div className=\"p-4 rounded-lg bg-primary/10 border border-primary/20\">\n                          <div className=\"flex items-center gap-2\">\n                            <Star className=\"w-5 h-5 text-primary\" />\n                            <span className=\"text-sm text-muted-foreground\">Relationship Score</span>\n                          </div>\n                          <p className=\"text-3xl font-bold mt-2\">{selectedInvestor.relationshipScore || 0}/100</p>\n                        </div>\n                        <div className=\"p-4 rounded-lg bg-green-500/10 border border-green-500/20\">\n                          <div className=\"flex items-center gap-2\">\n                            <Briefcase className=\"w-5 h-5 text-green-500\" />\n                            <span className=\"text-sm text-muted-foreground\">Deals Participated</span>\n                          </div>\n                          <p className=\"text-3xl font-bold mt-2\">{selectedInvestor.dealsParticipated || 0}</p>\n                        </div>\n                      </div>\n                    </TabsContent>\n                    \n                    <TabsContent value=\"interactions\" className=\"mt-4\">\n                      <ScrollArea className=\"h-64\">\n                        <div className=\"space-y-3\">\n                          {selectedInvestorData?.interactions?.map((interaction: any) => (\n                            <div key={interaction.id} className=\"p-3 rounded-lg border border-border\">\n                              <div className=\"flex items-center justify-between\">\n                                <Badge variant=\"secondary\">{interaction.type}</Badge>\n                                <span className=\"text-sm text-muted-foreground\">\n                                  {format(parseISO(interaction.date), 'MMM d, yyyy')}\n                                </span>\n                              </div>\n                              <p className=\"mt-2 text-sm\">{interaction.notes}</p>\n                              {interaction.userName && (\n                                <p className=\"mt-1 text-xs text-muted-foreground\">By: {interaction.userName}</p>\n                              )}\n                            </div>\n                          ))}\n                          {(!selectedInvestorData?.interactions || selectedInvestorData.interactions.length === 0) && (\n                            <div className=\"text-center py-8 text-muted-foreground\">\n                              <MessageSquare className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                              <p>No interactions logged yet</p>\n                            </div>\n                          )}\n                        </div>\n                      </ScrollArea>\n                    </TabsContent>\n                    \n                    <TabsContent value=\"deals\" className=\"mt-4\">\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <Briefcase className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                        <p>Deal history coming soon</p>\n                      </div>\n                    </TabsContent>\n                  </Tabs>\n                </CardContent>\n              </>\n            ) : (\n              <CardContent className=\"py-16 text-center\">\n                <Users className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50\" />\n                <h3 className=\"text-lg font-medium\">Select an Investor</h3>\n                <p className=\"text-muted-foreground mt-1\">\n                  Choose an investor from the list to view their details\n                </p>\n              </CardContent>\n            )}\n          </Card>\n        </div>\n      </div>\n\n      <Dialog open={showAddInvestor} onOpenChange={setShowAddInvestor}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Add New Investor</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4 max-h-[60vh] overflow-y-auto\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Name *</Label>\n                <Input\n                  value={newInvestor.name}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, name: e.target.value }))}\n                  placeholder=\"John Smith\"\n                  data-testid=\"input-investor-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Firm *</Label>\n                <Input\n                  value={newInvestor.firm}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, firm: e.target.value }))}\n                  placeholder=\"Blackstone\"\n                  data-testid=\"input-investor-firm\"\n                />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Type</Label>\n                <Select value={newInvestor.type} onValueChange={(v) => setNewInvestor(prev => ({ ...prev, type: v }))}>\n                  <SelectTrigger data-testid=\"select-investor-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"PE\">Private Equity</SelectItem>\n                    <SelectItem value=\"VC\">Venture Capital</SelectItem>\n                    <SelectItem value=\"Strategic\">Strategic</SelectItem>\n                    <SelectItem value=\"Family Office\">Family Office</SelectItem>\n                    <SelectItem value=\"Hedge Fund\">Hedge Fund</SelectItem>\n                    <SelectItem value=\"Sovereign Wealth\">Sovereign Wealth</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Status</Label>\n                <Select value={newInvestor.status} onValueChange={(v) => setNewInvestor(prev => ({ ...prev, status: v }))}>\n                  <SelectTrigger data-testid=\"select-investor-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Active\">Active</SelectItem>\n                    <SelectItem value=\"Warm\">Warm</SelectItem>\n                    <SelectItem value=\"Cold\">Cold</SelectItem>\n                    <SelectItem value=\"Inactive\">Inactive</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Email</Label>\n                <Input\n                  type=\"email\"\n                  value={newInvestor.email}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, email: e.target.value }))}\n                  placeholder=\"john@firm.com\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Phone</Label>\n                <Input\n                  value={newInvestor.phone}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, phone: e.target.value }))}\n                  placeholder=\"+1 (555) 123-4567\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Location</Label>\n              <Input\n                value={newInvestor.location}\n                onChange={(e) => setNewInvestor(prev => ({ ...prev, location: e.target.value }))}\n                placeholder=\"New York, NY\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Sectors (comma-separated)</Label>\n              <Input\n                value={newInvestor.sectors}\n                onChange={(e) => setNewInvestor(prev => ({ ...prev, sectors: e.target.value }))}\n                placeholder=\"Technology, Healthcare, Financial Services\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Min Deal Size ($M)</Label>\n                <Input\n                  type=\"number\"\n                  value={newInvestor.minDealSize}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, minDealSize: e.target.value }))}\n                  placeholder=\"10\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Max Deal Size ($M)</Label>\n                <Input\n                  type=\"number\"\n                  value={newInvestor.maxDealSize}\n                  onChange={(e) => setNewInvestor(prev => ({ ...prev, maxDealSize: e.target.value }))}\n                  placeholder=\"500\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Notes</Label>\n              <Textarea\n                value={newInvestor.notes}\n                onChange={(e) => setNewInvestor(prev => ({ ...prev, notes: e.target.value }))}\n                placeholder=\"Any relevant notes about this investor...\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAddInvestor(false)}>Cancel</Button>\n            <Button \n              onClick={handleAddInvestor}\n              disabled={createInvestor.isPending}\n              data-testid=\"button-save-investor\"\n            >\n              {createInvestor.isPending ? 'Saving...' : 'Add Investor'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showAddInteraction} onOpenChange={setShowAddInteraction}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Log Interaction</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Type</Label>\n              <Select value={newInteraction.type} onValueChange={(v) => setNewInteraction(prev => ({ ...prev, type: v }))}>\n                <SelectTrigger data-testid=\"select-interaction-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Call\">Call</SelectItem>\n                  <SelectItem value=\"Meeting\">Meeting</SelectItem>\n                  <SelectItem value=\"Email\">Email</SelectItem>\n                  <SelectItem value=\"Event\">Event</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Notes</Label>\n              <Textarea\n                placeholder=\"Describe the interaction...\"\n                value={newInteraction.notes}\n                onChange={(e) => setNewInteraction(prev => ({ ...prev, notes: e.target.value }))}\n                data-testid=\"input-interaction-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAddInteraction(false)}>Cancel</Button>\n            <Button \n              onClick={handleAddInteraction}\n              disabled={createInteraction.isPending}\n              data-testid=\"button-save-interaction\"\n            >\n              {createInteraction.isPending ? 'Saving...' : 'Save'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":40149,"size_tokens":null},"client/src/pages/ceo/PipelineForecasting.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  BarChart3,\n  PieChart,\n  Calendar,\n  Target,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  ArrowUpRight,\n  ArrowDownRight,\n  Filter,\n  Download,\n  RefreshCw\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  LineChart,\n  Line,\n  AreaChart,\n  Area,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  PieChart as RechartsPieChart,\n  Pie,\n  Cell\n} from \"recharts\";\n\nconst COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];\n\n// Map legacy IB stages to new stages\nconst mapIBStage = (stage: string) => {\n  const legacyMap: Record<string, string> = {\n    'Due Diligence': 'Diligence',\n    'Negotiation': 'Legal',\n    'Closing': 'Close',\n    'Execution': 'Structuring',\n    'Signing': 'Close',\n    'Qualification': 'Origination',\n    'Pitch': 'Structuring',\n    'Documentation': 'Legal',\n  };\n  return legacyMap[stage] || stage;\n};\n\nexport default function PipelineForecasting() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [] } = useDealsListing();\n  \n  const [timeframe, setTimeframe] = useState<string>(\"Q4 2024\");\n  const [scenarioType, setScenarioType] = useState<string>(\"base\");\n  const [closeRateAdjustment, setCloseRateAdjustment] = useState<number[]>([100]);\n  const [dealValueAdjustment, setDealValueAdjustment] = useState<number[]>([100]);\n\n  const stageWeights: Record<string, number> = {\n    'Origination': 0.15,\n    'Structuring': 0.35,\n    'Diligence': 0.55,\n    'Legal': 0.80,\n    'Close': 0.95,\n  };\n\n  const forecasts = useMemo(() => {\n    const closeRate = closeRateAdjustment[0] / 100;\n    const valueMultiplier = dealValueAdjustment[0] / 100;\n    \n    const activeDeals = deals.filter(d => d.status === 'Active');\n    \n    const weightedPipeline = activeDeals.reduce((sum, deal) => {\n      const mappedStage = mapIBStage(deal.stage);\n      const weight = stageWeights[mappedStage] || 0.5;\n      return sum + (deal.value * weight * closeRate * valueMultiplier);\n    }, 0);\n\n    const bestCase = activeDeals.reduce((sum, deal) => {\n      const mappedStage = mapIBStage(deal.stage);\n      const weight = Math.min((stageWeights[mappedStage] || 0.5) + 0.2, 1);\n      return sum + (deal.value * weight * 1.1 * valueMultiplier);\n    }, 0);\n\n    const worstCase = activeDeals.reduce((sum, deal) => {\n      const mappedStage = mapIBStage(deal.stage);\n      const weight = Math.max((stageWeights[mappedStage] || 0.5) - 0.2, 0);\n      return sum + (deal.value * weight * 0.8 * valueMultiplier);\n    }, 0);\n\n    return {\n      base: weightedPipeline,\n      best: bestCase,\n      worst: worstCase,\n      total: activeDeals.reduce((sum, d) => sum + d.value, 0),\n    };\n  }, [deals, closeRateAdjustment, dealValueAdjustment]);\n\n  const monthlyProjections = useMemo(() => {\n    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n    const currentMonth = new Date().getMonth();\n    \n    return months.slice(currentMonth, currentMonth + 6).map((month, idx) => {\n      const factor = 1 + (idx * 0.08);\n      return {\n        month,\n        base: Math.round(forecasts.base * factor / 6),\n        best: Math.round(forecasts.best * factor / 6),\n        worst: Math.round(forecasts.worst * factor / 6),\n      };\n    });\n  }, [forecasts]);\n\n  const stageDistribution = useMemo(() => {\n    const stages = ['Origination', 'Structuring', 'Diligence', 'Legal', 'Close'];\n    return stages.map(stage => {\n      const stageDeals = deals.filter(d => mapIBStage(d.stage) === stage && d.status === 'Active');\n      return {\n        name: stage,\n        value: stageDeals.reduce((sum, d) => sum + d.value, 0),\n        count: stageDeals.length,\n      };\n    }).filter(s => s.value > 0);\n  }, [deals]);\n\n  const sectorDistribution = useMemo(() => {\n    const sectorMap: Record<string, number> = {};\n    deals.filter(d => d.status === 'Active').forEach(deal => {\n      sectorMap[deal.sector] = (sectorMap[deal.sector] || 0) + deal.value;\n    });\n    return Object.entries(sectorMap).map(([name, value]) => ({ name, value }));\n  }, [deals]);\n\n  const quarterlyComparison = [\n    { quarter: 'Q1', actual: 45, forecast: 50, target: 55 },\n    { quarter: 'Q2', actual: 62, forecast: 58, target: 60 },\n    { quarter: 'Q3', actual: 78, forecast: 72, target: 70 },\n    { quarter: 'Q4', actual: null, forecast: forecasts.base, target: 85 },\n  ];\n\n  const riskAnalysis = useMemo(() => {\n    const activeDeals = deals.filter(d => d.status === 'Active');\n    const atRisk = activeDeals.filter(d => (d.progress || 0) < 30 && stageWeights[mapIBStage(d.stage)] > 0.3);\n    const onTrack = activeDeals.filter(d => (d.progress || 0) >= 50);\n    const delayed = activeDeals.filter(d => (d.progress || 0) >= 30 && (d.progress || 0) < 50);\n    \n    return { atRisk, onTrack, delayed };\n  }, [deals]);\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Pipeline Forecasting\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header Controls */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Pipeline Forecasting</h1>\n            <p className=\"text-muted-foreground\">Revenue projections and scenario analysis</p>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <Select value={timeframe} onValueChange={setTimeframe}>\n              <SelectTrigger className=\"w-32\" data-testid=\"select-timeframe\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Q4 2024\">Q4 2024</SelectItem>\n                <SelectItem value=\"Q1 2025\">Q1 2025</SelectItem>\n                <SelectItem value=\"H1 2025\">H1 2025</SelectItem>\n                <SelectItem value=\"FY 2025\">FY 2025</SelectItem>\n              </SelectContent>\n            </Select>\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"button-export-forecast\">\n              <Download className=\"w-4 h-4 mr-2\" />\n              Export\n            </Button>\n          </div>\n        </div>\n\n        {/* Scenario Controls */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Filter className=\"w-4 h-4\" />\n              Scenario Adjustments\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">Scenario Type</label>\n                <Select value={scenarioType} onValueChange={setScenarioType}>\n                  <SelectTrigger data-testid=\"select-scenario-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"base\">Base Case</SelectItem>\n                    <SelectItem value=\"best\">Best Case</SelectItem>\n                    <SelectItem value=\"worst\">Worst Case</SelectItem>\n                    <SelectItem value=\"custom\">Custom</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">\n                  Close Rate Adjustment: {closeRateAdjustment[0]}%\n                </label>\n                <Slider\n                  value={closeRateAdjustment}\n                  onValueChange={setCloseRateAdjustment}\n                  min={50}\n                  max={150}\n                  step={5}\n                  className=\"w-full\"\n                  data-testid=\"slider-close-rate\"\n                />\n              </div>\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">\n                  Deal Value Adjustment: {dealValueAdjustment[0]}%\n                </label>\n                <Slider\n                  value={dealValueAdjustment}\n                  onValueChange={setDealValueAdjustment}\n                  min={50}\n                  max={150}\n                  step={5}\n                  className=\"w-full\"\n                  data-testid=\"slider-deal-value\"\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Key Metrics */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Pipeline</p>\n                  <p className=\"text-2xl font-bold\">${forecasts.total}M</p>\n                </div>\n                <div className=\"p-2 rounded-lg bg-blue-500/20\">\n                  <DollarSign className=\"w-5 h-5 text-blue-500\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Weighted Forecast</p>\n                  <p className=\"text-2xl font-bold\">${Math.round(forecasts.base)}M</p>\n                </div>\n                <div className=\"p-2 rounded-lg bg-green-500/20\">\n                  <Target className=\"w-5 h-5 text-green-500\" />\n                </div>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                {Math.round((forecasts.base / forecasts.total) * 100)}% weighted probability\n              </p>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Best Case</p>\n                  <p className=\"text-2xl font-bold text-green-500\">${Math.round(forecasts.best)}M</p>\n                </div>\n                <div className=\"p-2 rounded-lg bg-green-500/20\">\n                  <TrendingUp className=\"w-5 h-5 text-green-500\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Worst Case</p>\n                  <p className=\"text-2xl font-bold text-orange-500\">${Math.round(forecasts.worst)}M</p>\n                </div>\n                <div className=\"p-2 rounded-lg bg-orange-500/20\">\n                  <TrendingDown className=\"w-5 h-5 text-orange-500\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Charts Section */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Monthly Projection Chart */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BarChart3 className=\"w-5 h-5 text-primary\" />\n                Monthly Revenue Projections\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <AreaChart data={monthlyProjections}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"month\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Legend />\n                  <Area type=\"monotone\" dataKey=\"best\" name=\"Best Case\" stroke=\"#10b981\" fill=\"#10b98133\" />\n                  <Area type=\"monotone\" dataKey=\"base\" name=\"Base Case\" stroke=\"#3b82f6\" fill=\"#3b82f633\" />\n                  <Area type=\"monotone\" dataKey=\"worst\" name=\"Worst Case\" stroke=\"#f59e0b\" fill=\"#f59e0b33\" />\n                </AreaChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Stage Distribution */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <PieChart className=\"w-5 h-5 text-primary\" />\n                Pipeline by Stage\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <RechartsPieChart>\n                  <Pie\n                    data={stageDistribution}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={60}\n                    outerRadius={100}\n                    paddingAngle={5}\n                    dataKey=\"value\"\n                    label={({ name, value }) => `${name}: $${value}M`}\n                  >\n                    {stageDistribution.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                    ))}\n                  </Pie>\n                  <Tooltip \n                    formatter={(value: number) => [`$${value}M`, 'Value']}\n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                </RechartsPieChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Quarterly Comparison */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5 text-primary\" />\n                Quarterly Performance vs Target\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={quarterlyComparison}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"quarter\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Legend />\n                  <Bar dataKey=\"actual\" name=\"Actual\" fill=\"#10b981\" />\n                  <Bar dataKey=\"forecast\" name=\"Forecast\" fill=\"#3b82f6\" />\n                  <Bar dataKey=\"target\" name=\"Target\" fill=\"#8b5cf6\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Sector Distribution */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BarChart3 className=\"w-5 h-5 text-primary\" />\n                Pipeline by Sector\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={sectorDistribution} layout=\"vertical\">\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis type=\"number\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis dataKey=\"name\" type=\"category\" stroke=\"hsl(var(--muted-foreground))\" width={100} />\n                  <Tooltip \n                    formatter={(value: number) => [`$${value}M`, 'Value']}\n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Bar dataKey=\"value\" fill=\"#3b82f6\" radius={[0, 4, 4, 0]} />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Risk Analysis */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"w-5 h-5 text-primary\" />\n              Deal Risk Analysis\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              {/* On Track */}\n              <div className=\"p-4 rounded-lg bg-green-500/10 border border-green-500/20\">\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <CheckCircle className=\"w-5 h-5 text-green-500\" />\n                  <h3 className=\"font-medium text-green-500\">On Track</h3>\n                  <Badge variant=\"secondary\" className=\"ml-auto bg-green-500/20 text-green-500\">\n                    {riskAnalysis.onTrack.length}\n                  </Badge>\n                </div>\n                <ScrollArea className=\"h-32\">\n                  <div className=\"space-y-2\">\n                    {riskAnalysis.onTrack.slice(0, 5).map(deal => (\n                      <div key={deal.id} className=\"flex items-center justify-between text-sm\">\n                        <span className=\"truncate\">{deal.name}</span>\n                        <span className=\"text-muted-foreground\">${deal.value}M</span>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </div>\n\n              {/* Delayed */}\n              <div className=\"p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20\">\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <Clock className=\"w-5 h-5 text-yellow-500\" />\n                  <h3 className=\"font-medium text-yellow-500\">Delayed</h3>\n                  <Badge variant=\"secondary\" className=\"ml-auto bg-yellow-500/20 text-yellow-500\">\n                    {riskAnalysis.delayed.length}\n                  </Badge>\n                </div>\n                <ScrollArea className=\"h-32\">\n                  <div className=\"space-y-2\">\n                    {riskAnalysis.delayed.slice(0, 5).map(deal => (\n                      <div key={deal.id} className=\"flex items-center justify-between text-sm\">\n                        <span className=\"truncate\">{deal.name}</span>\n                        <span className=\"text-muted-foreground\">${deal.value}M</span>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </div>\n\n              {/* At Risk */}\n              <div className=\"p-4 rounded-lg bg-red-500/10 border border-red-500/20\">\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <AlertTriangle className=\"w-5 h-5 text-red-500\" />\n                  <h3 className=\"font-medium text-red-500\">At Risk</h3>\n                  <Badge variant=\"secondary\" className=\"ml-auto bg-red-500/20 text-red-500\">\n                    {riskAnalysis.atRisk.length}\n                  </Badge>\n                </div>\n                <ScrollArea className=\"h-32\">\n                  <div className=\"space-y-2\">\n                    {riskAnalysis.atRisk.slice(0, 5).map(deal => (\n                      <div key={deal.id} className=\"flex items-center justify-between text-sm\">\n                        <span className=\"truncate\">{deal.name}</span>\n                        <span className=\"text-muted-foreground\">${deal.value}M</span>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":21117,"size_tokens":null},"client/src/pages/shared/TimeTracking.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Clock,\n  Play,\n  Pause,\n  Square,\n  Plus,\n  Calendar,\n  Briefcase,\n  BarChart3,\n  TrendingUp,\n  Timer,\n  Trash2\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing, useTimeEntries, useCreateTimeEntry, useDeleteTimeEntry } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { format, startOfWeek, endOfWeek, eachDayOfInterval, isSameDay, parseISO } from \"date-fns\";\nimport { toast } from \"sonner\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell\n} from \"recharts\";\n\ntype TimeTrackingProps = {\n  role: 'CEO' | 'Employee';\n};\n\nconst COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];\n\nexport default function TimeTracking({ role }: TimeTrackingProps) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [] } = useDealsListing();\n  const { data: timeEntries = [], isLoading } = useTimeEntries();\n  const createTimeEntry = useCreateTimeEntry();\n  const deleteTimeEntry = useDeleteTimeEntry();\n  \n  const [isTimerRunning, setIsTimerRunning] = useState(false);\n  const [timerSeconds, setTimerSeconds] = useState(0);\n  const [timerDeal, setTimerDeal] = useState<string>(\"\");\n  const [showAddEntry, setShowAddEntry] = useState(false);\n  const [selectedWeek] = useState(new Date());\n\n  const [newEntry, setNewEntry] = useState({\n    dealId: '',\n    hours: '',\n    minutes: '',\n    description: '',\n    category: 'General',\n    billable: true,\n  });\n\n  useEffect(() => {\n    let interval: NodeJS.Timeout;\n    if (isTimerRunning) {\n      interval = setInterval(() => {\n        setTimerSeconds(prev => prev + 1);\n      }, 1000);\n    }\n    return () => clearInterval(interval);\n  }, [isTimerRunning]);\n\n  const weekStart = startOfWeek(selectedWeek);\n  const weekEnd = endOfWeek(selectedWeek);\n  const weekDays = eachDayOfInterval({ start: weekStart, end: weekEnd });\n\n  const entries = useMemo(() => {\n    return timeEntries.map(e => ({\n      ...e,\n      dateObj: parseISO(e.date),\n      dealName: deals.find(d => d.id === e.dealId)?.name || 'Unknown Deal'\n    })).sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());\n  }, [timeEntries, deals]);\n\n  const weeklyHours = useMemo(() => {\n    return weekDays.map(day => {\n      const dayEntries = entries.filter(e => isSameDay(e.dateObj, day));\n      const totalMinutes = dayEntries.reduce((sum, e) => sum + (e.hours || 0), 0);\n      return {\n        day: format(day, 'EEE'),\n        hours: Math.round(totalMinutes / 60 * 10) / 10,\n        date: day,\n      };\n    });\n  }, [entries, weekDays]);\n\n  const hoursByDeal = useMemo(() => {\n    const dealHours: Record<string, number> = {};\n    entries.forEach(e => {\n      dealHours[e.dealName] = (dealHours[e.dealName] || 0) + (e.hours || 0);\n    });\n    return Object.entries(dealHours)\n      .map(([name, minutes]) => ({ name, hours: Math.round(minutes / 60 * 10) / 10 }))\n      .sort((a, b) => b.hours - a.hours)\n      .slice(0, 5);\n  }, [entries]);\n\n  const stats = useMemo(() => {\n    const thisWeekEntries = entries.filter(e => e.dateObj >= weekStart && e.dateObj <= weekEnd);\n    const thisWeekMinutes = thisWeekEntries.reduce((sum, e) => sum + (e.hours || 0), 0);\n    const billableMinutes = thisWeekEntries.filter(e => e.billable).reduce((sum, e) => sum + (e.hours || 0), 0);\n    const totalMinutes = entries.reduce((sum, e) => sum + (e.hours || 0), 0);\n    \n    return {\n      thisWeek: Math.round(thisWeekMinutes / 60 * 10) / 10,\n      billable: Math.round(billableMinutes / 60 * 10) / 10,\n      total: Math.round(totalMinutes / 60 * 10) / 10,\n      billableRate: thisWeekMinutes > 0 ? Math.round((billableMinutes / thisWeekMinutes) * 100) : 0,\n    };\n  }, [entries, weekStart, weekEnd]);\n\n  const formatDuration = (minutes: number) => {\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    return `${hours}h ${mins}m`;\n  };\n\n  const handleStartTimer = () => {\n    if (!timerDeal) return;\n    setIsTimerRunning(true);\n  };\n\n  const handleStopTimer = async () => {\n    setIsTimerRunning(false);\n    \n    if (timerSeconds >= 60) {\n      const minutes = Math.round(timerSeconds / 60);\n      try {\n        await createTimeEntry.mutateAsync({\n          dealId: timerDeal,\n          hours: minutes,\n          date: format(new Date(), 'yyyy-MM-dd'),\n          description: 'Timer entry',\n          category: 'General',\n          billable: true,\n        });\n        toast.success(`Logged ${formatDuration(minutes)} for deal`);\n      } catch (error) {\n        toast.error('Failed to save time entry');\n      }\n    }\n    \n    setTimerSeconds(0);\n    setTimerDeal('');\n  };\n\n  const handleAddEntry = async () => {\n    const totalMinutes = parseInt(newEntry.hours || '0') * 60 + parseInt(newEntry.minutes || '0');\n    if (!newEntry.dealId || totalMinutes <= 0) {\n      toast.error('Please select a deal and enter time');\n      return;\n    }\n    \n    try {\n      await createTimeEntry.mutateAsync({\n        dealId: newEntry.dealId,\n        hours: totalMinutes,\n        date: format(new Date(), 'yyyy-MM-dd'),\n        description: newEntry.description,\n        category: newEntry.category,\n        billable: newEntry.billable,\n      });\n      toast.success('Time entry saved');\n      setShowAddEntry(false);\n      setNewEntry({ dealId: '', hours: '', minutes: '', description: '', category: 'General', billable: true });\n    } catch (error) {\n      toast.error('Failed to save time entry');\n    }\n  };\n\n  const handleDeleteEntry = async (id: string) => {\n    try {\n      await deleteTimeEntry.mutateAsync(id);\n      toast.success('Time entry deleted');\n    } catch (error) {\n      toast.error('Failed to delete time entry');\n    }\n  };\n\n  return (\n    <Layout role={role} pageTitle=\"Time Tracking\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Clock className=\"w-6 h-6 text-primary\" />\n              Time Tracking\n            </h1>\n            <p className=\"text-muted-foreground\">Track time spent on deals and tasks</p>\n          </div>\n          <Button onClick={() => setShowAddEntry(true)} data-testid=\"button-add-entry\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Log Time\n          </Button>\n        </div>\n\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-6\">\n              <div className=\"flex-1 max-w-xs\">\n                <Label className=\"text-sm text-muted-foreground mb-2 block\">Select Deal</Label>\n                <Select value={timerDeal} onValueChange={setTimerDeal} disabled={isTimerRunning}>\n                  <SelectTrigger data-testid=\"select-timer-deal\">\n                    <SelectValue placeholder=\"Choose a deal...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {deals.filter(d => d.status === 'Active').map(deal => (\n                      <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"flex items-center gap-4\">\n                <div className=\"text-4xl font-mono font-bold min-w-[120px] text-center\">\n                  {String(Math.floor(timerSeconds / 3600)).padStart(2, '0')}:\n                  {String(Math.floor((timerSeconds % 3600) / 60)).padStart(2, '0')}:\n                  {String(timerSeconds % 60).padStart(2, '0')}\n                </div>\n                \n                <div className=\"flex items-center gap-2\">\n                  {!isTimerRunning ? (\n                    <Button \n                      onClick={handleStartTimer} \n                      disabled={!timerDeal}\n                      className=\"bg-green-500 hover:bg-green-600\"\n                      data-testid=\"button-start-timer\"\n                    >\n                      <Play className=\"w-4 h-4 mr-1\" />\n                      Start\n                    </Button>\n                  ) : (\n                    <>\n                      <Button \n                        variant=\"outline\"\n                        onClick={() => setIsTimerRunning(false)}\n                        data-testid=\"button-pause-timer\"\n                      >\n                        <Pause className=\"w-4 h-4\" />\n                      </Button>\n                      <Button \n                        onClick={handleStopTimer}\n                        className=\"bg-red-500 hover:bg-red-600\"\n                        data-testid=\"button-stop-timer\"\n                      >\n                        <Square className=\"w-4 h-4 mr-1\" />\n                        Stop\n                      </Button>\n                    </>\n                  )}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">This Week</p>\n                  <p className=\"text-2xl font-bold\">{stats.thisWeek}h</p>\n                </div>\n                <Timer className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Billable Hours</p>\n                  <p className=\"text-2xl font-bold text-green-500\">{stats.billable}h</p>\n                </div>\n                <TrendingUp className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Billable Rate</p>\n                  <p className=\"text-2xl font-bold text-blue-500\">{stats.billableRate}%</p>\n                </div>\n                <BarChart3 className=\"w-5 h-5 text-blue-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Logged</p>\n                  <p className=\"text-2xl font-bold\">{stats.total}h</p>\n                </div>\n                <Clock className=\"w-5 h-5 text-muted-foreground\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5 text-primary\" />\n                Weekly Hours\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={250}>\n                <BarChart data={weeklyHours}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"day\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Bar dataKey=\"hours\" fill=\"#3b82f6\" radius={[4, 4, 0, 0]} />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Briefcase className=\"w-5 h-5 text-primary\" />\n                Hours by Deal\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {hoursByDeal.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height={250}>\n                  <PieChart>\n                    <Pie\n                      data={hoursByDeal}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      innerRadius={50}\n                      outerRadius={80}\n                      paddingAngle={5}\n                      dataKey=\"hours\"\n                      label={({ name, hours }) => `${name}: ${hours}h`}\n                    >\n                      {hoursByDeal.map((_, index) => (\n                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                      ))}\n                    </Pie>\n                    <Tooltip \n                      contentStyle={{ \n                        backgroundColor: 'hsl(var(--card))', \n                        border: '1px solid hsl(var(--border))',\n                        borderRadius: '8px'\n                      }} \n                    />\n                  </PieChart>\n                </ResponsiveContainer>\n              ) : (\n                <div className=\"h-[250px] flex items-center justify-center text-muted-foreground\">\n                  No time entries yet\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"w-5 h-5 text-primary\" />\n              Recent Time Entries\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n            ) : entries.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No time entries yet. Click \"Log Time\" to add your first entry.\n              </div>\n            ) : (\n              <ScrollArea className=\"h-64\">\n                <div className=\"space-y-2\">\n                  {entries.slice(0, 15).map(entry => (\n                    <div key={entry.id} className=\"flex items-center justify-between p-3 rounded-lg border border-border hover:bg-secondary/50 group\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className={cn(\n                          \"w-2 h-full rounded-full min-h-[40px]\",\n                          entry.billable ? \"bg-green-500\" : \"bg-gray-500\"\n                        )} />\n                        <div>\n                          <p className=\"font-medium\">{entry.dealName}</p>\n                          <p className=\"text-sm text-muted-foreground\">{entry.description || entry.category}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"text-right\">\n                          <p className=\"font-mono font-medium\">{formatDuration(entry.hours || 0)}</p>\n                          <p className=\"text-xs text-muted-foreground\">{format(entry.dateObj, 'MMM d, yyyy')}</p>\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"opacity-0 group-hover:opacity-100 transition-opacity\"\n                          onClick={() => handleDeleteEntry(entry.id)}\n                          data-testid={`button-delete-entry-${entry.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </ScrollArea>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={showAddEntry} onOpenChange={setShowAddEntry}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Log Time Entry</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Deal</Label>\n              <Select value={newEntry.dealId} onValueChange={(v) => setNewEntry(prev => ({ ...prev, dealId: v }))}>\n                <SelectTrigger data-testid=\"select-entry-deal\">\n                  <SelectValue placeholder=\"Select a deal...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {deals.map(deal => (\n                    <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Category</Label>\n              <Select value={newEntry.category} onValueChange={(v) => setNewEntry(prev => ({ ...prev, category: v }))}>\n                <SelectTrigger data-testid=\"select-entry-category\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"General\">General</SelectItem>\n                  <SelectItem value=\"Meetings\">Meetings</SelectItem>\n                  <SelectItem value=\"Research\">Research</SelectItem>\n                  <SelectItem value=\"Document Review\">Document Review</SelectItem>\n                  <SelectItem value=\"Client Calls\">Client Calls</SelectItem>\n                  <SelectItem value=\"Due Diligence\">Due Diligence</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Hours</Label>\n                <Input\n                  type=\"number\"\n                  min=\"0\"\n                  value={newEntry.hours}\n                  onChange={(e) => setNewEntry(prev => ({ ...prev, hours: e.target.value }))}\n                  placeholder=\"0\"\n                  data-testid=\"input-hours\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Minutes</Label>\n                <Input\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"59\"\n                  value={newEntry.minutes}\n                  onChange={(e) => setNewEntry(prev => ({ ...prev, minutes: e.target.value }))}\n                  placeholder=\"0\"\n                  data-testid=\"input-minutes\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Description</Label>\n              <Textarea\n                value={newEntry.description}\n                onChange={(e) => setNewEntry(prev => ({ ...prev, description: e.target.value }))}\n                placeholder=\"What did you work on?\"\n                data-testid=\"input-description\"\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <input\n                type=\"checkbox\"\n                id=\"billable\"\n                checked={newEntry.billable}\n                onChange={(e) => setNewEntry(prev => ({ ...prev, billable: e.target.checked }))}\n              />\n              <Label htmlFor=\"billable\">Billable</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAddEntry(false)}>Cancel</Button>\n            <Button \n              onClick={handleAddEntry} \n              disabled={createTimeEntry.isPending}\n              data-testid=\"button-save-entry\"\n            >\n              {createTimeEntry.isPending ? 'Saving...' : 'Save Entry'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":20975,"size_tokens":null},"client/src/pages/ceo/AuditTrail.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport {\n  FileText,\n  Search,\n  Download,\n  Calendar as CalendarIcon,\n  User,\n  Briefcase,\n  CheckSquare,\n  MessageSquare,\n  AlertTriangle,\n  Shield,\n  Clock,\n  PlusCircle,\n  Edit,\n  Trash2,\n  Eye,\n  Loader2\n} from \"lucide-react\";\nimport { useCurrentUser, useAuditLogs } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { format, subDays, isAfter, isBefore, parseISO } from \"date-fns\";\n\nconst actionIcons: Record<string, React.ElementType> = {\n  Deal: Briefcase,\n  Task: CheckSquare,\n  Document: FileText,\n  User: User,\n  Message: MessageSquare,\n  System: Shield,\n  TimeEntry: Clock,\n  TimeOffRequest: CalendarIcon,\n  Investor: User,\n  InvestorInteraction: MessageSquare,\n};\n\nconst actionColors: Record<string, string> = {\n  CREATE: 'text-green-500',\n  UPDATE: 'text-blue-500',\n  DELETE: 'text-red-500',\n  VIEW: 'text-gray-500',\n  EXPORT: 'text-purple-500',\n  LOGIN: 'text-green-500',\n  LOGOUT: 'text-gray-500',\n  ASSIGN: 'text-yellow-500',\n  COMPLETE: 'text-green-500',\n};\n\nconst actionIconMap: Record<string, React.ElementType> = {\n  CREATE: PlusCircle,\n  UPDATE: Edit,\n  DELETE: Trash2,\n  VIEW: Eye,\n};\n\nexport default function AuditTrail() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: auditLogs = [], isLoading } = useAuditLogs(500);\n  \n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterAction, setFilterAction] = useState<string>(\"all\");\n  const [filterEntity, setFilterEntity] = useState<string>(\"all\");\n  const [dateRange, setDateRange] = useState<{ from: Date | undefined; to: Date | undefined }>({\n    from: subDays(new Date(), 30),\n    to: new Date(),\n  });\n\n  const logs = useMemo(() => {\n    return auditLogs.map(log => ({\n      ...log,\n      timestampObj: parseISO(log.timestamp),\n    }));\n  }, [auditLogs]);\n\n  const filteredLogs = useMemo(() => {\n    return logs.filter(log => {\n      if (searchQuery) {\n        const query = searchQuery.toLowerCase();\n        if (!log.details?.toLowerCase().includes(query) && \n            !log.userName?.toLowerCase().includes(query) &&\n            !log.entityType?.toLowerCase().includes(query)) {\n          return false;\n        }\n      }\n      if (filterAction !== 'all' && log.action !== filterAction) return false;\n      if (filterEntity !== 'all' && log.entityType !== filterEntity) return false;\n      if (dateRange.from && isBefore(log.timestampObj, dateRange.from)) return false;\n      if (dateRange.to && isAfter(log.timestampObj, dateRange.to)) return false;\n      return true;\n    });\n  }, [logs, searchQuery, filterAction, filterEntity, dateRange]);\n\n  const stats = useMemo(() => {\n    const today = new Date();\n    const todayLogs = logs.filter(l => format(l.timestampObj, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd'));\n    const deleteActions = logs.filter(l => l.action === 'DELETE');\n    const uniqueUsers = new Set(logs.map(l => l.userId)).size;\n    \n    return {\n      total: logs.length,\n      today: todayLogs.length,\n      deletes: deleteActions.length,\n      activeUsers: uniqueUsers,\n    };\n  }, [logs]);\n\n  const uniqueEntityTypes = useMemo(() => {\n    return [...new Set(logs.map(l => l.entityType))].filter(Boolean);\n  }, [logs]);\n\n  const exportAuditLog = () => {\n    const csv = [\n      ['Timestamp', 'User', 'Action', 'Entity Type', 'Entity ID', 'Details'],\n      ...filteredLogs.map(l => [\n        format(l.timestampObj, 'yyyy-MM-dd HH:mm:ss'),\n        l.userName || 'Unknown',\n        l.action,\n        l.entityType,\n        l.entityId,\n        l.details || '',\n      ])\n    ].map(row => row.join(',')).join('\\n');\n    \n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `audit-log-${format(new Date(), 'yyyy-MM-dd')}.csv`;\n    a.click();\n  };\n\n  const getSeverity = (action: string) => {\n    if (action === 'DELETE') return 'critical';\n    if (action === 'UPDATE' || action === 'EXPORT') return 'warning';\n    return 'info';\n  };\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Audit Trail\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Shield className=\"w-6 h-6 text-primary\" />\n              Audit Trail & Compliance\n            </h1>\n            <p className=\"text-muted-foreground\">Track all system activities and user actions</p>\n          </div>\n          <Button onClick={exportAuditLog} data-testid=\"button-export-audit\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export Log\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Events</p>\n                  <p className=\"text-2xl font-bold\">{stats.total}</p>\n                </div>\n                <FileText className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Today's Activity</p>\n                  <p className=\"text-2xl font-bold text-blue-500\">{stats.today}</p>\n                </div>\n                <Clock className=\"w-5 h-5 text-blue-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Delete Actions</p>\n                  <p className=\"text-2xl font-bold text-red-500\">{stats.deletes}</p>\n                </div>\n                <AlertTriangle className=\"w-5 h-5 text-red-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Active Users</p>\n                  <p className=\"text-2xl font-bold text-green-500\">{stats.activeUsers}</p>\n                </div>\n                <User className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"bg-card border-border\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-wrap gap-4\">\n              <div className=\"flex-1 min-w-[200px]\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search events...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-audit\"\n                  />\n                </div>\n              </div>\n              <Select value={filterAction} onValueChange={setFilterAction}>\n                <SelectTrigger className=\"w-32\" data-testid=\"select-filter-action\">\n                  <SelectValue placeholder=\"Action\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Actions</SelectItem>\n                  <SelectItem value=\"CREATE\">Create</SelectItem>\n                  <SelectItem value=\"UPDATE\">Update</SelectItem>\n                  <SelectItem value=\"DELETE\">Delete</SelectItem>\n                  <SelectItem value=\"VIEW\">View</SelectItem>\n                  <SelectItem value=\"EXPORT\">Export</SelectItem>\n                </SelectContent>\n              </Select>\n              <Select value={filterEntity} onValueChange={setFilterEntity}>\n                <SelectTrigger className=\"w-40\" data-testid=\"select-filter-entity\">\n                  <SelectValue placeholder=\"Entity\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Entities</SelectItem>\n                  {uniqueEntityTypes.map(type => (\n                    <SelectItem key={type} value={type}>{type}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Popover>\n                <PopoverTrigger asChild>\n                  <Button variant=\"outline\" className=\"w-auto\" data-testid=\"button-date-range\">\n                    <CalendarIcon className=\"w-4 h-4 mr-2\" />\n                    {dateRange.from && dateRange.to \n                      ? `${format(dateRange.from, 'MMM d')} - ${format(dateRange.to, 'MMM d')}`\n                      : 'Date Range'\n                    }\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-auto p-0\" align=\"end\">\n                  <Calendar\n                    mode=\"range\"\n                    selected={{ from: dateRange.from, to: dateRange.to }}\n                    onSelect={(range) => setDateRange({ from: range?.from, to: range?.to })}\n                  />\n                </PopoverContent>\n              </Popover>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-card border-border\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <FileText className=\"w-5 h-5 text-primary\" />\n              Activity Log ({filteredLogs.length} events)\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\n              </div>\n            ) : (\n              <ScrollArea className=\"h-[500px]\">\n                <div className=\"space-y-2\">\n                  {filteredLogs.map((log) => {\n                    const EntityIcon = actionIcons[log.entityType] || FileText;\n                    const ActionIcon = actionIconMap[log.action] || FileText;\n                    const severity = getSeverity(log.action);\n                    \n                    return (\n                      <div\n                        key={log.id}\n                        className={cn(\n                          \"flex items-center gap-4 p-3 rounded-lg border transition-colors hover:bg-secondary/50\",\n                          severity === 'critical' && \"border-red-500/30 bg-red-500/5\",\n                          severity === 'warning' && \"border-yellow-500/30 bg-yellow-500/5\",\n                          severity === 'info' && \"border-border\"\n                        )}\n                      >\n                        <div className={cn(\n                          \"w-10 h-10 rounded-full flex items-center justify-center\",\n                          severity === 'critical' && \"bg-red-500/20\",\n                          severity === 'warning' && \"bg-yellow-500/20\",\n                          severity === 'info' && \"bg-primary/20\"\n                        )}>\n                          <EntityIcon className={cn(\n                            \"w-5 h-5\",\n                            severity === 'critical' && \"text-red-500\",\n                            severity === 'warning' && \"text-yellow-500\",\n                            severity === 'info' && \"text-primary\"\n                          )} />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-medium\">{log.userName || 'System'}</span>\n                            <Badge variant=\"secondary\" className={cn(\"text-xs capitalize\", actionColors[log.action])}>\n                              {log.action}\n                            </Badge>\n                            <Badge variant=\"outline\" className=\"text-xs\">{log.entityType}</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground truncate\">{log.details || `${log.action} ${log.entityType}`}</p>\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            Entity ID: {log.entityId}\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            {format(log.timestampObj, 'MMM d, h:mm a')}\n                          </p>\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {filteredLogs.length === 0 && !isLoading && (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <FileText className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p>No audit events found</p>\n                      <p className=\"text-sm mt-1\">Actions will be logged here as they occur</p>\n                    </div>\n                  )}\n                </div>\n              </ScrollArea>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":14219,"size_tokens":null},"client/src/pages/ceo/WinLossAnalysis.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  TrendingUp,\n  TrendingDown,\n  Award,\n  XCircle,\n  BarChart3,\n  PieChart,\n  Target,\n  Users,\n  Building,\n  DollarSign,\n  Lightbulb,\n  AlertTriangle\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  BarChart,\n  Bar,\n  PieChart as RechartsPieChart,\n  Pie,\n  Cell,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  LineChart,\n  Line\n} from \"recharts\";\n\nconst COLORS = ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#06b6d4'];\n\n// Map legacy IB stages to new stages\nconst mapIBStage = (stage: string) => {\n  const legacyMap: Record<string, string> = {\n    'Due Diligence': 'Diligence',\n    'Negotiation': 'Legal',\n    'Closing': 'Close',\n    'Execution': 'Structuring',\n    'Signing': 'Close',\n    'Qualification': 'Origination',\n    'Pitch': 'Structuring',\n    'Documentation': 'Legal',\n  };\n  return legacyMap[stage] || stage;\n};\n\nexport default function WinLossAnalysis() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [] } = useDealsListing();\n  \n  const [timeframe, setTimeframe] = useState<string>(\"year\");\n\n  const wonDeals = useMemo(() => deals.filter(d => d.status === 'Closed'), [deals]);\n  const lostDeals = useMemo(() => deals.filter(d => d.status === 'Lost'), [deals]);\n  const activeDeals = useMemo(() => deals.filter(d => d.status === 'Active'), [deals]);\n\n  const winRate = useMemo(() => {\n    const completed = wonDeals.length + lostDeals.length;\n    return completed > 0 ? Math.round((wonDeals.length / completed) * 100) : 0;\n  }, [wonDeals, lostDeals]);\n\n  const stats = useMemo(() => ({\n    totalWon: wonDeals.length,\n    totalLost: lostDeals.length,\n    wonValue: wonDeals.reduce((sum, d) => sum + d.value, 0),\n    lostValue: lostDeals.reduce((sum, d) => sum + d.value, 0),\n    avgWonValue: wonDeals.length > 0 ? Math.round(wonDeals.reduce((sum, d) => sum + d.value, 0) / wonDeals.length) : 0,\n    avgLostValue: lostDeals.length > 0 ? Math.round(lostDeals.reduce((sum, d) => sum + d.value, 0) / lostDeals.length) : 0,\n  }), [wonDeals, lostDeals]);\n\n  const winLossByStage = useMemo(() => {\n    const stages = ['Origination', 'Structuring', 'Diligence', 'Legal', 'Close'];\n    return stages.map(stage => ({\n      stage,\n      won: wonDeals.filter(d => mapIBStage(d.stage) === stage).length,\n      lost: lostDeals.filter(d => mapIBStage(d.stage) === stage).length,\n    }));\n  }, [wonDeals, lostDeals]);\n\n  const winLossBySector = useMemo(() => {\n    const sectorMap: Record<string, { won: number; lost: number }> = {};\n    wonDeals.forEach(d => {\n      if (!sectorMap[d.sector]) sectorMap[d.sector] = { won: 0, lost: 0 };\n      sectorMap[d.sector].won++;\n    });\n    lostDeals.forEach(d => {\n      if (!sectorMap[d.sector]) sectorMap[d.sector] = { won: 0, lost: 0 };\n      sectorMap[d.sector].lost++;\n    });\n    return Object.entries(sectorMap).map(([sector, data]) => ({\n      sector,\n      won: data.won,\n      lost: data.lost,\n      winRate: data.won + data.lost > 0 ? Math.round((data.won / (data.won + data.lost)) * 100) : 0,\n    }));\n  }, [wonDeals, lostDeals]);\n\n  const monthlyTrend = [\n    { month: 'Jan', won: 2, lost: 1 },\n    { month: 'Feb', won: 3, lost: 2 },\n    { month: 'Mar', won: 2, lost: 0 },\n    { month: 'Apr', won: 4, lost: 1 },\n    { month: 'May', won: 3, lost: 2 },\n    { month: 'Jun', won: 5, lost: 1 },\n    { month: 'Jul', won: 4, lost: 3 },\n    { month: 'Aug', won: 6, lost: 2 },\n    { month: 'Sep', won: 4, lost: 1 },\n    { month: 'Oct', won: 5, lost: 2 },\n    { month: 'Nov', won: 7, lost: 1 },\n    { month: 'Dec', won: wonDeals.length, lost: lostDeals.length },\n  ];\n\n  const lossReasons = [\n    { reason: 'Price/Valuation', count: 8, percentage: 32 },\n    { reason: 'Competition', count: 5, percentage: 20 },\n    { reason: 'Deal Timing', count: 4, percentage: 16 },\n    { reason: 'Market Conditions', count: 3, percentage: 12 },\n    { reason: 'Buyer Fit', count: 3, percentage: 12 },\n    { reason: 'Due Diligence Issues', count: 2, percentage: 8 },\n  ];\n\n  const winFactors = [\n    { factor: 'Strong Relationships', count: 12, percentage: 35 },\n    { factor: 'Market Timing', count: 8, percentage: 24 },\n    { factor: 'Valuation Alignment', count: 6, percentage: 18 },\n    { factor: 'Unique Value Prop', count: 5, percentage: 15 },\n    { factor: 'Speed to Close', count: 3, percentage: 8 },\n  ];\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Win/Loss Analysis\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <BarChart3 className=\"w-6 h-6 text-primary\" />\n              Win/Loss Analysis\n            </h1>\n            <p className=\"text-muted-foreground\">Analyze deal outcomes to improve performance</p>\n          </div>\n          <Select value={timeframe} onValueChange={setTimeframe}>\n            <SelectTrigger className=\"w-32\" data-testid=\"select-timeframe\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"quarter\">This Quarter</SelectItem>\n              <SelectItem value=\"year\">This Year</SelectItem>\n              <SelectItem value=\"all\">All Time</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* Key Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Win Rate</p>\n                  <p className=\"text-2xl font-bold text-primary\">{winRate}%</p>\n                </div>\n                <Target className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Deals Won</p>\n                  <p className=\"text-2xl font-bold text-green-500\">{stats.totalWon}</p>\n                </div>\n                <Award className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Deals Lost</p>\n                  <p className=\"text-2xl font-bold text-red-500\">{stats.totalLost}</p>\n                </div>\n                <XCircle className=\"w-5 h-5 text-red-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Won Value</p>\n                  <p className=\"text-2xl font-bold text-green-500\">${stats.wonValue}M</p>\n                </div>\n                <DollarSign className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Lost Value</p>\n                  <p className=\"text-2xl font-bold text-red-500\">${stats.lostValue}M</p>\n                </div>\n                <DollarSign className=\"w-5 h-5 text-red-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Charts */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Win/Loss Trend */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-5 h-5 text-primary\" />\n                Monthly Win/Loss Trend\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <LineChart data={monthlyTrend}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"month\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Legend />\n                  <Line type=\"monotone\" dataKey=\"won\" name=\"Won\" stroke=\"#10b981\" strokeWidth={2} />\n                  <Line type=\"monotone\" dataKey=\"lost\" name=\"Lost\" stroke=\"#ef4444\" strokeWidth={2} />\n                </LineChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Win/Loss by Sector */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Building className=\"w-5 h-5 text-primary\" />\n                Win Rate by Sector\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={winLossBySector}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"sector\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Legend />\n                  <Bar dataKey=\"won\" name=\"Won\" fill=\"#10b981\" />\n                  <Bar dataKey=\"lost\" name=\"Lost\" fill=\"#ef4444\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Insights */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Loss Reasons */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"w-5 h-5 text-red-500\" />\n                Top Loss Reasons\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {lossReasons.map((reason, idx) => (\n                  <div key={idx} className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-medium\">{reason.reason}</span>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge variant=\"secondary\">{reason.count} deals</Badge>\n                        <span className=\"text-sm text-muted-foreground\">{reason.percentage}%</span>\n                      </div>\n                    </div>\n                    <div className=\"h-2 bg-secondary rounded-full overflow-hidden\">\n                      <div \n                        className=\"h-full bg-red-500 rounded-full\" \n                        style={{ width: `${reason.percentage}%` }}\n                      />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Win Factors */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Lightbulb className=\"w-5 h-5 text-green-500\" />\n                Top Win Factors\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {winFactors.map((factor, idx) => (\n                  <div key={idx} className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-medium\">{factor.factor}</span>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge variant=\"secondary\">{factor.count} deals</Badge>\n                        <span className=\"text-sm text-muted-foreground\">{factor.percentage}%</span>\n                      </div>\n                    </div>\n                    <div className=\"h-2 bg-secondary rounded-full overflow-hidden\">\n                      <div \n                        className=\"h-full bg-green-500 rounded-full\" \n                        style={{ width: `${factor.percentage}%` }}\n                      />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Deal Lists */}\n        <Tabs defaultValue=\"won\" className=\"w-full\">\n          <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n            <TabsTrigger value=\"won\" data-testid=\"tab-won-deals\">Won Deals ({wonDeals.length})</TabsTrigger>\n            <TabsTrigger value=\"lost\" data-testid=\"tab-lost-deals\">Lost Deals ({lostDeals.length})</TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"won\">\n            <Card className=\"bg-card border-border\">\n              <CardContent className=\"p-4\">\n                <ScrollArea className=\"h-64\">\n                  <div className=\"space-y-2\">\n                    {wonDeals.map(deal => (\n                      <div key={deal.id} className=\"flex items-center justify-between p-3 rounded-lg border border-green-500/30 bg-green-500/5\">\n                        <div>\n                          <p className=\"font-medium\">{deal.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{deal.client}  {deal.sector}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-bold text-green-500\">${deal.value}M</p>\n                          <Badge variant=\"secondary\">{deal.stage}</Badge>\n                        </div>\n                      </div>\n                    ))}\n                    {wonDeals.length === 0 && (\n                      <p className=\"text-center py-8 text-muted-foreground\">No won deals yet</p>\n                    )}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          </TabsContent>\n          \n          <TabsContent value=\"lost\">\n            <Card className=\"bg-card border-border\">\n              <CardContent className=\"p-4\">\n                <ScrollArea className=\"h-64\">\n                  <div className=\"space-y-2\">\n                    {lostDeals.map(deal => (\n                      <div key={deal.id} className=\"flex items-center justify-between p-3 rounded-lg border border-red-500/30 bg-red-500/5\">\n                        <div>\n                          <p className=\"font-medium\">{deal.name}</p>\n                          <p className=\"text-sm text-muted-foreground\">{deal.client}  {deal.sector}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-bold text-red-500\">${deal.value}M</p>\n                          <Badge variant=\"secondary\">{deal.stage}</Badge>\n                        </div>\n                      </div>\n                    ))}\n                    {lostDeals.length === 0 && (\n                      <p className=\"text-center py-8 text-muted-foreground\">No lost deals</p>\n                    )}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":16959,"size_tokens":null},"client/src/pages/ceo/TeamPerformance.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Users,\n  TrendingUp,\n  TrendingDown,\n  Award,\n  Target,\n  Clock,\n  CheckCircle,\n  BarChart3,\n  Star,\n  Briefcase,\n  ArrowUpRight,\n  ArrowDownRight,\n  Calendar,\n  Search\n} from \"lucide-react\";\nimport { useCurrentUser, useUsers, useDealsListing, useTasks } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  BarChart,\n  Bar,\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  RadarChart,\n  PolarGrid,\n  PolarAngleAxis,\n  PolarRadiusAxis,\n  Radar\n} from \"recharts\";\n\nexport default function TeamPerformance() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [] } = useUsers();\n  const { data: deals = [] } = useDealsListing();\n  const { data: tasks = [] } = useTasks();\n  \n  const [timeframe, setTimeframe] = useState<string>(\"month\");\n  const [selectedMember, setSelectedMember] = useState<string | null>(null);\n  const [memberSearch, setMemberSearch] = useState<string>(\"\");\n\n  // Helper to get date range based on timeframe\n  const getTimeframeRange = (tf: string) => {\n    const now = new Date();\n    let start: Date;\n    switch (tf) {\n      case 'week':\n        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);\n        break;\n      case 'month':\n        start = new Date(now.getFullYear(), now.getMonth(), 1);\n        break;\n      case 'quarter':\n        const quarterMonth = Math.floor(now.getMonth() / 3) * 3;\n        start = new Date(now.getFullYear(), quarterMonth, 1);\n        break;\n      case 'year':\n        start = new Date(now.getFullYear(), 0, 1);\n        break;\n      default:\n        start = new Date(now.getFullYear(), now.getMonth(), 1);\n    }\n    return { start, end: now };\n  };\n\n  const teamMembers = useMemo(() => {\n    const { start, end } = getTimeframeRange(timeframe);\n    \n    // Helper to check if a date is within the timeframe\n    const isInTimeframe = (dateStr: string | Date | null | undefined) => {\n      if (!dateStr) return false;\n      const date = new Date(dateStr);\n      return date >= start && date <= end;\n    };\n    \n    return users\n      .filter(u => u.status === 'active')\n      .map(user => {\n      // Get ALL user's tasks (for base counts)\n      const allUserTasks = tasks.filter(t => t.assignedTo === user.id);\n      const allUserCompletedTasks = allUserTasks.filter(t => t.status === 'Completed');\n      \n      // Get ALL user's deals\n      const allUserDeals = deals.filter(d => \n        d.lead === user.name || (d as any).podTeam?.some((p: any) => p.name === user.name)\n      );\n      \n      // Filter tasks for the timeframe (completed within timeframe)\n      const timeframeCompletedTasks = allUserCompletedTasks.filter(t => {\n        if (!t.completedAt) return false;\n        return isInTimeframe(t.completedAt);\n      });\n      \n      // Filter deals created within the timeframe\n      const timeframeDeals = allUserDeals.filter(d => {\n        if (!d.createdAt) return false;\n        return isInTimeframe(d.createdAt);\n      });\n      \n      // Filter tasks that have activity within the timeframe (due or completed in timeframe)\n      const timeframeTasks = allUserTasks.filter(t => {\n        const dueInRange = t.dueDate && isInTimeframe(t.dueDate);\n        const completedInRange = t.completedAt && isInTimeframe(t.completedAt);\n        return dueInRange || completedInRange;\n      });\n      \n      // Use timeframe data when available, fall back to all-time if no data in timeframe\n      const hasTimeframeData = timeframeTasks.length > 0 || timeframeDeals.length > 0;\n      const displayTasks = hasTimeframeData ? timeframeTasks : allUserTasks;\n      const displayCompletedTasks = hasTimeframeData ? timeframeCompletedTasks : allUserCompletedTasks;\n      const displayDeals = hasTimeframeData ? timeframeDeals : allUserDeals;\n      \n      const taskCompletionRate = displayTasks.length > 0 \n        ? Math.round((displayCompletedTasks.length / displayTasks.length) * 100) \n        : 0;\n      \n      const avgDealValue = displayDeals.length > 0\n        ? Math.round(displayDeals.reduce((sum, d) => sum + d.value, 0) / displayDeals.length)\n        : 0;\n      \n      const onTimeCompletions = displayCompletedTasks.filter(t => {\n        if (!t.dueDate || !t.completedAt) return false;\n        const dueDate = new Date(t.dueDate);\n        const completedDate = new Date(t.completedAt);\n        return completedDate <= dueDate;\n      }).length;\n      \n      const tasksWithCompletionDate = displayCompletedTasks.filter(t => t.completedAt).length;\n      const onTimeRate = tasksWithCompletionDate > 0\n        ? Math.round((onTimeCompletions / tasksWithCompletionDate) * 100)\n        : 0; // Default to 0% if no completed tasks\n      \n      const activeDeals = displayDeals.filter(d => d.status === 'Active').length;\n      const closedDeals = displayDeals.filter(d => d.status === 'Closed').length;\n      const pipelineValue = displayDeals.reduce((sum, d) => sum + d.value, 0);\n      \n      // Calculate a dynamic performance score based on actual metrics\n      // Weighted: Task Completion (30%), On-Time Rate (30%), Completed Tasks (20%), Deal Activity (20%)\n      const taskWeight = taskCompletionRate * 0.3;\n      const onTimeWeight = onTimeRate * 0.3;\n      const completedWeight = Math.min(displayCompletedTasks.length * 5, 100) * 0.2; // 5 points per task, max 100\n      const dealWeight = Math.min((activeDeals + closedDeals) * 10, 100) * 0.2; // 10 points per deal, max 100\n      const calculatedScore = Math.round(taskWeight + onTimeWeight + completedWeight + dealWeight);\n\n      return {\n        ...user,\n        taskCompletionRate,\n        avgDealValue,\n        onTimeRate,\n        totalTasks: displayTasks.length,\n        completedTasks: displayCompletedTasks.length,\n        activeDeals,\n        closedDeals,\n        pipelineValue,\n        calculatedScore, // Dynamic score based on performance\n        hasTimeframeData, // Flag to indicate if data is from timeframe or all-time\n      };\n    });\n  }, [users, deals, tasks, timeframe]);\n\n  const teamStats = useMemo(() => {\n    const totalTasks = teamMembers.reduce((sum, m) => sum + m.totalTasks, 0);\n    const completedTasks = teamMembers.reduce((sum, m) => sum + m.completedTasks, 0);\n    const activeDeals = teamMembers.reduce((sum, m) => sum + m.activeDeals, 0);\n    const avgCompletionRate = totalTasks > 0\n      ? Math.round((completedTasks / totalTasks) * 100)\n      : 0;\n    \n    return { totalTasks, completedTasks, activeDeals, avgCompletionRate };\n  }, [teamMembers]);\n\n  // Performance trends calculated based on timeframe\n  const performanceTrends = useMemo(() => {\n    const now = new Date();\n    const data: { period: string; tasks: number; deals: number; revenue: number }[] = [];\n    \n    // Generate data points based on selected timeframe\n    if (timeframe === 'week') {\n      // Last 7 days\n      for (let i = 6; i >= 0; i--) {\n        const date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);\n        const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);\n        const dayName = date.toLocaleString('default', { weekday: 'short' });\n        \n        const dayTasks = tasks.filter(t => {\n          if (t.status !== 'Completed' || !t.completedAt) return false;\n          const completedDate = new Date(t.completedAt);\n          return completedDate.toDateString() === date.toDateString();\n        }).length;\n        \n        const dayDeals = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt.toDateString() === date.toDateString();\n        }).length;\n        \n        const dayRevenue = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt.toDateString() === date.toDateString();\n        }).reduce((sum, d) => sum + d.value, 0);\n        \n        data.push({ period: dayName, tasks: dayTasks, deals: dayDeals, revenue: dayRevenue });\n      }\n    } else if (timeframe === 'month') {\n      // Weeks of current month - cover entire month (up to 5 weeks for 31-day months)\n      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();\n      const weeksNeeded = Math.ceil(daysInMonth / 7);\n      \n      for (let week = 0; week < weeksNeeded; week++) {\n        const weekStartDay = 1 + (week * 7);\n        const weekEndDay = Math.min((week + 1) * 7, daysInMonth);\n        const weekStart = new Date(monthStart.getFullYear(), monthStart.getMonth(), weekStartDay);\n        const weekEnd = new Date(monthStart.getFullYear(), monthStart.getMonth(), weekEndDay, 23, 59, 59);\n        \n        const weekTasks = tasks.filter(t => {\n          if (t.status !== 'Completed' || !t.completedAt) return false;\n          const completedDate = new Date(t.completedAt);\n          return completedDate >= weekStart && completedDate <= weekEnd;\n        }).length;\n        \n        const weekDeals = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= weekStart && createdAt <= weekEnd;\n        }).length;\n        \n        const weekRevenue = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= weekStart && createdAt <= weekEnd;\n        }).reduce((sum, d) => sum + d.value, 0);\n        \n        data.push({ period: `Week ${week + 1}`, tasks: weekTasks, deals: weekDeals, revenue: weekRevenue });\n      }\n    } else if (timeframe === 'quarter') {\n      // All 3 months of current quarter (always show all 3)\n      const quarterMonth = Math.floor(now.getMonth() / 3) * 3;\n      for (let i = 0; i < 3; i++) {\n        const monthStart = new Date(now.getFullYear(), quarterMonth + i, 1);\n        const monthEnd = new Date(now.getFullYear(), quarterMonth + i + 1, 0, 23, 59, 59);\n        const monthName = monthStart.toLocaleString('default', { month: 'short' });\n        \n        const monthTasks = tasks.filter(t => {\n          if (t.status !== 'Completed' || !t.completedAt) return false;\n          const completedDate = new Date(t.completedAt);\n          return completedDate >= monthStart && completedDate <= monthEnd;\n        }).length;\n        \n        const monthDeals = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= monthStart && createdAt <= monthEnd;\n        }).length;\n        \n        const monthRevenue = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= monthStart && createdAt <= monthEnd;\n        }).reduce((sum, d) => sum + d.value, 0);\n        \n        data.push({ period: monthName, tasks: monthTasks, deals: monthDeals, revenue: monthRevenue });\n      }\n    } else {\n      // Year - always show all 12 months\n      for (let i = 0; i < 12; i++) {\n        const monthStart = new Date(now.getFullYear(), i, 1);\n        const monthEnd = new Date(now.getFullYear(), i + 1, 0, 23, 59, 59);\n        const monthName = monthStart.toLocaleString('default', { month: 'short' });\n        \n        const monthTasks = tasks.filter(t => {\n          if (t.status !== 'Completed' || !t.completedAt) return false;\n          const completedDate = new Date(t.completedAt);\n          return completedDate >= monthStart && completedDate <= monthEnd;\n        }).length;\n        \n        const monthDeals = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= monthStart && createdAt <= monthEnd;\n        }).length;\n        \n        const monthRevenue = deals.filter(d => {\n          if (d.status !== 'Closed') return false;\n          const createdAt = d.createdAt ? new Date(d.createdAt) : null;\n          return createdAt && createdAt >= monthStart && createdAt <= monthEnd;\n        }).reduce((sum, d) => sum + d.value, 0);\n        \n        data.push({ period: monthName, tasks: monthTasks, deals: monthDeals, revenue: monthRevenue });\n      }\n    }\n    \n    return data;\n  }, [tasks, deals, timeframe]);\n\n  const leaderboard = useMemo(() => {\n    return [...teamMembers]\n      .sort((a, b) => b.calculatedScore - a.calculatedScore)\n      .slice(0, 5);\n  }, [teamMembers]);\n  \n  // Filtered team members based on search\n  const filteredTeamMembers = useMemo(() => {\n    if (!memberSearch.trim()) return teamMembers;\n    const searchLower = memberSearch.toLowerCase();\n    return teamMembers.filter(m => \n      m.name.toLowerCase().includes(searchLower) ||\n      (m.jobTitle?.toLowerCase() || '').includes(searchLower) ||\n      (m.email?.toLowerCase() || '').includes(searchLower)\n    );\n  }, [teamMembers, memberSearch]);\n\n  const roleDistribution = useMemo(() => {\n    const roles: Record<string, number> = {};\n    teamMembers.forEach(m => {\n      roles[m.role] = (roles[m.role] || 0) + 1;\n    });\n    return Object.entries(roles).map(([name, value]) => ({ name, value }));\n  }, [teamMembers]);\n\n  const selectedMemberData = selectedMember \n    ? teamMembers.find(m => m.id === selectedMember) \n    : null;\n\n  const selectedMemberRadar = selectedMemberData ? [\n    { metric: 'Task Completion', value: selectedMemberData.taskCompletionRate },\n    { metric: 'On-Time Delivery', value: selectedMemberData.onTimeRate },\n    { metric: 'Deal Activity', value: Math.min((selectedMemberData.activeDeals + selectedMemberData.closedDeals) * 10, 100) },\n    { metric: 'Pipeline Value', value: Math.min(selectedMemberData.pipelineValue / 10, 100) },\n    { metric: 'Overall Score', value: selectedMemberData.calculatedScore },\n  ] : [];\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Team Performance\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Team Performance Analytics</h1>\n            <p className=\"text-muted-foreground\">Monitor team productivity, workload, and trends</p>\n          </div>\n          <Select value={timeframe} onValueChange={setTimeframe}>\n            <SelectTrigger className=\"w-32\" data-testid=\"select-timeframe\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"week\">This Week</SelectItem>\n              <SelectItem value=\"month\">This Month</SelectItem>\n              <SelectItem value=\"quarter\">This Quarter</SelectItem>\n              <SelectItem value=\"year\">This Year</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* Summary Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Team Size</p>\n                  <p className=\"text-2xl font-bold\">{teamMembers.length}</p>\n                </div>\n                <Users className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Tasks Completed</p>\n                  <p className=\"text-2xl font-bold\">{teamStats.completedTasks}/{teamStats.totalTasks}</p>\n                </div>\n                <CheckCircle className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Avg Completion Rate</p>\n                  <p className=\"text-2xl font-bold\">{teamStats.avgCompletionRate}%</p>\n                </div>\n                <Target className=\"w-5 h-5 text-blue-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Active Deals</p>\n                  <p className=\"text-2xl font-bold\">{teamStats.activeDeals}</p>\n                </div>\n                <Briefcase className=\"w-5 h-5 text-purple-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Performance Trends Chart */}\n          <Card className=\"lg:col-span-2 bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <BarChart3 className=\"w-5 h-5 text-primary\" />\n                Performance Trends ({timeframe === 'week' ? 'This Week' : timeframe === 'month' ? 'This Month' : timeframe === 'quarter' ? 'This Quarter' : 'This Year'})\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={performanceTrends}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis dataKey=\"period\" stroke=\"hsl(var(--muted-foreground))\" />\n                  <YAxis stroke=\"hsl(var(--muted-foreground))\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: 'hsl(var(--card))', \n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px'\n                    }} \n                  />\n                  <Legend />\n                  <Bar dataKey=\"tasks\" name=\"Tasks Completed\" fill=\"#3b82f6\" />\n                  <Bar dataKey=\"deals\" name=\"Deals Closed\" fill=\"#10b981\" />\n                  <Bar dataKey=\"revenue\" name=\"Revenue ($M)\" fill=\"#8b5cf6\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          {/* Leaderboard */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Award className=\"w-5 h-5 text-yellow-500\" />\n                Top Performers\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {leaderboard.map((member, idx) => (\n                  <div \n                    key={member.id} \n                    className=\"flex items-center gap-3 p-2 rounded-lg hover:bg-secondary/50 transition-colors cursor-pointer\"\n                    onClick={() => setSelectedMember(member.id)}\n                  >\n                    <div className={cn(\n                      \"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold\",\n                      idx === 0 && \"bg-yellow-500/20 text-yellow-500\",\n                      idx === 1 && \"bg-gray-400/20 text-gray-400\",\n                      idx === 2 && \"bg-orange-500/20 text-orange-500\",\n                      idx > 2 && \"bg-secondary text-muted-foreground\"\n                    )}>\n                      {idx + 1}\n                    </div>\n                    <Avatar className=\"w-8 h-8\">\n                      <AvatarFallback className=\"text-xs bg-primary/20 text-primary\">\n                        {member.name.split(' ').map(n => n[0]).join('')}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium text-sm truncate\">{member.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">{member.jobTitle || member.role}</p>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Star className=\"w-4 h-4 text-yellow-500\" />\n                      <span className=\"font-medium\">{member.calculatedScore}</span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Team Members Grid */}\n        <Card className=\"bg-card border-border\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"w-5 h-5 text-primary\" />\n              Team Members ({filteredTeamMembers.length})\n            </CardTitle>\n            <div className=\"relative w-64\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search members...\"\n                value={memberSearch}\n                onChange={(e) => setMemberSearch(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-members\"\n              />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {filteredTeamMembers.map(member => (\n                <Card \n                  key={member.id} \n                  className={cn(\n                    \"bg-secondary/30 border cursor-pointer transition-all\",\n                    selectedMember === member.id ? \"border-primary\" : \"border-transparent hover:border-border\"\n                  )}\n                  onClick={() => setSelectedMember(member.id)}\n                  data-testid={`team-member-card-${member.id}`}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <Avatar className=\"w-12 h-12\">\n                        <AvatarFallback className=\"bg-primary/20 text-primary\">\n                          {member.name.split(' ').map(n => n[0]).join('')}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"flex-1 min-w-0\">\n                        <h4 className=\"font-medium truncate\">{member.name}</h4>\n                        <Badge variant=\"secondary\" className=\"text-xs mt-1\">{member.jobTitle || member.role}</Badge>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        <Star className=\"w-4 h-4 text-yellow-500\" />\n                        <span className=\"font-medium text-sm\">{member.calculatedScore}</span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"mt-4 space-y-3\">\n                      <div>\n                        <div className=\"flex items-center justify-between text-sm mb-1\">\n                          <span className=\"text-muted-foreground\">Task Completion</span>\n                          <span className=\"font-medium\">{member.taskCompletionRate}%</span>\n                        </div>\n                        <Progress value={member.taskCompletionRate} className=\"h-1.5\" />\n                      </div>\n                      \n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <div className=\"p-2 rounded bg-secondary/50\">\n                          <p className=\"text-muted-foreground text-xs\">Active Deals</p>\n                          <p className=\"font-medium\">{member.activeDeals}</p>\n                        </div>\n                        <div className=\"p-2 rounded bg-secondary/50\">\n                          <p className=\"text-muted-foreground text-xs\">Pipeline</p>\n                          <p className=\"font-medium\">${member.pipelineValue}M</p>\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Selected Member Details */}\n        {selectedMemberData && (\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Avatar className=\"w-8 h-8\">\n                    <AvatarFallback className=\"bg-primary/20 text-primary text-sm\">\n                      {selectedMemberData.name.split(' ').map(n => n[0]).join('')}\n                    </AvatarFallback>\n                  </Avatar>\n                  {selectedMemberData.name} - Performance Details\n                </CardTitle>\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setSelectedMember(null)}>\n                  Close\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {/* Radar Chart */}\n                <div>\n                  <h4 className=\"font-medium mb-4\">Performance Metrics</h4>\n                  <ResponsiveContainer width=\"100%\" height={300}>\n                    <RadarChart data={selectedMemberRadar}>\n                      <PolarGrid stroke=\"hsl(var(--border))\" />\n                      <PolarAngleAxis dataKey=\"metric\" stroke=\"hsl(var(--muted-foreground))\" />\n                      <PolarRadiusAxis angle={30} domain={[0, 100]} stroke=\"hsl(var(--border))\" />\n                      <Radar \n                        name={selectedMemberData.name} \n                        dataKey=\"value\" \n                        stroke=\"#3b82f6\" \n                        fill=\"#3b82f6\" \n                        fillOpacity={0.3} \n                      />\n                      <Tooltip \n                        contentStyle={{ \n                          backgroundColor: 'hsl(var(--card))', \n                          border: '1px solid hsl(var(--border))',\n                          borderRadius: '8px'\n                        }} \n                      />\n                    </RadarChart>\n                  </ResponsiveContainer>\n                </div>\n\n                {/* Stats Grid */}\n                <div>\n                  <h4 className=\"font-medium mb-4\">Detailed Statistics</h4>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">Total Tasks</p>\n                      <p className=\"text-2xl font-bold\">{selectedMemberData.totalTasks}</p>\n                    </div>\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">Completed</p>\n                      <p className=\"text-2xl font-bold text-green-500\">{selectedMemberData.completedTasks}</p>\n                    </div>\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">On-Time Rate</p>\n                      <p className=\"text-2xl font-bold\">{selectedMemberData.onTimeRate}%</p>\n                    </div>\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">Avg Deal Value</p>\n                      <p className=\"text-2xl font-bold\">${selectedMemberData.avgDealValue}M</p>\n                    </div>\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">Active Deals</p>\n                      <p className=\"text-2xl font-bold text-blue-500\">{selectedMemberData.activeDeals}</p>\n                    </div>\n                    <div className=\"p-4 rounded-lg bg-secondary/30\">\n                      <p className=\"text-sm text-muted-foreground\">Closed Deals</p>\n                      <p className=\"text-2xl font-bold text-purple-500\">{selectedMemberData.closedDeals}</p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":29524,"size_tokens":null},"client/src/pages/ceo/CapitalRaisingCalendar.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Calendar as CalendarIcon,\n  ChevronLeft,\n  ChevronRight,\n  Plus,\n  Users,\n  Building,\n  Phone,\n  Mail,\n  MapPin,\n  Clock,\n  Target,\n  DollarSign,\n  AlertCircle,\n  CheckCircle\n} from \"lucide-react\";\nimport { useCurrentUser, useDealsListing, useCalendarEvents, useCreateCalendarEvent, useUpdateCalendarEvent, useDeleteCalendarEvent, CalendarEventType } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths, isToday, parseISO } from \"date-fns\";\nimport { toast } from \"sonner\";\n\ntype InvestorEvent = {\n  id: string;\n  title: string;\n  date: Date;\n  time?: string;\n  type: 'meeting' | 'call' | 'deadline' | 'followup' | 'presentation';\n  investor: string;\n  deal?: string;\n  status: 'scheduled' | 'completed' | 'pending';\n  notes?: string;\n  location?: string;\n};\n\nconst eventTypeColors: Record<string, string> = {\n  meeting: 'bg-blue-500',\n  call: 'bg-green-500',\n  deadline: 'bg-red-500',\n  followup: 'bg-yellow-500',\n  presentation: 'bg-purple-500',\n};\n\nconst eventTypeLabels: Record<string, string> = {\n  meeting: 'Meeting',\n  call: 'Call',\n  deadline: 'Deadline',\n  followup: 'Follow-up',\n  presentation: 'Presentation',\n};\n\nexport default function CapitalRaisingCalendar() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [] } = useDealsListing();\n  const { data: calendarEvents = [], isLoading: eventsLoading } = useCalendarEvents();\n  const createEventMutation = useCreateCalendarEvent();\n  const updateEventMutation = useUpdateCalendarEvent();\n  const deleteEventMutation = useDeleteCalendarEvent();\n  \n  const [currentMonth, setCurrentMonth] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n  const [showAddEvent, setShowAddEvent] = useState(false);\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  \n  const [newEvent, setNewEvent] = useState({\n    title: '',\n    date: '',\n    time: '',\n    type: 'meeting' as InvestorEvent['type'],\n    investor: '',\n    deal: '',\n    location: '',\n    notes: '',\n  });\n  \n  // Transform database events to component format\n  const events: InvestorEvent[] = useMemo(() => {\n    return calendarEvents.map((event: CalendarEventType) => ({\n      id: event.id || '',\n      title: event.title,\n      date: event.date ? parseISO(event.date) : new Date(),\n      time: event.time || undefined,\n      type: (event.type || 'meeting') as InvestorEvent['type'],\n      investor: event.investor || 'Unknown Investor',\n      deal: event.dealName || undefined,\n      status: (event.status || 'scheduled') as 'scheduled' | 'completed' | 'pending',\n      notes: event.notes || undefined,\n      location: event.location || undefined,\n    }));\n  }, [calendarEvents]);\n\n  const monthStart = startOfMonth(currentMonth);\n  const monthEnd = endOfMonth(currentMonth);\n  const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });\n\n  const startPadding = monthStart.getDay();\n  const paddedDays = [...Array(startPadding).fill(null), ...daysInMonth];\n\n  const filteredEvents = useMemo(() => {\n    return events.filter(event => {\n      if (filterType !== 'all' && event.type !== filterType) return false;\n      return true;\n    });\n  }, [events, filterType]);\n\n  const getEventsForDate = (date: Date) => {\n    return filteredEvents.filter(event => isSameDay(event.date, date));\n  };\n\n  const upcomingEvents = useMemo(() => {\n    return filteredEvents\n      .filter(e => e.date >= new Date())\n      .sort((a, b) => a.date.getTime() - b.date.getTime())\n      .slice(0, 10);\n  }, [filteredEvents]);\n\n  const handleAddEvent = async () => {\n    if (!newEvent.title || !newEvent.date || !newEvent.investor) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n    \n    // Find the deal to get its name\n    const selectedDeal = deals.find((d: any) => d.id === newEvent.deal);\n    \n    try {\n      await createEventMutation.mutateAsync({\n        title: newEvent.title,\n        date: newEvent.date,\n        time: newEvent.time || null,\n        type: newEvent.type,\n        description: null,\n        dealId: newEvent.deal || null,\n        dealName: selectedDeal?.name || null,\n        location: newEvent.location || null,\n        participants: [],\n        isAllDay: false,\n        color: null,\n        investor: newEvent.investor || null,\n        status: 'scheduled',\n        notes: newEvent.notes || null,\n      });\n      \n      toast.success(\"Event added successfully\");\n      setShowAddEvent(false);\n      setNewEvent({\n        title: '',\n        date: '',\n        time: '',\n        type: 'meeting',\n        investor: '',\n        deal: '',\n        location: '',\n        notes: '',\n      });\n    } catch (error) {\n      toast.error(\"Failed to create event\");\n      console.error(\"Failed to create event:\", error);\n    }\n  };\n\n  const investorStats = useMemo(() => {\n    const scheduled = events.filter(e => e.status === 'scheduled').length;\n    const completed = events.filter(e => e.status === 'completed').length;\n    const pending = events.filter(e => e.status === 'pending').length;\n    const thisMonth = events.filter(e => isSameMonth(e.date, currentMonth)).length;\n    \n    return { scheduled, completed, pending, thisMonth };\n  }, [events, currentMonth]);\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Capital Raising Calendar\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Capital Raising Calendar</h1>\n            <p className=\"text-muted-foreground\">Track investor touchpoints and fundraising milestones</p>\n          </div>\n          <Button onClick={() => setShowAddEvent(true)} data-testid=\"button-add-event\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Event\n          </Button>\n        </div>\n\n        {/* Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">This Month</p>\n                  <p className=\"text-2xl font-bold\">{investorStats.thisMonth}</p>\n                </div>\n                <CalendarIcon className=\"w-5 h-5 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Scheduled</p>\n                  <p className=\"text-2xl font-bold text-blue-500\">{investorStats.scheduled}</p>\n                </div>\n                <Clock className=\"w-5 h-5 text-blue-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Pending</p>\n                  <p className=\"text-2xl font-bold text-yellow-500\">{investorStats.pending}</p>\n                </div>\n                <AlertCircle className=\"w-5 h-5 text-yellow-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Completed</p>\n                  <p className=\"text-2xl font-bold text-green-500\">{investorStats.completed}</p>\n                </div>\n                <CheckCircle className=\"w-5 h-5 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Calendar */}\n          <Card className=\"lg:col-span-2 bg-card border-border\">\n            <CardHeader className=\"pb-2\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2\">\n                  <CalendarIcon className=\"w-5 h-5 text-primary\" />\n                  {format(currentMonth, 'MMMM yyyy')}\n                </CardTitle>\n                <div className=\"flex items-center gap-2\">\n                  <Select value={filterType} onValueChange={setFilterType}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-filter-type\">\n                      <SelectValue placeholder=\"All types\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Types</SelectItem>\n                      <SelectItem value=\"meeting\">Meetings</SelectItem>\n                      <SelectItem value=\"call\">Calls</SelectItem>\n                      <SelectItem value=\"deadline\">Deadlines</SelectItem>\n                      <SelectItem value=\"followup\">Follow-ups</SelectItem>\n                      <SelectItem value=\"presentation\">Presentations</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Button variant=\"ghost\" size=\"icon\" onClick={() => setCurrentMonth(subMonths(currentMonth, 1))}>\n                    <ChevronLeft className=\"w-4 h-4\" />\n                  </Button>\n                  <Button variant=\"ghost\" size=\"icon\" onClick={() => setCurrentMonth(addMonths(currentMonth, 1))}>\n                    <ChevronRight className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {/* Days of week header */}\n              <div className=\"grid grid-cols-7 gap-1 mb-2\">\n                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (\n                  <div key={day} className=\"text-center text-sm font-medium text-muted-foreground py-2\">\n                    {day}\n                  </div>\n                ))}\n              </div>\n              \n              {/* Calendar grid */}\n              <div className=\"grid grid-cols-7 gap-1\">\n                {paddedDays.map((day, idx) => {\n                  if (!day) {\n                    return <div key={`empty-${idx}`} className=\"h-24 bg-secondary/20 rounded-lg\" />;\n                  }\n                  \n                  const dayEvents = getEventsForDate(day);\n                  const isSelected = selectedDate && isSameDay(day, selectedDate);\n                  \n                  return (\n                    <button\n                      key={day.toISOString()}\n                      onClick={() => setSelectedDate(day)}\n                      className={cn(\n                        \"h-24 p-1 rounded-lg border text-left transition-colors overflow-hidden\",\n                        isToday(day) && \"border-primary\",\n                        isSelected && \"bg-primary/10 border-primary\",\n                        !isSelected && \"border-border hover:bg-secondary/50\"\n                      )}\n                    >\n                      <span className={cn(\n                        \"text-sm font-medium\",\n                        isToday(day) && \"text-primary\"\n                      )}>\n                        {format(day, 'd')}\n                      </span>\n                      <div className=\"mt-1 space-y-0.5\">\n                        {dayEvents.slice(0, 3).map(event => (\n                          <div\n                            key={event.id}\n                            className={cn(\n                              \"text-xs px-1 py-0.5 rounded truncate text-white\",\n                              eventTypeColors[event.type]\n                            )}\n                          >\n                            {event.title}\n                          </div>\n                        ))}\n                        {dayEvents.length > 3 && (\n                          <p className=\"text-xs text-muted-foreground\">+{dayEvents.length - 3} more</p>\n                        )}\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Upcoming Events */}\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Target className=\"w-5 h-5 text-primary\" />\n                Upcoming Events\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-[500px]\">\n                <div className=\"space-y-3\">\n                  {upcomingEvents.map(event => (\n                    <div\n                      key={event.id}\n                      className=\"p-3 rounded-lg border border-border hover:bg-secondary/50 transition-colors\"\n                    >\n                      <div className=\"flex items-start gap-3\">\n                        <div className={cn(\n                          \"w-3 h-3 rounded-full mt-1.5\",\n                          eventTypeColors[event.type]\n                        )} />\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium text-sm truncate\">{event.title}</p>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {eventTypeLabels[event.type]}\n                            </Badge>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {event.time \n                                ? `${format(event.date, 'MMM d')}, ${event.time.replace(/^(\\d{1,2}):(\\d{2})$/, (_, h, m) => {\n                                    const hour = parseInt(h);\n                                    const ampm = hour >= 12 ? 'PM' : 'AM';\n                                    const displayHour = hour % 12 || 12;\n                                    return `${displayHour}:${m} ${ampm}`;\n                                  })}`\n                                : format(event.date, 'MMM d')}\n                            </span>\n                          </div>\n                          <div className=\"flex items-center gap-1 mt-2 text-xs text-muted-foreground\">\n                            <Building className=\"w-3 h-3\" />\n                            <span className=\"truncate\">{event.investor}</span>\n                          </div>\n                          {event.deal && (\n                            <div className=\"flex items-center gap-1 mt-1 text-xs text-muted-foreground\">\n                              <DollarSign className=\"w-3 h-3\" />\n                              <span className=\"truncate\">{event.deal}</span>\n                            </div>\n                          )}\n                          {event.location && (\n                            <div className=\"flex items-center gap-1 mt-1 text-xs text-muted-foreground\">\n                              <MapPin className=\"w-3 h-3\" />\n                              <span className=\"truncate\">{event.location}</span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                  {upcomingEvents.length === 0 && (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <CalendarIcon className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p className=\"text-sm\">No upcoming events</p>\n                    </div>\n                  )}\n                </div>\n              </ScrollArea>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Selected Date Events */}\n        {selectedDate && (\n          <Card className=\"bg-card border-border\">\n            <CardHeader>\n              <CardTitle>Events on {format(selectedDate, 'MMMM d, yyyy')}</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {getEventsForDate(selectedDate).map(event => (\n                  <Card key={event.id} className=\"bg-secondary/30\">\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <Badge className={cn(\"text-white\", eventTypeColors[event.type])}>\n                          {eventTypeLabels[event.type]}\n                        </Badge>\n                        <Badge variant={event.status === 'completed' ? 'default' : 'secondary'}>\n                          {event.status}\n                        </Badge>\n                      </div>\n                      <h4 className=\"font-medium\">{event.title}</h4>\n                      <p className=\"text-sm text-muted-foreground mt-1\">{event.investor}</p>\n                      {event.deal && <p className=\"text-sm text-muted-foreground\">Deal: {event.deal}</p>}\n                      {event.location && <p className=\"text-sm text-muted-foreground\">Location: {event.location}</p>}\n                    </CardContent>\n                  </Card>\n                ))}\n                {getEventsForDate(selectedDate).length === 0 && (\n                  <p className=\"text-muted-foreground col-span-full text-center py-8\">\n                    No events scheduled for this date\n                  </p>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Add Event Dialog */}\n      <Dialog open={showAddEvent} onOpenChange={setShowAddEvent}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Add Investor Event</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Event Title</Label>\n              <Input\n                placeholder=\"e.g., LP Meeting with First Round\"\n                value={newEvent.title}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, title: e.target.value }))}\n                data-testid=\"input-event-title\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Date</Label>\n                <Input\n                  type=\"date\"\n                  value={newEvent.date}\n                  onChange={(e) => setNewEvent(prev => ({ ...prev, date: e.target.value }))}\n                  data-testid=\"input-event-date\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Time</Label>\n                <Select\n                  value={newEvent.time}\n                  onValueChange={(v) => setNewEvent(prev => ({ ...prev, time: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-event-time\">\n                    <SelectValue placeholder=\"Select time\" />\n                  </SelectTrigger>\n                  <SelectContent className=\"max-h-[200px]\">\n                    {Array.from({ length: 36 }, (_, i) => {\n                      const hour = Math.floor(i / 2) + 6;\n                      const minute = (i % 2) * 30;\n                      const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;\n                      const hour12 = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;\n                      const ampm = hour >= 12 ? 'PM' : 'AM';\n                      const display = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;\n                      return <SelectItem key={time24} value={time24}>{display}</SelectItem>;\n                    })}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Type</Label>\n              <Select value={newEvent.type} onValueChange={(v) => setNewEvent(prev => ({ ...prev, type: v as InvestorEvent['type'] }))}>\n                <SelectTrigger data-testid=\"select-event-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"meeting\">Meeting</SelectItem>\n                  <SelectItem value=\"call\">Call</SelectItem>\n                  <SelectItem value=\"deadline\">Deadline</SelectItem>\n                  <SelectItem value=\"followup\">Follow-up</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Investor</Label>\n              <Input\n                placeholder=\"e.g., Sequoia Capital\"\n                value={newEvent.investor}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, investor: e.target.value }))}\n                data-testid=\"input-investor\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Related Deal (optional)</Label>\n              <Select value={newEvent.deal || \"none\"} onValueChange={(v) => setNewEvent(prev => ({ ...prev, deal: v === \"none\" ? '' : v }))}>\n                <SelectTrigger data-testid=\"select-deal\">\n                  <SelectValue placeholder=\"Select a deal...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">None</SelectItem>\n                  {deals.map(deal => (\n                    <SelectItem key={deal.id} value={deal.name}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Location (optional)</Label>\n              <Input\n                placeholder=\"e.g., NYC Office or Virtual - Zoom\"\n                value={newEvent.location}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, location: e.target.value }))}\n                data-testid=\"input-location\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Notes (optional)</Label>\n              <Textarea\n                placeholder=\"Add any notes...\"\n                value={newEvent.notes}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, notes: e.target.value }))}\n                data-testid=\"input-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAddEvent(false)}>Cancel</Button>\n            <Button onClick={handleAddEvent} data-testid=\"button-save-event\">Save Event</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":23732,"size_tokens":null},"client/src/pages/shared/GoalSettingOKRs.tsx":{"content":"import { useState } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { \n  Target, \n  Plus, \n  Search, \n  CheckCircle,\n  Circle,\n  TrendingUp,\n  Calendar,\n  Users,\n  BarChart3,\n  ChevronDown,\n  ChevronRight,\n  Pencil,\n  Trash2,\n  Award\n} from \"lucide-react\";\nimport { useCurrentUser, useUsers, useOkrs, useCreateOkr, useUpdateOkr, useDeleteOkr } from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport type { Okr, KeyResult } from \"@shared/schema\";\n\nexport default function GoalSettingOKRs({ role }: { role: 'CEO' | 'Employee' }) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [] } = useUsers();\n  const { data: okrs = [], isLoading } = useOkrs();\n  const createOkrMutation = useCreateOkr();\n  const updateOkrMutation = useUpdateOkr();\n  const deleteOkrMutation = useDeleteOkr();\n\n  const handleDeleteOkr = async (id: string) => {\n    if (!confirm(\"Are you sure you want to delete this OKR?\")) return;\n    try {\n      await deleteOkrMutation.mutateAsync(id);\n      toast.success(\"OKR deleted\");\n    } catch (error) {\n      toast.error(\"Failed to delete OKR\");\n    }\n  };\n  \n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [expandedOKRs, setExpandedOKRs] = useState<Set<string>>(new Set());\n  const [activeTab, setActiveTab] = useState(\"all\");\n\n  const [newOKR, setNewOKR] = useState({\n    objective: \"\",\n    description: \"\",\n    ownerId: currentUser?.id || \"\",\n    quarter: \"Q1\",\n    year: 2025,\n    keyResults: [{ title: \"\", targetValue: 0, unit: \"\" }],\n    type: \"individual\" as 'individual' | 'team',\n    teamName: \"\"\n  });\n\n  const toggleExpand = (id: string) => {\n    const newExpanded = new Set(expandedOKRs);\n    if (newExpanded.has(id)) {\n      newExpanded.delete(id);\n    } else {\n      newExpanded.add(id);\n    }\n    setExpandedOKRs(newExpanded);\n  };\n\n  const filteredOKRs = okrs.filter(okr => {\n    const matchesSearch = okr.objective.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      okr.ownerName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      (okr.teamName && okr.teamName.toLowerCase().includes(searchQuery.toLowerCase()));\n    \n    if (activeTab === \"my-okrs\") return matchesSearch && okr.ownerId === currentUser?.id;\n    if (activeTab === \"team-okrs\") return matchesSearch && okr.type === 'team';\n    if (activeTab === \"individual\") return matchesSearch && okr.type === 'individual';\n    return matchesSearch;\n  });\n\n  const handleCreateOKR = async () => {\n    if (!newOKR.objective || newOKR.keyResults.filter(kr => kr.title).length === 0) {\n      toast.error(\"Please add an objective and at least one key result\");\n      return;\n    }\n\n    if (newOKR.type === 'team' && !newOKR.teamName) {\n      toast.error(\"Please enter a team name for team OKRs\");\n      return;\n    }\n\n    const owner = users.find(u => u.id === newOKR.ownerId) || currentUser;\n    \n    try {\n      await createOkrMutation.mutateAsync({\n        objective: newOKR.objective,\n        description: newOKR.description,\n        ownerId: newOKR.ownerId || currentUser?.id || undefined,\n        ownerName: owner?.name || \"Unknown\",\n        quarter: newOKR.quarter,\n        year: newOKR.year,\n        keyResults: newOKR.keyResults.filter(kr => kr.title).map((kr, i) => ({\n          id: `kr${i}`,\n          title: kr.title,\n          targetValue: kr.targetValue,\n          currentValue: 0,\n          unit: kr.unit,\n          progress: 0\n        })),\n        status: \"on-track\",\n        overallProgress: 0,\n        type: newOKR.type,\n        teamName: newOKR.type === 'team' ? newOKR.teamName : undefined\n      });\n      \n      setShowCreateModal(false);\n      setNewOKR({\n        objective: \"\",\n        description: \"\",\n        ownerId: currentUser?.id || \"\",\n        quarter: \"Q1\",\n        year: 2025,\n        keyResults: [{ title: \"\", targetValue: 0, unit: \"\" }],\n        type: \"individual\",\n        teamName: \"\"\n      });\n      toast.success(\"OKR created successfully\");\n    } catch (error) {\n      toast.error(\"Failed to create OKR\");\n    }\n  };\n\n  const updateKeyResultProgress = async (okrId: string, krId: string, newValue: number) => {\n    const okr = okrs.find(o => o.id === okrId);\n    if (!okr || !okr.keyResults) return;\n    \n    const updatedKRs = okr.keyResults.map(kr => {\n      if (kr.id === krId) {\n        const progress = Math.min(Math.round((newValue / kr.targetValue) * 100), 100);\n        return { ...kr, currentValue: newValue, progress };\n      }\n      return kr;\n    });\n    \n    const overallProgress = Math.round(updatedKRs.reduce((sum, kr) => sum + kr.progress, 0) / updatedKRs.length);\n    let status: 'on-track' | 'at-risk' | 'behind' | 'completed' = 'on-track';\n    if (overallProgress >= 100) status = 'completed';\n    else if (overallProgress < 50) status = 'behind';\n    else if (overallProgress < 70) status = 'at-risk';\n    \n    try {\n      await updateOkrMutation.mutateAsync({\n        id: okrId,\n        updates: { keyResults: updatedKRs, overallProgress, status }\n      });\n    } catch (error) {\n      toast.error(\"Failed to update progress\");\n    }\n  };\n\n  const addKeyResultField = () => {\n    setNewOKR({\n      ...newOKR,\n      keyResults: [...newOKR.keyResults, { title: \"\", targetValue: 0, unit: \"\" }]\n    });\n  };\n\n  const updateKeyResultField = (index: number, field: string, value: any) => {\n    const updatedKRs = [...newOKR.keyResults];\n    updatedKRs[index] = { ...updatedKRs[index], [field]: value };\n    setNewOKR({ ...newOKR, keyResults: updatedKRs });\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'on-track': return 'bg-green-500';\n      case 'at-risk': return 'bg-yellow-500';\n      case 'behind': return 'bg-red-500';\n      case 'completed': return 'bg-blue-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">Goal Setting & OKRs</h1>\n            <p className=\"text-muted-foreground\">Track objectives and key results across the organization</p>\n          </div>\n          <Button onClick={() => setShowCreateModal(true)} data-testid=\"button-create-okr\">\n            <Plus className=\"w-4 h-4 mr-2\" /> New OKR\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <Target className=\"w-5 h-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{okrs.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total OKRs</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                  <TrendingUp className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{okrs.filter(o => o.status === 'on-track').length}</p>\n                  <p className=\"text-xs text-muted-foreground\">On Track</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                  <BarChart3 className=\"w-5 h-5 text-yellow-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {Math.round(okrs.reduce((sum, o) => sum + o.overallProgress, 0) / Math.max(okrs.length, 1))}%\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Avg. Progress</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <Award className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{okrs.filter(o => o.status === 'completed').length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Completed</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Objectives & Key Results</CardTitle>\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search OKRs...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-okrs\"\n                />\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\n              <TabsList>\n                <TabsTrigger value=\"all\">All OKRs</TabsTrigger>\n                <TabsTrigger value=\"my-okrs\">My OKRs</TabsTrigger>\n                <TabsTrigger value=\"team-okrs\">Team Goals</TabsTrigger>\n                <TabsTrigger value=\"individual\">Individual Goals</TabsTrigger>\n              </TabsList>\n              <TabsContent value={activeTab} className=\"mt-4\">\n                <ScrollArea className=\"h-[500px]\">\n                  <div className=\"space-y-4\">\n                    {filteredOKRs.map((okr) => (\n                      <Card key={okr.id} className=\"hover:border-primary/50 transition-colors\" data-testid={`okr-${okr.id}`}>\n                        <CardContent className=\"p-4\">\n                          <div \n                            className=\"flex items-start justify-between cursor-pointer\"\n                            onClick={() => toggleExpand(okr.id)}\n                          >\n                            <div className=\"flex items-start gap-3 flex-1\">\n                              <button className=\"mt-1\">\n                                {expandedOKRs.has(okr.id) ? (\n                                  <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                                ) : (\n                                  <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                                )}\n                              </button>\n                              <div className=\"flex-1\">\n                                <div className=\"flex items-center gap-2 mb-1\">\n                                  <h3 className=\"font-medium\">{okr.objective}</h3>\n                                  <Badge className={cn(\"text-white\", getStatusColor(okr.status))}>\n                                    {okr.status.replace('-', ' ')}\n                                  </Badge>\n                                  <Badge variant=\"outline\" className={okr.type === 'team' ? 'border-blue-500 text-blue-500' : 'border-purple-500 text-purple-500'}>\n                                    {okr.type === 'team' ? 'Team' : 'Individual'}\n                                  </Badge>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">{okr.description}</p>\n                                <div className=\"flex items-center gap-4 mt-2 text-xs text-muted-foreground\">\n                                  <span className=\"flex items-center gap-1\">\n                                    <Users className=\"w-3 h-3\" /> {okr.type === 'team' && okr.teamName ? okr.teamName : okr.ownerName}\n                                  </span>\n                                  <span className=\"flex items-center gap-1\">\n                                    <Calendar className=\"w-3 h-3\" /> {okr.quarter} {okr.year}\n                                  </span>\n                                  <span className=\"flex items-center gap-1\">\n                                    <Target className=\"w-3 h-3\" /> {okr.keyResults.length} Key Results\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-3 ml-4\">\n                              <div className=\"text-right\">\n                                <p className=\"text-2xl font-bold\">{okr.overallProgress}%</p>\n                                <Progress value={okr.overallProgress} className=\"w-24 h-2\" />\n                              </div>\n                              {(currentUser?.accessLevel === 'admin' || okr.ownerId === currentUser?.id) && (\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    handleDeleteOkr(okr.id);\n                                  }}\n                                  className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n                                  data-testid={`delete-okr-${okr.id}`}\n                                >\n                                  <Trash2 className=\"w-4 h-4\" />\n                                </Button>\n                              )}\n                            </div>\n                          </div>\n\n                          {expandedOKRs.has(okr.id) && (\n                            <div className=\"mt-4 pt-4 border-t space-y-3\">\n                              {okr.keyResults.map((kr) => (\n                                <div key={kr.id} className=\"flex items-center gap-4 p-3 bg-secondary/30 rounded-lg\">\n                                  <div className=\"flex-1\">\n                                    <div className=\"flex items-center gap-2 mb-1\">\n                                      {kr.progress >= 100 ? (\n                                        <CheckCircle className=\"w-4 h-4 text-green-500\" />\n                                      ) : (\n                                        <Circle className=\"w-4 h-4 text-muted-foreground\" />\n                                      )}\n                                      <span className=\"text-sm font-medium\">{kr.title}</span>\n                                    </div>\n                                    <div className=\"flex items-center gap-2 ml-6\">\n                                      <Progress value={kr.progress} className=\"flex-1 h-2\" />\n                                      <span className=\"text-xs text-muted-foreground w-20\">\n                                        {kr.currentValue}/{kr.targetValue} {kr.unit}\n                                      </span>\n                                    </div>\n                                  </div>\n                                  <Input\n                                    type=\"number\"\n                                    value={kr.currentValue}\n                                    onChange={(e) => updateKeyResultProgress(okr.id, kr.id, parseInt(e.target.value) || 0)}\n                                    className=\"w-20 h-8\"\n                                    data-testid={`input-kr-${kr.id}`}\n                                  />\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    ))}\n                    {filteredOKRs.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        No OKRs found\n                      </div>\n                    )}\n                  </div>\n                </ScrollArea>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Create New OKR</DialogTitle>\n          </DialogHeader>\n          <ScrollArea className=\"max-h-[60vh]\">\n            <div className=\"space-y-4 pr-4\">\n              <div>\n                <Label>Objective *</Label>\n                <Input\n                  value={newOKR.objective}\n                  onChange={(e) => setNewOKR({ ...newOKR, objective: e.target.value })}\n                  placeholder=\"What do you want to achieve?\"\n                  data-testid=\"input-objective\"\n                />\n              </div>\n              <div>\n                <Label>Description</Label>\n                <Textarea\n                  value={newOKR.description}\n                  onChange={(e) => setNewOKR({ ...newOKR, description: e.target.value })}\n                  placeholder=\"Why is this important?\"\n                  data-testid=\"input-okr-description\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Goal Type *</Label>\n                  <Select value={newOKR.type} onValueChange={(v) => setNewOKR({ ...newOKR, type: v as 'individual' | 'team' })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"individual\">Individual Goal</SelectItem>\n                      <SelectItem value=\"team\">Team Goal</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                {newOKR.type === 'team' && (\n                  <div>\n                    <Label>Team Name *</Label>\n                    <Input\n                      value={newOKR.teamName}\n                      onChange={(e) => setNewOKR({ ...newOKR, teamName: e.target.value })}\n                      placeholder=\"Enter team name\"\n                      data-testid=\"input-team-name\"\n                    />\n                  </div>\n                )}\n                {newOKR.type === 'individual' && (\n                  <div>\n                    <Label>Owner</Label>\n                    <Select value={newOKR.ownerId} onValueChange={(v) => setNewOKR({ ...newOKR, ownerId: v })}>\n                      <SelectTrigger>\n                        <SelectValue placeholder=\"Select owner\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {users.map((user) => (\n                          <SelectItem key={user.id} value={user.id}>{user.name}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Quarter</Label>\n                  <Select value={newOKR.quarter} onValueChange={(v) => setNewOKR({ ...newOKR, quarter: v })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Q1\">Q1</SelectItem>\n                      <SelectItem value=\"Q2\">Q2</SelectItem>\n                      <SelectItem value=\"Q3\">Q3</SelectItem>\n                      <SelectItem value=\"Q4\">Q4</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label>Year</Label>\n                  <Select value={newOKR.year.toString()} onValueChange={(v) => setNewOKR({ ...newOKR, year: parseInt(v) })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"2024\">2024</SelectItem>\n                      <SelectItem value=\"2025\">2025</SelectItem>\n                      <SelectItem value=\"2026\">2026</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div>\n                <Label>Key Results</Label>\n                <div className=\"space-y-2 mt-2\">\n                  {newOKR.keyResults.map((kr, index) => (\n                    <div key={index} className=\"grid grid-cols-6 gap-2\">\n                      <Input\n                        className=\"col-span-3\"\n                        value={kr.title}\n                        onChange={(e) => updateKeyResultField(index, 'title', e.target.value)}\n                        placeholder=\"Key result description\"\n                        data-testid={`input-kr-title-${index}`}\n                      />\n                      <Input\n                        type=\"number\"\n                        value={kr.targetValue || ''}\n                        onChange={(e) => updateKeyResultField(index, 'targetValue', parseInt(e.target.value) || 0)}\n                        placeholder=\"Target\"\n                        data-testid={`input-kr-target-${index}`}\n                      />\n                      <Input\n                        className=\"col-span-2\"\n                        value={kr.unit}\n                        onChange={(e) => updateKeyResultField(index, 'unit', e.target.value)}\n                        placeholder=\"Unit (%, deals, etc.)\"\n                        data-testid={`input-kr-unit-${index}`}\n                      />\n                    </div>\n                  ))}\n                  <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={addKeyResultField}>\n                    <Plus className=\"w-3 h-3 mr-1\" /> Add Key Result\n                  </Button>\n                </div>\n              </div>\n            </div>\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateOKR} data-testid=\"button-submit-okr\">Create OKR</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":23417,"size_tokens":null},"client/src/pages/shared/DealAnnouncements.tsx":{"content":"import { useState } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Megaphone, \n  Plus, \n  Search, \n  MessageSquare,\n  ThumbsUp,\n  Share2,\n  Pin,\n  Clock,\n  Users,\n  Briefcase,\n  Trophy,\n  PartyPopper,\n  Bell,\n  Send,\n  Vote,\n  CheckCircle,\n  BarChart3,\n  Trash2,\n  Eye,\n  EyeOff\n} from \"lucide-react\";\nimport { \n  useCurrentUser, \n  useDealsListing, \n  useUsers,\n  useAnnouncements,\n  useCreateAnnouncement,\n  useUpdateAnnouncement,\n  useDeleteAnnouncement,\n  usePolls,\n  useCreatePoll,\n  useUpdatePoll,\n  useDeletePoll\n} from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { format, formatDistanceToNow, addDays } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport type { Announcement, Poll, PollOption } from \"@shared/schema\";\n\ntype AnnouncementType = 'deal-closed' | 'milestone' | 'team-update' | 'celebration' | 'general';\ntype LocalReaction = { emoji: string; count: number; userIds: string[] };\ntype LocalComment = { id: string; authorId: string; authorName: string; content: string; createdAt: string };\n\nexport default function DealAnnouncements({ role }: { role: 'CEO' | 'Employee' }) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [] } = useDealsListing();\n  const { data: users = [] } = useUsers();\n  const { data: announcements = [], isLoading: announcementsLoading } = useAnnouncements();\n  const { data: polls = [], isLoading: pollsLoading } = usePolls();\n  const createAnnouncementMutation = useCreateAnnouncement();\n  const updateAnnouncementMutation = useUpdateAnnouncement();\n  const deleteAnnouncementMutation = useDeleteAnnouncement();\n  const createPollMutation = useCreatePoll();\n  const updatePollMutation = useUpdatePoll();\n  const deletePollMutation = useDeletePoll();\n  \n  const [activeTab, setActiveTab] = useState<'announcements' | 'polls'>('announcements');\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showCreatePollModal, setShowCreatePollModal] = useState(false);\n  const [showPollResultsModal, setShowPollResultsModal] = useState(false);\n  const [selectedPoll, setSelectedPoll] = useState<Poll | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [commentingOn, setCommentingOn] = useState<string | null>(null);\n  const [newComment, setNewComment] = useState(\"\");\n\n  const [newAnnouncement, setNewAnnouncement] = useState({\n    title: \"\",\n    content: \"\",\n    type: \"general\" as AnnouncementType,\n    dealId: \"\",\n    isPinned: false,\n    notifyTeam: true\n  });\n\n  const [newPoll, setNewPoll] = useState({\n    question: \"\",\n    options: [\"\", \"\", \"\"],\n    expiresInDays: 3,\n    isAnonymous: false,\n    allowMultiple: false\n  });\n\n  const filteredPolls = polls.filter(p =>\n    p.question.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n  const activePolls = filteredPolls.filter(p => p.status === 'active');\n  const closedPolls = filteredPolls.filter(p => p.status === 'closed');\n\n  const filteredAnnouncements = announcements\n    .filter(a => \n      a.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      a.content.toLowerCase().includes(searchQuery.toLowerCase())\n    )\n    .sort((a, b) => {\n      if (a.isPinned && !b.isPinned) return -1;\n      if (!a.isPinned && b.isPinned) return 1;\n      const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;\n      const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;\n      return bTime - aTime;\n    });\n\n  const handleCreateAnnouncement = async () => {\n    if (!newAnnouncement.title || !newAnnouncement.content) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n\n    const deal = deals.find(d => d.id === newAnnouncement.dealId);\n    \n    try {\n      await createAnnouncementMutation.mutateAsync({\n        title: newAnnouncement.title,\n        content: newAnnouncement.content,\n        type: newAnnouncement.type,\n        dealId: newAnnouncement.dealId || undefined,\n        dealName: deal?.name,\n        isPinned: newAnnouncement.isPinned,\n        reactions: [],\n        comments: []\n      });\n\n      setShowCreateModal(false);\n      setNewAnnouncement({ title: \"\", content: \"\", type: \"general\", dealId: \"\", isPinned: false, notifyTeam: true });\n    \n      if (newAnnouncement.notifyTeam) {\n        toast.success(\"Announcement posted and team notified!\");\n      } else {\n        toast.success(\"Announcement posted successfully\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to create announcement\");\n    }\n  };\n\n  const addReaction = async (announcementId: string, emoji: string) => {\n    const announcement = announcements.find(a => a.id === announcementId);\n    if (!announcement) return;\n    \n    const reactions = announcement.reactions || [];\n    const existingReaction = reactions.find(r => r.emoji === emoji);\n    let newReactions: LocalReaction[];\n    \n    if (existingReaction) {\n      if (existingReaction.userIds.includes(currentUser?.id || \"\")) {\n        newReactions = reactions\n          .map(r => r.emoji === emoji \n            ? { ...r, count: r.count - 1, userIds: r.userIds.filter(id => id !== currentUser?.id) }\n            : r)\n          .filter(r => r.count > 0);\n      } else {\n        newReactions = reactions.map(r =>\n          r.emoji === emoji\n            ? { ...r, count: r.count + 1, userIds: [...r.userIds, currentUser?.id || \"\"] }\n            : r\n        );\n      }\n    } else {\n      newReactions = [...reactions, { emoji, count: 1, userIds: [currentUser?.id || \"\"] }];\n    }\n    \n    try {\n      await updateAnnouncementMutation.mutateAsync({ id: announcementId, updates: { reactions: newReactions } });\n    } catch (error) {\n      toast.error(\"Failed to add reaction\");\n    }\n  };\n\n  const addComment = async (announcementId: string) => {\n    if (!newComment.trim()) return;\n    \n    const announcement = announcements.find(a => a.id === announcementId);\n    if (!announcement) return;\n    \n    const newCommentObj: LocalComment = {\n      id: Date.now().toString(),\n      authorId: currentUser?.id || \"\",\n      authorName: currentUser?.name || \"Unknown\",\n      content: newComment,\n      createdAt: new Date().toISOString()\n    };\n    \n    try {\n      await updateAnnouncementMutation.mutateAsync({\n        id: announcementId,\n        updates: { comments: [...(announcement.comments || []), newCommentObj] }\n      });\n      setNewComment(\"\");\n      setCommentingOn(null);\n      toast.success(\"Comment added\");\n    } catch (error) {\n      toast.error(\"Failed to add comment\");\n    }\n  };\n\n  const togglePin = async (id: string) => {\n    const announcement = announcements.find(a => a.id === id);\n    if (!announcement) return;\n    \n    try {\n      await updateAnnouncementMutation.mutateAsync({ id, updates: { isPinned: !announcement.isPinned } });\n    } catch (error) {\n      toast.error(\"Failed to toggle pin\");\n    }\n  };\n\n  const handleDeleteAnnouncement = async (id: string) => {\n    try {\n      await deleteAnnouncementMutation.mutateAsync(id);\n      toast.success(\"Announcement deleted\");\n    } catch (error) {\n      toast.error(\"Failed to delete announcement\");\n    }\n  };\n\n  const handleCreatePoll = async () => {\n    const validOptions = newPoll.options.filter(o => o.trim());\n    if (!newPoll.question || validOptions.length < 2) {\n      toast.error(\"Please add a question and at least 2 options\");\n      return;\n    }\n\n    try {\n      await createPollMutation.mutateAsync({\n        question: newPoll.question,\n        options: validOptions.map((text, i) => ({\n          id: `o${i}`,\n          text,\n          votes: []\n        })),\n        expiresAt: addDays(new Date(), newPoll.expiresInDays).toISOString(),\n        isAnonymous: newPoll.isAnonymous,\n        allowMultiple: newPoll.allowMultiple,\n        status: \"active\"\n      });\n      \n      setShowCreatePollModal(false);\n      setNewPoll({ question: \"\", options: [\"\", \"\", \"\"], expiresInDays: 3, isAnonymous: false, allowMultiple: false });\n      toast.success(\"Poll created successfully\");\n    } catch (error) {\n      toast.error(\"Failed to create poll\");\n    }\n  };\n\n  const votePoll = async (pollId: string, optionId: string) => {\n    const poll = polls.find(p => p.id === pollId);\n    if (!poll || !poll.options) return;\n    \n    const hasVoted = poll.options.some(o => o.votes.includes(currentUser?.id || \"\"));\n    let newOptions: PollOption[];\n    \n    if (hasVoted && !poll.allowMultiple) {\n      newOptions = poll.options.map(o => ({\n        ...o,\n        votes: o.id === optionId\n          ? [...o.votes.filter(v => v !== currentUser?.id), currentUser?.id || \"\"]\n          : o.votes.filter(v => v !== currentUser?.id)\n      }));\n    } else {\n      newOptions = poll.options.map(o => ({\n        ...o,\n        votes: o.id === optionId\n          ? o.votes.includes(currentUser?.id || \"\")\n            ? o.votes.filter(v => v !== currentUser?.id)\n            : [...o.votes, currentUser?.id || \"\"]\n          : o.votes\n      }));\n    }\n    \n    try {\n      await updatePollMutation.mutateAsync({ id: pollId, updates: { options: newOptions } });\n      toast.success(\"Vote recorded\");\n    } catch (error) {\n      toast.error(\"Failed to record vote\");\n    }\n  };\n\n  const closePoll = async (pollId: string) => {\n    try {\n      await updatePollMutation.mutateAsync({ id: pollId, updates: { status: 'closed' } });\n      toast.success(\"Poll closed\");\n    } catch (error) {\n      toast.error(\"Failed to close poll\");\n    }\n  };\n\n  const deletePoll = async (pollId: string) => {\n    try {\n      await deletePollMutation.mutateAsync(pollId);\n      toast.success(\"Poll deleted\");\n    } catch (error) {\n      toast.error(\"Failed to delete poll\");\n    }\n  };\n\n  const getTotalVotes = (poll: Poll) => {\n    return (poll.options || []).reduce((sum, o) => sum + o.votes.length, 0);\n  };\n\n  const getVotePercentage = (poll: Poll, option: PollOption) => {\n    const total = getTotalVotes(poll);\n    return total > 0 ? Math.round((option.votes.length / total) * 100) : 0;\n  };\n\n  const addPollOption = () => {\n    setNewPoll({ ...newPoll, options: [...newPoll.options, \"\"] });\n  };\n\n  const updatePollOption = (index: number, value: string) => {\n    const options = [...newPoll.options];\n    options[index] = value;\n    setNewPoll({ ...newPoll, options });\n  };\n\n  const removePollOption = (index: number) => {\n    if (newPoll.options.length > 2) {\n      setNewPoll({ ...newPoll, options: newPoll.options.filter((_, i) => i !== index) });\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'deal-closed': return <Trophy className=\"w-5 h-5 text-yellow-500\" />;\n      case 'milestone': return <Briefcase className=\"w-5 h-5 text-blue-500\" />;\n      case 'team-update': return <Users className=\"w-5 h-5 text-green-500\" />;\n      case 'celebration': return <PartyPopper className=\"w-5 h-5 text-purple-500\" />;\n      default: return <Megaphone className=\"w-5 h-5 text-primary\" />;\n    }\n  };\n\n  const getTypeBadge = (type: string) => {\n    const colors: Record<string, string> = {\n      'deal-closed': 'bg-yellow-500',\n      'milestone': 'bg-blue-500',\n      'team-update': 'bg-green-500',\n      'celebration': 'bg-purple-500',\n      'general': 'bg-gray-500'\n    };\n    return <Badge className={cn(\"text-white\", colors[type])}>{type.replace('-', ' ')}</Badge>;\n  };\n\n  const reactionEmojis = [\"\", \"\", \"\", \"\", \"\", \"\"];\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">Team Communications</h1>\n            <p className=\"text-muted-foreground\">Announcements, polls, and team updates</p>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={() => setShowCreatePollModal(true)} data-testid=\"button-create-poll\">\n              <Vote className=\"w-4 h-4 mr-2\" /> New Poll\n            </Button>\n            <Button onClick={() => setShowCreateModal(true)} data-testid=\"button-create-announcement\">\n              <Plus className=\"w-4 h-4 mr-2\" /> New Announcement\n            </Button>\n          </div>\n        </div>\n\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'announcements' | 'polls')} className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <TabsList>\n              <TabsTrigger value=\"announcements\" className=\"gap-2\">\n                <Megaphone className=\"w-4 h-4\" /> Announcements\n                <Badge variant=\"secondary\" className=\"ml-1\">{announcements.length}</Badge>\n              </TabsTrigger>\n              <TabsTrigger value=\"polls\" className=\"gap-2\">\n                <Vote className=\"w-4 h-4\" /> Quick Polls\n                <Badge variant=\"secondary\" className=\"ml-1\">{activePolls.length}</Badge>\n              </TabsTrigger>\n            </TabsList>\n            <div className=\"relative w-64\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder={activeTab === 'announcements' ? \"Search announcements...\" : \"Search polls...\"}\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </div>\n\n          <TabsContent value=\"announcements\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-4 gap-4\">\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-primary/10 rounded-lg\">\n                      <Megaphone className=\"w-5 h-5 text-primary\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{announcements.length}</p>\n                      <p className=\"text-xs text-muted-foreground\">Total Announcements</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                      <Trophy className=\"w-5 h-5 text-yellow-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{announcements.filter(a => a.type === 'deal-closed').length}</p>\n                      <p className=\"text-xs text-muted-foreground\">Deals Closed</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                      <MessageSquare className=\"w-5 h-5 text-blue-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{announcements.reduce((sum, a) => sum + (a.comments?.length || 0), 0)}</p>\n                      <p className=\"text-xs text-muted-foreground\">Comments</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-red-500/10 rounded-lg\">\n                      <ThumbsUp className=\"w-5 h-5 text-red-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{announcements.reduce((sum, a) => sum + (a.reactions || []).reduce((s, r) => s + r.count, 0), 0)}</p>\n                      <p className=\"text-xs text-muted-foreground\">Reactions</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            <ScrollArea className=\"h-[500px]\">\n          <div className=\"space-y-4\">\n            {filteredAnnouncements.map((announcement) => (\n              <Card key={announcement.id} className={cn(\"hover:border-primary/50 transition-colors\", announcement.isPinned && \"border-yellow-500/50 bg-yellow-500/5\")} data-testid={`announcement-${announcement.id}`}>\n                <CardContent className=\"p-6\">\n                  <div className=\"flex items-start justify-between mb-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"p-2 bg-secondary rounded-lg\">\n                        {getTypeIcon(announcement.type)}\n                      </div>\n                      <div>\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <h3 className=\"font-semibold text-lg\">{announcement.title}</h3>\n                          {announcement.isPinned && <Pin className=\"w-4 h-4 text-yellow-500\" />}\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {getTypeBadge(announcement.type)}\n                          {announcement.dealName && (\n                            <Badge variant=\"outline\">{announcement.dealName}</Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      {currentUser?.accessLevel === 'admin' && (\n                        <Button variant=\"ghost\" size=\"sm\" onClick={() => togglePin(announcement.id)}>\n                          <Pin className={cn(\"w-4 h-4\", announcement.isPinned && \"text-yellow-500 fill-yellow-500\")} />\n                        </Button>\n                      )}\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"text-destructive hover:text-destructive hover:bg-destructive/10\"\n                        onClick={() => handleDeleteAnnouncement(announcement.id)}\n                        data-testid={`delete-announcement-${announcement.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  <p className=\"text-muted-foreground mb-4 whitespace-pre-wrap\">{announcement.content}</p>\n\n                  <div className=\"flex items-center gap-4 text-xs text-muted-foreground mb-4\">\n                    <span className=\"flex items-center gap-1\">\n                      <Avatar className=\"h-5 w-5\">\n                        <AvatarFallback className=\"text-[10px]\">\n                          {announcement.authorName.split(' ').map(n => n[0]).join('')}\n                        </AvatarFallback>\n                      </Avatar>\n                      {announcement.authorName}\n                    </span>\n                    <span className=\"flex items-center gap-1\">\n                      <Clock className=\"w-3 h-3\" /> {announcement.createdAt ? formatDistanceToNow(new Date(announcement.createdAt), { addSuffix: true }) : 'Just now'}\n                    </span>\n                  </div>\n\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    {reactionEmojis.map((emoji) => {\n                      const reaction = (announcement.reactions || []).find(r => r.emoji === emoji);\n                      const hasReacted = reaction?.userIds.includes(currentUser?.id || \"\");\n                      return (\n                        <button\n                          key={emoji}\n                          onClick={() => addReaction(announcement.id, emoji)}\n                          className={cn(\n                            \"px-2 py-1 rounded-full text-sm transition-colors\",\n                            hasReacted ? \"bg-primary/20 border border-primary\" : \"bg-secondary hover:bg-secondary/80\"\n                          )}\n                          data-testid={`reaction-${announcement.id}-${emoji}`}\n                        >\n                          {emoji} {reaction?.count || 0}\n                        </button>\n                      );\n                    })}\n                  </div>\n\n                  {(announcement.comments?.length || 0) > 0 && (\n                    <div className=\"border-t pt-4 space-y-3\">\n                      {(announcement.comments || []).map((comment) => (\n                        <div key={comment.id} className=\"flex gap-2\">\n                          <Avatar className=\"h-6 w-6\">\n                            <AvatarFallback className=\"text-[10px]\">\n                              {comment.authorName.split(' ').map(n => n[0]).join('')}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className=\"flex-1 bg-secondary/30 rounded-lg p-2\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <span className=\"text-sm font-medium\">{comment.authorName}</span>\n                              <span className=\"text-[10px] text-muted-foreground\">\n                                {formatDistanceToNow(new Date(comment.createdAt), { addSuffix: true })}\n                              </span>\n                            </div>\n                            <p className=\"text-sm\">{comment.content}</p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  {commentingOn === announcement.id ? (\n                    <div className=\"mt-4 flex gap-2\">\n                      <Input\n                        value={newComment}\n                        onChange={(e) => setNewComment(e.target.value)}\n                        placeholder=\"Add a comment...\"\n                        onKeyDown={(e) => e.key === 'Enter' && addComment(announcement.id)}\n                        data-testid={`input-comment-${announcement.id}`}\n                      />\n                      <Button size=\"sm\" onClick={() => addComment(announcement.id)}>\n                        <Send className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ) : (\n                    <Button variant=\"ghost\" size=\"sm\" className=\"mt-2\" onClick={() => setCommentingOn(announcement.id)}>\n                      <MessageSquare className=\"w-4 h-4 mr-1\" /> Comment\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"polls\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-4 gap-4\">\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-primary/10 rounded-lg\">\n                      <Vote className=\"w-5 h-5 text-primary\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{activePolls.length}</p>\n                      <p className=\"text-xs text-muted-foreground\">Active Polls</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                      <CheckCircle className=\"w-5 h-5 text-green-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{closedPolls.length}</p>\n                      <p className=\"text-xs text-muted-foreground\">Closed Polls</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                      <Users className=\"w-5 h-5 text-blue-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">{polls.reduce((sum, p) => sum + getTotalVotes(p), 0)}</p>\n                      <p className=\"text-xs text-muted-foreground\">Total Votes</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                      <BarChart3 className=\"w-5 h-5 text-yellow-500\" />\n                    </div>\n                    <div>\n                      <p className=\"text-2xl font-bold\">\n                        {Math.round(polls.reduce((sum, p) => sum + getTotalVotes(p), 0) / Math.max(polls.length, 1))}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">Avg. Responses</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-6\">\n              <div>\n                <h2 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                  <Vote className=\"w-5 h-5 text-green-500\" /> Active Polls\n                </h2>\n                <ScrollArea className=\"h-[400px]\">\n                  <div className=\"space-y-4 pr-4\">\n                    {activePolls.map((poll) => (\n                      <Card key={poll.id} className=\"hover:border-primary/50 transition-colors\" data-testid={`poll-${poll.id}`}>\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div>\n                              <h3 className=\"font-medium\">{poll.question}</h3>\n                              <div className=\"flex items-center gap-2 mt-1\">\n                                {poll.isAnonymous && (\n                                  <Badge variant=\"outline\" className=\"text-[10px]\">\n                                    <EyeOff className=\"w-3 h-3 mr-1\" /> Anonymous\n                                  </Badge>\n                                )}\n                                {poll.allowMultiple && (\n                                  <Badge variant=\"outline\" className=\"text-[10px]\">Multiple choice</Badge>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"flex gap-1\">\n                              <Button variant=\"ghost\" size=\"sm\" onClick={() => closePoll(poll.id)} title=\"Close poll\">\n                                <CheckCircle className=\"w-4 h-4\" />\n                              </Button>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => deletePoll(poll.id)} \n                                className=\"text-destructive hover:text-destructive hover:bg-destructive/10\"\n                                title=\"Delete poll\"\n                                data-testid={`delete-poll-${poll.id}`}\n                              >\n                                <Trash2 className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          </div>\n\n                          <div className=\"space-y-2\">\n                            {(poll.options || []).map((option) => {\n                              const percentage = getVotePercentage(poll, option);\n                              const isSelected = option.votes.includes(currentUser?.id || \"\");\n                              return (\n                                <button\n                                  key={option.id}\n                                  onClick={() => votePoll(poll.id, option.id)}\n                                  className={cn(\n                                    \"w-full text-left p-3 rounded-lg border transition-all relative overflow-hidden\",\n                                    isSelected ? \"border-primary bg-primary/10\" : \"border-border hover:border-primary/50\"\n                                  )}\n                                  data-testid={`vote-${poll.id}-${option.id}`}\n                                >\n                                  <div\n                                    className=\"absolute inset-0 bg-primary/10 transition-all\"\n                                    style={{ width: `${percentage}%` }}\n                                  />\n                                  <div className=\"relative flex items-center justify-between\">\n                                    <span className=\"text-sm\">{option.text}</span>\n                                    <span className=\"text-xs text-muted-foreground\">{percentage}%</span>\n                                  </div>\n                                </button>\n                              );\n                            })}\n                          </div>\n\n                          <div className=\"flex items-center justify-between mt-3 text-xs text-muted-foreground\">\n                            <span className=\"flex items-center gap-1\">\n                              <Users className=\"w-3 h-3\" /> {getTotalVotes(poll)} votes\n                            </span>\n                            <span className=\"flex items-center gap-1\">\n                              <Clock className=\"w-3 h-3\" /> Ends {formatDistanceToNow(new Date(poll.expiresAt), { addSuffix: true })}\n                            </span>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                    {activePolls.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        No active polls\n                      </div>\n                    )}\n                  </div>\n                </ScrollArea>\n              </div>\n\n              <div>\n                <h2 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                  <CheckCircle className=\"w-5 h-5 text-gray-500\" /> Closed Polls\n                </h2>\n                <ScrollArea className=\"h-[400px]\">\n                  <div className=\"space-y-4 pr-4\">\n                    {closedPolls.map((poll) => {\n                      const winner = [...(poll.options || [])].sort((a, b) => b.votes.length - a.votes.length)[0];\n                      return (\n                        <Card key={poll.id} className=\"opacity-80\" data-testid={`poll-closed-${poll.id}`}>\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start justify-between mb-3\">\n                              <div>\n                                <h3 className=\"font-medium\">{poll.question}</h3>\n                                <Badge variant=\"secondary\" className=\"mt-1\">Closed</Badge>\n                              </div>\n                              <div className=\"flex gap-1\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => { setSelectedPoll(poll); setShowPollResultsModal(true); }}\n                                >\n                                  <Eye className=\"w-4 h-4 mr-1\" /> Results\n                                </Button>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"sm\" \n                                  onClick={() => deletePoll(poll.id)} \n                                  className=\"text-destructive hover:text-destructive hover:bg-destructive/10\"\n                                  title=\"Delete poll\"\n                                  data-testid={`delete-closed-poll-${poll.id}`}\n                                >\n                                  <Trash2 className=\"w-4 h-4\" />\n                                </Button>\n                              </div>\n                            </div>\n\n                            <div className=\"p-3 bg-green-500/10 rounded-lg border border-green-500/30\">\n                              <p className=\"text-xs text-muted-foreground mb-1\">Winner</p>\n                              <p className=\"font-medium\">{winner?.text}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {winner?.votes.length || 0} votes ({getVotePercentage(poll, winner || { id: '', text: '', votes: [] })}%)\n                              </p>\n                            </div>\n\n                            <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n                              <span>{getTotalVotes(poll)} total votes</span>\n                              <span>by {poll.creatorName}</span>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                    {closedPolls.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        No closed polls\n                      </div>\n                    )}\n                  </div>\n                </ScrollArea>\n              </div>\n            </div>\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Announcement</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Title *</Label>\n              <Input\n                value={newAnnouncement.title}\n                onChange={(e) => setNewAnnouncement({ ...newAnnouncement, title: e.target.value })}\n                placeholder=\"Announcement title\"\n                data-testid=\"input-announcement-title\"\n              />\n            </div>\n            <div>\n              <Label>Content *</Label>\n              <Textarea\n                value={newAnnouncement.content}\n                onChange={(e) => setNewAnnouncement({ ...newAnnouncement, content: e.target.value })}\n                placeholder=\"Share the news with your team...\"\n                rows={4}\n                data-testid=\"input-announcement-content\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Type</Label>\n                <Select value={newAnnouncement.type} onValueChange={(v: any) => setNewAnnouncement({ ...newAnnouncement, type: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"deal-closed\">Deal Closed</SelectItem>\n                    <SelectItem value=\"milestone\">Milestone</SelectItem>\n                    <SelectItem value=\"team-update\">Team Update</SelectItem>\n                    <SelectItem value=\"celebration\">Celebration</SelectItem>\n                    <SelectItem value=\"general\">General</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label>Related Deal</Label>\n                <Select value={newAnnouncement.dealId || \"none\"} onValueChange={(v) => setNewAnnouncement({ ...newAnnouncement, dealId: v === \"none\" ? '' : v })}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select deal (optional)\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">None</SelectItem>\n                    {deals.map((deal) => (\n                      <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  checked={newAnnouncement.isPinned}\n                  onCheckedChange={(checked) => setNewAnnouncement({ ...newAnnouncement, isPinned: checked })}\n                />\n                <Label>Pin announcement</Label>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  checked={newAnnouncement.notifyTeam}\n                  onCheckedChange={(checked) => setNewAnnouncement({ ...newAnnouncement, notifyTeam: checked })}\n                />\n                <Label>Notify team</Label>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateAnnouncement} data-testid=\"button-submit-announcement\">Post Announcement</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showCreatePollModal} onOpenChange={setShowCreatePollModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Poll</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Question *</Label>\n              <Input\n                value={newPoll.question}\n                onChange={(e) => setNewPoll({ ...newPoll, question: e.target.value })}\n                placeholder=\"What do you want to ask?\"\n                data-testid=\"input-poll-question\"\n              />\n            </div>\n            <div>\n              <Label>Options *</Label>\n              <div className=\"space-y-2 mt-2\">\n                {newPoll.options.map((option, index) => (\n                  <div key={index} className=\"flex gap-2\">\n                    <Input\n                      value={option}\n                      onChange={(e) => updatePollOption(index, e.target.value)}\n                      placeholder={`Option ${index + 1}`}\n                      data-testid={`input-poll-option-${index}`}\n                    />\n                    {newPoll.options.length > 2 && (\n                      <Button variant=\"ghost\" size=\"icon\" onClick={() => removePollOption(index)}>\n                        <Trash2 className=\"w-4 h-4 text-destructive\" />\n                      </Button>\n                    )}\n                  </div>\n                ))}\n                <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={addPollOption}>\n                  <Plus className=\"w-3 h-3 mr-1\" /> Add Option\n                </Button>\n              </div>\n            </div>\n            <div>\n              <Label>Expires in (days)</Label>\n              <Input\n                type=\"number\"\n                min=\"1\"\n                max=\"30\"\n                value={newPoll.expiresInDays}\n                onChange={(e) => setNewPoll({ ...newPoll, expiresInDays: parseInt(e.target.value) || 3 })}\n                data-testid=\"input-poll-expires-days\"\n              />\n            </div>\n            <div className=\"flex items-center gap-6\">\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  checked={newPoll.isAnonymous}\n                  onCheckedChange={(checked) => setNewPoll({ ...newPoll, isAnonymous: checked })}\n                />\n                <Label>Anonymous voting</Label>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  checked={newPoll.allowMultiple}\n                  onCheckedChange={(checked) => setNewPoll({ ...newPoll, allowMultiple: checked })}\n                />\n                <Label>Allow multiple choices</Label>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreatePollModal(false)}>Cancel</Button>\n            <Button onClick={handleCreatePoll} data-testid=\"button-submit-poll\">Create Poll</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showPollResultsModal} onOpenChange={setShowPollResultsModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Poll Results</DialogTitle>\n          </DialogHeader>\n          {selectedPoll && (\n            <div className=\"space-y-4\">\n              <h3 className=\"font-medium\">{selectedPoll.question}</h3>\n              <div className=\"space-y-3\">\n                {[...(selectedPoll.options || [])]\n                  .sort((a, b) => b.votes.length - a.votes.length)\n                  .map((option, index) => (\n                    <div key={option.id}>\n                      <div className=\"flex justify-between mb-1\">\n                        <span className={cn(\"text-sm\", index === 0 && \"font-medium\")}>\n                          {index === 0 && \" \"}{option.text}\n                        </span>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {option.votes.length} ({getVotePercentage(selectedPoll, option)}%)\n                        </span>\n                      </div>\n                      <Progress value={getVotePercentage(selectedPoll, option)} />\n                    </div>\n                  ))}\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                Total: {getTotalVotes(selectedPoll)} votes\n              </p>\n            </div>\n          )}\n          <DialogFooter>\n            <Button onClick={() => setShowPollResultsModal(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":42914,"size_tokens":null},"client/src/pages/shared/DealTemplates.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  FileStack, \n  Plus, \n  Search, \n  Copy,\n  Pencil,\n  Trash2,\n  CheckCircle,\n  Briefcase,\n  Building,\n  DollarSign,\n  Clock,\n  Users,\n  FileText,\n  Star,\n  StarOff,\n  Loader2\n} from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { useDealTemplates, useCreateDealTemplate, useUpdateDealTemplate, useDeleteDealTemplate, DealTemplateType } from \"@/lib/api\";\n\ntype DealTemplate = DealTemplateType;\n\nexport default function DealTemplates({ role }: { role: 'CEO' | 'Employee' }) {\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [selectedTemplate, setSelectedTemplate] = useState<DealTemplate | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n\n  const { data: templates = [], isLoading } = useDealTemplates();\n  \n  // Predefined categories that always show, plus any additional types from templates\n  const PREDEFINED_CATEGORIES = [\"Deal\", \"HR\", \"Compliance\", \"Operations\", \"Finance\", \"Legal\"];\n  const TEMPLATE_CATEGORIES = useMemo(() => {\n    const templateTypes = new Set(templates.map(t => t.dealType));\n    // Combine predefined with any custom types from templates\n    const allCategories = new Set([...PREDEFINED_CATEGORIES, ...templateTypes]);\n    return [\"all\", ...Array.from(allCategories).sort()];\n  }, [templates]);\n  const createTemplate = useCreateDealTemplate();\n  const updateTemplate = useUpdateDealTemplate();\n  const deleteTemplateMutation = useDeleteDealTemplate();\n\n  const [newTemplate, setNewTemplate] = useState({\n    name: \"\",\n    description: \"\",\n    sector: \"Technology\",\n    dealType: \"Deal\",\n    estimatedDuration: 90,\n    stages: \"\",\n    checklistItems: \"\"\n  });\n\n  const filteredTemplates = templates.filter(t => {\n    const matchesSearch = \n      t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      (t.description || '').toLowerCase().includes(searchQuery.toLowerCase()) ||\n      t.sector.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesCategory = categoryFilter === \"all\" || t.dealType === categoryFilter;\n    return matchesSearch && matchesCategory;\n  });\n\n  const handleCreateTemplate = async () => {\n    if (!newTemplate.name || !newTemplate.description) {\n      toast.error(\"Please fill in required fields\");\n      return;\n    }\n\n    try {\n      await createTemplate.mutateAsync({\n        name: newTemplate.name,\n        description: newTemplate.description,\n        sector: newTemplate.sector,\n        dealType: newTemplate.dealType,\n        stages: newTemplate.stages.split(\",\").map(s => s.trim()).filter(Boolean),\n        defaultTasks: [],\n        estimatedDuration: newTemplate.estimatedDuration,\n        checklistItems: newTemplate.checklistItems.split(\"\\n\").map(s => s.trim()).filter(Boolean),\n        isFavorite: false,\n        usageCount: 0,\n      });\n      setShowCreateModal(false);\n      setNewTemplate({ name: \"\", description: \"\", sector: \"Technology\", dealType: \"Deal\", estimatedDuration: 90, stages: \"\", checklistItems: \"\" });\n      toast.success(\"Template created successfully\");\n    } catch (error) {\n      toast.error(\"Failed to create template\");\n    }\n  };\n\n  const toggleFavorite = async (id: string) => {\n    const template = templates.find(t => t.id === id);\n    if (!template) return;\n    try {\n      await updateTemplate.mutateAsync({\n        id,\n        updates: { isFavorite: !template.isFavorite }\n      });\n    } catch (error) {\n      toast.error(\"Failed to update favorite\");\n    }\n  };\n\n  const duplicateTemplate = async (template: DealTemplate) => {\n    try {\n      await createTemplate.mutateAsync({\n        name: `${template.name} (Copy)`,\n        description: template.description,\n        sector: template.sector,\n        dealType: template.dealType,\n        stages: template.stages,\n        defaultTasks: template.defaultTasks,\n        estimatedDuration: template.estimatedDuration,\n        checklistItems: template.checklistItems,\n        isFavorite: false,\n        usageCount: 0,\n      });\n      toast.success(\"Template duplicated\");\n    } catch (error) {\n      toast.error(\"Failed to duplicate template\");\n    }\n  };\n\n  const deleteTemplate = async (id: string) => {\n    try {\n      await deleteTemplateMutation.mutateAsync(id);\n      toast.success(\"Template deleted\");\n    } catch (error) {\n      toast.error(\"Failed to delete template\");\n    }\n  };\n\n  const useTemplate = async (template: DealTemplate) => {\n    try {\n      await updateTemplate.mutateAsync({\n        id: template.id,\n        updates: { usageCount: (template.usageCount || 0) + 1 }\n      });\n      toast.success(`Creating new deal from \"${template.name}\" template`);\n    } catch (error) {\n      console.error(\"Failed to update usage count:\", error);\n      toast.success(`Creating new deal from \"${template.name}\" template`);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-96\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">Templates</h1>\n            <p className=\"text-muted-foreground\">Create and manage reusable configurations</p>\n          </div>\n          <Button onClick={() => setShowCreateModal(true)} data-testid=\"button-create-template\">\n            <Plus className=\"w-4 h-4 mr-2\" /> New Template\n          </Button>\n        </div>\n\n        {/* Category Filters */}\n        <div className=\"flex gap-2 flex-wrap\">\n          {TEMPLATE_CATEGORIES.map((category) => (\n            <Button\n              key={category}\n              variant={categoryFilter === category ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setCategoryFilter(category)}\n              data-testid={`filter-category-${category}`}\n            >\n              {category === \"all\" ? \"All\" : category}\n            </Button>\n          ))}\n        </div>\n\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <FileStack className=\"w-5 h-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{templates.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total Templates</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                  <Star className=\"w-5 h-5 text-yellow-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{templates.filter(t => t.isFavorite).length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Favorites</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                  <CheckCircle className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{templates.reduce((sum, t) => sum + (t.usageCount || 0), 0)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Times Used</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <Briefcase className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{new Set(templates.map(t => t.dealType)).size}</p>\n                  <p className=\"text-xs text-muted-foreground\">Deal Types</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Template Library</CardTitle>\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search templates...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-templates\"\n                />\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <ScrollArea className=\"h-[500px]\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                {filteredTemplates.map((template) => (\n                  <Card key={template.id} className=\"hover:border-primary/50 transition-colors\" data-testid={`template-${template.id}`}>\n                    <CardHeader className=\"pb-2\">\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <CardTitle className=\"text-base\">{template.name}</CardTitle>\n                            <button onClick={() => toggleFavorite(template.id)} className=\"hover:opacity-80\">\n                              {template.isFavorite ? (\n                                <Star className=\"w-4 h-4 text-yellow-500 fill-yellow-500\" />\n                              ) : (\n                                <StarOff className=\"w-4 h-4 text-muted-foreground\" />\n                              )}\n                            </button>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Badge variant=\"outline\">{template.dealType}</Badge>\n                            <Badge variant=\"secondary\">{template.sector}</Badge>\n                          </div>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <p className=\"text-sm text-muted-foreground line-clamp-2\">{template.description}</p>\n                      \n                      <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                        <span className=\"flex items-center gap-1\">\n                          <Clock className=\"w-3 h-3\" /> {template.estimatedDuration} days\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <FileText className=\"w-3 h-3\" /> {template.stages.length} stages\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <CheckCircle className=\"w-3 h-3\" /> Used {template.usageCount}x\n                        </span>\n                      </div>\n\n                      <div className=\"flex flex-wrap gap-1\">\n                        {template.stages.slice(0, 4).map((stage, i) => (\n                          <Badge key={i} variant=\"outline\" className=\"text-[10px]\">{stage}</Badge>\n                        ))}\n                        {template.stages.length > 4 && (\n                          <Badge variant=\"outline\" className=\"text-[10px]\">+{template.stages.length - 4}</Badge>\n                        )}\n                      </div>\n\n                      <div className=\"flex gap-2 pt-2\">\n                        <Button size=\"sm\" onClick={() => useTemplate(template)} className=\"flex-1\" data-testid={`use-template-${template.id}`}>\n                          Use Template\n                        </Button>\n                        <Button size=\"sm\" variant=\"outline\" onClick={() => duplicateTemplate(template)}>\n                          <Copy className=\"w-3 h-3\" />\n                        </Button>\n                        <Button size=\"sm\" variant=\"outline\" onClick={() => { setSelectedTemplate(template); setShowEditModal(true); }}>\n                          <Pencil className=\"w-3 h-3\" />\n                        </Button>\n                        <Button size=\"sm\" variant=\"outline\" onClick={() => deleteTemplate(template.id)} className=\"text-destructive hover:text-destructive\">\n                          <Trash2 className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n              {filteredTemplates.length === 0 && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No templates found\n                </div>\n              )}\n            </ScrollArea>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Create Deal Template</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Template Name *</Label>\n              <Input\n                value={newTemplate.name}\n                onChange={(e) => setNewTemplate({ ...newTemplate, name: e.target.value })}\n                placeholder=\"e.g., Standard M&A Template\"\n                data-testid=\"input-template-name\"\n              />\n            </div>\n            <div>\n              <Label>Description *</Label>\n              <Textarea\n                value={newTemplate.description}\n                onChange={(e) => setNewTemplate({ ...newTemplate, description: e.target.value })}\n                placeholder=\"Describe when to use this template...\"\n                data-testid=\"input-template-description\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Sector</Label>\n                <Select value={newTemplate.sector} onValueChange={(v) => setNewTemplate({ ...newTemplate, sector: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Technology\">Technology</SelectItem>\n                    <SelectItem value=\"Healthcare\">Healthcare</SelectItem>\n                    <SelectItem value=\"Finance\">Finance</SelectItem>\n                    <SelectItem value=\"Energy\">Energy</SelectItem>\n                    <SelectItem value=\"All\">All Sectors</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label>Category</Label>\n                <Select value={newTemplate.dealType} onValueChange={(v) => setNewTemplate({ ...newTemplate, dealType: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {PREDEFINED_CATEGORIES.map((category) => (\n                      <SelectItem key={category} value={category}>{category}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div>\n              <Label>Estimated Duration (days)</Label>\n              <Input\n                type=\"number\"\n                value={newTemplate.estimatedDuration}\n                onChange={(e) => setNewTemplate({ ...newTemplate, estimatedDuration: parseInt(e.target.value) || 90 })}\n                data-testid=\"input-template-duration\"\n              />\n            </div>\n            <div>\n              <Label>Stages (comma-separated)</Label>\n              <Input\n                value={newTemplate.stages}\n                onChange={(e) => setNewTemplate({ ...newTemplate, stages: e.target.value })}\n                placeholder=\"Origination, Structuring, Diligence, Legal, Close\"\n                data-testid=\"input-template-stages\"\n              />\n            </div>\n            <div>\n              <Label>Checklist Items (one per line)</Label>\n              <Textarea\n                value={newTemplate.checklistItems}\n                onChange={(e) => setNewTemplate({ ...newTemplate, checklistItems: e.target.value })}\n                placeholder=\"NDA signed&#10;Data room configured&#10;...\"\n                rows={4}\n                data-testid=\"input-template-checklist\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateTemplate} data-testid=\"button-submit-template\">Create Template</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":18095,"size_tokens":null},"client/src/pages/shared/ClientPortal.tsx":{"content":"import { useState } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  Users, \n  Plus, \n  Search, \n  Link2, \n  Mail, \n  Eye, \n  EyeOff,\n  FileText,\n  Clock,\n  CheckCircle,\n  Shield,\n  ExternalLink,\n  Copy,\n  Settings,\n  Bell,\n  Download,\n  Upload,\n  Loader2,\n  Trash2,\n  Send,\n  UserPlus,\n  Building2,\n  XCircle\n} from \"lucide-react\";\nimport { useDealsListing, useClientPortalAccess, useCreateClientPortalAccess, useUpdateClientPortalAccess, useDeleteClientPortalAccess, usePortalInvites, useCreatePortalInvite, useRevokePortalInvite, useExternalUsers } from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport type { ClientPortalAccess } from \"@shared/schema\";\n\nexport default function ClientPortal({ role }: { role: 'CEO' | 'Employee' }) {\n  const { data: deals = [] } = useDealsListing();\n  const { data: clientAccess = [], isLoading } = useClientPortalAccess();\n  const { data: portalInvites = [], isLoading: invitesLoading } = usePortalInvites();\n  const { data: externalUsers = [] } = useExternalUsers();\n  const createAccess = useCreateClientPortalAccess();\n  const updateAccess = useUpdateClientPortalAccess();\n  const deleteAccess = useDeleteClientPortalAccess();\n  const createInvite = useCreatePortalInvite();\n  const revokeInvite = useRevokePortalInvite();\n  \n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showInviteModal, setShowInviteModal] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"active\");\n  const [mainTab, setMainTab] = useState(\"invitations\");\n\n  const [newAccess, setNewAccess] = useState({\n    clientName: \"\",\n    clientEmail: \"\",\n    dealId: \"\",\n    accessLevel: \"view\" as 'view' | 'upload' | 'full',\n    expiresAt: \"\",\n    notifyClient: true\n  });\n  \n  const [newInvite, setNewInvite] = useState({\n    name: \"\",\n    email: \"\",\n    organization: \"\",\n    dealIds: [] as string[],\n    accessLevel: \"view\",\n    message: \"\"\n  });\n\n  // Helper to get deal name from ID\n  const getDealName = (dealId: string) => {\n    const deal = deals.find(d => d.id === dealId);\n    return deal?.name || \"Unknown Deal\";\n  };\n\n  // Generate portal URL from access token or ID\n  const getPortalUrl = (access: ClientPortalAccess) => {\n    return `https://portal.kronos.com/c/${access.accessToken || access.id.substring(0, 8)}`;\n  };\n\n  const filteredAccess = clientAccess.filter(access => {\n    const dealName = getDealName(access.dealId);\n    const matchesSearch = access.clientName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      dealName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      access.clientEmail.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    if (activeTab === \"active\") return matchesSearch && access.isActive;\n    if (activeTab === \"expired\") return matchesSearch && !access.isActive;\n    return matchesSearch;\n  });\n\n  const handleCreateAccess = async () => {\n    if (!newAccess.clientName || !newAccess.clientEmail || !newAccess.dealId) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n\n    try {\n      await createAccess.mutateAsync({\n        clientName: newAccess.clientName,\n        clientEmail: newAccess.clientEmail,\n        dealId: newAccess.dealId,\n        accessLevel: newAccess.accessLevel,\n        expiresAt: newAccess.expiresAt || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n        isActive: true,\n        accessToken: Math.random().toString(36).substring(2, 10),\n      });\n\n      setShowCreateModal(false);\n      setNewAccess({ clientName: \"\", clientEmail: \"\", dealId: \"\", accessLevel: \"view\", expiresAt: \"\", notifyClient: true });\n      \n      if (newAccess.notifyClient) {\n        toast.success(`Portal access created and invitation sent to ${newAccess.clientEmail}`);\n      } else {\n        toast.success(\"Portal access created successfully\");\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create portal access\");\n    }\n  };\n\n  const toggleAccess = async (id: string, currentStatus: boolean | null) => {\n    try {\n      await updateAccess.mutateAsync({\n        id,\n        updates: { isActive: !currentStatus },\n      });\n      toast.success(\"Access status updated\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update access status\");\n    }\n  };\n\n  const copyPortalLink = (url: string) => {\n    navigator.clipboard.writeText(url);\n    toast.success(\"Portal link copied to clipboard\");\n  };\n\n  const handleDeleteAccess = async (id: string, clientName: string) => {\n    if (!confirm(`Are you sure you want to delete portal access for ${clientName}? This action cannot be undone.`)) {\n      return;\n    }\n    \n    try {\n      await deleteAccess.mutateAsync(id);\n      toast.success(\"Portal access deleted\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete portal access\");\n    }\n  };\n  \n  const handleCreateInvite = async () => {\n    if (!newInvite.name || !newInvite.email || newInvite.dealIds.length === 0) {\n      toast.error(\"Please fill in name, email, and select at least one deal\");\n      return;\n    }\n    \n    try {\n      await createInvite.mutateAsync({\n        name: newInvite.name,\n        email: newInvite.email,\n        organization: newInvite.organization || undefined,\n        dealIds: newInvite.dealIds,\n        accessLevel: newInvite.accessLevel,\n        message: newInvite.message || undefined\n      });\n      \n      setShowInviteModal(false);\n      setNewInvite({ name: \"\", email: \"\", organization: \"\", dealIds: [], accessLevel: \"view\", message: \"\" });\n      toast.success(`Invitation sent to ${newInvite.email}`);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to send invitation\");\n    }\n  };\n  \n  const handleRevokeInvite = async (id: string, email: string) => {\n    if (!confirm(`Are you sure you want to revoke the invitation for ${email}?`)) {\n      return;\n    }\n    \n    try {\n      await revokeInvite.mutateAsync(id);\n      toast.success(\"Invitation revoked\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to revoke invitation\");\n    }\n  };\n  \n  const toggleDealSelection = (dealId: string) => {\n    setNewInvite(prev => ({\n      ...prev,\n      dealIds: prev.dealIds.includes(dealId) \n        ? prev.dealIds.filter(id => id !== dealId)\n        : [...prev.dealIds, dealId]\n    }));\n  };\n\n  const getAccessBadge = (level: string) => {\n    switch (level) {\n      case 'view':\n        return <Badge variant=\"secondary\"><Eye className=\"w-3 h-3 mr-1\" /> View Only</Badge>;\n      case 'upload':\n        return <Badge variant=\"default\"><Upload className=\"w-3 h-3 mr-1\" /> Upload</Badge>;\n      case 'full':\n        return <Badge className=\"bg-green-500\"><Shield className=\"w-3 h-3 mr-1\" /> Full Access</Badge>;\n      default:\n        return <Badge variant=\"outline\">{level}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-96\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n        </div>\n      </Layout>\n    );\n  }\n\n  const pendingInvites = portalInvites.filter(i => i.status === 'pending');\n  const acceptedInvites = portalInvites.filter(i => i.status === 'accepted');\n  const revokedInvites = portalInvites.filter(i => i.status === 'revoked' || i.status === 'expired');\n  \n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">Client Portal</h1>\n            <p className=\"text-muted-foreground\">Manage secure client access to deal documents and communications</p>\n          </div>\n          <Button onClick={() => setShowInviteModal(true)} data-testid=\"button-invite-client\">\n            <UserPlus className=\"w-4 h-4 mr-2\" /> Invite Client\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <Mail className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{pendingInvites.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Pending Invites</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                  <Users className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{(externalUsers as any[]).length}</p>\n                  <p className=\"text-xs text-muted-foreground\">External Users</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-purple-500/10 rounded-lg\">\n                  <FileText className=\"w-5 h-5 text-purple-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{deals.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Available Deals</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-amber-500/10 rounded-lg\">\n                  <CheckCircle className=\"w-5 h-5 text-amber-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{acceptedInvites.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Active Clients</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n        \n        <Tabs value={mainTab} onValueChange={setMainTab}>\n          <TabsList>\n            <TabsTrigger value=\"invitations\">Invitations</TabsTrigger>\n            <TabsTrigger value=\"users\">External Users</TabsTrigger>\n            <TabsTrigger value=\"legacy\">Legacy Access</TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"invitations\" className=\"space-y-4 mt-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Portal Invitations</CardTitle>\n                <CardDescription>Send and manage client portal invitations</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Tabs defaultValue=\"pending\">\n                  <TabsList className=\"mb-4\">\n                    <TabsTrigger value=\"pending\">Pending ({pendingInvites.length})</TabsTrigger>\n                    <TabsTrigger value=\"accepted\">Accepted ({acceptedInvites.length})</TabsTrigger>\n                    <TabsTrigger value=\"revoked\">Revoked/Expired ({revokedInvites.length})</TabsTrigger>\n                  </TabsList>\n                  \n                  <TabsContent value=\"pending\">\n                    <ScrollArea className=\"h-[400px]\">\n                      {invitesLoading ? (\n                        <div className=\"flex justify-center py-8\">\n                          <Loader2 className=\"h-6 w-6 animate-spin\" />\n                        </div>\n                      ) : pendingInvites.length === 0 ? (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <Mail className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                          <p>No pending invitations</p>\n                          <Button variant=\"link\" onClick={() => setShowInviteModal(true)}>\n                            Send your first invitation\n                          </Button>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {pendingInvites.map((invite) => (\n                            <div key={invite.id} className=\"p-4 border rounded-lg\" data-testid={`invite-${invite.id}`}>\n                              <div className=\"flex items-start justify-between\">\n                                <div className=\"space-y-1\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <h3 className=\"font-medium\">{invite.name}</h3>\n                                    <Badge variant=\"outline\" className=\"text-amber-500 border-amber-500\">Pending</Badge>\n                                  </div>\n                                  <p className=\"text-sm text-muted-foreground\">{invite.email}</p>\n                                  {invite.organization && (\n                                    <p className=\"text-sm flex items-center gap-1\">\n                                      <Building2 className=\"h-3 w-3\" /> {invite.organization}\n                                    </p>\n                                  )}\n                                  <div className=\"flex flex-wrap gap-1 mt-2\">\n                                    {invite.dealIds.map(dealId => (\n                                      <Badge key={dealId} variant=\"secondary\" className=\"text-xs\">\n                                        {getDealName(dealId)}\n                                      </Badge>\n                                    ))}\n                                  </div>\n                                </div>\n                                <div className=\"flex items-center gap-2\">\n                                  <Button\n                                    variant=\"destructive\"\n                                    size=\"sm\"\n                                    onClick={() => handleRevokeInvite(invite.id, invite.email)}\n                                    data-testid={`revoke-invite-${invite.id}`}\n                                  >\n                                    <XCircle className=\"w-3 h-3 mr-1\" /> Revoke\n                                  </Button>\n                                </div>\n                              </div>\n                              <div className=\"mt-3 flex items-center gap-4 text-xs text-muted-foreground\">\n                                <span className=\"flex items-center gap-1\">\n                                  <Clock className=\"w-3 h-3\" /> Expires: {format(new Date(invite.expiresAt), 'MMM d, yyyy')}\n                                </span>\n                                <span className=\"flex items-center gap-1\">\n                                  <Send className=\"w-3 h-3\" /> Sent by: {invite.inviterName}\n                                </span>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </TabsContent>\n                  \n                  <TabsContent value=\"accepted\">\n                    <ScrollArea className=\"h-[400px]\">\n                      {acceptedInvites.length === 0 ? (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <CheckCircle className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                          <p>No accepted invitations yet</p>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {acceptedInvites.map((invite) => (\n                            <div key={invite.id} className=\"p-4 border rounded-lg\">\n                              <div className=\"flex items-start justify-between\">\n                                <div className=\"space-y-1\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <h3 className=\"font-medium\">{invite.name}</h3>\n                                    <Badge variant=\"default\" className=\"bg-green-500\">Accepted</Badge>\n                                  </div>\n                                  <p className=\"text-sm text-muted-foreground\">{invite.email}</p>\n                                  {invite.organization && (\n                                    <p className=\"text-sm flex items-center gap-1\">\n                                      <Building2 className=\"h-3 w-3\" /> {invite.organization}\n                                    </p>\n                                  )}\n                                </div>\n                              </div>\n                              <div className=\"mt-3 flex items-center gap-4 text-xs text-muted-foreground\">\n                                <span className=\"flex items-center gap-1\">\n                                  <CheckCircle className=\"w-3 h-3\" /> Accepted: {invite.acceptedAt ? format(new Date(invite.acceptedAt), 'MMM d, yyyy') : 'N/A'}\n                                </span>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </TabsContent>\n                  \n                  <TabsContent value=\"revoked\">\n                    <ScrollArea className=\"h-[400px]\">\n                      {revokedInvites.length === 0 ? (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <XCircle className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                          <p>No revoked or expired invitations</p>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {revokedInvites.map((invite) => (\n                            <div key={invite.id} className=\"p-4 border rounded-lg opacity-60\">\n                              <div className=\"flex items-start justify-between\">\n                                <div className=\"space-y-1\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <h3 className=\"font-medium\">{invite.name}</h3>\n                                    <Badge variant=\"destructive\">{invite.status}</Badge>\n                                  </div>\n                                  <p className=\"text-sm text-muted-foreground\">{invite.email}</p>\n                                </div>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </TabsContent>\n                </Tabs>\n              </CardContent>\n            </Card>\n          </TabsContent>\n          \n          <TabsContent value=\"users\" className=\"space-y-4 mt-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>External Users</CardTitle>\n                <CardDescription>Clients and stakeholders with portal access</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ScrollArea className=\"h-[400px]\">\n                  {(externalUsers as any[]).length === 0 ? (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <Users className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                      <p>No external users yet</p>\n                      <p className=\"text-sm\">Invite clients to create their portal accounts</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {(externalUsers as any[]).map((user: any) => (\n                        <div key={user.id} className=\"p-4 border rounded-lg\" data-testid={`external-user-${user.id}`}>\n                          <div className=\"flex items-start justify-between\">\n                            <div className=\"space-y-1\">\n                              <div className=\"flex items-center gap-2\">\n                                <h3 className=\"font-medium\">{user.name}</h3>\n                                <Badge variant=\"outline\">External</Badge>\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n                              {user.externalOrganization && (\n                                <p className=\"text-sm flex items-center gap-1\">\n                                  <Building2 className=\"h-3 w-3\" /> {user.externalOrganization}\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"mt-3 text-xs text-muted-foreground\">\n                            Joined: {user.createdAt ? formatDistanceToNow(new Date(user.createdAt), { addSuffix: true }) : 'Unknown'}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          </TabsContent>\n          \n          <TabsContent value=\"legacy\" className=\"space-y-4 mt-4\">\n            <div className=\"grid grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                  <Users className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{clientAccess.filter(a => a.isActive).length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Active Portals</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <FileText className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{clientAccess.length * 5}</p>\n                  <p className=\"text-xs text-muted-foreground\">Documents Shared</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                  <Clock className=\"w-5 h-5 text-yellow-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{clientAccess.filter(a => a.lastAccess && new Date(a.lastAccess) > new Date(Date.now() - 24 * 60 * 60 * 1000)).length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Accessed Today</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-red-500/10 rounded-lg\">\n                  <EyeOff className=\"w-5 h-5 text-red-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{clientAccess.filter(a => !a.isActive).length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Expired/Disabled</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Portal Access Management</CardTitle>\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search clients or deals...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-portals\"\n                />\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\n              <TabsList>\n                <TabsTrigger value=\"active\">Active ({clientAccess.filter(a => a.isActive).length})</TabsTrigger>\n                <TabsTrigger value=\"expired\">Expired ({clientAccess.filter(a => !a.isActive).length})</TabsTrigger>\n                <TabsTrigger value=\"all\">All ({clientAccess.length})</TabsTrigger>\n              </TabsList>\n              <TabsContent value={activeTab} className=\"mt-4\">\n                <ScrollArea className=\"h-[400px]\">\n                  <div className=\"space-y-3\">\n                    {filteredAccess.map((access) => (\n                      <div\n                        key={access.id}\n                        className=\"p-4 border rounded-lg hover:bg-secondary/30 transition-colors\"\n                        data-testid={`portal-access-${access.id}`}\n                      >\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"space-y-1\">\n                            <div className=\"flex items-center gap-2\">\n                              <h3 className=\"font-medium\">{access.clientName}</h3>\n                              {getAccessBadge(access.accessLevel)}\n                              {!access.isActive && <Badge variant=\"destructive\">Disabled</Badge>}\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">{access.clientEmail}</p>\n                            <p className=\"text-sm\">\n                              <span className=\"text-muted-foreground\">Deal:</span> {getDealName(access.dealId)}\n                            </p>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => copyPortalLink(getPortalUrl(access))}\n                              data-testid={`copy-link-${access.id}`}\n                            >\n                              <Copy className=\"w-3 h-3 mr-1\" /> Copy Link\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => window.open(getPortalUrl(access), '_blank')}\n                            >\n                              <ExternalLink className=\"w-3 h-3\" />\n                            </Button>\n                            <Switch\n                              checked={access.isActive ?? false}\n                              onCheckedChange={() => toggleAccess(access.id, access.isActive)}\n                              data-testid={`toggle-access-${access.id}`}\n                            />\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"text-destructive hover:bg-destructive/10\"\n                              onClick={() => handleDeleteAccess(access.id, access.clientName)}\n                              data-testid={`delete-access-${access.id}`}\n                            >\n                              <Trash2 className=\"w-3 h-3\" />\n                            </Button>\n                          </div>\n                        </div>\n                        <div className=\"mt-3 flex items-center gap-4 text-xs text-muted-foreground\">\n                          <span className=\"flex items-center gap-1\">\n                            <FileText className=\"w-3 h-3\" /> 5 documents\n                          </span>\n                          {access.expiresAt && (\n                            <span className=\"flex items-center gap-1\">\n                              <Clock className=\"w-3 h-3\" /> Expires: {format(new Date(access.expiresAt), 'MMM d, yyyy')}\n                            </span>\n                          )}\n                          {access.lastAccess && (\n                            <span className=\"flex items-center gap-1\">\n                              <Eye className=\"w-3 h-3\" /> Last access: {format(new Date(access.lastAccess), 'MMM d, h:mm a')}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                    {filteredAccess.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        No portal access found\n                      </div>\n                    )}\n                  </div>\n                </ScrollArea>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Portal Access</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Client Name *</Label>\n              <Input\n                value={newAccess.clientName}\n                onChange={(e) => setNewAccess({ ...newAccess, clientName: e.target.value })}\n                placeholder=\"Enter client name\"\n                data-testid=\"input-client-name\"\n              />\n            </div>\n            <div>\n              <Label>Client Email *</Label>\n              <Input\n                type=\"email\"\n                value={newAccess.clientEmail}\n                onChange={(e) => setNewAccess({ ...newAccess, clientEmail: e.target.value })}\n                placeholder=\"client@example.com\"\n                data-testid=\"input-client-email\"\n              />\n            </div>\n            <div>\n              <Label>Deal *</Label>\n              <Select value={newAccess.dealId} onValueChange={(v) => setNewAccess({ ...newAccess, dealId: v })}>\n                <SelectTrigger data-testid=\"select-deal\">\n                  <SelectValue placeholder=\"Select a deal\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {deals.map((deal) => (\n                    <SelectItem key={deal.id} value={deal.id}>{deal.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Access Level</Label>\n              <Select value={newAccess.accessLevel} onValueChange={(v: any) => setNewAccess({ ...newAccess, accessLevel: v })}>\n                <SelectTrigger data-testid=\"select-access-level\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"view\">View Only - Can view shared documents</SelectItem>\n                  <SelectItem value=\"upload\">Upload - Can view and upload documents</SelectItem>\n                  <SelectItem value=\"full\">Full Access - Can view, upload, and comment</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Expires On</Label>\n              <Input\n                type=\"date\"\n                value={newAccess.expiresAt}\n                onChange={(e) => setNewAccess({ ...newAccess, expiresAt: e.target.value })}\n                data-testid=\"input-expires-at\"\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                checked={newAccess.notifyClient}\n                onCheckedChange={(checked) => setNewAccess({ ...newAccess, notifyClient: checked })}\n              />\n              <Label>Send invitation email to client</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateAccess} data-testid=\"button-submit-portal-access\">Create Access</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      <Dialog open={showInviteModal} onOpenChange={setShowInviteModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Invite Client to Portal</DialogTitle>\n            <DialogDescription>\n              Send an invitation email to a client or stakeholder to access deal information.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Name *</Label>\n                <Input\n                  value={newInvite.name}\n                  onChange={(e) => setNewInvite({ ...newInvite, name: e.target.value })}\n                  placeholder=\"John Smith\"\n                  data-testid=\"input-invite-name\"\n                />\n              </div>\n              <div>\n                <Label>Email *</Label>\n                <Input\n                  type=\"email\"\n                  value={newInvite.email}\n                  onChange={(e) => setNewInvite({ ...newInvite, email: e.target.value })}\n                  placeholder=\"john@company.com\"\n                  data-testid=\"input-invite-email\"\n                />\n              </div>\n            </div>\n            <div>\n              <Label>Organization</Label>\n              <Input\n                value={newInvite.organization}\n                onChange={(e) => setNewInvite({ ...newInvite, organization: e.target.value })}\n                placeholder=\"Company Inc.\"\n                data-testid=\"input-invite-organization\"\n              />\n            </div>\n            <div>\n              <Label>Access Level</Label>\n              <Select value={newInvite.accessLevel} onValueChange={(v) => setNewInvite({ ...newInvite, accessLevel: v })}>\n                <SelectTrigger data-testid=\"select-invite-access-level\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"view\">View Only - Can view shared documents</SelectItem>\n                  <SelectItem value=\"upload\">Upload - Can view and upload documents</SelectItem>\n                  <SelectItem value=\"full\">Full Access - View, upload, and communicate</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Select Deals *</Label>\n              <p className=\"text-xs text-muted-foreground mb-2\">Select which deals this client can access</p>\n              <ScrollArea className=\"h-[150px] border rounded-lg p-2\">\n                <div className=\"space-y-2\">\n                  {deals.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">No deals available</p>\n                  ) : (\n                    deals.map((deal) => (\n                      <div key={deal.id} className=\"flex items-center gap-2\">\n                        <Checkbox\n                          id={`deal-${deal.id}`}\n                          checked={newInvite.dealIds.includes(deal.id)}\n                          onCheckedChange={() => toggleDealSelection(deal.id)}\n                          data-testid={`checkbox-deal-${deal.id}`}\n                        />\n                        <label htmlFor={`deal-${deal.id}`} className=\"text-sm cursor-pointer flex-1\">\n                          {deal.name}\n                          <span className=\"text-xs text-muted-foreground ml-2\">({deal.stage})</span>\n                        </label>\n                      </div>\n                    ))\n                  )}\n                </div>\n              </ScrollArea>\n            </div>\n            <div>\n              <Label>Personal Message (Optional)</Label>\n              <Textarea\n                value={newInvite.message}\n                onChange={(e) => setNewInvite({ ...newInvite, message: e.target.value })}\n                placeholder=\"Add a personal note to include in the invitation email...\"\n                rows={3}\n                data-testid=\"input-invite-message\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowInviteModal(false)}>Cancel</Button>\n            <Button \n              onClick={handleCreateInvite} \n              disabled={createInvite.isPending || !newInvite.name || !newInvite.email || newInvite.dealIds.length === 0}\n              data-testid=\"button-send-invite\"\n            >\n              {createInvite.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Sending...\n                </>\n              ) : (\n                <>\n                  <Send className=\"w-4 h-4 mr-2\" />\n                  Send Invitation\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":38233,"size_tokens":null},"client/src/pages/shared/MentorshipPairing.tsx":{"content":"import { useState } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { \n  Users, \n  Plus, \n  Search, \n  UserPlus,\n  GraduationCap,\n  Target,\n  Calendar,\n  MessageSquare,\n  TrendingUp,\n  Award,\n  Heart,\n  Loader2,\n  Trash2\n} from \"lucide-react\";\nimport { useUsers, useMentorshipPairings, useCreateMentorshipPairing, useUpdateMentorshipPairing, useDeleteMentorshipPairing, useCurrentUser } from \"@/lib/api\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport type { MentorshipPairing } from \"@shared/schema\";\n\nexport default function MentorshipPairing({ role }: { role: 'CEO' | 'Employee' }) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [] } = useUsers();\n  const { data: pairings = [], isLoading } = useMentorshipPairings();\n  const createPairing = useCreateMentorshipPairing();\n  const updatePairing = useUpdateMentorshipPairing();\n  const deletePairing = useDeleteMentorshipPairing();\n\n  const handleDeletePairing = async (id: string) => {\n    if (!confirm(\"Are you sure you want to remove this mentorship pairing?\")) return;\n    try {\n      await deletePairing.mutateAsync(id);\n      toast.success(\"Mentorship pairing removed\");\n    } catch (error) {\n      toast.error(\"Failed to remove pairing\");\n    }\n  };\n  \n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [newPairing, setNewPairing] = useState({\n    mentorId: \"\",\n    menteeId: \"\",\n    focusAreas: \"\",\n    goals: \"\",\n    meetingFrequency: \"Weekly\",\n    firstMeeting: \"\"\n  });\n\n  const seniorRoles = ['Managing Director', 'Director', 'CEO'];\n  const mentors = users.filter(u => seniorRoles.includes(u.role));\n  const mentees = users.filter(u => !seniorRoles.includes(u.role));\n\n  // Helper to get user info from ID\n  const getUserRole = (userId: string) => {\n    const user = users.find(u => u.id === userId);\n    return user?.role || \"Unknown\";\n  };\n\n  const filteredPairings = pairings.filter(p =>\n    p.mentorName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    p.menteeName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    (p.focusAreas || []).some((f: string) => f.toLowerCase().includes(searchQuery.toLowerCase()))\n  );\n\n  const handleCreatePairing = async () => {\n    if (!newPairing.mentorId || !newPairing.menteeId) {\n      toast.error(\"Please select both mentor and mentee\");\n      return;\n    }\n\n    const mentor = users.find(u => u.id === newPairing.mentorId);\n    const mentee = users.find(u => u.id === newPairing.menteeId);\n\n    try {\n      await createPairing.mutateAsync({\n        mentorId: newPairing.mentorId,\n        mentorName: mentor?.name || \"Unknown\",\n        menteeId: newPairing.menteeId,\n        menteeName: mentee?.name || \"Unknown\",\n        focusAreas: newPairing.focusAreas.split(\",\").map(s => s.trim()).filter(Boolean),\n        goals: newPairing.goals.split(\"\\n\").map(s => s.trim()).filter(Boolean),\n        meetingFrequency: newPairing.meetingFrequency,\n        startDate: new Date().toISOString(),\n        status: \"active\",\n      });\n\n      setShowCreateModal(false);\n      setNewPairing({ mentorId: \"\", menteeId: \"\", focusAreas: \"\", goals: \"\", meetingFrequency: \"Weekly\", firstMeeting: \"\" });\n      toast.success(\"Mentorship pairing created successfully\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create pairing\");\n    }\n  };\n\n  const updatePairingStatus = async (id: string, status: string) => {\n    try {\n      await updatePairing.mutateAsync({\n        id,\n        updates: { \n          status, \n          endDate: status === 'completed' ? new Date().toISOString() : undefined \n        },\n      });\n      toast.success(\"Pairing status updated\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update pairing\");\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'active':\n        return <Badge className=\"bg-green-500\">Active</Badge>;\n      case 'completed':\n        return <Badge variant=\"secondary\">Completed</Badge>;\n      case 'paused':\n        return <Badge variant=\"outline\">Paused</Badge>;\n      default:\n        return <Badge>{status}</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-96\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">Mentorship Pairing</h1>\n            <p className=\"text-muted-foreground\">Manage mentor-mentee relationships and track development goals</p>\n          </div>\n          {currentUser?.accessLevel === 'admin' && (\n            <Button onClick={() => setShowCreateModal(true)} data-testid=\"button-create-pairing\">\n              <Plus className=\"w-4 h-4 mr-2\" /> New Pairing\n            </Button>\n          )}\n        </div>\n\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <Users className=\"w-5 h-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{pairings.filter(p => p.status === 'active').length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Active Pairings</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-green-500/10 rounded-lg\">\n                  <GraduationCap className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{pairings.filter(p => p.status === 'completed').length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Completed Programs</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <Target className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {pairings.reduce((sum, p) => sum + (p.goals || []).length, 0)}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Total Goals</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                  <Calendar className=\"w-5 h-5 text-yellow-500\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{pairings.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total Pairs</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Mentorship Pairs</CardTitle>\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search pairings...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-pairings\"\n                />\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <ScrollArea className=\"h-[500px]\">\n              <div className=\"space-y-4\">\n                {filteredPairings.map((pairing) => (\n                  <Card key={pairing.id} className=\"hover:border-primary/50 transition-colors\" data-testid={`pairing-${pairing.id}`}>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-start justify-between mb-4\">\n                        <div className=\"flex items-center gap-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <Avatar className=\"h-10 w-10\">\n                              <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                                {pairing.mentorName.split(' ').map(n => n[0]).join('')}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <p className=\"font-medium\">{pairing.mentorName}</p>\n                              <p className=\"text-xs text-muted-foreground\">{getUserRole(pairing.mentorId)} (Mentor)</p>\n                            </div>\n                          </div>\n                          <Heart className=\"w-4 h-4 text-red-400\" />\n                          <div className=\"flex items-center gap-2\">\n                            <Avatar className=\"h-10 w-10\">\n                              <AvatarFallback className=\"bg-secondary\">\n                                {pairing.menteeName.split(' ').map(n => n[0]).join('')}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <p className=\"font-medium\">{pairing.menteeName}</p>\n                              <p className=\"text-xs text-muted-foreground\">{getUserRole(pairing.menteeId)} (Mentee)</p>\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {getStatusBadge(pairing.status)}\n                          {currentUser?.accessLevel === 'admin' && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => handleDeletePairing(pairing.id)}\n                              className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n                              data-testid={`delete-pairing-${pairing.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          )}\n                        </div>\n                      </div>\n\n                      <div className=\"grid grid-cols-2 gap-4 mb-4\">\n                        <div>\n                          <p className=\"text-xs text-muted-foreground mb-2\">Focus Areas</p>\n                          <div className=\"flex flex-wrap gap-1\">\n                            {(pairing.focusAreas || []).map((area, i) => (\n                              <Badge key={i} variant=\"outline\" className=\"text-xs\">{area}</Badge>\n                            ))}\n                          </div>\n                        </div>\n                        <div>\n                          <p className=\"text-xs text-muted-foreground mb-2\">Goals</p>\n                          <div className=\"text-sm\">\n                            {(pairing.goals || []).length} development goals\n                          </div>\n                        </div>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <p className=\"text-xs text-muted-foreground\">Development Goals</p>\n                        <div className=\"space-y-1\">\n                          {(pairing.goals || []).map((goal, index) => (\n                            <div\n                              key={index}\n                              className=\"flex items-center gap-2 text-sm p-1 rounded\"\n                            >\n                              <Target className=\"w-4 h-4 text-muted-foreground\" />\n                              <span>{goal}</span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-center gap-4 mt-4 pt-4 border-t text-xs text-muted-foreground\">\n                        <span className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-3 h-3\" /> {pairing.meetingFrequency || 'Weekly'}\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <TrendingUp className=\"w-3 h-3\" /> Since {format(new Date(pairing.startDate), 'MMM yyyy')}\n                        </span>\n                        {pairing.notes && (\n                          <span className=\"flex items-center gap-1\">\n                            <MessageSquare className=\"w-3 h-3\" /> Has notes\n                          </span>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n                {filteredPairings.length === 0 && (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    No mentorship pairings found\n                  </div>\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Mentorship Pairing</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Mentor *</Label>\n              <Select value={newPairing.mentorId} onValueChange={(v) => setNewPairing({ ...newPairing, mentorId: v })}>\n                <SelectTrigger data-testid=\"select-mentor\">\n                  <SelectValue placeholder=\"Select a mentor\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {mentors.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>{user.name} ({user.jobTitle || user.role})</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Mentee *</Label>\n              <Select value={newPairing.menteeId} onValueChange={(v) => setNewPairing({ ...newPairing, menteeId: v })}>\n                <SelectTrigger data-testid=\"select-mentee\">\n                  <SelectValue placeholder=\"Select a mentee\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {mentees.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>{user.name} ({user.jobTitle || user.role})</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Focus Areas (comma-separated)</Label>\n              <Input\n                value={newPairing.focusAreas}\n                onChange={(e) => setNewPairing({ ...newPairing, focusAreas: e.target.value })}\n                placeholder=\"Financial Modeling, Leadership, Client Relations\"\n                data-testid=\"input-focus-areas\"\n              />\n            </div>\n            <div>\n              <Label>Development Goals (one per line)</Label>\n              <Textarea\n                value={newPairing.goals}\n                onChange={(e) => setNewPairing({ ...newPairing, goals: e.target.value })}\n                placeholder=\"Complete certification&#10;Lead a project&#10;...\"\n                rows={4}\n                data-testid=\"input-goals\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Meeting Frequency</Label>\n                <Select value={newPairing.meetingFrequency} onValueChange={(v) => setNewPairing({ ...newPairing, meetingFrequency: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Weekly\">Weekly</SelectItem>\n                    <SelectItem value=\"Bi-weekly\">Bi-weekly</SelectItem>\n                    <SelectItem value=\"Monthly\">Monthly</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label>First Meeting</Label>\n                <Input\n                  type=\"datetime-local\"\n                  value={newPairing.firstMeeting}\n                  onChange={(e) => setNewPairing({ ...newPairing, firstMeeting: e.target.value })}\n                  data-testid=\"input-first-meeting\"\n                />\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreatePairing} data-testid=\"button-submit-pairing\">Create Pairing</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":18066,"size_tokens":null},"client/src/pages/shared/StakeholderDirectory.tsx":{"content":"import { useState, useMemo, useRef, useEffect } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport * as XLSX from \"xlsx\";\nimport { \n  Users, \n  Plus, \n  Search, \n  Building,\n  Mail,\n  Phone,\n  Globe,\n  Linkedin,\n  MapPin,\n  Briefcase,\n  Star,\n  StarOff,\n  Pencil,\n  Trash2,\n  ExternalLink,\n  Calendar,\n  Upload,\n  FileSpreadsheet,\n  CheckCircle,\n  AlertCircle,\n  Loader2,\n  FileText,\n  Sparkles\n} from \"lucide-react\";\nimport { useDealsListing, useStakeholders, useStakeholderStats, useCreateStakeholder, useUpdateStakeholder, useDeleteStakeholder } from \"@/lib/api\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport type { Stakeholder } from \"@shared/schema\";\n\ntype StakeholderType = 'investor' | 'advisor' | 'legal' | 'banker' | 'consultant' | 'client' | 'other';\n\ntype LocalStakeholder = {\n  id: string;\n  name: string;\n  title: string;\n  company: string;\n  type: StakeholderType;\n  email?: string;\n  phone?: string;\n  linkedin?: string;\n  website?: string;\n  location?: string;\n  focus?: string;\n  notes?: string;\n  deals: string[];\n  isFavorite: boolean;\n  lastContact?: string;\n  createdAt?: string;\n};\n\nexport default function StakeholderDirectory({ role }: { role: 'CEO' | 'Employee' }) {\n  const queryClient = useQueryClient();\n  const { data: deals = [] } = useDealsListing();\n  \n  // Pagination and search state\n  const [currentPage, setCurrentPage] = useState(1);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedSearch, setDebouncedSearch] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"all\");\n  const pageSize = 50;\n  \n  // Debounce search input\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(searchQuery);\n      setCurrentPage(1); // Reset to first page on search\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n  \n  // Reset page when tab changes\n  useEffect(() => {\n    setCurrentPage(1);\n  }, [activeTab]);\n  \n  const { data: stakeholdersData, isLoading } = useStakeholders({\n    page: currentPage,\n    pageSize,\n    search: debouncedSearch || undefined,\n    type: activeTab !== 'all' ? activeTab : undefined\n  });\n  \n  // Fetch global stats for summary cards (not affected by pagination/filtering)\n  const { data: statsData } = useStakeholderStats();\n  \n  const dbStakeholders = stakeholdersData?.stakeholders || [];\n  const totalStakeholders = stakeholdersData?.total || 0;\n  \n  // Use global stats for summary cards\n  const globalTotal = statsData?.total || 0;\n  const globalTypeCounts = statsData?.typeCounts || {};\n  const globalFavoriteCount = statsData?.favoriteCount || 0;\n  const totalPages = stakeholdersData?.totalPages || 1;\n  \n  const createStakeholderMutation = useCreateStakeholder();\n  const updateStakeholderMutation = useUpdateStakeholder();\n  const deleteStakeholderMutation = useDeleteStakeholder();\n  \n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [selectedStakeholder, setSelectedStakeholder] = useState<LocalStakeholder | null>(null);\n  \n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const docScanInputRef = useRef<HTMLInputElement>(null);\n  const [importData, setImportData] = useState<Array<Record<string, string>>>([]);\n  const [selectedRows, setSelectedRows] = useState<Set<number>>(new Set());\n  const [isImporting, setIsImporting] = useState(false);\n  const [isScanning, setIsScanning] = useState(false);\n  const [isParsingFile, setIsParsingFile] = useState(false);\n  const [importColumnMap, setImportColumnMap] = useState<Record<string, string>>({\n    name: '',\n    title: '',\n    company: '',\n    type: '',\n    email: '',\n    phone: '',\n    linkedin: '',\n    website: '',\n    location: '',\n    focus: '',\n    notes: ''\n  });\n  \n  const handleDocumentScan = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n    \n    const ext = file.name.toLowerCase().split('.').pop() || '';\n    const supportedFormats = ['txt', 'csv', 'json', 'md', 'xlsx', 'xls'];\n    \n    if (!supportedFormats.includes(ext) && !file.type.includes('text') && !file.type.includes('spreadsheet')) {\n      toast.error(\"Please upload a document (TXT, CSV, JSON, MD, Excel)\");\n      if (docScanInputRef.current) docScanInputRef.current.value = '';\n      return;\n    }\n    \n    setIsScanning(true);\n    \n    try {\n      let content = '';\n      \n      if (ext === 'xlsx' || ext === 'xls') {\n        try {\n          const arrayBuffer = await file.arrayBuffer();\n          const workbook = XLSX.read(arrayBuffer, { type: 'array' });\n          const firstSheetName = workbook.SheetNames[0];\n          if (!firstSheetName) {\n            throw new Error(\"Excel file has no sheets\");\n          }\n          const worksheet = workbook.Sheets[firstSheetName];\n          content = XLSX.utils.sheet_to_csv(worksheet);\n        } catch (xlsxError) {\n          console.error(\"Error reading Excel file:\", xlsxError);\n          toast.error(\"Failed to read Excel file. Please ensure it's a valid .xlsx or .xls file.\");\n          setIsScanning(false);\n          if (docScanInputRef.current) docScanInputRef.current.value = '';\n          return;\n        }\n      } else {\n        content = await new Promise<string>((resolve, reject) => {\n          const reader = new FileReader();\n          reader.onload = (e) => resolve(e.target?.result as string);\n          reader.onerror = () => reject(new Error(\"Failed to read file\"));\n          reader.readAsText(file);\n        });\n      }\n      \n      if (!content || content.trim().length === 0) {\n        toast.error(\"Document appears to be empty\");\n        setIsScanning(false);\n        if (docScanInputRef.current) docScanInputRef.current.value = '';\n        return;\n      }\n      \n      const response = await fetch(\"/api/stakeholders/scan-document\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({\n          documentContent: content.slice(0, 150000),\n          filename: file.name,\n          autoCreate: true\n        })\n      });\n      \n      let result;\n      try {\n        result = await response.json();\n      } catch (jsonError) {\n        console.error(\"Failed to parse response:\", jsonError);\n        throw new Error(\"Server returned an invalid response. Please try again.\");\n      }\n      \n      if (!response.ok) {\n        throw new Error(result.error || \"Failed to scan document\");\n      }\n      \n      if (result.successCount > 0) {\n        toast.success(`Successfully imported ${result.successCount} of ${result.totalFound} stakeholder${result.successCount > 1 ? 's' : ''} from document`);\n        // Refresh the stakeholder list to show newly created entries\n        queryClient.invalidateQueries({ queryKey: ['stakeholders'], refetchType: 'all' });\n      } else if (result.totalFound === 0) {\n        toast.info(\"No stakeholder contacts found in the document. Make sure entries have both name and company.\");\n      } else {\n        toast.error(\"Failed to create stakeholders from document\");\n      }\n      \n      if (result.skippedCount > 0) {\n        toast.warning(`${result.skippedCount} entr${result.skippedCount > 1 ? 'ies' : 'y'} skipped (missing name or company)`);\n      }\n      \n      if (result.failedCount > 0) {\n        toast.warning(`${result.failedCount} stakeholder${result.failedCount > 1 ? 's' : ''} could not be imported due to errors`);\n      }\n    } catch (error: any) {\n      console.error('Document scan error:', error);\n      toast.error(error?.message || \"Failed to extract information from document\");\n    }\n    \n    setIsScanning(false);\n    if (docScanInputRef.current) docScanInputRef.current.value = '';\n  };\n\n  // Known sectors for extraction from long text\n  const KNOWN_SECTORS = [\n    'technology', 'tech', 'software', 'saas', 'fintech', 'biotech', 'medtech', 'edtech', 'proptech', 'insurtech', 'regtech', 'cleantech', 'agtech',\n    'healthcare', 'health', 'pharmaceuticals', 'pharma', 'medical devices', 'life sciences', 'biomedical', 'genomics', 'diagnostics',\n    'finance', 'financial services', 'banking', 'investment', 'asset management', 'private equity', 'venture capital', 'hedge fund', 'wealth management',\n    'energy', 'oil', 'gas', 'renewable', 'solar', 'wind', 'utilities', 'power', 'clean energy', 'green energy',\n    'consumer', 'retail', 'e-commerce', 'ecommerce', 'cpg', 'consumer goods', 'fmcg', 'food', 'beverage', 'apparel', 'fashion',\n    'industrial', 'manufacturing', 'aerospace', 'defense', 'automotive', 'machinery', 'chemicals', 'materials', 'logistics', 'transportation',\n    'real estate', 'property', 'reit', 'hospitality', 'hotels', 'commercial real estate', 'residential',\n    'telecommunications', 'telecom', 'media', 'entertainment', 'gaming', 'advertising', 'publishing', 'streaming',\n    'infrastructure', 'construction', 'engineering', 'mining', 'metals',\n    'agriculture', 'farming', 'agribusiness', 'food production',\n    'education', 'edtech', 'training', 'e-learning',\n    'government', 'public sector', 'non-profit', 'ngo',\n    'services', 'professional services', 'consulting', 'legal', 'accounting'\n  ];\n\n  // Extract sectors from long text by scanning for known sector terms\n  const extractSectorsFromText = (text: string): string => {\n    if (!text) return '';\n    const lowerText = text.toLowerCase();\n    const foundSectors: string[] = [];\n    \n    for (const sector of KNOWN_SECTORS) {\n      // Use word boundary matching to avoid partial matches\n      const regex = new RegExp(`\\\\b${sector.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}\\\\b`, 'i');\n      if (regex.test(lowerText) && !foundSectors.some(s => s.toLowerCase() === sector.toLowerCase())) {\n        // Capitalize first letter of each word\n        const formatted = sector.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');\n        foundSectors.push(formatted);\n      }\n    }\n    \n    return foundSectors.join(', ');\n  };\n\n  // Scan all columns in a row to find sector information\n  const extractSectorsFromRow = (row: Record<string, string>, focusColumn?: string): string => {\n    // First try the mapped focus column if available\n    if (focusColumn && row[focusColumn]) {\n      const extractedFromFocus = extractSectorsFromText(row[focusColumn]);\n      if (extractedFromFocus) return extractedFromFocus;\n    }\n    \n    // Scan ALL columns for sector-related terms\n    let allFoundSectors: string[] = [];\n    for (const [key, value] of Object.entries(row)) {\n      if (value && typeof value === 'string') {\n        const extracted = extractSectorsFromText(value);\n        if (extracted) {\n          const sectors = extracted.split(', ');\n          for (const s of sectors) {\n            if (!allFoundSectors.includes(s)) {\n              allFoundSectors.push(s);\n            }\n          }\n        }\n      }\n    }\n    \n    return allFoundSectors.join(', ');\n  };\n\n  const stakeholders: LocalStakeholder[] = useMemo(() => dbStakeholders.map(s => ({\n    id: s.id,\n    name: s.name,\n    title: s.title,\n    company: s.company,\n    type: s.type as StakeholderType,\n    email: s.email || undefined,\n    phone: s.phone || undefined,\n    linkedin: s.linkedin || undefined,\n    website: s.website || undefined,\n    location: s.location || undefined,\n    focus: s.focus || undefined,\n    notes: s.notes || undefined,\n    deals: s.deals || [],\n    isFavorite: s.isFavorite || false,\n    lastContact: s.lastContact || undefined,\n    createdAt: s.createdAt?.toString()\n  })), [dbStakeholders]);\n\n  const [newStakeholder, setNewStakeholder] = useState({\n    name: \"\",\n    title: \"\",\n    company: \"\",\n    type: \"investor\" as StakeholderType,\n    email: \"\",\n    phone: \"\",\n    linkedin: \"\",\n    website: \"\",\n    location: \"\",\n    focus: \"\",\n    notes: \"\"\n  });\n\n  const typeColors: Record<string, string> = {\n    investor: \"bg-green-500\",\n    advisor: \"bg-blue-500\",\n    legal: \"bg-purple-500\",\n    banker: \"bg-yellow-500\",\n    consultant: \"bg-orange-500\",\n    client: \"bg-red-500\",\n    other: \"bg-gray-500\"\n  };\n\n  // Server-side filtering is now applied via API params\n  // Local filtering only for favorites tab (client-side state)\n  const filteredStakeholders = activeTab === \"favorites\" \n    ? stakeholders.filter(s => s.isFavorite)\n    : stakeholders;\n\n  const handleCreateStakeholder = async () => {\n    if (!newStakeholder.name || !newStakeholder.company) {\n      toast.error(\"Please fill in required fields\");\n      return;\n    }\n\n    try {\n      await createStakeholderMutation.mutateAsync({\n        name: newStakeholder.name,\n        title: newStakeholder.title,\n        company: newStakeholder.company,\n        type: newStakeholder.type,\n        email: newStakeholder.email || undefined,\n        phone: newStakeholder.phone || undefined,\n        linkedin: newStakeholder.linkedin || undefined,\n        website: newStakeholder.website || undefined,\n        location: newStakeholder.location || undefined,\n        focus: newStakeholder.focus || undefined,\n        notes: newStakeholder.notes || undefined,\n        deals: [],\n        isFavorite: false\n      });\n\n      setShowCreateModal(false);\n      setNewStakeholder({\n        name: \"\", title: \"\", company: \"\", type: \"investor\",\n        email: \"\", phone: \"\", linkedin: \"\", website: \"\", location: \"\", focus: \"\", notes: \"\"\n      });\n      toast.success(\"Stakeholder added to directory\");\n    } catch (error) {\n      toast.error(\"Failed to add stakeholder\");\n    }\n  };\n\n  const toggleFavorite = async (id: string) => {\n    if (id.startsWith('inv-')) return;\n    \n    const stakeholder = stakeholders.find(s => s.id === id);\n    if (!stakeholder) return;\n    \n    try {\n      await updateStakeholderMutation.mutateAsync({\n        id,\n        updates: { isFavorite: !stakeholder.isFavorite }\n      });\n    } catch (error) {\n      toast.error(\"Failed to update favorite\");\n    }\n  };\n\n  const deleteStakeholder = async (id: string) => {\n    if (id.startsWith('inv-')) return;\n    \n    try {\n      await deleteStakeholderMutation.mutateAsync(id);\n      toast.success(\"Stakeholder removed\");\n    } catch (error) {\n      toast.error(\"Failed to remove stakeholder\");\n    }\n  };\n\n  const getTypeCounts = () => {\n    const counts: Record<string, number> = {};\n    stakeholders.forEach(s => {\n      counts[s.type] = (counts[s.type] || 0) + 1;\n    });\n    return counts;\n  };\n\n  const typeCounts = getTypeCounts();\n  \n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n    \n    const ext = file.name.toLowerCase().split('.').pop() || '';\n    const validExtensions = ['xlsx', 'xls', 'csv', 'tsv', 'txt'];\n    \n    if (!validExtensions.includes(ext)) {\n      toast.error(\"Please use a CSV, Excel (.xlsx, .xls), or text file.\");\n      if (fileInputRef.current) fileInputRef.current.value = '';\n      return;\n    }\n    \n    // Show loading indicator\n    setIsParsingFile(true);\n    toast.info(\"Uploading and processing file... This may take a moment for large files.\");\n    \n    try {\n      // Upload file to server for parsing (avoids UI freeze)\n      const formData = new FormData();\n      formData.append('file', file);\n      \n      const response = await fetch('/api/stakeholders/parse-file', {\n        method: 'POST',\n        credentials: 'include',\n        body: formData\n      });\n      \n      const result = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to parse file');\n      }\n      \n      const { headers, rows } = result;\n      \n      if (rows.length === 0) {\n        setIsParsingFile(false);\n        toast.error(\"No valid data found in file\");\n        return;\n      }\n      \n      setImportData(rows);\n      setSelectedRows(new Set(rows.map((_: any, i: number) => i)));\n      \n      // Create fresh autoMap (don't use stale state)\n      const autoMap: Record<string, string> = {\n        name: '',\n        title: '',\n        company: '',\n        type: '',\n        email: '',\n        phone: '',\n        linkedin: '',\n        website: '',\n        location: '',\n        focus: '',\n        notes: ''\n      };\n      const lowerHeaders = headers.map((h: string) => h.toLowerCase().trim());\n      \n      console.log('Auto-mapping - headers:', headers);\n      console.log('Auto-mapping - lowerHeaders:', lowerHeaders);\n      \n      // Extended mappings to catch more header variations\n      const fieldMappings: Record<string, string[]> = {\n        name: ['name', 'full name', 'contact name', 'stakeholder', 'person', 'contact', 'investor name', 'fund manager', 'manager', 'first name', 'firstname', 'last name', 'lastname', 'investor', 'principal'],\n        title: ['title', 'job title', 'position', 'role', 'designation', 'job'],\n        company: ['company', 'organization', 'firm', 'employer', 'org', 'fund', 'fund name', 'institution', 'entity', 'business', 'investor', 'lp', 'gp', 'group', 'family office', 'endowment', 'pension', 'foundation'],\n        type: ['type', 'category', 'stakeholder type', 'investor type', 'classification', 'class'],\n        email: ['email', 'e-mail', 'email address', 'mail', 'contact email', 'work email', 'primary email'],\n        phone: ['phone', 'telephone', 'mobile', 'cell', 'phone number', 'tel', 'contact number', 'work phone', 'direct'],\n        linkedin: ['linkedin', 'linked in', 'linkedin url', 'li', 'linkedin profile', 'social'],\n        website: ['website', 'web', 'url', 'site', 'homepage', 'domain', 'company website', 'fund website'],\n        location: ['location', 'city', 'address', 'region', 'country', 'state', 'hq', 'headquarters', 'geography', 'geo', 'based in', 'office'],\n        focus: ['focus', 'sector', 'sector focus', 'sectors', 'industry', 'industries', 'investment focus', 'specialization', 'expertise', 'vertical', 'verticals', 'strategy', 'investment strategy', 'mandate', 'target sectors', 'preferred sectors', 'investment thesis', 'asset class'],\n        notes: ['notes', 'comments', 'description', 'remarks', 'additional info', 'other', 'memo', 'details']\n      };\n      \n      // First pass: exact matches only (highest priority)\n      const usedHeaders = new Set<string>();\n      Object.entries(fieldMappings).forEach(([field, aliases]) => {\n        const match = headers.find((h: string, i: number) => {\n          const lowerH = lowerHeaders[i];\n          if (usedHeaders.has(h)) return false;\n          return aliases.includes(lowerH);\n        });\n        if (match) {\n          autoMap[field] = match;\n          usedHeaders.add(match);\n          console.log(`Auto-mapped (exact) ${field} -> \"${match}\"`);\n        }\n      });\n      \n      // Second pass: header contains alias (e.g., \"LinkedIn URL\" contains \"linkedin\")\n      Object.entries(fieldMappings).forEach(([field, aliases]) => {\n        if (autoMap[field]) return; // Already mapped\n        const match = headers.find((h: string, i: number) => {\n          const lowerH = lowerHeaders[i];\n          if (usedHeaders.has(h)) return false;\n          return aliases.some(alias => lowerH.includes(alias));\n        });\n        if (match) {\n          autoMap[field] = match;\n          usedHeaders.add(match);\n          console.log(`Auto-mapped (partial) ${field} -> \"${match}\"`);\n        }\n      });\n      \n      console.log('Final autoMap:', autoMap);\n      setImportColumnMap(autoMap);\n      setIsParsingFile(false);\n      setShowImportModal(true);\n      toast.success(`Loaded ${rows.length} rows from file. Review the column mapping and click Import.`);\n    } catch (error: any) {\n      setIsParsingFile(false);\n      console.error('File upload/parse error:', error);\n      toast.error(error.message || \"Failed to process file\");\n    }\n    \n    if (fileInputRef.current) fileInputRef.current.value = '';\n  };\n  \n  const toggleRowSelection = (index: number) => {\n    const newSelected = new Set(selectedRows);\n    if (newSelected.has(index)) {\n      newSelected.delete(index);\n    } else {\n      newSelected.add(index);\n    }\n    setSelectedRows(newSelected);\n  };\n  \n  const toggleAllRows = () => {\n    if (selectedRows.size === importData.length) {\n      setSelectedRows(new Set());\n    } else {\n      setSelectedRows(new Set(importData.map((_, i) => i)));\n    }\n  };\n  \n  const handleImportSubmit = async () => {\n    if (!importColumnMap.name || !importColumnMap.company) {\n      toast.error(\"Please map Name and Company columns\");\n      return;\n    }\n    \n    if (selectedRows.size === 0) {\n      toast.error(\"Please select at least one row to import\");\n      return;\n    }\n    \n    setIsImporting(true);\n    \n    // Build array of stakeholders for bulk import\n    const validTypes: StakeholderType[] = ['investor', 'advisor', 'legal', 'banker', 'consultant', 'client', 'other'];\n    \n    // Debug: log mapping and sample data\n    console.log('Column mapping:', importColumnMap);\n    console.log('Sample row keys:', importData[0] ? Object.keys(importData[0]) : []);\n    console.log('Sample row:', importData[0]);\n    console.log('Selected rows count:', selectedRows.size);\n    \n    const stakeholdersToImport = Array.from(selectedRows).map(index => {\n      const row = importData[index];\n      if (!row) return null;\n      \n      const typeValue = row[importColumnMap.type]?.toLowerCase() || 'other';\n      const type = validTypes.includes(typeValue as StakeholderType) ? typeValue as StakeholderType : 'other';\n      const focusValue = extractSectorsFromRow(row, importColumnMap.focus);\n      \n      const nameValue = row[importColumnMap.name] || '';\n      const companyValue = row[importColumnMap.company] || '';\n      \n      // Use company as name if name is empty (common for investor databases)\n      const effectiveName = nameValue || companyValue;\n      const effectiveCompany = companyValue || nameValue;\n      \n      return {\n        name: effectiveName,\n        title: row[importColumnMap.title] || '',\n        company: effectiveCompany,\n        type,\n        email: row[importColumnMap.email] || null,\n        phone: row[importColumnMap.phone] || null,\n        linkedin: row[importColumnMap.linkedin] || null,\n        website: row[importColumnMap.website] || null,\n        location: row[importColumnMap.location] || null,\n        focus: focusValue || null,\n        notes: row[importColumnMap.notes] || null,\n      };\n    }).filter(s => s !== null && s.name && s.company);\n    \n    console.log('Stakeholders to import count:', stakeholdersToImport.length);\n    \n    // Check if all rows were filtered out\n    if (stakeholdersToImport.length === 0) {\n      setIsImporting(false);\n      // Debug info for user\n      const sampleRow = importData[Array.from(selectedRows)[0]];\n      const mappedName = importColumnMap.name ? sampleRow?.[importColumnMap.name] : undefined;\n      const mappedCompany = importColumnMap.company ? sampleRow?.[importColumnMap.company] : undefined;\n      console.log('Debug - Name column mapped to:', importColumnMap.name, '-> value:', mappedName);\n      console.log('Debug - Company column mapped to:', importColumnMap.company, '-> value:', mappedCompany);\n      console.log('Debug - Row keys:', sampleRow ? Object.keys(sampleRow) : []);\n      \n      if (!mappedName && !mappedCompany) {\n        toast.error(`Column mapping issue: The mapped columns don't match the file headers. Please check your column selections.`);\n      } else if (!mappedName) {\n        toast.error(`No valid Name values found in the selected Name column \"${importColumnMap.name}\"`);\n      } else if (!mappedCompany) {\n        toast.error(`No valid Company values found in the selected Company column \"${importColumnMap.company}\"`);\n      } else {\n        toast.error(\"All rows are missing required Name or Company values\");\n      }\n      return;\n    }\n    \n    try {\n      const response = await fetch('/api/stakeholders/bulk-import', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({ stakeholders: stakeholdersToImport })\n      });\n      \n      const result = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to import');\n      }\n      \n      setIsImporting(false);\n      setShowImportModal(false);\n      setImportData([]);\n      setSelectedRows(new Set());\n      \n      // Refresh the stakeholder list\n      queryClient.invalidateQueries({ queryKey: ['stakeholders'], refetchType: 'all' });\n      \n      if (result.successCount > 0) {\n        toast.success(`Successfully imported ${result.successCount} stakeholder${result.successCount > 1 ? 's' : ''}`);\n      }\n      if (result.errorCount > 0) {\n        toast.warning(`${result.errorCount} row${result.errorCount > 1 ? 's' : ''} could not be imported (missing name or company)`);\n      }\n    } catch (error: any) {\n      setIsImporting(false);\n      toast.error(error.message || \"Failed to import stakeholders\");\n    }\n  };\n  \n  const importHeaders = importData.length > 0 ? Object.keys(importData[0]) : [];\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-display font-bold\">External Stakeholder Directory</h1>\n            <p className=\"text-muted-foreground\">Manage contacts for investors, advisors, legal counsel, and more</p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <input\n              type=\"file\"\n              ref={fileInputRef}\n              accept=\".csv,.xlsx,.xls,.txt,.tsv\"\n              onChange={handleFileUpload}\n              className=\"hidden\"\n              data-testid=\"input-file-upload\"\n            />\n            <input\n              type=\"file\"\n              ref={docScanInputRef}\n              accept=\".txt,.csv,.json,.md,.xlsx,.xls\"\n              onChange={handleDocumentScan}\n              className=\"hidden\"\n              data-testid=\"input-doc-scan\"\n            />\n            <Button\n              variant=\"outline\"\n              onClick={() => fileInputRef.current?.click()}\n              disabled={isParsingFile}\n              data-testid=\"button-import\"\n            >\n              {isParsingFile ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Processing...\n                </>\n              ) : (\n                <>\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Import\n                </>\n              )}\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={() => docScanInputRef.current?.click()}\n              disabled={isScanning}\n              data-testid=\"button-scan-document\"\n            >\n              {isScanning ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Scanning...\n                </>\n              ) : (\n                <>\n                  <Sparkles className=\"w-4 h-4 mr-2\" />\n                  AI Import\n                </>\n              )}\n            </Button>\n            <Button onClick={() => setShowCreateModal(true)} data-testid=\"button-add-stakeholder\">\n              <Plus className=\"w-4 h-4 mr-2\" /> Add Stakeholder\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-6 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <Users className=\"w-5 h-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{globalTotal}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          {Object.entries(typeColors).slice(0, 5).map(([type, color]) => (\n            <Card key={type}>\n              <CardContent className=\"pt-6\">\n                <div className=\"flex items-center gap-3\">\n                  <div className={cn(\"p-2 rounded-lg\", color.replace(\"bg-\", \"bg-\") + \"/10\")}>\n                    <Building className={cn(\"w-5 h-5\", color.replace(\"bg-\", \"text-\"))} />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{globalTypeCounts[type] || 0}</p>\n                    <p className=\"text-xs text-muted-foreground capitalize\">{type}s</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Directory</CardTitle>\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search stakeholders...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-stakeholders\"\n                />\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\n              <TabsList className=\"flex-wrap h-auto gap-1\">\n                <TabsTrigger value=\"all\">All ({globalTotal})</TabsTrigger>\n                <TabsTrigger value=\"favorites\">\n                  <Star className=\"w-3 h-3 mr-1\" /> Favorites ({globalFavoriteCount})\n                </TabsTrigger>\n                <TabsTrigger value=\"investor\">Investors</TabsTrigger>\n                <TabsTrigger value=\"legal\">Legal</TabsTrigger>\n                <TabsTrigger value=\"banker\">Bankers</TabsTrigger>\n                <TabsTrigger value=\"advisor\">Advisors</TabsTrigger>\n                <TabsTrigger value=\"client\">Clients</TabsTrigger>\n              </TabsList>\n              <TabsContent value={activeTab} className=\"mt-4\">\n                <ScrollArea className=\"h-[450px]\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    {filteredStakeholders.map((stakeholder) => (\n                      <Card key={stakeholder.id} className=\"hover:border-primary/50 transition-colors\" data-testid={`stakeholder-${stakeholder.id}`}>\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div className=\"flex items-center gap-3\">\n                              <Avatar className=\"h-12 w-12\">\n                                <AvatarFallback className={cn(\"text-white\", typeColors[stakeholder.type])}>\n                                  {stakeholder.name.split(' ').map(n => n[0]).join('')}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div>\n                                <div className=\"flex items-center gap-2\">\n                                  <h3 className=\"font-medium\">{stakeholder.name}</h3>\n                                  <button onClick={() => toggleFavorite(stakeholder.id)} className=\"hover:opacity-80\">\n                                    {stakeholder.isFavorite ? (\n                                      <Star className=\"w-4 h-4 text-yellow-500 fill-yellow-500\" />\n                                    ) : (\n                                      <StarOff className=\"w-4 h-4 text-muted-foreground\" />\n                                    )}\n                                  </button>\n                                </div>\n                                <p className=\"text-sm text-muted-foreground\">{stakeholder.title}</p>\n                                <div className=\"flex items-center gap-2 mt-1\">\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    <Building className=\"w-3 h-3 mr-1\" /> {stakeholder.company}\n                                  </Badge>\n                                  <Badge className={cn(\"text-white text-xs\", typeColors[stakeholder.type])}>\n                                    {stakeholder.type}\n                                  </Badge>\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n\n                          <div className=\"space-y-1 text-sm mb-3\">\n                            {stakeholder.email && (\n                              <a href={`mailto:${stakeholder.email}`} className=\"flex items-center gap-2 text-muted-foreground hover:text-primary\">\n                                <Mail className=\"w-3 h-3\" /> {stakeholder.email}\n                              </a>\n                            )}\n                            {stakeholder.phone && (\n                              <a href={`tel:${stakeholder.phone}`} className=\"flex items-center gap-2 text-muted-foreground hover:text-primary\">\n                                <Phone className=\"w-3 h-3\" /> {stakeholder.phone}\n                              </a>\n                            )}\n                            {stakeholder.location && (\n                              <p className=\"flex items-center gap-2 text-muted-foreground\">\n                                <MapPin className=\"w-3 h-3\" /> {stakeholder.location}\n                              </p>\n                            )}\n                          </div>\n\n                          {stakeholder.focus && (\n                            <div className=\"flex flex-wrap gap-1 mb-3\">\n                              <span className=\"text-xs text-muted-foreground font-medium mr-1\">Sectors:</span>\n                              {stakeholder.focus.split(',').map((sector, idx) => (\n                                <Badge key={idx} variant=\"secondary\" className=\"text-[10px] bg-primary/10 text-primary\">\n                                  {sector.trim()}\n                                </Badge>\n                              ))}\n                            </div>\n                          )}\n\n                          {stakeholder.notes && (\n                            <p className=\"text-xs text-muted-foreground p-2 bg-secondary/30 rounded mb-3 line-clamp-2\">\n                              {stakeholder.notes}\n                            </p>\n                          )}\n\n                          {stakeholder.deals.length > 0 && (\n                            <div className=\"flex flex-wrap gap-1 mb-3\">\n                              {stakeholder.deals.map(dealId => {\n                                const deal = deals.find(d => d.id === dealId);\n                                return deal ? (\n                                  <Badge key={dealId} variant=\"outline\" className=\"text-[10px]\">\n                                    <Briefcase className=\"w-2 h-2 mr-1\" /> {deal.name}\n                                  </Badge>\n                                ) : null;\n                              })}\n                            </div>\n                          )}\n\n                          <div className=\"flex items-center justify-between pt-3 border-t\">\n                            <div className=\"flex gap-1\">\n                              {stakeholder.linkedin && (\n                                <Button variant=\"ghost\" size=\"sm\" asChild>\n                                  <a href={stakeholder.linkedin} target=\"_blank\" rel=\"noopener noreferrer\">\n                                    <Linkedin className=\"w-3 h-3\" />\n                                  </a>\n                                </Button>\n                              )}\n                              {stakeholder.website && (\n                                <Button variant=\"ghost\" size=\"sm\" asChild>\n                                  <a href={stakeholder.website} target=\"_blank\" rel=\"noopener noreferrer\">\n                                    <Globe className=\"w-3 h-3\" />\n                                  </a>\n                                </Button>\n                              )}\n                            </div>\n                            <div className=\"flex gap-1\">\n                              <Button variant=\"ghost\" size=\"sm\" onClick={() => { setSelectedStakeholder(stakeholder); setShowEditModal(true); }}>\n                                <Pencil className=\"w-3 h-3\" />\n                              </Button>\n                              <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                  <Button variant=\"ghost\" size=\"sm\" className=\"text-destructive\">\n                                    <Trash2 className=\"w-3 h-3\" />\n                                  </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                  <AlertDialogHeader>\n                                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                      This action cannot be undone. This will permanently remove {stakeholder.name} from {stakeholder.company} from the directory.\n                                    </AlertDialogDescription>\n                                  </AlertDialogHeader>\n                                  <AlertDialogFooter>\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                    <AlertDialogAction onClick={() => deleteStakeholder(stakeholder.id)}>\n                                      Remove Stakeholder\n                                    </AlertDialogAction>\n                                  </AlertDialogFooter>\n                                </AlertDialogContent>\n                              </AlertDialog>\n                            </div>\n                          </div>\n\n                          {stakeholder.lastContact && (\n                            <p className=\"text-[10px] text-muted-foreground mt-2 flex items-center gap-1\">\n                              <Calendar className=\"w-3 h-3\" /> Last contact: {format(new Date(stakeholder.lastContact), 'MMM d, yyyy')}\n                            </p>\n                          )}\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                  {filteredStakeholders.length === 0 && (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      {isLoading ? \"Loading...\" : \"No stakeholders found\"}\n                    </div>\n                  )}\n                </ScrollArea>\n                \n                {/* Pagination Controls */}\n                {totalPages > 1 && (\n                  <div className=\"flex items-center justify-between mt-4 pt-4 border-t\">\n                    <div className=\"text-sm text-muted-foreground\">\n                      Showing {((currentPage - 1) * pageSize) + 1} - {Math.min(currentPage * pageSize, totalStakeholders)} of {totalStakeholders}\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(1)}\n                        disabled={currentPage === 1 || isLoading}\n                      >\n                        First\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\n                        disabled={currentPage === 1 || isLoading}\n                      >\n                        Previous\n                      </Button>\n                      <span className=\"text-sm px-2\">\n                        Page {currentPage} of {totalPages}\n                      </span>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\n                        disabled={currentPage === totalPages || isLoading}\n                      >\n                        Next\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(totalPages)}\n                        disabled={currentPage === totalPages || isLoading}\n                      >\n                        Last\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Edit Modal */}\n      <Dialog open={showEditModal} onOpenChange={setShowEditModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Edit Stakeholder</DialogTitle>\n          </DialogHeader>\n          <ScrollArea className=\"max-h-[60vh]\">\n            <div className=\"space-y-4 pr-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Name *</Label>\n                  <Input\n                    value={selectedStakeholder?.name || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, name: e.target.value } : null)}\n                    placeholder=\"Full name\"\n                    data-testid=\"input-edit-stakeholder-name\"\n                  />\n                </div>\n                <div>\n                  <Label>Title</Label>\n                  <Input\n                    value={selectedStakeholder?.title || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, title: e.target.value } : null)}\n                    placeholder=\"Job title\"\n                    data-testid=\"input-edit-stakeholder-title\"\n                  />\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Company *</Label>\n                  <Input\n                    value={selectedStakeholder?.company || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, company: e.target.value } : null)}\n                    placeholder=\"Company name\"\n                    data-testid=\"input-edit-stakeholder-company\"\n                  />\n                </div>\n                <div>\n                  <Label>Type</Label>\n                  <Select value={selectedStakeholder?.type || 'investor'} onValueChange={(v: any) => setSelectedStakeholder(prev => prev ? { ...prev, type: v } : null)}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"investor\">Investor</SelectItem>\n                      <SelectItem value=\"advisor\">Advisor</SelectItem>\n                      <SelectItem value=\"legal\">Legal Counsel</SelectItem>\n                      <SelectItem value=\"banker\">Banker</SelectItem>\n                      <SelectItem value=\"consultant\">Consultant</SelectItem>\n                      <SelectItem value=\"client\">Client</SelectItem>\n                      <SelectItem value=\"other\">Other</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Email</Label>\n                  <Input\n                    type=\"email\"\n                    value={selectedStakeholder?.email || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, email: e.target.value } : null)}\n                    placeholder=\"email@example.com\"\n                    data-testid=\"input-edit-stakeholder-email\"\n                  />\n                </div>\n                <div>\n                  <Label>Phone</Label>\n                  <Input\n                    value={selectedStakeholder?.phone || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, phone: e.target.value } : null)}\n                    placeholder=\"+1 555-000-0000\"\n                    data-testid=\"input-edit-stakeholder-phone\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label>Location</Label>\n                <Input\n                  value={selectedStakeholder?.location || ''}\n                  onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, location: e.target.value } : null)}\n                  placeholder=\"City, State\"\n                  data-testid=\"input-edit-stakeholder-location\"\n                />\n              </div>\n              {selectedStakeholder?.type === 'investor' && (\n                <div>\n                  <Label>Sector Focus</Label>\n                  <Input\n                    value={selectedStakeholder?.focus || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, focus: e.target.value } : null)}\n                    placeholder=\"e.g. Technology, Healthcare, Consumer\"\n                    data-testid=\"input-edit-stakeholder-focus\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">Used for matching investors to deals by sector</p>\n                </div>\n              )}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>LinkedIn URL</Label>\n                  <Input\n                    value={selectedStakeholder?.linkedin || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, linkedin: e.target.value } : null)}\n                    placeholder=\"https://linkedin.com/in/...\"\n                  />\n                </div>\n                <div>\n                  <Label>Website</Label>\n                  <Input\n                    value={selectedStakeholder?.website || ''}\n                    onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, website: e.target.value } : null)}\n                    placeholder=\"https://...\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label>Notes</Label>\n                <Textarea\n                  value={selectedStakeholder?.notes || ''}\n                  onChange={(e) => setSelectedStakeholder(prev => prev ? { ...prev, notes: e.target.value } : null)}\n                  placeholder=\"Additional notes about this contact...\"\n                  rows={3}\n                  data-testid=\"input-edit-stakeholder-notes\"\n                />\n              </div>\n            </div>\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditModal(false)}>Cancel</Button>\n            <Button onClick={async () => {\n              if (selectedStakeholder) {\n                try {\n                  await updateStakeholderMutation.mutateAsync({\n                    id: selectedStakeholder.id,\n                    updates: {\n                      name: selectedStakeholder.name,\n                      title: selectedStakeholder.title,\n                      company: selectedStakeholder.company,\n                      type: selectedStakeholder.type,\n                      email: selectedStakeholder.email || null,\n                      phone: selectedStakeholder.phone || null,\n                      linkedin: selectedStakeholder.linkedin || null,\n                      website: selectedStakeholder.website || null,\n                      location: selectedStakeholder.location || null,\n                      focus: selectedStakeholder.focus || null,\n                      notes: selectedStakeholder.notes || null,\n                    }\n                  });\n                  toast.success(\"Stakeholder updated\");\n                  setShowEditModal(false);\n                } catch (error) {\n                  toast.error(\"Failed to update stakeholder\");\n                }\n              }\n            }} data-testid=\"button-save-stakeholder\">Save Changes</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Modal */}\n      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Add Stakeholder</DialogTitle>\n            <DialogDescription>\n              Enter stakeholder details manually.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <ScrollArea className=\"max-h-[50vh]\">\n            <div className=\"space-y-4 pr-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Name *</Label>\n                  <Input\n                    value={newStakeholder.name}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, name: e.target.value })}\n                    placeholder=\"Full name\"\n                    data-testid=\"input-stakeholder-name\"\n                  />\n                </div>\n                <div>\n                  <Label>Title</Label>\n                  <Input\n                    value={newStakeholder.title}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, title: e.target.value })}\n                    placeholder=\"Job title\"\n                    data-testid=\"input-stakeholder-title\"\n                  />\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Company *</Label>\n                  <Input\n                    value={newStakeholder.company}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, company: e.target.value })}\n                    placeholder=\"Company name\"\n                    data-testid=\"input-stakeholder-company\"\n                  />\n                </div>\n                <div>\n                  <Label>Type</Label>\n                  <Select value={newStakeholder.type} onValueChange={(v: any) => setNewStakeholder({ ...newStakeholder, type: v })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"investor\">Investor</SelectItem>\n                      <SelectItem value=\"advisor\">Advisor</SelectItem>\n                      <SelectItem value=\"legal\">Legal Counsel</SelectItem>\n                      <SelectItem value=\"banker\">Banker</SelectItem>\n                      <SelectItem value=\"consultant\">Consultant</SelectItem>\n                      <SelectItem value=\"client\">Client</SelectItem>\n                      <SelectItem value=\"other\">Other</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>Email</Label>\n                  <Input\n                    type=\"email\"\n                    value={newStakeholder.email}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, email: e.target.value })}\n                    placeholder=\"email@example.com\"\n                    data-testid=\"input-stakeholder-email\"\n                  />\n                </div>\n                <div>\n                  <Label>Phone</Label>\n                  <Input\n                    value={newStakeholder.phone}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, phone: e.target.value })}\n                    placeholder=\"+1 555-000-0000\"\n                    data-testid=\"input-stakeholder-phone\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label>Location</Label>\n                <Input\n                  value={newStakeholder.location}\n                  onChange={(e) => setNewStakeholder({ ...newStakeholder, location: e.target.value })}\n                  placeholder=\"City, State\"\n                  data-testid=\"input-stakeholder-location\"\n                />\n              </div>\n              {newStakeholder.type === 'investor' && (\n                <div>\n                  <Label>Sector Focus</Label>\n                  <Input\n                    value={newStakeholder.focus}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, focus: e.target.value })}\n                    placeholder=\"e.g. Technology, Healthcare, Consumer\"\n                    data-testid=\"input-stakeholder-focus\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">Used for matching investors to deals by sector</p>\n                </div>\n              )}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>LinkedIn URL</Label>\n                  <Input\n                    value={newStakeholder.linkedin}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, linkedin: e.target.value })}\n                    placeholder=\"https://linkedin.com/in/...\"\n                  />\n                </div>\n                <div>\n                  <Label>Website</Label>\n                  <Input\n                    value={newStakeholder.website}\n                    onChange={(e) => setNewStakeholder({ ...newStakeholder, website: e.target.value })}\n                    placeholder=\"https://...\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label>Notes</Label>\n                <Textarea\n                  value={newStakeholder.notes}\n                  onChange={(e) => setNewStakeholder({ ...newStakeholder, notes: e.target.value })}\n                  placeholder=\"Additional notes about this contact...\"\n                  rows={3}\n                  data-testid=\"input-stakeholder-notes\"\n                />\n              </div>\n            </div>\n          </ScrollArea>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateStakeholder} data-testid=\"button-submit-stakeholder\">Add Stakeholder</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Import Modal */}\n      <Dialog open={showImportModal} onOpenChange={setShowImportModal}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] bg-card border-border overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileSpreadsheet className=\"w-5 h-5\" />\n              Import Stakeholders\n            </DialogTitle>\n            <DialogDescription>\n              Map your CSV columns to stakeholder fields and select rows to import\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-6 gap-2 p-3 bg-secondary/30 rounded-lg\">\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Name *</Label>\n                <Select value={importColumnMap.name} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, name: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Title</Label>\n                <Select value={importColumnMap.title} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, title: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Company *</Label>\n                <Select value={importColumnMap.company} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, company: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Type</Label>\n                <Select value={importColumnMap.type} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, type: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Email</Label>\n                <Select value={importColumnMap.email} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, email: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Phone</Label>\n                <Select value={importColumnMap.phone} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, phone: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"grid grid-cols-5 gap-2 p-3 bg-secondary/30 rounded-lg\">\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Location</Label>\n                <Select value={importColumnMap.location} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, location: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs text-amber-500 font-medium\">Sector Focus</Label>\n                <Select value={importColumnMap.focus} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, focus: v })}>\n                  <SelectTrigger className=\"h-8 text-xs border-amber-500/50\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Website</Label>\n                <Select value={importColumnMap.website} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, website: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">LinkedIn</Label>\n                <Select value={importColumnMap.linkedin} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, linkedin: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-1\">\n                <Label className=\"text-xs\">Notes</Label>\n                <Select value={importColumnMap.notes} onValueChange={(v) => setImportColumnMap({ ...importColumnMap, notes: v })}>\n                  <SelectTrigger className=\"h-8 text-xs\">\n                    <SelectValue placeholder=\"Select column\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {importHeaders.map(h => (\n                      <SelectItem key={h} value={h}>{h}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">\n                {selectedRows.size} of {importData.length} rows selected\n              </span>\n              <Button variant=\"ghost\" size=\"sm\" onClick={toggleAllRows}>\n                {selectedRows.size === importData.length ? 'Deselect All' : 'Select All'}\n              </Button>\n            </div>\n\n            <ScrollArea className=\"h-[300px] border border-border rounded-lg\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-10\">\n                      <Checkbox \n                        checked={selectedRows.size === importData.length && importData.length > 0}\n                        onCheckedChange={toggleAllRows}\n                      />\n                    </TableHead>\n                    {importHeaders.slice(0, 5).map(h => (\n                      <TableHead key={h} className=\"text-xs\">{h}</TableHead>\n                    ))}\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {importData.slice(0, 100).map((row, index) => (\n                    <TableRow \n                      key={index}\n                      className={cn(!selectedRows.has(index) && \"opacity-50\")}\n                    >\n                      <TableCell>\n                        <Checkbox \n                          checked={selectedRows.has(index)}\n                          onCheckedChange={() => toggleRowSelection(index)}\n                        />\n                      </TableCell>\n                      {importHeaders.slice(0, 5).map(h => (\n                        <TableCell key={h} className=\"text-xs truncate max-w-[150px]\">\n                          {row[h] || '-'}\n                        </TableCell>\n                      ))}\n                    </TableRow>\n                  ))}\n                  {importData.length > 100 && (\n                    <TableRow>\n                      <TableCell colSpan={6} className=\"text-center text-xs text-muted-foreground py-4\">\n                        ... and {importData.length - 100} more rows (all {importData.length} rows will be imported)\n                      </TableCell>\n                    </TableRow>\n                  )}\n                </TableBody>\n              </Table>\n            </ScrollArea>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowImportModal(false)}>Cancel</Button>\n            <Button onClick={handleImportSubmit} disabled={isImporting}>\n              {isImporting ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Importing...\n                </>\n              ) : (\n                <>\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Import {selectedRows.size} Stakeholders\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":67004,"size_tokens":null},"client/src/pages/shared/EventCalendar.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Calendar,\n  ChevronLeft,\n  ChevronRight,\n  Plus,\n  Clock,\n  MapPin,\n  Briefcase,\n  Trash2,\n  Video,\n  CalendarOff,\n  Check,\n  X,\n  User,\n  ChevronsUpDown\n} from \"lucide-react\";\nimport { useCurrentUser, useMeetings, useDealsListing, useUsers, useCreateMeeting, useDeleteMeeting, useTimeOffRequests, useCreateTimeOffRequest, useUpdateTimeOffRequest, useGoogleCalendarStatus, useGoogleCalendarEvents, useCreateGoogleCalendarEvent, useConnectGoogleCalendar, useDisconnectGoogleCalendar, useSyncGoogleCalendar, type GoogleCalendarEvent } from \"@/lib/api\";\nimport { cn } from \"@/lib/utils\";\nimport { format, startOfMonth, endOfMonth, startOfWeek, endOfWeek, addDays, isSameMonth, isSameDay, addMonths, subMonths, isToday, parseISO, isWithinInterval, addHours } from \"date-fns\";\nimport { toast } from \"sonner\";\nimport type { Meeting, TimeOffRequest } from \"@shared/schema\";\nimport { ExternalLink, RefreshCw } from \"lucide-react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\n\ntype EventCalendarProps = {\n  role: 'CEO' | 'Employee';\n};\n\nexport default function EventCalendar({ role }: EventCalendarProps) {\n  const queryClient = useQueryClient();\n  const { data: currentUser } = useCurrentUser();\n  const { data: meetings = [] } = useMeetings();\n  const { data: deals = [] } = useDealsListing();\n  const { data: users = [] } = useUsers();\n  const { data: timeOffRequests = [] } = useTimeOffRequests();\n  const { data: googleCalendarStatus } = useGoogleCalendarStatus();\n  const { data: googleEvents = [], isLoading: isLoadingGoogleEvents, refetch: refetchGoogleEvents } = useGoogleCalendarEvents();\n  const createMeetingMutation = useCreateMeeting();\n  const deleteMeetingMutation = useDeleteMeeting();\n  const createTimeOffMutation = useCreateTimeOffRequest();\n  const updateTimeOffMutation = useUpdateTimeOffRequest();\n  const createGoogleEventMutation = useCreateGoogleCalendarEvent();\n  const connectGoogleCalendar = useConnectGoogleCalendar();\n  const disconnectGoogleCalendar = useDisconnectGoogleCalendar();\n  const syncGoogleCalendar = useSyncGoogleCalendar();\n  const [, setLocation] = useLocation();\n\n  // Handle OAuth callback query parameters\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const connected = urlParams.get('connected');\n    const error = urlParams.get('error');\n    \n    if (connected === 'true') {\n      toast.success(\"Google Calendar connected successfully!\");\n      // Remove query params from URL\n      window.history.replaceState({}, '', window.location.pathname);\n      // Refresh status and events\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"google-calendar-events\"] });\n    } else if (error) {\n      const errorMessages: Record<string, string> = {\n        'oauth_denied': 'Google Calendar authorization was denied',\n        'invalid_callback': 'Invalid authorization callback',\n        'invalid_state': 'Security validation failed. Please try again.',\n        'connection_failed': 'Failed to connect Google Calendar',\n        'not_authenticated': 'Please log in to connect Google Calendar',\n      };\n      toast.error(errorMessages[error] || 'Failed to connect Google Calendar');\n      window.history.replaceState({}, '', window.location.pathname);\n    }\n  }, []);\n\n  const [currentMonth, setCurrentMonth] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n  const [showEventModal, setShowEventModal] = useState(false);\n  const [showEventDetail, setShowEventDetail] = useState(false);\n  const [showTimeOffModal, setShowTimeOffModal] = useState(false);\n  const [showDayDetail, setShowDayDetail] = useState(false);\n  const [selectedEvent, setSelectedEvent] = useState<Meeting | null>(null);\n  const [selectedGoogleEvent, setSelectedGoogleEvent] = useState<GoogleCalendarEvent | null>(null);\n  const [selectedDayItems, setSelectedDayItems] = useState<{meetings: Meeting[], timeOffs: TimeOffRequest[], googleEvents: GoogleCalendarEvent[]}>({ meetings: [], timeOffs: [], googleEvents: [] });\n  const [activeTab, setActiveTab] = useState(\"calendar\");\n  const [calendarView, setCalendarView] = useState<'day' | 'week' | 'month'>('week');\n  const [dayViewDate, setDayViewDate] = useState<Date>(new Date());\n  const [weekViewDate, setWeekViewDate] = useState<Date>(new Date());\n  \n  const [newEvent, setNewEvent] = useState({\n    title: \"\",\n    date: \"\",\n    time: \"\",\n    duration: 60,\n    location: \"\",\n    dealId: \"\",\n    description: \"\",\n    videoLink: \"\",\n    videoPlatform: \"\",\n    invitees: [] as string[]\n  });\n\n  const [newTimeOff, setNewTimeOff] = useState({\n    type: \"Vacation\",\n    startDate: \"\",\n    endDate: \"\",\n    notes: \"\"\n  });\n\n  const [dealPopoverOpen, setDealPopoverOpen] = useState(false);\n  const [inviteesPopoverOpen, setInviteesPopoverOpen] = useState(false);\n\n  const calendarDays = useMemo(() => {\n    const monthStart = startOfMonth(currentMonth);\n    const monthEnd = endOfMonth(monthStart);\n    const startDate = startOfWeek(monthStart);\n    const endDate = endOfWeek(monthEnd);\n\n    const days = [];\n    let day = startDate;\n    while (day <= endDate) {\n      days.push(day);\n      day = addDays(day, 1);\n    }\n    return days;\n  }, [currentMonth]);\n\n  const getEventsForDate = (date: Date) => {\n    return meetings.filter(meeting => {\n      const meetingDate = new Date(meeting.scheduledFor);\n      return isSameDay(meetingDate, date);\n    });\n  };\n\n  const getTimeOffForDate = (date: Date) => {\n    return timeOffRequests.filter(request => {\n      if (request.status !== 'Approved') return false;\n      const start = parseISO(request.startDate);\n      const end = parseISO(request.endDate);\n      return isWithinInterval(date, { start, end }) || isSameDay(date, start) || isSameDay(date, end);\n    });\n  };\n\n  const getGoogleEventsForDate = (date: Date) => {\n    return googleEvents.filter(event => {\n      const eventDate = new Date(event.start);\n      return isSameDay(eventDate, date);\n    });\n  };\n\n  const myTimeOffRequests = useMemo(() => {\n    if (currentUser?.accessLevel === 'admin') return [];\n    return timeOffRequests.filter(r => r.userId === currentUser?.id);\n  }, [timeOffRequests, currentUser?.id, currentUser?.accessLevel]);\n\n  const pendingTimeOffRequests = useMemo(() => {\n    if (currentUser?.accessLevel !== 'admin') return [];\n    return timeOffRequests.filter(r => r.status === 'Pending');\n  }, [timeOffRequests, currentUser?.accessLevel]);\n\n  const approvedTimeOffRequests = useMemo(() => {\n    return timeOffRequests.filter(r => r.status === 'Approved');\n  }, [timeOffRequests]);\n\n  const handleDateClick = (date: Date) => {\n    setSelectedDate(date);\n    const events = getEventsForDate(date);\n    const timeOffs = getTimeOffForDate(date);\n    const gEvents = getGoogleEventsForDate(date);\n    \n    const totalItems = events.length + timeOffs.length + gEvents.length;\n    \n    if (totalItems === 0) {\n      setNewEvent(prev => ({\n        ...prev,\n        date: format(date, 'yyyy-MM-dd')\n      }));\n      setShowEventModal(true);\n    } else if (events.length === 1 && timeOffs.length === 0 && gEvents.length === 0) {\n      setSelectedEvent(events[0]);\n      setShowEventDetail(true);\n    } else if (gEvents.length === 1 && events.length === 0 && timeOffs.length === 0) {\n      setSelectedGoogleEvent(gEvents[0]);\n    } else {\n      setSelectedDayItems({ meetings: events, timeOffs, googleEvents: gEvents });\n      setShowDayDetail(true);\n    }\n  };\n\n  const handleEventClick = (event: Meeting, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setSelectedEvent(event);\n    setShowEventDetail(true);\n  };\n\n  const handleCreateEvent = async () => {\n    if (!newEvent.title || !newEvent.date || !newEvent.time) {\n      toast.error(\"Please fill in title, date and time\");\n      return;\n    }\n\n    try {\n      const scheduledFor = new Date(`${newEvent.date}T${newEvent.time}`);\n      \n      // Convert user IDs to emails for the participants field (API expects emails)\n      const participantEmails = newEvent.invitees\n        .map(userId => {\n          const user = users.find(u => u.id === userId);\n          return user?.email;\n        })\n        .filter((email): email is string => !!email);\n      \n      await createMeetingMutation.mutateAsync({\n        title: newEvent.title,\n        scheduledFor,\n        duration: newEvent.duration,\n        location: newEvent.location || null,\n        dealId: newEvent.dealId || null,\n        description: newEvent.description || null,\n        videoLink: newEvent.videoLink || null,\n        videoPlatform: newEvent.videoPlatform || null,\n        organizerId: currentUser?.id || null,\n        participants: participantEmails,\n        status: 'scheduled',\n      });\n      \n      const inviteCount = newEvent.invitees.length;\n      toast.success(`Event created successfully!${inviteCount > 0 ? ` ${inviteCount} team member${inviteCount > 1 ? 's' : ''} invited.` : ''}`);\n      setShowEventModal(false);\n      setNewEvent({\n        title: \"\",\n        date: \"\",\n        time: \"\",\n        duration: 60,\n        location: \"\",\n        dealId: \"\",\n        description: \"\",\n        videoLink: \"\",\n        videoPlatform: \"\",\n        invitees: []\n      });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create event\");\n    }\n  };\n\n  const handleDeleteEvent = async (eventId: string) => {\n    try {\n      await deleteMeetingMutation.mutateAsync(eventId);\n      toast.success(\"Event deleted successfully!\");\n      setShowEventDetail(false);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete event\");\n    }\n  };\n\n  const handleCreateTimeOff = async () => {\n    if (!newTimeOff.startDate || !newTimeOff.endDate) {\n      toast.error(\"Please select start and end dates\");\n      return;\n    }\n\n    try {\n      await createTimeOffMutation.mutateAsync({\n        type: newTimeOff.type,\n        startDate: newTimeOff.startDate,\n        endDate: newTimeOff.endDate,\n        notes: newTimeOff.notes || undefined,\n      });\n      \n      toast.success(\"Time off request submitted!\");\n      setShowTimeOffModal(false);\n      setNewTimeOff({\n        type: \"Vacation\",\n        startDate: \"\",\n        endDate: \"\",\n        notes: \"\"\n      });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to submit request\");\n    }\n  };\n\n  const handleApproveTimeOff = async (requestId: string) => {\n    try {\n      await updateTimeOffMutation.mutateAsync({\n        id: requestId,\n        updates: {\n          status: 'Approved',\n        }\n      });\n      toast.success(\"Time off approved!\");\n      setShowDayDetail(false);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to approve request\");\n    }\n  };\n\n  const handleDenyTimeOff = async (requestId: string) => {\n    try {\n      await updateTimeOffMutation.mutateAsync({\n        id: requestId,\n        updates: {\n          status: 'Denied',\n        }\n      });\n      toast.success(\"Time off denied\");\n      setShowDayDetail(false);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to deny request\");\n    }\n  };\n\n  const getDealName = (dealId: string | null | undefined) => {\n    if (!dealId) return null;\n    const deal = deals.find(d => d.id === dealId);\n    return deal?.name || null;\n  };\n\n  const getUserName = (userId: string | null | undefined) => {\n    if (!userId) return \"Unknown\";\n    const user = users.find(u => u.id === userId);\n    return user?.name || \"Unknown\";\n  };\n\n  const formatEventTime = (meeting: Meeting) => {\n    const date = new Date(meeting.scheduledFor);\n    return format(date, 'h:mm a');\n  };\n\n  const formatEventDate = (meeting: Meeting) => {\n    const date = new Date(meeting.scheduledFor);\n    return format(date, 'EEEE, MMMM d, yyyy');\n  };\n\n  const upcomingEvents = useMemo(() => {\n    const now = new Date();\n    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    return meetings\n      .filter(m => new Date(m.scheduledFor) >= todayStart)\n      .sort((a, b) => new Date(a.scheduledFor).getTime() - new Date(b.scheduledFor).getTime())\n      .slice(0, 5);\n  }, [meetings]);\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'Approved': return 'bg-green-500/10 text-green-500 border-green-500/20';\n      case 'Denied': return 'bg-red-500/10 text-red-500 border-red-500/20';\n      default: return 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20';\n    }\n  };\n\n  const getTimeOffTypeColor = (type: string) => {\n    switch (type) {\n      case 'Vacation': return 'bg-blue-500';\n      case 'Sick': return 'bg-red-500';\n      case 'Personal': return 'bg-purple-500';\n      case 'WFH': return 'bg-green-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  return (\n    <Layout role={role} pageTitle=\"Calendar\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\">Calendar</h1>\n            <p className=\"text-muted-foreground\">\n              {currentUser?.accessLevel === 'admin' \n                ? 'Manage events and review time off requests'\n                : 'Schedule events and request time off'}\n            </p>\n          </div>\n          <div className=\"flex gap-2\">\n            {currentUser?.accessLevel !== 'admin' && (\n              <Button variant=\"outline\" onClick={() => setShowTimeOffModal(true)} data-testid=\"button-request-time-off\">\n                <CalendarOff className=\"w-4 h-4 mr-2\" />\n                Request Time Off\n              </Button>\n            )}\n            <Button onClick={() => setShowEventModal(true)} data-testid=\"button-new-event\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              New Event\n            </Button>\n          </div>\n        </div>\n\n        <Tabs value={activeTab} onValueChange={setActiveTab}>\n          <TabsList>\n            <TabsTrigger value=\"calendar\">Calendar</TabsTrigger>\n            {currentUser?.accessLevel === 'admin' ? (\n              <TabsTrigger value=\"requests\" className=\"relative\">\n                Time Off Requests\n                {pendingTimeOffRequests.length > 0 && (\n                  <Badge className=\"ml-2 h-5 w-5 p-0 flex items-center justify-center bg-orange-500\">\n                    {pendingTimeOffRequests.length}\n                  </Badge>\n                )}\n              </TabsTrigger>\n            ) : (\n              <TabsTrigger value=\"my-requests\">My Requests</TabsTrigger>\n            )}\n          </TabsList>\n\n          <TabsContent value=\"calendar\" className=\"mt-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n              <div className=\"lg:col-span-3\">\n                <Card className=\"bg-card border-border\">\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-4\">\n                        <CardTitle className=\"text-lg font-semibold\">\n                          {format(currentMonth, 'MMMM yyyy')}\n                        </CardTitle>\n                        {googleCalendarStatus?.configured && (\n                          <div className=\"flex items-center gap-2\">\n                            {googleCalendarStatus.connected ? (\n                              <>\n                                <div className=\"flex items-center gap-1.5 px-2 py-1 bg-green-500/10 text-green-600 rounded-md text-xs font-medium\">\n                                  <div className=\"w-1.5 h-1.5 bg-green-500 rounded-full\" />\n                                  Google Calendar\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  className=\"h-6 w-6\"\n                                  onClick={() => refetchGoogleEvents()}\n                                  disabled={isLoadingGoogleEvents}\n                                  title=\"Refresh Google Calendar\"\n                                  data-testid=\"button-refresh-google-calendar\"\n                                >\n                                  <RefreshCw className={cn(\"w-3 h-3\", isLoadingGoogleEvents && \"animate-spin\")} />\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-6 text-xs text-muted-foreground\"\n                                  onClick={() => {\n                                    syncGoogleCalendar.mutate(undefined, {\n                                      onSuccess: (result) => toast.success(result.message),\n                                      onError: (error) => toast.error(error.message)\n                                    });\n                                  }}\n                                  disabled={syncGoogleCalendar.isPending}\n                                  data-testid=\"button-sync-google-calendar\"\n                                >\n                                  {syncGoogleCalendar.isPending ? \"Syncing...\" : \"Sync\"}\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-6 text-xs text-muted-foreground hover:text-destructive\"\n                                  onClick={() => {\n                                    disconnectGoogleCalendar.mutate(undefined, {\n                                      onSuccess: () => toast.success(\"Google Calendar disconnected\"),\n                                      onError: (error) => toast.error(error.message)\n                                    });\n                                  }}\n                                  disabled={disconnectGoogleCalendar.isPending}\n                                  data-testid=\"button-disconnect-google-calendar\"\n                                >\n                                  Disconnect\n                                </Button>\n                              </>\n                            ) : (\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                className=\"h-7 text-xs gap-1.5\"\n                                onClick={() => {\n                                  connectGoogleCalendar.mutate(undefined, {\n                                    onSuccess: (authUrl) => {\n                                      window.location.href = authUrl;\n                                    },\n                                    onError: (error) => toast.error(error.message)\n                                  });\n                                }}\n                                disabled={connectGoogleCalendar.isPending}\n                                data-testid=\"button-connect-google-calendar\"\n                              >\n                                <Calendar className=\"w-3.5 h-3.5\" />\n                                Connect Google Calendar\n                              </Button>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          onClick={() => {\n                            if (calendarView === 'day') {\n                              setDayViewDate(addDays(dayViewDate, -1));\n                            } else if (calendarView === 'week') {\n                              setWeekViewDate(addDays(weekViewDate, -7));\n                            } else {\n                              setCurrentMonth(subMonths(currentMonth, 1));\n                            }\n                          }}\n                          data-testid=\"button-prev\"\n                        >\n                          <ChevronLeft className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            const today = new Date();\n                            setDayViewDate(today);\n                            setWeekViewDate(today);\n                            setCurrentMonth(today);\n                          }}\n                          data-testid=\"button-today\"\n                        >\n                          Today\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          onClick={() => {\n                            if (calendarView === 'day') {\n                              setDayViewDate(addDays(dayViewDate, 1));\n                            } else if (calendarView === 'week') {\n                              setWeekViewDate(addDays(weekViewDate, 7));\n                            } else {\n                              setCurrentMonth(addMonths(currentMonth, 1));\n                            }\n                          }}\n                          data-testid=\"button-next\"\n                        >\n                          <ChevronRight className=\"w-4 h-4\" />\n                        </Button>\n                        <Separator orientation=\"vertical\" className=\"h-6 mx-1\" />\n                        <div className=\"flex items-center rounded-md border border-border overflow-hidden\">\n                          <Button\n                            variant={calendarView === 'day' ? 'secondary' : 'ghost'}\n                            size=\"sm\"\n                            className=\"rounded-none border-0 h-8\"\n                            onClick={() => setCalendarView('day')}\n                            data-testid=\"button-view-day\"\n                          >\n                            Day\n                          </Button>\n                          <Button\n                            variant={calendarView === 'week' ? 'secondary' : 'ghost'}\n                            size=\"sm\"\n                            className=\"rounded-none border-0 border-l border-r border-border h-8\"\n                            onClick={() => setCalendarView('week')}\n                            data-testid=\"button-view-week\"\n                          >\n                            Week\n                          </Button>\n                          <Button\n                            variant={calendarView === 'month' ? 'secondary' : 'ghost'}\n                            size=\"sm\"\n                            className=\"rounded-none border-0 h-8\"\n                            onClick={() => setCalendarView('month')}\n                            data-testid=\"button-view-month\"\n                          >\n                            Month\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {calendarView === 'day' ? (\n                      // Day View with hourly timeline\n                      <div className=\"relative\">\n                        <div className=\"text-center mb-4\">\n                          <div className=\"text-4xl font-bold text-foreground\">{format(dayViewDate, 'd')}</div>\n                          <div className=\"text-sm text-muted-foreground\">{format(dayViewDate, 'EEEE, MMMM yyyy')}</div>\n                        </div>\n                        <ScrollArea className=\"h-[600px]\">\n                          <div className=\"relative\" style={{ minHeight: '1440px' }}>\n                            {/* Hour grid lines */}\n                            {Array.from({ length: 24 }, (_, hour) => (\n                              <div\n                                key={hour}\n                                className=\"absolute w-full border-t border-border flex\"\n                                style={{ top: `${hour * 60}px`, height: '60px' }}\n                              >\n                                <div className=\"w-16 flex-shrink-0 text-xs text-muted-foreground pr-2 text-right -translate-y-2\">\n                                  {format(new Date().setHours(hour, 0, 0, 0), 'h a')}\n                                </div>\n                                <div className=\"flex-1 border-l border-border/50\" />\n                              </div>\n                            ))}\n                            \n                            {/* Events positioned by time */}\n                            <div className=\"absolute left-16 right-0 top-0\">\n                              {getEventsForDate(dayViewDate).map(event => {\n                                const eventDate = new Date(event.scheduledFor);\n                                const startHour = eventDate.getHours();\n                                const startMinute = eventDate.getMinutes();\n                                const startPos = startHour * 60 + startMinute;\n                                const duration = event.duration || 60;\n                                \n                                return (\n                                  <div\n                                    key={event.id}\n                                    className=\"absolute left-1 right-1 bg-blue-500 text-white rounded-md p-2 cursor-pointer hover:bg-blue-600 transition-colors overflow-hidden\"\n                                    style={{\n                                      top: `${startPos}px`,\n                                      height: `${Math.max(duration, 30)}px`,\n                                      minHeight: '30px'\n                                    }}\n                                    onClick={() => {\n                                      setSelectedEvent(event);\n                                      setShowEventDetail(true);\n                                    }}\n                                    data-testid={`day-event-${event.id}`}\n                                  >\n                                    <div className=\"text-sm font-medium truncate\">{event.title}</div>\n                                    <div className=\"text-xs opacity-80\">\n                                      {format(eventDate, 'h:mm a')} - {format(addHours(eventDate, duration / 60), 'h:mm a')}\n                                    </div>\n                                  </div>\n                                );\n                              })}\n                              \n                              {/* Google Calendar events */}\n                              {getGoogleEventsForDate(dayViewDate).map(gEvent => {\n                                const eventDate = new Date(gEvent.start);\n                                const startHour = eventDate.getHours();\n                                const startMinute = eventDate.getMinutes();\n                                const startPos = startHour * 60 + startMinute;\n                                const endDate = new Date(gEvent.end);\n                                const duration = Math.max((endDate.getTime() - eventDate.getTime()) / 60000, 30);\n                                \n                                return (\n                                  <div\n                                    key={gEvent.id}\n                                    className=\"absolute left-1 right-1 bg-green-600 text-white rounded-md p-2 cursor-pointer hover:bg-green-700 transition-colors overflow-hidden flex items-start gap-1\"\n                                    style={{\n                                      top: `${startPos}px`,\n                                      height: `${Math.max(duration, 30)}px`,\n                                      minHeight: '30px'\n                                    }}\n                                    onClick={() => setSelectedGoogleEvent(gEvent)}\n                                    data-testid={`day-google-event-${gEvent.id}`}\n                                  >\n                                    <Calendar className=\"w-3 h-3 flex-shrink-0 mt-0.5\" />\n                                    <div className=\"flex-1 min-w-0\">\n                                      <div className=\"text-sm font-medium truncate\">{gEvent.title}</div>\n                                      <div className=\"text-xs opacity-80\">\n                                        {format(eventDate, 'h:mm a')} - {format(endDate, 'h:mm a')}\n                                      </div>\n                                    </div>\n                                  </div>\n                                );\n                              })}\n                              \n                              {/* Time off indicators */}\n                              {getTimeOffForDate(dayViewDate).length > 0 && (\n                                <div className=\"absolute left-1 right-1 top-0 bg-orange-500/20 border border-orange-500/50 rounded-md p-2\">\n                                  <div className=\"text-sm font-medium text-orange-600\">Time Off</div>\n                                  {getTimeOffForDate(dayViewDate).map(timeOff => (\n                                    <div key={timeOff.id} className=\"text-xs text-orange-600\">\n                                      {getUserName(timeOff.userId)} - {timeOff.type}\n                                    </div>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        </ScrollArea>\n                      </div>\n                    ) : calendarView === 'week' ? (\n                      // Week View with 7-day columns and hourly rows\n                      <div className=\"relative\">\n                        <div className=\"text-center mb-4\">\n                          <div className=\"text-lg font-bold text-foreground\">\n                            {format(startOfWeek(weekViewDate), 'MMM d')} - {format(endOfWeek(weekViewDate), 'MMM d, yyyy')}\n                          </div>\n                        </div>\n                        <div className=\"border border-border rounded-lg overflow-hidden\">\n                          {/* Week header with days */}\n                          <div className=\"grid grid-cols-8 bg-secondary/50\">\n                            <div className=\"p-2 text-center text-xs font-medium text-muted-foreground border-r border-border w-16\" />\n                            {Array.from({ length: 7 }, (_, i) => {\n                              const day = addDays(startOfWeek(weekViewDate), i);\n                              return (\n                                <div\n                                  key={i}\n                                  className={cn(\n                                    \"p-2 text-center border-r border-border last:border-r-0\",\n                                    isToday(day) && \"bg-primary/10\"\n                                  )}\n                                >\n                                  <div className=\"text-xs font-medium text-muted-foreground\">{format(day, 'EEE')}</div>\n                                  <div className={cn(\n                                    \"text-lg font-bold mt-0.5\",\n                                    isToday(day) && \"text-primary\"\n                                  )}>\n                                    {format(day, 'd')}\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                          {/* Week grid with hours */}\n                          <ScrollArea className=\"h-[500px]\">\n                            <div className=\"relative\" style={{ minHeight: '960px' }}>\n                              {/* Hour rows (6 AM to 10 PM) */}\n                              {Array.from({ length: 17 }, (_, i) => i + 6).map(hour => (\n                                <div\n                                  key={hour}\n                                  className=\"grid grid-cols-8 border-b border-border\"\n                                  style={{ height: '60px' }}\n                                >\n                                  <div className=\"w-16 text-xs text-muted-foreground pr-2 text-right pt-1 border-r border-border\">\n                                    {format(new Date().setHours(hour, 0, 0, 0), 'h a')}\n                                  </div>\n                                  {Array.from({ length: 7 }, (_, dayIdx) => (\n                                    <div key={dayIdx} className=\"border-r border-border/30 last:border-r-0 relative\" />\n                                  ))}\n                                </div>\n                              ))}\n                              {/* Events overlay */}\n                              <div className=\"absolute top-0 left-16 right-0 grid grid-cols-7\" style={{ height: '100%' }}>\n                                {Array.from({ length: 7 }, (_, dayIdx) => {\n                                  const day = addDays(startOfWeek(weekViewDate), dayIdx);\n                                  const dayEvents = getEventsForDate(day);\n                                  const dayGoogleEvents = getGoogleEventsForDate(day);\n                                  const dayTimeOffs = getTimeOffForDate(day);\n                                  \n                                  return (\n                                    <div key={dayIdx} className=\"relative border-r border-border/30 last:border-r-0\">\n                                      {/* Time off banner at top */}\n                                      {dayTimeOffs.length > 0 && (\n                                        <div className=\"absolute top-0 left-0.5 right-0.5 bg-orange-500/20 border border-orange-500/50 rounded text-[9px] p-1 z-10\">\n                                          <span className=\"text-orange-600 font-medium truncate block\">\n                                            {dayTimeOffs[0].type}\n                                          </span>\n                                        </div>\n                                      )}\n                                      {/* Meetings */}\n                                      {dayEvents.map(event => {\n                                        const eventDate = new Date(event.scheduledFor);\n                                        const startHour = eventDate.getHours();\n                                        const startMinute = eventDate.getMinutes();\n                                        const startPos = (startHour - 6) * 60 + startMinute;\n                                        const duration = event.duration || 60;\n                                        \n                                        if (startHour < 6 || startHour >= 22) return null;\n                                        \n                                        return (\n                                          <div\n                                            key={event.id}\n                                            className=\"absolute left-0.5 right-0.5 bg-blue-500 text-white rounded text-[10px] p-1 cursor-pointer hover:bg-blue-600 transition-colors overflow-hidden z-20\"\n                                            style={{\n                                              top: `${startPos}px`,\n                                              height: `${Math.max(duration, 25)}px`,\n                                              minHeight: '20px'\n                                            }}\n                                            onClick={() => {\n                                              setSelectedEvent(event);\n                                              setShowEventDetail(true);\n                                            }}\n                                            data-testid={`week-event-${event.id}`}\n                                          >\n                                            <div className=\"font-medium truncate\">{event.title}</div>\n                                            <div className=\"opacity-80 truncate\">{format(eventDate, 'h:mm a')}</div>\n                                          </div>\n                                        );\n                                      })}\n                                      {/* Google events */}\n                                      {dayGoogleEvents.map(gEvent => {\n                                        const eventDate = new Date(gEvent.start);\n                                        const startHour = eventDate.getHours();\n                                        const startMinute = eventDate.getMinutes();\n                                        const startPos = (startHour - 6) * 60 + startMinute;\n                                        const endDate = new Date(gEvent.end);\n                                        const duration = Math.max((endDate.getTime() - eventDate.getTime()) / 60000, 25);\n                                        \n                                        if (startHour < 6 || startHour >= 22) return null;\n                                        \n                                        return (\n                                          <div\n                                            key={gEvent.id}\n                                            className=\"absolute left-0.5 right-0.5 bg-green-600 text-white rounded text-[10px] p-1 cursor-pointer hover:bg-green-700 transition-colors overflow-hidden z-20\"\n                                            style={{\n                                              top: `${startPos}px`,\n                                              height: `${Math.max(duration, 25)}px`,\n                                              minHeight: '20px'\n                                            }}\n                                            onClick={() => setSelectedGoogleEvent(gEvent)}\n                                            data-testid={`week-google-event-${gEvent.id}`}\n                                          >\n                                            <div className=\"font-medium truncate flex items-center gap-0.5\">\n                                              <Calendar className=\"w-2.5 h-2.5 flex-shrink-0\" />\n                                              {gEvent.title}\n                                            </div>\n                                            <div className=\"opacity-80 truncate\">{format(eventDate, 'h:mm a')}</div>\n                                          </div>\n                                        );\n                                      })}\n                                    </div>\n                                  );\n                                })}\n                              </div>\n                            </div>\n                          </ScrollArea>\n                        </div>\n                      </div>\n                    ) : (\n                    // Month View (existing grid)\n                    <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n                      {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (\n                        <div key={day} className=\"bg-secondary/50 p-2 text-center text-xs font-medium text-muted-foreground\">\n                          {day}\n                        </div>\n                      ))}\n                      {calendarDays.map((day, idx) => {\n                        const dayEvents = getEventsForDate(day);\n                        const dayTimeOffs = getTimeOffForDate(day);\n                        const dayGoogleEvents = getGoogleEventsForDate(day);\n                        const isCurrentMonth = isSameMonth(day, currentMonth);\n                        const isSelected = selectedDate && isSameDay(day, selectedDate);\n                        const hasTimeOff = dayTimeOffs.length > 0;\n                        const totalItems = dayEvents.length + dayTimeOffs.length + dayGoogleEvents.length;\n                        \n                        return (\n                          <div\n                            key={idx}\n                            className={cn(\n                              \"min-h-[100px] p-1 bg-card cursor-pointer transition-colors hover:bg-secondary/30\",\n                              !isCurrentMonth && \"bg-muted/30 text-muted-foreground\",\n                              isSelected && \"ring-2 ring-primary ring-inset\",\n                              isToday(day) && \"bg-primary/5\",\n                              hasTimeOff && \"bg-orange-500/5\"\n                            )}\n                            onClick={() => handleDateClick(day)}\n                            data-testid={`calendar-day-${format(day, 'yyyy-MM-dd')}`}\n                          >\n                            <div className={cn(\n                              \"text-sm font-medium mb-1 w-6 h-6 flex items-center justify-center rounded-full\",\n                              isToday(day) && \"bg-primary text-primary-foreground\"\n                            )}>\n                              {format(day, 'd')}\n                            </div>\n                            <div className=\"space-y-0.5\">\n                              {dayTimeOffs.slice(0, 1).map(timeOff => (\n                                <div\n                                  key={timeOff.id}\n                                  className={cn(\n                                    \"text-[10px] px-1 py-0.5 rounded truncate text-white\",\n                                    getTimeOffTypeColor(timeOff.type)\n                                  )}\n                                >\n                                  {getUserName(timeOff.userId)} - {timeOff.type}\n                                </div>\n                              ))}\n                              {dayEvents.slice(0, 2).map(event => (\n                                <div\n                                  key={event.id}\n                                  className=\"text-[10px] px-1 py-0.5 rounded truncate text-white bg-blue-500 cursor-pointer\"\n                                  onClick={(e) => handleEventClick(event, e)}\n                                  data-testid={`event-${event.id}`}\n                                >\n                                  {event.title}\n                                </div>\n                              ))}\n                              {dayGoogleEvents.slice(0, 2 - Math.min(dayEvents.length, 2)).map(gEvent => (\n                                <div\n                                  key={gEvent.id}\n                                  className=\"text-[10px] px-1 py-0.5 rounded truncate text-white bg-green-600 cursor-pointer flex items-center gap-0.5\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    setSelectedGoogleEvent(gEvent);\n                                  }}\n                                  data-testid={`google-event-${gEvent.id}`}\n                                >\n                                  <Calendar className=\"w-2.5 h-2.5 flex-shrink-0\" />\n                                  {gEvent.title}\n                                </div>\n                              ))}\n                              {totalItems > 3 && (\n                                <div className=\"text-[10px] text-muted-foreground px-1\">\n                                  +{totalItems - 3} more\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"space-y-6\">\n                <Card className=\"bg-card border-border\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                      <Clock className=\"w-4 h-4\" />\n                      Upcoming Events\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ScrollArea className=\"h-[200px]\">\n                      {upcomingEvents.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground text-center py-4\">No upcoming events</p>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {upcomingEvents.map(event => (\n                            <div\n                              key={event.id}\n                              className=\"p-3 rounded-lg bg-secondary/30 hover:bg-secondary/50 cursor-pointer transition-colors\"\n                              onClick={() => {\n                                setSelectedEvent(event);\n                                setShowEventDetail(true);\n                              }}\n                              data-testid={`upcoming-event-${event.id}`}\n                            >\n                              <div className=\"flex items-start justify-between gap-2\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"font-medium text-sm truncate\">{event.title}</p>\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    {format(new Date(event.scheduledFor), 'MMM d')} at {formatEventTime(event)}\n                                  </p>\n                                </div>\n                                <div className=\"w-2 h-2 rounded-full mt-1.5 bg-blue-500\" />\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-card border-border\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                      <CalendarOff className=\"w-4 h-4\" />\n                      Approved Time Off\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ScrollArea className=\"h-[150px]\">\n                      {approvedTimeOffRequests.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground text-center py-4\">No approved time off</p>\n                      ) : (\n                        <div className=\"space-y-2\">\n                          {approvedTimeOffRequests.slice(0, 5).map(request => (\n                            <div\n                              key={request.id}\n                              className=\"p-2 rounded bg-secondary/30\"\n                            >\n                              <p className=\"font-medium text-xs\">{getUserName(request.userId)}</p>\n                              <p className=\"text-[10px] text-muted-foreground\">\n                                {request.type}: {request.startDate} - {request.endDate}\n                              </p>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          </TabsContent>\n\n          {currentUser?.accessLevel === 'admin' ? (\n            <TabsContent value=\"requests\" className=\"mt-6\">\n              <Card className=\"bg-card border-border\">\n                <CardHeader>\n                  <CardTitle>Time Off Requests</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {pendingTimeOffRequests.length === 0 ? (\n                    <p className=\"text-muted-foreground text-center py-8\">No pending requests</p>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      {pendingTimeOffRequests.map(request => (\n                        <div\n                          key={request.id}\n                          className=\"flex items-center justify-between p-4 rounded-lg bg-secondary/30\"\n                        >\n                          <div className=\"flex items-center gap-4\">\n                            <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                              <User className=\"w-5 h-5 text-primary\" />\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">{getUserName(request.userId)}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {request.type}: {request.startDate} to {request.endDate}\n                              </p>\n                              {request.notes && (\n                                <p className=\"text-xs text-muted-foreground mt-1\">\"{request.notes}\"</p>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              className=\"text-red-500 hover:text-red-600\"\n                              onClick={() => handleDenyTimeOff(request.id)}\n                              disabled={updateTimeOffMutation.isPending}\n                              data-testid={`deny-request-${request.id}`}\n                            >\n                              <X className=\"w-4 h-4 mr-1\" />\n                              Deny\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              className=\"bg-green-600 hover:bg-green-700\"\n                              onClick={() => handleApproveTimeOff(request.id)}\n                              disabled={updateTimeOffMutation.isPending}\n                              data-testid={`approve-request-${request.id}`}\n                            >\n                              <Check className=\"w-4 h-4 mr-1\" />\n                              Approve\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          ) : (\n            <TabsContent value=\"my-requests\" className=\"mt-6\">\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <CardTitle>My Time Off Requests</CardTitle>\n                  <Button onClick={() => setShowTimeOffModal(true)} data-testid=\"button-new-request\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    New Request\n                  </Button>\n                </CardHeader>\n                <CardContent>\n                  {myTimeOffRequests.length === 0 ? (\n                    <p className=\"text-muted-foreground text-center py-8\">No time off requests yet</p>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      {myTimeOffRequests.map(request => (\n                        <div\n                          key={request.id}\n                          className=\"flex items-center justify-between p-4 rounded-lg bg-secondary/30\"\n                        >\n                          <div>\n                            <div className=\"flex items-center gap-2\">\n                              <p className=\"font-medium\">{request.type}</p>\n                              <Badge variant=\"outline\" className={getStatusColor(request.status)}>\n                                {request.status}\n                              </Badge>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground mt-1\">\n                              {request.startDate} to {request.endDate}\n                            </p>\n                            {request.notes && (\n                              <p className=\"text-xs text-muted-foreground mt-1\">Note: {request.notes}</p>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          )}\n        </Tabs>\n      </div>\n\n      <Dialog open={showEventModal} onOpenChange={setShowEventModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create New Event</DialogTitle>\n            <DialogDescription>Add a new event to your calendar</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Title</Label>\n              <Input\n                value={newEvent.title}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, title: e.target.value }))}\n                placeholder=\"Event title\"\n                data-testid=\"input-event-title\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Date</Label>\n                <Input\n                  type=\"date\"\n                  value={newEvent.date}\n                  onChange={(e) => setNewEvent(prev => ({ ...prev, date: e.target.value }))}\n                  data-testid=\"input-event-date\"\n                />\n              </div>\n              <div>\n                <Label>Time</Label>\n                <Select\n                  value={newEvent.time}\n                  onValueChange={(v) => setNewEvent(prev => ({ ...prev, time: v }))}\n                >\n                  <SelectTrigger data-testid=\"select-event-time\">\n                    <SelectValue placeholder=\"Select time\" />\n                  </SelectTrigger>\n                  <SelectContent className=\"max-h-[200px]\">\n                    {Array.from({ length: 36 }, (_, i) => {\n                      const hour = Math.floor(i / 2) + 6;\n                      const minute = (i % 2) * 30;\n                      const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;\n                      const hour12 = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;\n                      const ampm = hour >= 12 ? 'PM' : 'AM';\n                      const display = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;\n                      return <SelectItem key={time24} value={time24}>{display}</SelectItem>;\n                    })}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div>\n              <Label>Duration (minutes)</Label>\n              <Select\n                value={newEvent.duration.toString()}\n                onValueChange={(v) => setNewEvent(prev => ({ ...prev, duration: parseInt(v) }))}\n              >\n                <SelectTrigger data-testid=\"select-event-duration\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"15\">15 minutes</SelectItem>\n                  <SelectItem value=\"30\">30 minutes</SelectItem>\n                  <SelectItem value=\"45\">45 minutes</SelectItem>\n                  <SelectItem value=\"60\">1 hour</SelectItem>\n                  <SelectItem value=\"90\">1.5 hours</SelectItem>\n                  <SelectItem value=\"120\">2 hours</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label>Location</Label>\n              <Input\n                value={newEvent.location}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, location: e.target.value }))}\n                placeholder=\"Location or meeting room\"\n                data-testid=\"input-event-location\"\n              />\n            </div>\n            <div>\n              <Label>Video Platform</Label>\n              <Select\n                value={newEvent.videoPlatform || \"none\"}\n                onValueChange={(v) => setNewEvent(prev => ({ ...prev, videoPlatform: v === \"none\" ? \"\" : v }))}\n              >\n                <SelectTrigger data-testid=\"select-event-video\">\n                  <SelectValue placeholder=\"Select platform\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">No video call</SelectItem>\n                  <SelectItem value=\"zoom\">Zoom</SelectItem>\n                  <SelectItem value=\"google_meet\">Google Meet</SelectItem>\n                  <SelectItem value=\"teams\">Microsoft Teams</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            {newEvent.videoPlatform && (\n              <div className=\"space-y-2\">\n                <Label>Meeting Link</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    value={newEvent.videoLink}\n                    onChange={(e) => setNewEvent(prev => ({ ...prev, videoLink: e.target.value }))}\n                    placeholder=\"Paste meeting link here...\"\n                    className=\"flex-1\"\n                    data-testid=\"input-event-meeting-link\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      const urls: Record<string, string> = {\n                        zoom: 'https://zoom.us/meeting/schedule',\n                        google_meet: 'https://meet.google.com/new',\n                        teams: 'https://teams.microsoft.com/l/meeting/new'\n                      };\n                      const url = urls[newEvent.videoPlatform];\n                      if (url) window.open(url, '_blank');\n                    }}\n                    data-testid=\"button-create-meeting-link\"\n                  >\n                    <ExternalLink className=\"h-4 w-4 mr-1\" />\n                    Create\n                  </Button>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Click \"Create\" to open {newEvent.videoPlatform === 'google_meet' ? 'Google Meet' : newEvent.videoPlatform === 'teams' ? 'Microsoft Teams' : 'Zoom'}, then paste the link here\n                </p>\n              </div>\n            )}\n            <div>\n              <Label>Related Deal</Label>\n              <Popover open={dealPopoverOpen} onOpenChange={setDealPopoverOpen}>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    role=\"combobox\"\n                    aria-expanded={dealPopoverOpen}\n                    className=\"w-full justify-between\"\n                    data-testid=\"select-event-deal\"\n                  >\n                    {newEvent.dealId\n                      ? deals.find(d => d.id === newEvent.dealId)?.name || \"Select deal...\"\n                      : \"Select deal (optional)\"}\n                    <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-[300px] p-0\">\n                  <Command>\n                    <CommandInput placeholder=\"Search deals...\" />\n                    <CommandList>\n                      <CommandEmpty>No deals found.</CommandEmpty>\n                      <CommandGroup>\n                        <CommandItem\n                          value=\"none\"\n                          onSelect={() => {\n                            setNewEvent(prev => ({ ...prev, dealId: \"\" }));\n                            setDealPopoverOpen(false);\n                          }}\n                        >\n                          <Check className={cn(\"mr-2 h-4 w-4\", !newEvent.dealId ? \"opacity-100\" : \"opacity-0\")} />\n                          No deal\n                        </CommandItem>\n                        {deals.map(deal => (\n                          <CommandItem\n                            key={deal.id}\n                            value={deal.name}\n                            onSelect={() => {\n                              setNewEvent(prev => ({ ...prev, dealId: deal.id }));\n                              setDealPopoverOpen(false);\n                            }}\n                          >\n                            <Check className={cn(\"mr-2 h-4 w-4\", newEvent.dealId === deal.id ? \"opacity-100\" : \"opacity-0\")} />\n                            {deal.name}\n                          </CommandItem>\n                        ))}\n                      </CommandGroup>\n                    </CommandList>\n                  </Command>\n                </PopoverContent>\n              </Popover>\n            </div>\n            <div>\n              <Label>Description</Label>\n              <Textarea\n                value={newEvent.description}\n                onChange={(e) => setNewEvent(prev => ({ ...prev, description: e.target.value }))}\n                placeholder=\"Event description...\"\n                rows={3}\n                data-testid=\"input-event-description\"\n              />\n            </div>\n            <div>\n              <Label>Invite Team Members</Label>\n              <div className=\"flex flex-wrap gap-2 mt-2 mb-2\">\n                {newEvent.invitees.map((userId) => {\n                  const user = users.find(u => u.id === userId);\n                  return (\n                    <Badge key={userId} variant=\"secondary\" className=\"flex items-center gap-1\">\n                      {user?.name || userId}\n                      <X \n                        className=\"w-3 h-3 cursor-pointer hover:text-destructive\" \n                        onClick={() => setNewEvent(prev => ({ \n                          ...prev, \n                          invitees: prev.invitees.filter(id => id !== userId) \n                        }))}\n                      />\n                    </Badge>\n                  );\n                })}\n              </div>\n              <Popover open={inviteesPopoverOpen} onOpenChange={setInviteesPopoverOpen}>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    role=\"combobox\"\n                    aria-expanded={inviteesPopoverOpen}\n                    className=\"w-full justify-between\"\n                    data-testid=\"select-event-invitees\"\n                  >\n                    {newEvent.invitees.length > 0\n                      ? `${newEvent.invitees.length} member${newEvent.invitees.length > 1 ? 's' : ''} selected`\n                      : \"Select team members to invite...\"}\n                    <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-[300px] p-0\">\n                  <Command>\n                    <CommandInput placeholder=\"Search team members...\" />\n                    <CommandList>\n                      <CommandEmpty>No team members found.</CommandEmpty>\n                      <CommandGroup>\n                        {users\n                          .filter(u => u.id !== currentUser?.id)\n                          .map(user => (\n                            <CommandItem\n                              key={user.id}\n                              value={user.name}\n                              onSelect={() => {\n                                setNewEvent(prev => ({\n                                  ...prev,\n                                  invitees: prev.invitees.includes(user.id)\n                                    ? prev.invitees.filter(id => id !== user.id)\n                                    : [...prev.invitees, user.id]\n                                }));\n                              }}\n                            >\n                              <Check className={cn(\"mr-2 h-4 w-4\", newEvent.invitees.includes(user.id) ? \"opacity-100\" : \"opacity-0\")} />\n                              {user.name} ({user.jobTitle || user.role})\n                            </CommandItem>\n                          ))}\n                      </CommandGroup>\n                    </CommandList>\n                  </Command>\n                </PopoverContent>\n              </Popover>\n              {newEvent.invitees.length > 0 && (\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {newEvent.invitees.length} team member{newEvent.invitees.length > 1 ? 's' : ''} will be invited\n                </p>\n              )}\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEventModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateEvent} disabled={createMeetingMutation.isPending} data-testid=\"button-create-event\">\n              {createMeetingMutation.isPending ? \"Creating...\" : \"Create Event\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEventDetail} onOpenChange={setShowEventDetail}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle>{selectedEvent?.title}</DialogTitle>\n            <DialogDescription>Event Details</DialogDescription>\n          </DialogHeader>\n          {selectedEvent && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Calendar className=\"w-4 h-4 text-muted-foreground\" />\n                <span>{formatEventDate(selectedEvent)}</span>\n              </div>\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Clock className=\"w-4 h-4 text-muted-foreground\" />\n                <span>{formatEventTime(selectedEvent)} ({selectedEvent.duration} min)</span>\n              </div>\n              {selectedEvent.location && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <MapPin className=\"w-4 h-4 text-muted-foreground\" />\n                  <span>{selectedEvent.location}</span>\n                </div>\n              )}\n              {selectedEvent.videoLink && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Video className=\"w-4 h-4 text-muted-foreground\" />\n                  <a \n                    href={selectedEvent.videoLink} \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-primary hover:underline\"\n                  >\n                    Join {selectedEvent.videoPlatform === 'google_meet' ? 'Google Meet' : \n                          selectedEvent.videoPlatform === 'teams' ? 'Teams' : \n                          selectedEvent.videoPlatform === 'zoom' ? 'Zoom' : 'Meeting'}\n                  </a>\n                </div>\n              )}\n              {getDealName(selectedEvent.dealId) && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Briefcase className=\"w-4 h-4 text-muted-foreground\" />\n                  <Badge variant=\"outline\">{getDealName(selectedEvent.dealId)}</Badge>\n                </div>\n              )}\n              {(() => {\n                const participantsList = selectedEvent.participants as string[] | null;\n                if (!participantsList || !Array.isArray(participantsList) || participantsList.length === 0) return null;\n                return (\n                  <div>\n                    <Separator className=\"my-3\" />\n                    <div className=\"flex items-center gap-2 text-sm mb-2\">\n                      <User className=\"w-4 h-4 text-muted-foreground\" />\n                      <span className=\"font-medium\">Invited ({participantsList.length})</span>\n                    </div>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {participantsList.map((participantId: string, idx: number) => {\n                        const participant = users.find(u => u.id === participantId || u.email === participantId);\n                        return (\n                          <Badge key={idx} variant=\"secondary\">\n                            {participant?.name || participantId}\n                          </Badge>\n                        );\n                      })}\n                    </div>\n                  </div>\n                );\n              })()}\n              {selectedEvent.description && (\n                <div>\n                  <Separator className=\"my-3\" />\n                  <p className=\"text-sm text-muted-foreground\">{selectedEvent.description}</p>\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter className=\"gap-2\">\n            <Button\n              variant=\"destructive\"\n              size=\"sm\"\n              onClick={() => selectedEvent && handleDeleteEvent(selectedEvent.id)}\n              disabled={deleteMeetingMutation.isPending}\n              data-testid=\"button-delete-event\"\n            >\n              <Trash2 className=\"w-4 h-4 mr-1\" />\n              Delete\n            </Button>\n            <Button variant=\"outline\" onClick={() => setShowEventDetail(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showTimeOffModal} onOpenChange={setShowTimeOffModal}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Request Time Off</DialogTitle>\n            <DialogDescription>Submit a time off request for approval</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Type</Label>\n              <Select\n                value={newTimeOff.type}\n                onValueChange={(v) => setNewTimeOff(prev => ({ ...prev, type: v }))}\n              >\n                <SelectTrigger data-testid=\"select-time-off-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Vacation\">Vacation</SelectItem>\n                  <SelectItem value=\"Sick\">Sick Leave</SelectItem>\n                  <SelectItem value=\"Personal\">Personal</SelectItem>\n                  <SelectItem value=\"WFH\">Work From Home</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Start Date</Label>\n                <Input\n                  type=\"date\"\n                  value={newTimeOff.startDate}\n                  onChange={(e) => setNewTimeOff(prev => ({ ...prev, startDate: e.target.value }))}\n                  data-testid=\"input-time-off-start\"\n                />\n              </div>\n              <div>\n                <Label>End Date</Label>\n                <Input\n                  type=\"date\"\n                  value={newTimeOff.endDate}\n                  onChange={(e) => setNewTimeOff(prev => ({ ...prev, endDate: e.target.value }))}\n                  data-testid=\"input-time-off-end\"\n                />\n              </div>\n            </div>\n            <div>\n              <Label>Notes (optional)</Label>\n              <Textarea\n                value={newTimeOff.notes}\n                onChange={(e) => setNewTimeOff(prev => ({ ...prev, notes: e.target.value }))}\n                placeholder=\"Reason for time off...\"\n                rows={3}\n                data-testid=\"input-time-off-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowTimeOffModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateTimeOff} disabled={createTimeOffMutation.isPending} data-testid=\"button-submit-time-off\">\n              {createTimeOffMutation.isPending ? \"Submitting...\" : \"Submit Request\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showDayDetail} onOpenChange={setShowDayDetail}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle>\n              {selectedDate ? format(selectedDate, 'EEEE, MMMM d, yyyy') : 'Day Details'}\n            </DialogTitle>\n            <DialogDescription>Events and time off for this day</DialogDescription>\n          </DialogHeader>\n          <ScrollArea className=\"max-h-[400px]\">\n            <div className=\"space-y-4\">\n              {selectedDayItems.timeOffs.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2\">\n                    <CalendarOff className=\"w-4 h-4\" />\n                    Time Off\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {selectedDayItems.timeOffs.map(timeOff => (\n                      <div\n                        key={timeOff.id}\n                        className={cn(\n                          \"p-3 rounded-lg text-white\",\n                          getTimeOffTypeColor(timeOff.type)\n                        )}\n                      >\n                        <p className=\"font-medium\">{getUserName(timeOff.userId)}</p>\n                        <p className=\"text-sm opacity-90\">{timeOff.type}</p>\n                        <p className=\"text-xs opacity-80\">{timeOff.startDate} - {timeOff.endDate}</p>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n              {selectedDayItems.meetings.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2\">\n                    <Calendar className=\"w-4 h-4\" />\n                    Meetings\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {selectedDayItems.meetings.map(meeting => (\n                      <div\n                        key={meeting.id}\n                        className=\"p-3 rounded-lg bg-blue-500/10 border border-blue-500/20 cursor-pointer hover:bg-blue-500/20 transition-colors\"\n                        onClick={() => {\n                          setSelectedEvent(meeting);\n                          setShowDayDetail(false);\n                          setShowEventDetail(true);\n                        }}\n                      >\n                        <p className=\"font-medium\">{meeting.title}</p>\n                        <p className=\"text-sm text-muted-foreground\">{formatEventTime(meeting)}</p>\n                        {meeting.location && (\n                          <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n                            <MapPin className=\"w-3 h-3\" />\n                            {meeting.location}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n              {selectedDayItems.googleEvents.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2\">\n                    <Calendar className=\"w-4 h-4 text-green-500\" />\n                    Google Calendar\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {selectedDayItems.googleEvents.map(gEvent => (\n                      <div\n                        key={gEvent.id}\n                        className=\"p-3 rounded-lg bg-green-500/10 border border-green-500/20 cursor-pointer hover:bg-green-500/20 transition-colors\"\n                        onClick={() => {\n                          setSelectedGoogleEvent(gEvent);\n                          setShowDayDetail(false);\n                        }}\n                      >\n                        <p className=\"font-medium\">{gEvent.title}</p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {format(new Date(gEvent.start), 'h:mm a')} - {format(new Date(gEvent.end), 'h:mm a')}\n                        </p>\n                        {gEvent.location && (\n                          <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n                            <MapPin className=\"w-3 h-3\" />\n                            {gEvent.location}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          </ScrollArea>\n          <DialogFooter className=\"gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                if (selectedDate) {\n                  setNewEvent(prev => ({\n                    ...prev,\n                    date: format(selectedDate, 'yyyy-MM-dd')\n                  }));\n                }\n                setShowDayDetail(false);\n                setShowEventModal(true);\n              }}\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Event\n            </Button>\n            <Button variant=\"outline\" onClick={() => setShowDayDetail(false)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!selectedGoogleEvent} onOpenChange={(open) => !open && setSelectedGoogleEvent(null)}>\n        <DialogContent className=\"bg-card border-border max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5 text-green-500\" />\n              {selectedGoogleEvent?.title || 'Google Calendar Event'}\n            </DialogTitle>\n            <DialogDescription>Event from Google Calendar</DialogDescription>\n          </DialogHeader>\n          {selectedGoogleEvent && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <Clock className=\"w-4 h-4\" />\n                <span>\n                  {format(new Date(selectedGoogleEvent.start), 'EEEE, MMMM d, yyyy')}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2 text-muted-foreground\">\n                <Clock className=\"w-4 h-4\" />\n                <span>\n                  {format(new Date(selectedGoogleEvent.start), 'h:mm a')} - {format(new Date(selectedGoogleEvent.end), 'h:mm a')}\n                </span>\n              </div>\n              {selectedGoogleEvent.location && (\n                <div className=\"flex items-center gap-2 text-muted-foreground\">\n                  <MapPin className=\"w-4 h-4\" />\n                  <span>{selectedGoogleEvent.location}</span>\n                </div>\n              )}\n              {selectedGoogleEvent.description && (\n                <div className=\"pt-2 border-t\">\n                  <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                    {selectedGoogleEvent.description}\n                  </p>\n                </div>\n              )}\n              {selectedGoogleEvent.meetLink && (\n                <div className=\"pt-2\">\n                  <a\n                    href={selectedGoogleEvent.meetLink}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors\"\n                  >\n                    <Video className=\"w-4 h-4\" />\n                    Join Google Meet\n                    <ExternalLink className=\"w-3 h-3\" />\n                  </a>\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setSelectedGoogleEvent(null)}>Close</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":81429,"size_tokens":null},"client/src/lib/investors.ts":{"content":"export type InvestorData = {\n  id: number;\n  name: string;\n  type: string;\n  focus: string;\n  checkSize: string;\n  matchScore: number;\n  tags: string[];\n  email: string;\n  phone: string;\n  website: string;\n};\n\nexport const SHARED_INVESTORS: InvestorData[] = [\n  { id: 1, name: \"Ironclad PE\", type: \"Private Equity\", focus: \"Industrials\", checkSize: \"$50M - $200M\", matchScore: 95, tags: [\"Buyout\", \"Growth\"], email: \"deals@ironcladpe.com\", phone: \"+1 212-555-0101\", website: \"ironcladpe.com\" },\n  { id: 2, name: \"Horizon Legacy\", type: \"Family Office\", focus: \"Healthcare\", checkSize: \"$10M - $50M\", matchScore: 88, tags: [\"Long-term\", \"Minority\"], email: \"investments@horizonlegacy.com\", phone: \"+1 415-555-0102\", website: \"horizonlegacy.com\" },\n  { id: 3, name: \"Quantum Strategic\", type: \"Strategic\", focus: \"Technology\", checkSize: \"$100M+\", matchScore: 92, tags: [\"M&A\", \"Synergy\"], email: \"bd@quantumstrategic.com\", phone: \"+1 650-555-0103\", website: \"quantumstrategic.com\" },\n  { id: 4, name: \"Bedrock Industries\", type: \"Strategic\", focus: \"Industrials\", checkSize: \"$500M+\", matchScore: 75, tags: [\"Consolidation\"], email: \"corp@bedrockindustries.com\", phone: \"+1 312-555-0104\", website: \"bedrockindustries.com\" },\n  { id: 5, name: \"Apex Ventures\", type: \"Venture Capital\", focus: \"Technology\", checkSize: \"$5M - $25M\", matchScore: 82, tags: [\"Early Stage\", \"Growth\"], email: \"pitch@apexvc.com\", phone: \"+1 628-555-0105\", website: \"apexventures.com\" },\n  { id: 6, name: \"Sterling Capital\", type: \"Private Equity\", focus: \"Consumer\", checkSize: \"$75M - $300M\", matchScore: 79, tags: [\"Buyout\", \"Carve-out\"], email: \"deals@sterlingcap.com\", phone: \"+1 617-555-0106\", website: \"sterlingcapital.com\" },\n  { id: 7, name: \"Sequoia Capital\", type: \"Venture Capital\", focus: \"Technology\", checkSize: \"$10M - $100M\", matchScore: 91, tags: [\"Growth\", \"Tech\"], email: \"invest@sequoia.com\", phone: \"+1 650-555-0107\", website: \"sequoiacap.com\" },\n  { id: 8, name: \"Blackstone Group\", type: \"Private Equity\", focus: \"Diversified\", checkSize: \"$500M+\", matchScore: 85, tags: [\"Large Cap\", \"Buyout\"], email: \"deals@blackstone.com\", phone: \"+1 212-555-0108\", website: \"blackstone.com\" },\n  { id: 9, name: \"Tiger Global\", type: \"Hedge Fund\", focus: \"Technology\", checkSize: \"$25M - $500M\", matchScore: 87, tags: [\"Growth\", \"Late Stage\"], email: \"investments@tigerglobal.com\", phone: \"+1 212-555-0109\", website: \"tigerglobal.com\" },\n  { id: 10, name: \"Wellington Management\", type: \"Asset Manager\", focus: \"Healthcare\", checkSize: \"$50M - $200M\", matchScore: 78, tags: [\"Public Markets\", \"Growth\"], email: \"private@wellington.com\", phone: \"+1 617-555-0110\", website: \"wellington.com\" },\n];\n","path":null,"size_bytes":2680,"size_tokens":null},"server/rateLimiter.ts":{"content":"import rateLimit from 'express-rate-limit';\nimport { Request, Response } from 'express';\n\nconst standardHeaders = true;\nconst legacyHeaders = false;\n\nexport const generalLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 1000, // Limit each IP to 1000 requests per window (increased for normal usage)\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many requests, please try again later.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many requests, please try again later.',\n      retryAfter: Math.ceil(15 * 60 / 60) + ' minutes',\n    });\n  },\n});\n\nexport const authLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 10, // Limit each IP to 10 auth attempts per window\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many authentication attempts, please try again later.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many authentication attempts, please try again later.',\n      retryAfter: Math.ceil(15 * 60 / 60) + ' minutes',\n    });\n  },\n  skipSuccessfulRequests: true,\n});\n\nexport const strictLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 hour\n  max: 5, // Limit to 5 requests per hour (for password reset, etc.)\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many requests for this operation, please try again later.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many requests for this operation, please try again later.',\n      retryAfter: '1 hour',\n    });\n  },\n});\n\nexport const uploadLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 200, // Allow 200 file uploads per 15 minutes for bulk operations\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many file uploads, please wait a few minutes and try again.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many file uploads, please wait a few minutes and try again.',\n      retryAfter: '15 minutes',\n    });\n  },\n  keyGenerator: (req: Request) => {\n    const user = (req as any).user;\n    if (user?.id) {\n      return user.id;\n    }\n    return 'anonymous';\n  },\n});\n\nexport const aiLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 10, // Limit AI requests to prevent abuse\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many AI requests, please slow down.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many AI requests, please slow down.',\n      retryAfter: '1 minute',\n    });\n  },\n});\n\nexport const preferencesLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute window\n  max: 30, // Allow 30 preference saves per minute (plenty for UI interactions)\n  standardHeaders,\n  legacyHeaders,\n  message: { error: 'Too many preference saves, please slow down.' },\n  handler: (req: Request, res: Response) => {\n    res.status(429).json({ \n      error: 'Too many preference saves, please slow down.',\n      retryAfter: '1 minute',\n    });\n  },\n});\n","path":null,"size_bytes":3104,"size_tokens":null},"client/src/components/ErrorBoundary.tsx":{"content":"import React, { Component, ErrorInfo, ReactNode } from 'react';\nimport { AlertTriangle, RefreshCw, Home } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\n\ninterface Props {\n  children: ReactNode;\n  fallback?: ReactNode;\n}\n\ninterface State {\n  hasError: boolean;\n  error: Error | null;\n  errorInfo: ErrorInfo | null;\n}\n\nclass ErrorBoundary extends Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      hasError: false,\n      error: null,\n      errorInfo: null,\n    };\n  }\n\n  static getDerivedStateFromError(error: Error): Partial<State> {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {\n    this.setState({ errorInfo });\n    console.error('Error caught by ErrorBoundary:', error, errorInfo);\n  }\n\n  handleReset = (): void => {\n    this.setState({\n      hasError: false,\n      error: null,\n      errorInfo: null,\n    });\n  };\n\n  handleGoHome = (): void => {\n    this.handleReset();\n    window.location.href = '/';\n  };\n\n  handleRefresh = (): void => {\n    window.location.reload();\n  };\n\n  render(): ReactNode {\n    if (this.state.hasError) {\n      if (this.props.fallback) {\n        return this.props.fallback;\n      }\n\n      return (\n        <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n          <Card className=\"max-w-lg w-full\">\n            <CardHeader className=\"text-center\">\n              <div className=\"mx-auto mb-4 h-16 w-16 rounded-full bg-destructive/10 flex items-center justify-center\">\n                <AlertTriangle className=\"h-8 w-8 text-destructive\" />\n              </div>\n              <CardTitle className=\"text-xl\">Something went wrong</CardTitle>\n              <CardDescription>\n                An unexpected error occurred. Don't worry, your data is safe.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {process.env.NODE_ENV === 'development' && this.state.error && (\n                <div className=\"bg-muted rounded-lg p-4 text-sm\">\n                  <p className=\"font-medium text-destructive mb-2\">\n                    {this.state.error.name}: {this.state.error.message}\n                  </p>\n                  {this.state.errorInfo && (\n                    <pre className=\"text-xs text-muted-foreground overflow-auto max-h-32\">\n                      {this.state.errorInfo.componentStack}\n                    </pre>\n                  )}\n                </div>\n              )}\n              <div className=\"flex gap-3\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={this.handleGoHome}\n                  data-testid=\"button-go-home\"\n                >\n                  <Home className=\"h-4 w-4 mr-2\" />\n                  Go Home\n                </Button>\n                <Button\n                  className=\"flex-1\"\n                  onClick={this.handleRefresh}\n                  data-testid=\"button-refresh\"\n                >\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\n                  Try Again\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nexport function PageErrorBoundary({ children }: { children: ReactNode }) {\n  return <ErrorBoundary>{children}</ErrorBoundary>;\n}\n\nexport function withErrorBoundary<P extends object>(\n  WrappedComponent: React.ComponentType<P>,\n  fallback?: ReactNode\n) {\n  return function WithErrorBoundary(props: P) {\n    return (\n      <ErrorBoundary fallback={fallback}>\n        <WrappedComponent {...props} />\n      </ErrorBoundary>\n    );\n  };\n}\n\nexport default ErrorBoundary;\n","path":null,"size_bytes":3880,"size_tokens":null},"server/validation.ts":{"content":"import { z } from \"zod\";\nimport { Request, Response, NextFunction } from \"express\";\nimport { fromError } from \"zod-validation-error\";\n\nconst sanitizeString = (str: string): string => {\n  return str\n    .replace(/[<>]/g, '')\n    .trim();\n};\n\nconst sanitizeEmail = (email: string): string => {\n  return email.toLowerCase().trim();\n};\n\nexport const emailSchema = z.string()\n  .min(1, \"Email is required\")\n  .email(\"Invalid email format\")\n  .max(255, \"Email too long\")\n  .transform(sanitizeEmail);\n\nexport const passwordSchema = z.string()\n  .min(6, \"Password must be at least 6 characters\")\n  .max(128, \"Password too long\");\n\nexport const nameSchema = z.string()\n  .min(1, \"Name is required\")\n  .max(100, \"Name too long\")\n  .transform(sanitizeString);\n\nexport const idSchema = z.string()\n  .min(1, \"ID is required\")\n  .max(100, \"ID too long\")\n  .regex(/^[a-zA-Z0-9-_]+$/, \"Invalid ID format\");\n\nexport const loginSchema = z.object({\n  email: emailSchema,\n  password: z.string().min(1, \"Password is required\"),\n  rememberMe: z.boolean().optional(),\n});\n\nexport const signupSchema = z.object({\n  email: emailSchema,\n  password: passwordSchema,\n  name: nameSchema,\n  role: z.enum(['CEO', 'Managing Director', 'Director', 'Associate', 'Analyst']).optional(),\n  phone: z.string().max(20).optional().transform(val => val ? sanitizeString(val) : val),\n});\n\nexport const forgotPasswordSchema = z.object({\n  email: emailSchema,\n});\n\nexport const resetPasswordSchema = z.object({\n  token: z.string().min(1, \"Token is required\").max(128),\n  newPassword: passwordSchema,\n});\n\nexport const dealSchema = z.object({\n  name: z.string().min(1, \"Deal name is required\").max(200).transform(sanitizeString),\n  stage: z.enum(['Origination', 'Structuring', 'Diligence', 'Legal', 'Close', 'Closed Won', 'Closed Lost', 'Due Diligence', 'Negotiation', 'Closing', 'Execution', 'Signing', 'Qualification', 'Pitch', 'Documentation']).optional(),\n  value: z.number().min(0).max(1000000),\n  client: z.string().min(1, \"Client is required\").max(200).transform(sanitizeString),\n  sector: z.string().min(1, \"Sector is required\").max(100).transform(sanitizeString),\n  lead: z.string().min(1, \"Lead is required\").max(100).transform(sanitizeString),\n  progress: z.number().min(0).max(100).optional(),\n  status: z.enum(['Active', 'On Hold', 'Completed', 'Cancelled']).optional(),\n  description: z.string().max(5000).optional().transform(val => val ? sanitizeString(val) : val),\n  podTeam: z.array(z.object({\n    userId: z.string().optional(),\n    name: z.string().max(100),\n    role: z.string().max(50),\n    email: z.string().email().optional(),\n    phone: z.string().max(20).optional(),\n    slack: z.string().max(50).optional(),\n  })).optional(),\n  taggedInvestors: z.array(z.object({\n    id: z.string(),\n    name: z.string().max(100),\n    firm: z.string().max(200),\n    type: z.string().max(50),\n    status: z.string().max(50),\n    notes: z.string().max(1000).optional(),\n    email: z.string().email().optional(),\n    phone: z.string().max(20).optional(),\n    website: z.string().url().optional(),\n  })).optional(),\n}).partial().refine(data => Object.keys(data).length > 0, {\n  message: \"At least one field must be provided\",\n});\n\nexport const taskSchema = z.object({\n  title: z.string().min(1, \"Title is required\").max(200).transform(sanitizeString),\n  description: z.string().max(5000).optional().transform(val => val ? sanitizeString(val) : val),\n  dealId: z.string().optional(),\n  assignedTo: z.string().optional(),\n  assignedBy: z.string().optional(),\n  priority: z.enum(['Low', 'Medium', 'High', 'Urgent']).optional(),\n  dueDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Invalid date format (use YYYY-MM-DD)\"),\n  status: z.enum(['Pending', 'In Progress', 'Completed', 'Cancelled']).optional(),\n  type: z.string().min(1, \"Type is required\").max(50),\n});\n\nexport const meetingSchema = z.object({\n  title: z.string().min(1, \"Title is required\").max(200).transform(sanitizeString),\n  date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Invalid date format\"),\n  time: z.string().regex(/^\\d{2}:\\d{2}$/, \"Invalid time format (use HH:MM)\"),\n  attendees: z.array(z.string().max(100)).min(1, \"At least one attendee required\"),\n  location: z.string().max(200).optional().transform(val => val ? sanitizeString(val) : val),\n  dealId: z.string().optional(),\n  description: z.string().max(5000).optional().transform(val => val ? sanitizeString(val) : val),\n  timezone: z.string().max(50).optional(),\n  externalAttendees: z.array(z.object({\n    email: z.string().email(),\n    name: z.string().max(100),\n  })).optional(),\n});\n\nexport const notificationSchema = z.object({\n  userId: z.string().min(1),\n  type: z.enum(['info', 'success', 'warning', 'alert']),\n  title: z.string().min(1).max(200).transform(sanitizeString),\n  message: z.string().min(1).max(1000).transform(sanitizeString),\n  link: z.string().max(500).optional(),\n});\n\nexport const paginationSchema = z.object({\n  page: z.coerce.number().min(1).default(1),\n  limit: z.coerce.number().min(1).max(100).default(20),\n  sortBy: z.string().max(50).optional(),\n  sortOrder: z.enum(['asc', 'desc']).optional(),\n});\n\nexport const searchQuerySchema = z.object({\n  q: z.string().max(200).optional().transform(val => val ? sanitizeString(val) : val),\n  filter: z.string().max(100).optional(),\n});\n\nexport function validateBody<T extends z.ZodSchema>(schema: T) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const result = schema.safeParse(req.body);\n    if (!result.success) {\n      return res.status(400).json({ \n        error: fromError(result.error).toString(),\n        details: result.error.errors.map(e => ({\n          field: e.path.join('.'),\n          message: e.message,\n        })),\n      });\n    }\n    req.body = result.data;\n    next();\n  };\n}\n\nexport function validateQuery<T extends z.ZodSchema>(schema: T) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const result = schema.safeParse(req.query);\n    if (!result.success) {\n      return res.status(400).json({ \n        error: fromError(result.error).toString(),\n        details: result.error.errors.map(e => ({\n          field: e.path.join('.'),\n          message: e.message,\n        })),\n      });\n    }\n    req.query = result.data;\n    next();\n  };\n}\n\nexport function validateParams<T extends z.ZodSchema>(schema: T) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const result = schema.safeParse(req.params);\n    if (!result.success) {\n      return res.status(400).json({ \n        error: fromError(result.error).toString(),\n        details: result.error.errors.map(e => ({\n          field: e.path.join('.'),\n          message: e.message,\n        })),\n      });\n    }\n    req.params = result.data;\n    next();\n  };\n}\n\nexport const idParamSchema = z.object({\n  id: idSchema,\n});\n","path":null,"size_bytes":6809,"size_tokens":null},"server/logger.ts":{"content":"import { Request, Response, NextFunction } from 'express';\nimport { randomUUID } from 'crypto';\n\nexport type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\ninterface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  requestId?: string;\n  message: string;\n  method?: string;\n  path?: string;\n  statusCode?: number;\n  duration?: number;\n  userId?: string;\n  error?: {\n    name: string;\n    message: string;\n    stack?: string;\n  };\n  metadata?: Record<string, any>;\n}\n\nconst LOG_COLORS = {\n  debug: '\\x1b[36m',\n  info: '\\x1b[32m',\n  warn: '\\x1b[33m',\n  error: '\\x1b[31m',\n  reset: '\\x1b[0m',\n};\n\nfunction formatLog(entry: LogEntry): string {\n  const color = LOG_COLORS[entry.level] || LOG_COLORS.reset;\n  const timestamp = entry.timestamp;\n  const level = entry.level.toUpperCase().padEnd(5);\n  const requestId = entry.requestId ? `[${entry.requestId.slice(0, 8)}]` : '';\n  \n  let line = `${timestamp} ${color}${level}${LOG_COLORS.reset} ${requestId} ${entry.message}`;\n  \n  if (entry.method && entry.path) {\n    line += ` | ${entry.method} ${entry.path}`;\n  }\n  \n  if (entry.statusCode) {\n    const statusColor = entry.statusCode >= 400 ? LOG_COLORS.error : LOG_COLORS.info;\n    line += ` ${statusColor}${entry.statusCode}${LOG_COLORS.reset}`;\n  }\n  \n  if (entry.duration !== undefined) {\n    line += ` (${entry.duration}ms)`;\n  }\n  \n  if (entry.userId) {\n    line += ` user:${entry.userId.slice(0, 8)}`;\n  }\n  \n  return line;\n}\n\nclass Logger {\n  private static instance: Logger;\n  private requestMetrics: Map<string, { startTime: number; path: string; method: string }> = new Map();\n\n  static getInstance(): Logger {\n    if (!Logger.instance) {\n      Logger.instance = new Logger();\n    }\n    return Logger.instance;\n  }\n\n  private log(level: LogLevel, message: string, metadata?: Record<string, any>) {\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level,\n      message,\n      ...metadata,\n    };\n\n    console.log(formatLog(entry));\n\n    if (level === 'error' && entry.error?.stack) {\n      console.error(entry.error.stack);\n    }\n  }\n\n  debug(message: string, metadata?: Record<string, any>) {\n    if (process.env.NODE_ENV === 'development') {\n      this.log('debug', message, metadata);\n    }\n  }\n\n  info(message: string, metadata?: Record<string, any>) {\n    this.log('info', message, metadata);\n  }\n\n  warn(message: string, metadata?: Record<string, any>) {\n    this.log('warn', message, metadata);\n  }\n\n  error(message: string, error?: Error, metadata?: Record<string, any>) {\n    this.log('error', message, {\n      ...metadata,\n      error: error ? {\n        name: error.name,\n        message: error.message,\n        stack: error.stack,\n      } : undefined,\n    });\n  }\n\n  startRequest(requestId: string, path: string, method: string) {\n    this.requestMetrics.set(requestId, {\n      startTime: Date.now(),\n      path,\n      method,\n    });\n  }\n\n  endRequest(requestId: string, statusCode: number, userId?: string) {\n    const metrics = this.requestMetrics.get(requestId);\n    if (metrics) {\n      const duration = Date.now() - metrics.startTime;\n      this.info('Request completed', {\n        requestId,\n        method: metrics.method,\n        path: metrics.path,\n        statusCode,\n        duration,\n        userId,\n      });\n      this.requestMetrics.delete(requestId);\n    }\n  }\n\n  getMetrics() {\n    return {\n      activeRequests: this.requestMetrics.size,\n    };\n  }\n}\n\nexport const logger = Logger.getInstance();\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      requestId?: string;\n    }\n  }\n}\n\nexport function requestIdMiddleware(req: Request, res: Response, next: NextFunction) {\n  req.requestId = randomUUID();\n  res.setHeader('X-Request-ID', req.requestId);\n  next();\n}\n\nexport function requestLoggingMiddleware(req: Request, res: Response, next: NextFunction) {\n  const requestId = req.requestId || randomUUID();\n  const startTime = Date.now();\n\n  if (req.path.startsWith('/api')) {\n    logger.startRequest(requestId, req.path, req.method);\n  }\n\n  res.on('finish', () => {\n    if (req.path.startsWith('/api')) {\n      const duration = Date.now() - startTime;\n      const userId = (req.user as any)?.id;\n      const metadata = {\n        requestId,\n        method: req.method,\n        path: req.path,\n        statusCode: res.statusCode,\n        duration,\n        userId,\n      };\n      \n      logger.endRequest(requestId, res.statusCode, userId);\n      \n      if (res.statusCode >= 500) {\n        logger.error(`${req.method} ${req.path}`, undefined, metadata);\n      } else if (res.statusCode >= 400) {\n        logger.warn(`${req.method} ${req.path}`, metadata);\n      } else {\n        logger.info(`${req.method} ${req.path}`, metadata);\n      }\n    }\n  });\n\n  next();\n}\n\nexport function errorLoggingMiddleware(err: Error, req: Request, res: Response, next: NextFunction) {\n  logger.error('Unhandled error', err, {\n    requestId: req.requestId,\n    method: req.method,\n    path: req.path,\n    userId: (req.user as any)?.id,\n  });\n  next(err);\n}\n\nexport function logServerStart(port: number) {\n  logger.info(`Server started`, {\n    metadata: {\n      port,\n      environment: process.env.NODE_ENV || 'development',\n      nodeVersion: process.version,\n    },\n  });\n}\n\nexport function logDatabaseConnection(success: boolean, error?: Error) {\n  if (success) {\n    logger.info('Database connected successfully');\n  } else {\n    logger.error('Database connection failed', error);\n  }\n}\n\nexport function logAuthEvent(event: 'login' | 'logout' | 'signup' | 'password_reset', userId: string, success: boolean, requestId?: string) {\n  const message = success ? `${event} successful` : `${event} failed`;\n  const logFn = success ? logger.info.bind(logger) : logger.warn.bind(logger);\n  logFn(message, { requestId, userId, metadata: { event } });\n}\n","path":null,"size_bytes":5813,"size_tokens":null},"client/src/pages/ceo/InvestorDatabase.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useCurrentUser } from \"@/lib/api\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { toast } from \"sonner\";\nimport {\n  Building2,\n  Plus,\n  Search,\n  Edit2,\n  Trash2,\n  DollarSign,\n  Mail,\n  Phone,\n  Globe,\n  Filter,\n  Users,\n  Linkedin,\n} from \"lucide-react\";\n\ntype Investor = {\n  id: string;\n  name: string;\n  firm: string;\n  type: string;\n  focus?: string;\n  aum?: string;\n  checkSize?: string;\n  preferredStage?: string;\n  location?: string;\n  website?: string;\n  email?: string;\n  phone?: string;\n  linkedIn?: string;\n  notes?: string;\n  tags?: string[];\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n};\n\nconst investorTypes = [\n  \"Private Equity\",\n  \"Venture Capital\",\n  \"Strategic\",\n  \"Family Office\",\n  \"Hedge Fund\",\n  \"Institutional\",\n  \"Sovereign Wealth\",\n  \"Corporate\",\n];\n\nconst focusOptions = [\n  \"Technology\",\n  \"Healthcare\",\n  \"Financial Services\",\n  \"Consumer\",\n  \"Industrial\",\n  \"Energy\",\n  \"Real Estate\",\n  \"Media & Entertainment\",\n  \"Multi-sector\",\n];\n\nconst stageOptions = [\n  \"Seed\",\n  \"Early Stage\",\n  \"Growth\",\n  \"Late Stage\",\n  \"Buyout\",\n  \"Distressed\",\n  \"All Stages\",\n];\n\nconst emptyInvestor = {\n  name: \"\",\n  firm: \"\",\n  type: \"\",\n  focus: \"Multi-sector\",\n  aum: \"\",\n  checkSize: \"\",\n  preferredStage: \"\",\n  location: \"\",\n  website: \"\",\n  email: \"\",\n  phone: \"\",\n  linkedIn: \"\",\n  notes: \"\",\n};\n\nexport default function InvestorDatabase() {\n  const { data: currentUser } = useCurrentUser();\n  const queryClient = useQueryClient();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"all\");\n  const [showAddDialog, setShowAddDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [selectedInvestor, setSelectedInvestor] = useState<Investor | null>(null);\n  const [formData, setFormData] = useState(emptyInvestor);\n\n  const { data: investors = [], isLoading } = useQuery<Investor[]>({\n    queryKey: [\"/api/db-investors\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof emptyInvestor) => {\n      const response = await fetch(\"/api/db-investors\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to create investor\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-investors\"] });\n      setShowAddDialog(false);\n      setFormData(emptyInvestor);\n      toast.success(\"Investor added successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<typeof emptyInvestor> }) => {\n      const response = await fetch(`/api/db-investors/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to update investor\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-investors\"] });\n      setShowEditDialog(false);\n      setSelectedInvestor(null);\n      setFormData(emptyInvestor);\n      toast.success(\"Investor updated successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/db-investors/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to delete investor\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-investors\"] });\n      toast.success(\"Investor removed successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const filteredInvestors = investors.filter((investor) => {\n    const matchesSearch =\n      investor.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      investor.firm.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (investor.email?.toLowerCase().includes(searchTerm.toLowerCase()) || false);\n    const matchesType = typeFilter === \"all\" || investor.type === typeFilter;\n    return matchesSearch && matchesType;\n  });\n\n  const handleEdit = (investor: Investor) => {\n    setSelectedInvestor(investor);\n    setFormData({\n      name: investor.name,\n      firm: investor.firm,\n      type: investor.type,\n      focus: investor.focus || \"Multi-sector\",\n      aum: investor.aum || \"\",\n      checkSize: investor.checkSize || \"\",\n      preferredStage: investor.preferredStage || \"\",\n      location: investor.location || \"\",\n      website: investor.website || \"\",\n      email: investor.email || \"\",\n      phone: investor.phone || \"\",\n      linkedIn: investor.linkedIn || \"\",\n      notes: investor.notes || \"\",\n    });\n    setShowEditDialog(true);\n  };\n\n  const InvestorForm = ({ isEdit = false }: { isEdit?: boolean }) => (\n    <div className=\"grid gap-4 py-4 max-h-[60vh] overflow-y-auto pr-2\">\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"name\">Contact Name *</Label>\n          <Input\n            id=\"name\"\n            value={formData.name}\n            onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n            placeholder=\"John Smith\"\n            data-testid=\"input-investor-name\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"firm\">Firm Name *</Label>\n          <Input\n            id=\"firm\"\n            value={formData.firm}\n            onChange={(e) => setFormData({ ...formData, firm: e.target.value })}\n            placeholder=\"Acme Capital\"\n            data-testid=\"input-investor-firm\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"email\">Email</Label>\n          <Input\n            id=\"email\"\n            type=\"email\"\n            value={formData.email}\n            onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n            placeholder=\"john@acmecapital.com\"\n            data-testid=\"input-investor-email\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"phone\">Phone</Label>\n          <Input\n            id=\"phone\"\n            value={formData.phone}\n            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n            placeholder=\"+1 (555) 123-4567\"\n            data-testid=\"input-investor-phone\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"type\">Investor Type *</Label>\n          <Select\n            value={formData.type}\n            onValueChange={(value) => setFormData({ ...formData, type: value })}\n          >\n            <SelectTrigger data-testid=\"select-investor-type\">\n              <SelectValue placeholder=\"Select type\" />\n            </SelectTrigger>\n            <SelectContent>\n              {investorTypes.map((type) => (\n                <SelectItem key={type} value={type}>\n                  {type}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"stage\">Preferred Stage</Label>\n          <Select\n            value={formData.preferredStage}\n            onValueChange={(value) => setFormData({ ...formData, preferredStage: value })}\n          >\n            <SelectTrigger data-testid=\"select-investment-stage\">\n              <SelectValue placeholder=\"Select stage\" />\n            </SelectTrigger>\n            <SelectContent>\n              {stageOptions.map((stage) => (\n                <SelectItem key={stage} value={stage}>\n                  {stage}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"focus\">Sector Focus</Label>\n          <Select\n            value={formData.focus}\n            onValueChange={(value) => setFormData({ ...formData, focus: value })}\n          >\n            <SelectTrigger data-testid=\"select-sector-focus\">\n              <SelectValue placeholder=\"Select focus\" />\n            </SelectTrigger>\n            <SelectContent>\n              {focusOptions.map((focus) => (\n                <SelectItem key={focus} value={focus}>\n                  {focus}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"location\">Location</Label>\n          <Input\n            id=\"location\"\n            value={formData.location}\n            onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n            placeholder=\"New York, NY\"\n            data-testid=\"input-investor-location\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"aum\">AUM (Assets Under Management)</Label>\n          <Input\n            id=\"aum\"\n            value={formData.aum}\n            onChange={(e) => setFormData({ ...formData, aum: e.target.value })}\n            placeholder=\"$2.5B\"\n            data-testid=\"input-investor-aum\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"checkSize\">Check Size</Label>\n          <Input\n            id=\"checkSize\"\n            value={formData.checkSize}\n            onChange={(e) => setFormData({ ...formData, checkSize: e.target.value })}\n            placeholder=\"$10M - $50M\"\n            data-testid=\"input-investor-checksize\"\n          />\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"website\">Website</Label>\n          <Input\n            id=\"website\"\n            value={formData.website}\n            onChange={(e) => setFormData({ ...formData, website: e.target.value })}\n            placeholder=\"https://acmecapital.com\"\n            data-testid=\"input-investor-website\"\n          />\n        </div>\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"linkedIn\">LinkedIn</Label>\n          <Input\n            id=\"linkedIn\"\n            value={formData.linkedIn}\n            onChange={(e) => setFormData({ ...formData, linkedIn: e.target.value })}\n            placeholder=\"linkedin.com/in/johnsmith\"\n            data-testid=\"input-investor-linkedin\"\n          />\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"notes\">Notes</Label>\n        <Textarea\n          id=\"notes\"\n          value={formData.notes}\n          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n          placeholder=\"Key information about the investor...\"\n          rows={3}\n          data-testid=\"input-investor-notes\"\n        />\n      </div>\n    </div>\n  );\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Investor Database\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-display font-bold tracking-tight\">Investor Database</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Manage your investor contacts and relationships\n            </p>\n          </div>\n        <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>\n          <DialogTrigger asChild>\n            <Button className=\"gap-2\" data-testid=\"button-add-investor\">\n              <Plus className=\"h-4 w-4\" />\n              Add Investor\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Building2 className=\"h-5 w-5\" />\n                Add New Investor\n              </DialogTitle>\n              <DialogDescription>\n                Add a new investor contact to your database\n              </DialogDescription>\n            </DialogHeader>\n            <InvestorForm />\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setShowAddDialog(false)}>\n                Cancel\n              </Button>\n              <Button\n                onClick={() => createMutation.mutate(formData)}\n                disabled={createMutation.isPending || !formData.name || !formData.firm || !formData.type}\n                data-testid=\"button-save-investor\"\n              >\n                {createMutation.isPending ? \"Adding...\" : \"Add Investor\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-primary/20\">\n                <Building2 className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{investors.length}</p>\n                <p className=\"text-sm text-muted-foreground\">Total Investors</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-green-500/20\">\n                <DollarSign className=\"h-6 w-6 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">\n                  {investors.filter((i) => i.type === \"Private Equity\").length}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">PE Firms</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-blue-500/20\">\n                <Users className=\"h-6 w-6 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">\n                  {investors.filter((i) => i.type === \"Venture Capital\").length}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">VC Firms</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-purple-500/20\">\n                <Building2 className=\"h-6 w-6 text-purple-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">\n                  {investors.filter((i) => i.type === \"Family Office\").length}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Family Offices</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"border-border bg-card/50\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle>Investor Directory</CardTitle>\n              <CardDescription>Search and manage investor contacts</CardDescription>\n            </div>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search investors...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-9 bg-secondary/50\"\n                  data-testid=\"input-search-investors\"\n                />\n              </div>\n              <Select value={typeFilter} onValueChange={setTypeFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-filter-type\">\n                  <Filter className=\"h-4 w-4 mr-2\" />\n                  <SelectValue placeholder=\"Filter by type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Types</SelectItem>\n                  {investorTypes.map((type) => (\n                    <SelectItem key={type} value={type}>\n                      {type}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n          ) : filteredInvestors.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              {investors.length === 0 ? \"No investors in database. Add your first investor!\" : \"No investors match your search.\"}\n            </div>\n          ) : (\n            <ScrollArea className=\"h-[500px]\">\n              <Table>\n                <TableHeader>\n                  <TableRow className=\"border-border hover:bg-transparent\">\n                    <TableHead>Contact</TableHead>\n                    <TableHead>Firm</TableHead>\n                    <TableHead>Type</TableHead>\n                    <TableHead>Focus</TableHead>\n                    <TableHead>AUM</TableHead>\n                    <TableHead>Check Size</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredInvestors.map((investor) => (\n                    <TableRow key={investor.id} className=\"border-border\" data-testid={`row-investor-${investor.id}`}>\n                      <TableCell>\n                        <div>\n                          <p className=\"font-medium\">{investor.name}</p>\n                          <div className=\"flex items-center gap-2 text-xs text-muted-foreground mt-1\">\n                            {investor.email && (\n                              <span className=\"flex items-center gap-1\">\n                                <Mail className=\"h-3 w-3\" />\n                                {investor.email}\n                              </span>\n                            )}\n                          </div>\n                          {investor.phone && (\n                            <div className=\"flex items-center gap-1 text-xs text-muted-foreground mt-0.5\">\n                              <Phone className=\"h-3 w-3\" />\n                              {investor.phone}\n                            </div>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div>\n                          <p>{investor.firm}</p>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            {investor.website && (\n                              <a\n                                href={investor.website}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center gap-1 text-xs text-primary hover:underline\"\n                              >\n                                <Globe className=\"h-3 w-3\" />\n                              </a>\n                            )}\n                            {investor.linkedIn && (\n                              <a\n                                href={investor.linkedIn.startsWith('http') ? investor.linkedIn : `https://${investor.linkedIn}`}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center gap-1 text-xs text-primary hover:underline\"\n                              >\n                                <Linkedin className=\"h-3 w-3\" />\n                              </a>\n                            )}\n                          </div>\n                          {investor.location && (\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">{investor.location}</p>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\" className=\"bg-primary/10 text-primary border-primary/30\">\n                          {investor.type}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm\">{investor.focus || \"-\"}</span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm font-medium\">{investor.aum || \"-\"}</span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm\">{investor.checkSize || \"-\"}</span>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex gap-2 justify-end\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => handleEdit(investor)}\n                            data-testid={`button-edit-investor-${investor.id}`}\n                          >\n                            <Edit2 className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className=\"text-red-400 hover:bg-red-500/10\"\n                            onClick={() => {\n                              if (confirm(\"Are you sure you want to remove this investor?\")) {\n                                deleteMutation.mutate(investor.id);\n                              }\n                            }}\n                            data-testid={`button-delete-investor-${investor.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </ScrollArea>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Edit2 className=\"h-5 w-5\" />\n              Edit Investor\n            </DialogTitle>\n            <DialogDescription>\n              Update investor information\n            </DialogDescription>\n          </DialogHeader>\n          <InvestorForm isEdit />\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (selectedInvestor) {\n                  updateMutation.mutate({ id: selectedInvestor.id, data: formData });\n                }\n              }}\n              disabled={updateMutation.isPending || !formData.name || !formData.firm}\n              data-testid=\"button-update-investor\"\n            >\n              {updateMutation.isPending ? \"Updating...\" : \"Update Investor\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":25357,"size_tokens":null},"client/src/pages/ceo/UserManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useCurrentUser } from \"@/lib/api\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Users,\n  UserCheck,\n  UserX,\n  Clock,\n  Shield,\n  Ban,\n  RefreshCw,\n  UserCog,\n  FileText,\n  ChevronRight,\n  AlertTriangle,\n  UserPlus,\n  Mail,\n} from \"lucide-react\";\n\ntype User = {\n  id: string;\n  name: string;\n  email: string;\n  role: string;\n  accessLevel: string;\n  jobTitle?: string;\n  status: string;\n  createdAt: string;\n  avatar?: string;\n  twoFactorEnabled?: boolean;\n};\n\ntype AuditLog = {\n  id: string;\n  userId: string | null;\n  userName: string;\n  action: string;\n  entityType: string;\n  entityId: string | null;\n  entityName: string | null;\n  details: Record<string, any>;\n  ipAddress: string | null;\n  createdAt: string;\n};\n\nconst accessLevelColors: Record<string, string> = {\n  admin: \"bg-purple-500/20 text-purple-400 border-purple-500/30\",\n  standard: \"bg-green-500/20 text-green-400 border-green-500/30\",\n};\n\nconst getAccessLevelDisplay = (accessLevel: string) => {\n  return accessLevel === 'admin' ? 'Admin' : 'Standard';\n};\n\nconst getAccessLevelColor = (accessLevel: string) => {\n  return accessLevel === 'admin' ? accessLevelColors.admin : accessLevelColors.standard;\n};\n\nconst statusColors: Record<string, string> = {\n  active: \"bg-green-500/20 text-green-400 border-green-500/30\",\n  pending: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  suspended: \"bg-red-500/20 text-red-400 border-red-500/30\",\n  rejected: \"bg-gray-500/20 text-gray-400 border-gray-500/30\",\n};\n\nconst actionLabels: Record<string, string> = {\n  user_signup: \"User Registration\",\n  user_approved: \"User Approved\",\n  user_rejected: \"User Rejected\",\n  user_suspended: \"User Suspended\",\n  user_reactivated: \"User Reactivated\",\n  role_changed: \"Role Changed\",\n  login: \"Login\",\n  login_2fa: \"Login (2FA)\",\n  \"2fa_enabled\": \"2FA Enabled\",\n  \"2fa_disabled\": \"2FA Disabled\",\n  document_created: \"Document Created\",\n  document_updated: \"Document Updated\",\n  document_archived: \"Document Archived\",\n  investor_created: \"Investor Created\",\n  investor_updated: \"Investor Updated\",\n  investor_deactivated: \"Investor Deactivated\",\n};\n\nexport default function UserManagement() {\n  const { data: currentUser } = useCurrentUser();\n  const queryClient = useQueryClient();\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [showRoleDialog, setShowRoleDialog] = useState(false);\n  const [newRole, setNewRole] = useState(\"\");\n  const [showSuspendDialog, setShowSuspendDialog] = useState(false);\n  const [showInviteDialog, setShowInviteDialog] = useState(false);\n  const [inviteName, setInviteName] = useState(\"\");\n  const [inviteEmail, setInviteEmail] = useState(\"\");\n  const [inviteAccessLevel, setInviteAccessLevel] = useState(\"standard\");\n  const [inviteJobTitle, setInviteJobTitle] = useState(\"\");\n\n  const { data: allUsers = [], isLoading: loadingUsers } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: pendingUsers = [], isLoading: loadingPending } = useQuery<User[]>({\n    queryKey: [\"/api/admin/pending-users\"],\n  });\n\n  const { data: auditLogs = [], isLoading: loadingLogs } = useQuery<AuditLog[]>({\n    queryKey: [\"/api/admin/audit-logs\"],\n  });\n\n  const activeUsers = allUsers.filter(u => u.status === \"active\");\n  const suspendedUsers = allUsers.filter(u => u.status === \"suspended\");\n\n  const approveMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/users/${userId}/approve`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to approve user\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/pending-users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      toast.success(\"User approved successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/users/${userId}/reject`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to reject user\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/pending-users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      toast.success(\"User registration rejected\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const suspendMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/users/${userId}/suspend`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to suspend user\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      setShowSuspendDialog(false);\n      setSelectedUser(null);\n      toast.success(\"User suspended successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const reactivateMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/users/${userId}/reactivate`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to reactivate user\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      toast.success(\"User reactivated successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const changeRoleMutation = useMutation({\n    mutationFn: async ({ userId, accessLevel }: { userId: string; accessLevel: string }) => {\n      const response = await fetch(`/api/admin/users/${userId}/access-level`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ accessLevel }),\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to change role\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      setShowRoleDialog(false);\n      setSelectedUser(null);\n      setNewRole(\"\");\n      toast.success(\"User role updated successfully\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const inviteMutation = useMutation({\n    mutationFn: async (data: { name: string; email: string; accessLevel: string; jobTitle?: string }) => {\n      const response = await fetch(\"/api/admin/invite-user\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const result = await response.json();\n        throw new Error(result.error || \"Failed to invite user\");\n      }\n      return response.json();\n    },\n    onSuccess: (result) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/pending-users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/audit-logs\"] });\n      setShowInviteDialog(false);\n      setInviteName(\"\");\n      setInviteEmail(\"\");\n      setInviteAccessLevel(\"standard\");\n      setInviteJobTitle(\"\");\n      if (result.emailSent) {\n        toast.success(\"User invited successfully! They will receive an email to set up their account.\");\n      } else {\n        toast.warning(\"User created but invite email could not be sent. Use 'Resend Invite' to try again.\");\n      }\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const resendInviteMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/admin/users/${userId}/resend-invite`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || \"Failed to resend invite\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Invite email resent successfully!\");\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const getInitials = (name: string) => {\n    return name\n      .split(\" \")\n      .map((n) => n[0])\n      .join(\"\")\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"User Management\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-display font-bold tracking-tight\">User Management</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Manage user access, roles, and review audit logs\n            </p>\n          </div>\n          <Button \n            onClick={() => setShowInviteDialog(true)}\n            data-testid=\"button-invite-user\"\n          >\n            <UserPlus className=\"h-4 w-4 mr-2\" />\n            Invite User\n          </Button>\n        </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-primary/20\">\n                <Users className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{activeUsers.length}</p>\n                <p className=\"text-sm text-muted-foreground\">Active Users</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-amber-500/20\">\n                <Clock className=\"h-6 w-6 text-amber-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{pendingUsers.length}</p>\n                <p className=\"text-sm text-muted-foreground\">Pending Approval</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-red-500/20\">\n                <Ban className=\"h-6 w-6 text-red-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{suspendedUsers.length}</p>\n                <p className=\"text-sm text-muted-foreground\">Suspended</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border bg-card/50\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-3 rounded-lg bg-green-500/20\">\n                <Shield className=\"h-6 w-6 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{activeUsers.filter(u => u.twoFactorEnabled).length}</p>\n                <p className=\"text-sm text-muted-foreground\">2FA Enabled</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs defaultValue=\"pending\" className=\"space-y-4\">\n        <TabsList className=\"bg-secondary/50\">\n          <TabsTrigger value=\"pending\" className=\"gap-2\">\n            <Clock className=\"h-4 w-4\" />\n            Pending ({pendingUsers.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"active\" className=\"gap-2\">\n            <UserCheck className=\"h-4 w-4\" />\n            Active ({activeUsers.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"suspended\" className=\"gap-2\">\n            <Ban className=\"h-4 w-4\" />\n            Suspended ({suspendedUsers.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"audit\" className=\"gap-2\">\n            <FileText className=\"h-4 w-4\" />\n            Audit Logs\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"pending\">\n          <Card className=\"border-border bg-card/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"h-5 w-5 text-amber-500\" />\n                Pending Registrations\n              </CardTitle>\n              <CardDescription>\n                Review and approve new user registration requests\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loadingPending ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n              ) : pendingUsers.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No pending registrations\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"border-border hover:bg-transparent\">\n                      <TableHead>User</TableHead>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Job Title</TableHead>\n                      <TableHead>Requested On</TableHead>\n                      <TableHead className=\"text-right\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {pendingUsers.map((user) => (\n                      <TableRow key={user.id} className=\"border-border\" data-testid={`row-pending-user-${user.id}`}>\n                        <TableCell>\n                          <div className=\"flex items-center gap-3\">\n                            <Avatar className=\"h-9 w-9\">\n                              <AvatarImage src={user.avatar} />\n                              <AvatarFallback className=\"bg-primary/20 text-primary text-sm\">\n                                {getInitials(user.name)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <span className=\"font-medium\">{user.name}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-muted-foreground\">{user.email}</TableCell>\n                        <TableCell>\n                          {user.jobTitle ? (\n                            <Badge variant=\"outline\" className=\"bg-blue-500/20 text-blue-400 border-blue-500/30\">\n                              {user.jobTitle}\n                            </Badge>\n                          ) : (\n                            <span className=\"text-muted-foreground text-sm\">Not specified</span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-muted-foreground\">\n                          {format(new Date(user.createdAt), \"MMM d, yyyy\")}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex gap-2 justify-end\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              className=\"gap-1\"\n                              onClick={() => resendInviteMutation.mutate(user.id)}\n                              disabled={resendInviteMutation.isPending}\n                              data-testid={`button-resend-invite-${user.id}`}\n                            >\n                              <Mail className=\"h-4 w-4\" />\n                              Resend\n                            </Button>\n                            <AlertDialog>\n                              <AlertDialogTrigger asChild>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  className=\"gap-1 border-red-500/30 text-red-400 hover:bg-red-500/10\"\n                                  disabled={rejectMutation.isPending}\n                                  data-testid={`button-reject-${user.id}`}\n                                >\n                                  <UserX className=\"h-4 w-4\" />\n                                  Reject\n                                </Button>\n                              </AlertDialogTrigger>\n                              <AlertDialogContent>\n                                <AlertDialogHeader>\n                                  <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                                  <AlertDialogDescription>\n                                    This will reject {user.name}'s registration request. They will need to submit a new registration if they want to access the platform.\n                                  </AlertDialogDescription>\n                                </AlertDialogHeader>\n                                <AlertDialogFooter>\n                                  <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                  <AlertDialogAction onClick={() => rejectMutation.mutate(user.id)}>\n                                    Reject Registration\n                                  </AlertDialogAction>\n                                </AlertDialogFooter>\n                              </AlertDialogContent>\n                            </AlertDialog>\n                            <Button\n                              size=\"sm\"\n                              className=\"gap-1 bg-green-600 hover:bg-green-700\"\n                              onClick={() => approveMutation.mutate(user.id)}\n                              disabled={approveMutation.isPending}\n                              data-testid={`button-approve-${user.id}`}\n                            >\n                              <UserCheck className=\"h-4 w-4\" />\n                              Approve\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"active\">\n          <Card className=\"border-border bg-card/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <UserCheck className=\"h-5 w-5 text-green-500\" />\n                Active Users\n              </CardTitle>\n              <CardDescription>\n                Manage active team members and their roles\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loadingUsers ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n              ) : activeUsers.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No active users\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"border-border hover:bg-transparent\">\n                      <TableHead>User</TableHead>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Title</TableHead>\n                      <TableHead>Access Level</TableHead>\n                      <TableHead>2FA</TableHead>\n                      <TableHead className=\"text-right\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {activeUsers.map((user) => (\n                      <TableRow key={user.id} className=\"border-border\" data-testid={`row-active-user-${user.id}`}>\n                        <TableCell>\n                          <div className=\"flex items-center gap-3\">\n                            <Avatar className=\"h-9 w-9\">\n                              <AvatarImage src={user.avatar} />\n                              <AvatarFallback className=\"bg-primary/20 text-primary text-sm\">\n                                {getInitials(user.name)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <span className=\"font-medium\">{user.name}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-muted-foreground\">{user.email}</TableCell>\n                        <TableCell>\n                          {user.jobTitle ? (\n                            <Badge variant=\"outline\" className=\"bg-blue-500/20 text-blue-400 border-blue-500/30\">\n                              {user.jobTitle}\n                            </Badge>\n                          ) : (\n                            <span className=\"text-muted-foreground text-sm\">-</span>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className={getAccessLevelColor(user.accessLevel)}>\n                            {getAccessLevelDisplay(user.accessLevel)}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          {user.twoFactorEnabled ? (\n                            <Badge variant=\"outline\" className=\"bg-green-500/20 text-green-400 border-green-500/30\">\n                              Enabled\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"outline\" className=\"bg-gray-500/20 text-gray-400 border-gray-500/30\">\n                              Disabled\n                            </Badge>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex gap-2 justify-end\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              className=\"gap-1\"\n                              onClick={() => {\n                                setSelectedUser(user);\n                                setNewRole(user.accessLevel);\n                                setShowRoleDialog(true);\n                              }}\n                              data-testid={`button-change-role-${user.id}`}\n                            >\n                              <UserCog className=\"h-4 w-4\" />\n                              Access\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              className=\"gap-1 border-red-500/30 text-red-400 hover:bg-red-500/10\"\n                              onClick={() => {\n                                setSelectedUser(user);\n                                setShowSuspendDialog(true);\n                              }}\n                              data-testid={`button-suspend-${user.id}`}\n                            >\n                              <Ban className=\"h-4 w-4\" />\n                              Suspend\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"suspended\">\n          <Card className=\"border-border bg-card/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Ban className=\"h-5 w-5 text-red-500\" />\n                Suspended Users\n              </CardTitle>\n              <CardDescription>\n                Users who have been suspended from the platform\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loadingUsers ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n              ) : suspendedUsers.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No suspended users\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"border-border hover:bg-transparent\">\n                      <TableHead>User</TableHead>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Title</TableHead>\n                      <TableHead>Access Level</TableHead>\n                      <TableHead className=\"text-right\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {suspendedUsers.map((user) => (\n                      <TableRow key={user.id} className=\"border-border\" data-testid={`row-suspended-user-${user.id}`}>\n                        <TableCell>\n                          <div className=\"flex items-center gap-3\">\n                            <Avatar className=\"h-9 w-9 opacity-50\">\n                              <AvatarImage src={user.avatar} />\n                              <AvatarFallback className=\"bg-red-500/20 text-red-400 text-sm\">\n                                {getInitials(user.name)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <span className=\"font-medium text-muted-foreground\">{user.name}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-muted-foreground\">{user.email}</TableCell>\n                        <TableCell>\n                          {user.jobTitle ? (\n                            <Badge variant=\"outline\" className=\"bg-blue-500/20 text-blue-400 border-blue-500/30 opacity-50\">\n                              {user.jobTitle}\n                            </Badge>\n                          ) : (\n                            <span className=\"text-muted-foreground text-sm\">-</span>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className={`${getAccessLevelColor(user.accessLevel)} opacity-50`}>\n                            {getAccessLevelDisplay(user.accessLevel)}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <Button\n                            size=\"sm\"\n                            className=\"gap-1 bg-green-600 hover:bg-green-700\"\n                            onClick={() => reactivateMutation.mutate(user.id)}\n                            disabled={reactivateMutation.isPending}\n                            data-testid={`button-reactivate-${user.id}`}\n                          >\n                            <RefreshCw className=\"h-4 w-4\" />\n                            Reactivate\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"audit\">\n          <Card className=\"border-border bg-card/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <FileText className=\"h-5 w-5 text-primary\" />\n                Audit Logs\n              </CardTitle>\n              <CardDescription>\n                Security and activity logs for compliance\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loadingLogs ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading...</div>\n              ) : auditLogs.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No audit logs available\n                </div>\n              ) : (\n                <ScrollArea className=\"h-[500px]\">\n                  <div className=\"space-y-4\">\n                    {auditLogs.map((log, index) => (\n                      <div key={log.id}>\n                        <div className=\"flex items-start gap-4 py-3\" data-testid={`audit-log-${log.id}`}>\n                          <div className=\"p-2 rounded-lg bg-secondary/50 mt-0.5\">\n                            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <span className=\"font-medium\">{log.userName || \"System\"}</span>\n                              <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {actionLabels[log.action] || log.action}\n                              </Badge>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {log.entityType}: {log.entityName || log.entityId || \"N/A\"}\n                            </p>\n                            {log.details && Object.keys(log.details).length > 0 && (\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                {JSON.stringify(log.details)}\n                              </p>\n                            )}\n                            <p className=\"text-xs text-muted-foreground/60 mt-1\">\n                              {format(new Date(log.createdAt), \"MMM d, yyyy 'at' h:mm a\")}\n                              {log.ipAddress && `  ${log.ipAddress}`}\n                            </p>\n                          </div>\n                        </div>\n                        {index < auditLogs.length - 1 && <Separator />}\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={showRoleDialog} onOpenChange={setShowRoleDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <UserCog className=\"h-5 w-5\" />\n              Change Access Level\n            </DialogTitle>\n            <DialogDescription>\n              Update the platform access level for {selectedUser?.name}. This controls what features and data they can access.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Select value={newRole} onValueChange={setNewRole}>\n              <SelectTrigger data-testid=\"select-role\">\n                <SelectValue placeholder=\"Select access level\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"admin\">Admin (Full Access)</SelectItem>\n                <SelectItem value=\"standard\">Standard</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowRoleDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (selectedUser && newRole) {\n                  changeRoleMutation.mutate({ userId: selectedUser.id, accessLevel: newRole });\n                }\n              }}\n              disabled={changeRoleMutation.isPending || !newRole}\n              data-testid=\"button-confirm-role-change\"\n            >\n              {changeRoleMutation.isPending ? \"Updating...\" : \"Update Access\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showSuspendDialog} onOpenChange={setShowSuspendDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-red-400\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Suspend User\n            </DialogTitle>\n            <DialogDescription>\n              Are you sure you want to suspend {selectedUser?.name}? They will be immediately logged out and unable to access the platform.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowSuspendDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => {\n                if (selectedUser) {\n                  suspendMutation.mutate(selectedUser.id);\n                }\n              }}\n              disabled={suspendMutation.isPending}\n              data-testid=\"button-confirm-suspend\"\n            >\n              {suspendMutation.isPending ? \"Suspending...\" : \"Suspend User\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showInviteDialog} onOpenChange={setShowInviteDialog}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <UserPlus className=\"h-5 w-5 text-primary\" />\n              Invite New User\n            </DialogTitle>\n            <DialogDescription>\n              Send an invitation email to add a new team member. They will receive a link to set up their password.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"invite-name\">Full Name</Label>\n              <Input\n                id=\"invite-name\"\n                placeholder=\"John Smith\"\n                value={inviteName}\n                onChange={(e) => setInviteName(e.target.value)}\n                data-testid=\"input-invite-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"invite-email\">Email Address</Label>\n              <Input\n                id=\"invite-email\"\n                type=\"email\"\n                placeholder=\"john@equiturn.com\"\n                value={inviteEmail}\n                onChange={(e) => setInviteEmail(e.target.value)}\n                data-testid=\"input-invite-email\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"invite-access\">Access Level</Label>\n              <Select value={inviteAccessLevel} onValueChange={setInviteAccessLevel}>\n                <SelectTrigger data-testid=\"select-invite-access\">\n                  <SelectValue placeholder=\"Select access level\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"standard\">Standard</SelectItem>\n                  <SelectItem value=\"admin\">Admin (Full Access)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"invite-job-title\">Job Title (optional)</Label>\n              <Input\n                id=\"invite-job-title\"\n                placeholder=\"Analyst\"\n                value={inviteJobTitle}\n                onChange={(e) => setInviteJobTitle(e.target.value)}\n                data-testid=\"input-invite-job-title\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowInviteDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (inviteName && inviteEmail) {\n                  inviteMutation.mutate({\n                    name: inviteName,\n                    email: inviteEmail,\n                    accessLevel: inviteAccessLevel,\n                    jobTitle: inviteJobTitle || undefined,\n                  });\n                }\n              }}\n              disabled={inviteMutation.isPending || !inviteName || !inviteEmail}\n              data-testid=\"button-send-invite\"\n            >\n              {inviteMutation.isPending ? \"Sending...\" : \"Send Invitation\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":38825,"size_tokens":null},"client/src/pages/shared/DocumentManagement.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport {\n  FileText,\n  Upload,\n  Search,\n  Download,\n  Trash2,\n  Edit2,\n  FolderOpen,\n  File,\n  FileSpreadsheet,\n  FileImage,\n  FileCode,\n  Filter,\n  Plus,\n  Eye,\n  Briefcase,\n  Clock,\n  User,\n  Tag,\n  Loader2,\n  X,\n  Sparkles,\n  Save,\n  Copy,\n  FileSignature,\n  Scale,\n  HandshakeIcon,\n  ScrollText,\n  ClipboardList,\n  FileCheck,\n  Building2,\n  PenLine,\n  ExternalLink,\n} from \"lucide-react\";\nimport { useDocuments, useCreateDocument, useUpdateDocument, useDeleteDocument, useDealsListing, useCurrentUser, type DocumentRecord } from \"@/lib/api\";\n\ntype DocumentManagementProps = {\n  role?: 'CEO' | 'Employee';\n  defaultTab?: 'templates' | 'library';\n};\n\nconst documentCategories = [\n  { value: \"deal_document\", label: \"Deal Documents\" },\n  { value: \"compliance\", label: \"Compliance\" },\n  { value: \"template\", label: \"Templates\" },\n  { value: \"internal\", label: \"Internal\" },\n  { value: \"client\", label: \"Client Materials\" },\n  { value: \"general\", label: \"General\" },\n];\n\nconst documentTypes = [\n  { value: \"teaser\", label: \"Teaser\" },\n  { value: \"cim\", label: \"CIM\" },\n  { value: \"nda\", label: \"NDA\" },\n  { value: \"loi\", label: \"LOI\" },\n  { value: \"term_sheet\", label: \"Term Sheet\" },\n  { value: \"sba\", label: \"SBA\" },\n  { value: \"uploaded\", label: \"Uploaded File\" },\n  { value: \"report\", label: \"Report\" },\n  { value: \"presentation\", label: \"Presentation\" },\n  { value: \"spreadsheet\", label: \"Spreadsheet\" },\n  { value: \"other\", label: \"Other\" },\n];\n\nconst ibTemplates = [\n  { \n    id: \"nda\", \n    name: \"Non-Disclosure Agreement\", \n    shortName: \"NDA\",\n    description: \"Confidentiality agreement for deal discussions\",\n    icon: FileSignature,\n    category: \"Legal\"\n  },\n  { \n    id: \"teaser\", \n    name: \"Investment Teaser\", \n    shortName: \"Teaser\",\n    description: \"One-page investment opportunity summary\",\n    icon: FileText,\n    category: \"Marketing\"\n  },\n  { \n    id: \"cim\", \n    name: \"Confidential Info Memo\", \n    shortName: \"CIM\",\n    description: \"Comprehensive company information memorandum\",\n    icon: ScrollText,\n    category: \"Marketing\"\n  },\n  { \n    id: \"loi\", \n    name: \"Letter of Intent\", \n    shortName: \"LOI\",\n    description: \"Non-binding preliminary acquisition terms\",\n    icon: PenLine,\n    category: \"Legal\"\n  },\n  { \n    id: \"term_sheet\", \n    name: \"Term Sheet\", \n    shortName: \"Term Sheet\",\n    description: \"Key transaction terms and conditions\",\n    icon: ClipboardList,\n    category: \"Legal\"\n  },\n  { \n    id: \"engagement_letter\", \n    name: \"Engagement Letter\", \n    shortName: \"Engagement\",\n    description: \"Advisory services agreement\",\n    icon: HandshakeIcon,\n    category: \"Legal\"\n  },\n  { \n    id: \"due_diligence_checklist\", \n    name: \"Due Diligence Checklist\", \n    shortName: \"DD Checklist\",\n    description: \"Comprehensive DD request list\",\n    icon: FileCheck,\n    category: \"Operations\"\n  },\n  { \n    id: \"management_presentation\", \n    name: \"Management Presentation\", \n    shortName: \"Mgmt Pres\",\n    description: \"Executive team presentation outline\",\n    icon: Building2,\n    category: \"Marketing\"\n  },\n  { \n    id: \"fairness_opinion\", \n    name: \"Fairness Opinion\", \n    shortName: \"Fairness\",\n    description: \"Transaction fairness assessment\",\n    icon: Scale,\n    category: \"Analysis\"\n  },\n  { \n    id: \"process_letter\", \n    name: \"Process Letter\", \n    shortName: \"Process\",\n    description: \"Bid process instructions for buyers\",\n    icon: ScrollText,\n    category: \"Operations\"\n  },\n];\n\nconst getFileIcon = (mimeType?: string, type?: string) => {\n  if (mimeType?.includes('spreadsheet') || mimeType?.includes('excel') || type === 'spreadsheet') {\n    return <FileSpreadsheet className=\"h-5 w-5 text-green-500\" />;\n  }\n  if (mimeType?.includes('image')) {\n    return <FileImage className=\"h-5 w-5 text-purple-500\" />;\n  }\n  if (mimeType?.includes('pdf')) {\n    return <FileText className=\"h-5 w-5 text-red-500\" />;\n  }\n  if (mimeType?.includes('code') || mimeType?.includes('json') || mimeType?.includes('xml')) {\n    return <FileCode className=\"h-5 w-5 text-blue-500\" />;\n  }\n  return <File className=\"h-5 w-5 text-muted-foreground\" />;\n};\n\nconst formatFileSize = (bytes?: number) => {\n  if (!bytes) return \"-\";\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n};\n\nexport default function DocumentManagement({ role = 'CEO', defaultTab = 'templates' }: DocumentManagementProps) {\n  const { data: currentUser } = useCurrentUser();\n  const { data: documents = [], isLoading } = useDocuments();\n  const { data: deals = [] } = useDealsListing();\n  const createDocument = useCreateDocument();\n  const updateDocument = useUpdateDocument();\n  const deleteDocument = useDeleteDocument();\n\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n  const [dealFilter, setDealFilter] = useState<string>(\"all\");\n  const [showUploadDialog, setShowUploadDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showPreviewDialog, setShowPreviewDialog] = useState(false);\n  const [selectedDocument, setSelectedDocument] = useState<DocumentRecord | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  \n    const [selectedTemplate, setSelectedTemplate] = useState<typeof ibTemplates[0] | null>(null);\n  const [selectedDealForGeneration, setSelectedDealForGeneration] = useState<string>(\"none\");\n  const [generatedContent, setGeneratedContent] = useState<string>(\"\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [templateSearch, setTemplateSearch] = useState(\"\");\n\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const [uploadForm, setUploadForm] = useState({\n    type: \"uploaded\",\n    category: \"general\",\n    dealId: \"\",\n    tags: \"\",\n    files: [] as File[],\n  });\n\n  const filteredDocuments = documents.filter((doc) => {\n    const matchesSearch =\n      doc.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (doc.filename || \"\").toLowerCase().includes(searchTerm.toLowerCase()) ||\n      (doc.uploaderName || \"\").toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesCategory = categoryFilter === \"all\" || doc.category === categoryFilter;\n    const matchesDeal = dealFilter === \"all\" || doc.dealId === dealFilter;\n    return matchesSearch && matchesCategory && matchesDeal;\n  });\n  \n  const filteredTemplates = ibTemplates.filter((template) =>\n    template.name.toLowerCase().includes(templateSearch.toLowerCase()) ||\n    template.description.toLowerCase().includes(templateSearch.toLowerCase()) ||\n    template.category.toLowerCase().includes(templateSearch.toLowerCase())\n  );\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n    \n    const validFiles: File[] = [];\n    for (const file of Array.from(files)) {\n      if (file.size > 10 * 1024 * 1024) {\n        toast.error(`File \"${file.name}\" exceeds 10MB limit`);\n      } else {\n        validFiles.push(file);\n      }\n    }\n    \n    if (validFiles.length > 0) {\n      setUploadForm({ ...uploadForm, files: [...uploadForm.files, ...validFiles] });\n    }\n  };\n\n  const removeFile = (index: number) => {\n    setUploadForm({\n      ...uploadForm,\n      files: uploadForm.files.filter((_, i) => i !== index)\n    });\n  };\n\n  const handleUpload = async () => {\n    if (uploadForm.files.length === 0) {\n      toast.error(\"Please select at least one file\");\n      return;\n    }\n\n    setIsUploading(true);\n    const dealIdToUse = uploadForm.dealId === \"none\" ? undefined : uploadForm.dealId || undefined;\n    const selectedDeal = dealIdToUse ? deals.find(d => d.id === dealIdToUse) : undefined;\n    const tags = uploadForm.tags ? uploadForm.tags.split(',').map(t => t.trim()) : [];\n\n    let uploadedCount = 0;\n    let failedCount = 0;\n\n    try {\n      for (const file of uploadForm.files) {\n        try {\n          const base64Content = await new Promise<string>((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onloadend = () => resolve(reader.result as string);\n            reader.onerror = () => reject(new Error(\"Failed to read file\"));\n            reader.readAsDataURL(file);\n          });\n\n          await createDocument.mutateAsync({\n            title: file.name.replace(/\\.[^/.]+$/, \"\"),\n            type: uploadForm.type,\n            category: uploadForm.category,\n            filename: file.name,\n            originalName: file.name,\n            mimeType: file.type,\n            size: file.size,\n            content: base64Content,\n            dealId: dealIdToUse,\n            dealName: selectedDeal?.name || undefined,\n            tags,\n          });\n          uploadedCount++;\n        } catch (error) {\n          console.error(`Failed to upload ${file.name}:`, error);\n          failedCount++;\n        }\n      }\n\n      if (uploadedCount > 0) {\n        toast.success(`${uploadedCount} document(s) uploaded successfully${failedCount > 0 ? `, ${failedCount} failed` : ''}`);\n      } else {\n        toast.error(\"Failed to upload documents\");\n      }\n\n      setShowUploadDialog(false);\n      setUploadForm({\n        type: \"uploaded\",\n        category: \"general\",\n        dealId: \"\",\n        tags: \"\",\n        files: [],\n      });\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to upload documents\");\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handleEdit = (doc: DocumentRecord) => {\n    setSelectedDocument(doc);\n    setShowEditDialog(true);\n  };\n\n  const handleUpdateDocument = async (updates: Partial<DocumentRecord>) => {\n    if (!selectedDocument) return;\n\n    try {\n      await updateDocument.mutateAsync({ id: selectedDocument.id, updates });\n      toast.success(\"Document updated successfully\");\n      setShowEditDialog(false);\n      setSelectedDocument(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update document\");\n    }\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!confirm(\"Are you sure you want to delete this document?\")) return;\n\n    try {\n      await deleteDocument.mutateAsync(id);\n      toast.success(\"Document deleted successfully\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete document\");\n    }\n  };\n\n  const handleDownload = async (doc: DocumentRecord & { contentUnavailable?: boolean }) => {\n    // Check if legacy file is unavailable\n    if (doc.contentUnavailable) {\n      toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n      return;\n    }\n\n    try {\n      // Use the server download endpoint which handles all content types properly\n      const response = await fetch(`/api/documents/${doc.id}/download`);\n      \n      if (!response.ok) {\n        const error = await response.json().catch(() => ({ error: \"Download failed\" }));\n        toast.error(error.error || \"Failed to download document\");\n        return;\n      }\n      \n      // Create a blob from the response and download it\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = doc.originalName || doc.filename || `${doc.title}.pdf`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      toast.success(\"Download started\");\n    } catch (error) {\n      console.error('Download error:', error);\n      toast.error(\"Failed to download document\");\n    }\n  };\n\n  // Helper to infer mimeType from filename if not provided\n  const inferMimeType = (doc: DocumentRecord): string => {\n    if (doc.mimeType) return doc.mimeType;\n    const filename = (doc.originalName || doc.filename || '').toLowerCase();\n    if (filename.endsWith('.pdf')) return 'application/pdf';\n    if (filename.endsWith('.png')) return 'image/png';\n    if (filename.endsWith('.jpg') || filename.endsWith('.jpeg')) return 'image/jpeg';\n    if (filename.endsWith('.gif')) return 'image/gif';\n    if (filename.endsWith('.txt')) return 'text/plain';\n    if (filename.endsWith('.csv')) return 'text/csv';\n    if (filename.endsWith('.doc') || filename.endsWith('.docx')) return 'application/msword';\n    if (filename.endsWith('.xls') || filename.endsWith('.xlsx')) return 'application/vnd.ms-excel';\n    return '';\n  };\n\n  // Check if document can be viewed in browser\n  const canViewInBrowser = (doc: DocumentRecord & { contentUnavailable?: boolean }): boolean => {\n    // Can't view if content is unavailable (legacy files)\n    if (doc.contentUnavailable) return false;\n    const mimeType = inferMimeType(doc);\n    // PDFs and images can be viewed in browser\n    return mimeType.includes('pdf') || mimeType.includes('image') || mimeType.includes('text');\n  };\n\n  const handleViewInNewTab = async (doc: DocumentRecord & { contentUnavailable?: boolean }) => {\n    // Check if legacy file is unavailable\n    if (doc.contentUnavailable) {\n      toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n      return;\n    }\n\n    try {\n      // Use the server download endpoint and open the result in a new tab\n      const response = await fetch(`/api/documents/${doc.id}/download`);\n      \n      if (!response.ok) {\n        const error = await response.json().catch(() => ({ error: \"Failed to open document\" }));\n        toast.error(error.error || \"Failed to open document\");\n        return;\n      }\n      \n      // Create a blob URL and open it\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const newWindow = window.open(url, '_blank');\n      if (!newWindow) {\n        toast.error(\"Unable to open document. Please allow popups for this site.\");\n        window.URL.revokeObjectURL(url);\n      }\n      // Note: We don't revoke the URL immediately because the new window needs it\n    } catch (error) {\n      console.error('Failed to open document:', error);\n      toast.error(\"Failed to open document\");\n    }\n  };\n\n  const handlePreview = (doc: DocumentRecord) => {\n    setSelectedDocument(doc);\n    setShowPreviewDialog(true);\n  };\n  \n  const handleTemplateSelect = (template: typeof ibTemplates[0]) => {\n    setSelectedTemplate(template);\n    setGeneratedContent(\"\");\n    setIsEditing(false);\n  };\n  \n  const handleGenerateDocument = async () => {\n    if (!selectedTemplate) {\n      toast.error(\"Please select a template first\");\n      return;\n    }\n    \n    setIsGenerating(true);\n    \n    try {\n      const hasDeal = selectedDealForGeneration && selectedDealForGeneration !== \"none\";\n      const dealData = hasDeal ? deals.find(d => d.id === selectedDealForGeneration) : null;\n      \n      const response = await fetch('/api/generate-document', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({\n          templateName: selectedTemplate.name,\n          dealId: hasDeal ? selectedDealForGeneration : undefined,\n          deal: dealData,\n          compliance: { sec: true, finra: true, legal: true }\n        })\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to generate document');\n      }\n      \n      const data = await response.json();\n      setGeneratedContent(data.content);\n      toast.success(\"Document generated successfully!\");\n    } catch (error: any) {\n      console.error('Generation error:', error);\n      toast.error(error.message || \"Failed to generate document\");\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n  \n  const handleSaveGeneratedDocument = async () => {\n    if (!generatedContent || !selectedTemplate) {\n      toast.error(\"No document content to save\");\n      return;\n    }\n    \n    try {\n      const hasDeal = selectedDealForGeneration && selectedDealForGeneration !== \"none\";\n      const dealData = hasDeal ? deals.find(d => d.id === selectedDealForGeneration) : null;\n      const textEncoder = new TextEncoder();\n      const contentBytes = textEncoder.encode(generatedContent);\n      \n      // Convert UTF-8 bytes to base64 safely (handles non-ASCII characters)\n      const binaryString = Array.from(contentBytes, byte => String.fromCharCode(byte)).join('');\n      const base64Content = `data:text/plain;base64,${btoa(binaryString)}`;\n      \n      await createDocument.mutateAsync({\n        title: `${selectedTemplate.name}${dealData ? ` - ${dealData.name}` : ''}`,\n        type: selectedTemplate.id,\n        category: \"deal_document\",\n        filename: `${selectedTemplate.shortName.toLowerCase().replace(/\\s+/g, '_')}_${Date.now()}.txt`,\n        originalName: `${selectedTemplate.shortName}.txt`,\n        mimeType: 'text/plain',\n        size: contentBytes.length,\n        content: base64Content,\n        dealId: hasDeal ? selectedDealForGeneration : undefined,\n        dealName: dealData?.name || undefined,\n        tags: ['ai-generated', selectedTemplate.category.toLowerCase()],\n      });\n      \n      toast.success(\"Document saved to library!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to save document\");\n    }\n  };\n  \n  const handleCopyContent = () => {\n    navigator.clipboard.writeText(generatedContent);\n    toast.success(\"Content copied to clipboard!\");\n  };\n\n  const documentsByCategory = documentCategories.map(cat => ({\n    ...cat,\n    count: documents.filter(d => d.category === cat.value).length,\n  }));\n\n  return (\n    <Layout role={role} userName={currentUser?.name} pageTitle=\"Document Management\">\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-display font-bold tracking-tight\">Document Management</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Generate AI-powered documents or manage your document library\n            </p>\n          </div>\n          <div className=\"flex gap-2\">\n            <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" className=\"gap-2\" data-testid=\"button-upload-document\">\n                  <Upload className=\"h-4 w-4\" />\n                  Upload\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-lg\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <Upload className=\"h-5 w-5\" />\n                    Upload Document\n                  </DialogTitle>\n                  <DialogDescription>\n                    Upload a new document to the platform\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"grid gap-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Files *</Label>\n                    <div className=\"border-2 border-dashed rounded-lg p-6 text-center hover:border-primary/50 transition-colors\">\n                      <input\n                        ref={fileInputRef}\n                        type=\"file\"\n                        multiple\n                        onChange={handleFileSelect}\n                        className=\"hidden\"\n                        accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.json,.xml,.jpg,.jpeg,.png,.gif\"\n                        data-testid=\"input-file-upload\"\n                      />\n                      <div\n                        onClick={() => fileInputRef.current?.click()}\n                        className=\"cursor-pointer\"\n                      >\n                        <Upload className=\"h-8 w-8 mx-auto text-muted-foreground mb-2\" />\n                        <p className=\"text-sm text-muted-foreground\">\n                          Click to select files (max 10MB each)\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          You can select multiple files at once\n                        </p>\n                      </div>\n                    </div>\n                    {uploadForm.files.length > 0 && (\n                      <div className=\"space-y-2 mt-3 max-h-32 overflow-y-auto\">\n                        {uploadForm.files.map((file, index) => (\n                          <div key={index} className=\"flex items-center justify-between p-2 bg-secondary/50 rounded-lg\">\n                            <div className=\"flex items-center gap-2 min-w-0\">\n                              {getFileIcon(file.type)}\n                              <span className=\"text-sm truncate\">{file.name}</span>\n                              <span className=\"text-xs text-muted-foreground\">({(file.size / 1024).toFixed(1)} KB)</span>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => removeFile(index)}\n                            >\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Type</Label>\n                      <Select\n                        value={uploadForm.type}\n                        onValueChange={(value) => setUploadForm({ ...uploadForm, type: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-document-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {documentTypes.map((type) => (\n                            <SelectItem key={type.value} value={type.value}>\n                              {type.label}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Category</Label>\n                      <Select\n                        value={uploadForm.category}\n                        onValueChange={(value) => setUploadForm({ ...uploadForm, category: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-document-category\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {documentCategories.map((cat) => (\n                            <SelectItem key={cat.value} value={cat.value}>\n                              {cat.label}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label>Associate with Deal (optional)</Label>\n                    <Select\n                      value={uploadForm.dealId}\n                      onValueChange={(value) => setUploadForm({ ...uploadForm, dealId: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-document-deal\">\n                        <SelectValue placeholder=\"Select a deal\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"none\">No deal association</SelectItem>\n                        {deals.map((deal) => (\n                          <SelectItem key={deal.id} value={deal.id}>\n                            {deal.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"doc-tags\">Tags (comma-separated)</Label>\n                    <Input\n                      id=\"doc-tags\"\n                      value={uploadForm.tags}\n                      onChange={(e) => setUploadForm({ ...uploadForm, tags: e.target.value })}\n                      placeholder=\"e.g., confidential, quarterly, draft\"\n                      data-testid=\"input-document-tags\"\n                    />\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button variant=\"outline\" onClick={() => setShowUploadDialog(false)}>\n                    Cancel\n                  </Button>\n                  <Button\n                    onClick={handleUpload}\n                    disabled={isUploading || createDocument.isPending || uploadForm.files.length === 0}\n                    data-testid=\"button-confirm-upload\"\n                  >\n                    {isUploading || createDocument.isPending ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Uploading {uploadForm.files.length} file(s)...\n                      </>\n                    ) : (\n                      `Upload ${uploadForm.files.length > 0 ? `(${uploadForm.files.length})` : ''}`\n                    )}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </div>\n\n        {defaultTab === 'templates' && (\n          <div className=\"space-y-0\">\n            <div className=\"grid grid-cols-12 gap-6 min-h-[600px]\">\n              <div className=\"col-span-3\">\n                <Card className=\"h-full border-border\">\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">IB Templates</CardTitle>\n                    <div className=\"relative mt-2\">\n                      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search templates...\"\n                        value={templateSearch}\n                        onChange={(e) => setTemplateSearch(e.target.value)}\n                        className=\"pl-9 h-9 text-sm\"\n                        data-testid=\"input-search-templates\"\n                      />\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"p-0\">\n                    <ScrollArea className=\"h-[500px]\">\n                      <div className=\"space-y-1 px-3 pb-3\">\n                        {filteredTemplates.map((template) => {\n                          const Icon = template.icon;\n                          return (\n                            <div\n                              key={template.id}\n                              onClick={() => handleTemplateSelect(template)}\n                              className={`p-3 rounded-lg cursor-pointer transition-all hover:bg-secondary/80 ${\n                                selectedTemplate?.id === template.id \n                                  ? 'bg-primary/10 border border-primary/30' \n                                  : 'border border-transparent'\n                              }`}\n                              data-testid={`template-${template.id}`}\n                            >\n                              <div className=\"flex items-start gap-3\">\n                                <div className={`p-2 rounded-md ${\n                                  selectedTemplate?.id === template.id \n                                    ? 'bg-primary/20 text-primary' \n                                    : 'bg-secondary text-muted-foreground'\n                                }`}>\n                                  <Icon className=\"h-4 w-4\" />\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"font-medium text-sm truncate\">{template.name}</p>\n                                  <p className=\"text-xs text-muted-foreground line-clamp-2 mt-0.5\">\n                                    {template.description}\n                                  </p>\n                                  <Badge variant=\"outline\" className=\"mt-1.5 text-[10px] px-1.5 py-0\">\n                                    {template.category}\n                                  </Badge>\n                                </div>\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </ScrollArea>\n                  </CardContent>\n                </Card>\n              </div>\n              \n              <div className=\"col-span-9\">\n                <Card className=\"h-full border-border\">\n                  <CardHeader className=\"pb-3 border-b\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle className=\"text-base\">\n                          {selectedTemplate ? selectedTemplate.name : 'Select a Template'}\n                        </CardTitle>\n                        <CardDescription>\n                          {selectedTemplate \n                            ? selectedTemplate.description \n                            : 'Choose a template from the left panel to generate a document'}\n                        </CardDescription>\n                      </div>\n                      {selectedTemplate && (\n                        <div className=\"flex items-center gap-2\">\n                          <Select\n                            value={selectedDealForGeneration}\n                            onValueChange={setSelectedDealForGeneration}\n                          >\n                            <SelectTrigger className=\"w-48\" data-testid=\"select-generation-deal\">\n                              <Briefcase className=\"h-4 w-4 mr-2\" />\n                              <SelectValue placeholder=\"Link to deal\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"none\">No deal</SelectItem>\n                              {deals.map((deal) => (\n                                <SelectItem key={deal.id} value={deal.id}>\n                                  {deal.name}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <Button\n                            onClick={handleGenerateDocument}\n                            disabled={isGenerating}\n                            className=\"gap-2\"\n                            data-testid=\"button-generate-document\"\n                          >\n                            {isGenerating ? (\n                              <>\n                                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                                Generating...\n                              </>\n                            ) : (\n                              <>\n                                <Sparkles className=\"h-4 w-4\" />\n                                Generate\n                              </>\n                            )}\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"p-0 flex-1\">\n                    {!selectedTemplate ? (\n                      <div className=\"flex flex-col items-center justify-center h-[500px] text-center p-8\">\n                        <div className=\"w-16 h-16 rounded-full bg-secondary flex items-center justify-center mb-4\">\n                          <FileText className=\"h-8 w-8 text-muted-foreground\" />\n                        </div>\n                        <h3 className=\"font-semibold text-lg mb-2\">No Template Selected</h3>\n                        <p className=\"text-muted-foreground max-w-md\">\n                          Select an investment banking template from the left panel to generate a professional document using AI.\n                        </p>\n                      </div>\n                    ) : !generatedContent ? (\n                      <div className=\"flex flex-col items-center justify-center h-[500px] text-center p-8\">\n                        <div className=\"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                          <Sparkles className=\"h-8 w-8 text-primary\" />\n                        </div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Ready to Generate</h3>\n                        <p className=\"text-muted-foreground max-w-md mb-4\">\n                          Click \"Generate\" to create a {selectedTemplate.name} document. \n                          {selectedDealForGeneration && selectedDealForGeneration !== \"none\" && ' The document will be customized for the selected deal.'}\n                        </p>\n                        <Button\n                          onClick={handleGenerateDocument}\n                          disabled={isGenerating}\n                          size=\"lg\"\n                          className=\"gap-2\"\n                        >\n                          {isGenerating ? (\n                            <>\n                              <Loader2 className=\"h-4 w-4 animate-spin\" />\n                              Generating...\n                            </>\n                          ) : (\n                            <>\n                              <Sparkles className=\"h-4 w-4\" />\n                              Generate Document\n                            </>\n                          )}\n                        </Button>\n                      </div>\n                    ) : (\n                      <div className=\"flex flex-col h-[500px]\">\n                        <div className=\"flex items-center justify-between px-4 py-2 border-b bg-secondary/30\">\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"secondary\" className=\"gap-1\">\n                              <Sparkles className=\"h-3 w-3\" />\n                              AI Generated\n                            </Badge>\n                            {isEditing && (\n                              <Badge variant=\"outline\" className=\"gap-1\">\n                                <Edit2 className=\"h-3 w-3\" />\n                                Editing\n                              </Badge>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={handleCopyContent}\n                              className=\"gap-1\"\n                              data-testid=\"button-copy-content\"\n                            >\n                              <Copy className=\"h-4 w-4\" />\n                              Copy\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setIsEditing(!isEditing)}\n                              className=\"gap-1\"\n                              data-testid=\"button-toggle-edit\"\n                            >\n                              <Edit2 className=\"h-4 w-4\" />\n                              {isEditing ? 'Preview' : 'Edit'}\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              onClick={handleSaveGeneratedDocument}\n                              className=\"gap-1\"\n                              data-testid=\"button-save-document\"\n                            >\n                              <Save className=\"h-4 w-4\" />\n                              Save to Library\n                            </Button>\n                          </div>\n                        </div>\n                        <ScrollArea className=\"flex-1 p-4\">\n                          {isEditing ? (\n                            <Textarea\n                              value={generatedContent}\n                              onChange={(e) => setGeneratedContent(e.target.value)}\n                              className=\"min-h-[440px] font-mono text-sm resize-none\"\n                              data-testid=\"textarea-document-content\"\n                            />\n                          ) : (\n                            <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                              <pre className=\"whitespace-pre-wrap font-sans text-sm leading-relaxed\">\n                                {generatedContent}\n                              </pre>\n                            </div>\n                          )}\n                        </ScrollArea>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {defaultTab === 'library' && (\n          <div className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-6 gap-4\">\n              {documentsByCategory.map((cat) => (\n                <Card\n                  key={cat.value}\n                  className={`border-border bg-card/50 cursor-pointer transition-colors hover:border-primary/50 ${\n                    categoryFilter === cat.value ? \"border-primary\" : \"\"\n                  }`}\n                  onClick={() => setCategoryFilter(categoryFilter === cat.value ? \"all\" : cat.value)}\n                >\n                  <CardContent className=\"pt-4 pb-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-2xl font-bold\">{cat.count}</p>\n                        <p className=\"text-xs text-muted-foreground\">{cat.label}</p>\n                      </div>\n                      <FolderOpen className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n\n            <Card className=\"border-border bg-card/50\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle>All Documents</CardTitle>\n                    <CardDescription>\n                      {filteredDocuments.length} document{filteredDocuments.length !== 1 ? \"s\" : \"\"} found\n                    </CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"relative w-64\">\n                      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search documents...\"\n                        value={searchTerm}\n                        onChange={(e) => setSearchTerm(e.target.value)}\n                        className=\"pl-9 bg-secondary/50\"\n                        data-testid=\"input-search-documents\"\n                      />\n                    </div>\n                    <Select value={dealFilter} onValueChange={setDealFilter}>\n                      <SelectTrigger className=\"w-48\" data-testid=\"select-filter-deal\">\n                        <Briefcase className=\"h-4 w-4 mr-2\" />\n                        <SelectValue placeholder=\"Filter by deal\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"all\">All Deals</SelectItem>\n                        {deals.map((deal) => (\n                          <SelectItem key={deal.id} value={deal.id}>\n                            {deal.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    {(categoryFilter !== \"all\" || dealFilter !== \"all\") && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setCategoryFilter(\"all\");\n                          setDealFilter(\"all\");\n                        }}\n                      >\n                        Clear Filters\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <div className=\"text-center py-8\">\n                    <Loader2 className=\"h-8 w-8 animate-spin mx-auto text-muted-foreground\" />\n                    <p className=\"text-muted-foreground mt-2\">Loading documents...</p>\n                  </div>\n                ) : filteredDocuments.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    {documents.length === 0\n                      ? \"No documents yet. Upload your first document or generate one using AI!\"\n                      : \"No documents match your filters.\"}\n                  </div>\n                ) : (\n                  <ScrollArea className=\"h-[500px]\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow className=\"border-border hover:bg-transparent\">\n                          <TableHead>Document</TableHead>\n                          <TableHead>Type</TableHead>\n                          <TableHead>Category</TableHead>\n                          <TableHead>Deal</TableHead>\n                          <TableHead>Size</TableHead>\n                          <TableHead>Uploaded</TableHead>\n                          <TableHead className=\"text-right\">Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {filteredDocuments.map((doc) => (\n                          <TableRow\n                            key={doc.id}\n                            className=\"border-border\"\n                            data-testid={`row-document-${doc.id}`}\n                          >\n                            <TableCell>\n                              <div className=\"flex items-center gap-3\">\n                                {getFileIcon(doc.mimeType, doc.type)}\n                                <div>\n                                  <p className=\"font-medium\">{doc.title}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{doc.filename}</p>\n                                </div>\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <Badge variant=\"outline\" className=\"bg-primary/10 text-primary border-primary/30\">\n                                {documentTypes.find(t => t.value === doc.type)?.label || doc.type}\n                              </Badge>\n                            </TableCell>\n                            <TableCell>\n                              <span className=\"text-sm\">\n                                {documentCategories.find(c => c.value === doc.category)?.label || doc.category}\n                              </span>\n                            </TableCell>\n                            <TableCell>\n                              {doc.dealName ? (\n                                <div className=\"flex items-center gap-1 text-sm\">\n                                  <Briefcase className=\"h-3 w-3\" />\n                                  {doc.dealName}\n                                </div>\n                              ) : (\n                                <span className=\"text-muted-foreground\">-</span>\n                              )}\n                            </TableCell>\n                            <TableCell>\n                              <span className=\"text-sm\">{formatFileSize(doc.size)}</span>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"space-y-0.5\">\n                                <p className=\"text-sm\">{format(new Date(doc.createdAt), \"MMM d, yyyy\")}</p>\n                                <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                  <User className=\"h-3 w-3\" />\n                                  {doc.uploaderName || \"Unknown\"}\n                                </p>\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              <div className=\"flex gap-1 justify-end\">\n                                {doc.content && (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    onClick={() => handlePreview(doc)}\n                                    className=\"h-8 w-8\"\n                                    title=\"Preview\"\n                                    data-testid={`button-preview-${doc.id}`}\n                                  >\n                                    <Eye className=\"h-4 w-4\" />\n                                  </Button>\n                                )}\n                                {doc.content && canViewInBrowser(doc) && (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    onClick={() => handleViewInNewTab(doc)}\n                                    className=\"h-8 w-8\"\n                                    title=\"Open in new tab\"\n                                    data-testid={`button-view-${doc.id}`}\n                                  >\n                                    <ExternalLink className=\"h-4 w-4\" />\n                                  </Button>\n                                )}\n                                {doc.content && (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    onClick={() => handleDownload(doc)}\n                                    className=\"h-8 w-8\"\n                                    title=\"Download\"\n                                    data-testid={`button-download-${doc.id}`}\n                                  >\n                                    <Download className=\"h-4 w-4\" />\n                                  </Button>\n                                )}\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => handleEdit(doc)}\n                                  className=\"h-8 w-8\"\n                                  data-testid={`button-edit-${doc.id}`}\n                                >\n                                  <Edit2 className=\"h-4 w-4\" />\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => handleDelete(doc.id)}\n                                  className=\"h-8 w-8 text-destructive hover:text-destructive\"\n                                  data-testid={`button-delete-${doc.id}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </ScrollArea>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        )}\n      </div>\n\n      <Dialog open={showPreviewDialog} onOpenChange={setShowPreviewDialog}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh]\">\n          <DialogHeader>\n            <div className=\"flex items-center justify-between\">\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Eye className=\"h-5 w-5\" />\n                {selectedDocument?.title}\n              </DialogTitle>\n              {selectedDocument && (\n                <div className=\"flex items-center gap-2 mr-8\">\n                  {canViewInBrowser(selectedDocument) && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleViewInNewTab(selectedDocument)}\n                      data-testid=\"button-view-new-tab\"\n                    >\n                      <ExternalLink className=\"h-4 w-4 mr-2\" />\n                      Open in New Tab\n                    </Button>\n                  )}\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleDownload(selectedDocument)}\n                    data-testid=\"button-download-preview\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Download\n                  </Button>\n                </div>\n              )}\n            </div>\n          </DialogHeader>\n          <ScrollArea className=\"h-[60vh]\">\n            {selectedDocument?.content && (\n              selectedDocument.mimeType?.includes('text') || selectedDocument.type === 'text/plain' ? (\n                <pre className=\"whitespace-pre-wrap font-sans text-sm p-4 bg-secondary/30 rounded-lg\">\n                  {atob(selectedDocument.content.split(',')[1] || '')}\n                </pre>\n              ) : selectedDocument.mimeType?.includes('image') ? (\n                <img src={selectedDocument.content} alt={selectedDocument.title} className=\"max-w-full\" />\n              ) : selectedDocument.mimeType?.includes('pdf') ? (\n                <iframe src={selectedDocument.content} className=\"w-full h-[55vh]\" title={selectedDocument.title} />\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <FileText className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n                  <p>Preview not available for this file type.</p>\n                  <Button\n                    variant=\"outline\"\n                    className=\"mt-4\"\n                    onClick={() => selectedDocument && handleDownload(selectedDocument)}\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Download to view\n                  </Button>\n                </div>\n              )\n            )}\n          </ScrollArea>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Edit2 className=\"h-5 w-5\" />\n              Edit Document\n            </DialogTitle>\n          </DialogHeader>\n          {selectedDocument && (\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-title\">Title</Label>\n                <Input\n                  id=\"edit-title\"\n                  value={selectedDocument.title}\n                  onChange={(e) => setSelectedDocument({ ...selectedDocument, title: e.target.value })}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Type</Label>\n                  <Select\n                    value={selectedDocument.type}\n                    onValueChange={(value) => setSelectedDocument({ ...selectedDocument, type: value })}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {documentTypes.map((type) => (\n                        <SelectItem key={type.value} value={type.value}>\n                          {type.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Category</Label>\n                  <Select\n                    value={selectedDocument.category}\n                    onValueChange={(value) => setSelectedDocument({ ...selectedDocument, category: value })}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {documentCategories.map((cat) => (\n                        <SelectItem key={cat.value} value={cat.value}>\n                          {cat.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Associate with Deal</Label>\n                <Select\n                  value={selectedDocument.dealId || \"none\"}\n                  onValueChange={(value) => {\n                    const dealIdToUse = value === \"none\" ? undefined : value;\n                    const deal = dealIdToUse ? deals.find(d => d.id === dealIdToUse) : undefined;\n                    setSelectedDocument({\n                      ...selectedDocument,\n                      dealId: dealIdToUse,\n                      dealName: deal?.name || undefined,\n                    });\n                  }}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"No deal association\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">No deal association</SelectItem>\n                    {deals.map((deal) => (\n                      <SelectItem key={deal.id} value={deal.id}>\n                        {deal.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() =>\n                handleUpdateDocument({\n                  title: selectedDocument?.title,\n                  type: selectedDocument?.type,\n                  category: selectedDocument?.category,\n                  dealId: selectedDocument?.dealId,\n                  dealName: selectedDocument?.dealName,\n                })\n              }\n              disabled={updateDocument.isPending}\n            >\n              {updateDocument.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Saving...\n                </>\n              ) : (\n                \"Save Changes\"\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":56673,"size_tokens":null},"client/src/pages/ceo/AuditLogs.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useCurrentUser } from \"@/lib/api\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { format } from \"date-fns\";\nimport {\n  Search,\n  Filter,\n  FileText,\n  User,\n  Briefcase,\n  Clock,\n  Shield,\n  Activity,\n  Download,\n  RefreshCw,\n  ChevronRight,\n  Eye,\n  Calendar,\n} from \"lucide-react\";\n\ntype AuditLog = {\n  id: string;\n  userId: string | null;\n  userName: string;\n  action: string;\n  entityType: string;\n  entityId: string | null;\n  entityName: string | null;\n  details: Record<string, any>;\n  ipAddress: string | null;\n  createdAt: string;\n  timestamp: string;\n};\n\nconst actionLabels: Record<string, string> = {\n  user_signup: \"User Registration\",\n  user_approved: \"User Approved\",\n  user_rejected: \"User Rejected\",\n  user_suspended: \"User Suspended\",\n  user_reactivated: \"User Reactivated\",\n  role_changed: \"Role Changed\",\n  login: \"Login\",\n  login_failed: \"Login Failed\",\n  logout: \"Logout\",\n  login_2fa: \"Login (2FA)\",\n  \"2fa_enabled\": \"2FA Enabled\",\n  \"2fa_disabled\": \"2FA Disabled\",\n  deal_created: \"Deal Created\",\n  deal_updated: \"Deal Updated\",\n  deal_deleted: \"Deal Deleted\",\n  deal_stage_changed: \"Deal Stage Changed\",\n  task_created: \"Task Created\",\n  task_updated: \"Task Updated\",\n  task_completed: \"Task Completed\",\n  task_deleted: \"Task Deleted\",\n  document_created: \"Document Created\",\n  document_updated: \"Document Updated\",\n  document_deleted: \"Document Deleted\",\n  document_archived: \"Document Archived\",\n  document_downloaded: \"Document Downloaded\",\n  investor_created: \"Investor Created\",\n  investor_updated: \"Investor Updated\",\n  investor_deleted: \"Investor Deleted\",\n  investor_deactivated: \"Investor Deactivated\",\n  meeting_created: \"Meeting Created\",\n  meeting_updated: \"Meeting Updated\",\n  meeting_deleted: \"Meeting Deleted\",\n  message_sent: \"Message Sent\",\n  password_reset: \"Password Reset\",\n  password_changed: \"Password Changed\",\n};\n\nconst entityTypeIcons: Record<string, any> = {\n  user: User,\n  deal: Briefcase,\n  task: FileText,\n  document: FileText,\n  investor: User,\n  meeting: Calendar,\n  message: Activity,\n  auth: Shield,\n};\n\nconst actionCategories: Record<string, string> = {\n  user_signup: \"user\",\n  user_approved: \"user\",\n  user_rejected: \"user\",\n  user_suspended: \"user\",\n  user_reactivated: \"user\",\n  role_changed: \"user\",\n  login: \"auth\",\n  login_failed: \"auth\",\n  logout: \"auth\",\n  login_2fa: \"auth\",\n  \"2fa_enabled\": \"auth\",\n  \"2fa_disabled\": \"auth\",\n  deal_created: \"deal\",\n  deal_updated: \"deal\",\n  deal_deleted: \"deal\",\n  deal_stage_changed: \"deal\",\n  task_created: \"task\",\n  task_updated: \"task\",\n  task_completed: \"task\",\n  task_deleted: \"task\",\n  document_created: \"document\",\n  document_updated: \"document\",\n  document_deleted: \"document\",\n  document_archived: \"document\",\n  document_downloaded: \"document\",\n  investor_created: \"investor\",\n  investor_updated: \"investor\",\n  investor_deleted: \"investor\",\n  investor_deactivated: \"investor\",\n  meeting_created: \"meeting\",\n  meeting_updated: \"meeting\",\n  meeting_deleted: \"meeting\",\n  message_sent: \"message\",\n  password_reset: \"auth\",\n  password_changed: \"auth\",\n};\n\nconst categoryColors: Record<string, string> = {\n  user: \"bg-purple-500/20 text-purple-400 border-purple-500/30\",\n  auth: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  deal: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n  task: \"bg-green-500/20 text-green-400 border-green-500/30\",\n  document: \"bg-cyan-500/20 text-cyan-400 border-cyan-500/30\",\n  investor: \"bg-indigo-500/20 text-indigo-400 border-indigo-500/30\",\n  meeting: \"bg-pink-500/20 text-pink-400 border-pink-500/30\",\n  message: \"bg-orange-500/20 text-orange-400 border-orange-500/30\",\n};\n\nexport default function AuditLogs({ role }: { role?: 'CEO' | 'Employee' }) {\n  const { data: currentUser } = useCurrentUser();\n  const userRole = role || currentUser?.role || 'Employee';\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterEntityType, setFilterEntityType] = useState<string>(\"all\");\n  const [filterUser, setFilterUser] = useState<string>(\"all\");\n  const [selectedLog, setSelectedLog] = useState<AuditLog | null>(null);\n\n  const { data: auditLogs = [], isLoading, refetch } = useQuery<AuditLog[]>({\n    queryKey: [\"/api/admin/audit-logs\"],\n  });\n\n  const { data: users = [] } = useQuery<{ id: string; name: string }[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const filteredLogs = auditLogs.filter((log) => {\n    const matchesSearch =\n      searchQuery === \"\" ||\n      log.userName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      log.action?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      log.entityName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      actionLabels[log.action]?.toLowerCase().includes(searchQuery.toLowerCase());\n\n    const matchesEntityType =\n      filterEntityType === \"all\" || log.entityType === filterEntityType;\n\n    const matchesUser =\n      filterUser === \"all\" || log.userId === filterUser;\n\n    return matchesSearch && matchesEntityType && matchesUser;\n  });\n\n  const uniqueEntityTypes = Array.from(new Set(auditLogs.map((log) => log.entityType))).filter(Boolean);\n\n  const getActionLabel = (action: string) => {\n    return actionLabels[action] || action.replace(/_/g, \" \").replace(/\\b\\w/g, (l) => l.toUpperCase());\n  };\n\n  const getCategory = (action: string) => {\n    return actionCategories[action] || \"other\";\n  };\n\n  const getCategoryColor = (action: string) => {\n    const category = getCategory(action);\n    return categoryColors[category] || \"bg-gray-500/20 text-gray-400 border-gray-500/30\";\n  };\n\n  const getEntityIcon = (entityType: string) => {\n    const Icon = entityTypeIcons[entityType] || Activity;\n    return Icon;\n  };\n\n  const formatDetails = (details: Record<string, any>) => {\n    if (!details || Object.keys(details).length === 0) return null;\n\n    return (\n      <div className=\"space-y-2 text-sm\">\n        {Object.entries(details).map(([key, value]) => (\n          <div key={key} className=\"flex gap-2\">\n            <span className=\"text-muted-foreground capitalize min-w-[120px]\">\n              {key.replace(/([A-Z])/g, \" $1\").replace(/_/g, \" \")}:\n            </span>\n            <span className=\"text-foreground\">\n              {typeof value === \"object\" ? JSON.stringify(value) : String(value)}\n            </span>\n          </div>\n        ))}\n      </div>\n    );\n  };\n\n  const escapeCsvField = (field: string): string => {\n    if (field.includes(\",\") || field.includes('\"') || field.includes(\"\\n\") || field.includes(\"\\r\")) {\n      return `\"${field.replace(/\"/g, '\"\"')}\"`;\n    }\n    return field;\n  };\n\n  const exportLogs = () => {\n    const headers = [\"Timestamp\", \"User\", \"Action\", \"Entity Type\", \"Entity\", \"IP Address\", \"Details\"];\n    const rows = filteredLogs.map((log) => [\n      format(new Date(log.timestamp || log.createdAt), \"yyyy-MM-dd HH:mm:ss\"),\n      log.userName || \"System\",\n      getActionLabel(log.action),\n      log.entityType || \"-\",\n      log.entityName || \"-\",\n      log.ipAddress || \"-\",\n      JSON.stringify(log.details || {}),\n    ]);\n\n    const csvContent = [\n      headers.map(escapeCsvField).join(\",\"),\n      ...rows.map((row) => row.map(escapeCsvField).join(\",\")),\n    ].join(\"\\n\");\n\n    const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `audit-logs-${format(new Date(), \"yyyy-MM-dd\")}.csv`;\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <Layout role={userRole as 'CEO' | 'Employee'} pageTitle=\"Audit Logs\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\" data-testid=\"audit-logs-page\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-display font-bold\">\n              {userRole === 'CEO' ? 'Audit Logs' : 'My Activity Log'}\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              {userRole === 'CEO' \n                ? 'Track all user activities and system events for compliance' \n                : 'View your activity history for compliance and record keeping'}\n            </p>\n          </div>\n        <div className=\"flex gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => refetch()}\n            data-testid=\"button-refresh-logs\"\n          >\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Refresh\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={exportLogs}\n            data-testid=\"button-export-logs\"\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export CSV\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4 flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-primary/10\">\n              <Activity className=\"w-5 h-5 text-primary\" />\n            </div>\n            <div>\n              <p className=\"text-2xl font-bold\">{auditLogs.length}</p>\n              <p className=\"text-sm text-muted-foreground\">Total Events</p>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-blue-500/10\">\n              <User className=\"w-5 h-5 text-blue-500\" />\n            </div>\n            <div>\n              <p className=\"text-2xl font-bold\">\n                {new Set(auditLogs.map((l) => l.userId)).size}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">Active Users</p>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-amber-500/10\">\n              <Shield className=\"w-5 h-5 text-amber-500\" />\n            </div>\n            <div>\n              <p className=\"text-2xl font-bold\">\n                {auditLogs.filter((l) => l.action?.includes(\"login\") || l.action?.includes(\"2fa\")).length}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">Auth Events</p>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-green-500/10\">\n              <Clock className=\"w-5 h-5 text-green-500\" />\n            </div>\n            <div>\n              <p className=\"text-2xl font-bold\">\n                {auditLogs.filter((l) => {\n                  const logDate = new Date(l.timestamp || l.createdAt);\n                  const today = new Date();\n                  return logDate.toDateString() === today.toDateString();\n                }).length}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">Today's Events</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <FileText className=\"w-5 h-5\" />\n                Activity Log\n              </CardTitle>\n              <CardDescription>\n                View and filter all system activities\n              </CardDescription>\n            </div>\n            <Badge variant=\"outline\" className=\"font-mono\">\n              {filteredLogs.length} records\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col md:flex-row gap-4 mb-6\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by user, action, or entity...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-logs\"\n              />\n            </div>\n            <Select value={filterEntityType} onValueChange={setFilterEntityType}>\n              <SelectTrigger className=\"w-[180px]\" data-testid=\"select-entity-type\">\n                <Filter className=\"w-4 h-4 mr-2\" />\n                <SelectValue placeholder=\"Entity Type\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                {uniqueEntityTypes.map((type) => (\n                  <SelectItem key={type} value={type}>\n                    {type.charAt(0).toUpperCase() + type.slice(1)}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {userRole === 'CEO' && (\n              <Select value={filterUser} onValueChange={setFilterUser}>\n                <SelectTrigger className=\"w-[200px]\" data-testid=\"select-user\">\n                  <User className=\"w-4 h-4 mr-2\" />\n                  <SelectValue placeholder=\"All Users\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Users</SelectItem>\n                  {users.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>\n                      {user.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            )}\n          </div>\n\n          <ScrollArea className=\"h-[600px]\">\n            {isLoading ? (\n              <div className=\"flex items-center justify-center h-32\">\n                <RefreshCw className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : filteredLogs.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center h-32 text-muted-foreground\">\n                <Activity className=\"w-8 h-8 mb-2\" />\n                <p>No audit logs found</p>\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-[180px]\">Timestamp</TableHead>\n                    <TableHead className=\"w-[150px]\">User</TableHead>\n                    <TableHead className=\"w-[200px]\">Action</TableHead>\n                    <TableHead>Entity</TableHead>\n                    <TableHead className=\"w-[120px]\">IP Address</TableHead>\n                    <TableHead className=\"w-[80px]\">Details</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredLogs.map((log) => {\n                    const EntityIcon = getEntityIcon(log.entityType);\n                    return (\n                      <TableRow\n                        key={log.id}\n                        className=\"cursor-pointer hover:bg-muted/50\"\n                        onClick={() => setSelectedLog(log)}\n                        data-testid={`row-audit-log-${log.id}`}\n                      >\n                        <TableCell className=\"font-mono text-sm\">\n                          <div className=\"flex items-center gap-2\">\n                            <Clock className=\"w-3 h-3 text-muted-foreground\" />\n                            {format(new Date(log.timestamp || log.createdAt), \"MMM d, yyyy\")}\n                            <span className=\"text-muted-foreground\">\n                              {format(new Date(log.timestamp || log.createdAt), \"HH:mm:ss\")}\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center\">\n                              <User className=\"w-3 h-3 text-primary\" />\n                            </div>\n                            <span className=\"truncate max-w-[100px]\">\n                              {log.userName || \"System\"}\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <Badge\n                            variant=\"outline\"\n                            className={getCategoryColor(log.action)}\n                          >\n                            {getActionLabel(log.action)}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          {log.entityType && (\n                            <div className=\"flex items-center gap-2\">\n                              <EntityIcon className=\"w-4 h-4 text-muted-foreground\" />\n                              <span className=\"capitalize\">{log.entityType}</span>\n                              {log.entityName && (\n                                <>\n                                  <ChevronRight className=\"w-3 h-3 text-muted-foreground\" />\n                                  <span className=\"text-muted-foreground truncate max-w-[150px]\">\n                                    {log.entityName}\n                                  </span>\n                                </>\n                              )}\n                            </div>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"font-mono text-sm text-muted-foreground\">\n                          {log.ipAddress || \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              setSelectedLog(log);\n                            }}\n                            data-testid={`button-view-details-${log.id}`}\n                          >\n                            <Eye className=\"w-4 h-4\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedLog} onOpenChange={() => setSelectedLog(null)}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Activity className=\"w-5 h-5\" />\n              Audit Log Details\n            </DialogTitle>\n            <DialogDescription>\n              Complete information about this activity\n            </DialogDescription>\n          </DialogHeader>\n          {selectedLog && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Timestamp</p>\n                  <p className=\"font-mono text-sm\">\n                    {format(new Date(selectedLog.timestamp || selectedLog.createdAt), \"PPpp\")}\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">User</p>\n                  <p className=\"flex items-center gap-2\">\n                    <User className=\"w-4 h-4\" />\n                    {selectedLog.userName || \"System\"}\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Action</p>\n                  <Badge\n                    variant=\"outline\"\n                    className={getCategoryColor(selectedLog.action)}\n                  >\n                    {getActionLabel(selectedLog.action)}\n                  </Badge>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">IP Address</p>\n                  <p className=\"font-mono text-sm\">\n                    {selectedLog.ipAddress || \"Not recorded\"}\n                  </p>\n                </div>\n              </div>\n\n              {selectedLog.entityType && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-1\">Entity</p>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted rounded-md\">\n                    {(() => {\n                      const EntityIcon = getEntityIcon(selectedLog.entityType);\n                      return <EntityIcon className=\"w-4 h-4\" />;\n                    })()}\n                    <span className=\"capitalize\">{selectedLog.entityType}</span>\n                    {selectedLog.entityName && (\n                      <>\n                        <ChevronRight className=\"w-3 h-3\" />\n                        <span>{selectedLog.entityName}</span>\n                      </>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {selectedLog.details && Object.keys(selectedLog.details).length > 0 && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground mb-2\">Additional Details</p>\n                  <div className=\"p-3 bg-muted rounded-md\">\n                    {formatDetails(selectedLog.details)}\n                  </div>\n                </div>\n              )}\n\n              <div className=\"text-xs text-muted-foreground font-mono\">\n                Log ID: {selectedLog.id}\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":22364,"size_tokens":null},"client/src/pages/portal/PortalDashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useCurrentUser, usePortalDeals, usePortalUpdates, usePortalMessages, useSendPortalMessage, useDocumentsByDeal, useLogout } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { \n  Loader2, Building2, FileText, MessageSquare, TrendingUp, Calendar, \n  Download, Send, LogOut, User, Clock, CheckCircle2, AlertCircle, Info, Eye, ExternalLink\n} from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { Deal } from \"@/lib/api\";\n\nexport default function PortalDashboard() {\n  const [, setLocation] = useLocation();\n  const { data: user, isLoading: userLoading } = useCurrentUser();\n  const { data: deals = [], isLoading: dealsLoading } = usePortalDeals();\n  const logoutMutation = useLogout();\n  \n  const [selectedDeal, setSelectedDeal] = useState<Deal | null>(null);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  \n  const handleLogout = async () => {\n    try {\n      await logoutMutation.mutateAsync();\n      setLocation(\"/portal/login\");\n    } catch {\n      toast.error(\"Failed to log out\");\n    }\n  };\n  \n  if (userLoading || dealsLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n  \n  if (!user || user.role !== \"External\") {\n    setLocation(\"/portal/login\");\n    return null;\n  }\n  \n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"border-b bg-card/50 backdrop-blur sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex justify-between items-center h-16\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 rounded-xl bg-gradient-to-br from-primary to-primary/60 flex items-center justify-center\">\n                <Building2 className=\"h-5 w-5 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-lg font-semibold\">Kronos</h1>\n                <p className=\"text-xs text-muted-foreground\">Client Portal</p>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center gap-4\">\n              <div className=\"text-right hidden sm:block\">\n                <p className=\"text-sm font-medium\">{user.name}</p>\n                <p className=\"text-xs text-muted-foreground\">{(user as any).externalOrganization || user.email}</p>\n              </div>\n              <Button variant=\"ghost\" size=\"icon\" onClick={handleLogout} data-testid=\"button-logout\">\n                <LogOut className=\"h-5 w-5\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n      \n      <main className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <div className=\"mb-8\">\n          <h2 className=\"text-2xl font-bold\">Welcome, {user.name.split(\" \")[0]}</h2>\n          <p className=\"text-muted-foreground\">\n            {(user as any).externalOrganization ? `${(user as any).externalOrganization} Portal` : \"Your deal dashboard\"}\n          </p>\n        </div>\n        \n        {deals.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-16\">\n              <FileText className=\"h-12 w-12 text-muted-foreground/50 mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">No Deals Available</h3>\n              <p className=\"text-muted-foreground text-center max-w-sm\">\n                You don't have access to any deals yet. Contact your relationship manager for more information.\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-6 lg:grid-cols-3\">\n            <div className=\"lg:col-span-1 space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wide\">Your Deals</h3>\n              {deals.map((deal) => (\n                <DealCard \n                  key={deal.id} \n                  deal={deal} \n                  isSelected={selectedDeal?.id === deal.id}\n                  onClick={() => {\n                    setSelectedDeal(deal);\n                    setActiveTab(\"overview\");\n                  }}\n                />\n              ))}\n            </div>\n            \n            <div className=\"lg:col-span-2\">\n              {selectedDeal ? (\n                <DealDetail \n                  deal={selectedDeal} \n                  activeTab={activeTab}\n                  onTabChange={setActiveTab}\n                />\n              ) : (\n                <Card className=\"h-full min-h-[400px]\">\n                  <CardContent className=\"flex flex-col items-center justify-center h-full\">\n                    <TrendingUp className=\"h-12 w-12 text-muted-foreground/50 mb-4\" />\n                    <h3 className=\"text-lg font-medium mb-2\">Select a Deal</h3>\n                    <p className=\"text-muted-foreground text-center\">\n                      Click on a deal to view details, documents, and updates.\n                    </p>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}\n\nfunction DealCard({ deal, isSelected, onClick }: { deal: Deal; isSelected: boolean; onClick: () => void }) {\n  // Map legacy IB stages to new stages\n  const mapIBStage = (stage: string) => {\n    const legacyMap: Record<string, string> = {\n      'Due Diligence': 'Diligence',\n      'Negotiation': 'Legal',\n      'Closing': 'Close',\n      'Execution': 'Structuring',\n      'Signing': 'Close',\n    };\n    return legacyMap[stage] || stage;\n  };\n  \n  const stageColors: Record<string, string> = {\n    Origination: \"bg-blue-500/10 text-blue-500 border-blue-500/20\",\n    Structuring: \"bg-cyan-500/10 text-cyan-500 border-cyan-500/20\",\n    Diligence: \"bg-amber-500/10 text-amber-500 border-amber-500/20\",\n    Legal: \"bg-purple-500/10 text-purple-500 border-purple-500/20\",\n    Close: \"bg-green-500/10 text-green-500 border-green-500/20\",\n    Closed: \"bg-slate-500/10 text-slate-500 border-slate-500/20\",\n  };\n  \n  const mappedStage = mapIBStage(deal.stage);\n  \n  return (\n    <Card \n      className={`cursor-pointer transition-all hover:border-primary/50 ${\n        isSelected ? \"border-primary ring-2 ring-primary/20\" : \"\"\n      }`}\n      onClick={onClick}\n      data-testid={`card-deal-${deal.id}`}\n    >\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between mb-3\">\n          <div>\n            <h4 className=\"font-semibold\">{deal.name}</h4>\n            <p className=\"text-sm text-muted-foreground\">{deal.client}</p>\n          </div>\n          <Badge variant=\"outline\" className={stageColors[mappedStage] || \"\"}>\n            {mappedStage}\n          </Badge>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Progress</span>\n            <span className=\"font-medium\">{deal.progress}%</span>\n          </div>\n          <Progress value={deal.progress} className=\"h-2\" />\n        </div>\n        \n        {deal.value && (\n          <div className=\"mt-3 pt-3 border-t flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Deal Value</span>\n            <span className=\"font-semibold\">${deal.value.toLocaleString()}</span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction DealDetail({ deal, activeTab, onTabChange }: { deal: Deal; activeTab: string; onTabChange: (tab: string) => void }) {\n  const { data: updates = [], isLoading: updatesLoading } = usePortalUpdates(deal.id);\n  const { data: messages = [], isLoading: messagesLoading, refetch: refetchMessages } = usePortalMessages(deal.id);\n  const { data: documents = [], isLoading: docsLoading } = useDocumentsByDeal(deal.id);\n  const sendMessageMutation = useSendPortalMessage();\n  \n  const [newMessage, setNewMessage] = useState(\"\");\n  \n  const handleSendMessage = async () => {\n    if (!newMessage.trim()) return;\n    \n    try {\n      await sendMessageMutation.mutateAsync({ dealId: deal.id, content: newMessage.trim() });\n      setNewMessage(\"\");\n      refetchMessages();\n      toast.success(\"Message sent\");\n    } catch (err: any) {\n      toast.error(err.message || \"Failed to send message\");\n    }\n  };\n  \n  const handleDownload = async (doc: any) => {\n    try {\n      const response = await fetch(`/api/documents/${doc.id}/download`);\n      if (!response.ok) {\n        const error = await response.json().catch(() => ({ error: \"Download failed\" }));\n        toast.error(error.error || \"Failed to download document\");\n        return;\n      }\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement(\"a\");\n      link.href = url;\n      link.download = doc.originalName || doc.filename;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      toast.success(\"Download started\");\n    } catch (error) {\n      console.error('Download error:', error);\n      toast.error(\"Failed to download document\");\n    }\n  };\n\n  // Helper to infer mimeType from filename if not provided\n  const inferMimeType = (doc: any): string => {\n    if (doc.mimeType) return doc.mimeType;\n    const filename = (doc.originalName || doc.filename || '').toLowerCase();\n    if (filename.endsWith('.pdf')) return 'application/pdf';\n    if (filename.endsWith('.png')) return 'image/png';\n    if (filename.endsWith('.jpg') || filename.endsWith('.jpeg')) return 'image/jpeg';\n    if (filename.endsWith('.gif')) return 'image/gif';\n    if (filename.endsWith('.txt')) return 'text/plain';\n    return '';\n  };\n\n  const canViewInBrowser = (doc: any): boolean => {\n    // Can't view if content is unavailable (legacy files)\n    if (doc.contentUnavailable) return false;\n    const mimeType = inferMimeType(doc);\n    return mimeType.includes('pdf') || mimeType.includes('image') || mimeType.includes('text');\n  };\n\n  const handleViewInNewTab = async (doc: any) => {\n    try {\n      const response = await fetch(`/api/documents/${doc.id}/download`);\n      if (!response.ok) {\n        const error = await response.json().catch(() => ({ error: \"Failed to open document\" }));\n        toast.error(error.error || \"Failed to open document\");\n        return;\n      }\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const newWindow = window.open(url, '_blank');\n      if (!newWindow) {\n        toast.error(\"Unable to open document. Please allow popups for this site.\");\n        window.URL.revokeObjectURL(url);\n      }\n    } catch (error) {\n      console.error('Failed to open document:', error);\n      toast.error(\"Failed to open document\");\n    }\n  };\n  \n  return (\n    <Card>\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-start justify-between\">\n          <div>\n            <CardTitle>{deal.name}</CardTitle>\n            <CardDescription>{deal.client} - {deal.sector}</CardDescription>\n          </div>\n          <Badge variant={deal.status === \"active\" ? \"default\" : \"secondary\"}>\n            {deal.status}\n          </Badge>\n        </div>\n      </CardHeader>\n      \n      <Tabs value={activeTab} onValueChange={onTabChange}>\n        <div className=\"px-6\">\n          <TabsList className=\"w-full grid grid-cols-4\">\n            <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n            <TabsTrigger value=\"updates\" data-testid=\"tab-updates\">Updates</TabsTrigger>\n            <TabsTrigger value=\"documents\" data-testid=\"tab-documents\">Documents</TabsTrigger>\n            <TabsTrigger value=\"messages\" data-testid=\"tab-messages\">Messages</TabsTrigger>\n          </TabsList>\n        </div>\n        \n        <CardContent className=\"pt-6\">\n          <TabsContent value=\"overview\" className=\"mt-0 space-y-6\">\n            <div className=\"grid sm:grid-cols-2 gap-4\">\n              <div className=\"p-4 bg-muted/50 rounded-lg\">\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                  <TrendingUp className=\"h-4 w-4\" />\n                  Current Stage\n                </div>\n                <p className=\"font-semibold\">{deal.stage}</p>\n              </div>\n              <div className=\"p-4 bg-muted/50 rounded-lg\">\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-1\">\n                  <Calendar className=\"h-4 w-4\" />\n                  Progress\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <Progress value={deal.progress} className=\"flex-1\" />\n                  <span className=\"font-semibold\">{deal.progress}%</span>\n                </div>\n              </div>\n            </div>\n            \n            {deal.description && (\n              <div>\n                <h4 className=\"text-sm font-medium text-muted-foreground mb-2\">Description</h4>\n                <p className=\"text-sm\">{deal.description}</p>\n              </div>\n            )}\n            \n            <div className=\"grid sm:grid-cols-3 gap-4 text-center\">\n              <div className=\"p-4 border rounded-lg\">\n                <FileText className=\"h-6 w-6 mx-auto mb-2 text-primary\" />\n                <p className=\"text-2xl font-bold\">{documents.length}</p>\n                <p className=\"text-xs text-muted-foreground\">Documents</p>\n              </div>\n              <div className=\"p-4 border rounded-lg\">\n                <MessageSquare className=\"h-6 w-6 mx-auto mb-2 text-primary\" />\n                <p className=\"text-2xl font-bold\">{messages.length}</p>\n                <p className=\"text-xs text-muted-foreground\">Messages</p>\n              </div>\n              <div className=\"p-4 border rounded-lg\">\n                <Clock className=\"h-6 w-6 mx-auto mb-2 text-primary\" />\n                <p className=\"text-2xl font-bold\">{updates.length}</p>\n                <p className=\"text-xs text-muted-foreground\">Updates</p>\n              </div>\n            </div>\n          </TabsContent>\n          \n          <TabsContent value=\"updates\" className=\"mt-0\">\n            {updatesLoading ? (\n              <div className=\"flex justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin\" />\n              </div>\n            ) : updates.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <Info className=\"h-8 w-8 mx-auto text-muted-foreground/50 mb-2\" />\n                <p className=\"text-muted-foreground\">No updates yet</p>\n              </div>\n            ) : (\n              <ScrollArea className=\"h-[400px] pr-4\">\n                <div className=\"space-y-4\">\n                  {updates.map((update: any) => (\n                    <div key={update.id} className=\"p-4 border rounded-lg\">\n                      <div className=\"flex items-start justify-between mb-2\">\n                        <h4 className=\"font-medium\">{update.title}</h4>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {update.type}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mb-3\">{update.content}</p>\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                        <User className=\"h-3 w-3\" />\n                        <span>{update.authorName}</span>\n                        <span>-</span>\n                        <span>{formatDistanceToNow(new Date(update.createdAt), { addSuffix: true })}</span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </ScrollArea>\n            )}\n          </TabsContent>\n          \n          <TabsContent value=\"documents\" className=\"mt-0\">\n            {docsLoading ? (\n              <div className=\"flex justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin\" />\n              </div>\n            ) : documents.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <FileText className=\"h-8 w-8 mx-auto text-muted-foreground/50 mb-2\" />\n                <p className=\"text-muted-foreground\">No documents shared yet</p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {documents.map((doc: any) => (\n                  <div \n                    key={doc.id} \n                    className=\"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors\"\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                      <div>\n                        <p className=\"font-medium text-sm\">{doc.title || doc.filename}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {doc.category} - {format(new Date(doc.createdAt), \"MMM d, yyyy\")}\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      {doc.content && canViewInBrowser(doc) && (\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          onClick={() => handleViewInNewTab(doc)}\n                          title=\"Open in new tab\"\n                          data-testid={`button-view-${doc.id}`}\n                        >\n                          <ExternalLink className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        onClick={() => handleDownload(doc)}\n                        title=\"Download\"\n                        data-testid={`button-download-${doc.id}`}\n                      >\n                        <Download className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </TabsContent>\n          \n          <TabsContent value=\"messages\" className=\"mt-0\">\n            <div className=\"flex flex-col h-[400px]\">\n              <ScrollArea className=\"flex-1 pr-4 mb-4\">\n                {messagesLoading ? (\n                  <div className=\"flex justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin\" />\n                  </div>\n                ) : messages.length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <MessageSquare className=\"h-8 w-8 mx-auto text-muted-foreground/50 mb-2\" />\n                    <p className=\"text-muted-foreground\">No messages yet</p>\n                    <p className=\"text-xs text-muted-foreground\">Start the conversation below</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {messages.map((msg: any) => (\n                      <div \n                        key={msg.id} \n                        className={`flex ${msg.isExternal ? \"justify-end\" : \"justify-start\"}`}\n                      >\n                        <div \n                          className={`max-w-[80%] p-3 rounded-lg ${\n                            msg.isExternal \n                              ? \"bg-primary text-primary-foreground\" \n                              : \"bg-muted\"\n                          }`}\n                        >\n                          <p className=\"text-sm\">{msg.content}</p>\n                          <div className={`text-xs mt-1 ${msg.isExternal ? \"text-primary-foreground/70\" : \"text-muted-foreground\"}`}>\n                            {msg.senderName} - {formatDistanceToNow(new Date(msg.createdAt), { addSuffix: true })}\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </ScrollArea>\n              \n              <div className=\"flex gap-2\">\n                <Textarea\n                  placeholder=\"Type your message...\"\n                  value={newMessage}\n                  onChange={(e) => setNewMessage(e.target.value)}\n                  className=\"min-h-[60px] resize-none\"\n                  data-testid=\"input-message\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\" && !e.shiftKey) {\n                      e.preventDefault();\n                      handleSendMessage();\n                    }\n                  }}\n                />\n                <Button \n                  onClick={handleSendMessage}\n                  disabled={!newMessage.trim() || sendMessageMutation.isPending}\n                  data-testid=\"button-send-message\"\n                >\n                  {sendMessageMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Send className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n            </div>\n          </TabsContent>\n        </CardContent>\n      </Tabs>\n    </Card>\n  );\n}\n","path":null,"size_bytes":22018,"size_tokens":null},"client/src/pages/portal/PortalRegister.tsx":{"content":"import { useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { usePortalInviteByToken, usePortalRegister } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Building2, Shield, FileText, MessageSquare, CheckCircle2 } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\n\nexport default function PortalRegister() {\n  const { token } = useParams<{ token: string }>();\n  const [, setLocation] = useLocation();\n  const { data: invite, isLoading, error } = usePortalInviteByToken(token || null);\n  const registerMutation = usePortalRegister();\n  \n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  \n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (password !== confirmPassword) {\n      toast.error(\"Passwords do not match\");\n      return;\n    }\n    \n    if (password.length < 8) {\n      toast.error(\"Password must be at least 8 characters\");\n      return;\n    }\n    \n    try {\n      await registerMutation.mutateAsync({ token: token!, password, phone: phone || undefined });\n      toast.success(\"Account created successfully!\");\n      setLocation(\"/portal\");\n    } catch (err: any) {\n      toast.error(err.message || \"Registration failed\");\n    }\n  };\n  \n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-white\" />\n      </div>\n    );\n  }\n  \n  if (error || !invite) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4\">\n        <Card className=\"w-full max-w-md border-destructive/50 bg-card/95 backdrop-blur\">\n          <CardHeader className=\"text-center\">\n            <CardTitle className=\"text-destructive\">Invalid Invitation</CardTitle>\n            <CardDescription>\n              This invitation link is invalid, has expired, or has already been used.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"text-center\">\n            <Button variant=\"outline\" onClick={() => setLocation(\"/portal/login\")}>\n              Go to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n  \n  const expiresAt = new Date(invite.expiresAt);\n  \n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4\">\n      <div className=\"w-full max-w-lg\">\n        <div className=\"text-center mb-8\">\n          <div className=\"flex items-center justify-center gap-2 mb-4\">\n            <div className=\"h-12 w-12 rounded-xl bg-gradient-to-br from-primary to-primary/60 flex items-center justify-center\">\n              <Building2 className=\"h-6 w-6 text-white\" />\n            </div>\n          </div>\n          <h1 className=\"text-3xl font-bold text-white\">Kronos</h1>\n          <p className=\"text-slate-400\">Client Portal</p>\n        </div>\n        \n        <Card className=\"bg-card/95 backdrop-blur border-border/50\">\n          <CardHeader>\n            <CardTitle className=\"text-xl\">Complete Your Registration</CardTitle>\n            <CardDescription>\n              {invite.inviterName} has invited you to access the client portal\n              {invite.organization && ` for ${invite.organization}`}.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <span className=\"text-muted-foreground\">Email:</span>\n                <span className=\"font-medium\">{invite.email}</span>\n              </div>\n              <div className=\"flex items-center gap-2 text-sm\">\n                <span className=\"text-muted-foreground\">Name:</span>\n                <span className=\"font-medium\">{invite.name}</span>\n              </div>\n              {invite.organization && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <span className=\"text-muted-foreground\">Organization:</span>\n                  <span className=\"font-medium\">{invite.organization}</span>\n                </div>\n              )}\n              <div className=\"flex items-center gap-2 text-sm\">\n                <span className=\"text-muted-foreground\">Access Level:</span>\n                <Badge variant=\"secondary\" className=\"capitalize\">{invite.accessLevel}</Badge>\n              </div>\n              <div className=\"flex items-center gap-2 text-sm\">\n                <span className=\"text-muted-foreground\">Expires:</span>\n                <span className=\"font-medium\">{format(expiresAt, \"MMM d, yyyy\")}</span>\n              </div>\n            </div>\n            \n            {invite.dealNames.length > 0 && (\n              <div className=\"bg-muted/50 rounded-lg p-4\">\n                <p className=\"text-sm text-muted-foreground mb-2\">You'll have access to:</p>\n                <div className=\"space-y-1\">\n                  {invite.dealNames.map((name, i) => (\n                    <div key={i} className=\"flex items-center gap-2 text-sm\">\n                      <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                      <span>{name}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n            \n            <div className=\"grid grid-cols-3 gap-3 text-center\">\n              <div className=\"p-3 bg-muted/30 rounded-lg\">\n                <FileText className=\"h-5 w-5 mx-auto mb-1 text-primary\" />\n                <span className=\"text-xs text-muted-foreground\">Documents</span>\n              </div>\n              <div className=\"p-3 bg-muted/30 rounded-lg\">\n                <MessageSquare className=\"h-5 w-5 mx-auto mb-1 text-primary\" />\n                <span className=\"text-xs text-muted-foreground\">Messages</span>\n              </div>\n              <div className=\"p-3 bg-muted/30 rounded-lg\">\n                <Shield className=\"h-5 w-5 mx-auto mb-1 text-primary\" />\n                <span className=\"text-xs text-muted-foreground\">Secure</span>\n              </div>\n            </div>\n            \n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"phone\">Phone Number (Optional)</Label>\n                <Input\n                  id=\"phone\"\n                  type=\"tel\"\n                  placeholder=\"+1 (555) 123-4567\"\n                  value={phone}\n                  onChange={(e) => setPhone(e.target.value)}\n                  data-testid=\"input-phone\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Create Password</Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder=\"At least 8 characters\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  required\n                  minLength={8}\n                  data-testid=\"input-password\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"confirmPassword\">Confirm Password</Label>\n                <Input\n                  id=\"confirmPassword\"\n                  type=\"password\"\n                  placeholder=\"Confirm your password\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  required\n                  data-testid=\"input-confirm-password\"\n                />\n              </div>\n              \n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={registerMutation.isPending}\n                data-testid=\"button-register\"\n              >\n                {registerMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Creating Account...\n                  </>\n                ) : (\n                  \"Create Account\"\n                )}\n              </Button>\n            </form>\n            \n            <p className=\"text-xs text-center text-muted-foreground\">\n              Already have an account?{\" \"}\n              <a href=\"/portal/login\" className=\"text-primary hover:underline\">\n                Sign in\n              </a>\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9002,"size_tokens":null},"client/src/pages/portal/PortalLogin.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { usePortalLogin } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2, Building2, Lock, Mail } from \"lucide-react\";\nimport { toast } from \"sonner\";\n\nexport default function PortalLogin() {\n  const [, setLocation] = useLocation();\n  const loginMutation = usePortalLogin();\n  \n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  \n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!email || !password) {\n      toast.error(\"Please enter your email and password\");\n      return;\n    }\n    \n    try {\n      await loginMutation.mutateAsync({ email, password });\n      toast.success(\"Welcome back!\");\n      setLocation(\"/portal\");\n    } catch (err: any) {\n      toast.error(err.message || \"Login failed\");\n    }\n  };\n  \n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4\">\n      <div className=\"w-full max-w-md\">\n        <div className=\"text-center mb-8\">\n          <div className=\"flex items-center justify-center gap-2 mb-4\">\n            <div className=\"h-12 w-12 rounded-xl bg-gradient-to-br from-primary to-primary/60 flex items-center justify-center\">\n              <Building2 className=\"h-6 w-6 text-white\" />\n            </div>\n          </div>\n          <h1 className=\"text-3xl font-bold text-white\">Kronos</h1>\n          <p className=\"text-slate-400\">Client Portal</p>\n        </div>\n        \n        <Card className=\"bg-card/95 backdrop-blur border-border/50\">\n          <CardHeader>\n            <CardTitle className=\"text-xl\">Welcome Back</CardTitle>\n            <CardDescription>\n              Sign in to access your client portal and view deal updates.\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email Address</Label>\n                <div className=\"relative\">\n                  <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    placeholder=\"you@company.com\"\n                    value={email}\n                    onChange={(e) => setEmail(e.target.value)}\n                    className=\"pl-10\"\n                    required\n                    data-testid=\"input-email\"\n                  />\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Password</Label>\n                <div className=\"relative\">\n                  <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    placeholder=\"Enter your password\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    className=\"pl-10\"\n                    required\n                    data-testid=\"input-password\"\n                  />\n                </div>\n              </div>\n              \n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={loginMutation.isPending}\n                data-testid=\"button-login\"\n              >\n                {loginMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Signing in...\n                  </>\n                ) : (\n                  \"Sign In\"\n                )}\n              </Button>\n            </form>\n            \n            <div className=\"mt-6 pt-6 border-t border-border/50\">\n              <p className=\"text-sm text-center text-muted-foreground\">\n                This portal is for invited clients and stakeholders only.\n                <br />\n                <span className=\"text-xs\">\n                  Internal team members should use the{\" \"}\n                  <a href=\"/\" className=\"text-primary hover:underline\">\n                    main login\n                  </a>\n                </span>\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4678,"size_tokens":null},"server/googleCalendar.ts":{"content":"// Google Calendar Integration with Per-User OAuth\nimport { google, Auth, calendar_v3 } from 'googleapis';\nimport { storage } from './storage';\nimport crypto from 'crypto';\n\nconst GOOGLE_CLIENT_ID = process.env.GOOGLE_CLIENT_ID;\nconst GOOGLE_CLIENT_SECRET = process.env.GOOGLE_CLIENT_SECRET;\n\nfunction getRedirectUri(): string {\n  // In production, use the configured production URL\n  if (process.env.PRODUCTION_URL) {\n    return `${process.env.PRODUCTION_URL}/api/google-calendar/callback`;\n  }\n  // Fallback to Replit deployment URL if available\n  if (process.env.REPLIT_DEPLOYMENT_URL) {\n    return `${process.env.REPLIT_DEPLOYMENT_URL}/api/google-calendar/callback`;\n  }\n  // In development, use the dev domain\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    return `https://${process.env.REPLIT_DEV_DOMAIN}/api/google-calendar/callback`;\n  }\n  return 'http://localhost:5000/api/google-calendar/callback';\n}\n\nconst SCOPES = [\n  'https://www.googleapis.com/auth/calendar.readonly',\n  'https://www.googleapis.com/auth/calendar.events',\n];\n\n// Session-based OAuth state storage (in-memory for simplicity)\nconst pendingOAuthStates = new Map<string, { userId: string; expiresAt: number }>();\n\nexport function isGoogleOAuthConfigured(): boolean {\n  return !!(GOOGLE_CLIENT_ID && GOOGLE_CLIENT_SECRET);\n}\n\nfunction getOAuth2Client(): Auth.OAuth2Client {\n  if (!isGoogleOAuthConfigured()) {\n    throw new Error('Google OAuth credentials not configured. Please set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET.');\n  }\n  return new google.auth.OAuth2(\n    GOOGLE_CLIENT_ID,\n    GOOGLE_CLIENT_SECRET,\n    getRedirectUri()\n  );\n}\n\nexport function getAuthUrl(userId: string): { url: string; state: string } {\n  const oauth2Client = getOAuth2Client();\n  \n  // Generate a secure random state token\n  const state = crypto.randomBytes(32).toString('hex');\n  \n  // Store the state with the userId for validation on callback\n  pendingOAuthStates.set(state, {\n    userId,\n    expiresAt: Date.now() + 10 * 60 * 1000 // 10 minutes expiry\n  });\n  \n  // Clean up expired states\n  for (const [key, value] of pendingOAuthStates.entries()) {\n    if (value.expiresAt < Date.now()) {\n      pendingOAuthStates.delete(key);\n    }\n  }\n  \n  const url = oauth2Client.generateAuthUrl({\n    access_type: 'offline',\n    scope: SCOPES,\n    prompt: 'consent',\n    state,\n  });\n  \n  return { url, state };\n}\n\nexport function validateOAuthState(state: string, authenticatedUserId: string): boolean {\n  const pending = pendingOAuthStates.get(state);\n  if (!pending) {\n    return false;\n  }\n  \n  // Check if expired\n  if (pending.expiresAt < Date.now()) {\n    pendingOAuthStates.delete(state);\n    return false;\n  }\n  \n  // Validate that the state belongs to the authenticated user\n  if (pending.userId !== authenticatedUserId) {\n    return false;\n  }\n  \n  // State is valid, remove it (single use)\n  pendingOAuthStates.delete(state);\n  return true;\n}\n\nexport async function handleOAuthCallback(code: string, userId: string): Promise<void> {\n  const oauth2Client = getOAuth2Client();\n  const { tokens } = await oauth2Client.getToken(code);\n  \n  await storage.saveGoogleCalendarToken({\n    userId,\n    accessToken: tokens.access_token!,\n    refreshToken: tokens.refresh_token || undefined,\n    expiresAt: tokens.expiry_date ? new Date(tokens.expiry_date) : undefined,\n    scope: tokens.scope || SCOPES.join(' '),\n    tokenType: tokens.token_type || 'Bearer',\n  });\n}\n\nasync function getAuthenticatedClient(userId: string): Promise<calendar_v3.Calendar | null> {\n  const tokenRecord = await storage.getGoogleCalendarToken(userId);\n  if (!tokenRecord) {\n    return null;\n  }\n\n  const oauth2Client = getOAuth2Client();\n  oauth2Client.setCredentials({\n    access_token: tokenRecord.accessToken,\n    refresh_token: tokenRecord.refreshToken || undefined,\n    expiry_date: tokenRecord.expiresAt ? tokenRecord.expiresAt.getTime() : undefined,\n  });\n\n  // Check if token is expired or will expire soon (within 5 minutes)\n  const tokenExpiresSoon = tokenRecord.expiresAt && \n    (tokenRecord.expiresAt.getTime() - 5 * 60 * 1000) < Date.now();\n\n  if (tokenExpiresSoon) {\n    if (tokenRecord.refreshToken) {\n      try {\n        // Use getAccessToken which handles refresh automatically\n        const { credentials } = await oauth2Client.refreshAccessToken();\n        \n        // Save the new tokens\n        await storage.saveGoogleCalendarToken({\n          userId,\n          accessToken: credentials.access_token!,\n          refreshToken: credentials.refresh_token || tokenRecord.refreshToken,\n          expiresAt: credentials.expiry_date ? new Date(credentials.expiry_date) : undefined,\n          scope: credentials.scope || tokenRecord.scope || undefined,\n          tokenType: credentials.token_type || 'Bearer',\n        });\n        \n        oauth2Client.setCredentials(credentials);\n      } catch (error: any) {\n        console.error('Failed to refresh Google Calendar token:', error.message);\n        // Token refresh failed - user needs to re-authenticate\n        await storage.deleteGoogleCalendarToken(userId);\n        return null;\n      }\n    } else {\n      // No refresh token available - user needs to re-authenticate\n      console.log('No refresh token available for user:', userId);\n      await storage.deleteGoogleCalendarToken(userId);\n      return null;\n    }\n  }\n\n  return google.calendar({ version: 'v3', auth: oauth2Client });\n}\n\nexport async function isUserConnected(userId: string): Promise<boolean> {\n  const token = await storage.getGoogleCalendarToken(userId);\n  return !!token;\n}\n\nexport async function disconnectUser(userId: string): Promise<void> {\n  await storage.deleteGoogleCalendarToken(userId);\n}\n\nexport async function listUserCalendarEvents(\n  userId: string,\n  maxResults: number = 50,\n  timeMin?: Date,\n  timeMax?: Date\n) {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  const params: calendar_v3.Params$Resource$Events$List = {\n    calendarId: 'primary',\n    maxResults,\n    singleEvents: true,\n    orderBy: 'startTime',\n  };\n\n  if (timeMin) {\n    params.timeMin = timeMin.toISOString();\n  } else {\n    params.timeMin = new Date().toISOString();\n  }\n\n  if (timeMax) {\n    params.timeMax = timeMax.toISOString();\n  }\n\n  const response = await calendar.events.list(params);\n  return response.data.items || [];\n}\n\nexport async function createUserCalendarEvent(\n  userId: string,\n  event: {\n    summary: string;\n    description?: string;\n    location?: string;\n    start: Date;\n    end: Date;\n    attendees?: string[];\n    addMeetLink?: boolean;\n  }\n) {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  const eventData: calendar_v3.Schema$Event = {\n    summary: event.summary,\n    description: event.description,\n    location: event.location,\n    start: {\n      dateTime: event.start.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    },\n    end: {\n      dateTime: event.end.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    },\n  };\n\n  if (event.attendees && event.attendees.length > 0) {\n    eventData.attendees = event.attendees.map(email => ({ email }));\n  }\n\n  if (event.addMeetLink) {\n    eventData.conferenceData = {\n      createRequest: {\n        requestId: `kronos-${Date.now()}`,\n        conferenceSolutionKey: { type: 'hangoutsMeet' },\n      },\n    };\n  }\n\n  const response = await calendar.events.insert({\n    calendarId: 'primary',\n    requestBody: eventData,\n    conferenceDataVersion: event.addMeetLink ? 1 : 0,\n    sendUpdates: event.attendees?.length ? 'all' : 'none',\n  });\n\n  return response.data;\n}\n\nexport async function deleteUserCalendarEvent(userId: string, eventId: string): Promise<void> {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  await calendar.events.delete({\n    calendarId: 'primary',\n    eventId,\n  });\n}\n\nexport async function updateUserCalendarEvent(\n  userId: string,\n  eventId: string,\n  event: {\n    summary?: string;\n    description?: string;\n    location?: string;\n    start?: Date;\n    end?: Date;\n    attendees?: string[];\n  }\n) {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  const eventData: calendar_v3.Schema$Event = {};\n\n  if (event.summary !== undefined) eventData.summary = event.summary;\n  if (event.description !== undefined) eventData.description = event.description;\n  if (event.location !== undefined) eventData.location = event.location;\n  \n  if (event.start) {\n    eventData.start = {\n      dateTime: event.start.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    };\n  }\n  \n  if (event.end) {\n    eventData.end = {\n      dateTime: event.end.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    };\n  }\n\n  if (event.attendees && event.attendees.length > 0) {\n    eventData.attendees = event.attendees.map(email => ({ email }));\n  }\n\n  const response = await calendar.events.patch({\n    calendarId: 'primary',\n    eventId,\n    requestBody: eventData,\n    sendUpdates: event.attendees?.length ? 'all' : 'none',\n  });\n\n  return response.data;\n}\n\n// Sync platform calendar event to Google Calendar\nexport async function syncEventToGoogle(\n  userId: string,\n  platformEvent: {\n    id: string;\n    title: string;\n    description?: string | null;\n    location?: string | null;\n    date: string;\n    time?: string | null;\n    isAllDay?: boolean | null;\n    participants?: string[] | null;\n    googleCalendarEventId?: string | null;\n  }\n): Promise<{ googleEventId: string; action: 'created' | 'updated' }> {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  // Build start and end times\n  let startDateTime: Date;\n  let endDateTime: Date;\n  \n  if (platformEvent.time) {\n    const [hours, minutes] = platformEvent.time.split(':').map(Number);\n    startDateTime = new Date(platformEvent.date);\n    startDateTime.setHours(hours, minutes, 0, 0);\n    endDateTime = new Date(startDateTime);\n    endDateTime.setHours(endDateTime.getHours() + 1); // Default 1 hour duration\n  } else {\n    startDateTime = new Date(platformEvent.date);\n    startDateTime.setHours(9, 0, 0, 0);\n    endDateTime = new Date(startDateTime);\n    endDateTime.setHours(10, 0, 0, 0);\n  }\n\n  const eventData: calendar_v3.Schema$Event = {\n    summary: platformEvent.title,\n    description: platformEvent.description || undefined,\n    location: platformEvent.location || undefined,\n    start: platformEvent.isAllDay ? {\n      date: platformEvent.date,\n    } : {\n      dateTime: startDateTime.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    },\n    end: platformEvent.isAllDay ? {\n      date: platformEvent.date,\n    } : {\n      dateTime: endDateTime.toISOString(),\n      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n    },\n    extendedProperties: {\n      private: {\n        kronosPlatformEventId: platformEvent.id,\n      }\n    }\n  };\n\n  if (platformEvent.participants && platformEvent.participants.length > 0) {\n    // Filter for email-like participants\n    const emailParticipants = platformEvent.participants.filter(p => p.includes('@'));\n    if (emailParticipants.length > 0) {\n      eventData.attendees = emailParticipants.map(email => ({ email }));\n    }\n  }\n\n  // Check if we should update or create\n  if (platformEvent.googleCalendarEventId) {\n    try {\n      const response = await calendar.events.patch({\n        calendarId: 'primary',\n        eventId: platformEvent.googleCalendarEventId,\n        requestBody: eventData,\n        sendUpdates: 'none',\n      });\n      return { googleEventId: response.data.id!, action: 'updated' };\n    } catch (error: any) {\n      // If event doesn't exist in Google, create a new one\n      if (error.code === 404 || error.code === 410) {\n        const response = await calendar.events.insert({\n          calendarId: 'primary',\n          requestBody: eventData,\n        });\n        return { googleEventId: response.data.id!, action: 'created' };\n      }\n      throw error;\n    }\n  } else {\n    const response = await calendar.events.insert({\n      calendarId: 'primary',\n      requestBody: eventData,\n    });\n    return { googleEventId: response.data.id!, action: 'created' };\n  }\n}\n\n// Sync events from Google Calendar back to the platform\nexport async function syncEventsFromGoogle(\n  userId: string,\n  timeMin?: Date,\n  timeMax?: Date\n): Promise<calendar_v3.Schema$Event[]> {\n  const calendar = await getAuthenticatedClient(userId);\n  if (!calendar) {\n    throw new Error('Google Calendar not connected');\n  }\n\n  const now = new Date();\n  const defaultTimeMin = timeMin || new Date(now.getFullYear(), now.getMonth(), 1); // First of current month\n  const defaultTimeMax = timeMax || new Date(now.getFullYear(), now.getMonth() + 3, 0); // End of 3 months from now\n\n  const response = await calendar.events.list({\n    calendarId: 'primary',\n    timeMin: defaultTimeMin.toISOString(),\n    timeMax: defaultTimeMax.toISOString(),\n    singleEvents: true,\n    orderBy: 'startTime',\n    maxResults: 250,\n  });\n\n  return response.data.items || [];\n}\n","path":null,"size_bytes":13400,"size_tokens":null},"client/src/pages/employee/AssetManagement.tsx":{"content":"import { useState, useMemo, useEffect, useRef, useCallback } from \"react\";\nimport { useDebounce } from \"@/hooks/useDebounce\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useSearch } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  Search, Filter, MoreVertical, ArrowRight, Calendar, DollarSign, Briefcase, \n  Pencil, Trash2, Eye, Users, Phone, Mail, MessageSquare, Plus, X, \n  Building2, TrendingUp, FileText, Clock, CheckCircle2, ChevronRight,\n  UserPlus, History, LayoutGrid, CalendarDays, ChevronLeft, Upload, GitCompare, ArrowUpDown, BarChart3,\n  Mic, MicOff, Play, Pause, Square, Volume2, Download, UserCircle, ExternalLink, ArrowLeftCircle\n} from \"lucide-react\";\nimport { \n  useCurrentUser, useDealsListing, useDeal, useCreateDeal, useUpdateDeal, useDeleteDeal, useMoveDealToOpportunity, useUsers, useTasks, useCreateDealFee,\n  useStageDocuments, useCreateStageDocument, useDeleteStageDocument,\n  useStagePodMembers, useCreateStagePodMember, useDeleteStagePodMember,\n  useStageVoiceNotes, useCreateStageVoiceNote, useDeleteStageVoiceNote,\n  useTaskComments, useCreateTaskComment, useCreateTask, useDeleteTask,\n  useCustomSectors, useCreateCustomSector,\n  useDealFees, type DealFeeType,\n  useCreateDocument,\n  useAllInvestors,\n  useDealNotes, useCreateDealNote, type DealNoteType\n} from \"@/lib/api\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { Check, ChevronsUpDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format, startOfWeek, endOfWeek, startOfMonth, endOfMonth, eachDayOfInterval, isSameDay, addDays, addWeeks, addMonths, subDays, subWeeks, subMonths, isToday, isBefore, isAfter, parseISO } from \"date-fns\";\nimport type { Deal, PodTeamMember, TaggedInvestor, AuditEntry } from \"@shared/schema\";\nimport { ObjectUploader, type UploadedFile } from \"@/components/ObjectUploader\";\nimport {\n  RadarChart,\n  PolarGrid,\n  PolarAngleAxis,\n  PolarRadiusAxis,\n  Radar,\n  ResponsiveContainer,\n  Legend,\n  Tooltip\n} from \"recharts\";\n\nconst COMPARISON_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];\n\nconst DEAL_STAGES = ['Reception', 'Initial Review', 'Hard Diligence', 'Structure', 'Negotiation', 'Closing', 'Invested'];\n\nfunction DealStageTeamCount({ dealId, stage }: { dealId: string; stage: string }) {\n  const { data: stagePodMembers = [] } = useStagePodMembers(dealId, stage);\n  const [showPopover, setShowPopover] = useState(false);\n  \n  return (\n    <Popover open={showPopover} onOpenChange={setShowPopover}>\n      <PopoverTrigger asChild>\n        <div className=\"cursor-pointer hover:text-primary transition-colors\" onClick={(e) => { e.stopPropagation(); setShowPopover(true); }}>\n          <span className=\"font-medium\">{stagePodMembers.length} members</span>\n        </div>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-72 p-3\" align=\"start\" onClick={(e) => e.stopPropagation()}>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n              <Users className=\"w-4 h-4 text-emerald-400\" />\n              {stage} Stage Team\n            </h4>\n            <Badge variant=\"secondary\" className=\"text-xs\">{stagePodMembers.length}</Badge>\n          </div>\n          {stagePodMembers.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">No team members assigned to this stage yet</p>\n          ) : (\n            <ScrollArea className=\"max-h-48\">\n              <div className=\"space-y-2\">\n                {stagePodMembers.map((member: any) => (\n                  <div key={member.id} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div className=\"w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-sm font-medium\">\n                      {member.userName?.charAt(0) || '?'}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                      <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nfunction DealTotalTeamCount({ dealId, podTeam = [] }: { dealId: string; podTeam?: PodTeamMember[] }) {\n  const { data: allStagePodMembers = [] } = useStagePodMembers(dealId);\n  const [showPopover, setShowPopover] = useState(false);\n  \n  const distinctMembers = useMemo(() => {\n    const seen = new Map<string, any>();\n    // Add stage pod members\n    allStagePodMembers.forEach((member: any) => {\n      if (member.userId && !seen.has(member.userId)) {\n        seen.set(member.userId, { ...member, source: 'stage' });\n      }\n    });\n    // Add pod team members (legacy)\n    podTeam.forEach((member: PodTeamMember) => {\n      if (member.userId && !seen.has(member.userId)) {\n        seen.set(member.userId, { userId: member.userId, userName: member.name, role: member.role, source: 'pod' });\n      }\n    });\n    return Array.from(seen.values());\n  }, [allStagePodMembers, podTeam]);\n  \n  return (\n    <Popover open={showPopover} onOpenChange={setShowPopover}>\n      <PopoverTrigger asChild>\n        <div className=\"cursor-pointer hover:text-primary transition-colors\" onClick={(e) => { e.stopPropagation(); setShowPopover(true); }}>\n          <span className=\"font-medium\">{distinctMembers.length} members</span>\n        </div>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-72 p-3\" align=\"start\" onClick={(e) => e.stopPropagation()}>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n              <Users className=\"w-4 h-4 text-emerald-400\" />\n              Deal Team\n            </h4>\n            <Badge variant=\"secondary\" className=\"text-xs\">{distinctMembers.length}</Badge>\n          </div>\n          {distinctMembers.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">No team members assigned yet</p>\n          ) : (\n            <ScrollArea className=\"max-h-48\">\n              <div className=\"space-y-2\">\n                {distinctMembers.map((member: any) => (\n                  <div key={member.userId} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                    <div className=\"w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-sm font-medium\">\n                      {member.userName?.charAt(0) || '?'}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                      <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\nfunction DealTotalTeamCountNumber({ dealId, podTeam = [] }: { dealId: string; podTeam?: PodTeamMember[] }) {\n  const { data: allStagePodMembers = [] } = useStagePodMembers(dealId);\n  \n  const distinctCount = useMemo(() => {\n    const seen = new Set<string>();\n    // Add stage pod members\n    allStagePodMembers.forEach((member: any) => {\n      if (member.userId) {\n        seen.add(member.userId);\n      }\n    });\n    // Add pod team members (legacy)\n    podTeam.forEach((member: PodTeamMember) => {\n      if (member.userId) {\n        seen.add(member.userId);\n      }\n    });\n    return seen.size;\n  }, [allStagePodMembers, podTeam]);\n  \n  return <>{distinctCount}</>;\n}\n\nfunction DealNotesSection({ dealId, allUsers }: { dealId: string; allUsers: any[] }) {\n  const { data: notes = [], isLoading } = useDealNotes(dealId);\n  const createDealNote = useCreateDealNote();\n  const [newNote, setNewNote] = useState(\"\");\n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const filteredUsers = useMemo(() => {\n    if (!mentionQuery) return allUsers.slice(0, 5);\n    return allUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    ).slice(0, 5);\n  }, [allUsers, mentionQuery]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    const position = e.target.selectionStart || 0;\n    setNewNote(value);\n    setCursorPosition(position);\n\n    const textBeforeCursor = value.slice(0, position);\n    const atMatch = textBeforeCursor.match(/@(\\w*)$/);\n    if (atMatch) {\n      setShowMentions(true);\n      setMentionQuery(atMatch[1]);\n    } else {\n      setShowMentions(false);\n      setMentionQuery(\"\");\n    }\n  };\n\n  const insertMention = (userName: string) => {\n    const textBeforeCursor = newNote.slice(0, cursorPosition);\n    const textAfterCursor = newNote.slice(cursorPosition);\n    const beforeAt = textBeforeCursor.replace(/@\\w*$/, '');\n    const mentionName = userName.replace(/\\s+/g, '');\n    const newText = `${beforeAt}@${mentionName} ${textAfterCursor}`;\n    setNewNote(newText);\n    setShowMentions(false);\n    setMentionQuery(\"\");\n    textareaRef.current?.focus();\n  };\n\n  const handleSubmit = async () => {\n    if (!newNote.trim()) return;\n    try {\n      await createDealNote.mutateAsync({ dealId, content: newNote.trim() });\n      setNewNote(\"\");\n      toast.success(\"Note added\");\n    } catch {\n      toast.error(\"Failed to add note\");\n    }\n  };\n\n  const renderContentWithMentions = (content: string) => {\n    const parts = content.split(/(@\\w+)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith('@')) {\n        return <span key={i} className=\"text-emerald-400 font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Loading notes...</div>;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"font-medium flex items-center gap-2\">\n          <MessageSquare className=\"w-4 h-4\" />\n          Deal Notes\n        </h4>\n        <Badge variant=\"secondary\">{notes.length} notes</Badge>\n      </div>\n\n      <div className=\"relative\">\n        <Textarea\n          ref={textareaRef}\n          placeholder=\"Add a note... Use @ to mention team members\"\n          value={newNote}\n          onChange={handleInputChange}\n          className=\"min-h-[80px]\"\n          data-testid=\"input-deal-note\"\n        />\n        {showMentions && filteredUsers.length > 0 && (\n          <div className=\"absolute bottom-full left-0 mb-1 w-64 bg-popover border rounded-md shadow-lg z-50 max-h-48 overflow-auto\">\n            {filteredUsers.map(user => (\n              <button\n                key={user.id}\n                className=\"w-full px-3 py-2 text-left hover:bg-accent flex items-center gap-2\"\n                onClick={() => insertMention(user.name)}\n              >\n                <div className=\"w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-xs\">\n                  {user.name.charAt(0)}\n                </div>\n                <span className=\"text-sm\">{user.name}</span>\n              </button>\n            ))}\n          </div>\n        )}\n        <div className=\"flex justify-end mt-2\">\n          <Button \n            size=\"sm\" \n            onClick={handleSubmit}\n            disabled={!newNote.trim() || createDealNote.isPending}\n            data-testid=\"button-submit-deal-note\"\n          >\n            <Plus className=\"w-4 h-4 mr-1\" /> Add Note\n          </Button>\n        </div>\n      </div>\n\n      <ScrollArea className=\"h-[300px]\">\n        <div className=\"space-y-3\">\n          {notes.map((note: DealNoteType) => (\n            <div key={note.id} className=\"p-3 bg-secondary/30 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-sm font-medium text-emerald-400 flex-shrink-0\">\n                  {note.userName?.charAt(0) || '?'}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium text-sm\">{note.userName}</span>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {format(new Date(note.createdAt), 'MMM d, h:mm a')}\n                    </span>\n                  </div>\n                  <p className=\"text-sm mt-1 whitespace-pre-wrap\">\n                    {renderContentWithMentions(note.content)}\n                  </p>\n                </div>\n              </div>\n            </div>\n          ))}\n          {notes.length === 0 && (\n            <div className=\"text-center py-8 text-muted-foreground text-sm\">\n              No notes yet. Add the first note above.\n            </div>\n          )}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n\nconst INVESTOR_TYPES = ['PE', 'VC', 'Strategic', 'Family Office', 'Hedge Fund', 'Sovereign Wealth'];\nconst INVESTOR_STATUSES = ['Contacted', 'Interested', 'In DD', 'Term Sheet', 'Passed', 'Closed'];\n\ntype StageWorkSectionProps = {\n  dealId: string;\n  dealName: string;\n  dealStage: string;\n  allUsers: any[];\n  currentUser: any;\n  allTasks: any[];\n  activeStageTab: string;\n  setActiveStageTab: (stage: string) => void;\n  createStageDocument: any;\n  deleteStageDocument: any;\n  createStagePodMember: any;\n  deleteStagePodMember: any;\n  createStageVoiceNote: any;\n  deleteStageVoiceNote: any;\n  createTaskComment: any;\n  createTask: any;\n  deleteTask: any;\n  createDocument: any;\n  onAuditEntry?: (action: string, details: string) => Promise<void>;\n  totalTeamCount?: number;\n  useFullDealTeam?: boolean;\n};\n\nfunction StageWorkSection({\n  dealId,\n  dealName,\n  dealStage,\n  allUsers,\n  currentUser,\n  allTasks,\n  activeStageTab,\n  setActiveStageTab,\n  createStageDocument,\n  deleteStageDocument,\n  createStagePodMember,\n  deleteStagePodMember,\n  createStageVoiceNote,\n  deleteStageVoiceNote,\n  createTaskComment,\n  createTask,\n  deleteTask,\n  createDocument,\n  onAuditEntry,\n  totalTeamCount,\n  useFullDealTeam = false\n}: StageWorkSectionProps) {\n  const { data: stageDocuments = [] } = useStageDocuments(dealId, activeStageTab);\n  const { data: stageVoiceNotes = [] } = useStageVoiceNotes(dealId, activeStageTab);\n  \n  // For AM deals (useFullDealTeam=true): fetch all members across all stages\n  // For IB deals (useFullDealTeam=false): fetch only stage-specific members\n  const { data: stagePodMembers = [] } = useStagePodMembers(\n    dealId, \n    useFullDealTeam ? undefined : activeStageTab\n  );\n  \n  const [showAddDocument, setShowAddDocument] = useState(false);\n  const [showAddMember, setShowAddMember] = useState(false);\n  const [showAddTask, setShowAddTask] = useState(false);\n  const [showTeamPopover, setShowTeamPopover] = useState(false);\n  const [documentTitle, setDocumentTitle] = useState(\"\");\n  const [documentCategory, setDocumentCategory] = useState(\"General\");\n  const [documentFiles, setDocumentFiles] = useState<File[]>([]);\n  const [memberSearch, setMemberSearch] = useState(\"\");\n  const [selectedMember, setSelectedMember] = useState<any>(null);\n  const [memberRole, setMemberRole] = useState(\"\");\n  const [newTaskTitle, setNewTaskTitle] = useState(\"\");\n  const [newTaskPriority, setNewTaskPriority] = useState(\"Medium\");\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingTime, setRecordingTime] = useState(0);\n  const [voiceTitle, setVoiceTitle] = useState(\"\");\n  const recordingInterval = useRef<NodeJS.Timeout | null>(null);\n  \n  const [expandedTask, setExpandedTask] = useState<string | null>(null);\n  \n  useEffect(() => {\n    return () => {\n      if (recordingInterval.current) {\n        clearInterval(recordingInterval.current);\n      }\n    };\n  }, []);\n  \n  const stageTasks = useMemo(() => {\n    return allTasks.filter((task: any) => \n      task.dealId === dealId && \n      (task.dealStage === activeStageTab || (!task.dealStage && activeStageTab === dealStage))\n    );\n  }, [allTasks, dealId, activeStageTab, dealStage]);\n  \n  const filteredMembers = useMemo(() => {\n    if (!memberSearch || memberSearch.length < 2) return [];\n    const query = memberSearch.toLowerCase();\n    return allUsers.filter((user: any) => \n      user.name.toLowerCase().includes(query) || \n      user.email.toLowerCase().includes(query)\n    ).slice(0, 5);\n  }, [allUsers, memberSearch]);\n  \n  const handleAddDocument = async () => {\n    if (documentFiles.length === 0) {\n      toast.error(\"Please select at least one file to upload\");\n      return;\n    }\n    \n    const categoryMap: Record<string, string> = {\n      'General': 'Other',\n      'Financial': 'Financial Documents',\n      'Legal': 'Legal',\n      'Technical': 'Reports',\n      'Presentation': 'Presentations'\n    };\n    \n    let uploadedCount = 0;\n    let failedCount = 0;\n    \n    try {\n      for (const file of documentFiles) {\n        try {\n          const title = file.name;\n          \n          // First upload the file to get a URL\n          const formData = new FormData();\n          formData.append('file', file);\n          \n          const uploadResponse = await fetch('/api/upload', {\n            method: 'POST',\n            body: formData,\n          });\n          \n          if (!uploadResponse.ok) {\n            throw new Error('Failed to upload file');\n          }\n          \n          const uploadResult = await uploadResponse.json();\n          const fileUrl = uploadResult.url;\n          \n          // Save to stage documents with the URL\n          await createStageDocument.mutateAsync({\n            dealId,\n            doc: {\n              stage: activeStageTab,\n              title: title,\n              filename: file.name,\n              url: fileUrl,\n              mimeType: file.type,\n              size: file.size,\n            }\n          });\n          \n          // Also read file as base64 for document library archive\n          const base64Data = await new Promise<string>((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onload = (e) => resolve(e.target?.result as string);\n            reader.onerror = () => reject(new Error(\"Failed to read file\"));\n            reader.readAsDataURL(file);\n          });\n          \n          try {\n            await createDocument.mutateAsync({\n              title: title,\n              filename: `[${dealName}] ${title}`,\n              content: base64Data,\n              category: categoryMap[documentCategory] || 'Other',\n              dealId: dealId,\n              tags: [activeStageTab, 'Stage Work'],\n              type: 'stage_document',\n              uploadedBy: currentUser?.id,\n              originalName: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n          } catch (archiveError) {\n            console.error('Failed to archive document (non-critical):', archiveError);\n          }\n          \n          uploadedCount++;\n        } catch (error) {\n          console.error(`Failed to upload ${file.name}:`, error);\n          failedCount++;\n        }\n      }\n      \n      if (onAuditEntry && uploadedCount > 0) {\n        await onAuditEntry('Documents Uploaded', `${uploadedCount} document(s) uploaded to ${activeStageTab} stage`);\n      }\n      \n      if (uploadedCount > 0) {\n        toast.success(`${uploadedCount} document(s) uploaded successfully${failedCount > 0 ? `, ${failedCount} failed` : ''}`);\n      } else {\n        toast.error(\"Failed to upload documents\");\n      }\n      \n      setDocumentTitle(\"\");\n      setDocumentCategory(\"General\");\n      setDocumentFiles([]);\n      setShowAddDocument(false);\n      if (fileInputRef.current) fileInputRef.current.value = '';\n    } catch (error) {\n      toast.error(\"Failed to upload documents\");\n    }\n  };\n  \n  const handleAddTask = async () => {\n    if (!newTaskTitle.trim()) {\n      toast.error(\"Please enter a task title\");\n      return;\n    }\n    try {\n      const nextWeek = new Date();\n      nextWeek.setDate(nextWeek.getDate() + 7);\n      await createTask.mutateAsync({\n        title: newTaskTitle.trim(),\n        description: '',\n        status: 'Pending',\n        priority: newTaskPriority,\n        dealId: dealId,\n        dealStage: activeStageTab,\n        assignedTo: currentUser?.id || undefined,\n        type: 'Deal Task',\n        dueDate: nextWeek.toISOString().split('T')[0]\n      });\n      if (onAuditEntry) {\n        await onAuditEntry('Task Created', `${newTaskTitle.trim()} created in ${activeStageTab} stage`);\n      }\n      toast.success(\"Task created\");\n      setNewTaskTitle(\"\");\n      setNewTaskPriority(\"Medium\");\n      setShowAddTask(false);\n    } catch (error) {\n      toast.error(\"Failed to create task\");\n    }\n  };\n  \n  const handleAddMember = async () => {\n    if (!selectedMember) {\n      toast.error(\"Please select a team member\");\n      return;\n    }\n    try {\n      // For AM deals (useFullDealTeam=true), add member at deal level with \"All\" stage\n      // For IB deals, add member to the specific active stage\n      const memberStage = useFullDealTeam ? \"All\" : activeStageTab;\n      \n      await createStagePodMember.mutateAsync({\n        dealId,\n        member: {\n          stage: memberStage,\n          userId: selectedMember.id,\n          userName: selectedMember.name,\n          role: memberRole || selectedMember.role || 'Team Member',\n          email: selectedMember.email || '',\n          phone: selectedMember.phone || '',\n        }\n      });\n      if (onAuditEntry) {\n        const auditDetail = useFullDealTeam \n          ? `${selectedMember.name} added to deal team`\n          : `${selectedMember.name} added to ${activeStageTab} stage`;\n        await onAuditEntry('Team Member Added', auditDetail);\n      }\n      toast.success(useFullDealTeam ? \"Team member added to deal\" : \"Team member added to stage\");\n      setSelectedMember(null);\n      setMemberSearch(\"\");\n      setMemberRole(\"\");\n      setShowAddMember(false);\n    } catch (error) {\n      toast.error(\"Failed to add team member\");\n    }\n  };\n  \n  const startRecording = () => {\n    setIsRecording(true);\n    setRecordingTime(0);\n    recordingInterval.current = setInterval(() => {\n      setRecordingTime(prev => prev + 1);\n    }, 1000);\n    toast.info(\"Recording started\");\n  };\n  \n  const stopRecording = async () => {\n    setIsRecording(false);\n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n    }\n    \n    if (recordingTime > 0) {\n      try {\n        await createStageVoiceNote.mutateAsync({\n          dealId,\n          note: {\n            stage: activeStageTab,\n            title: voiceTitle || `Note ${format(new Date(), 'MMM d, h:mm a')}`,\n            filename: `voice_note_${Date.now()}.webm`,\n            duration: recordingTime,\n          }\n        });\n        toast.success(\"Voice note saved!\");\n      } catch (error) {\n        toast.error(\"Failed to save voice note\");\n      }\n    }\n    \n    setVoiceTitle(\"\");\n    setRecordingTime(0);\n  };\n  \n  const cancelRecording = () => {\n    setIsRecording(false);\n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n    }\n    setRecordingTime(0);\n    setVoiceTitle(\"\");\n  };\n  \n  const formatDuration = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n  \n  const getStageIndex = (stage: string) => DEAL_STAGES.indexOf(stage);\n  \n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center gap-1 p-1 bg-secondary/30 rounded-lg\">\n        {DEAL_STAGES.map((stage, index) => {\n          const isCurrentStage = dealStage === stage;\n          const isPastStage = getStageIndex(dealStage) > index;\n          const isActive = activeStageTab === stage;\n          return (\n            <Button\n              key={stage}\n              variant={isActive ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              className={cn(\n                \"flex-1 text-xs relative\",\n                isActive && \"bg-primary text-primary-foreground\",\n                !isActive && isCurrentStage && \"ring-1 ring-primary/50\",\n                !isActive && isPastStage && \"text-muted-foreground\"\n              )}\n              onClick={() => setActiveStageTab(stage)}\n            >\n              {stage}\n              {isCurrentStage && (\n                <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full\" />\n              )}\n            </Button>\n          );\n        })}\n      </div>\n      \n      <div className=\"text-xs text-muted-foreground text-center\">\n        Viewing stage: <span className=\"font-medium text-foreground\">{activeStageTab}</span>\n        {activeStageTab === dealStage && <span className=\"ml-1 text-green-500\">(Current)</span>}\n      </div>\n      \n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\n        <Card className=\"bg-secondary/20\">\n          <CardContent className=\"p-3 text-center\">\n            <FileText className=\"w-4 h-4 mx-auto mb-1 text-blue-400\" />\n            <div className=\"text-lg font-bold\">{stageDocuments.length}</div>\n            <div className=\"text-xs text-muted-foreground\">Documents</div>\n          </CardContent>\n        </Card>\n        <Popover open={showTeamPopover} onOpenChange={setShowTeamPopover}>\n          <PopoverTrigger asChild>\n            <Card \n              className=\"bg-secondary/20 cursor-pointer hover:bg-secondary/30 transition-colors\"\n              onClick={(e) => { e.stopPropagation(); setShowTeamPopover(true); }}\n            >\n              <CardContent className=\"p-3 text-center\">\n                <Users className=\"w-4 h-4 mx-auto mb-1 text-emerald-400\" />\n                <div className=\"text-lg font-bold\">{stagePodMembers.length}</div>\n                <div className=\"text-xs text-muted-foreground\">Team</div>\n              </CardContent>\n            </Card>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-72 p-3\" align=\"center\" onClick={(e) => e.stopPropagation()}>\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                  <Users className=\"w-4 h-4 text-emerald-400\" />\n                  {useFullDealTeam ? 'Deal Team' : `${activeStageTab} Stage Team`}\n                </h4>\n                <Badge variant=\"secondary\" className=\"text-xs\">{stagePodMembers.length}</Badge>\n              </div>\n              {stagePodMembers.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  {useFullDealTeam ? 'No team members assigned to this deal yet' : 'No team members assigned to this stage yet'}\n                </p>\n              ) : (\n                <ScrollArea className=\"max-h-48\">\n                  <div className=\"space-y-2\">\n                    {stagePodMembers.map((member: any) => (\n                      <div key={member.id} className=\"flex items-center gap-2 p-2 bg-secondary/30 rounded-lg\">\n                        <div className=\"w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-sm font-medium\">\n                          {member.userName?.charAt(0) || '?'}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"font-medium text-sm truncate\">{member.userName || 'Unknown'}</div>\n                          <div className=\"text-xs text-muted-foreground truncate\">{member.jobTitle || member.role}</div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              )}\n            </div>\n          </PopoverContent>\n        </Popover>\n        <Card className=\"bg-secondary/20\">\n          <CardContent className=\"p-3 text-center\">\n            <Mic className=\"w-4 h-4 mx-auto mb-1 text-purple-400\" />\n            <div className=\"text-lg font-bold\">{stageVoiceNotes.length}</div>\n            <div className=\"text-xs text-muted-foreground\">Notes</div>\n          </CardContent>\n        </Card>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <FileText className=\"w-4 h-4 text-blue-400\" /> Stage Documents\n          </h5>\n          <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddDocument(!showAddDocument)}>\n            <Plus className=\"w-4 h-4\" />\n          </Button>\n        </div>\n        \n        {showAddDocument && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <Select value={documentCategory} onValueChange={setDocumentCategory}>\n              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-document-category\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"General\">General</SelectItem>\n                <SelectItem value=\"Financial\">Financial</SelectItem>\n                <SelectItem value=\"Legal\">Legal</SelectItem>\n                <SelectItem value=\"Technical\">Technical</SelectItem>\n                <SelectItem value=\"Presentation\">Presentation</SelectItem>\n              </SelectContent>\n            </Select>\n            <ObjectUploader\n              maxFiles={10}\n              maxSizeBytes={500 * 1024 * 1024}\n              onComplete={(uploadedFiles: UploadedFile[]) => {\n                const categoryMap: Record<string, string> = {\n                  'General': 'Other',\n                  'Financial': 'Financial Documents',\n                  'Legal': 'Legal',\n                  'Technical': 'Reports',\n                  'Presentation': 'Presentations'\n                };\n                \n                uploadedFiles.forEach(file => {\n                  createStageDocument.mutate({\n                    dealId,\n                    doc: {\n                      stage: activeStageTab,\n                      title: file.filename,\n                      filename: file.filename,\n                      url: file.objectPath,\n                      mimeType: file.type,\n                      size: file.size,\n                    }\n                  });\n                  \n                  createDocument.mutate({\n                    title: file.filename,\n                    filename: `[${dealName}] ${file.filename}`,\n                    content: file.objectPath,\n                    category: categoryMap[documentCategory] || 'Other',\n                    dealId: dealId,\n                    tags: [activeStageTab, 'Stage Work'],\n                    type: 'stage_document',\n                    uploadedBy: currentUser?.id,\n                    originalName: file.filename,\n                    mimeType: file.type,\n                    size: file.size,\n                  });\n                });\n                \n                if (onAuditEntry && uploadedFiles.length > 0) {\n                  onAuditEntry('Documents Uploaded', `${uploadedFiles.length} document(s) uploaded to ${activeStageTab} stage`);\n                }\n                \n                toast.success(`${uploadedFiles.length} document(s) uploaded`);\n                setShowAddDocument(false);\n              }}\n            />\n            <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddDocument(false); setDocumentFiles([]); setDocumentTitle(''); }}>Cancel</Button>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[100px]\">\n          {stageDocuments.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No documents for this stage\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              {stageDocuments.map((doc: any) => (\n                <div key={doc.id} className=\"flex items-center justify-between p-2 bg-secondary/20 rounded text-sm group\">\n                  <div className=\"flex items-center gap-2\">\n                    <FileText className=\"w-3 h-3 text-blue-400\" />\n                    <span className=\"truncate\">{doc.title}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100\">\n                    {(doc.url || doc.fileData) && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => {\n                          const viewUrl = doc.url || doc.fileData;\n                          if (viewUrl) window.open(viewUrl, '_blank');\n                        }}\n                        title=\"View\"\n                        data-testid={`view-doc-${doc.id}`}\n                      >\n                        <ExternalLink className=\"w-3 h-3 text-green-400\" />\n                      </Button>\n                    )}\n                    {(doc.url || doc.fileData) && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => {\n                          const downloadUrl = doc.url || doc.fileData;\n                          if (downloadUrl) {\n                            const link = document.createElement('a');\n                            link.href = downloadUrl;\n                            link.download = doc.filename || doc.title || 'document';\n                            link.click();\n                          }\n                        }}\n                        title=\"Download\"\n                        data-testid={`download-doc-${doc.id}`}\n                      >\n                        <Download className=\"w-3 h-3 text-blue-400\" />\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-6 w-6\"\n                      onClick={() => deleteStageDocument.mutate({ id: doc.id, dealId, stage: activeStageTab })}\n                      title=\"Delete\"\n                      data-testid={`delete-doc-${doc.id}`}\n                    >\n                      <X className=\"w-3 h-3 text-red-400\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <Users className=\"w-4 h-4 text-green-400\" /> {useFullDealTeam ? 'Deal Team' : 'Stage Team'}\n          </h5>\n          <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddMember(!showAddMember)}>\n            <Plus className=\"w-4 h-4\" />\n          </Button>\n        </div>\n        \n        {showAddMember && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by name or email...\"\n                value={memberSearch}\n                onChange={(e) => setMemberSearch(e.target.value)}\n                className=\"h-8 text-sm pl-7\"\n                data-testid=\"input-team-search\"\n              />\n            </div>\n            {memberSearch.length >= 2 && (\n              <div className=\"max-h-[120px] overflow-y-auto border rounded-md bg-background\">\n                {filteredMembers.length === 0 ? (\n                  <div className=\"p-2 text-sm text-muted-foreground text-center\">No users found</div>\n                ) : (\n                  filteredMembers.map((user: any) => (\n                    <button\n                      key={user.id}\n                      onClick={() => {\n                        setSelectedMember(user);\n                        setMemberRole(user.jobTitle || user.role || 'Team Member');\n                        setMemberSearch('');\n                      }}\n                      className={cn(\n                        \"w-full p-2 text-left hover:bg-secondary/50 flex items-center gap-2 text-sm\",\n                        selectedMember?.id === user.id && \"bg-primary/10\"\n                      )}\n                      data-testid={`team-member-${user.id}`}\n                    >\n                      <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-xs\">\n                        {user.name?.charAt(0) || '?'}\n                      </div>\n                      <div>\n                        <div className=\"font-medium\">{user.name}</div>\n                        <div className=\"text-xs text-muted-foreground\">{user.email}</div>\n                      </div>\n                    </button>\n                  ))\n                )}\n              </div>\n            )}\n            {selectedMember && (\n              <div className=\"flex items-center gap-2 p-2 bg-primary/10 rounded text-sm\">\n                <Check className=\"w-4 h-4 text-primary\" />\n                <span>Selected: {selectedMember.name}</span>\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 ml-auto\" onClick={() => setSelectedMember(null)}>\n                  <X className=\"w-3 h-3\" />\n                </Button>\n              </div>\n            )}\n            <Input\n              placeholder={useFullDealTeam ? \"Role on this deal\" : \"Role for this stage\"}\n              value={memberRole}\n              onChange={(e) => setMemberRole(e.target.value)}\n              className=\"h-8 text-sm\"\n              data-testid=\"input-member-role\"\n            />\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={handleAddMember} className=\"flex-1\" disabled={!selectedMember} data-testid=\"button-add-member\">Add Member</Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddMember(false); setSelectedMember(null); setMemberSearch(''); }}>Cancel</Button>\n            </div>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[80px]\">\n          {stagePodMembers.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              {useFullDealTeam ? 'No team members for this deal' : 'No team members for this stage'}\n            </div>\n          ) : (\n            <div className=\"flex flex-wrap gap-2\">\n              {stagePodMembers.map((member: any) => (\n                <div key={member.id} className=\"flex items-center gap-1 px-2 py-1 bg-secondary/30 rounded-full text-xs group\">\n                  <div className=\"w-5 h-5 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-xs\">\n                    {member.userName?.charAt(0) || '?'}\n                  </div>\n                  <span>{member.userName || 'Unknown'}</span>\n                  <span className=\"text-muted-foreground\">({member.role})</span>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-4 w-4 opacity-0 group-hover:opacity-100\"\n                    onClick={() => deleteStagePodMember.mutate(member.id)}\n                  >\n                    <X className=\"w-3 h-3 text-red-400\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <Mic className=\"w-4 h-4 text-purple-400\" /> Voice Notes\n          </h5>\n        </div>\n        \n        {isRecording ? (\n          <div className=\"p-3 bg-red-500/10 border border-red-500/30 rounded-lg space-y-2\">\n            <div className=\"flex items-center justify-center gap-2 text-red-400\">\n              <div className=\"w-2 h-2 bg-red-500 rounded-full animate-pulse\" />\n              Recording: {formatDuration(recordingTime)}\n            </div>\n            <Input\n              placeholder=\"Voice note title (optional)\"\n              value={voiceTitle}\n              onChange={(e) => setVoiceTitle(e.target.value)}\n              className=\"h-8 text-sm\"\n            />\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={stopRecording} className=\"flex-1 bg-red-500 hover:bg-red-600\">\n                <Square className=\"w-3 h-3 mr-1\" /> Stop & Save\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={cancelRecording}>Cancel</Button>\n            </div>\n          </div>\n        ) : (\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            className=\"w-full\" \n            onClick={startRecording}\n          >\n            <Mic className=\"w-4 h-4 mr-2 text-purple-400\" /> Start Recording\n          </Button>\n        )}\n        \n        <ScrollArea className=\"h-[80px]\">\n          {stageVoiceNotes.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No voice notes for this stage\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              {stageVoiceNotes.map((note: any) => (\n                <div key={note.id} className=\"flex items-center justify-between p-2 bg-secondary/20 rounded text-sm group\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\n                      <Play className=\"w-3 h-3 text-purple-400\" />\n                    </Button>\n                    <div>\n                      <span className=\"truncate\">{note.title}</span>\n                      <span className=\"text-xs text-muted-foreground ml-2\">{formatDuration(note.duration)}</span>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100\">\n                    <span className=\"text-xs text-muted-foreground mr-1\">{note.recorderName || note.authorName}</span>\n                    {note.url && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-6 w-6\"\n                        onClick={() => window.open(note.url, '_blank')}\n                        data-testid={`download-note-${note.id}`}\n                      >\n                        <Download className=\"w-3 h-3 text-purple-400\" />\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-6 w-6\"\n                      onClick={() => deleteStageVoiceNote.mutate(note.id)}\n                      data-testid={`delete-note-${note.id}`}\n                    >\n                      <X className=\"w-3 h-3 text-red-400\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n      \n      {/* Tasks Section */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h5 className=\"text-sm font-medium flex items-center gap-2\">\n            <CheckCircle2 className=\"w-4 h-4 text-orange-400\" /> Deal Tasks\n          </h5>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"secondary\" className=\"text-xs\">{stageTasks.length} tasks</Badge>\n            <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowAddTask(!showAddTask)} data-testid=\"button-add-task-toggle\">\n              <Plus className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n        \n        {showAddTask && (\n          <div className=\"p-3 bg-secondary/30 rounded-lg space-y-2\">\n            <Input\n              placeholder=\"Task title\"\n              value={newTaskTitle}\n              onChange={(e) => setNewTaskTitle(e.target.value)}\n              className=\"h-8 text-sm\"\n              data-testid=\"input-task-title\"\n            />\n            <Select value={newTaskPriority} onValueChange={setNewTaskPriority}>\n              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-task-priority\">\n                <SelectValue placeholder=\"Priority\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"Low\">Low Priority</SelectItem>\n                <SelectItem value=\"Medium\">Medium Priority</SelectItem>\n                <SelectItem value=\"High\">High Priority</SelectItem>\n                <SelectItem value=\"Critical\">Critical</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"flex gap-2\">\n              <Button size=\"sm\" onClick={handleAddTask} className=\"flex-1\" disabled={!newTaskTitle.trim()} data-testid=\"button-create-task\">\n                Create Task\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={() => { setShowAddTask(false); setNewTaskTitle(''); }}>Cancel</Button>\n            </div>\n          </div>\n        )}\n        \n        <ScrollArea className=\"h-[150px]\">\n          {stageTasks.length === 0 ? (\n            <div className=\"text-center text-sm text-muted-foreground py-4\">\n              No tasks for this deal\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {stageTasks.map((task: any) => (\n                <div key={task.id} className=\"bg-secondary/20 rounded-lg overflow-hidden group\">\n                  <div \n                    className=\"flex items-center justify-between p-2 cursor-pointer hover:bg-secondary/30\"\n                    onClick={() => setExpandedTask(expandedTask === task.id ? null : task.id)}\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <div className={cn(\n                        \"w-2 h-2 rounded-full\",\n                        task.status === 'Completed' ? \"bg-green-500\" :\n                        task.status === 'In Progress' ? \"bg-blue-500\" :\n                        \"bg-yellow-500\"\n                      )} />\n                      <span className=\"text-sm truncate\">{task.title}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {task.priority}\n                      </Badge>\n                      <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-6 w-6 opacity-0 group-hover:opacity-100\"\n                            onClick={(e) => e.stopPropagation()}\n                            data-testid={`delete-task-${task.id}`}\n                          >\n                            <X className=\"w-3 h-3 text-red-400\" />\n                          </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent onClick={(e) => e.stopPropagation()}>\n                          <AlertDialogHeader>\n                            <AlertDialogTitle>Delete Task</AlertDialogTitle>\n                            <AlertDialogDescription>\n                              Are you sure you want to delete \"{task.title}\"? This action cannot be undone.\n                            </AlertDialogDescription>\n                          </AlertDialogHeader>\n                          <AlertDialogFooter>\n                            <AlertDialogCancel>Cancel</AlertDialogCancel>\n                            <AlertDialogAction\n                              onClick={() => {\n                                deleteTask.mutate(task.id);\n                                toast.success(\"Task deleted\");\n                              }}\n                            >\n                              Delete\n                            </AlertDialogAction>\n                          </AlertDialogFooter>\n                        </AlertDialogContent>\n                      </AlertDialog>\n                      <ChevronRight className={cn(\n                        \"w-4 h-4 transition-transform\",\n                        expandedTask === task.id && \"rotate-90\"\n                      )} />\n                    </div>\n                  </div>\n                  \n                  {expandedTask === task.id && (\n                    <TaskComments \n                      taskId={task.id}\n                      currentUser={currentUser}\n                      createTaskComment={createTaskComment}\n                      users={allUsers}\n                    />\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n      </div>\n    </div>\n  );\n}\n\nfunction TaskComments({ \n  taskId,\n  currentUser,\n  createTaskComment,\n  users = []\n}: { \n  taskId: string;\n  currentUser: any;\n  createTaskComment: any;\n  users?: any[];\n}) {\n  const { data: comments = [] } = useTaskComments(taskId);\n  const [newComment, setNewComment] = useState(\"\");\n  const [showMentionDropdown, setShowMentionDropdown] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [mentionStartIndex, setMentionStartIndex] = useState<number | null>(null);\n  const [selectedMentionIndex, setSelectedMentionIndex] = useState(0);\n  const inputRef = useRef<HTMLInputElement>(null);\n  \n  const mentionableUsers = useMemo(() => {\n    const activeUsers = users.filter(u => u.status === 'active');\n    if (!mentionQuery) return activeUsers.slice(0, 5);\n    return activeUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    ).slice(0, 5);\n  }, [users, mentionQuery]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    const cursorPos = e.target.selectionStart || 0;\n    setNewComment(value);\n    \n    const textBeforeCursor = value.substring(0, cursorPos);\n    const atIndex = textBeforeCursor.lastIndexOf('@');\n    \n    if (atIndex !== -1) {\n      const charBeforeAt = atIndex > 0 ? textBeforeCursor[atIndex - 1] : ' ';\n      if (charBeforeAt === ' ' || atIndex === 0) {\n        const query = textBeforeCursor.substring(atIndex + 1);\n        if (!query.includes(' ')) {\n          setMentionQuery(query);\n          setMentionStartIndex(atIndex);\n          setShowMentionDropdown(true);\n          setSelectedMentionIndex(0);\n          return;\n        }\n      }\n    }\n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n  };\n\n  const insertMention = (user: any) => {\n    if (mentionStartIndex === null) return;\n    const beforeMention = newComment.substring(0, mentionStartIndex);\n    const afterMention = newComment.substring(mentionStartIndex + mentionQuery.length + 1);\n    const newMessage = `${beforeMention}@${user.name} ${afterMention}`;\n    setNewComment(newMessage);\n    setShowMentionDropdown(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(null);\n    setSelectedMentionIndex(0);\n    inputRef.current?.focus();\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (!showMentionDropdown) {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        handleAddComment();\n      }\n      return;\n    }\n    \n    if (e.key === 'ArrowDown') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => \n        prev < mentionableUsers.length - 1 ? prev + 1 : prev\n      );\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault();\n      setSelectedMentionIndex(prev => prev > 0 ? prev - 1 : 0);\n    } else if (e.key === 'Enter' || e.key === 'Tab') {\n      e.preventDefault();\n      if (mentionableUsers[selectedMentionIndex]) {\n        insertMention(mentionableUsers[selectedMentionIndex]);\n      }\n    } else if (e.key === 'Escape') {\n      setShowMentionDropdown(false);\n    }\n  };\n  \n  const handleAddComment = async () => {\n    if (!newComment.trim()) return;\n    try {\n      await createTaskComment.mutateAsync({\n        taskId,\n        comment: {\n          content: newComment.trim(),\n          authorId: currentUser?.id || '',\n          authorName: currentUser?.name || 'Unknown'\n        }\n      });\n      toast.success(\"Comment added\");\n      setNewComment(\"\");\n    } catch (error) {\n      toast.error(\"Failed to add comment\");\n    }\n  };\n\n  const renderContentWithMentions = (content: string) => {\n    const parts = content.split(/(@[A-Za-z]+(?:\\s[A-Za-z]+)*)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith('@')) {\n        return <span key={i} className=\"text-primary font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n  \n  return (\n    <div className=\"p-2 border-t border-border/50 space-y-2\">\n      <div className=\"text-xs text-muted-foreground\">Comments ({comments.length})</div>\n      \n      {comments.length > 0 && (\n        <div className=\"space-y-1 max-h-[100px] overflow-y-auto\">\n          {comments.map((comment: any) => (\n            <div key={comment.id} className=\"p-2 bg-secondary/30 rounded text-xs\">\n              <div className=\"flex items-center justify-between mb-1\">\n                <span className=\"font-medium\">{comment.authorName}</span>\n                <span className=\"text-muted-foreground\">\n                  {format(new Date(comment.createdAt), 'MMM d, h:mm a')}\n                </span>\n              </div>\n              <p>{renderContentWithMentions(comment.content)}</p>\n            </div>\n          ))}\n        </div>\n      )}\n      \n      <div className=\"relative\">\n        <div className=\"flex gap-2\">\n          <Input\n            ref={inputRef}\n            placeholder=\"Add a comment... (use @ to mention)\"\n            value={newComment}\n            onChange={handleInputChange}\n            className=\"h-7 text-xs\"\n            onKeyDown={handleKeyDown}\n          />\n          <Button \n            size=\"sm\" \n            className=\"h-7 px-2\"\n            onClick={handleAddComment}\n          >\n            <Plus className=\"w-3 h-3\" />\n          </Button>\n        </div>\n        {showMentionDropdown && mentionableUsers.length > 0 && (\n          <div className=\"absolute bottom-full left-0 mb-1 w-48 bg-popover border border-border rounded-md shadow-lg z-50 max-h-32 overflow-y-auto\">\n            {mentionableUsers.map((user, index) => (\n              <div\n                key={user.id}\n                className={cn(\n                  \"px-2 py-1.5 text-xs cursor-pointer flex items-center gap-2\",\n                  index === selectedMentionIndex ? \"bg-accent\" : \"hover:bg-accent\"\n                )}\n                onClick={() => insertMention(user)}\n              >\n                <div className=\"w-5 h-5 rounded-full bg-primary/20 flex items-center justify-center text-[10px] font-medium text-primary\">\n                  {user.name.split(' ').map((n: string) => n[0]).join('')}\n                </div>\n                <span>{user.name}</span>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\ntype DealManagementProps = {\n  role?: 'CEO' | 'Employee';\n};\n\nexport default function AssetManagement({ role = 'CEO' }: DealManagementProps) {\n  const searchString = useSearch();\n  const queryClient = useQueryClient();\n  const { data: currentUser } = useCurrentUser();\n  const { data: allDeals = [], isLoading } = useDealsListing();\n  const { data: allUsers = [] } = useUsers();\n  const { data: allTasks = [] } = useTasks();\n  const { data: stakeholders = [] } = useAllInvestors();\n  \n  // Filter deals based on access level - non-admin users only see deals they're assigned to\n  // Filter out Opportunities and Asset Management deals - those appear in their own respective pages\n  const deals = useMemo(() => {\n    // Filter out opportunities and asset management deals - they have their own pages\n    const investmentBankingDeals = allDeals.filter(deal => {\n      const dealType = (deal as any).dealType;\n      return dealType === 'Asset Management';\n    });\n    \n    if (currentUser?.accessLevel === 'admin') {\n      return investmentBankingDeals;\n    }\n    // For employees, filter to only show deals where they are in the pod team\n    // If user data is not yet available, show no deals until we can verify access\n    if (!currentUser?.id && !currentUser?.email && !currentUser?.name) {\n      return [];\n    }\n    return investmentBankingDeals.filter(deal => {\n      const podTeam = deal.podTeam || [];\n      return podTeam.some((member: PodTeamMember) => \n        (currentUser.id && member.userId === currentUser.id) || \n        (currentUser.email && member.email === currentUser.email) ||\n        (currentUser.name && member.name === currentUser.name)\n      );\n    });\n  }, [allDeals, role, currentUser]);\n  const createDeal = useCreateDeal();\n  const updateDeal = useUpdateDeal();\n  const deleteDeal = useDeleteDeal();\n  const moveDealToOpportunity = useMoveDealToOpportunity();\n  const createDealFee = useCreateDealFee();\n  const createDocument = useCreateDocument();\n  \n  // Custom sectors\n  const { data: customSectors = [] } = useCustomSectors();\n  const createCustomSector = useCreateCustomSector();\n  \n  // Stage-based mutations\n  const createStageDocument = useCreateStageDocument();\n  const deleteStageDocument = useDeleteStageDocument();\n  const createStagePodMember = useCreateStagePodMember();\n  const deleteStagePodMember = useDeleteStagePodMember();\n  const createStageVoiceNote = useCreateStageVoiceNote();\n  const deleteStageVoiceNote = useDeleteStageVoiceNote();\n  const createTaskComment = useCreateTaskComment();\n  const createTask = useCreateTask();\n  const deleteTask = useDeleteTask();\n\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const debouncedSearchQuery = useDebounce(searchQuery, 300);\n  const [stageFilter, setStageFilter] = useState<string | null>(null);\n  const [showNewDealModal, setShowNewDealModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [selectedDeal, setSelectedDeal] = useState<Deal | null>(null);\n  const [editingDeal, setEditingDeal] = useState<Deal | null>(null);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingLeadDealId, setEditingLeadDealId] = useState<string | null>(null);\n  const [editingLeadValue, setEditingLeadValue] = useState(\"\");\n  \n  // Client contact editing state\n  const [editingClientContact, setEditingClientContact] = useState(false);\n  const [clientContactForm, setClientContactForm] = useState({ name: '', email: '', phone: '', role: '' });\n  \n  // Fetch the FULL deal data (with attachments) when a deal is selected\n  const { data: fullDealData } = useDeal(selectedDeal?.id || '');\n  \n  // Use fullDealData for attachments display (includes large fields excluded from listing)\n  const selectedDealWithAttachments = fullDealData || selectedDeal;\n  \n  // Fetch fees for the selected deal\n  const { data: selectedDealFees = [] } = useDealFees(selectedDeal?.id || '');\n  // Fetch ALL stage pod members for the selected deal (across all stages)\n  const { data: allStagePodMembers = [] } = useStagePodMembers(selectedDeal?.id || '', undefined);\n  // Count unique team members (deduplicated by email or name)\n  const uniqueTeamCount = useMemo(() => {\n    const seen = new Set<string>();\n    allStagePodMembers.forEach((member: any) => {\n      const key = member.email || member.userName || member.userId || crypto.randomUUID();\n      seen.add(key);\n    });\n    return seen.size;\n  }, [allStagePodMembers]);\n  const [activeStageTab, setActiveStageTab] = useState(\"Reception\");\n  const [viewMode, setViewMode] = useState<'grid' | 'calendar' | 'compare'>('grid');\n  const [calendarView, setCalendarView] = useState<'day' | 'week' | 'month'>('week');\n  const [calendarDate, setCalendarDate] = useState(new Date());\n  const [selectedCalendarDeal, setSelectedCalendarDeal] = useState<Deal | null>(null);\n  const [calendarDealSearch, setCalendarDealSearch] = useState(\"\");\n  \n  const [selectedCompareDeals, setSelectedCompareDeals] = useState<string[]>([]);\n  const [compareSortBy, setCompareSortBy] = useState<string>(\"value\");\n  \n  // Task detail modal for calendar view\n  const [showTaskDetailModal, setShowTaskDetailModal] = useState(false);\n  const [selectedCalendarTask, setSelectedCalendarTask] = useState<any>(null);\n  \n  // Delete deal confirmation dialog\n  const [showDeleteDealDialog, setShowDeleteDealDialog] = useState(false);\n  const [dealToDelete, setDealToDelete] = useState<string | null>(null);\n  \n  const openTaskDetail = (task: any, deal: Deal) => {\n    setSelectedCalendarTask({ ...task, deal });\n    setShowTaskDetailModal(true);\n  };\n\n  // Voice Notes State\n  type DealVoiceNote = {\n    id: string;\n    title: string;\n    duration: number;\n    authorName: string;\n    createdAt: string;\n  };\n  const [dealVoiceNotes, setDealVoiceNotes] = useState<Record<string, DealVoiceNote[]>>({});\n  const [isRecordingVoice, setIsRecordingVoice] = useState(false);\n  const [voiceRecordingTime, setVoiceRecordingTime] = useState(0);\n  const [voiceNoteTitle, setVoiceNoteTitle] = useState(\"\");\n  const voiceRecordingInterval = useRef<NodeJS.Timeout | null>(null);\n  const voicePlaybackInterval = useRef<NodeJS.Timeout | null>(null);\n  const [playingVoiceNoteId, setPlayingVoiceNoteId] = useState<string | null>(null);\n  const [voicePlayProgress, setVoicePlayProgress] = useState(0);\n\n  // Reset voice recording state when deal changes or component unmounts\n  useEffect(() => {\n    if (isRecordingVoice) {\n      if (voiceRecordingInterval.current) {\n        clearInterval(voiceRecordingInterval.current);\n      }\n      setIsRecordingVoice(false);\n      setVoiceRecordingTime(0);\n      setVoiceNoteTitle(\"\");\n    }\n    if (playingVoiceNoteId) {\n      if (voicePlaybackInterval.current) {\n        clearInterval(voicePlaybackInterval.current);\n      }\n      setPlayingVoiceNoteId(null);\n      setVoicePlayProgress(0);\n    }\n  }, [selectedDeal?.id]);\n  \n  const [newDeal, setNewDeal] = useState({\n    name: '',\n    client: '',\n    sector: 'Real Estate',\n    customSector: '',\n    value: '',\n    stage: 'Reception',\n    lead: '',\n    status: 'Active',\n    progress: 0,\n    description: '',\n  });\n  \n  const [newDealFees, setNewDealFees] = useState<{\n    engagement: string;\n    monthly: string;\n    success: string;\n    transaction: string;\n    spread: string;\n  }>({\n    engagement: '',\n    monthly: '',\n    success: '',\n    transaction: '',\n    spread: '',\n  });\n  \n  const BASE_SECTORS = ['Real Estate', 'Infrastructure', 'Private Equity', 'Hedge Funds', 'Fixed Income', 'Equities', 'Commodities'];\n  const SECTORS = useMemo(() => {\n    const customNames = customSectors.map(s => s.name);\n    // Combine base sectors with custom sectors, avoiding duplicates\n    const allSectors = [...BASE_SECTORS, ...customNames.filter(name => !BASE_SECTORS.includes(name))];\n    return [...allSectors, 'Other'];\n  }, [customSectors]);\n  const [sectorOpen, setSectorOpen] = useState(false);\n  const [editSectorOpen, setEditSectorOpen] = useState(false);\n  const [editCustomSector, setEditCustomSector] = useState('');\n\n  const [newTeamMember, setNewTeamMember] = useState<PodTeamMember>({\n    name: '',\n    role: '',\n    email: '',\n    phone: '',\n    slack: '',\n  });\n  const [teamMemberSearch, setTeamMemberSearch] = useState('');\n  const [teamMemberOpen, setTeamMemberOpen] = useState(false);\n  \n  const filteredUsers = useMemo(() => {\n    if (!teamMemberSearch || teamMemberSearch.length < 2) return [];\n    const query = teamMemberSearch.toLowerCase();\n    return allUsers.filter(user => \n      user.name.toLowerCase().includes(query) || \n      user.email.toLowerCase().includes(query)\n    ).slice(0, 5);\n  }, [allUsers, teamMemberSearch]);\n\n  const [newInvestor, setNewInvestor] = useState<Omit<TaggedInvestor, 'id'>>({\n    name: '',\n    firm: '',\n    type: 'PE',\n    status: 'Contacted',\n    notes: '',\n    email: '',\n    phone: '',\n    website: '',\n  });\n  const [investorSearchOpen, setInvestorSearchOpen] = useState(false);\n  const [investorSearchQuery, setInvestorSearchQuery] = useState('');\n\n  const crmInvestors = useMemo(() => {\n    return stakeholders.map(s => ({\n        id: s.id,\n        name: s.name,\n        firm: s.title || s.company || s.name,\n        type: (s.notes?.match(/Type: ([^|,]+)/)?.[1]) || 'PE',\n        email: s.email || '',\n        phone: s.phone || '',\n        website: s.website || '',\n        focus: s.focus || '',\n      }));\n  }, [stakeholders]);\n\n  const filteredCrmInvestors = useMemo(() => {\n    if (!investorSearchQuery) return crmInvestors;\n    const query = investorSearchQuery.toLowerCase();\n    return crmInvestors.filter(inv => \n      inv.name.toLowerCase().includes(query) || \n      inv.firm.toLowerCase().includes(query)\n    );\n  }, [crmInvestors, investorSearchQuery]);\n\n  const handleSelectCrmInvestor = (investor: typeof crmInvestors[0]) => {\n    setNewInvestor({\n      name: investor.name,\n      firm: investor.firm,\n      type: investor.type,\n      status: 'Contacted',\n      notes: investor.focus ? `Focus: ${investor.focus}` : '',\n      email: investor.email,\n      phone: investor.phone,\n      website: investor.website,\n    });\n    setInvestorSearchOpen(false);\n    setInvestorSearchQuery('');\n  };\n\n  // Handle URL query parameter for selecting a specific deal\n  useEffect(() => {\n    if (searchString && deals.length > 0) {\n      const params = new URLSearchParams(searchString);\n      const dealId = params.get('id');\n      if (dealId) {\n        const deal = deals.find(d => d.id === dealId);\n        if (deal) {\n          setSelectedDeal(deal);\n        }\n      }\n    }\n  }, [searchString, deals]);\n\n  // Keep selectedDeal in sync with fresh data from deals query\n  useEffect(() => {\n    if (selectedDeal && deals.length > 0) {\n      const freshDeal = deals.find(d => d.id === selectedDeal.id);\n      if (freshDeal) {\n        setSelectedDeal(freshDeal);\n      }\n    }\n  }, [deals]);\n\n  const filteredDeals = useMemo(() => {\n    return deals.filter(deal => {\n      const matchesSearch = !debouncedSearchQuery || \n        deal.name.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) ||\n        deal.client.toLowerCase().includes(debouncedSearchQuery.toLowerCase()) ||\n        deal.sector.toLowerCase().includes(debouncedSearchQuery.toLowerCase());\n      const matchesStage = !stageFilter || deal.stage === stageFilter;\n      return matchesSearch && matchesStage;\n    });\n  }, [deals, debouncedSearchQuery, stageFilter]);\n\n  const getStageIndex = (stage: string) => DEAL_STAGES.indexOf(stage);\n  const getStageProgress = (stage: string) => Math.round(((getStageIndex(stage) + 1) / DEAL_STAGES.length) * 100);\n\n  // Voice Note Functions\n  const formatVoiceDuration = (seconds: number) => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  const startVoiceRecording = () => {\n    setIsRecordingVoice(true);\n    setVoiceRecordingTime(0);\n    voiceRecordingInterval.current = setInterval(() => {\n      setVoiceRecordingTime(prev => prev + 1);\n    }, 1000);\n    toast.info(\"Recording started\");\n  };\n\n  const stopVoiceRecording = () => {\n    setIsRecordingVoice(false);\n    if (voiceRecordingInterval.current) {\n      clearInterval(voiceRecordingInterval.current);\n    }\n\n    if (selectedDeal && voiceRecordingTime > 0) {\n      const newNote = {\n        id: Date.now().toString(),\n        title: voiceNoteTitle || `Note ${format(new Date(), 'MMM d, h:mm a')}`,\n        duration: voiceRecordingTime,\n        authorName: currentUser?.name || \"Unknown\",\n        createdAt: new Date().toISOString()\n      };\n\n      setDealVoiceNotes(prev => ({\n        ...prev,\n        [selectedDeal.id]: [...(prev[selectedDeal.id] || []), newNote]\n      }));\n      \n      setVoiceNoteTitle(\"\");\n      setVoiceRecordingTime(0);\n      toast.success(\"Voice note saved!\");\n    }\n  };\n\n  const cancelVoiceRecording = () => {\n    setIsRecordingVoice(false);\n    if (voiceRecordingInterval.current) {\n      clearInterval(voiceRecordingInterval.current);\n    }\n    setVoiceRecordingTime(0);\n    setVoiceNoteTitle(\"\");\n  };\n\n  const toggleVoiceNotePlay = (noteId: string, duration: number) => {\n    // Always clear any existing playback interval first\n    if (voicePlaybackInterval.current) {\n      clearInterval(voicePlaybackInterval.current);\n      voicePlaybackInterval.current = null;\n    }\n\n    if (playingVoiceNoteId === noteId) {\n      // Stop playing current note\n      setPlayingVoiceNoteId(null);\n      setVoicePlayProgress(0);\n    } else {\n      // Start playing new note\n      setPlayingVoiceNoteId(noteId);\n      setVoicePlayProgress(0);\n      voicePlaybackInterval.current = setInterval(() => {\n        setVoicePlayProgress(prev => {\n          if (prev >= 100) {\n            if (voicePlaybackInterval.current) {\n              clearInterval(voicePlaybackInterval.current);\n              voicePlaybackInterval.current = null;\n            }\n            setPlayingVoiceNoteId(null);\n            return 0;\n          }\n          return prev + (100 / duration);\n        });\n      }, 1000);\n    }\n  };\n\n  const deleteVoiceNote = (dealId: string, noteId: string) => {\n    setDealVoiceNotes(prev => ({\n      ...prev,\n      [dealId]: (prev[dealId] || []).filter(n => n.id !== noteId)\n    }));\n    toast.success(\"Voice note deleted\");\n  };\n\n  const handleCreateDeal = async () => {\n    if (!newDeal.name || !newDeal.client || !newDeal.value) {\n      toast.error(\"Please fill in all required fields\");\n      return;\n    }\n    const parsedValue = parseInt(newDeal.value);\n    if (isNaN(parsedValue) || parsedValue <= 0) {\n      toast.error(\"Please enter a valid deal value\");\n      return;\n    }\n    \n    const finalSector = newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector;\n    \n    // Save custom sector if it's a new one not in the existing list\n    const isCustomSector = newDeal.sector === 'Other' && newDeal.customSector;\n    const existingCustomSectorNames = customSectors.map(s => s.name.toLowerCase());\n    const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(newDeal.customSector.toLowerCase()) && !BASE_SECTORS.includes(newDeal.customSector);\n    \n    try {\n      // Save the custom sector first if it's new\n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(newDeal.customSector);\n        } catch (e) {\n          // Ignore if sector already exists (duplicate)\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      const createdDeal = await createDeal.mutateAsync({\n        name: newDeal.name,\n        client: newDeal.client,\n        clientContactName: null,\n        clientContactEmail: null,\n        clientContactPhone: null,\n        clientContactRole: null,\n        sector: finalSector,\n        value: parsedValue,\n        stage: newDeal.stage,\n        lead: newDeal.lead || currentUser?.name || 'Unassigned',\n        status: newDeal.status,\n        progress: getStageProgress(newDeal.stage),\n        dealType: 'Asset Management',\n        description: newDeal.description || null,\n        attachments: [],\n        podTeam: [],\n        taggedInvestors: [],\n        auditTrail: [{\n          id: crypto.randomUUID(),\n          timestamp: new Date().toISOString(),\n          action: 'Deal Created',\n          user: currentUser?.name || 'System',\n          details: `Deal \"${newDeal.name}\" created with initial stage: ${newDeal.stage}`,\n        }],\n      });\n      \n      const feePromises = [];\n      if (newDealFees.engagement && parseFloat(newDealFees.engagement) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'engagement', amount: parseFloat(newDealFees.engagement), percentage: null, currency: 'USD', description: 'Engagement fee', billingFrequency: 'one-time' }\n        }));\n      }\n      if (newDealFees.monthly && parseFloat(newDealFees.monthly) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'monthly', amount: parseFloat(newDealFees.monthly), percentage: null, currency: 'USD', description: 'Monthly retainer', billingFrequency: 'monthly' }\n        }));\n      }\n      if (newDealFees.success && parseFloat(newDealFees.success) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'success', amount: null, percentage: parseFloat(newDealFees.success), currency: 'USD', description: 'Success fee', billingFrequency: 'on-close' }\n        }));\n      }\n      if (newDealFees.transaction && parseFloat(newDealFees.transaction) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'transaction', amount: null, percentage: parseFloat(newDealFees.transaction), currency: 'USD', description: 'Transaction fee', billingFrequency: 'on-close' }\n        }));\n      }\n      if (newDealFees.spread && parseFloat(newDealFees.spread) > 0) {\n        feePromises.push(createDealFee.mutateAsync({\n          dealId: createdDeal.id,\n          fee: { feeType: 'spread', amount: null, percentage: parseFloat(newDealFees.spread), currency: 'USD', description: 'Spread', billingFrequency: 'on-close' }\n        }));\n      }\n      \n      if (feePromises.length > 0) {\n        await Promise.all(feePromises);\n      }\n      \n      toast.success(\"Deal created successfully!\");\n      setShowNewDealModal(false);\n      setNewDeal({ name: '', client: '', sector: 'Real Estate', customSector: '', value: '', stage: 'Reception', lead: '', status: 'Active', progress: 0, description: '' });\n      setNewDealFees({ engagement: '', monthly: '', success: '', transaction: '', spread: '' });\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to create deal\");\n    }\n  };\n\n  const handleStageChange = async (deal: Deal, newStage: string) => {\n    const newProgress = getStageProgress(newStage);\n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Stage Changed',\n      user: currentUser?.name || 'System',\n      details: `Stage changed from \"${deal.stage}\" to \"${newStage}\"`,\n    };\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: deal.id,\n        stage: newStage,\n        progress: newProgress,\n        auditTrail: [...(deal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      toast.success(`Deal moved to ${newStage}`);\n      if (selectedDeal?.id === deal.id) {\n        setSelectedDeal({ ...deal, stage: newStage, progress: newProgress, auditTrail: [...(deal.auditTrail as AuditEntry[] || []), auditEntry] });\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update stage\");\n    }\n  };\n\n  const handleAddTeamMember = async () => {\n    if (!selectedDeal || !newTeamMember.name || !newTeamMember.role) {\n      toast.error(\"Please fill in name and role\");\n      return;\n    }\n    \n    // Look up the real user ID based on email or name\n    const matchingUser = allUsers.find(user => \n      (newTeamMember.email && user.email === newTeamMember.email) ||\n      user.name === newTeamMember.name\n    );\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Team Member Added',\n      user: currentUser?.name || 'System',\n      details: `Added ${newTeamMember.name} (${newTeamMember.role}) to pod team`,\n    };\n\n    // Use the real user ID if found, otherwise generate a random one for external contacts\n    const userId = matchingUser?.id || crypto.randomUUID();\n    const updatedPodTeam = [...(selectedDeal.podTeam as PodTeamMember[] || []), { ...newTeamMember, userId }];\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        podTeam: updatedPodTeam,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, podTeam: updatedPodTeam, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      setNewTeamMember({ name: '', role: '', email: '', phone: '', slack: '' });\n      toast.success(\"Team member added!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add team member\");\n    }\n  };\n\n  const handleRemoveTeamMember = async (memberIndex: number) => {\n    if (!selectedDeal) return;\n    const member = (selectedDeal.podTeam as PodTeamMember[])?.[memberIndex];\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Team Member Removed',\n      user: currentUser?.name || 'System',\n      details: `Removed ${member?.name} from pod team`,\n    };\n\n    const updatedPodTeam = (selectedDeal.podTeam as PodTeamMember[] || []).filter((_, i) => i !== memberIndex);\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        podTeam: updatedPodTeam,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, podTeam: updatedPodTeam, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Team member removed\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove team member\");\n    }\n  };\n\n  const handleAddInvestor = async () => {\n    if (!selectedDeal || !newInvestor.name || !newInvestor.firm) {\n      toast.error(\"Please fill in investor name and firm\");\n      return;\n    }\n    \n    const investor: TaggedInvestor = {\n      ...newInvestor,\n      id: crypto.randomUUID(),\n    };\n\n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Tagged',\n      user: currentUser?.name || 'System',\n      details: `Tagged ${newInvestor.name} from ${newInvestor.firm} (${newInvestor.type})`,\n    };\n\n    const updatedInvestors = [...(selectedDeal.taggedInvestors as TaggedInvestor[] || []), investor];\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      setNewInvestor({ name: '', firm: '', type: 'PE', status: 'Contacted', notes: '', email: '', phone: '', website: '' });\n      toast.success(\"Investor tagged!\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to add investor\");\n    }\n  };\n\n  const handleUpdateInvestorStatus = async (investorId: string, newStatus: string) => {\n    if (!selectedDeal) return;\n    \n    const investor = (selectedDeal.taggedInvestors as TaggedInvestor[])?.find(i => i.id === investorId);\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Status Updated',\n      user: currentUser?.name || 'System',\n      details: `${investor?.name} status changed to \"${newStatus}\"`,\n    };\n\n    const updatedInvestors = (selectedDeal.taggedInvestors as TaggedInvestor[] || []).map(i => \n      i.id === investorId ? { ...i, status: newStatus } : i\n    );\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Investor status updated\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update investor status\");\n    }\n  };\n\n  const handleRemoveInvestor = async (investorId: string) => {\n    if (!selectedDeal) return;\n    const investor = (selectedDeal.taggedInvestors as TaggedInvestor[])?.find(i => i.id === investorId);\n    \n    const auditEntry: AuditEntry = {\n      id: crypto.randomUUID(),\n      timestamp: new Date().toISOString(),\n      action: 'Investor Removed',\n      user: currentUser?.name || 'System',\n      details: `Removed ${investor?.name} from ${investor?.firm}`,\n    };\n\n    const updatedInvestors = (selectedDeal.taggedInvestors as TaggedInvestor[] || []).filter(i => i.id !== investorId);\n    \n    try {\n      await updateDeal.mutateAsync({\n        id: selectedDeal.id,\n        taggedInvestors: updatedInvestors,\n        auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry],\n      });\n      setSelectedDeal({ ...selectedDeal, taggedInvestors: updatedInvestors, auditTrail: [...(selectedDeal.auditTrail as AuditEntry[] || []), auditEntry] });\n      toast.success(\"Investor removed\");\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to remove investor\");\n    }\n  };\n\n  const handleEditDeal = async () => {\n    if (!editingDeal) return;\n    \n    // Handle custom sector\n    const finalSector = editingDeal.sector === 'Other' && editCustomSector ? editCustomSector : editingDeal.sector;\n    \n    // Save custom sector if it's a new one\n    const isCustomSector = editingDeal.sector === 'Other' && editCustomSector;\n    const existingCustomSectorNames = customSectors.map(s => s.name.toLowerCase());\n    const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(editCustomSector.toLowerCase()) && !BASE_SECTORS.includes(editCustomSector);\n    \n    try {\n      // Save the custom sector first if it's new\n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(editCustomSector);\n        } catch (e) {\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      await updateDeal.mutateAsync({\n        id: editingDeal.id,\n        name: editingDeal.name,\n        client: editingDeal.client,\n        sector: finalSector,\n        value: editingDeal.value,\n        stage: editingDeal.stage,\n        lead: editingDeal.lead,\n        status: editingDeal.status,\n        progress: editingDeal.progress,\n      });\n      toast.success(\"Deal updated successfully!\");\n      setShowEditModal(false);\n      setEditingDeal(null);\n      setEditCustomSector('');\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to update deal\");\n    }\n  };\n\n  const handleDeleteDeal = async (dealId: string) => {\n    try {\n      await deleteDeal.mutateAsync(dealId);\n      toast.success(\"Deal deleted successfully!\");\n      if (selectedDeal?.id === dealId) {\n        setSelectedDeal(null);\n      }\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to delete deal\");\n    }\n  };\n\n  const openEditModal = (deal: Deal) => {\n    setEditingDeal(deal);\n    // If the current sector is not in the SECTORS list, it's a custom sector\n    const isCustom = !BASE_SECTORS.includes(deal.sector) && deal.sector !== 'Other';\n    if (isCustom) {\n      setEditCustomSector(deal.sector);\n      setEditingDeal({ ...deal, sector: 'Other' });\n    } else {\n      setEditCustomSector('');\n    }\n    setShowEditModal(true);\n  };\n\n  if (isLoading) {\n    return (\n      <Layout role={role} pageTitle=\"Asset Management\" userName={currentUser?.name || \"\"}>\n        <div className=\"flex items-center justify-center h-96\">\n          <div className=\"text-muted-foreground\">Loading deals...</div>\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role} pageTitle=\"Asset Management\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        {/* Header & Filters */}\n        <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n          <div className=\"relative flex-1 max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n            <Input \n              placeholder=\"Search AM deals by name, client, or sector...\" \n              className=\"pl-9 bg-card border-border\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              data-testid=\"input-search-deals\"\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            {/* View Mode Toggle */}\n            <div className=\"flex items-center bg-card border border-border rounded-md overflow-hidden\">\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none border-r border-border\", viewMode === 'grid' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('grid')}\n                data-testid=\"button-view-grid\"\n              >\n                <LayoutGrid className=\"w-4 h-4\" />\n              </Button>\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none border-r border-border\", viewMode === 'calendar' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('calendar')}\n                data-testid=\"button-view-calendar\"\n              >\n                <CalendarDays className=\"w-4 h-4\" />\n              </Button>\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className={cn(\"rounded-none\", viewMode === 'compare' && \"bg-primary/10 text-primary\")}\n                onClick={() => setViewMode('compare')}\n                data-testid=\"button-view-compare\"\n              >\n                <GitCompare className=\"w-4 h-4\" />\n              </Button>\n            </div>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"outline\" className=\"bg-card border-border gap-2\">\n                  <Filter className=\"w-4 h-4\" /> {stageFilter || 'All Stages'}\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent>\n                <DropdownMenuItem onClick={() => setStageFilter(null)}>All Stages</DropdownMenuItem>\n                <DropdownMenuSeparator />\n                {DEAL_STAGES.map(stage => (\n                  <DropdownMenuItem key={stage} onClick={() => setStageFilter(stage)}>{stage}</DropdownMenuItem>\n                ))}\n              </DropdownMenuContent>\n            </DropdownMenu>\n            {currentUser?.accessLevel === 'admin' && (\n              <Button \n                className=\"bg-primary text-primary-foreground hover:bg-primary/90\"\n                onClick={() => setShowNewDealModal(true)}\n                data-testid=\"button-new-deal\"\n              >\n                <Plus className=\"w-4 h-4 mr-1\" /> New Deal\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {/* Calendar View */}\n        {viewMode === 'calendar' && (() => {\n          const getCalendarDays = () => {\n            if (calendarView === 'day') {\n              return [calendarDate];\n            } else if (calendarView === 'week') {\n              const start = startOfWeek(calendarDate, { weekStartsOn: 0 });\n              const end = endOfWeek(calendarDate, { weekStartsOn: 0 });\n              return eachDayOfInterval({ start, end });\n            } else {\n              const monthStart = startOfMonth(calendarDate);\n              const monthEnd = endOfMonth(calendarDate);\n              const calendarStart = startOfWeek(monthStart, { weekStartsOn: 0 });\n              const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: 0 });\n              return eachDayOfInterval({ start: calendarStart, end: calendarEnd });\n            }\n          };\n\n          const navigatePrev = () => {\n            if (calendarView === 'day') setCalendarDate(subDays(calendarDate, 1));\n            else if (calendarView === 'week') setCalendarDate(subWeeks(calendarDate, 1));\n            else setCalendarDate(subMonths(calendarDate, 1));\n          };\n\n          const navigateNext = () => {\n            if (calendarView === 'day') setCalendarDate(addDays(calendarDate, 1));\n            else if (calendarView === 'week') setCalendarDate(addWeeks(calendarDate, 1));\n            else setCalendarDate(addMonths(calendarDate, 1));\n          };\n\n          const getEventsForDay = (day: Date) => {\n            const events: { type: 'task' | 'milestone' | 'stage_change'; deal: Deal; item?: any; date: Date }[] = [];\n            \n            if (!selectedCalendarDeal) return events;\n            \n            const deal = selectedCalendarDeal;\n            const dealTasks = allTasks.filter((t: any) => t.dealId === deal.id);\n            dealTasks.forEach((task: any) => {\n              if (task.dueDate && isSameDay(parseISO(task.dueDate), day)) {\n                events.push({ type: 'task', deal, item: task, date: day });\n              }\n            });\n            \n            const auditTrail = deal.auditTrail as AuditEntry[] || [];\n            auditTrail.forEach(entry => {\n              if (entry.timestamp && isSameDay(parseISO(entry.timestamp), day)) {\n                if (entry.action === 'Stage Changed' || entry.action === 'Deal Created') {\n                  events.push({ type: 'milestone', deal, item: entry, date: day });\n                }\n              }\n            });\n            \n            return events;\n          };\n\n          const filteredCalendarDeals = deals.filter(deal =>\n            deal.name.toLowerCase().includes(calendarDealSearch.toLowerCase()) ||\n            deal.client.toLowerCase().includes(calendarDealSearch.toLowerCase())\n          );\n\n          const calendarDays = getCalendarDays();\n\n          return (\n            <div className=\"space-y-4\">\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <CalendarDays className=\"w-5 h-5 text-primary\" />\n                        <CardTitle className=\"text-lg\">Deal Calendar</CardTitle>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"flex bg-secondary rounded-lg p-0.5\">\n                          <Button \n                            variant={calendarView === 'day' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('day')}\n                            data-testid=\"calendar-view-day\"\n                          >\n                            Day\n                          </Button>\n                          <Button \n                            variant={calendarView === 'week' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('week')}\n                            data-testid=\"calendar-view-week\"\n                          >\n                            Week\n                          </Button>\n                          <Button \n                            variant={calendarView === 'month' ? 'default' : 'ghost'} \n                            size=\"sm\" \n                            className=\"h-7 px-3 text-xs\"\n                            onClick={() => setCalendarView('month')}\n                            data-testid=\"calendar-view-month\"\n                          >\n                            Month\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                    \n                    {/* Deal Selector */}\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"relative flex-1 max-w-md\">\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                        <Input\n                          placeholder=\"Search and select a deal...\"\n                          value={calendarDealSearch}\n                          onChange={(e) => setCalendarDealSearch(e.target.value)}\n                          className=\"pl-9 bg-secondary/50 border-border\"\n                          data-testid=\"calendar-deal-search\"\n                        />\n                        {calendarDealSearch && (\n                          <div className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-card border border-border rounded-lg shadow-xl max-h-[200px] overflow-y-auto\">\n                            {filteredCalendarDeals.length === 0 ? (\n                              <div className=\"p-3 text-sm text-muted-foreground text-center\">No deals found</div>\n                            ) : (\n                              filteredCalendarDeals.map(deal => (\n                                <div\n                                  key={deal.id}\n                                  className=\"p-3 hover:bg-secondary/50 cursor-pointer transition-colors border-b border-border/50 last:border-b-0\"\n                                  onClick={() => {\n                                    setSelectedCalendarDeal(deal);\n                                    setCalendarDealSearch(\"\");\n                                  }}\n                                  data-testid={`calendar-deal-option-${deal.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{deal.name}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{deal.client}{deal.sector ? `  ${deal.sector}` : ''}  {deal.stage}</div>\n                                </div>\n                              ))\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      {selectedCalendarDeal && (\n                        <div className=\"flex items-center gap-2 px-3 py-2 bg-primary/10 border border-primary/30 rounded-lg\">\n                          <Briefcase className=\"w-4 h-4 text-primary\" />\n                          <span className=\"text-sm font-medium\">{selectedCalendarDeal.name}</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-5 w-5 ml-1\"\n                            onClick={() => setSelectedCalendarDeal(null)}\n                            data-testid=\"calendar-clear-deal\"\n                          >\n                            <X className=\"w-3 h-3\" />\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={navigatePrev}>\n                      <ChevronLeft className=\"w-4 h-4\" />\n                    </Button>\n                    <h3 className=\"text-lg font-semibold\">\n                      {calendarView === 'day' && format(calendarDate, 'EEEE, MMMM d, yyyy')}\n                      {calendarView === 'week' && `${format(startOfWeek(calendarDate, { weekStartsOn: 0 }), 'MMM d')} - ${format(endOfWeek(calendarDate, { weekStartsOn: 0 }), 'MMM d, yyyy')}`}\n                      {calendarView === 'month' && format(calendarDate, 'MMMM yyyy')}\n                    </h3>\n                    <div className=\"flex items-center gap-2\">\n                      <Button variant=\"outline\" size=\"sm\" onClick={() => setCalendarDate(new Date())}>\n                        Today\n                      </Button>\n                      <Button variant=\"outline\" size=\"sm\" onClick={navigateNext}>\n                        <ChevronRight className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {!selectedCalendarDeal && (\n                    <div className=\"text-center py-16 text-muted-foreground\">\n                      <Briefcase className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\n                      <h3 className=\"text-lg font-medium mb-2\">Select a Deal</h3>\n                      <p className=\"text-sm\">Use the search box above to select a deal and view its calendar events</p>\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'month' && (\n                    <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n                      {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (\n                        <div key={day} className=\"bg-secondary p-2 text-center text-xs font-medium text-muted-foreground\">\n                          {day}\n                        </div>\n                      ))}\n                      {calendarDays.map((day, index) => {\n                        const events = getEventsForDay(day);\n                        const isCurrentMonth = day.getMonth() === calendarDate.getMonth();\n                        return (\n                          <div \n                            key={index} \n                            className={cn(\n                              \"bg-card min-h-[100px] p-2 transition-colors\",\n                              !isCurrentMonth && \"opacity-40\",\n                              isToday(day) && \"ring-2 ring-primary ring-inset\"\n                            )}\n                          >\n                            <div className={cn(\n                              \"text-sm font-medium mb-1\",\n                              isToday(day) ? \"text-primary\" : \"text-foreground\"\n                            )}>\n                              {format(day, 'd')}\n                            </div>\n                            <div className=\"space-y-1\">\n                              {events.slice(0, 3).map((event, i) => (\n                                <div \n                                  key={i}\n                                  className={cn(\n                                    \"text-[10px] px-1.5 py-0.5 rounded truncate cursor-pointer hover:opacity-80\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20 text-green-400\" : \"bg-blue-500/20 text-blue-400\"),\n                                    event.type === 'milestone' && \"bg-purple-500/20 text-purple-400\"\n                                  )}\n                                  onClick={() => { setSelectedDeal(event.deal); setActiveTab(\"overview\"); }}\n                                >\n                                  {event.type === 'task' ? event.item?.title : event.item?.action}\n                                </div>\n                              ))}\n                              {events.length > 3 && (\n                                <div className=\"text-[10px] text-muted-foreground pl-1\">\n                                  +{events.length - 3} more\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'week' && (\n                    <div className=\"grid grid-cols-7 gap-2\">\n                      {calendarDays.map((day, index) => {\n                        const events = getEventsForDay(day);\n                        return (\n                          <div \n                            key={index} \n                            className={cn(\n                              \"bg-secondary/30 rounded-lg p-3 min-h-[200px] transition-colors\",\n                              isToday(day) && \"ring-2 ring-primary\"\n                            )}\n                          >\n                            <div className={cn(\n                              \"text-center mb-2 pb-2 border-b border-border\",\n                              isToday(day) ? \"text-primary\" : \"\"\n                            )}>\n                              <div className=\"text-xs text-muted-foreground\">{format(day, 'EEE')}</div>\n                              <div className=\"text-lg font-bold\">{format(day, 'd')}</div>\n                            </div>\n                            <ScrollArea className=\"h-[150px]\">\n                              <div className=\"space-y-1.5\">\n                                {events.map((event, i) => (\n                                  <div \n                                    key={i}\n                                    className={cn(\n                                      \"text-xs p-2 rounded cursor-pointer hover:opacity-80 transition-opacity\",\n                                      event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20 text-green-400\" : \"bg-blue-500/20 text-blue-400\"),\n                                      event.type === 'milestone' && \"bg-purple-500/20 text-purple-400\"\n                                    )}\n                                    onClick={() => {\n                                      if (event.type === 'task') {\n                                        openTaskDetail(event.item, event.deal);\n                                      } else {\n                                        setSelectedDeal(event.deal); \n                                        setActiveTab(\"overview\");\n                                      }\n                                    }}\n                                  >\n                                    <div className=\"font-medium truncate\">{event.type === 'task' ? event.item?.title : event.item?.action}</div>\n                                    <div className=\"text-[10px] opacity-70 truncate\">{event.deal.name}</div>\n                                  </div>\n                                ))}\n                                {events.length === 0 && (\n                                  <div className=\"text-xs text-muted-foreground text-center py-4\">No events</div>\n                                )}\n                              </div>\n                            </ScrollArea>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {selectedCalendarDeal && calendarView === 'day' && (\n                    <div className=\"space-y-4\">\n                      {(() => {\n                        const events = getEventsForDay(calendarDate);\n                        const deal = selectedCalendarDeal;\n\n                        if (events.length === 0) {\n                          return (\n                            <div className=\"text-center py-12 text-muted-foreground\">\n                              <CalendarDays className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                              <p>No events scheduled for this day</p>\n                            </div>\n                          );\n                        }\n\n                        return (\n                          <Card className=\"bg-secondary/30 border-border\">\n                            <CardHeader className=\"pb-2\">\n                              <div className=\"flex items-center justify-between\">\n                                <div>\n                                  <CardTitle className=\"text-base\">{deal.name}</CardTitle>\n                                  <CardDescription>{deal.client}{deal.sector ? `  ${deal.sector}` : ''}</CardDescription>\n                                </div>\n                                <Badge variant=\"outline\">{deal.stage}</Badge>\n                              </div>\n                            </CardHeader>\n                            <CardContent className=\"space-y-2\">\n                              {events.map((event, i) => (\n                                <div \n                                  key={i}\n                                  className={cn(\n                                    \"flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-secondary/50 transition-colors\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/10\" : \"bg-blue-500/10\"),\n                                    event.type === 'milestone' && \"bg-purple-500/10\"\n                                  )}\n                                  onClick={() => {\n                                    if (event.type === 'task') {\n                                      openTaskDetail(event.item, deal);\n                                    } else {\n                                      setSelectedDeal(deal); \n                                      setActiveTab(\"overview\");\n                                    }\n                                  }}\n                                >\n                                  <div className={cn(\n                                    \"w-8 h-8 rounded-full flex items-center justify-center\",\n                                    event.type === 'task' && (event.item?.status === 'Completed' ? \"bg-green-500/20\" : \"bg-blue-500/20\"),\n                                    event.type === 'milestone' && \"bg-purple-500/20\"\n                                  )}>\n                                    {event.type === 'task' ? (\n                                      event.item?.status === 'Completed' ? <CheckCircle2 className=\"w-4 h-4 text-green-400\" /> : <Clock className=\"w-4 h-4 text-blue-400\" />\n                                    ) : (\n                                      <TrendingUp className=\"w-4 h-4 text-purple-400\" />\n                                    )}\n                                  </div>\n                                  <div className=\"flex-1\">\n                                    <div className=\"font-medium text-sm\">\n                                      {event.type === 'task' ? event.item?.title : event.item?.action}\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      {event.type === 'task' ? `Priority: ${event.item?.priority}` : event.item?.details}\n                                    </div>\n                                  </div>\n                                  <Badge variant=\"secondary\" className=\"text-[10px]\">\n                                    {event.type === 'task' ? event.item?.status : 'Milestone'}\n                                  </Badge>\n                                </div>\n                              ))}\n                            </CardContent>\n                          </Card>\n                        );\n                      })()}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card border-border\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Legend</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap gap-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-blue-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Pending Task</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-green-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Completed Task</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded bg-purple-500/50\"></div>\n                      <span className=\"text-sm text-muted-foreground\">Milestone / Stage Change</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          );\n        })()}\n\n        {/* Deals Grid */}\n        {viewMode === 'grid' && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {filteredDeals.map((deal) => (\n            <Card \n              key={deal.id} \n              className=\"bg-card border-border hover:shadow-lg hover:shadow-primary/5 transition-all duration-300 group\" \n              data-testid={`card-deal-${deal.id}`}\n            >\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex justify-between items-start\">\n                  <Badge variant=\"outline\" className={cn(\n                    \"border-0 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider\",\n                    deal.stage === 'Reception' ? \"bg-blue-500/20 text-blue-400\" :\n                    deal.stage === 'Initial Review' ? \"bg-purple-500/20 text-purple-400\" :\n                    deal.stage === 'Hard Diligence' ? \"bg-orange-500/20 text-orange-400\" :\n                    deal.stage === 'Structure' ? \"bg-cyan-500/20 text-cyan-400\" :\n                    deal.stage === 'Negotiation' ? \"bg-yellow-500/20 text-yellow-400\" :\n                    deal.stage === 'Closing' ? \"bg-pink-500/20 text-pink-400\" :\n                    \"bg-green-500/20 text-green-400\"\n                  )}>\n                    {deal.stage}\n                  </Badge>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 -mr-2\">\n                        <MoreVertical className=\"w-4 h-4 text-muted-foreground\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => { setSelectedDeal(deal); setActiveTab(\"overview\"); }}>\n                        <Eye className=\"w-4 h-4 mr-2\" /> View Details\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => openEditModal(deal)}>\n                        <Pencil className=\"w-4 h-4 mr-2\" /> Edit Deal\n                      </DropdownMenuItem>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem \n                        className=\"text-red-500\" \n                        onClick={() => {\n                          setDealToDelete(deal.id);\n                          setShowDeleteDealDialog(true);\n                        }}\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" /> Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n                <CardTitle className=\"text-xl mt-2 group-hover:text-primary transition-colors\">{deal.name}</CardTitle>\n                <CardDescription>{deal.client}{deal.sector ? <>  <span className=\"font-medium\">{deal.sector}</span></> : ''}</CardDescription>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-4\">\n                {/* Stage Progress Bar - Click icons to change stage */}\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between items-center\">\n                    {DEAL_STAGES.map((stage, index) => {\n                      const isActive = getStageIndex(deal.stage) >= index;\n                      const isCurrent = deal.stage === stage;\n                      return (\n                        <div \n                          key={stage} \n                          className=\"flex flex-col items-center flex-1 cursor-pointer group/stage\"\n                          onClick={() => handleStageChange(deal, stage)}\n                          data-testid={`stage-icon-${deal.id}-${stage.toLowerCase().replace(' ', '-')}`}\n                        >\n                          <div className={cn(\n                            \"w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold transition-all\",\n                            isCurrent ? \"bg-primary text-primary-foreground ring-2 ring-primary/30\" :\n                            isActive ? \"bg-primary/60 text-primary-foreground\" :\n                            \"bg-secondary text-muted-foreground\",\n                            \"group-hover/stage:ring-2 group-hover/stage:ring-primary/50 group-hover/stage:scale-110\"\n                          )}>\n                            {isActive ? <CheckCircle2 className=\"w-3.5 h-3.5\" /> : index + 1}\n                          </div>\n                          <span className={cn(\n                            \"text-[8px] mt-1 truncate max-w-full transition-colors\",\n                            isCurrent ? \"text-primary font-bold\" :\n                            isActive ? \"text-foreground\" : \"text-muted-foreground\",\n                            \"group-hover/stage:text-primary\"\n                          )}>{stage.slice(0, 4)}</span>\n                        </div>\n                      );\n                    })}\n                  </div>\n                  <div className=\"h-1 bg-secondary rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-primary transition-all duration-500\" \n                      style={{ width: `${getStageProgress(deal.stage)}%` }}\n                    />\n                  </div>\n                  <p className=\"text-[9px] text-muted-foreground text-center\">Click any stage to update</p>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-1\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider flex items-center gap-1\">\n                      <DollarSign className=\"w-3 h-3\" /> Value\n                    </div>\n                    <div className=\"font-mono font-bold text-lg\">${deal.value}M</div>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider flex items-center gap-1\">\n                      <Users className=\"w-3 h-3\" /> Team\n                    </div>\n                    <DealTotalTeamCount dealId={deal.id} podTeam={(deal.podTeam as PodTeamMember[]) || []} />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-2 pt-2\">\n                  <div className=\"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-[10px] font-bold text-primary\">\n                    {deal.lead.split(' ').map(n => n[0]).join('')}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground\">Lead: {deal.lead}</span>\n                </div>\n              </CardContent>\n              \n              <CardFooter className=\"pt-2\">\n                <Button \n                  className=\"w-full bg-secondary hover:bg-primary hover:text-primary-foreground text-secondary-foreground transition-colors gap-2\"\n                  onClick={() => { setSelectedDeal(deal); setActiveTab(\"overview\"); }}\n                  data-testid={`button-view-deal-${deal.id}`}\n                >\n                  View Deal Room <ArrowRight className=\"w-4 h-4\" />\n                </Button>\n              </CardFooter>\n            </Card>\n          ))}\n        </div>\n        )}\n\n        {filteredDeals.length === 0 && viewMode !== 'compare' && (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            {searchQuery || stageFilter ? \"No deals match your search criteria\" : \"No deals yet. Create your first deal!\"}\n          </div>\n        )}\n\n        {/* Comparison View */}\n        {viewMode === 'compare' && (() => {\n          const selectedDealsData = deals.filter(d => selectedCompareDeals.includes(d.id));\n          \n          const getStageValue = (stage: string) => {\n            const stageIndex = DEAL_STAGES.indexOf(stage);\n            return ((stageIndex + 1) / DEAL_STAGES.length) * 100;\n          };\n          \n          const getTeamScore = (deal: Deal) => {\n            const podTeam = (deal.podTeam as PodTeamMember[]) || [];\n            return Math.min(podTeam.length * 20, 100);\n          };\n          \n          const getInvestorScore = (deal: Deal) => {\n            const investors = (deal.taggedInvestors as TaggedInvestor[]) || [];\n            return Math.min(investors.length * 15, 100);\n          };\n          \n          const getDocumentScore = (deal: Deal) => {\n            const attachments = (deal.attachments as any[]) || [];\n            return Math.min(attachments.length * 10, 100);\n          };\n          \n          const maxValue = Math.max(...deals.map(d => d.value || 0), 1);\n          \n          const radarData = [\n            { metric: 'Deal Value', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, ((d.value || 0) / maxValue) * 100])) },\n            { metric: 'Stage Progress', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getStageValue(d.stage)])) },\n            { metric: 'Team Size', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getTeamScore(d)])) },\n            { metric: 'Investors', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getInvestorScore(d)])) },\n            { metric: 'Documents', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, getDocumentScore(d)])) },\n            { metric: 'Progress', fullMark: 100, ...Object.fromEntries(selectedDealsData.map(d => [d.name, d.progress || 0])) },\n          ];\n          \n          const toggleDealSelection = (dealId: string) => {\n            if (selectedCompareDeals.includes(dealId)) {\n              setSelectedCompareDeals(selectedCompareDeals.filter(id => id !== dealId));\n            } else if (selectedCompareDeals.length < 5) {\n              setSelectedCompareDeals([...selectedCompareDeals, dealId]);\n            } else {\n              toast.error(\"You can compare up to 5 deals at a time\");\n            }\n          };\n          \n          const sortedDeals = [...deals].sort((a, b) => {\n            switch (compareSortBy) {\n              case 'value': return (b.value || 0) - (a.value || 0);\n              case 'stage': return getStageValue(b.stage) - getStageValue(a.stage);\n              case 'name': return a.name.localeCompare(b.name);\n              default: return 0;\n            }\n          });\n          \n          return (\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                {/* Deal Selection Panel */}\n                <Card className=\"lg:col-span-1\">\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"text-lg flex items-center gap-2\">\n                        <Briefcase className=\"w-5 h-5\" /> Select Deals\n                      </CardTitle>\n                      <Badge variant=\"secondary\">{selectedCompareDeals.length}/5</Badge>\n                    </div>\n                    <CardDescription>Choose up to 5 deals to compare</CardDescription>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Select value={compareSortBy} onValueChange={setCompareSortBy}>\n                        <SelectTrigger className=\"w-full\">\n                          <ArrowUpDown className=\"w-4 h-4 mr-2\" />\n                          <SelectValue placeholder=\"Sort by\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"value\">Sort by Value</SelectItem>\n                          <SelectItem value=\"stage\">Sort by Stage</SelectItem>\n                          <SelectItem value=\"name\">Sort by Name</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <ScrollArea className=\"h-[400px]\">\n                      <div className=\"space-y-2 pr-4\">\n                        {sortedDeals.map((deal) => (\n                          <div\n                            key={deal.id}\n                            className={cn(\n                              \"p-3 rounded-lg border cursor-pointer transition-all\",\n                              selectedCompareDeals.includes(deal.id)\n                                ? \"border-primary bg-primary/10\"\n                                : \"border-border hover:border-primary/50\"\n                            )}\n                            onClick={() => toggleDealSelection(deal.id)}\n                            data-testid={`compare-deal-${deal.id}`}\n                          >\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2\">\n                                  <Checkbox\n                                    checked={selectedCompareDeals.includes(deal.id)}\n                                    onCheckedChange={() => toggleDealSelection(deal.id)}\n                                  />\n                                  <span className=\"font-medium truncate\">{deal.name}</span>\n                                </div>\n                                <div className=\"text-xs text-muted-foreground mt-1\">{deal.client}</div>\n                              </div>\n                              <Badge variant=\"outline\" className=\"shrink-0\">${deal.value}M</Badge>\n                            </div>\n                            <div className=\"flex items-center gap-2 mt-2\">\n                              <Badge className=\"text-xs\" variant=\"secondary\">{deal.stage}</Badge>\n                              <Badge className={cn(\n                                \"text-xs\",\n                                deal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                                deal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                                \"bg-gray-500/20 text-gray-400\"\n                              )}>{deal.status}</Badge>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                    {selectedCompareDeals.length > 0 && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"w-full\"\n                        onClick={() => setSelectedCompareDeals([])}\n                      >\n                        Clear Selection\n                      </Button>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Comparison Charts */}\n                <Card className=\"lg:col-span-2\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <BarChart3 className=\"w-5 h-5\" /> Deal Comparison\n                    </CardTitle>\n                    <CardDescription>\n                      {selectedCompareDeals.length === 0 \n                        ? \"Select deals from the left panel to compare them\"\n                        : `Comparing ${selectedCompareDeals.length} deal${selectedCompareDeals.length > 1 ? 's' : ''}`}\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {selectedCompareDeals.length === 0 ? (\n                      <div className=\"h-[400px] flex items-center justify-center text-muted-foreground\">\n                        <div className=\"text-center\">\n                          <GitCompare className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                          <p>Select at least one deal to see comparison</p>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"h-[400px]\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                          <RadarChart data={radarData}>\n                            <PolarGrid stroke=\"hsl(var(--border))\" />\n                            <PolarAngleAxis \n                              dataKey=\"metric\" \n                              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 12 }}\n                            />\n                            <PolarRadiusAxis \n                              angle={30} \n                              domain={[0, 100]} \n                              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10 }}\n                            />\n                            {selectedDealsData.map((deal, index) => (\n                              <Radar\n                                key={deal.id}\n                                name={deal.name}\n                                dataKey={deal.name}\n                                stroke={COMPARISON_COLORS[index % COMPARISON_COLORS.length]}\n                                fill={COMPARISON_COLORS[index % COMPARISON_COLORS.length]}\n                                fillOpacity={0.2}\n                              />\n                            ))}\n                            <Legend />\n                            <Tooltip\n                              contentStyle={{\n                                backgroundColor: 'hsl(var(--card))',\n                                border: '1px solid hsl(var(--border))',\n                                borderRadius: '8px'\n                              }}\n                            />\n                          </RadarChart>\n                        </ResponsiveContainer>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Comparison Table */}\n              {selectedCompareDeals.length > 0 && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Detailed Comparison</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"overflow-x-auto\">\n                      <table className=\"w-full\">\n                        <thead>\n                          <tr className=\"border-b border-border\">\n                            <th className=\"text-left py-3 px-4 text-sm font-medium text-muted-foreground\">Metric</th>\n                            {selectedDealsData.map((deal, index) => (\n                              <th \n                                key={deal.id} \n                                className=\"text-left py-3 px-4 text-sm font-medium\"\n                                style={{ color: COMPARISON_COLORS[index % COMPARISON_COLORS.length] }}\n                              >\n                                {deal.name}\n                              </th>\n                            ))}\n                          </tr>\n                        </thead>\n                        <tbody>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Deal Value</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4 font-mono font-semibold\">${deal.value}M</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Client</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.client}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Sector</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.sector}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Stage</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <Badge variant=\"secondary\">{deal.stage}</Badge>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Status</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <Badge className={cn(\n                                  deal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                                  deal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                                  \"bg-gray-500/20 text-gray-400\"\n                                )}>{deal.status}</Badge>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Progress</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"w-24 h-2 bg-secondary rounded-full overflow-hidden\">\n                                    <div \n                                      className=\"h-full bg-primary\" \n                                      style={{ width: `${deal.progress || 0}%` }}\n                                    />\n                                  </div>\n                                  <span className=\"text-sm\">{deal.progress || 0}%</span>\n                                </div>\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Lead</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">{deal.lead}</td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Team Size</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.podTeam as PodTeamMember[]) || []).length} members\n                              </td>\n                            ))}\n                          </tr>\n                          <tr className=\"border-b border-border/50\">\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Tagged Investors</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.taggedInvestors as TaggedInvestor[]) || []).length} investors\n                              </td>\n                            ))}\n                          </tr>\n                          <tr>\n                            <td className=\"py-3 px-4 text-sm text-muted-foreground\">Documents</td>\n                            {selectedDealsData.map(deal => (\n                              <td key={deal.id} className=\"py-3 px-4\">\n                                {((deal.attachments as any[]) || []).length} files\n                              </td>\n                            ))}\n                          </tr>\n                        </tbody>\n                      </table>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          );\n        })()}\n      </div>\n\n      {/* Deal Room Sheet */}\n      <Sheet open={!!selectedDeal} onOpenChange={() => setSelectedDeal(null)}>\n        <SheetContent className=\"w-full sm:max-w-2xl bg-card border-border overflow-y-auto\">\n          {selectedDeal && (\n            <>\n              <SheetHeader className=\"pb-4 border-b border-border\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <SheetTitle className=\"text-2xl\">{selectedDeal.name}</SheetTitle>\n                    <SheetDescription>{selectedDeal.client}  {selectedDeal.sector}</SheetDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <AlertDialog>\n                      <AlertDialogTrigger asChild>\n                        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-move-to-opportunities\">\n                          <ArrowLeftCircle className=\"w-4 h-4 mr-2\" />\n                          Move to Opportunities\n                        </Button>\n                      </AlertDialogTrigger>\n                      <AlertDialogContent>\n                        <AlertDialogHeader>\n                          <AlertDialogTitle>Move to Opportunities?</AlertDialogTitle>\n                          <AlertDialogDescription>\n                            This will move \"{selectedDeal.name}\" back to the Opportunities page. The deal stage will be reset to \"Origination\".\n                          </AlertDialogDescription>\n                        </AlertDialogHeader>\n                        <AlertDialogFooter>\n                          <AlertDialogCancel>Cancel</AlertDialogCancel>\n                          <AlertDialogAction\n                            onClick={() => {\n                              moveDealToOpportunity.mutate(selectedDeal.id, {\n                                onSuccess: () => {\n                                  toast.success('Deal moved to Opportunities');\n                                  setSelectedDeal(null);\n                                },\n                                onError: (error) => {\n                                  toast.error(error.message || 'Failed to move deal');\n                                },\n                              });\n                            }}\n                          >\n                            Move to Opportunities\n                          </AlertDialogAction>\n                        </AlertDialogFooter>\n                      </AlertDialogContent>\n                    </AlertDialog>\n                    <Badge className={cn(\n                      \"px-3 py-1\",\n                      selectedDeal.status === 'Active' ? \"bg-green-500/20 text-green-400\" :\n                      selectedDeal.status === 'On Hold' ? \"bg-yellow-500/20 text-yellow-400\" :\n                      \"bg-gray-500/20 text-gray-400\"\n                    )}>\n                      {selectedDeal.status}\n                    </Badge>\n                  </div>\n                </div>\n              </SheetHeader>\n\n              {/* Stage Progress */}\n              <div className=\"py-6 border-b border-border\">\n                <h4 className=\"text-sm font-medium text-muted-foreground mb-4\">DEAL STAGE</h4>\n                <div className=\"flex items-center gap-2\">\n                  {DEAL_STAGES.map((stage, index) => {\n                    const isActive = getStageIndex(selectedDeal.stage) >= index;\n                    const isCurrent = selectedDeal.stage === stage;\n                    return (\n                      <Button\n                        key={stage}\n                        variant={isCurrent ? \"default\" : isActive ? \"secondary\" : \"outline\"}\n                        size=\"sm\"\n                        className={cn(\n                          \"flex-1 text-xs\",\n                          isCurrent && \"ring-2 ring-primary/30\",\n                          !isActive && \"opacity-50\"\n                        )}\n                        onClick={() => handleStageChange(selectedDeal, stage)}\n                        data-testid={`button-stage-${stage.toLowerCase()}`}\n                      >\n                        {stage}\n                      </Button>\n                    );\n                  })}\n                </div>\n                <div className=\"mt-3 h-2 bg-secondary rounded-full overflow-hidden\">\n                  <div \n                    className=\"h-full bg-primary transition-all duration-500\" \n                    style={{ width: `${getStageProgress(selectedDeal.stage)}%` }}\n                  />\n                </div>\n              </div>\n\n              {/* Tabs */}\n              <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mt-6\">\n                <TabsList className=\"grid grid-cols-7 bg-secondary/50\">\n                  <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n                  <TabsTrigger value=\"stages\">Stage Work</TabsTrigger>\n                  <TabsTrigger value=\"investors\">Investors</TabsTrigger>\n                  <TabsTrigger value=\"documents\">Docs</TabsTrigger>\n                  <TabsTrigger value=\"voice\">Voice</TabsTrigger>\n                  <TabsTrigger value=\"notes\">Notes</TabsTrigger>\n                  <TabsTrigger value=\"audit\">Audit</TabsTrigger>\n                </TabsList>\n\n                {/* Overview Tab */}\n                <TabsContent value=\"overview\" className=\"mt-4 space-y-4\">\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <DollarSign className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\">${selectedDeal.value}M</div>\n                        <div className=\"text-xs text-muted-foreground\">Deal Value</div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <Users className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\"><DealTotalTeamCountNumber dealId={selectedDeal.id} podTeam={(selectedDeal.podTeam as PodTeamMember[]) || []} /></div>\n                        <div className=\"text-xs text-muted-foreground\">Team Members</div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"bg-secondary/30\">\n                      <CardContent className=\"p-4 text-center\">\n                        <Building2 className=\"w-5 h-5 mx-auto mb-1 text-primary\" />\n                        <div className=\"text-2xl font-bold text-primary\">{(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length}</div>\n                        <div className=\"text-xs text-muted-foreground\">Investors</div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <span className=\"text-muted-foreground\">Sector:</span>\n                      <span className=\"ml-2 font-medium\">{selectedDeal.sector}</span>\n                    </div>\n                    <div className=\"p-3 bg-secondary/30 rounded-lg group relative\">\n                      <span className=\"text-muted-foreground\">Lead:</span>\n                      {editingLeadDealId === selectedDeal.id ? (\n                        <div className=\"mt-1\">\n                          <Select \n                            value={editingLeadValue} \n                            onValueChange={(value) => setEditingLeadValue(value)}\n                          >\n                            <SelectTrigger className=\"h-8 text-sm\" data-testid=\"select-edit-lead\">\n                              <SelectValue placeholder=\"Select lead\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {allUsers.map(user => (\n                                <SelectItem key={user.id} value={user.name}>{user.name}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <div className=\"flex gap-1 mt-1\">\n                            <Button \n                              size=\"sm\" \n                              className=\"h-6 text-xs px-2\"\n                              onClick={async () => {\n                                try {\n                                  await updateDeal.mutateAsync({ id: selectedDeal.id, lead: editingLeadValue });\n                                  toast.success(\"Lead updated\");\n                                  setEditingLeadDealId(null);\n                                } catch {\n                                  toast.error(\"Failed to update lead\");\n                                }\n                              }}\n                              data-testid=\"button-save-lead\"\n                            >\n                              Save\n                            </Button>\n                            <Button \n                              size=\"sm\" \n                              variant=\"outline\" \n                              className=\"h-6 text-xs px-2\"\n                              onClick={() => setEditingLeadDealId(null)}\n                            >\n                              Cancel\n                            </Button>\n                          </div>\n                        </div>\n                      ) : (\n                        <>\n                          <span className=\"ml-2 font-medium\">{selectedDeal.lead}</span>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-5 w-5 absolute top-2 right-2 opacity-0 group-hover:opacity-100\"\n                            onClick={() => {\n                              setEditingLeadDealId(selectedDeal.id);\n                              setEditingLeadValue(selectedDeal.lead);\n                            }}\n                            data-testid=\"button-edit-lead\"\n                          >\n                            <Pencil className=\"w-3 h-3\" />\n                          </Button>\n                        </>\n                      )}\n                    </div>\n                  </div>\n\n                  {selectedDeal.description && (\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <span className=\"text-muted-foreground text-sm\">Description:</span>\n                      <p className=\"mt-1 text-sm\">{selectedDeal.description}</p>\n                    </div>\n                  )}\n\n                  {/* Client Contact Section */}\n                  <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <UserCircle className=\"w-4 h-4 text-primary\" />\n                        <span className=\"font-medium text-sm\">Client Contact</span>\n                      </div>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"h-6 text-xs\"\n                        onClick={() => {\n                          setEditingClientContact(true);\n                          setClientContactForm({\n                            name: selectedDeal.clientContactName || '',\n                            email: selectedDeal.clientContactEmail || '',\n                            phone: selectedDeal.clientContactPhone || '',\n                            role: selectedDeal.clientContactRole || '',\n                          });\n                        }}\n                        data-testid=\"button-edit-client-contact\"\n                      >\n                        <Pencil className=\"w-3 h-3 mr-1\" /> Edit\n                      </Button>\n                    </div>\n                    {editingClientContact ? (\n                      <div className=\"space-y-2\">\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          <div>\n                            <Label className=\"text-xs\">Contact Name</Label>\n                            <Input \n                              value={clientContactForm.name}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, name: e.target.value }))}\n                              placeholder=\"Contact person name\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-name\"\n                            />\n                          </div>\n                          <div>\n                            <Label className=\"text-xs\">Role/Title</Label>\n                            <Input \n                              value={clientContactForm.role}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, role: e.target.value }))}\n                              placeholder=\"e.g., CFO, CEO\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-role\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          <div>\n                            <Label className=\"text-xs\">Email</Label>\n                            <Input \n                              type=\"email\"\n                              value={clientContactForm.email}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, email: e.target.value }))}\n                              placeholder=\"email@company.com\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-email\"\n                            />\n                          </div>\n                          <div>\n                            <Label className=\"text-xs\">Phone</Label>\n                            <Input \n                              value={clientContactForm.phone}\n                              onChange={(e) => setClientContactForm(prev => ({ ...prev, phone: e.target.value }))}\n                              placeholder=\"+1 (555) 123-4567\"\n                              className=\"h-8 text-sm\"\n                              data-testid=\"input-client-contact-phone\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"flex gap-2 mt-2\">\n                          <Button \n                            size=\"sm\" \n                            className=\"h-7 text-xs\"\n                            onClick={async () => {\n                              try {\n                                await updateDeal.mutateAsync({\n                                  id: selectedDeal.id,\n                                  clientContactName: clientContactForm.name || null,\n                                  clientContactEmail: clientContactForm.email || null,\n                                  clientContactPhone: clientContactForm.phone || null,\n                                  clientContactRole: clientContactForm.role || null,\n                                });\n                                setSelectedDeal({\n                                  ...selectedDeal,\n                                  clientContactName: clientContactForm.name || null,\n                                  clientContactEmail: clientContactForm.email || null,\n                                  clientContactPhone: clientContactForm.phone || null,\n                                  clientContactRole: clientContactForm.role || null,\n                                });\n                                setEditingClientContact(false);\n                                toast.success(\"Client contact updated\");\n                              } catch {\n                                toast.error(\"Failed to update client contact\");\n                              }\n                            }}\n                            data-testid=\"button-save-client-contact\"\n                          >\n                            Save\n                          </Button>\n                          <Button \n                            variant=\"outline\" \n                            size=\"sm\" \n                            className=\"h-7 text-xs\"\n                            onClick={() => setEditingClientContact(false)}\n                          >\n                            Cancel\n                          </Button>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"space-y-2\">\n                        {selectedDeal.clientContactName || selectedDeal.clientContactEmail || selectedDeal.clientContactPhone ? (\n                          <>\n                            {selectedDeal.clientContactName && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <UserCircle className=\"w-4 h-4 text-muted-foreground\" />\n                                <span className=\"font-medium\">{selectedDeal.clientContactName}</span>\n                                {selectedDeal.clientContactRole && (\n                                  <Badge variant=\"secondary\" className=\"text-[10px]\">{selectedDeal.clientContactRole}</Badge>\n                                )}\n                              </div>\n                            )}\n                            {selectedDeal.clientContactEmail && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <Mail className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`mailto:${selectedDeal.clientContactEmail}`} className=\"text-primary hover:underline\">\n                                  {selectedDeal.clientContactEmail}\n                                </a>\n                              </div>\n                            )}\n                            {selectedDeal.clientContactPhone && (\n                              <div className=\"flex items-center gap-2 text-sm\">\n                                <Phone className=\"w-4 h-4 text-muted-foreground\" />\n                                <a href={`tel:${selectedDeal.clientContactPhone}`} className=\"text-primary hover:underline\">\n                                  {selectedDeal.clientContactPhone}\n                                </a>\n                              </div>\n                            )}\n                          </>\n                        ) : (\n                          <div className=\"text-sm text-muted-foreground italic\">No client contact added yet</div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Deal Fees Section */}\n                  {selectedDealFees.length > 0 && (\n                    <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <DollarSign className=\"w-4 h-4 text-primary\" />\n                        <span className=\"font-medium text-sm\">Fee Structure</span>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {selectedDealFees.map((fee: DealFeeType) => {\n                          const hasAmount = fee.amount !== null && fee.amount !== undefined && !isNaN(Number(fee.amount));\n                          const hasPercentage = fee.percentage !== null && fee.percentage !== undefined && !isNaN(Number(fee.percentage));\n                          return (\n                            <div key={fee.id} className=\"p-2 bg-background/50 rounded-md border border-border/50\">\n                              <div className=\"text-xs text-muted-foreground capitalize\">{fee.feeType.replace('-', ' ').replace('_', ' ')}</div>\n                              <div className=\"font-semibold text-primary\">\n                                {hasAmount \n                                  ? `$${Number(fee.amount).toLocaleString()}` \n                                  : hasPercentage \n                                    ? `${Number(fee.percentage)}%` \n                                    : '-'}\n                              </div>\n                              {fee.description && (\n                                <div className=\"text-xs text-muted-foreground mt-1\">{fee.description}</div>\n                              )}\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  )}\n                </TabsContent>\n\n                {/* Stage Work Tab */}\n                <TabsContent value=\"stages\" className=\"mt-4 space-y-4\">\n                  <StageWorkSection \n                    dealId={selectedDeal.id}\n                    dealName={selectedDeal.name}\n                    dealStage={selectedDeal.stage}\n                    allUsers={allUsers}\n                    currentUser={currentUser}\n                    allTasks={allTasks}\n                    activeStageTab={activeStageTab}\n                    setActiveStageTab={setActiveStageTab}\n                    createStageDocument={createStageDocument}\n                    deleteStageDocument={deleteStageDocument}\n                    createStagePodMember={createStagePodMember}\n                    deleteStagePodMember={deleteStagePodMember}\n                    createStageVoiceNote={createStageVoiceNote}\n                    deleteStageVoiceNote={deleteStageVoiceNote}\n                    createTaskComment={createTaskComment}\n                    createTask={createTask}\n                    deleteTask={deleteTask}\n                    createDocument={createDocument}\n                    totalTeamCount={uniqueTeamCount}\n                    useFullDealTeam={true}\n                    onAuditEntry={async (action, details) => {\n                      try {\n                        const auditEntry: AuditEntry = {\n                          id: crypto.randomUUID(),\n                          timestamp: new Date().toISOString(),\n                          action,\n                          user: currentUser?.name || 'System',\n                          details,\n                        };\n                        \n                        // Fetch fresh deal data from server to get authoritative auditTrail\n                        const freshDeal = await queryClient.fetchQuery<Deal>({\n                          queryKey: ['deals', selectedDeal.id],\n                          queryFn: async () => {\n                            const res = await fetch(`/api/deals/${selectedDeal.id}`);\n                            if (!res.ok) throw new Error('Failed to fetch deal');\n                            return res.json();\n                          },\n                          staleTime: 0, // Force fresh fetch\n                        });\n                        \n                        const currentAuditTrail = Array.isArray(freshDeal?.auditTrail) \n                          ? [...(freshDeal.auditTrail as AuditEntry[])]\n                          : [];\n                        const newAuditTrail = [...currentAuditTrail, auditEntry];\n                        \n                        await updateDeal.mutateAsync({\n                          id: selectedDeal.id,\n                          auditTrail: newAuditTrail,\n                        });\n                        \n                        // Only update state after successful mutation\n                        const updatedDeal = { ...selectedDeal, auditTrail: newAuditTrail };\n                        setSelectedDeal(updatedDeal);\n                        \n                        // Also update the cache with a new array (immutable)\n                        queryClient.setQueryData<Deal[]>(['deals'], (old) => \n                          old ? old.map(d => d.id === selectedDeal.id ? { ...d, auditTrail: newAuditTrail } : d) : []\n                        );\n                      } catch (error: any) {\n                        toast.error(\"Failed to log audit entry\");\n                      }\n                    }}\n                  />\n                </TabsContent>\n\n                {/* Investors Tab */}\n                <TabsContent value=\"investors\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between gap-3\">\n                    <h4 className=\"font-medium\">Tagged Investors</h4>\n                    <div className=\"flex items-center gap-2 flex-1 max-w-xs\">\n                      <div className=\"relative flex-1\">\n                        <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-muted-foreground\" />\n                        <Input \n                          placeholder=\"Search investors...\"\n                          value={investorSearchQuery}\n                          onChange={(e) => setInvestorSearchQuery(e.target.value)}\n                          className=\"h-8 pl-8 text-sm\"\n                          data-testid=\"input-investor-search\"\n                        />\n                      </div>\n                      <Badge variant=\"secondary\">{(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length}</Badge>\n                    </div>\n                  </div>\n\n                  {/* Investors List */}\n                  <ScrollArea className=\"h-[200px]\">\n                    <div className=\"space-y-2\">\n                      {(selectedDeal.taggedInvestors as TaggedInvestor[] || [])\n                        .filter((investor) => {\n                          if (!investorSearchQuery) return true;\n                          const query = investorSearchQuery.toLowerCase();\n                          return (\n                            investor.name.toLowerCase().includes(query) ||\n                            investor.firm.toLowerCase().includes(query) ||\n                            investor.type.toLowerCase().includes(query) ||\n                            investor.status.toLowerCase().includes(query)\n                          );\n                        })\n                        .map((investor) => (\n                        <div key={investor.id} className=\"p-3 bg-secondary/30 rounded-lg group\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center\">\n                                <Building2 className=\"w-5 h-5 text-primary\" />\n                              </div>\n                              <div>\n                                <div className=\"font-medium\">{investor.name}</div>\n                                <div className=\"text-xs text-muted-foreground\">{investor.firm}  {investor.type}</div>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              {investor.email && (\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" asChild data-testid={`investor-email-${investor.id}`}>\n                                  <a href={`mailto:${investor.email}`}><Mail className=\"w-4 h-4 text-blue-500\" /></a>\n                                </Button>\n                              )}\n                              <Select \n                                value={investor.status} \n                                onValueChange={(v) => handleUpdateInvestorStatus(investor.id, v)}\n                              >\n                                <SelectTrigger className=\"h-8 w-28 text-xs\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {INVESTOR_STATUSES.map(status => (\n                                    <SelectItem key={status} value={status}>{status}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                  <Button \n                                    variant=\"ghost\" \n                                    size=\"icon\" \n                                    className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                  >\n                                    <X className=\"w-4 h-4 text-red-500\" />\n                                  </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                  <AlertDialogHeader>\n                                    <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                      This will remove {investor.name} from {investor.firm} from this deal. This action cannot be undone.\n                                    </AlertDialogDescription>\n                                  </AlertDialogHeader>\n                                  <AlertDialogFooter>\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                    <AlertDialogAction onClick={() => handleRemoveInvestor(investor.id)}>\n                                      Remove\n                                    </AlertDialogAction>\n                                  </AlertDialogFooter>\n                                </AlertDialogContent>\n                              </AlertDialog>\n                            </div>\n                          </div>\n                          {investor.notes && (\n                            <p className=\"text-xs text-muted-foreground mt-2 pl-13\">{investor.notes}</p>\n                          )}\n                        </div>\n                      ))}\n                      {(selectedDeal.taggedInvestors as TaggedInvestor[] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No investors tagged yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n\n                  {/* Add Investor Form */}\n                  <div className=\"p-4 border border-dashed border-border rounded-lg space-y-3\">\n                    <div className=\"flex items-center gap-2 text-sm font-medium\">\n                      <Building2 className=\"w-4 h-4\" /> Tag Investor\n                    </div>\n                    \n                    {/* CRM Investor Search */}\n                    <Popover open={investorSearchOpen} onOpenChange={setInvestorSearchOpen}>\n                      <PopoverTrigger asChild>\n                        <Button\n                          variant=\"outline\"\n                          role=\"combobox\"\n                          aria-expanded={investorSearchOpen}\n                          className=\"w-full justify-between text-muted-foreground font-normal\"\n                          data-testid=\"investor-search-trigger\"\n                        >\n                          {newInvestor.name ? `${newInvestor.name} - ${newInvestor.firm}` : \"Search CRM investors...\"}\n                          <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                        </Button>\n                      </PopoverTrigger>\n                      <PopoverContent className=\"w-[400px] p-0\" align=\"start\">\n                        <Command>\n                          <CommandInput \n                            placeholder=\"Search investors by name or firm...\" \n                            value={investorSearchQuery}\n                            onValueChange={setInvestorSearchQuery}\n                          />\n                          <CommandList>\n                            <CommandEmpty>No investors found. Enter manually below.</CommandEmpty>\n                            <CommandGroup heading=\"CRM Investors\">\n                              {filteredCrmInvestors.slice(0, 10).map((investor) => (\n                                <CommandItem\n                                  key={investor.id}\n                                  value={`${investor.name} ${investor.firm}`}\n                                  onSelect={() => handleSelectCrmInvestor(investor)}\n                                  data-testid={`investor-option-${investor.id}`}\n                                >\n                                  <Check\n                                    className={cn(\n                                      \"mr-2 h-4 w-4\",\n                                      newInvestor.name === investor.name ? \"opacity-100\" : \"opacity-0\"\n                                    )}\n                                  />\n                                  <div className=\"flex flex-col\">\n                                    <span className=\"font-medium\">{investor.name}</span>\n                                    <span className=\"text-xs text-muted-foreground\">{investor.firm}</span>\n                                  </div>\n                                </CommandItem>\n                              ))}\n                            </CommandGroup>\n                          </CommandList>\n                        </Command>\n                      </PopoverContent>\n                    </Popover>\n                    \n                    <div className=\"text-xs text-muted-foreground text-center\">- or enter manually -</div>\n                    \n                    <div className=\"grid grid-cols-2 gap-2\">\n                      <Input \n                        placeholder=\"Contact Name *\" \n                        value={newInvestor.name}\n                        onChange={(e) => setNewInvestor({ ...newInvestor, name: e.target.value })}\n                      />\n                      <Input \n                        placeholder=\"Firm Name *\" \n                        value={newInvestor.firm}\n                        onChange={(e) => setNewInvestor({ ...newInvestor, firm: e.target.value })}\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      <Select value={newInvestor.type} onValueChange={(v) => setNewInvestor({ ...newInvestor, type: v })}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Type\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {INVESTOR_TYPES.map(type => (\n                            <SelectItem key={type} value={type}>{type}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <Select value={newInvestor.status} onValueChange={(v) => setNewInvestor({ ...newInvestor, status: v })}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Status\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {INVESTOR_STATUSES.map(status => (\n                            <SelectItem key={status} value={status}>{status}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <Textarea \n                      placeholder=\"Notes (optional)\" \n                      value={newInvestor.notes}\n                      onChange={(e) => setNewInvestor({ ...newInvestor, notes: e.target.value })}\n                      className=\"resize-none\"\n                      rows={2}\n                    />\n                    <Button onClick={handleAddInvestor} className=\"w-full\">\n                      <Plus className=\"w-4 h-4 mr-1\" /> Tag Investor\n                    </Button>\n                  </div>\n                </TabsContent>\n\n                {/* Documents Tab */}\n                <TabsContent value=\"documents\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Deal Documents</h4>\n                    <Badge variant=\"secondary\">\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).length} files\n                    </Badge>\n                  </div>\n\n                  <div \n                    className=\"border-2 border-dashed border-border rounded-lg p-6 text-center hover:border-primary/50 transition-colors cursor-pointer\"\n                    onClick={() => document.getElementById('deal-document-upload')?.click()}\n                    onDragOver={(e) => {\n                      e.preventDefault();\n                      e.stopPropagation();\n                      e.currentTarget.classList.add('border-primary', 'bg-primary/5');\n                    }}\n                    onDragLeave={(e) => {\n                      e.preventDefault();\n                      e.stopPropagation();\n                      e.currentTarget.classList.remove('border-primary', 'bg-primary/5');\n                    }}\n                    onDrop={async (e) => {\n                      e.preventDefault();\n                      e.stopPropagation();\n                      e.currentTarget.classList.remove('border-primary', 'bg-primary/5');\n                      const files = Array.from(e.dataTransfer.files);\n                      if (files.length === 0) return;\n                      \n                      const existingAttachments = (selectedDealWithAttachments?.attachments as any[] || []);\n                      const uploadedAttachments: any[] = [];\n                      \n                      for (const file of files) {\n                        try {\n                          const formData = new FormData();\n                          formData.append('file', file);\n                          \n                          const response = await fetch('/api/upload', {\n                            method: 'POST',\n                            credentials: 'include',\n                            body: formData,\n                          });\n                          \n                          if (response.ok) {\n                            const uploadedFile = await response.json();\n                            uploadedAttachments.push(uploadedFile);\n                          } else {\n                            const error = await response.json();\n                            throw new Error(error.error || 'Upload failed');\n                          }\n                        } catch (error: any) {\n                          toast.error(`Failed to upload ${file.name}: ${error.message || 'Unknown error'}`);\n                        }\n                      }\n                      \n                      if (uploadedAttachments.length > 0) {\n                        try {\n                          await updateDeal.mutateAsync({\n                            id: selectedDeal.id,\n                            attachments: [...existingAttachments, ...uploadedAttachments],\n                          });\n                          toast.success(`${uploadedAttachments.length} file(s) uploaded successfully`);\n                        } catch (error: any) {\n                          console.error('Error saving files to deal:', error);\n                          toast.error(error.message || \"Failed to save files to deal\");\n                        }\n                      }\n                    }}\n                  >\n                    <input \n                      type=\"file\" \n                      id=\"deal-document-upload\" \n                      className=\"hidden\" \n                      multiple \n                      accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp,.heic,.bmp,image/*\"\n                      onChange={async (e) => {\n                        const files = Array.from(e.target.files || []);\n                        if (files.length === 0) return;\n                        \n                        const existingAttachments = (selectedDealWithAttachments?.attachments as any[] || []);\n                        const uploadedAttachments: any[] = [];\n                        \n                        // Upload each file to the server using FormData\n                        for (const file of files) {\n                          try {\n                            const formData = new FormData();\n                            formData.append('file', file);\n                            \n                            const response = await fetch('/api/upload', {\n                              method: 'POST',\n                              credentials: 'include',\n                              body: formData,\n                            });\n                            \n                            if (response.ok) {\n                              const uploadedFile = await response.json();\n                              uploadedAttachments.push(uploadedFile);\n                            } else {\n                              const error = await response.json();\n                              throw new Error(error.error || 'Upload failed');\n                            }\n                          } catch (error: any) {\n                            console.error('Error uploading file:', error);\n                            toast.error(`Failed to upload ${file.name}: ${error.message || 'Unknown error'}`);\n                          }\n                        }\n                        \n                        if (uploadedAttachments.length > 0) {\n                          try {\n                            await updateDeal.mutateAsync({\n                              id: selectedDeal.id,\n                              attachments: [...existingAttachments, ...uploadedAttachments],\n                            });\n                            \n                            // Also add documents to the Document Library\n                            for (const doc of uploadedAttachments) {\n                              try {\n                                await createDocument.mutateAsync({\n                                  title: doc.filename,\n                                  type: doc.type || 'application/octet-stream',\n                                  category: 'Other',\n                                  filename: doc.filename,\n                                  originalName: doc.filename,\n                                  mimeType: doc.type,\n                                  size: doc.size,\n                                  content: doc.url,\n                                  dealId: selectedDeal.id,\n                                  dealName: selectedDeal.name,\n                                  tags: ['deal-attachment'],\n                                });\n                              } catch (docError) {\n                                console.error('Failed to add to document library:', docError);\n                              }\n                            }\n                            \n                            toast.success(`${uploadedAttachments.length} file(s) uploaded successfully`);\n                          } catch (error: any) {\n                            console.error('Error saving files to deal:', error);\n                            toast.error(error.message || \"Failed to save files to deal\");\n                          }\n                        }\n                        \n                        // Reset the input\n                        e.target.value = '';\n                      }}\n                      data-testid=\"input-document-upload\"\n                    />\n                    <Upload className=\"w-8 h-8 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">\n                      Click to upload documents\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      PDF, Word, Excel, PowerPoint, CSV, TXT\n                    </p>\n                  </div>\n\n                  <ScrollArea className=\"h-[300px]\">\n                    <div className=\"space-y-2\">\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).map((doc: any) => (\n                        <div key={doc.id} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"w-10 h-10 rounded bg-primary/10 flex items-center justify-center\">\n                              <FileText className=\"w-5 h-5 text-primary\" />\n                            </div>\n                            <div>\n                              <div className=\"font-medium text-sm\">{doc.filename}</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                {(doc.size / 1024).toFixed(1)} KB  {format(new Date(doc.uploadedAt), 'MMM d, yyyy')}\n                              </div>\n                            </div>\n                          </div>\n                          <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8\"\n                              onClick={() => {\n                                if (doc.contentUnavailable || (doc.url?.startsWith('/uploads/') && !doc.url?.startsWith('data:'))) {\n                                  toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n                                  return;\n                                }\n                                window.open(doc.url, '_blank');\n                              }}\n                              title=\"View\"\n                              data-testid={`button-view-doc-${doc.id}`}\n                            >\n                              <Eye className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8\"\n                              onClick={() => {\n                                if (doc.contentUnavailable || (doc.url?.startsWith('/uploads/') && !doc.url?.startsWith('data:'))) {\n                                  toast.error(\"This file was stored in temporary storage and is no longer available. Please re-upload the document.\");\n                                  return;\n                                }\n                                const link = document.createElement('a');\n                                link.href = doc.url;\n                                link.download = doc.filename || 'document';\n                                document.body.appendChild(link);\n                                link.click();\n                                document.body.removeChild(link);\n                              }}\n                              title=\"Download\"\n                              data-testid={`button-download-doc-${doc.id}`}\n                            >\n                              <Download className=\"w-4 h-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"icon\" \n                              className=\"h-8 w-8 text-red-400 hover:text-red-300\"\n                              onClick={async () => {\n                                const updatedAttachments = (selectedDealWithAttachments?.attachments as any[] || [])\n                                  .filter((a: any) => a.id !== doc.id);\n                                try {\n                                  await updateDeal.mutateAsync({\n                                    id: selectedDeal.id,\n                                    attachments: updatedAttachments,\n                                  });\n                                  toast.success(\"Document removed\");\n                                } catch (error) {\n                                  toast.error(\"Failed to remove document\");\n                                }\n                              }}\n                              title=\"Delete\"\n                              data-testid={`button-delete-doc-${doc.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                      {((selectedDealWithAttachments?.attachments as any[] || [])).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No documents uploaded yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n\n                {/* Voice Notes Tab */}\n                <TabsContent value=\"voice\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Voice Notes</h4>\n                    <Badge variant=\"secondary\">{(dealVoiceNotes[selectedDeal.id] || []).length} notes</Badge>\n                  </div>\n\n                  {/* Recording Section */}\n                  <div className=\"p-4 border border-dashed border-border rounded-lg space-y-3\">\n                    {isRecordingVoice ? (\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center justify-center gap-4\">\n                          <div className=\"w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center animate-pulse\">\n                            <Mic className=\"w-6 h-6 text-red-500\" />\n                          </div>\n                          <div className=\"text-2xl font-bold text-red-500\">{formatVoiceDuration(voiceRecordingTime)}</div>\n                        </div>\n                        <Input\n                          placeholder=\"Add a title for this recording...\"\n                          value={voiceNoteTitle}\n                          onChange={(e) => setVoiceNoteTitle(e.target.value)}\n                          className=\"text-center\"\n                        />\n                        <div className=\"flex items-center justify-center gap-2\">\n                          <Button variant=\"outline\" onClick={cancelVoiceRecording}>\n                            <X className=\"w-4 h-4 mr-2\" /> Cancel\n                          </Button>\n                          <Button variant=\"destructive\" onClick={stopVoiceRecording}>\n                            <Square className=\"w-4 h-4 mr-2\" /> Stop & Save\n                          </Button>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"text-center space-y-3\">\n                        <Button onClick={startVoiceRecording} className=\"gap-2\">\n                          <Mic className=\"w-4 h-4\" /> Start Recording\n                        </Button>\n                        <p className=\"text-xs text-muted-foreground\">Record quick audio updates for this deal</p>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Voice Notes List */}\n                  <ScrollArea className=\"h-[200px]\">\n                    <div className=\"space-y-2\">\n                      {(dealVoiceNotes[selectedDeal.id] || []).map((note) => (\n                        <div key={note.id} className=\"p-3 bg-secondary/30 rounded-lg flex items-center justify-between group\">\n                          <div className=\"flex items-center gap-3 flex-1\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              className=\"h-10 w-10 rounded-full bg-primary/20\"\n                              onClick={() => toggleVoiceNotePlay(note.id, note.duration)}\n                            >\n                              {playingVoiceNoteId === note.id ? (\n                                <Pause className=\"w-4 h-4 text-primary\" />\n                              ) : (\n                                <Play className=\"w-4 h-4 text-primary\" />\n                              )}\n                            </Button>\n                            <div className=\"flex-1\">\n                              <div className=\"font-medium text-sm\">{note.title}</div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                {note.authorName}  {formatVoiceDuration(note.duration)}  {format(parseISO(note.createdAt), 'MMM d, h:mm a')}\n                              </div>\n                              {playingVoiceNoteId === note.id && (\n                                <div className=\"h-1 bg-secondary rounded-full mt-2 overflow-hidden\">\n                                  <div \n                                    className=\"h-full bg-primary transition-all\" \n                                    style={{ width: `${voicePlayProgress}%` }}\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\"\n                            onClick={() => deleteVoiceNote(selectedDeal.id, note.id)}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-red-500\" />\n                          </Button>\n                        </div>\n                      ))}\n                      {(dealVoiceNotes[selectedDeal.id] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No voice notes recorded yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n\n                {/* Deal Notes Tab */}\n                <TabsContent value=\"notes\" className=\"mt-4 space-y-4\">\n                  <DealNotesSection dealId={selectedDeal.id} allUsers={allUsers} />\n                </TabsContent>\n\n                {/* Audit Trail Tab */}\n                <TabsContent value=\"audit\" className=\"mt-4 space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h4 className=\"font-medium\">Institutional Audit Trail</h4>\n                    <Badge variant=\"secondary\">{(selectedDeal.auditTrail as AuditEntry[] || []).length} entries</Badge>\n                  </div>\n\n                  <ScrollArea className=\"h-[400px]\">\n                    <div className=\"space-y-3\">\n                      {(selectedDeal.auditTrail as AuditEntry[] || []).slice().reverse().map((entry) => (\n                        <div key={entry.id} className=\"flex gap-3 p-3 bg-secondary/30 rounded-lg\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0\">\n                            <History className=\"w-4 h-4 text-primary\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center justify-between\">\n                              <span className=\"font-medium text-sm\">{entry.action}</span>\n                              <span className=\"text-xs text-muted-foreground\">\n                                {format(new Date(entry.timestamp), 'MMM d, yyyy h:mm a')}\n                              </span>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground mt-1\">{entry.details}</p>\n                            <p className=\"text-[10px] text-muted-foreground/70 mt-1\">by {entry.user}</p>\n                          </div>\n                        </div>\n                      ))}\n                      {(selectedDeal.auditTrail as AuditEntry[] || []).length === 0 && (\n                        <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                          No audit entries yet\n                        </div>\n                      )}\n                    </div>\n                  </ScrollArea>\n                </TabsContent>\n              </Tabs>\n            </>\n          )}\n        </SheetContent>\n      </Sheet>\n\n      {/* New Deal Modal */}\n      <Dialog open={showNewDealModal} onOpenChange={setShowNewDealModal}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Create New AM Deal</DialogTitle>\n            <DialogDescription>Enter the details for the new deal below.</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Deal Name *</Label>\n              <Input \n                placeholder=\"Project Codename\" \n                value={newDeal.name}\n                onChange={(e) => setNewDeal({ ...newDeal, name: e.target.value })}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Client *</Label>\n              <Input \n                placeholder=\"Client Company Name\" \n                value={newDeal.client}\n                onChange={(e) => setNewDeal({ ...newDeal, client: e.target.value })}\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Value (in millions) *</Label>\n                <Input \n                  type=\"number\" \n                  placeholder=\"100\" \n                  value={newDeal.value}\n                  onChange={(e) => setNewDeal({ ...newDeal, value: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Sector</Label>\n                <Popover open={sectorOpen} onOpenChange={setSectorOpen}>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" role=\"combobox\" aria-expanded={sectorOpen} className=\"w-full justify-between\">\n                      {newDeal.sector === 'Other' && newDeal.customSector ? newDeal.customSector : newDeal.sector}\n                      <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-full p-0\">\n                    <Command>\n                      <CommandInput placeholder=\"Search sector or type custom...\" />\n                      <CommandList>\n                        <CommandEmpty>\n                          <div className=\"p-2\">\n                            <p className=\"text-sm text-muted-foreground mb-2\">No sector found. Add custom:</p>\n                            <Input \n                              placeholder=\"Enter custom sector\"\n                              value={newDeal.customSector}\n                              onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                              onKeyDown={(e) => {\n                                if (e.key === 'Enter' && newDeal.customSector) {\n                                  setNewDeal({ ...newDeal, sector: 'Other' });\n                                  setSectorOpen(false);\n                                }\n                              }}\n                            />\n                          </div>\n                        </CommandEmpty>\n                        <CommandGroup>\n                          {SECTORS.map((sector) => (\n                            <CommandItem\n                              key={sector}\n                              value={sector}\n                              onSelect={() => {\n                                setNewDeal({ ...newDeal, sector, customSector: sector === 'Other' ? newDeal.customSector : '' });\n                                setSectorOpen(false);\n                              }}\n                            >\n                              <Check className={cn(\"mr-2 h-4 w-4\", newDeal.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                              {sector}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n                {newDeal.sector === 'Other' && (\n                  <Input \n                    placeholder=\"Enter custom sector name\"\n                    value={newDeal.customSector}\n                    onChange={(e) => setNewDeal({ ...newDeal, customSector: e.target.value })}\n                    className=\"mt-2\"\n                  />\n                )}\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Stage</Label>\n                <Select value={newDeal.stage} onValueChange={(v) => setNewDeal({ ...newDeal, stage: v })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DEAL_STAGES.map(stage => (\n                      <SelectItem key={stage} value={stage}>{stage}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Lead</Label>\n                <Input \n                  placeholder=\"Deal Lead Name\" \n                  value={newDeal.lead}\n                  onChange={(e) => setNewDeal({ ...newDeal, lead: e.target.value })}\n                />\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Description / Notes</Label>\n              <Textarea \n                placeholder=\"Enter deal description, notes, or any additional details...\"\n                value={newDeal.description || ''}\n                onChange={(e) => setNewDeal({ ...newDeal, description: e.target.value })}\n                rows={4}\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowNewDealModal(false)}>Cancel</Button>\n            <Button onClick={handleCreateDeal} disabled={createDeal.isPending}>\n              {createDeal.isPending ? \"Creating...\" : \"Create Deal\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Deal Modal */}\n      <Dialog open={showEditModal} onOpenChange={setShowEditModal}>\n        <DialogContent className=\"bg-card border-border\">\n          <DialogHeader>\n            <DialogTitle>Edit Deal</DialogTitle>\n          </DialogHeader>\n          {editingDeal && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Deal Name</Label>\n                <Input \n                  value={editingDeal.name}\n                  onChange={(e) => setEditingDeal({ ...editingDeal, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Client</Label>\n                <Input \n                  value={editingDeal.client}\n                  onChange={(e) => setEditingDeal({ ...editingDeal, client: e.target.value })}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Value (in millions)</Label>\n                  <Input \n                    type=\"number\" \n                    value={editingDeal.value}\n                    onChange={(e) => setEditingDeal({ ...editingDeal, value: parseInt(e.target.value) || 0 })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Stage</Label>\n                  <Select value={editingDeal.stage} onValueChange={(v) => setEditingDeal({ ...editingDeal, stage: v, progress: getStageProgress(v) })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {DEAL_STAGES.map(stage => (\n                        <SelectItem key={stage} value={stage}>{stage}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Sector</Label>\n                  <Popover open={editSectorOpen} onOpenChange={setEditSectorOpen}>\n                    <PopoverTrigger asChild>\n                      <Button variant=\"outline\" role=\"combobox\" aria-expanded={editSectorOpen} className=\"w-full justify-between\">\n                        {editingDeal.sector === 'Other' && editCustomSector ? editCustomSector : editingDeal.sector}\n                        <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-full p-0\">\n                      <Command>\n                        <CommandInput placeholder=\"Search sector or type custom...\" />\n                        <CommandList>\n                          <CommandEmpty>\n                            <div className=\"p-2\">\n                              <p className=\"text-sm text-muted-foreground mb-2\">No sector found. Add custom:</p>\n                              <Input \n                                placeholder=\"Enter custom sector\"\n                                value={editCustomSector}\n                                onChange={(e) => setEditCustomSector(e.target.value)}\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter' && editCustomSector) {\n                                    setEditingDeal({ ...editingDeal, sector: 'Other' });\n                                    setEditSectorOpen(false);\n                                  }\n                                }}\n                              />\n                            </div>\n                          </CommandEmpty>\n                          <CommandGroup>\n                            {SECTORS.map((sector) => (\n                              <CommandItem\n                                key={sector}\n                                value={sector}\n                                onSelect={() => {\n                                  setEditingDeal({ ...editingDeal, sector });\n                                  if (sector !== 'Other') setEditCustomSector('');\n                                  setEditSectorOpen(false);\n                                }}\n                              >\n                                <Check className={cn(\"mr-2 h-4 w-4\", editingDeal.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                                {sector}\n                              </CommandItem>\n                            ))}\n                          </CommandGroup>\n                        </CommandList>\n                      </Command>\n                    </PopoverContent>\n                  </Popover>\n                  {editingDeal.sector === 'Other' && (\n                    <Input \n                      placeholder=\"Enter custom sector name\"\n                      value={editCustomSector}\n                      onChange={(e) => setEditCustomSector(e.target.value)}\n                      className=\"mt-2\"\n                    />\n                  )}\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Status</Label>\n                  <Select value={editingDeal.status} onValueChange={(v) => setEditingDeal({ ...editingDeal, status: v })}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Active\">Active</SelectItem>\n                      <SelectItem value=\"On Hold\">On Hold</SelectItem>\n                      <SelectItem value=\"Closed\">Closed</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Lead</Label>\n                <Input \n                  placeholder=\"Deal Lead Name\"\n                  value={editingDeal.lead}\n                  onChange={(e) => setEditingDeal({ ...editingDeal, lead: e.target.value })}\n                />\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditModal(false)}>Cancel</Button>\n            <Button onClick={handleEditDeal} disabled={updateDeal.isPending}>\n              {updateDeal.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Task Detail Modal for Calendar View */}\n      <Dialog open={showTaskDetailModal} onOpenChange={setShowTaskDetailModal}>\n        <DialogContent className=\"bg-card border-border max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"w-5 h-5 text-primary\" />\n              Task Details\n            </DialogTitle>\n            <DialogDescription>\n              {selectedCalendarTask?.deal?.name}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedCalendarTask && (\n            <div className=\"space-y-4 py-4\">\n              <div>\n                <h3 className=\"text-lg font-semibold\">{selectedCalendarTask.title}</h3>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Priority</p>\n                  <Badge variant={selectedCalendarTask.priority === 'High' ? 'destructive' : 'secondary'} className=\"mt-1\">\n                    {selectedCalendarTask.priority}\n                  </Badge>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Status</p>\n                  <Badge variant={selectedCalendarTask.status === 'Completed' ? 'default' : 'secondary'} className=\"mt-1\">\n                    {selectedCalendarTask.status}\n                  </Badge>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Due Date</p>\n                  <p className=\"text-sm font-medium mt-1\">\n                    {selectedCalendarTask.dueDate ? format(parseISO(selectedCalendarTask.dueDate), 'MMM d, yyyy') : 'Not set'}\n                  </p>\n                </div>\n                <div className=\"bg-secondary/30 rounded-lg p-3\">\n                  <p className=\"text-xs text-muted-foreground\">Assigned To</p>\n                  <p className=\"text-sm font-medium mt-1\">\n                    {allUsers.find((u: any) => u.id === selectedCalendarTask.assignedTo)?.name || 'Unassigned'}\n                  </p>\n                </div>\n              </div>\n              \n              <div>\n                <p className=\"text-xs text-muted-foreground mb-1\">Related Deal</p>\n                <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                  <p className=\"font-medium\">{selectedCalendarTask.deal?.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {selectedCalendarTask.deal?.client}  {selectedCalendarTask.deal?.sector}\n                  </p>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  className=\"flex-1\"\n                  onClick={() => {\n                    setSelectedDeal(selectedCalendarTask.deal);\n                    setActiveTab(\"overview\");\n                    setShowTaskDetailModal(false);\n                  }}\n                >\n                  <Eye className=\"w-4 h-4 mr-2\" />\n                  View Deal\n                </Button>\n                <Button variant=\"outline\" onClick={() => setShowTaskDetailModal(false)}>Close</Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Deal Confirmation Dialog */}\n      <AlertDialog open={showDeleteDealDialog} onOpenChange={setShowDeleteDealDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This action cannot be undone. This will permanently delete this deal and all its associated data including team members, investors, and documents.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => setDealToDelete(null)}>Cancel</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={() => {\n                if (dealToDelete) {\n                  handleDeleteDeal(dealToDelete);\n                  setDealToDelete(null);\n                  setShowDeleteDealDialog(false);\n                }\n              }}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              Delete Deal\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":209509,"size_tokens":null},"client/src/pages/ceo/Opportunities.tsx":{"content":"import { useState, useMemo, useRef, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { \n  Search, Plus, Lightbulb, CheckCircle, XCircle, Eye, Clock, DollarSign,\n  Building2, Users, ArrowRight, Briefcase, TrendingUp, AlertTriangle,\n  Upload, FileText, Paperclip, StickyNote, X, Download, Trash2, ExternalLink,\n  Pencil, Save, MessageSquare\n} from \"lucide-react\";\nimport { \n  useCurrentUser, useDealsListing, useDeal, useCreateDeal, useUpdateDeal, useDeleteDeal, useUsers,\n  useCustomSectors, useCreateCustomSector, useTagDealMember, useRemoveDealMember,\n  useDealNotes, useCreateDealNote, useApproveOpportunity, type DealNoteType\n} from \"@/lib/api\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { ChevronsUpDown, Check as CheckIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { toast } from \"sonner\";\nimport { format } from \"date-fns\";\nimport type { Deal, PodTeamMember } from \"@shared/schema\";\nimport { ObjectUploader, type UploadedFile } from \"@/components/ObjectUploader\";\n\nconst DIVISIONS = ['Investment Banking', 'Asset Management'];\nconst BASE_SECTORS = ['Technology', 'Healthcare', 'Finance', 'Energy', 'Consumer', 'Industrial', 'Real Estate', 'Other'];\n\ntype OpportunityAttachment = {\n  id: string;\n  filename: string;\n  url: string;\n  objectPath?: string;\n  size: number;\n  type?: string;\n  uploadedAt: string;\n};\n\ntype OpportunityNote = {\n  id: string;\n  content: string;\n  author: string;\n  createdAt: string;\n};\n\ntype OpportunitiesProps = {\n  role?: 'CEO' | 'Employee';\n};\n\nfunction DealNotesSection({ dealId, allUsers }: { dealId: string; allUsers: any[] }) {\n  const { data: notes = [], isLoading } = useDealNotes(dealId);\n  const createDealNote = useCreateDealNote();\n  const [newNote, setNewNote] = useState(\"\");\n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const filteredUsers = useMemo(() => {\n    if (!mentionQuery) return allUsers.slice(0, 5);\n    return allUsers.filter(u => \n      u.name.toLowerCase().includes(mentionQuery.toLowerCase())\n    ).slice(0, 5);\n  }, [allUsers, mentionQuery]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const value = e.target.value;\n    const position = e.target.selectionStart || 0;\n    setNewNote(value);\n    setCursorPosition(position);\n\n    const textBeforeCursor = value.slice(0, position);\n    const atMatch = textBeforeCursor.match(/@(\\w*)$/);\n    if (atMatch) {\n      setShowMentions(true);\n      setMentionQuery(atMatch[1]);\n    } else {\n      setShowMentions(false);\n      setMentionQuery(\"\");\n    }\n  };\n\n  const insertMention = (userName: string) => {\n    const textBeforeCursor = newNote.slice(0, cursorPosition);\n    const textAfterCursor = newNote.slice(cursorPosition);\n    const beforeAt = textBeforeCursor.replace(/@\\w*$/, '');\n    const mentionName = userName.replace(/\\s+/g, '');\n    const newText = `${beforeAt}@${mentionName} ${textAfterCursor}`;\n    setNewNote(newText);\n    setShowMentions(false);\n    setMentionQuery(\"\");\n    textareaRef.current?.focus();\n  };\n\n  const handleSubmit = async () => {\n    if (!newNote.trim()) return;\n    try {\n      await createDealNote.mutateAsync({ dealId, content: newNote.trim() });\n      setNewNote(\"\");\n      toast.success(\"Note added\");\n    } catch {\n      toast.error(\"Failed to add note\");\n    }\n  };\n\n  const renderContentWithMentions = (content: string) => {\n    const parts = content.split(/(@\\w+)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith('@')) {\n        return <span key={i} className=\"text-amber-500 font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Loading notes...</div>;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"font-medium flex items-center gap-2\">\n          <MessageSquare className=\"w-4 h-4\" />\n          Opportunity Notes\n        </h4>\n        <Badge variant=\"secondary\">{notes.length} notes</Badge>\n      </div>\n\n      <div className=\"relative\">\n        <Textarea\n          ref={textareaRef}\n          placeholder=\"Add a note... Use @ to mention team members\"\n          value={newNote}\n          onChange={handleInputChange}\n          className=\"min-h-[80px]\"\n          data-testid=\"input-opportunity-note\"\n        />\n        {showMentions && filteredUsers.length > 0 && (\n          <div className=\"absolute bottom-full left-0 mb-1 w-64 bg-popover border rounded-md shadow-lg z-50 max-h-48 overflow-auto\">\n            {filteredUsers.map(user => (\n              <button\n                key={user.id}\n                className=\"w-full px-3 py-2 text-left hover:bg-accent flex items-center gap-2\"\n                onClick={() => insertMention(user.name)}\n              >\n                <div className=\"w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center text-xs\">\n                  {user.name.charAt(0)}\n                </div>\n                <span className=\"text-sm\">{user.name}</span>\n              </button>\n            ))}\n          </div>\n        )}\n        <div className=\"flex justify-end mt-2\">\n          <Button \n            size=\"sm\" \n            onClick={handleSubmit}\n            disabled={!newNote.trim() || createDealNote.isPending}\n            data-testid=\"button-submit-opportunity-note\"\n          >\n            <Plus className=\"w-4 h-4 mr-1\" /> Add Note\n          </Button>\n        </div>\n      </div>\n\n      <ScrollArea className=\"h-[300px]\">\n        <div className=\"space-y-3\">\n          {notes.map((note: DealNoteType) => (\n            <div key={note.id} className=\"p-3 bg-secondary/30 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-sm font-medium text-amber-500 flex-shrink-0\">\n                  {note.userName?.charAt(0) || '?'}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium text-sm\">{note.userName}</span>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {format(new Date(note.createdAt), 'MMM d, h:mm a')}\n                    </span>\n                  </div>\n                  <p className=\"text-sm mt-1 whitespace-pre-wrap\">\n                    {renderContentWithMentions(note.content)}\n                  </p>\n                </div>\n              </div>\n            </div>\n          ))}\n          {notes.length === 0 && (\n            <div className=\"text-center py-8 text-muted-foreground text-sm\">\n              No notes yet. Add the first note above.\n            </div>\n          )}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n\nexport default function Opportunities({ role = 'CEO' }: OpportunitiesProps) {\n  const [location] = useLocation();\n  const searchString = typeof window !== 'undefined' ? window.location.search : '';\n  const { data: currentUser } = useCurrentUser();\n  const { data: deals = [], isLoading } = useDealsListing();\n  const { data: users = [] } = useUsers();\n  const { data: customSectors = [] } = useCustomSectors();\n  const createCustomSector = useCreateCustomSector();\n  const createDeal = useCreateDeal();\n  const updateDeal = useUpdateDeal();\n  const deleteDeal = useDeleteDeal();\n  const approveOpportunity = useApproveOpportunity();\n  const tagMember = useTagDealMember();\n  const removeMember = useRemoveDealMember();\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const detailFileInputRef = useRef<HTMLInputElement>(null);\n  \n  // Sector selector state\n  const [sectorOpen, setSectorOpen] = useState(false);\n  \n  // Dynamic sectors list combining base + custom\n  const SECTORS = useMemo(() => {\n    const customNames = customSectors.map((s: any) => s.name);\n    const allSectors = [...BASE_SECTORS, ...customNames.filter((name: string) => !BASE_SECTORS.includes(name))];\n    return allSectors;\n  }, [customSectors]);\n  \n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showNewOpportunityDialog, setShowNewOpportunityDialog] = useState(false);\n  const [showOpportunityDetail, setShowOpportunityDetail] = useState(false);\n  const [selectedOpportunity, setSelectedOpportunity] = useState<Deal | null>(null);\n  const [showApproveDialog, setShowApproveDialog] = useState(false);\n  const [showRejectDialog, setShowRejectDialog] = useState(false);\n  const [approvalDivision, setApprovalDivision] = useState<string>('Investment Banking');\n  const [detailTab, setDetailTab] = useState<'overview' | 'attachments' | 'notes'>('overview');\n  const [newNote, setNewNote] = useState(\"\");\n  const [isEditMode, setIsEditMode] = useState(false);\n  const [editForm, setEditForm] = useState({\n    name: \"\",\n    client: \"\",\n    sector: \"\",\n    customSector: \"\",\n    value: \"\" as string,\n    description: \"\",\n    lead: \"\",\n  });\n  const [editSectorOpen, setEditSectorOpen] = useState(false);\n  \n  const [newOpportunity, setNewOpportunity] = useState({\n    name: \"\",\n    client: \"\",\n    sector: \"Technology\",\n    customSector: \"\",\n    value: \"\" as string,\n    description: \"\",\n    lead: \"\",\n    notes: \"\" as string,\n    attachments: [] as OpportunityAttachment[],\n  });\n  \n  // Local state for opportunity details (notes and attachments)\n  const [opportunityNotes, setOpportunityNotes] = useState<OpportunityNote[]>([]);\n  const [opportunityAttachments, setOpportunityAttachments] = useState<OpportunityAttachment[]>([]);\n  \n  // Member tagging state\n  const [teamSearchQuery, setTeamSearchQuery] = useState(\"\");\n  const [showTeamDropdown, setShowTeamDropdown] = useState(false);\n  \n  // Filter for Opportunity deals only\n  const opportunities = useMemo(() => {\n    return deals.filter((deal: Deal) => (deal as any).dealType === 'Opportunity');\n  }, [deals]);\n\n  // Handle URL query parameter for selecting a specific opportunity\n  useEffect(() => {\n    if (searchString && opportunities.length > 0) {\n      const params = new URLSearchParams(searchString);\n      const opportunityId = params.get('id');\n      if (opportunityId) {\n        const opportunity = opportunities.find((d: Deal) => d.id === opportunityId);\n        if (opportunity) {\n          setSelectedOpportunity(opportunity);\n          setShowOpportunityDetail(true);\n        }\n      }\n    }\n  }, [searchString, opportunities]);\n  \n  // Apply search filter\n  const filteredOpportunities = useMemo(() => {\n    if (!searchQuery) return opportunities;\n    const query = searchQuery.toLowerCase();\n    return opportunities.filter((deal: Deal) => \n      deal.name.toLowerCase().includes(query) ||\n      deal.client.toLowerCase().includes(query) ||\n      deal.sector.toLowerCase().includes(query)\n    );\n  }, [opportunities, searchQuery]);\n  \n  // Stats\n  const stats = useMemo(() => {\n    const totalValue = opportunities.reduce((sum, deal: Deal) => sum + deal.value, 0);\n    const pending = opportunities.filter((d: Deal) => d.status === 'Active').length;\n    return { total: opportunities.length, totalValue, pending };\n  }, [opportunities]);\n  \n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, isDetail: boolean = false) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n    \n    // Handle multiple files\n    const fileArray = Array.from(files);\n    let uploadedCount = 0;\n    \n    for (const file of fileArray) {\n      const reader = new FileReader();\n      \n      reader.onload = () => {\n        const attachment: OpportunityAttachment = {\n          id: crypto.randomUUID(),\n          filename: file.name,\n          url: reader.result as string,\n          size: file.size,\n          uploadedAt: new Date().toISOString(),\n        };\n        \n        if (isDetail) {\n          setOpportunityAttachments(prev => [...prev, attachment]);\n        } else {\n          setNewOpportunity(prev => ({\n            ...prev,\n            attachments: [...prev.attachments, attachment]\n          }));\n        }\n        \n        uploadedCount++;\n        if (uploadedCount === fileArray.length) {\n          toast.success(`${fileArray.length} file(s) attached`);\n        }\n      };\n      \n      reader.readAsDataURL(file);\n    }\n    \n    e.target.value = '';\n  };\n  \n  const removeAttachment = (id: string, isDetail: boolean = false) => {\n    if (isDetail) {\n      setOpportunityAttachments(prev => prev.filter(a => a.id !== id));\n    } else {\n      setNewOpportunity(prev => ({\n        ...prev,\n        attachments: prev.attachments.filter(a => a.id !== id)\n      }));\n    }\n  };\n  \n  const handleAddNote = () => {\n    if (!newNote.trim()) return;\n    \n    const note: OpportunityNote = {\n      id: crypto.randomUUID(),\n      content: newNote,\n      author: currentUser?.name || 'Unknown',\n      createdAt: new Date().toISOString(),\n    };\n    \n    setOpportunityNotes(prev => [note, ...prev]);\n    setNewNote(\"\");\n    toast.success(\"Note added\");\n  };\n  \n  const handleCreateOpportunity = async () => {\n    if (!newOpportunity.name || !newOpportunity.client) {\n      toast.error(\"Please fill in required fields\");\n      return;\n    }\n    try {\n      // Determine final sector value\n      const finalSector = newOpportunity.sector === 'Other' && newOpportunity.customSector ? newOpportunity.customSector : newOpportunity.sector;\n      \n      // Save custom sector if it's a new one\n      const isCustomSector = newOpportunity.sector === 'Other' && newOpportunity.customSector;\n      const existingCustomSectorNames = customSectors.map((s: any) => s.name.toLowerCase());\n      const isNewCustomSector = isCustomSector && !existingCustomSectorNames.includes(newOpportunity.customSector.toLowerCase()) && !BASE_SECTORS.includes(newOpportunity.customSector);\n      \n      if (isNewCustomSector) {\n        try {\n          await createCustomSector.mutateAsync(newOpportunity.customSector);\n        } catch (e) {\n          console.log(\"Custom sector may already exist:\", e);\n        }\n      }\n      \n      await createDeal.mutateAsync({\n        ...newOpportunity,\n        sector: finalSector,\n        value: parseFloat(newOpportunity.value) || 0,\n        dealType: 'Opportunity',\n        stage: 'Origination',\n        status: 'Active',\n        progress: 0,\n        podTeam: [],\n      } as any);\n      toast.success(\"Opportunity created\");\n      setShowNewOpportunityDialog(false);\n      setNewOpportunity({ \n        name: \"\", client: \"\", sector: \"Technology\", customSector: \"\", value: \"\", \n        description: \"\", lead: \"\", notes: \"\", attachments: [] \n      });\n    } catch (error) {\n      toast.error(\"Failed to create opportunity\");\n    }\n  };\n  \n  const handleApprove = async () => {\n    if (!selectedOpportunity) return;\n    try {\n      if (approvalDivision === 'Investment Banking') {\n        toast.loading(\"Approving opportunity and forming pod team...\", { id: \"approve-opportunity\" });\n        await approveOpportunity.mutateAsync(selectedOpportunity.id);\n        toast.success(\"Opportunity approved! Pod team formed and tasks created.\", { id: \"approve-opportunity\" });\n      } else {\n        await updateDeal.mutateAsync({\n          id: selectedOpportunity.id,\n          dealType: 'Asset Management',\n          status: 'Active',\n        } as any);\n        toast.success(\"Opportunity approved and moved to Asset Management\");\n      }\n      \n      setShowApproveDialog(false);\n      setShowOpportunityDetail(false);\n      setSelectedOpportunity(null);\n    } catch (error: any) {\n      toast.error(error.message || \"Failed to approve opportunity\", { id: \"approve-opportunity\" });\n    }\n  };\n  \n  const handleReject = async () => {\n    if (!selectedOpportunity) return;\n    try {\n      await deleteDeal.mutateAsync(selectedOpportunity.id);\n      toast.success(\"Opportunity rejected and removed\");\n      setShowRejectDialog(false);\n      setShowOpportunityDetail(false);\n      setSelectedOpportunity(null);\n    } catch (error) {\n      toast.error(\"Failed to reject opportunity\");\n    }\n  };\n  \n  const openOpportunityDetail = (opportunity: Deal) => {\n    setSelectedOpportunity(opportunity);\n    setDetailTab('overview');\n    setIsEditMode(false);\n    // Load any existing attachments/notes from the opportunity\n    const opp = opportunity as any;\n    setOpportunityAttachments(opp.attachments || []);\n    setOpportunityNotes(opp.opportunityNotes || []);\n    // Initialize edit form with opportunity data\n    setEditForm({\n      name: opportunity.name,\n      client: opportunity.client,\n      sector: SECTORS.includes(opportunity.sector) ? opportunity.sector : 'Other',\n      customSector: SECTORS.includes(opportunity.sector) ? '' : opportunity.sector,\n      value: opportunity.value.toString(),\n      description: opportunity.description || '',\n      lead: opportunity.lead || '',\n    });\n    setShowOpportunityDetail(true);\n  };\n  \n  const handleSaveEdit = async () => {\n    if (!selectedOpportunity) return;\n    if (!editForm.name || !editForm.client) {\n      toast.error(\"Name and client are required\");\n      return;\n    }\n    try {\n      const finalSector = editForm.sector === 'Other' && editForm.customSector \n        ? editForm.customSector \n        : editForm.sector;\n      \n      // Save custom sector if new\n      if (editForm.sector === 'Other' && editForm.customSector) {\n        const existingNames = customSectors.map((s: any) => s.name.toLowerCase());\n        if (!existingNames.includes(editForm.customSector.toLowerCase()) && !BASE_SECTORS.includes(editForm.customSector)) {\n          try {\n            await createCustomSector.mutateAsync(editForm.customSector);\n          } catch (e) {\n            console.log(\"Custom sector may already exist:\", e);\n          }\n        }\n      }\n      \n      await updateDeal.mutateAsync({\n        id: selectedOpportunity.id,\n        name: editForm.name,\n        client: editForm.client,\n        sector: finalSector,\n        value: parseFloat(editForm.value) || 0,\n        description: editForm.description,\n        lead: editForm.lead,\n      } as any);\n      \n      // Update the selectedOpportunity with the new values so the UI reflects changes immediately\n      setSelectedOpportunity({\n        ...selectedOpportunity,\n        name: editForm.name,\n        client: editForm.client,\n        sector: finalSector,\n        value: parseFloat(editForm.value) || 0,\n        description: editForm.description,\n        lead: editForm.lead,\n      });\n      \n      toast.success(\"Opportunity updated\");\n      setIsEditMode(false);\n    } catch (error) {\n      toast.error(\"Failed to update opportunity\");\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return bytes + ' B';\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\n  };\n\n  return (\n    <Layout role={role} pageTitle=\"Potential Opportunities\">\n      <div className=\"space-y-6\">\n        {/* Header Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center\">\n                  <Lightbulb className=\"w-5 h-5 text-amber-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Opportunities</p>\n                  <p className=\"text-2xl font-bold\">{stats.total}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center\">\n                  <DollarSign className=\"w-5 h-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Potential Value</p>\n                  <p className=\"text-2xl font-bold\">${stats.totalValue}M</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center\">\n                  <Clock className=\"w-5 h-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Pending Review</p>\n                  <p className=\"text-2xl font-bold\">{stats.pending}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n        \n        {/* Toolbar */}\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"relative flex-1 max-w-md\">\n            <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search opportunities...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9 bg-secondary/50\"\n              data-testid=\"input-opportunities-search\"\n            />\n          </div>\n          <Button onClick={() => setShowNewOpportunityDialog(true)} data-testid=\"button-new-opportunity\">\n            <Plus className=\"w-4 h-4 mr-2\" />\n            New Opportunity\n          </Button>\n        </div>\n        \n        {/* Opportunities Grid */}\n        {filteredOpportunities.length > 0 ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {filteredOpportunities.map((opportunity: Deal) => (\n              <Card \n                key={opportunity.id} \n                className=\"bg-card border-border hover:border-primary/30 transition-colors cursor-pointer group\"\n                onClick={() => openOpportunityDetail(opportunity)}\n                data-testid={`card-opportunity-${opportunity.id}`}\n              >\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1 min-w-0\">\n                      <CardTitle className=\"text-base truncate\">{opportunity.name}</CardTitle>\n                      <CardDescription className=\"truncate\">{opportunity.client}</CardDescription>\n                    </div>\n                    <Badge variant=\"outline\" className=\"bg-amber-500/10 text-amber-500 border-amber-500/20 shrink-0\">\n                      Pending\n                    </Badge>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Value</span>\n                      <span className=\"font-semibold text-primary\">${opportunity.value}M</span>\n                    </div>\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Sector</span>\n                      <Badge variant=\"secondary\" className=\"text-xs\">{opportunity.sector}</Badge>\n                    </div>\n                    {opportunity.lead && (\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Lead</span>\n                        <span className=\"font-medium\">{opportunity.lead}</span>\n                      </div>\n                    )}\n                    {((opportunity as any).attachments?.length > 0) && (\n                      <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                        <Paperclip className=\"w-3 h-3\" />\n                        {(opportunity as any).attachments.length} attachment(s)\n                      </div>\n                    )}\n                    <div className=\"pt-2 border-t border-border\">\n                      <Button size=\"sm\" variant=\"outline\" className=\"w-full\"\n                        onClick={(e) => { e.stopPropagation(); openOpportunityDetail(opportunity); }}\n                      >\n                        <Eye className=\"w-3 h-3 mr-1\" />\n                        View Details\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : (\n          <Card className=\"bg-card border-border\">\n            <CardContent className=\"p-12 text-center\">\n              <Lightbulb className=\"w-12 h-12 mx-auto text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">No Opportunities Yet</h3>\n              <p className=\"text-muted-foreground mb-4\">Add new potential deals for review and approval</p>\n              <Button onClick={() => setShowNewOpportunityDialog(true)}>\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Opportunity\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n      \n      {/* New Opportunity Dialog - Enhanced */}\n      <Dialog open={showNewOpportunityDialog} onOpenChange={setShowNewOpportunityDialog}>\n        <DialogContent className=\"bg-card border-border max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>New Opportunity</DialogTitle>\n            <DialogDescription>Add a potential deal for review and approval</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Deal Name *</Label>\n                <Input\n                  value={newOpportunity.name}\n                  onChange={(e) => setNewOpportunity({ ...newOpportunity, name: e.target.value })}\n                  placeholder=\"e.g., Acme Corp Acquisition\"\n                  data-testid=\"input-opportunity-name\"\n                />\n              </div>\n              <div>\n                <Label>Client/Company *</Label>\n                <Input\n                  value={newOpportunity.client}\n                  onChange={(e) => setNewOpportunity({ ...newOpportunity, client: e.target.value })}\n                  placeholder=\"Company name\"\n                  data-testid=\"input-opportunity-client\"\n                />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-3 gap-4\">\n              <div>\n                <Label>Sector</Label>\n                <Popover open={sectorOpen} onOpenChange={setSectorOpen}>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" role=\"combobox\" aria-expanded={sectorOpen} className=\"w-full justify-between\" data-testid=\"select-opportunity-sector\">\n                      {newOpportunity.sector === 'Other' && newOpportunity.customSector ? newOpportunity.customSector : newOpportunity.sector}\n                      <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-full p-0\">\n                    <Command>\n                      <CommandInput placeholder=\"Search sector or type custom...\" />\n                      <CommandList>\n                        <CommandEmpty>\n                          <div className=\"p-2\">\n                            <p className=\"text-sm text-muted-foreground mb-2\">No sector found. Add custom:</p>\n                            <Input \n                              placeholder=\"Enter custom sector\"\n                              value={newOpportunity.customSector}\n                              onChange={(e) => setNewOpportunity({ ...newOpportunity, customSector: e.target.value })}\n                              onKeyDown={(e) => {\n                                if (e.key === 'Enter' && newOpportunity.customSector) {\n                                  setNewOpportunity({ ...newOpportunity, sector: 'Other' });\n                                  setSectorOpen(false);\n                                }\n                              }}\n                            />\n                          </div>\n                        </CommandEmpty>\n                        <CommandGroup>\n                          {SECTORS.map((sector) => (\n                            <CommandItem\n                              key={sector}\n                              value={sector}\n                              onSelect={() => {\n                                setNewOpportunity({ ...newOpportunity, sector, customSector: sector === 'Other' ? newOpportunity.customSector : '' });\n                                setSectorOpen(false);\n                              }}\n                            >\n                              <CheckIcon className={cn(\"mr-2 h-4 w-4\", newOpportunity.sector === sector ? \"opacity-100\" : \"opacity-0\")} />\n                              {sector}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n                {newOpportunity.sector === 'Other' && (\n                  <Input \n                    placeholder=\"Enter custom sector name\"\n                    value={newOpportunity.customSector}\n                    onChange={(e) => setNewOpportunity({ ...newOpportunity, customSector: e.target.value })}\n                    className=\"mt-2\"\n                    data-testid=\"input-custom-sector\"\n                  />\n                )}\n              </div>\n              <div>\n                <Label>Est. Value ($M)</Label>\n                <Input\n                  type=\"number\"\n                  value={newOpportunity.value}\n                  placeholder=\"0\"\n                  onChange={(e) => setNewOpportunity({ ...newOpportunity, value: e.target.value })}\n                  data-testid=\"input-opportunity-value\"\n                />\n              </div>\n              <div>\n                <Label>Lead Contact</Label>\n                <Input\n                  value={newOpportunity.lead}\n                  onChange={(e) => setNewOpportunity({ ...newOpportunity, lead: e.target.value })}\n                  placeholder=\"Who brought this in?\"\n                  data-testid=\"input-opportunity-lead\"\n                />\n              </div>\n            </div>\n            <div>\n              <Label>Description</Label>\n              <Textarea\n                value={newOpportunity.description}\n                onChange={(e) => setNewOpportunity({ ...newOpportunity, description: e.target.value })}\n                placeholder=\"Brief description of the opportunity, including key details, strategic rationale, and potential value drivers...\"\n                rows={4}\n                data-testid=\"textarea-opportunity-description\"\n              />\n            </div>\n            <div>\n              <Label>Initial Notes</Label>\n              <Textarea\n                value={newOpportunity.notes}\n                onChange={(e) => setNewOpportunity({ ...newOpportunity, notes: e.target.value })}\n                placeholder=\"Any additional notes, context, or considerations...\"\n                rows={2}\n              />\n            </div>\n            \n            {/* File Attachments */}\n            <div>\n              <Label className=\"flex items-center gap-2\">\n                <Paperclip className=\"w-4 h-4\" />\n                Attachments\n              </Label>\n              <div className=\"mt-2 space-y-3\">\n                <ObjectUploader\n                  maxNumberOfFiles={10}\n                  maxFileSize={500 * 1024 * 1024}\n                  accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.heic,.bmp,.mp4,.mov,.avi,.mp3,.wav,image/*,video/*,audio/*\"\n                  onComplete={(files: UploadedFile[]) => {\n                    const newAttachments: OpportunityAttachment[] = files.map(f => ({\n                      id: f.id,\n                      filename: f.filename,\n                      url: f.objectPath,\n                      objectPath: f.objectPath,\n                      size: f.size,\n                      type: f.type,\n                      uploadedAt: new Date().toISOString(),\n                    }));\n                    setNewOpportunity(prev => ({\n                      ...prev,\n                      attachments: [...prev.attachments, ...newAttachments]\n                    }));\n                  }}\n                  buttonVariant=\"outline\"\n                  buttonSize=\"sm\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Upload Files (up to 500MB)\n                </ObjectUploader>\n                <p className=\"text-xs text-muted-foreground\">\n                  Supports documents, images, videos, and audio files\n                </p>\n                \n                {newOpportunity.attachments.length > 0 && (\n                  <div className=\"space-y-2\">\n                    {newOpportunity.attachments.map((file) => (\n                      <div key={file.id} className=\"flex items-center justify-between p-2 bg-secondary/50 rounded-lg\">\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                          <FileText className=\"w-4 h-4 text-primary shrink-0\" />\n                          <span className=\"text-sm truncate\">{file.filename}</span>\n                          <span className=\"text-xs text-muted-foreground\">({formatFileSize(file.size)})</span>\n                        </div>\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6 shrink-0\"\n                          onClick={() => removeAttachment(file.id, false)}\n                        >\n                          <X className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowNewOpportunityDialog(false)}>Cancel</Button>\n            <Button onClick={handleCreateOpportunity} disabled={createDeal.isPending} data-testid=\"button-create-opportunity\">\n              {createDeal.isPending ? \"Creating...\" : \"Add Opportunity\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Opportunity Detail Sheet - Enhanced with Tabs */}\n      <Sheet open={showOpportunityDetail} onOpenChange={setShowOpportunityDetail}>\n        <SheetContent className=\"bg-card border-border w-[600px] sm:max-w-[600px]\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              <Lightbulb className=\"w-5 h-5 text-amber-500\" />\n              {selectedOpportunity?.name}\n            </SheetTitle>\n            <SheetDescription>{selectedOpportunity?.client}</SheetDescription>\n          </SheetHeader>\n          \n          {selectedOpportunity && (\n            <div className=\"mt-6\">\n              <Tabs value={detailTab} onValueChange={(v) => setDetailTab(v as any)}>\n                <TabsList className=\"w-full grid grid-cols-4\">\n                  <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n                  <TabsTrigger value=\"team\">\n                    Team\n                    {((selectedOpportunity as any)?.podTeam?.length > 0) && (\n                      <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5\">{(selectedOpportunity as any).podTeam.length}</Badge>\n                    )}\n                  </TabsTrigger>\n                  <TabsTrigger value=\"attachments\">\n                    Attach.\n                    {opportunityAttachments.length > 0 && (\n                      <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5\">{opportunityAttachments.length}</Badge>\n                    )}\n                  </TabsTrigger>\n                  <TabsTrigger value=\"notes\">\n                    Notes\n                    {opportunityNotes.length > 0 && (\n                      <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5\">{opportunityNotes.length}</Badge>\n                    )}\n                  </TabsTrigger>\n                </TabsList>\n                \n                <ScrollArea className=\"h-[calc(100vh-350px)] mt-4\">\n                  <TabsContent value=\"overview\" className=\"space-y-4 pr-4 mt-0\">\n                    {isEditMode ? (\n                      <div className=\"space-y-4\">\n                        <div className=\"space-y-2\">\n                          <Label>Opportunity Name *</Label>\n                          <Input\n                            value={editForm.name}\n                            onChange={(e) => setEditForm({ ...editForm, name: e.target.value })}\n                            placeholder=\"Enter opportunity name\"\n                            data-testid=\"input-edit-opportunity-name\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Client *</Label>\n                          <Input\n                            value={editForm.client}\n                            onChange={(e) => setEditForm({ ...editForm, client: e.target.value })}\n                            placeholder=\"Enter client name\"\n                            data-testid=\"input-edit-client\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Sector</Label>\n                          <Popover open={editSectorOpen} onOpenChange={setEditSectorOpen}>\n                            <PopoverTrigger asChild>\n                              <Button\n                                variant=\"outline\"\n                                role=\"combobox\"\n                                aria-expanded={editSectorOpen}\n                                className=\"w-full justify-between\"\n                                data-testid=\"select-edit-sector\"\n                              >\n                                {editForm.sector === 'Other' && editForm.customSector \n                                  ? editForm.customSector \n                                  : editForm.sector || \"Select sector...\"}\n                                <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                              </Button>\n                            </PopoverTrigger>\n                            <PopoverContent className=\"w-full p-0\">\n                              <Command>\n                                <CommandInput placeholder=\"Search or add sector...\" />\n                                <CommandList>\n                                  <CommandEmpty>\n                                    <Button\n                                      variant=\"ghost\"\n                                      className=\"w-full justify-start\"\n                                      onClick={() => {\n                                        const searchValue = (document.querySelector('[cmdk-input]') as HTMLInputElement)?.value || '';\n                                        if (searchValue) {\n                                          setEditForm({ ...editForm, sector: 'Other', customSector: searchValue });\n                                          setEditSectorOpen(false);\n                                        }\n                                      }}\n                                    >\n                                      <Plus className=\"mr-2 h-4 w-4\" />\n                                      Add new sector\n                                    </Button>\n                                  </CommandEmpty>\n                                  <CommandGroup>\n                                    {SECTORS.map((sector) => (\n                                      <CommandItem\n                                        key={sector}\n                                        value={sector}\n                                        onSelect={(value) => {\n                                          setEditForm({ ...editForm, sector: value, customSector: '' });\n                                          setEditSectorOpen(false);\n                                        }}\n                                      >\n                                        <CheckIcon\n                                          className={cn(\n                                            \"mr-2 h-4 w-4\",\n                                            editForm.sector === sector ? \"opacity-100\" : \"opacity-0\"\n                                          )}\n                                        />\n                                        {sector}\n                                      </CommandItem>\n                                    ))}\n                                  </CommandGroup>\n                                </CommandList>\n                              </Command>\n                            </PopoverContent>\n                          </Popover>\n                          {editForm.sector === 'Other' && (\n                            <Input\n                              value={editForm.customSector}\n                              onChange={(e) => setEditForm({ ...editForm, customSector: e.target.value })}\n                              placeholder=\"Enter custom sector\"\n                              className=\"mt-2\"\n                              data-testid=\"input-edit-custom-sector\"\n                            />\n                          )}\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Estimated Value ($M)</Label>\n                          <Input\n                            type=\"number\"\n                            value={editForm.value}\n                            onChange={(e) => setEditForm({ ...editForm, value: e.target.value })}\n                            placeholder=\"0\"\n                            data-testid=\"input-edit-value\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Lead Contact</Label>\n                          <Input\n                            value={editForm.lead}\n                            onChange={(e) => setEditForm({ ...editForm, lead: e.target.value })}\n                            placeholder=\"Enter lead contact name\"\n                            data-testid=\"input-edit-lead\"\n                          />\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label>Description</Label>\n                          <Textarea\n                            value={editForm.description}\n                            onChange={(e) => setEditForm({ ...editForm, description: e.target.value })}\n                            placeholder=\"Enter opportunity details...\"\n                            rows={4}\n                            data-testid=\"textarea-edit-description\"\n                          />\n                        </div>\n                        <div className=\"flex gap-2\">\n                          <Button\n                            variant=\"outline\"\n                            className=\"flex-1\"\n                            onClick={() => setIsEditMode(false)}\n                            data-testid=\"button-cancel-edit\"\n                          >\n                            Cancel\n                          </Button>\n                          <Button\n                            className=\"flex-1\"\n                            onClick={handleSaveEdit}\n                            disabled={updateDeal.isPending}\n                            data-testid=\"button-save-edit\"\n                          >\n                            <Save className=\"w-4 h-4 mr-2\" />\n                            {updateDeal.isPending ? \"Saving...\" : \"Save Changes\"}\n                          </Button>\n                        </div>\n                      </div>\n                    ) : (\n                      <>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div className=\"p-3 rounded-lg bg-secondary/30\">\n                            <p className=\"text-xs text-muted-foreground\">Estimated Value</p>\n                            <p className=\"text-lg font-bold text-primary\">${selectedOpportunity.value}M</p>\n                          </div>\n                          <div className=\"p-3 rounded-lg bg-secondary/30\">\n                            <p className=\"text-xs text-muted-foreground\">Sector</p>\n                            <p className=\"font-medium\">{selectedOpportunity.sector}</p>\n                          </div>\n                        </div>\n                        \n                        {selectedOpportunity.lead && (\n                          <div className=\"p-3 rounded-lg bg-secondary/30\">\n                            <p className=\"text-xs text-muted-foreground\">Lead Contact</p>\n                            <p className=\"font-medium\">{selectedOpportunity.lead}</p>\n                          </div>\n                        )}\n                        \n                        {selectedOpportunity.description && (\n                          <div className=\"p-3 rounded-lg bg-secondary/30\">\n                            <p className=\"text-xs text-muted-foreground mb-1\">Description</p>\n                            <p className=\"text-sm whitespace-pre-wrap\">{selectedOpportunity.description}</p>\n                          </div>\n                        )}\n                        \n                        <div className=\"p-3 rounded-lg bg-secondary/30\">\n                          <p className=\"text-xs text-muted-foreground mb-1\">Stage</p>\n                          <Badge>{selectedOpportunity.stage}</Badge>\n                        </div>\n                        \n                        {(selectedOpportunity as any).createdAt && (\n                          <div className=\"p-3 rounded-lg bg-secondary/30\">\n                            <p className=\"text-xs text-muted-foreground\">Created</p>\n                            <p className=\"text-sm\">{format(new Date((selectedOpportunity as any).createdAt), 'PPp')}</p>\n                          </div>\n                        )}\n                        \n                        <Button\n                          variant=\"outline\"\n                          className=\"w-full\"\n                          onClick={() => setIsEditMode(true)}\n                          data-testid=\"button-edit-opportunity\"\n                        >\n                          <Pencil className=\"w-4 h-4 mr-2\" />\n                          Edit Opportunity\n                        </Button>\n                      </>\n                    )}\n                  </TabsContent>\n                  \n                  {/* Team Tagging Tab */}\n                  <TabsContent value=\"team\" className=\"space-y-4 pr-4 mt-0\">\n                    <div className=\"relative\">\n                      <Search className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search team members...\"\n                        value={teamSearchQuery}\n                        onChange={(e) => {\n                          setTeamSearchQuery(e.target.value);\n                          setShowTeamDropdown(true);\n                        }}\n                        onFocus={() => setShowTeamDropdown(true)}\n                        className=\"pl-9\"\n                        data-testid=\"input-search-team-members\"\n                      />\n                      {showTeamDropdown && teamSearchQuery && (\n                        <div className=\"absolute top-full left-0 right-0 mt-1 bg-card border border-border rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto\">\n                          {users\n                            .filter(user => {\n                              const searchLower = teamSearchQuery.toLowerCase();\n                              const alreadyTagged = ((selectedOpportunity as any)?.podTeam || []).some(\n                                (m: any) => m.userId === user.id\n                              );\n                              if (alreadyTagged) return false;\n                              return (\n                                user.name.toLowerCase().includes(searchLower) ||\n                                (user.email?.toLowerCase() || '').includes(searchLower) ||\n                                (user.role?.toLowerCase() || '').includes(searchLower) ||\n                                (user.jobTitle?.toLowerCase() || '').includes(searchLower)\n                              );\n                            })\n                            .slice(0, 8)\n                            .map(user => (\n                              <div\n                                key={user.id}\n                                className=\"flex items-center gap-3 p-3 hover:bg-secondary/50 cursor-pointer transition-colors\"\n                                onClick={async () => {\n                                  if (!selectedOpportunity) return;\n                                  try {\n                                    await tagMember.mutateAsync({\n                                      dealId: selectedOpportunity.id,\n                                      memberId: user.id,\n                                      memberName: user.name,\n                                      memberRole: user.jobTitle || user.role || 'Team Member',\n                                    });\n                                    toast.success(`${user.name} tagged and notified`);\n                                    setTeamSearchQuery(\"\");\n                                    setShowTeamDropdown(false);\n                                  } catch (error: any) {\n                                    toast.error(error.message || \"Failed to tag team member\");\n                                  }\n                                }}\n                                data-testid={`tag-member-${user.id}`}\n                              >\n                                <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-xs font-bold text-primary\">\n                                  {user.name.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"text-sm font-medium truncate\">{user.name}</div>\n                                  <div className=\"text-xs text-muted-foreground truncate\">{user.jobTitle || user.role}</div>\n                                </div>\n                                <Badge variant=\"secondary\" className=\"text-xs shrink-0\">{user.role}</Badge>\n                              </div>\n                            ))}\n                          {users.filter(user => {\n                            const searchLower = teamSearchQuery.toLowerCase();\n                            const alreadyTagged = ((selectedOpportunity as any)?.podTeam || []).some(\n                              (m: any) => m.userId === user.id\n                            );\n                            return !alreadyTagged && (\n                              user.name.toLowerCase().includes(searchLower) ||\n                              (user.email?.toLowerCase() || '').includes(searchLower)\n                            );\n                          }).length === 0 && (\n                            <div className=\"p-3 text-sm text-muted-foreground text-center\">\n                              No matching team members found\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                    \n                    {/* Tagged Members List */}\n                    <div className=\"space-y-2\">\n                      <p className=\"text-xs text-muted-foreground uppercase tracking-wider\">Tagged Team Members</p>\n                      {((selectedOpportunity as any)?.podTeam && (selectedOpportunity as any).podTeam.length > 0) ? (\n                        <div className=\"space-y-2\">\n                          {((selectedOpportunity as any).podTeam as PodTeamMember[]).map((member, index) => (\n                            <div key={member.userId || index} className=\"flex items-center justify-between p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-xs font-bold text-primary\">\n                                  {member.name.split(' ').map(n => n[0]).join('').slice(0, 2)}\n                                </div>\n                                <div>\n                                  <p className=\"text-sm font-medium\">{member.name}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{member.jobTitle || member.role}</p>\n                                </div>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"h-8 w-8 text-destructive hover:text-destructive\"\n                                onClick={async () => {\n                                  if (!selectedOpportunity || !member.userId) return;\n                                  try {\n                                    await removeMember.mutateAsync({\n                                      dealId: selectedOpportunity.id,\n                                      memberId: member.userId,\n                                    });\n                                    toast.success(`${member.name} removed from opportunity`);\n                                  } catch (error: any) {\n                                    toast.error(error.message || \"Failed to remove team member\");\n                                  }\n                                }}\n                                data-testid={`remove-member-${member.userId}`}\n                              >\n                                <X className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          ))}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <Users className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                          <p className=\"text-sm\">No team members tagged yet</p>\n                          <p className=\"text-xs mt-1\">Search above to add team members</p>\n                        </div>\n                      )}\n                    </div>\n                  </TabsContent>\n                  \n                  <TabsContent value=\"attachments\" className=\"space-y-4 pr-4 mt-0\">\n                    <input\n                      ref={detailFileInputRef}\n                      type=\"file\"\n                      multiple\n                      className=\"hidden\"\n                      onChange={(e) => handleFileUpload(e, true)}\n                      accept=\".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      className=\"w-full\"\n                      onClick={() => detailFileInputRef.current?.click()}\n                    >\n                      <Upload className=\"w-4 h-4 mr-2\" />\n                      Upload Attachments\n                    </Button>\n                    \n                    {opportunityAttachments.length > 0 ? (\n                      <div className=\"space-y-2\">\n                        {opportunityAttachments.map((file) => (\n                          <div key={file.id} className=\"flex items-center justify-between p-3 bg-secondary/30 rounded-lg\">\n                            <div className=\"flex items-center gap-3 min-w-0\">\n                              <FileText className=\"w-5 h-5 text-primary shrink-0\" />\n                              <div className=\"min-w-0\">\n                                <p className=\"text-sm font-medium truncate\">{file.filename}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {formatFileSize(file.size)}  {format(new Date(file.uploadedAt), 'PP')}\n                                </p>\n                              </div>\n                            </div>\n                            <div className=\"flex gap-1\">\n                              <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\"\n                                onClick={() => window.open(file.url, '_blank')}\n                                title=\"View\"\n                                data-testid={`view-attachment-${file.id}`}\n                              >\n                                <ExternalLink className=\"w-4 h-4\" />\n                              </Button>\n                              <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\"\n                                onClick={() => {\n                                  const link = document.createElement('a');\n                                  link.href = file.url;\n                                  link.download = file.filename;\n                                  document.body.appendChild(link);\n                                  link.click();\n                                  document.body.removeChild(link);\n                                }}\n                                title=\"Download\"\n                                data-testid={`download-attachment-${file.id}`}\n                              >\n                                <Download className=\"w-4 h-4\" />\n                              </Button>\n                              <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive\"\n                                onClick={() => removeAttachment(file.id, true)}\n                                title=\"Delete\"\n                              >\n                                <Trash2 className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <Paperclip className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                        <p className=\"text-sm\">No attachments yet</p>\n                      </div>\n                    )}\n                  </TabsContent>\n                  \n                  <TabsContent value=\"notes\" className=\"space-y-4 pr-4 mt-0\">\n                    {selectedOpportunity && (\n                      <DealNotesSection dealId={selectedOpportunity.id} allUsers={users} />\n                    )}\n                  </TabsContent>\n                </ScrollArea>\n              </Tabs>\n              \n              {/* Action Buttons */}\n              <div className=\"pt-4 border-t border-border space-y-3 mt-4\">\n                <h4 className=\"font-medium text-sm\">Take Action</h4>\n                <div className=\"flex gap-2\">\n                  <Button className=\"flex-1 bg-green-600 hover:bg-green-700\" \n                    onClick={() => setShowApproveDialog(true)}\n                    data-testid=\"button-detail-approve\"\n                  >\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Approve Deal\n                  </Button>\n                  <Button variant=\"destructive\" className=\"flex-1\"\n                    onClick={() => setShowRejectDialog(true)}\n                    data-testid=\"button-detail-reject\"\n                  >\n                    <XCircle className=\"w-4 h-4 mr-2\" />\n                    Reject\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n        </SheetContent>\n      </Sheet>\n      \n      {/* Approve Dialog */}\n      <AlertDialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>\n        <AlertDialogContent className=\"bg-card border-border\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Approve Opportunity</AlertDialogTitle>\n            <AlertDialogDescription>\n              Choose which division this deal should be assigned to.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <div className=\"py-4\">\n            <Label>Assign to Division</Label>\n            <Select value={approvalDivision} onValueChange={setApprovalDivision}>\n              <SelectTrigger className=\"mt-2\" data-testid=\"select-approval-division\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {DIVISIONS.map(division => (\n                  <SelectItem key={division} value={division}>{division}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <p className=\"text-xs text-muted-foreground mt-2\">\n              {approvalDivision === 'Investment Banking' \n                ? 'Deal will appear in Deal Management page' \n                : 'Deal will appear in Asset Management page'}\n            </p>\n          </div>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction onClick={handleApprove} className=\"bg-green-600 hover:bg-green-700\" data-testid=\"button-confirm-approve\">\n              Approve & Move\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n      \n      {/* Reject Dialog */}\n      <AlertDialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>\n        <AlertDialogContent className=\"bg-card border-border\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"w-5 h-5 text-red-500\" />\n              Reject Opportunity\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to reject this opportunity? This action will remove it permanently.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction onClick={handleReject} className=\"bg-red-600 hover:bg-red-700\" data-testid=\"button-confirm-reject\">\n              Reject & Remove\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":64521,"size_tokens":null},"client/src/components/chat/FloatingChatWidget.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  MoreHorizontal,\n  PenSquare,\n  ChevronUp,\n  ChevronDown,\n  Search,\n  Maximize2,\n  Send,\n  ArrowLeft,\n  SlidersHorizontal\n} from \"lucide-react\";\nimport { useCurrentUser, useUsers } from \"@/lib/api\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\ntype ConversationMember = {\n  id: string;\n  name: string;\n  avatar?: string;\n};\n\ntype Conversation = {\n  id: string;\n  name: string | null;\n  isGroup: boolean | null;\n  createdBy: string | null;\n  members: ConversationMember[];\n  lastMessage: {\n    content: string;\n    senderId: string;\n    createdAt: string;\n  } | null;\n  unreadCount: number;\n};\n\ntype Message = {\n  id: string;\n  senderId: string;\n  senderName: string;\n  content: string;\n  createdAt: string;\n};\n\nexport function FloatingChatWidget() {\n  const [, setLocation] = useLocation();\n  const { data: currentUser } = useCurrentUser();\n  const { data: allUsers = [] } = useUsers();\n  const queryClient = useQueryClient();\n  \n  const [isExpanded, setIsExpanded] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [activeChat, setActiveChat] = useState<string | null>(null);\n  const [messageInput, setMessageInput] = useState(\"\");\n  const [activeTab, setActiveTab] = useState<'focused' | 'other'>('focused');\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const previousMessagesRef = useRef<Message[]>([]);\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n  \n  // Initialize notification sound\n  useEffect(() => {\n    audioRef.current = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQYAJ5rk/+WxOgAAU+b/+9BQAABU7f/61VcAAFLr//bQVAAAT+f/9MxQAABM4//xyEsAAEne/+7ERAD/Rdn/7MBAAP9C1f/qvDsA/z/R/+i4NgD/PNT/57Q0AP8x0P/krS8A/yjM/+KnKgD/H8j/4KElAP8Vw//enhsA/wzA/92VFgD/A73/25ERAP/6uv/ajw0A//a4/9mMCAD/8rb/2IoDAP/vsf/YhP//+6uu/9eA+//+q6z/1n73//+oqv/Ueu7/');\n    audioRef.current.volume = 0.5;\n  }, []);\n  \n  // Fetch conversations\n  const { data: conversations = [] } = useQuery<Conversation[]>({\n    queryKey: [\"/api/chat/conversations\"],\n    refetchInterval: 5000,\n  });\n  \n  // Fetch messages for active chat\n  const { data: messages = [] } = useQuery<Message[]>({\n    queryKey: [`/api/chat/conversations/${activeChat}/messages`],\n    enabled: !!activeChat,\n    refetchInterval: 3000,\n  });\n  \n  // Play sound on new messages\n  useEffect(() => {\n    if (messages.length > 0 && previousMessagesRef.current.length > 0) {\n      const newMessages = messages.filter(\n        m => !previousMessagesRef.current.some(pm => pm.id === m.id) && \n        m.senderId !== currentUser?.id\n      );\n      if (newMessages.length > 0 && audioRef.current) {\n        audioRef.current.play().catch(() => {});\n      }\n    }\n    previousMessagesRef.current = messages;\n  }, [messages, currentUser?.id]);\n  \n  // Send message mutation\n  const sendMessageMutation = useMutation({\n    mutationFn: async ({ conversationId, content }: { conversationId: string; content: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to send message\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${activeChat}/messages`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setMessageInput(\"\");\n    },\n  });\n  \n  // Auto-scroll to bottom\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n  \n  const totalUnread = conversations.reduce((sum, c) => sum + c.unreadCount, 0);\n  \n  const getConversationName = (conv: Conversation) => {\n    if (conv.name) return conv.name;\n    if (conv.isGroup) return \"Group Chat\";\n    const otherMember = conv.members.find(m => m.id !== currentUser?.id);\n    return otherMember?.name || \"Chat\";\n  };\n  \n  const getInitials = (name: string) => {\n    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n  };\n  \n  // Filter conversations based on search and tab\n  const filteredConversations = conversations.filter(conv => {\n    if (!searchQuery) return true;\n    const name = getConversationName(conv).toLowerCase();\n    return name.includes(searchQuery.toLowerCase());\n  }).filter(conv => {\n    // Focused = has recent activity or unread, Other = older conversations\n    if (activeTab === 'focused') {\n      return conv.unreadCount > 0 || conv.lastMessage;\n    }\n    return true;\n  });\n  \n  const handleSendMessage = () => {\n    if (!activeChat || !messageInput.trim()) return;\n    sendMessageMutation.mutate({ conversationId: activeChat, content: messageInput.trim() });\n  };\n  \n  const openFullChat = () => {\n    const basePath = currentUser?.accessLevel === 'admin' ? '/ceo' : '/employee';\n    setLocation(`${basePath}/chat`);\n    setIsExpanded(false);\n  };\n  \n  if (!currentUser) return null;\n  \n  // Get active conversation details\n  const activeChatData = activeChat ? conversations.find(c => c.id === activeChat) : null;\n  \n  // Format date for conversation list\n  const formatConversationDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    const now = new Date();\n    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));\n    \n    if (diffDays === 0) return format(date, 'h:mm a');\n    if (diffDays < 7) return format(date, 'EEE');\n    return format(date, 'MMM d');\n  };\n  \n  return (\n    <div className=\"fixed bottom-6 right-6 z-40\" data-testid=\"floating-chat-widget\">\n      {/* Expanded chat panel */}\n      {isExpanded && (\n        <Card className=\"w-80 mb-2 bg-white dark:bg-card border border-gray-200 dark:border-border shadow-xl rounded-lg overflow-hidden animate-in slide-in-from-bottom-2 duration-200\">\n          {activeChat ? (\n            // Active chat view\n            <>\n              <div className=\"px-3 py-2.5 border-b border-gray-200 dark:border-border flex items-center justify-between bg-white dark:bg-card\">\n                <div className=\"flex items-center gap-2\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-7 w-7 hover:bg-gray-100 dark:hover:bg-secondary\"\n                    onClick={() => setActiveChat(null)}\n                  >\n                    <ArrowLeft className=\"w-4 h-4\" />\n                  </Button>\n                  <div className=\"relative\">\n                    <Avatar className=\"h-8 w-8\">\n                      <AvatarFallback className=\"text-xs bg-primary/20 text-primary\">\n                        {activeChatData ? getInitials(getConversationName(activeChatData)) : \"?\"}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n                  </div>\n                  <span className=\"font-semibold text-sm text-gray-900 dark:text-foreground truncate max-w-[140px]\">\n                    {activeChatData ? getConversationName(activeChatData) : \"Chat\"}\n                  </span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7 hover:bg-gray-100 dark:hover:bg-secondary\" onClick={openFullChat}>\n                    <Maximize2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n              <CardContent className=\"p-0\">\n                <ScrollArea className=\"h-72 p-3 bg-gray-50 dark:bg-secondary/20\">\n                  {messages.map((msg) => (\n                    <div \n                      key={msg.id}\n                      className={cn(\n                        \"mb-3 max-w-[85%]\",\n                        msg.senderId === currentUser?.id ? \"ml-auto\" : \"\"\n                      )}\n                    >\n                      <div className={cn(\n                        \"rounded-2xl px-3 py-2 text-sm\",\n                        msg.senderId === currentUser?.id \n                          ? \"bg-blue-600 text-white rounded-br-sm\" \n                          : \"bg-white dark:bg-card border border-gray-200 dark:border-border rounded-bl-sm\"\n                      )}>\n                        {msg.senderId !== currentUser?.id && (\n                          <div className=\"text-xs font-medium mb-1 text-gray-500 dark:text-muted-foreground\">{msg.senderName}</div>\n                        )}\n                        {msg.content}\n                      </div>\n                      <div className={cn(\n                        \"text-[10px] text-gray-400 mt-0.5 px-1\",\n                        msg.senderId === currentUser?.id ? \"text-right\" : \"\"\n                      )}>\n                        {format(new Date(msg.createdAt), 'h:mm a')}\n                      </div>\n                    </div>\n                  ))}\n                  <div ref={messagesEndRef} />\n                </ScrollArea>\n                <div className=\"p-2 border-t border-gray-200 dark:border-border flex gap-2 bg-white dark:bg-card\">\n                  <Input\n                    value={messageInput}\n                    onChange={(e) => setMessageInput(e.target.value)}\n                    placeholder=\"Write a message...\"\n                    className=\"h-9 text-sm border-gray-200 dark:border-border rounded-full px-4\"\n                    onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}\n                    data-testid=\"input-floating-chat-message\"\n                  />\n                  <Button \n                    size=\"icon\" \n                    className=\"h-9 w-9 shrink-0 rounded-full bg-blue-600 hover:bg-blue-700\"\n                    onClick={handleSendMessage}\n                    disabled={sendMessageMutation.isPending || !messageInput.trim()}\n                    data-testid=\"button-send-floating-message\"\n                  >\n                    <Send className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </>\n          ) : (\n            // Conversation list view (LinkedIn style)\n            <>\n              {/* Header */}\n              <div className=\"px-3 py-2.5 border-b border-gray-200 dark:border-border flex items-center justify-between bg-white dark:bg-card\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"relative\">\n                    <Avatar className=\"h-8 w-8\">\n                      <AvatarFallback className=\"text-xs bg-primary/20 text-primary\">\n                        {currentUser ? getInitials(currentUser.name) : \"?\"}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n                  </div>\n                  <span className=\"font-semibold text-base text-gray-900 dark:text-foreground\">Messaging</span>\n                </div>\n                <div className=\"flex items-center gap-0.5\">\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\">\n                    <MoreHorizontal className=\"w-5 h-5 text-gray-600 dark:text-muted-foreground\" />\n                  </Button>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\" onClick={openFullChat}>\n                    <PenSquare className=\"w-5 h-5 text-gray-600 dark:text-muted-foreground\" />\n                  </Button>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"icon\" \n                    className=\"h-8 w-8 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\"\n                    onClick={() => setIsExpanded(false)}\n                  >\n                    <ChevronDown className=\"w-5 h-5 text-gray-600 dark:text-muted-foreground\" />\n                  </Button>\n                </div>\n              </div>\n              \n              {/* Search */}\n              <div className=\"px-3 py-2 border-b border-gray-200 dark:border-border bg-white dark:bg-card\">\n                <div className=\"relative flex items-center\">\n                  <Search className=\"absolute left-3 w-4 h-4 text-gray-400\" />\n                  <Input\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    placeholder=\"Search messages\"\n                    className=\"h-8 pl-9 pr-9 text-sm bg-gray-100 dark:bg-secondary border-0 rounded-md\"\n                    data-testid=\"input-search-floating-chat\"\n                  />\n                  <Button variant=\"ghost\" size=\"icon\" className=\"absolute right-0 h-8 w-8 hover:bg-transparent\">\n                    <SlidersHorizontal className=\"w-4 h-4 text-gray-500\" />\n                  </Button>\n                </div>\n              </div>\n              \n              {/* Tabs */}\n              <div className=\"px-3 border-b border-gray-200 dark:border-border bg-white dark:bg-card\">\n                <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'focused' | 'other')}>\n                  <TabsList className=\"bg-transparent h-10 p-0 gap-4\">\n                    <TabsTrigger \n                      value=\"focused\" \n                      className=\"px-0 pb-2 pt-1 rounded-none data-[state=active]:bg-transparent data-[state=active]:shadow-none data-[state=active]:border-b-2 data-[state=active]:border-green-600 data-[state=active]:text-green-700 dark:data-[state=active]:text-green-500 text-gray-500 dark:text-muted-foreground font-medium\"\n                    >\n                      Focused\n                    </TabsTrigger>\n                    <TabsTrigger \n                      value=\"other\"\n                      className=\"px-0 pb-2 pt-1 rounded-none data-[state=active]:bg-transparent data-[state=active]:shadow-none data-[state=active]:border-b-2 data-[state=active]:border-green-600 data-[state=active]:text-green-700 dark:data-[state=active]:text-green-500 text-gray-500 dark:text-muted-foreground font-medium\"\n                    >\n                      Other\n                    </TabsTrigger>\n                  </TabsList>\n                </Tabs>\n              </div>\n              \n              {/* Conversation List */}\n              <CardContent className=\"p-0 bg-white dark:bg-card\">\n                <ScrollArea className=\"h-80\">\n                  {filteredConversations.length === 0 ? (\n                    <div className=\"text-center py-12 text-gray-500 dark:text-muted-foreground text-sm\">\n                      No conversations yet\n                    </div>\n                  ) : (\n                    filteredConversations.map((conv) => (\n                      <div\n                        key={conv.id}\n                        className={cn(\n                          \"flex items-start gap-3 px-3 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-secondary/50 transition-colors border-b border-gray-100 dark:border-border/50\",\n                          conv.unreadCount > 0 && \"bg-blue-50/50 dark:bg-primary/5\"\n                        )}\n                        onClick={() => setActiveChat(conv.id)}\n                        data-testid={`chat-conversation-${conv.id}`}\n                      >\n                        <div className=\"relative shrink-0\">\n                          <Avatar className=\"h-12 w-12\">\n                            <AvatarFallback className=\"text-sm bg-gray-200 dark:bg-secondary text-gray-700 dark:text-foreground\">\n                              {getInitials(getConversationName(conv))}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className=\"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center justify-between mb-0.5\">\n                            <span className={cn(\n                              \"text-sm text-gray-900 dark:text-foreground truncate\",\n                              conv.unreadCount > 0 && \"font-semibold\"\n                            )}>\n                              {getConversationName(conv)}\n                            </span>\n                            {conv.lastMessage && (\n                              <span className=\"text-xs text-gray-500 dark:text-muted-foreground shrink-0 ml-2\">\n                                {formatConversationDate(conv.lastMessage.createdAt)}\n                              </span>\n                            )}\n                          </div>\n                          {conv.lastMessage && (\n                            <p className={cn(\n                              \"text-sm truncate\",\n                              conv.unreadCount > 0 \n                                ? \"text-gray-900 dark:text-foreground font-medium\" \n                                : \"text-gray-500 dark:text-muted-foreground\"\n                            )}>\n                              {conv.lastMessage.senderId === currentUser?.id ? 'You: ' : ''}\n                              {conv.lastMessage.content}\n                            </p>\n                          )}\n                        </div>\n                        {conv.unreadCount > 0 && (\n                          <Badge className=\"h-5 min-w-[20px] px-1.5 flex items-center justify-center text-[10px] bg-blue-600 hover:bg-blue-600 shrink-0 mt-1\">\n                            {conv.unreadCount}\n                          </Badge>\n                        )}\n                      </div>\n                    ))\n                  )}\n                </ScrollArea>\n              </CardContent>\n            </>\n          )}\n        </Card>\n      )}\n      \n      {/* Collapsed bar (LinkedIn style rectangular) */}\n      <div \n        className={cn(\n          \"flex items-center justify-between gap-2 px-3 py-2 rounded-lg shadow-lg cursor-pointer transition-all\",\n          \"bg-white dark:bg-card border border-gray-200 dark:border-border\",\n          \"hover:shadow-xl\",\n          isExpanded && \"opacity-0 pointer-events-none\"\n        )}\n        onClick={() => setIsExpanded(true)}\n        data-testid=\"button-toggle-floating-chat\"\n      >\n        <div className=\"flex items-center gap-2\">\n          <div className=\"relative\">\n            <Avatar className=\"h-8 w-8\">\n              <AvatarFallback className=\"text-xs bg-primary/20 text-primary\">\n                {currentUser ? getInitials(currentUser.name) : \"?\"}\n              </AvatarFallback>\n            </Avatar>\n            <div className=\"absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n          </div>\n          <span className=\"font-semibold text-sm text-gray-900 dark:text-foreground\">Messaging</span>\n          {totalUnread > 0 && (\n            <Badge className=\"h-5 min-w-[20px] px-1.5 flex items-center justify-center text-[10px] bg-blue-600 hover:bg-blue-600\">\n              {totalUnread > 9 ? '9+' : totalUnread}\n            </Badge>\n          )}\n        </div>\n        <div className=\"flex items-center gap-0.5\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"h-7 w-7 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\"\n            onClick={(e) => { e.stopPropagation(); openFullChat(); }}\n            title=\"Open full chat\"\n            data-testid=\"button-chat-fullscreen\"\n          >\n            <Maximize2 className=\"w-4 h-4 text-gray-600 dark:text-muted-foreground\" />\n          </Button>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"h-7 w-7 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\"\n            onClick={(e) => { e.stopPropagation(); openFullChat(); }}\n            title=\"New message\"\n            data-testid=\"button-chat-new-message\"\n          >\n            <PenSquare className=\"w-4 h-4 text-gray-600 dark:text-muted-foreground\" />\n          </Button>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"h-7 w-7 hover:bg-gray-100 dark:hover:bg-secondary rounded-full\"\n            onClick={(e) => { e.stopPropagation(); setIsExpanded(true); }}\n            title=\"Expand\"\n            data-testid=\"button-chat-expand\"\n          >\n            <ChevronUp className=\"w-4 h-4 text-gray-600 dark:text-muted-foreground\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21381,"size_tokens":null},"client/src/hooks/useDebounce.ts":{"content":"import { useState, useEffect, useCallback, useRef } from 'react';\n\nexport function useDebounce<T>(value: T, delay: number): T {\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(timer);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n\nexport function useDebouncedCallback<T extends (...args: any[]) => any>(\n  callback: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const callbackRef = useRef(callback);\n  \n  useEffect(() => {\n    callbackRef.current = callback;\n  }, [callback]);\n\n  const debouncedCallback = useCallback(\n    (...args: Parameters<T>) => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n      timeoutRef.current = setTimeout(() => {\n        callbackRef.current(...args);\n      }, delay);\n    },\n    [delay]\n  );\n\n  useEffect(() => {\n    return () => {\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, []);\n\n  return debouncedCallback;\n}\n\nexport default useDebounce;\n","path":null,"size_bytes":1218,"size_tokens":null},"client/src/components/VirtualList.tsx":{"content":"import { useRef } from 'react';\nimport { useVirtualizer } from '@tanstack/react-virtual';\n\ninterface VirtualListProps<T> {\n  items: T[];\n  renderItem: (item: T, index: number) => React.ReactNode;\n  estimateSize?: number;\n  overscan?: number;\n  className?: string;\n  itemClassName?: string;\n}\n\nexport function VirtualList<T>({\n  items,\n  renderItem,\n  estimateSize = 80,\n  overscan = 5,\n  className = '',\n  itemClassName = '',\n}: VirtualListProps<T>) {\n  const parentRef = useRef<HTMLDivElement>(null);\n\n  const virtualizer = useVirtualizer({\n    count: items.length,\n    getScrollElement: () => parentRef.current,\n    estimateSize: () => estimateSize,\n    overscan,\n  });\n\n  const virtualItems = virtualizer.getVirtualItems();\n\n  if (items.length === 0) {\n    return null;\n  }\n\n  return (\n    <div\n      ref={parentRef}\n      className={`overflow-auto ${className}`}\n      style={{ contain: 'strict' }}\n    >\n      <div\n        style={{\n          height: `${virtualizer.getTotalSize()}px`,\n          width: '100%',\n          position: 'relative',\n        }}\n      >\n        {virtualItems.map((virtualItem) => (\n          <div\n            key={virtualItem.key}\n            className={itemClassName}\n            style={{\n              position: 'absolute',\n              top: 0,\n              left: 0,\n              width: '100%',\n              transform: `translateY(${virtualItem.start}px)`,\n            }}\n            data-index={virtualItem.index}\n          >\n            {renderItem(items[virtualItem.index], virtualItem.index)}\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default VirtualList;\n","path":null,"size_bytes":1621,"size_tokens":null},"client/src/components/ObjectUploader.tsx":{"content":"import { useState, useRef, useCallback } from \"react\";\nimport type { ReactNode } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { X, Upload, FileIcon, CheckCircle, AlertCircle, Loader2, RefreshCw } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { triggerSessionExpired } from \"@/lib/api\";\n\nclass NonRetryableError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'NonRetryableError';\n  }\n}\n\ninterface UploadedFile {\n  id: string;\n  filename: string;\n  objectPath: string;\n  size: number;\n  type: string;\n}\n\ninterface PendingFile {\n  id: string;\n  file: File;\n  progress: number;\n  status: 'pending' | 'uploading' | 'success' | 'error';\n  error?: string;\n  objectPath?: string;\n}\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  allowedFileTypes?: string[];\n  accept?: string;\n  onComplete?: (files: UploadedFile[]) => void;\n  onError?: (error: Error) => void;\n  buttonClassName?: string;\n  buttonVariant?: \"default\" | \"outline\" | \"ghost\" | \"destructive\" | \"secondary\" | \"link\";\n  buttonSize?: \"default\" | \"sm\" | \"lg\" | \"icon\";\n  disabled?: boolean;\n  children: ReactNode;\n}\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nexport function ObjectUploader({\n  maxNumberOfFiles = 10,\n  maxFileSize = 500 * 1024 * 1024, // 500MB default\n  allowedFileTypes,\n  accept,\n  onComplete,\n  onError,\n  buttonClassName,\n  buttonVariant = \"outline\",\n  buttonSize = \"default\",\n  disabled = false,\n  children,\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [pendingFiles, setPendingFiles] = useState<PendingFile[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [isDragging, setIsDragging] = useState(false);\n\n  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files) return;\n    addFiles(Array.from(files));\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  }, [maxNumberOfFiles, maxFileSize, allowedFileTypes]);\n\n  const addFiles = useCallback((files: File[]) => {\n    const currentCount = pendingFiles.length;\n    const availableSlots = maxNumberOfFiles - currentCount;\n    \n    if (availableSlots <= 0) {\n      toast.error(`Maximum of ${maxNumberOfFiles} files allowed`);\n      return;\n    }\n\n    const filesToAdd = files.slice(0, availableSlots);\n    const newPendingFiles: PendingFile[] = [];\n\n    for (const file of filesToAdd) {\n      if (file.size > maxFileSize) {\n        toast.error(`${file.name} exceeds ${formatFileSize(maxFileSize)} limit`);\n        continue;\n      }\n\n      if (allowedFileTypes && allowedFileTypes.length > 0) {\n        const isAllowed = allowedFileTypes.some(type => {\n          if (type.includes('/*')) {\n            return file.type.startsWith(type.replace('/*', ''));\n          }\n          return file.type === type || file.name.toLowerCase().endsWith(type.replace('.', '').toLowerCase());\n        });\n        if (!isAllowed) {\n          toast.error(`${file.name} is not an allowed file type`);\n          continue;\n        }\n      }\n\n      newPendingFiles.push({\n        id: crypto.randomUUID(),\n        file,\n        progress: 0,\n        status: 'pending',\n      });\n    }\n\n    if (newPendingFiles.length > 0) {\n      setPendingFiles(prev => [...prev, ...newPendingFiles]);\n    }\n  }, [pendingFiles.length, maxNumberOfFiles, maxFileSize, allowedFileTypes]);\n\n  const removeFile = useCallback((id: string) => {\n    setPendingFiles(prev => prev.filter(f => f.id !== id));\n  }, []);\n\n  const getUploadErrorMessage = (status: number, defaultMessage: string): string => {\n    switch (status) {\n      case 401:\n        return \"Your session has expired. Please log in again to upload files.\";\n      case 403:\n        return \"You don't have permission to upload files. Please contact an administrator.\";\n      case 413:\n        return \"The file is too large. Please try a smaller file.\";\n      case 500:\n      case 502:\n      case 503:\n        return \"The server is temporarily unavailable. Please try again in a moment.\";\n      default:\n        return defaultMessage;\n    }\n  };\n\n  const isRetryableError = (status: number): boolean => {\n    return status === 408 || status === 429 || status >= 500;\n  };\n\n  const uploadFileWithRetry = async (\n    pendingFile: PendingFile, \n    maxRetries: number = 3\n  ): Promise<{ uploadURL: string; objectPath: string } | null> => {\n    let lastError: Error | null = null;\n    \n    for (let attempt = 0; attempt < maxRetries; attempt++) {\n      try {\n        if (attempt > 0) {\n          setPendingFiles(prev => prev.map(f => \n            f.id === pendingFile.id ? { ...f, progress: attempt * 10, error: undefined } : f\n          ));\n        }\n\n        const urlResponse = await fetch('/api/objects/upload', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ filename: pendingFile.file.name }),\n        });\n\n        if (urlResponse.ok) {\n          return await urlResponse.json();\n        }\n\n        if (urlResponse.status === 401) {\n          triggerSessionExpired();\n          throw new NonRetryableError(\"Your session has expired. Please log in again.\");\n        }\n\n        const errorMessage = getUploadErrorMessage(urlResponse.status, 'Failed to prepare upload');\n        \n        if (!isRetryableError(urlResponse.status)) {\n          throw new NonRetryableError(errorMessage);\n        }\n\n        lastError = new Error(errorMessage);\n      } catch (error: any) {\n        if (error instanceof NonRetryableError) {\n          throw error;\n        }\n        \n        lastError = error;\n      }\n      \n      if (attempt < maxRetries - 1) {\n        const waitTime = Math.pow(2, attempt) * 1000;\n        toast.info(`Retrying upload... (attempt ${attempt + 2}/${maxRetries})`, {\n          duration: waitTime - 200,\n          id: `retry-${pendingFile.id}`,\n        });\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n      }\n    }\n    \n    throw lastError || new Error(\"Failed to upload after multiple attempts. Please try again.\");\n  };\n\n  const uploadWithFallback = async (pendingFile: PendingFile): Promise<UploadedFile | null> => {\n    const formData = new FormData();\n    formData.append('file', pendingFile.file);\n\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest();\n      \n      xhr.upload.addEventListener('progress', (e) => {\n        if (e.lengthComputable) {\n          const progress = Math.round((e.loaded / e.total) * 100);\n          setPendingFiles(prev => prev.map(f => \n            f.id === pendingFile.id ? { ...f, progress, status: 'uploading', error: undefined } : f\n          ));\n        }\n      });\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          try {\n            const result = JSON.parse(xhr.responseText);\n            const objectPath = `/uploads/${result.filename}`;\n            \n            setPendingFiles(prev => prev.map(f => \n              f.id === pendingFile.id ? { ...f, progress: 100, status: 'success', objectPath, error: undefined } : f\n            ));\n\n            resolve({\n              id: pendingFile.id,\n              filename: pendingFile.file.name,\n              objectPath,\n              size: pendingFile.file.size,\n              type: pendingFile.file.type,\n            });\n          } catch {\n            reject(new Error('Failed to parse upload response'));\n          }\n        } else if (xhr.status === 401) {\n          triggerSessionExpired();\n          reject(new Error(\"Your session has expired. Please log in again.\"));\n        } else {\n          reject(new Error(getUploadErrorMessage(xhr.status, `Upload failed (${xhr.status})`)));\n        }\n      });\n\n      xhr.addEventListener('error', () => {\n        reject(new Error('Network error. Please check your internet connection and try again.'));\n      });\n\n      xhr.addEventListener('timeout', () => {\n        reject(new Error('Upload timed out. Please try again with a stable connection.'));\n      });\n\n      xhr.timeout = 300000;\n      xhr.open('POST', '/api/upload');\n      xhr.send(formData);\n    });\n  };\n\n  const uploadFile = async (pendingFile: PendingFile): Promise<UploadedFile | null> => {\n    try {\n      let result: { uploadURL: string; objectPath: string } | null = null;\n      let useObjectStorage = true;\n\n      try {\n        result = await uploadFileWithRetry(pendingFile);\n      } catch (error: any) {\n        if (error.message?.includes('temporarily unavailable') || \n            error.message?.includes('500') ||\n            error.message?.includes('Failed to sign object URL')) {\n          console.log('Object storage unavailable, falling back to base64 upload');\n          useObjectStorage = false;\n        } else {\n          throw error;\n        }\n      }\n      \n      if (!useObjectStorage || !result) {\n        return await uploadWithFallback(pendingFile);\n      }\n      \n      const { uploadURL, objectPath } = result;\n\n      await new Promise<void>((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        \n        xhr.upload.addEventListener('progress', (e) => {\n          if (e.lengthComputable) {\n            const progress = Math.round((e.loaded / e.total) * 100);\n            setPendingFiles(prev => prev.map(f => \n              f.id === pendingFile.id ? { ...f, progress, status: 'uploading', error: undefined } : f\n            ));\n          }\n        });\n\n        xhr.addEventListener('load', () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            resolve();\n          } else {\n            reject(new Error(getUploadErrorMessage(xhr.status, `Upload failed (${xhr.status})`)));\n          }\n        });\n\n        xhr.addEventListener('error', () => {\n          reject(new Error('Network error. Please check your internet connection and try again.'));\n        });\n\n        xhr.addEventListener('timeout', () => {\n          reject(new Error('Upload timed out. Please try again with a stable connection.'));\n        });\n\n        xhr.timeout = 300000;\n        xhr.open('PUT', uploadURL);\n        xhr.setRequestHeader('Content-Type', pendingFile.file.type || 'application/octet-stream');\n        xhr.send(pendingFile.file);\n      });\n\n      const confirmResponse = await fetch('/api/objects/confirm', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          objectPath,\n          filename: pendingFile.file.name,\n          size: pendingFile.file.size,\n          type: pendingFile.file.type,\n        }),\n      });\n\n      if (!confirmResponse.ok) {\n        if (confirmResponse.status === 401) {\n          triggerSessionExpired();\n          throw new Error(\"Your session has expired. Please log in again.\");\n        }\n        throw new Error(getUploadErrorMessage(confirmResponse.status, 'Failed to complete upload'));\n      }\n\n      setPendingFiles(prev => prev.map(f => \n        f.id === pendingFile.id ? { ...f, progress: 100, status: 'success', objectPath, error: undefined } : f\n      ));\n\n      return {\n        id: pendingFile.id,\n        filename: pendingFile.file.name,\n        objectPath,\n        size: pendingFile.file.size,\n        type: pendingFile.file.type,\n      };\n    } catch (error: any) {\n      const errorMessage = error.message || 'Upload failed. Please try again.';\n      setPendingFiles(prev => prev.map(f => \n        f.id === pendingFile.id ? { ...f, status: 'error', error: errorMessage } : f\n      ));\n      return null;\n    }\n  };\n\n  const handleUpload = async () => {\n    const filesToUpload = pendingFiles.filter(f => f.status === 'pending' || f.status === 'error');\n    if (filesToUpload.length === 0) {\n      toast.error('No files to upload');\n      return;\n    }\n\n    setIsUploading(true);\n    const uploadedFiles: UploadedFile[] = [];\n\n    for (const file of filesToUpload) {\n      setPendingFiles(prev => prev.map(f => \n        f.id === file.id ? { ...f, status: 'uploading', progress: 0, error: undefined } : f\n      ));\n\n      const result = await uploadFile(file);\n      if (result) {\n        uploadedFiles.push(result);\n      }\n    }\n\n    setIsUploading(false);\n\n    const errorCount = pendingFiles.filter(f => f.status === 'error').length;\n    \n    if (uploadedFiles.length > 0) {\n      onComplete?.(uploadedFiles);\n      if (errorCount > 0) {\n        toast.success(`${uploadedFiles.length} file(s) uploaded. ${errorCount} failed - you can retry them.`);\n      } else {\n        toast.success(`${uploadedFiles.length} file(s) uploaded successfully`);\n        setTimeout(() => {\n          setShowModal(false);\n          setPendingFiles([]);\n        }, 1000);\n      }\n    } else {\n      toast.error('Upload failed. Please check the errors and try again.');\n      onError?.(new Error('All uploads failed'));\n    }\n  };\n\n  const retryFailedFile = async (fileId: string) => {\n    const file = pendingFiles.find(f => f.id === fileId);\n    if (!file || file.status !== 'error') return;\n\n    setIsUploading(true);\n    setPendingFiles(prev => prev.map(f => \n      f.id === fileId ? { ...f, status: 'uploading', progress: 0, error: undefined } : f\n    ));\n\n    const result = await uploadFile(file);\n    setIsUploading(false);\n\n    if (result) {\n      onComplete?.([result]);\n      toast.success(`${file.file.name} uploaded successfully`);\n    }\n  };\n\n  const retryAllFailed = async () => {\n    const failedFiles = pendingFiles.filter(f => f.status === 'error');\n    if (failedFiles.length === 0) return;\n\n    setIsUploading(true);\n    const uploadedFiles: UploadedFile[] = [];\n\n    for (const file of failedFiles) {\n      setPendingFiles(prev => prev.map(f => \n        f.id === file.id ? { ...f, status: 'uploading', progress: 0, error: undefined } : f\n      ));\n\n      const result = await uploadFile(file);\n      if (result) {\n        uploadedFiles.push(result);\n      }\n    }\n\n    setIsUploading(false);\n\n    if (uploadedFiles.length > 0) {\n      onComplete?.(uploadedFiles);\n      toast.success(`${uploadedFiles.length} file(s) uploaded on retry`);\n    }\n  };\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    \n    const files = Array.from(e.dataTransfer.files);\n    if (files.length > 0) {\n      addFiles(files);\n    }\n  }, [addFiles]);\n\n  const handleClose = () => {\n    if (!isUploading) {\n      setShowModal(false);\n      setPendingFiles([]);\n    }\n  };\n\n  const pendingCount = pendingFiles.filter(f => f.status === 'pending').length;\n  const uploadingCount = pendingFiles.filter(f => f.status === 'uploading').length;\n  const successCount = pendingFiles.filter(f => f.status === 'success').length;\n  const errorCount = pendingFiles.filter(f => f.status === 'error').length;\n\n  return (\n    <>\n      <Button \n        onClick={() => setShowModal(true)} \n        className={buttonClassName}\n        variant={buttonVariant}\n        size={buttonSize}\n        disabled={disabled}\n        type=\"button\"\n        data-testid=\"button-object-upload\"\n      >\n        {children}\n      </Button>\n\n      <Dialog open={showModal} onOpenChange={handleClose}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Upload Files</DialogTitle>\n            <DialogDescription>\n              Upload files up to {formatFileSize(maxFileSize)} each. Maximum {maxNumberOfFiles} files.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div\n            className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${\n              isDragging ? 'border-primary bg-primary/5' : 'border-muted-foreground/25'\n            }`}\n            onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}\n            onDragLeave={(e) => { e.preventDefault(); setIsDragging(false); }}\n            onDrop={handleDrop}\n          >\n            <Upload className=\"mx-auto h-10 w-10 text-muted-foreground mb-4\" />\n            <p className=\"text-sm text-muted-foreground mb-2\">\n              Drag and drop files here, or click to browse\n            </p>\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              multiple\n              accept={accept}\n              onChange={handleFileSelect}\n              className=\"hidden\"\n              data-testid=\"input-file-upload\"\n            />\n            <Button \n              type=\"button\" \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => fileInputRef.current?.click()}\n              disabled={isUploading || pendingFiles.length >= maxNumberOfFiles}\n              data-testid=\"button-browse-files\"\n            >\n              Browse Files\n            </Button>\n          </div>\n\n          {pendingFiles.length > 0 && (\n            <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n              {pendingFiles.map((pf) => (\n                <div \n                  key={pf.id} \n                  className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg\"\n                  data-testid={`file-item-${pf.id}`}\n                >\n                  <div className=\"flex-shrink-0\">\n                    {pf.status === 'success' ? (\n                      <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                    ) : pf.status === 'error' ? (\n                      <AlertCircle className=\"h-5 w-5 text-destructive\" />\n                    ) : pf.status === 'uploading' ? (\n                      <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n                    ) : (\n                      <FileIcon className=\"h-5 w-5 text-muted-foreground\" />\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-medium truncate\">{pf.file.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatFileSize(pf.file.size)}</p>\n                    {pf.status === 'uploading' && (\n                      <Progress value={pf.progress} className=\"h-1 mt-1\" />\n                    )}\n                    {pf.status === 'error' && (\n                      <p className=\"text-xs text-destructive mt-1\">{pf.error}</p>\n                    )}\n                  </div>\n                  {pf.status === 'pending' && !isUploading && (\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-8 w-8 flex-shrink-0\"\n                      onClick={() => removeFile(pf.id)}\n                      data-testid={`button-remove-file-${pf.id}`}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                  {pf.status === 'error' && !isUploading && (\n                    <div className=\"flex gap-1 flex-shrink-0\">\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-8 w-8\"\n                        onClick={() => retryFailedFile(pf.id)}\n                        title=\"Retry upload\"\n                        data-testid={`button-retry-file-${pf.id}`}\n                      >\n                        <RefreshCw className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-8 w-8\"\n                        onClick={() => removeFile(pf.id)}\n                        data-testid={`button-remove-failed-file-${pf.id}`}\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n\n          <div className=\"flex justify-between items-center pt-4\">\n            <div className=\"text-sm text-muted-foreground\">\n              {pendingFiles.length} file(s) selected\n              {successCount > 0 && `  ${successCount} uploaded`}\n              {errorCount > 0 && <span className=\"text-destructive\">  {errorCount} failed</span>}\n            </div>\n            <div className=\"flex gap-2\">\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={handleClose}\n                disabled={isUploading}\n                data-testid=\"button-cancel-upload\"\n              >\n                {successCount > 0 && pendingCount === 0 && errorCount === 0 ? 'Done' : 'Cancel'}\n              </Button>\n              {errorCount > 0 && !isUploading && (\n                <Button \n                  type=\"button\"\n                  variant=\"secondary\"\n                  onClick={retryAllFailed}\n                  disabled={isUploading}\n                  data-testid=\"button-retry-all-failed\"\n                >\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\n                  Retry {errorCount} Failed\n                </Button>\n              )}\n              {pendingCount > 0 && (\n                <Button \n                  type=\"button\"\n                  onClick={handleUpload}\n                  disabled={isUploading || pendingCount === 0}\n                  data-testid=\"button-start-upload\"\n                >\n                  {isUploading ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Uploading...\n                    </>\n                  ) : (\n                    <>\n                      <Upload className=\"h-4 w-4 mr-2\" />\n                      Upload {pendingCount} File{pendingCount > 1 ? 's' : ''}\n                    </>\n                  )}\n                </Button>\n              )}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\nexport type { UploadedFile };\n","path":null,"size_bytes":22443,"size_tokens":null},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n    return null;\n  }\n\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      const contentType = metadata.contentType || \"application/octet-stream\";\n      \n      const inlineTypesExact = [\n        'application/pdf',\n        'application/json',\n      ];\n      const inlinePrefixes = [\n        'image/',\n        'video/',\n        'audio/',\n        'text/',\n      ];\n      \n      const isInlineType = inlineTypesExact.includes(contentType) || inlinePrefixes.some(prefix => contentType.startsWith(prefix));\n      const disposition = isInlineType ? 'inline' : 'attachment';\n      const filename = file.name.split('/').pop() || 'file';\n      \n      res.set({\n        \"Content-Type\": contentType,\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${isPublic ? \"public\" : \"private\"}, max-age=${cacheTtlSec}`,\n        \"Content-Disposition\": `${disposition}; filename=\"${encodeURIComponent(filename)}\"`,\n      });\n      const stream = file.createReadStream();\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityUploadURL(originalFilename?: string): Promise<{ uploadURL: string; objectPath: string }> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const extension = originalFilename ? `.${originalFilename.split('.').pop()}` : '';\n    const fullPath = `${privateObjectDir}/uploads/${objectId}${extension}`;\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    const uploadURL = await signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 3600,\n    });\n\n    return {\n      uploadURL,\n      objectPath: `/objects/uploads/${objectId}${extension}`,\n    };\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n\n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n\n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/\")) {\n      return normalizedPath;\n    }\n\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  async canAccessObjectEntity({\n    userId,\n    objectFile,\n    requestedPermission,\n  }: {\n    userId?: string;\n    objectFile: File;\n    requestedPermission?: ObjectPermission;\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n    });\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n","path":null,"size_bytes":8283,"size_tokens":null},"server/objectAcl.ts":{"content":"import { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\nexport enum ObjectAccessGroupType {}\n\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string;\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\nexport interface ObjectAclPolicy {\n  owner: string;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n  return granted === ObjectPermission.WRITE;\n}\n\nabstract class BaseObjectAccessGroup implements ObjectAccessGroup {\n  constructor(\n    public readonly type: ObjectAccessGroupType,\n    public readonly id: string,\n  ) {}\n\n  public abstract hasMember(userId: string): Promise<boolean>;\n}\n\nfunction createObjectAccessGroup(\n  group: ObjectAccessGroup,\n): BaseObjectAccessGroup {\n  switch (group.type) {\n    default:\n      throw new Error(`Unknown access group type: ${group.type}`);\n  }\n}\n\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  if (!userId) {\n    return false;\n  }\n\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  for (const rule of aclPolicy.aclRules || []) {\n    const accessGroup = createObjectAccessGroup(rule.group);\n    if (\n      (await accessGroup.hasMember(userId)) &&\n      isPermissionAllowed(requestedPermission, rule.permission)\n    ) {\n      return true;\n    }\n  }\n\n  return false;\n}\n","path":null,"size_bytes":2707,"size_tokens":null},"client/src/pages/shared/PersonalityQuestionnaire.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { usePersonalityProfile, useSavePersonalityProfile } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { toast } from \"sonner\";\nimport { CheckCircle, ChevronLeft, ChevronRight, Loader2, Pencil, ArrowRight } from \"lucide-react\";\n\ninterface Props {\n  role: \"CEO\" | \"Employee\";\n}\n\nconst STEPS = [\n  { id: \"work-style\", title: \"Work Style\" },\n  { id: \"communication\", title: \"Communication\" },\n  { id: \"decision-making\", title: \"Decision Making\" },\n  { id: \"strengths\", title: \"Strengths\" },\n  { id: \"preferences\", title: \"Preferences\" },\n  { id: \"availability\", title: \"Availability\" },\n];\n\nconst DEAL_TYPES = [\"M&A\", \"Capital Raising\", \"Asset Management\"];\nconst SECTORS = [\n  \"Technology\", \"Healthcare\", \"Financial Services\", \"Consumer\", \n  \"Industrial\", \"Energy\", \"Real Estate\", \"Media & Entertainment\"\n];\nconst STRENGTHS = [\n  \"Financial Modeling\", \"Due Diligence\", \"Negotiation\", \"Client Relations\",\n  \"Research & Analysis\", \"Presentations\", \"Project Management\", \"Legal/Compliance\"\n];\n\nconst getDefaultAnswers = () => ({\n  workStyle: \"\",\n  communicationStyle: \"\",\n  riskTolerance: \"\",\n  decisionMaking: \"\",\n  strengths: [] as string[],\n  preferredDealTypes: [] as string[],\n  preferredSectors: [] as string[],\n  experienceLevel: \"\",\n  leadershipStyle: \"\",\n  workloadCapacity: 5,\n  availability: \"full-time\",\n  timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n});\n\nexport default function PersonalityQuestionnaire({ role }: Props) {\n  const [, setLocation] = useLocation();\n  const { data: existingProfile, isLoading } = usePersonalityProfile();\n  const saveProfile = useSavePersonalityProfile();\n  \n  const [currentStep, setCurrentStep] = useState(0);\n  const [isEditing, setIsEditing] = useState(false);\n  const [justCompleted, setJustCompleted] = useState(false);\n  const [answers, setAnswers] = useState<Record<string, any>>(getDefaultAnswers());\n  \n  useEffect(() => {\n    if (existingProfile) {\n      setAnswers({\n        workStyle: existingProfile.workStyle || \"\",\n        communicationStyle: existingProfile.communicationStyle || \"\",\n        riskTolerance: existingProfile.riskTolerance || \"\",\n        decisionMaking: existingProfile.decisionMaking || \"\",\n        strengths: existingProfile.strengths || [],\n        preferredDealTypes: existingProfile.preferredDealTypes || [],\n        preferredSectors: existingProfile.preferredSectors || [],\n        experienceLevel: existingProfile.experienceLevel || \"\",\n        leadershipStyle: existingProfile.leadershipStyle || \"\",\n        workloadCapacity: existingProfile.workloadCapacity || 5,\n        availability: existingProfile.availability || \"full-time\",\n        timezone: existingProfile.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,\n      });\n    }\n  }, [existingProfile]);\n\n  const progress = ((currentStep + 1) / STEPS.length) * 100;\n\n  const updateAnswer = (key: string, value: any) => {\n    setAnswers(prev => ({ ...prev, [key]: value }));\n  };\n\n  const toggleArrayValue = (key: string, value: string) => {\n    setAnswers(prev => {\n      const arr = prev[key] || [];\n      if (arr.includes(value)) {\n        return { ...prev, [key]: arr.filter((v: string) => v !== value) };\n      }\n      return { ...prev, [key]: [...arr, value] };\n    });\n  };\n\n  const handleSubmit = async () => {\n    try {\n      await saveProfile.mutateAsync({\n        ...answers,\n        rawResponses: answers,\n      });\n      toast.success(\"Profile saved successfully!\");\n      setIsEditing(false);\n      setJustCompleted(true);\n    } catch (error) {\n      toast.error(\"Failed to save profile\");\n    }\n  };\n  \n  const goToDashboard = () => {\n    if (role === \"CEO\") {\n      setLocation(\"/ceo/dashboard\");\n    } else {\n      setLocation(\"/employee/home\");\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if ((existingProfile?.completedAt || justCompleted) && !isEditing) {\n    return (\n      <div className=\"container max-w-2xl mx-auto py-12 px-4\" data-testid=\"questionnaire-completed\">\n        <Card>\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto mb-4 h-16 w-16 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center\">\n              <CheckCircle className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n            </div>\n            <CardTitle>{justCompleted ? \"Welcome to Kronos!\" : \"Profile Complete\"}</CardTitle>\n            <CardDescription>\n              {justCompleted \n                ? \"Your profile has been saved. You're all set to start working on deals!\"\n                : \"Your personality profile has been saved and will be used for optimal team matching.\"\n              }\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid gap-2 text-sm\">\n              <div className=\"flex justify-between py-2 border-b\">\n                <span className=\"text-muted-foreground\">Work Style</span>\n                <span className=\"font-medium capitalize\">{answers.workStyle || existingProfile?.workStyle}</span>\n              </div>\n              <div className=\"flex justify-between py-2 border-b\">\n                <span className=\"text-muted-foreground\">Communication Style</span>\n                <span className=\"font-medium capitalize\">{answers.communicationStyle || existingProfile?.communicationStyle}</span>\n              </div>\n              <div className=\"flex justify-between py-2 border-b\">\n                <span className=\"text-muted-foreground\">Experience Level</span>\n                <span className=\"font-medium capitalize\">{answers.experienceLevel || existingProfile?.experienceLevel}</span>\n              </div>\n              <div className=\"flex justify-between py-2 border-b\">\n                <span className=\"text-muted-foreground\">Preferred Deal Types</span>\n                <span className=\"font-medium\">{(answers.preferredDealTypes?.length > 0 ? answers.preferredDealTypes : existingProfile?.preferredDealTypes)?.join(\", \") || \"Not set\"}</span>\n              </div>\n              <div className=\"flex justify-between py-2\">\n                <span className=\"text-muted-foreground\">Key Strengths</span>\n                <span className=\"font-medium\">{(answers.strengths?.length > 0 ? answers.strengths : existingProfile?.strengths)?.slice(0, 3).join(\", \") || \"Not set\"}</span>\n              </div>\n            </div>\n            {justCompleted ? (\n              <Button \n                onClick={goToDashboard}\n                className=\"w-full\"\n                data-testid=\"button-go-to-dashboard\"\n              >\n                Go to Dashboard <ArrowRight className=\"h-4 w-4 ml-2\" />\n              </Button>\n            ) : (\n              <Button \n                onClick={() => {\n                  setCurrentStep(0);\n                  setIsEditing(true);\n                }} \n                variant=\"outline\" \n                className=\"w-full\"\n                data-testid=\"button-update-profile\"\n              >\n                <Pencil className=\"h-4 w-4 mr-2\" /> Update Profile\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-2xl mx-auto py-12 px-4\" data-testid=\"questionnaire-form\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold mb-2\">Personality & Work Profile</h1>\n        <p className=\"text-muted-foreground\">\n          Complete this questionnaire to help us match you with optimal deal teams.\n        </p>\n      </div>\n\n      <div className=\"mb-6\">\n        <div className=\"flex justify-between text-sm mb-2\">\n          <span>Step {currentStep + 1} of {STEPS.length}</span>\n          <span className=\"text-muted-foreground\">{STEPS[currentStep].title}</span>\n        </div>\n        <Progress value={progress} className=\"h-2\" />\n      </div>\n\n      <Card>\n        <CardContent className=\"pt-6\">\n          {currentStep === 0 && (\n            <div className=\"space-y-6\" data-testid=\"step-work-style\">\n              <div className=\"space-y-3\">\n                <Label>How do you prefer to work?</Label>\n                <RadioGroup \n                  value={answers.workStyle} \n                  onValueChange={(v) => updateAnswer(\"workStyle\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"independent\" id=\"ws-independent\" data-testid=\"radio-work-independent\" />\n                    <Label htmlFor=\"ws-independent\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Independent</div>\n                      <div className=\"text-sm text-muted-foreground\">I work best alone with clear objectives</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"collaborative\" id=\"ws-collaborative\" data-testid=\"radio-work-collaborative\" />\n                    <Label htmlFor=\"ws-collaborative\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Collaborative</div>\n                      <div className=\"text-sm text-muted-foreground\">I thrive when working closely with others</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"flexible\" id=\"ws-flexible\" data-testid=\"radio-work-flexible\" />\n                    <Label htmlFor=\"ws-flexible\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Flexible</div>\n                      <div className=\"text-sm text-muted-foreground\">I adapt my style based on the task</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n            </div>\n          )}\n\n          {currentStep === 1 && (\n            <div className=\"space-y-6\" data-testid=\"step-communication\">\n              <div className=\"space-y-3\">\n                <Label>What is your preferred communication style?</Label>\n                <RadioGroup \n                  value={answers.communicationStyle} \n                  onValueChange={(v) => updateAnswer(\"communicationStyle\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"direct\" id=\"cs-direct\" data-testid=\"radio-comm-direct\" />\n                    <Label htmlFor=\"cs-direct\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Direct</div>\n                      <div className=\"text-sm text-muted-foreground\">Straightforward and to the point</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"diplomatic\" id=\"cs-diplomatic\" data-testid=\"radio-comm-diplomatic\" />\n                    <Label htmlFor=\"cs-diplomatic\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Diplomatic</div>\n                      <div className=\"text-sm text-muted-foreground\">Tactful and considerate of others</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"analytical\" id=\"cs-analytical\" data-testid=\"radio-comm-analytical\" />\n                    <Label htmlFor=\"cs-analytical\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Analytical</div>\n                      <div className=\"text-sm text-muted-foreground\">Data-driven with supporting evidence</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n            </div>\n          )}\n\n          {currentStep === 2 && (\n            <div className=\"space-y-6\" data-testid=\"step-decision-making\">\n              <div className=\"space-y-3\">\n                <Label>How do you approach risk?</Label>\n                <RadioGroup \n                  value={answers.riskTolerance} \n                  onValueChange={(v) => updateAnswer(\"riskTolerance\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"conservative\" id=\"rt-conservative\" data-testid=\"radio-risk-conservative\" />\n                    <Label htmlFor=\"rt-conservative\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Conservative</div>\n                      <div className=\"text-sm text-muted-foreground\">Prefer proven approaches with minimal risk</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"moderate\" id=\"rt-moderate\" data-testid=\"radio-risk-moderate\" />\n                    <Label htmlFor=\"rt-moderate\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Moderate</div>\n                      <div className=\"text-sm text-muted-foreground\">Balanced approach to calculated risks</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"aggressive\" id=\"rt-aggressive\" data-testid=\"radio-risk-aggressive\" />\n                    <Label htmlFor=\"rt-aggressive\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Aggressive</div>\n                      <div className=\"text-sm text-muted-foreground\">Comfortable with higher risk for higher reward</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n              <div className=\"space-y-3\">\n                <Label>How do you make decisions?</Label>\n                <RadioGroup \n                  value={answers.decisionMaking} \n                  onValueChange={(v) => updateAnswer(\"decisionMaking\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"intuitive\" id=\"dm-intuitive\" data-testid=\"radio-decision-intuitive\" />\n                    <Label htmlFor=\"dm-intuitive\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Intuitive</div>\n                      <div className=\"text-sm text-muted-foreground\">Trust experience and gut feeling</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"analytical\" id=\"dm-analytical\" data-testid=\"radio-decision-analytical\" />\n                    <Label htmlFor=\"dm-analytical\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Analytical</div>\n                      <div className=\"text-sm text-muted-foreground\">Data-driven with thorough analysis</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"consensus\" id=\"dm-consensus\" data-testid=\"radio-decision-consensus\" />\n                    <Label htmlFor=\"dm-consensus\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Consensus-Based</div>\n                      <div className=\"text-sm text-muted-foreground\">Gather input before deciding</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n            </div>\n          )}\n\n          {currentStep === 3 && (\n            <div className=\"space-y-6\" data-testid=\"step-strengths\">\n              <div className=\"space-y-3\">\n                <Label>Select your key strengths (choose up to 4)</Label>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {STRENGTHS.map((strength) => (\n                    <div\n                      key={strength}\n                      className={`flex items-center space-x-2 p-3 border rounded-lg cursor-pointer transition-colors ${\n                        answers.strengths?.includes(strength) ? \"bg-primary/10 border-primary\" : \"hover:bg-accent\"\n                      }`}\n                      onClick={() => {\n                        if (answers.strengths?.length < 4 || answers.strengths?.includes(strength)) {\n                          toggleArrayValue(\"strengths\", strength);\n                        }\n                      }}\n                    >\n                      <Checkbox \n                        checked={answers.strengths?.includes(strength)} \n                        data-testid={`checkbox-strength-${strength.toLowerCase().replace(/[^a-z]/g, '-')}`}\n                      />\n                      <span className=\"text-sm\">{strength}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n              <div className=\"space-y-3\">\n                <Label>What is your experience level?</Label>\n                <RadioGroup \n                  value={answers.experienceLevel} \n                  onValueChange={(v) => updateAnswer(\"experienceLevel\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"junior\" id=\"exp-junior\" data-testid=\"radio-exp-junior\" />\n                    <Label htmlFor=\"exp-junior\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Junior (0-2 years)</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"mid\" id=\"exp-mid\" data-testid=\"radio-exp-mid\" />\n                    <Label htmlFor=\"exp-mid\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Mid-Level (2-5 years)</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"senior\" id=\"exp-senior\" data-testid=\"radio-exp-senior\" />\n                    <Label htmlFor=\"exp-senior\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Senior (5+ years)</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n            </div>\n          )}\n\n          {currentStep === 4 && (\n            <div className=\"space-y-6\" data-testid=\"step-preferences\">\n              <div className=\"space-y-3\">\n                <Label>Preferred deal types (select all that apply)</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {DEAL_TYPES.map((type) => (\n                    <div\n                      key={type}\n                      className={`px-4 py-2 border rounded-full cursor-pointer transition-colors ${\n                        answers.preferredDealTypes?.includes(type) \n                          ? \"bg-primary text-primary-foreground\" \n                          : \"hover:bg-accent\"\n                      }`}\n                      onClick={() => toggleArrayValue(\"preferredDealTypes\", type)}\n                      data-testid={`chip-deal-type-${type.toLowerCase().replace(/[^a-z]/g, '-')}`}\n                    >\n                      {type}\n                    </div>\n                  ))}\n                </div>\n              </div>\n              <div className=\"space-y-3\">\n                <Label>Preferred sectors (select all that apply)</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {SECTORS.map((sector) => (\n                    <div\n                      key={sector}\n                      className={`px-4 py-2 border rounded-full cursor-pointer transition-colors ${\n                        answers.preferredSectors?.includes(sector) \n                          ? \"bg-primary text-primary-foreground\" \n                          : \"hover:bg-accent\"\n                      }`}\n                      onClick={() => toggleArrayValue(\"preferredSectors\", sector)}\n                      data-testid={`chip-sector-${sector.toLowerCase().replace(/[^a-z]/g, '-')}`}\n                    >\n                      {sector}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {currentStep === 5 && (\n            <div className=\"space-y-6\" data-testid=\"step-availability\">\n              <div className=\"space-y-3\">\n                <Label>What is your current availability?</Label>\n                <RadioGroup \n                  value={answers.availability} \n                  onValueChange={(v) => updateAnswer(\"availability\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"full-time\" id=\"av-full\" data-testid=\"radio-avail-full\" />\n                    <Label htmlFor=\"av-full\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Full-Time</div>\n                      <div className=\"text-sm text-muted-foreground\">Available for any deal assignment</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"part-time\" id=\"av-part\" data-testid=\"radio-avail-part\" />\n                    <Label htmlFor=\"av-part\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Part-Time</div>\n                      <div className=\"text-sm text-muted-foreground\">Limited availability</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"on-leave\" id=\"av-leave\" data-testid=\"radio-avail-leave\" />\n                    <Label htmlFor=\"av-leave\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">On Leave</div>\n                      <div className=\"text-sm text-muted-foreground\">Currently unavailable</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n              <div className=\"space-y-3\">\n                <Label>What is your leadership style?</Label>\n                <RadioGroup \n                  value={answers.leadershipStyle} \n                  onValueChange={(v) => updateAnswer(\"leadershipStyle\", v)}\n                >\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"hands-on\" id=\"ls-hands\" data-testid=\"radio-lead-hands\" />\n                    <Label htmlFor=\"ls-hands\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Hands-On</div>\n                      <div className=\"text-sm text-muted-foreground\">Actively involved in all details</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"delegating\" id=\"ls-deleg\" data-testid=\"radio-lead-delegating\" />\n                    <Label htmlFor=\"ls-deleg\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Delegating</div>\n                      <div className=\"text-sm text-muted-foreground\">Trust team to handle execution</div>\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 p-3 border rounded-lg hover:bg-accent\">\n                    <RadioGroupItem value=\"coaching\" id=\"ls-coach\" data-testid=\"radio-lead-coaching\" />\n                    <Label htmlFor=\"ls-coach\" className=\"flex-1 cursor-pointer\">\n                      <div className=\"font-medium\">Coaching</div>\n                      <div className=\"text-sm text-muted-foreground\">Focus on developing team members</div>\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex justify-between mt-8 pt-4 border-t\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setCurrentStep(s => s - 1)}\n              disabled={currentStep === 0}\n              data-testid=\"button-previous\"\n            >\n              <ChevronLeft className=\"h-4 w-4 mr-1\" /> Previous\n            </Button>\n            {currentStep < STEPS.length - 1 ? (\n              <Button\n                onClick={() => setCurrentStep(s => s + 1)}\n                data-testid=\"button-next\"\n              >\n                Next <ChevronRight className=\"h-4 w-4 ml-1\" />\n              </Button>\n            ) : (\n              <Button\n                onClick={handleSubmit}\n                disabled={saveProfile.isPending}\n                data-testid=\"button-submit\"\n              >\n                {saveProfile.isPending ? (\n                  <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> Saving...</>\n                ) : (\n                  \"Complete Profile\"\n                )}\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":26480,"size_tokens":null},"server/gmail.ts":{"content":"// Gmail integration for email scanning and deal extraction\n// Using connection:conn_google-mail_01KC9QQFKBJTX5TG2CGSFSZ021\n\nimport { google } from 'googleapis';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=google-mail',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('Gmail not connected');\n  }\n  return accessToken;\n}\n\nexport async function getUncachableGmailClient() {\n  const accessToken = await getAccessToken();\n\n  const oauth2Client = new google.auth.OAuth2();\n  oauth2Client.setCredentials({\n    access_token: accessToken\n  });\n\n  return google.gmail({ version: 'v1', auth: oauth2Client });\n}\n\nexport type GmailLabel = {\n  id: string;\n  name: string;\n  type: string;\n};\n\nexport type GmailMessage = {\n  id: string;\n  threadId: string;\n  labelIds: string[];\n  snippet: string;\n  payload: {\n    headers: { name: string; value: string }[];\n    parts?: {\n      mimeType: string;\n      body?: { data?: string };\n      parts?: any[];\n    }[];\n    body?: { data?: string };\n    mimeType?: string;\n  };\n  internalDate: string;\n};\n\nexport type ParsedEmail = {\n  id: string;\n  threadId: string;\n  from: string;\n  to: string;\n  subject: string;\n  date: Date;\n  body: string;\n  snippet: string;\n  attachments: { filename: string; mimeType: string; size: number }[];\n};\n\nexport async function listLabels(): Promise<GmailLabel[]> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    const response = await gmail.users.labels.list({\n      userId: 'me',\n    });\n    return (response.data.labels || []).map(label => ({\n      id: label.id || '',\n      name: label.name || '',\n      type: label.type || 'user',\n    }));\n  } catch (error) {\n    console.error('Error listing Gmail labels:', error);\n    throw error;\n  }\n}\n\nexport async function getLabelByName(labelName: string): Promise<GmailLabel | null> {\n  const labels = await listLabels();\n  return labels.find(l => l.name.toLowerCase() === labelName.toLowerCase()) || null;\n}\n\nexport async function listEmailsInLabel(labelId: string, maxResults: number = 50): Promise<{ id: string; threadId: string }[]> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    const response = await gmail.users.messages.list({\n      userId: 'me',\n      labelIds: [labelId],\n      maxResults,\n    });\n    return (response.data.messages || []).map(msg => ({\n      id: msg.id || '',\n      threadId: msg.threadId || '',\n    }));\n  } catch (error) {\n    console.error('Error listing emails:', error);\n    throw error;\n  }\n}\n\nexport async function getEmailById(messageId: string): Promise<GmailMessage | null> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    const response = await gmail.users.messages.get({\n      userId: 'me',\n      id: messageId,\n      format: 'full',\n    });\n    return response.data as GmailMessage;\n  } catch (error) {\n    console.error('Error getting email:', error);\n    return null;\n  }\n}\n\nexport async function getThreadMessages(threadId: string): Promise<GmailMessage[]> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    const response = await gmail.users.threads.get({\n      userId: 'me',\n      id: threadId,\n      format: 'full',\n    });\n    return (response.data.messages || []) as GmailMessage[];\n  } catch (error) {\n    console.error('Error getting thread:', error);\n    return [];\n  }\n}\n\nfunction decodeBase64Url(data: string): string {\n  try {\n    const base64 = data.replace(/-/g, '+').replace(/_/g, '/');\n    return Buffer.from(base64, 'base64').toString('utf-8');\n  } catch {\n    return '';\n  }\n}\n\nfunction extractEmailBody(payload: GmailMessage['payload']): string {\n  if (payload.body?.data) {\n    return decodeBase64Url(payload.body.data);\n  }\n  \n  if (payload.parts) {\n    for (const part of payload.parts) {\n      if (part.mimeType === 'text/plain' && part.body?.data) {\n        return decodeBase64Url(part.body.data);\n      }\n    }\n    for (const part of payload.parts) {\n      if (part.mimeType === 'text/html' && part.body?.data) {\n        const html = decodeBase64Url(part.body.data);\n        return html.replace(/<[^>]*>/g, '').replace(/\\s+/g, ' ').trim();\n      }\n    }\n    for (const part of payload.parts) {\n      if (part.mimeType?.startsWith('multipart/') && part.parts) {\n        for (const subpart of part.parts) {\n          if (subpart.mimeType === 'text/plain' && subpart.body?.data) {\n            return decodeBase64Url(subpart.body.data);\n          }\n        }\n      }\n    }\n  }\n  \n  return '';\n}\n\nfunction extractAttachments(payload: GmailMessage['payload']): { filename: string; mimeType: string; size: number }[] {\n  const attachments: { filename: string; mimeType: string; size: number }[] = [];\n  \n  function scanParts(parts: any[] | undefined) {\n    if (!parts) return;\n    for (const part of parts) {\n      if (part.filename && part.filename.length > 0) {\n        attachments.push({\n          filename: part.filename,\n          mimeType: part.mimeType || 'application/octet-stream',\n          size: part.body?.size || 0,\n        });\n      }\n      if (part.parts) {\n        scanParts(part.parts);\n      }\n    }\n  }\n  \n  scanParts(payload.parts);\n  return attachments;\n}\n\nexport function parseEmail(message: GmailMessage): ParsedEmail {\n  const headers = message.payload.headers;\n  const getHeader = (name: string) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';\n  \n  return {\n    id: message.id,\n    threadId: message.threadId,\n    from: getHeader('From'),\n    to: getHeader('To'),\n    subject: getHeader('Subject'),\n    date: new Date(parseInt(message.internalDate)),\n    body: extractEmailBody(message.payload),\n    snippet: message.snippet,\n    attachments: extractAttachments(message.payload),\n  };\n}\n\nexport async function scanDealFolder(folderName: string = 'Deals'): Promise<ParsedEmail[]> {\n  const label = await getLabelByName(folderName);\n  if (!label) {\n    console.log(`Label \"${folderName}\" not found`);\n    return [];\n  }\n  \n  const messageIds = await listEmailsInLabel(label.id);\n  const emails: ParsedEmail[] = [];\n  \n  for (const { id } of messageIds) {\n    const message = await getEmailById(id);\n    if (message) {\n      emails.push(parseEmail(message));\n    }\n  }\n  \n  return emails;\n}\n\nexport async function getThreadEmails(threadId: string): Promise<ParsedEmail[]> {\n  const messages = await getThreadMessages(threadId);\n  return messages.map(parseEmail);\n}\n\nexport async function addLabelToMessage(messageId: string, labelId: string): Promise<void> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    await gmail.users.messages.modify({\n      userId: 'me',\n      id: messageId,\n      requestBody: {\n        addLabelIds: [labelId],\n      },\n    });\n  } catch (error) {\n    console.error('Error adding label:', error);\n    throw error;\n  }\n}\n\nexport async function removeLabelFromMessage(messageId: string, labelId: string): Promise<void> {\n  try {\n    const gmail = await getUncachableGmailClient();\n    await gmail.users.messages.modify({\n      userId: 'me',\n      id: messageId,\n      requestBody: {\n        removeLabelIds: [labelId],\n      },\n    });\n  } catch (error) {\n    console.error('Error removing label:', error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":8166,"size_tokens":null},"server/dealAutomation.ts":{"content":"// Deal Automation Service - AI-powered deal extraction and team assignment\nimport OpenAI from \"openai\";\nimport { db } from \"./storage\";\nimport { \n  deals, \n  tasks, \n  users, \n  milestones, \n  personalityProfiles,\n  emailDeals,\n  dealAiContext,\n  aiTaskSuggestions,\n  notifications,\n  type Deal,\n  type User,\n  type Task,\n  type PersonalityProfile,\n  type InsertDeal,\n  type InsertTask,\n  type InsertMilestone,\n  type PodTeamMember\n} from \"@shared/schema\";\nimport { eq, and, ne, sql, count, desc } from \"drizzle-orm\";\nimport { scanDealFolder, getThreadEmails, type ParsedEmail } from \"./gmail\";\n\nconst openai = new OpenAI({ apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY });\n\n// Standard milestones by deal stage\nconst STAGE_MILESTONES: Record<string, { title: string; description: string }[]> = {\n  'Origination': [\n    { title: 'Initial Client Meeting', description: 'Schedule and conduct initial meeting with client to understand needs' },\n    { title: 'Preliminary Information Request', description: 'Send information request list to client' },\n    { title: 'Market Assessment', description: 'Conduct preliminary market and sector analysis' },\n    { title: 'Engagement Letter', description: 'Prepare and send engagement letter for signing' },\n  ],\n  'Structuring': [\n    { title: 'Financial Model Development', description: 'Build comprehensive financial model for the deal' },\n    { title: 'Valuation Analysis', description: 'Complete valuation analysis using multiple methodologies' },\n    { title: 'Deal Structure Proposal', description: 'Develop and present optimal deal structure' },\n    { title: 'Marketing Materials', description: 'Create teaser and CIM documents' },\n  ],\n  'Diligence': [\n    { title: 'Data Room Setup', description: 'Organize and populate virtual data room' },\n    { title: 'Due Diligence Checklist', description: 'Complete all due diligence items' },\n    { title: 'Management Presentations', description: 'Coordinate management presentation sessions' },\n    { title: 'Buyer/Investor Outreach', description: 'Contact and qualify potential buyers/investors' },\n  ],\n  'Legal': [\n    { title: 'LOI/Term Sheet', description: 'Review and negotiate letter of intent' },\n    { title: 'Legal Documentation', description: 'Coordinate preparation of definitive agreements' },\n    { title: 'Regulatory Filings', description: 'Prepare and submit required regulatory filings' },\n    { title: 'Final Negotiations', description: 'Support final negotiation sessions' },\n  ],\n  'Close': [\n    { title: 'Closing Checklist', description: 'Complete all closing requirements' },\n    { title: 'Funds Transfer', description: 'Coordinate fund flow and closing mechanics' },\n    { title: 'Post-Closing Items', description: 'Handle post-closing deliverables' },\n    { title: 'Deal Wrap-Up', description: 'Complete deal file and lessons learned' },\n  ],\n};\n\nexport type ExtractedDealInfo = {\n  name: string;\n  dealType: 'M&A' | 'Capital Raising' | 'Asset Management';\n  client: string;\n  sector: string;\n  estimatedValue: number;\n  description: string;\n  clientContactName?: string;\n  clientContactEmail?: string;\n  confidence: number;\n  relatedEmails: string[];\n};\n\nexport async function extractDealFromEmails(emails: ParsedEmail[]): Promise<ExtractedDealInfo | null> {\n  if (emails.length === 0) return null;\n\n  const emailContent = emails.map(e => \n    `From: ${e.from}\\nSubject: ${e.subject}\\nDate: ${e.date.toISOString()}\\n\\n${e.body.substring(0, 2000)}`\n  ).join('\\n\\n---\\n\\n');\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        {\n          role: 'system',\n          content: `You are an investment banking deal analyst. Extract deal information from emails.\nReturn a JSON object with these fields:\n- name: Deal name/project name (string)\n- dealType: One of \"M&A\", \"Capital Raising\", or \"Asset Management\"\n- client: Client company name (string)\n- sector: Industry sector like Technology, Healthcare, Consumer, Financial Services, Energy, Real Estate, Manufacturing, etc.\n- estimatedValue: Deal value in millions USD (number, estimate if not explicit)\n- description: Brief deal description (string)\n- clientContactName: Primary contact name if mentioned (string or null)\n- clientContactEmail: Contact email if mentioned (string or null)\n- confidence: How confident you are in the extraction, 0-100 (number)\n- isDeal: Boolean indicating if this actually appears to be a deal (vs spam/unrelated)\n\nOnly extract if the emails appear to describe an actual investment banking deal opportunity.`\n        },\n        {\n          role: 'user',\n          content: emailContent\n        }\n      ],\n      response_format: { type: 'json_object' },\n      temperature: 0.3,\n    });\n\n    const result = JSON.parse(response.choices[0].message.content || '{}');\n    \n    if (!result.isDeal || result.confidence < 50) {\n      return null;\n    }\n\n    return {\n      name: result.name || 'Unknown Deal',\n      dealType: result.dealType || 'M&A',\n      client: result.client || 'Unknown Client',\n      sector: result.sector || 'Other',\n      estimatedValue: result.estimatedValue || 0,\n      description: result.description || '',\n      clientContactName: result.clientContactName,\n      clientContactEmail: result.clientContactEmail,\n      confidence: result.confidence,\n      relatedEmails: emails.map(e => e.id),\n    };\n  } catch (error) {\n    console.error('Error extracting deal from emails:', error);\n    return null;\n  }\n}\n\nexport async function getUserWorkload(userId: string): Promise<number> {\n  const result = await db\n    .select({ count: count() })\n    .from(tasks)\n    .where(and(\n      eq(tasks.assignedTo, userId),\n      ne(tasks.status, 'Completed')\n    ));\n  return result[0]?.count || 0;\n}\n\nexport async function getActiveDealsCount(userId: string): Promise<number> {\n  const allDeals = await db.select().from(deals).where(eq(deals.status, 'Active'));\n  return allDeals.filter(d => \n    d.lead === userId || \n    (d.podTeam as PodTeamMember[])?.some(m => m.userId === userId)\n  ).length;\n}\n\nexport async function selectOptimalTeam(\n  dealInfo: ExtractedDealInfo, \n  stage: string = 'Origination'\n): Promise<{ lead: PodTeamMember; members: PodTeamMember[] }> {\n  const activeUsers = await db\n    .select()\n    .from(users)\n    .where(eq(users.status, 'active'));\n\n  const profiles = await db.select().from(personalityProfiles);\n  const profileMap = new Map(profiles.map(p => [p.userId, p]));\n\n  type UserScore = {\n    user: typeof activeUsers[0];\n    profile: typeof profiles[0] | undefined;\n    workload: number;\n    dealCount: number;\n    score: number;\n  };\n\n  const userScores: UserScore[] = [];\n\n  for (const user of activeUsers) {\n    const profile = profileMap.get(user.id);\n    const workload = await getUserWorkload(user.id);\n    const dealCount = await getActiveDealsCount(user.id);\n    \n    let score = 100;\n    \n    score -= workload * 10;\n    score -= dealCount * 15;\n    \n    if (profile) {\n      if (profile.preferredDealTypes?.includes(dealInfo.dealType)) score += 20;\n      if (profile.preferredSectors?.includes(dealInfo.sector)) score += 15;\n      \n      const capacity = profile.workloadCapacity || 5;\n      if (dealCount >= capacity) score -= 50;\n      \n      if (profile.experienceLevel === 'senior' || profile.experienceLevel === 'expert') score += 10;\n    }\n    \n    userScores.push({ user, profile, workload, dealCount, score });\n  }\n\n  userScores.sort((a, b) => b.score - a.score);\n\n  const eligibleLeads = userScores.filter(u => \n    u.profile?.experienceLevel === 'senior' || \n    u.profile?.experienceLevel === 'expert' ||\n    u.profile?.leadershipStyle\n  );\n\n  const selectedLead = eligibleLeads[0] || userScores[0];\n  \n  const teamMembers = userScores\n    .filter(u => u.user.id !== selectedLead?.user.id)\n    .slice(0, 2);\n\n  const lead: PodTeamMember = selectedLead ? {\n    userId: selectedLead.user.id,\n    name: selectedLead.user.name,\n    role: 'Lead',\n    email: selectedLead.user.email,\n    phone: selectedLead.user.phone || undefined,\n  } : { name: 'Unassigned', role: 'Lead' };\n\n  const members: PodTeamMember[] = teamMembers.map(m => ({\n    userId: m.user.id,\n    name: m.user.name,\n    role: m.profile?.experienceLevel === 'junior' ? 'Analyst' : 'Associate',\n    email: m.user.email,\n    phone: m.user.phone || undefined,\n  }));\n\n  return { lead, members };\n}\n\nexport async function createDealFromEmail(\n  extractedInfo: ExtractedDealInfo,\n  createAsOpportunity: boolean = true\n): Promise<string> {\n  const team = await selectOptimalTeam(extractedInfo);\n  \n  const dealType = createAsOpportunity ? 'Opportunity' : extractedInfo.dealType;\n  \n  const [newDeal] = await db.insert(deals).values({\n    name: extractedInfo.name,\n    dealType,\n    stage: 'Origination',\n    value: extractedInfo.estimatedValue,\n    client: extractedInfo.client,\n    sector: extractedInfo.sector,\n    lead: team.lead.name,\n    description: extractedInfo.description,\n    clientContactName: extractedInfo.clientContactName,\n    clientContactEmail: extractedInfo.clientContactEmail,\n    podTeam: [team.lead, ...team.members],\n    progress: 0,\n    status: 'Active',\n  }).returning();\n\n  return newDeal.id;\n}\n\nexport async function createMilestonesForDeal(dealId: string, stage: string = 'Origination'): Promise<void> {\n  const stageMilestones = STAGE_MILESTONES[stage] || [];\n  \n  const dueDate = new Date();\n  dueDate.setDate(dueDate.getDate() + 7);\n  \n  for (let i = 0; i < stageMilestones.length; i++) {\n    const milestone = stageMilestones[i];\n    const milestoneDue = new Date(dueDate);\n    milestoneDue.setDate(milestoneDue.getDate() + (i * 7));\n    \n    await db.insert(milestones).values({\n      dealId,\n      title: milestone.title,\n      description: milestone.description,\n      stage,\n      order: i,\n      status: 'pending',\n      dueDate: milestoneDue.toISOString().split('T')[0],\n    });\n  }\n}\n\nexport async function createTasksFromMilestone(\n  milestoneId: string,\n  dealId: string,\n  podTeam: PodTeamMember[]\n): Promise<void> {\n  const [milestone] = await db.select().from(milestones).where(eq(milestones.id, milestoneId));\n  if (!milestone) return;\n\n  const teamWithCapacity: { member: PodTeamMember; workload: number }[] = [];\n  \n  for (const member of podTeam) {\n    if (member.userId) {\n      const workload = await getUserWorkload(member.userId);\n      teamWithCapacity.push({ member, workload });\n    }\n  }\n\n  teamWithCapacity.sort((a, b) => a.workload - b.workload);\n\n  const taskTemplates = generateTaskTemplates(milestone.title, milestone.stage);\n\n  for (let i = 0; i < taskTemplates.length; i++) {\n    const template = taskTemplates[i];\n    const assignee = teamWithCapacity[i % teamWithCapacity.length];\n    \n    const dueDate = milestone.dueDate \n      ? new Date(milestone.dueDate)\n      : new Date();\n    dueDate.setDate(dueDate.getDate() - Math.floor((taskTemplates.length - i) / 2));\n\n    await db.insert(tasks).values({\n      title: template.title,\n      description: template.description,\n      dealId,\n      dealStage: milestone.stage,\n      assignedTo: assignee?.member.userId,\n      priority: template.priority as 'Low' | 'Medium' | 'High',\n      dueDate: dueDate.toISOString().split('T')[0],\n      status: 'Pending',\n      type: template.type,\n    });\n  }\n}\n\nfunction generateTaskTemplates(milestoneName: string, stage: string): { \n  title: string; \n  description: string; \n  priority: string; \n  type: string;\n}[] {\n  const templates: { title: string; description: string; priority: string; type: string; }[] = [];\n  \n  if (milestoneName.includes('Meeting')) {\n    templates.push(\n      { title: 'Schedule meeting', description: 'Coordinate calendars and send invites', priority: 'High', type: 'Coordination' },\n      { title: 'Prepare meeting agenda', description: 'Draft agenda and key discussion points', priority: 'Medium', type: 'Documentation' },\n      { title: 'Send meeting materials', description: 'Distribute pre-read materials to participants', priority: 'Medium', type: 'Communication' },\n    );\n  } else if (milestoneName.includes('Financial Model') || milestoneName.includes('Valuation')) {\n    templates.push(\n      { title: 'Gather financial data', description: 'Collect historical financials and projections', priority: 'High', type: 'Analysis' },\n      { title: 'Build model structure', description: 'Create model framework and assumptions', priority: 'High', type: 'Analysis' },\n      { title: 'Run sensitivity analysis', description: 'Test key assumptions and scenarios', priority: 'Medium', type: 'Analysis' },\n      { title: 'Quality check model', description: 'Review formulas and cross-check calculations', priority: 'High', type: 'Review' },\n    );\n  } else if (milestoneName.includes('Document') || milestoneName.includes('Materials')) {\n    templates.push(\n      { title: 'Draft initial content', description: 'Create first draft of document', priority: 'High', type: 'Documentation' },\n      { title: 'Internal review', description: 'Circulate for team feedback', priority: 'Medium', type: 'Review' },\n      { title: 'Incorporate feedback', description: 'Address comments and revise', priority: 'Medium', type: 'Documentation' },\n      { title: 'Final formatting', description: 'Polish layout and design', priority: 'Low', type: 'Documentation' },\n    );\n  } else if (milestoneName.includes('Due Diligence') || milestoneName.includes('Diligence')) {\n    templates.push(\n      { title: 'Create DD checklist', description: 'Compile comprehensive due diligence items', priority: 'High', type: 'Analysis' },\n      { title: 'Request information', description: 'Send information requests to relevant parties', priority: 'High', type: 'Communication' },\n      { title: 'Review received materials', description: 'Analyze submitted documents', priority: 'Medium', type: 'Analysis' },\n      { title: 'Summarize findings', description: 'Document key observations and issues', priority: 'Medium', type: 'Documentation' },\n    );\n  } else {\n    templates.push(\n      { title: `Complete ${milestoneName}`, description: `Execute ${milestoneName} requirements`, priority: 'High', type: 'General' },\n      { title: `Review ${milestoneName}`, description: `Quality check and approval`, priority: 'Medium', type: 'Review' },\n    );\n  }\n\n  return templates;\n}\n\nexport async function sendDealMemo(dealId: string): Promise<void> {\n  const [deal] = await db.select().from(deals).where(eq(deals.id, dealId));\n  if (!deal) return;\n\n  const podTeam = deal.podTeam as PodTeamMember[];\n  \n  for (const member of podTeam) {\n    if (member.userId) {\n      await db.insert(notifications).values({\n        userId: member.userId,\n        title: `New Deal Assignment: ${deal.name}`,\n        message: `You have been assigned to the ${deal.name} deal as ${member.role}. Client: ${deal.client}. Sector: ${deal.sector}. Value: $${deal.value}M.`,\n        type: 'info',\n        link: `/ceo/deals?dealId=${dealId}`,\n      });\n    }\n  }\n}\n\nexport async function addDealContext(\n  dealId: string, \n  contextType: string, \n  content: string,\n  sourceId?: string\n): Promise<void> {\n  let summary = content.substring(0, 500);\n  \n  try {\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        { role: 'system', content: 'Summarize this deal-related content in 2-3 sentences for quick reference.' },\n        { role: 'user', content: content.substring(0, 4000) }\n      ],\n      max_tokens: 150,\n    });\n    summary = response.choices[0].message.content || summary;\n  } catch (error) {\n    console.error('Error summarizing context:', error);\n  }\n\n  await db.insert(dealAiContext).values({\n    dealId,\n    contextType,\n    content,\n    summary,\n    sourceId,\n    processedAt: new Date(),\n  });\n}\n\nexport async function generateTaskSuggestions(dealId: string): Promise<void> {\n  const [deal] = await db.select().from(deals).where(eq(deals.id, dealId));\n  if (!deal) return;\n\n  const dealTasks = await db.select().from(tasks).where(eq(tasks.dealId, dealId));\n  const context = await db.select().from(dealAiContext).where(eq(dealAiContext.dealId, dealId));\n  const podTeam = deal.podTeam as PodTeamMember[];\n\n  const teamWorkloads: Record<string, number> = {};\n  for (const member of podTeam) {\n    if (member.userId) {\n      teamWorkloads[member.userId] = await getUserWorkload(member.userId);\n    }\n  }\n\n  const prompt = `Analyze this deal and suggest task optimizations:\n\nDeal: ${deal.name}\nType: ${deal.dealType}\nStage: ${deal.stage}\nClient: ${deal.client}\n\nCurrent Tasks (${dealTasks.length}):\n${dealTasks.map(t => `- ${t.title} (${t.status}, assigned to: ${t.assignedTo || 'unassigned'}, due: ${t.dueDate || 'no date'})`).join('\\n')}\n\nTeam Workloads:\n${Object.entries(teamWorkloads).map(([id, count]) => `- User ${id}: ${count} active tasks`).join('\\n')}\n\nRecent Context:\n${context.slice(-5).map(c => c.summary || c.content.substring(0, 200)).join('\\n')}\n\nSuggest up to 3 task adjustments. For each, provide:\n- suggestionType: \"reassign\" | \"reschedule\" | \"reprioritize\" | \"new_task\"\n- title: Brief title\n- description: What to do\n- reasoning: Why this helps\n- priority: \"low\" | \"medium\" | \"high\"\n- suggestedChanges: Object with specific changes (taskId, newAssignee, newDueDate, newPriority, etc.)\n\nReturn JSON array of suggestions.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        { role: 'system', content: 'You are an investment banking operations optimizer. Suggest task adjustments to improve efficiency and balance workload.' },\n        { role: 'user', content: prompt }\n      ],\n      response_format: { type: 'json_object' },\n      temperature: 0.5,\n    });\n\n    const result = JSON.parse(response.choices[0].message.content || '{\"suggestions\":[]}');\n    const suggestions = result.suggestions || result;\n\n    for (const suggestion of (Array.isArray(suggestions) ? suggestions : [suggestions])) {\n      if (!suggestion.title) continue;\n      \n      await db.insert(aiTaskSuggestions).values({\n        dealId,\n        suggestionType: suggestion.suggestionType || 'modify',\n        title: suggestion.title,\n        description: suggestion.description || '',\n        reasoning: suggestion.reasoning,\n        suggestedChanges: suggestion.suggestedChanges || {},\n        priority: suggestion.priority || 'medium',\n        status: 'pending',\n      });\n    }\n  } catch (error) {\n    console.error('Error generating task suggestions:', error);\n  }\n}\n\nexport async function processEmailFolder(folderName: string = 'Deals'): Promise<{\n  processed: number;\n  created: number;\n  errors: number;\n}> {\n  const stats = { processed: 0, created: 0, errors: 0 };\n\n  try {\n    const emails = await scanDealFolder(folderName);\n    const threadGroups = new Map<string, ParsedEmail[]>();\n    \n    for (const email of emails) {\n      const existing = threadGroups.get(email.threadId) || [];\n      existing.push(email);\n      threadGroups.set(email.threadId, existing);\n    }\n\n    for (const [threadId, threadEmails] of Array.from(threadGroups.entries())) {\n      stats.processed++;\n      \n      const existingEmailDeal = await db\n        .select()\n        .from(emailDeals)\n        .where(eq(emailDeals.threadId, threadId))\n        .limit(1);\n\n      if (existingEmailDeal.length > 0) continue;\n\n      try {\n        const extracted = await extractDealFromEmails(threadEmails);\n        \n        if (extracted) {\n          const dealId = await createDealFromEmail(extracted, true);\n          \n          await db.insert(emailDeals).values({\n            emailId: threadEmails[0].id,\n            threadId,\n            subject: threadEmails[0].subject,\n            sender: threadEmails[0].from,\n            receivedAt: threadEmails[0].date,\n            extractedData: extracted,\n            dealId,\n            status: 'processed',\n          });\n\n          await createMilestonesForDeal(dealId, 'Origination');\n          \n          for (const email of threadEmails) {\n            await addDealContext(dealId, 'email', email.body, email.id);\n          }\n          \n          await sendDealMemo(dealId);\n          \n          stats.created++;\n        } else {\n          await db.insert(emailDeals).values({\n            emailId: threadEmails[0].id,\n            threadId,\n            subject: threadEmails[0].subject,\n            sender: threadEmails[0].from,\n            receivedAt: threadEmails[0].date,\n            status: 'ignored',\n            processingNotes: 'Not identified as a deal',\n          });\n        }\n      } catch (error: any) {\n        stats.errors++;\n        await db.insert(emailDeals).values({\n          emailId: threadEmails[0].id,\n          threadId,\n          subject: threadEmails[0].subject,\n          sender: threadEmails[0].from,\n          receivedAt: threadEmails[0].date,\n          status: 'error',\n          processingNotes: error.message,\n        });\n      }\n    }\n  } catch (error) {\n    console.error('Error processing email folder:', error);\n    stats.errors++;\n  }\n\n  return stats;\n}\n","path":null,"size_bytes":21035,"size_tokens":null},"client/src/pages/shared/Forms.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useForms, useCreateForm, useUpdateForm, useDeleteForm, usePublishForm, useUnpublishForm, useShareForm, useFormSubmissions, useCurrentUser, type Form, type FormField, type FormBranchCondition, type FormTableColumn, type FormTableCell, type FormContentBlock } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { toast } from \"sonner\";\nimport { Plus, FileText, Share2, Trash2, Edit, Eye, Copy, Send, GripVertical, X, Type, Mail, List, Calendar, Hash, Paperclip, Heading, AlignLeft, Table, FileTextIcon, Image, ChevronDown, ChevronUp, GitBranch, Link, Upload, Search, ExternalLink, Download, ChevronLeft, User, Clock } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { format } from \"date-fns\";\nimport jsPDF from \"jspdf\";\n\nconst FIELD_TYPES = [\n  { value: 'heading', label: 'Section Heading', icon: Heading, category: 'layout' },\n  { value: 'content', label: 'Rich Content', icon: FileTextIcon, category: 'layout' },\n  { value: 'text', label: 'Short Text', icon: Type, category: 'input' },\n  { value: 'textarea', label: 'Long Text', icon: AlignLeft, category: 'input' },\n  { value: 'email', label: 'Email', icon: Mail, category: 'input' },\n  { value: 'single-select', label: 'Dropdown', icon: List, category: 'input' },\n  { value: 'multi-select', label: 'Multi Select', icon: List, category: 'input' },\n  { value: 'date', label: 'Date', icon: Calendar, category: 'input' },\n  { value: 'number', label: 'Number', icon: Hash, category: 'input' },\n  { value: 'file', label: 'File Upload', icon: Paperclip, category: 'input' },\n  { value: 'table', label: 'Info Table', icon: Table, category: 'layout' },\n] as const;\n\nexport default function Forms() {\n  const [location] = useLocation();\n  const role: 'CEO' | 'Employee' = location.startsWith('/ceo') ? 'CEO' : 'Employee';\n  \n  const { data: currentUser } = useCurrentUser();\n  const { data: forms, isLoading } = useForms();\n  const createForm = useCreateForm();\n  const updateForm = useUpdateForm();\n  const deleteForm = useDeleteForm();\n  const publishForm = usePublishForm();\n  const unpublishForm = useUnpublishForm();\n  const shareForm = useShareForm();\n\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showShareDialog, setShowShareDialog] = useState(false);\n  const [showSubmissionsDialog, setShowSubmissionsDialog] = useState(false);\n  const [showPreviewDialog, setShowPreviewDialog] = useState(false);\n  const [selectedForm, setSelectedForm] = useState<Form | null>(null);\n  const [newFormTitle, setNewFormTitle] = useState(\"\");\n  const [newFormDescription, setNewFormDescription] = useState(\"\");\n  const [shareEmails, setShareEmails] = useState(\"\");\n  const [shareMessage, setShareMessage] = useState(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [editingFields, setEditingFields] = useState<FormField[]>([]);\n  const [editingTitle, setEditingTitle] = useState(\"\");\n  const [editingDescription, setEditingDescription] = useState(\"\");\n  const [editingCoverImage, setEditingCoverImage] = useState(\"\");\n  const [expandedFieldId, setExpandedFieldId] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState<string>(\"build\");\n\n  // Check if user is Dimitra or Charles (admin users who can edit/manage forms)\n  const isFormAdmin = currentUser?.name?.toLowerCase().includes('dimitra') || \n                      currentUser?.email?.toLowerCase().includes('dimitra') ||\n                      currentUser?.name?.toLowerCase().includes('charles') || \n                      currentUser?.email?.toLowerCase().includes('charles');\n\n  // Filter forms: admins see all, others see only published forms\n  // Also filter by search query\n  const filteredForms = useMemo(() => {\n    if (!forms) return [];\n    \n    let result = forms;\n    \n    // Non-admins only see published forms\n    if (!isFormAdmin) {\n      result = result.filter(f => f.status === 'published');\n    }\n    \n    // Apply search filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter(f => \n        f.title.toLowerCase().includes(query) ||\n        (f.description && f.description.toLowerCase().includes(query))\n      );\n    }\n    \n    return result;\n  }, [forms, isFormAdmin, searchQuery]);\n\n  // Function to open form in new tab (for non-admin users)\n  const handleOpenForm = (form: Form) => {\n    if (form.shareToken) {\n      window.open(`/form/${form.shareToken}`, '_blank');\n    }\n  };\n\n  const handleCreateForm = async () => {\n    if (!newFormTitle.trim()) {\n      toast.error(\"Please enter a form title\");\n      return;\n    }\n    try {\n      const form = await createForm.mutateAsync({\n        title: newFormTitle,\n        description: newFormDescription || undefined,\n        fields: [],\n      });\n      toast.success(\"Form created successfully\");\n      setShowCreateDialog(false);\n      setNewFormTitle(\"\");\n      setNewFormDescription(\"\");\n      setSelectedForm(form);\n      setEditingTitle(form.title);\n      setEditingDescription(form.description || \"\");\n      setEditingCoverImage(form.coverImage || \"\");\n      setEditingFields(form.fields || []);\n      setActiveTab(\"build\");\n      setShowEditDialog(true);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleOpenEdit = (form: Form) => {\n    setSelectedForm(form);\n    setEditingTitle(form.title);\n    setEditingDescription(form.description || \"\");\n    setEditingCoverImage(form.coverImage || \"\");\n    setEditingFields(form.fields || []);\n    setActiveTab(\"build\");\n    setShowEditDialog(true);\n  };\n\n  const handleSaveForm = async () => {\n    if (!selectedForm) return;\n    try {\n      await updateForm.mutateAsync({\n        id: selectedForm.id,\n        title: editingTitle,\n        description: editingDescription,\n        coverImage: editingCoverImage || null,\n        fields: editingFields,\n      });\n      toast.success(\"Form saved successfully\");\n      setShowEditDialog(false);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handlePublishForm = async (form: Form) => {\n    try {\n      await publishForm.mutateAsync(form.id);\n      toast.success(\"Form published successfully\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleUnpublishForm = async (form: Form) => {\n    if (!confirm(`Are you sure you want to revert \"${form.title}\" to draft? The share link will stop working until you publish again.`)) return;\n    try {\n      await unpublishForm.mutateAsync(form.id);\n      toast.success(\"Form reverted to draft\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleDeleteForm = async (form: Form) => {\n    if (!confirm(`Are you sure you want to delete \"${form.title}\"?`)) return;\n    try {\n      await deleteForm.mutateAsync(form.id);\n      toast.success(\"Form deleted\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleOpenShare = (form: Form) => {\n    setSelectedForm(form);\n    setShareEmails(\"\");\n    setShareMessage(\"\");\n    setShowShareDialog(true);\n  };\n\n  const handleShareForm = async () => {\n    if (!selectedForm) return;\n    const emails = shareEmails.split(',').map(e => e.trim()).filter(Boolean);\n    if (emails.length === 0) {\n      toast.error(\"Please enter at least one email\");\n      return;\n    }\n    try {\n      const result = await shareForm.mutateAsync({\n        id: selectedForm.id,\n        emails,\n        message: shareMessage || undefined,\n      });\n      toast.success(`Form shared with ${emails.length} recipient(s)`);\n      setShowShareDialog(false);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleCopyLink = async (form: Form) => {\n    if (!form.shareToken) {\n      toast.error(\"Form must be published first\");\n      return;\n    }\n    const baseUrl = window.location.origin;\n    const link = `${baseUrl}/form/${form.shareToken}`;\n    await navigator.clipboard.writeText(link);\n    toast.success(\"Link copied to clipboard\");\n  };\n\n  const handlePreview = (form: Form) => {\n    setSelectedForm(form);\n    setShowPreviewDialog(true);\n  };\n\n  const addField = (type: FormField['type']) => {\n    const newField: FormField = {\n      id: `field_${Date.now()}`,\n      type,\n      label: type === 'heading' ? 'Section Title' : \n             type === 'content' ? 'Information Block' :\n             type === 'table' ? 'Reference Table' :\n             `New ${type} field`,\n      required: type === 'heading' || type === 'content' || type === 'table' ? false : false,\n      options: type === 'single-select' || type === 'multi-select' ? ['Option 1', 'Option 2'] : undefined,\n      description: undefined,\n      placeholder: undefined,\n      tableColumns: type === 'table' ? [\n        { id: 'col1', header: 'Column 1' },\n        { id: 'col2', header: 'Column 2' },\n      ] : undefined,\n      tableRows: type === 'table' ? [\n        [{ value: 'Row 1 Cell 1' }, { value: 'Row 1 Cell 2' }],\n      ] : undefined,\n      contentBlocks: type === 'content' ? [\n        { type: 'paragraph', text: 'Enter your information content here.' }\n      ] : undefined,\n    };\n    setEditingFields([...editingFields, newField]);\n    setExpandedFieldId(newField.id);\n  };\n\n  const updateField = (index: number, updates: Partial<FormField>) => {\n    const updated = [...editingFields];\n    updated[index] = { ...updated[index], ...updates };\n    setEditingFields(updated);\n  };\n\n  const removeField = (index: number) => {\n    setEditingFields(editingFields.filter((_, i) => i !== index));\n  };\n\n  const moveField = (from: number, to: number) => {\n    if (to < 0 || to >= editingFields.length) return;\n    const updated = [...editingFields];\n    const [removed] = updated.splice(from, 1);\n    updated.splice(to, 0, removed);\n    setEditingFields(updated);\n  };\n\n  const getSelectableFieldsForBranching = (currentFieldIndex: number) => {\n    return editingFields\n      .slice(0, currentFieldIndex)\n      .filter(f => f.type === 'single-select' || f.type === 'multi-select');\n  };\n\n  const addTableColumn = (fieldIndex: number) => {\n    const field = editingFields[fieldIndex];\n    if (!field.tableColumns) return;\n    const newColId = `col_${Date.now()}`;\n    const newColumns = [...field.tableColumns, { id: newColId, header: `Column ${field.tableColumns.length + 1}` }];\n    const newRows = (field.tableRows || []).map(row => [...row, { value: '' }]);\n    updateField(fieldIndex, { tableColumns: newColumns, tableRows: newRows });\n  };\n\n  const removeTableColumn = (fieldIndex: number, colIndex: number) => {\n    const field = editingFields[fieldIndex];\n    if (!field.tableColumns || field.tableColumns.length <= 1) return;\n    const newColumns = field.tableColumns.filter((_, i) => i !== colIndex);\n    const newRows = (field.tableRows || []).map(row => row.filter((_, i) => i !== colIndex));\n    updateField(fieldIndex, { tableColumns: newColumns, tableRows: newRows });\n  };\n\n  const addTableRow = (fieldIndex: number) => {\n    const field = editingFields[fieldIndex];\n    const colCount = field.tableColumns?.length || 2;\n    const newRow = Array(colCount).fill(null).map(() => ({ value: '' }));\n    updateField(fieldIndex, { tableRows: [...(field.tableRows || []), newRow] });\n  };\n\n  const removeTableRow = (fieldIndex: number, rowIndex: number) => {\n    const field = editingFields[fieldIndex];\n    if (!field.tableRows || field.tableRows.length <= 1) return;\n    updateField(fieldIndex, { tableRows: field.tableRows.filter((_, i) => i !== rowIndex) });\n  };\n\n  const updateTableCell = (fieldIndex: number, rowIndex: number, colIndex: number, value: string) => {\n    const field = editingFields[fieldIndex];\n    if (!field.tableRows) return;\n    const newRows = field.tableRows.map((row, ri) => \n      ri === rowIndex ? row.map((cell, ci) => ci === colIndex ? { value } : cell) : row\n    );\n    updateField(fieldIndex, { tableRows: newRows });\n  };\n\n  const updateTableHeader = (fieldIndex: number, colIndex: number, header: string) => {\n    const field = editingFields[fieldIndex];\n    if (!field.tableColumns) return;\n    const newColumns = field.tableColumns.map((col, i) => i === colIndex ? { ...col, header } : col);\n    updateField(fieldIndex, { tableColumns: newColumns });\n  };\n\n  const addContentBlock = (fieldIndex: number, type: 'paragraph' | 'heading' | 'list' | 'link') => {\n    const field = editingFields[fieldIndex];\n    const newBlock: FormContentBlock = type === 'list' \n      ? { type: 'list', items: ['Item 1', 'Item 2'] }\n      : type === 'link'\n      ? { type: 'link', linkText: 'Click here', url: 'https://' }\n      : { type, text: type === 'heading' ? 'Section Heading' : 'Enter text here...' };\n    updateField(fieldIndex, { contentBlocks: [...(field.contentBlocks || []), newBlock] });\n  };\n\n  const updateContentBlock = (fieldIndex: number, blockIndex: number, updates: Partial<FormContentBlock>) => {\n    const field = editingFields[fieldIndex];\n    if (!field.contentBlocks) return;\n    const newBlocks = field.contentBlocks.map((block, i) => i === blockIndex ? { ...block, ...updates } : block);\n    updateField(fieldIndex, { contentBlocks: newBlocks });\n  };\n\n  const removeContentBlock = (fieldIndex: number, blockIndex: number) => {\n    const field = editingFields[fieldIndex];\n    if (!field.contentBlocks || field.contentBlocks.length <= 1) return;\n    updateField(fieldIndex, { contentBlocks: field.contentBlocks.filter((_, i) => i !== blockIndex) });\n  };\n\n  return (\n    <Layout role={role}>\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold\" data-testid=\"page-title-forms\">Forms</h1>\n            <p className=\"text-muted-foreground\">\n              {isFormAdmin ? \"Create and share forms to collect information\" : \"View and submit forms\"}\n            </p>\n          </div>\n          {isFormAdmin && (\n            <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-create-form\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Form\n            </Button>\n          )}\n        </div>\n\n        {/* Search Bar */}\n        <div className=\"relative max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search forms by title or description...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-forms\"\n          />\n        </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center h-64\">\n          <p className=\"text-muted-foreground\">Loading forms...</p>\n        </div>\n      ) : filteredForms.length > 0 ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredForms.map((form) => (\n            <Card \n              key={form.id} \n              data-testid={`card-form-${form.id}`}\n              className={!isFormAdmin ? \"cursor-pointer hover:shadow-md transition-shadow\" : \"\"}\n              onClick={!isFormAdmin ? () => handleOpenForm(form) : undefined}\n            >\n              {form.coverImage && (\n                <div className=\"h-32 overflow-hidden rounded-t-lg\">\n                  <img src={form.coverImage} alt=\"\" className=\"w-full h-full object-cover\" />\n                </div>\n              )}\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <CardTitle className=\"text-lg\">{form.title}</CardTitle>\n                    {form.description && (\n                      <CardDescription className=\"mt-1\">{form.description}</CardDescription>\n                    )}\n                  </div>\n                  {isFormAdmin && (\n                    <Badge variant={form.status === 'published' ? 'default' : 'secondary'}>\n                      {form.status}\n                    </Badge>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-sm text-muted-foreground mb-4\">\n                  <p>{form.fields?.length || 0} fields</p>\n                  <p>Created {format(new Date(form.createdAt), 'MMM d, yyyy')}</p>\n                </div>\n                {isFormAdmin ? (\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => handleOpenEdit(form)} data-testid={`button-edit-form-${form.id}`}>\n                      <Edit className=\"h-4 w-4 mr-1\" />\n                      Edit\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => handlePreview(form)} data-testid={`button-preview-form-${form.id}`}>\n                      <Eye className=\"h-4 w-4 mr-1\" />\n                      Preview\n                    </Button>\n                    {form.status === 'draft' && (\n                      <Button variant=\"outline\" size=\"sm\" onClick={() => handlePublishForm(form)} data-testid={`button-publish-form-${form.id}`}>\n                        <Send className=\"h-4 w-4 mr-1\" />\n                        Publish\n                      </Button>\n                    )}\n                    {form.status === 'published' && (\n                      <>\n                        <Button variant=\"outline\" size=\"sm\" onClick={() => handleOpenShare(form)} data-testid={`button-share-form-${form.id}`}>\n                          <Share2 className=\"h-4 w-4 mr-1\" />\n                          Share\n                        </Button>\n                        <Button variant=\"outline\" size=\"sm\" onClick={() => handleCopyLink(form)} data-testid={`button-copy-link-${form.id}`}>\n                          <Copy className=\"h-4 w-4 mr-1\" />\n                          Copy Link\n                        </Button>\n                        <Button variant=\"outline\" size=\"sm\" onClick={() => handleUnpublishForm(form)} className=\"text-amber-600 hover:text-amber-700\" data-testid={`button-unpublish-form-${form.id}`}>\n                          <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                          Revert to Draft\n                        </Button>\n                      </>\n                    )}\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => { setSelectedForm(form); setShowSubmissionsDialog(true); }} data-testid={`button-submissions-${form.id}`}>\n                      <FileText className=\"h-4 w-4 mr-1\" />\n                      Submissions\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => handleDeleteForm(form)} className=\"text-destructive hover:text-destructive\" data-testid={`button-delete-form-${form.id}`}>\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"flex items-center text-primary\">\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\n                    <span className=\"text-sm\">Click to open form</span>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <FileText className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n            <h3 className=\"text-lg font-medium mb-2\">\n              {searchQuery ? \"No forms found\" : (isFormAdmin ? \"No forms yet\" : \"No published forms available\")}\n            </h3>\n            <p className=\"text-muted-foreground mb-4\">\n              {searchQuery \n                ? \"Try adjusting your search terms\" \n                : (isFormAdmin ? \"Create your first form to start collecting information\" : \"Check back later for new forms\")}\n            </p>\n            {isFormAdmin && !searchQuery && (\n              <Button onClick={() => setShowCreateDialog(true)}>\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Create Form\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create New Form</DialogTitle>\n            <DialogDescription>Enter a title and optional description for your form</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"form-title\">Title</Label>\n              <Input\n                id=\"form-title\"\n                value={newFormTitle}\n                onChange={(e) => setNewFormTitle(e.target.value)}\n                placeholder=\"Enter form title\"\n                data-testid=\"input-form-title\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"form-description\">Description (optional)</Label>\n              <Textarea\n                id=\"form-description\"\n                value={newFormDescription}\n                onChange={(e) => setNewFormDescription(e.target.value)}\n                placeholder=\"Enter form description\"\n                data-testid=\"input-form-description\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateDialog(false)}>Cancel</Button>\n            <Button onClick={handleCreateForm} disabled={createForm.isPending} data-testid=\"button-submit-create-form\">\n              {createForm.isPending ? \"Creating...\" : \"Create Form\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Edit Form</DialogTitle>\n            <DialogDescription>Design your form with fields, content, and conditional logic</DialogDescription>\n          </DialogHeader>\n          \n          <Tabs value={activeTab} onValueChange={setActiveTab}>\n            <TabsList className=\"mb-4\">\n              <TabsTrigger value=\"build\">Build</TabsTrigger>\n              <TabsTrigger value=\"settings\">Settings</TabsTrigger>\n              <TabsTrigger value=\"preview\">Preview</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"settings\" className=\"space-y-6\">\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <div>\n                  <Label htmlFor=\"edit-title\">Form Title</Label>\n                  <Input\n                    id=\"edit-title\"\n                    value={editingTitle}\n                    onChange={(e) => setEditingTitle(e.target.value)}\n                    data-testid=\"input-edit-title\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"edit-description\">Description</Label>\n                  <Input\n                    id=\"edit-description\"\n                    value={editingDescription}\n                    onChange={(e) => setEditingDescription(e.target.value)}\n                    data-testid=\"input-edit-description\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label htmlFor=\"edit-cover-image\">Cover Image URL</Label>\n                <Input\n                  id=\"edit-cover-image\"\n                  value={editingCoverImage}\n                  onChange={(e) => setEditingCoverImage(e.target.value)}\n                  placeholder=\"https://example.com/image.jpg\"\n                  data-testid=\"input-edit-cover-image\"\n                />\n                <p className=\"text-sm text-muted-foreground mt-1\">Add a header image to your form (optional)</p>\n                {editingCoverImage && (\n                  <div className=\"mt-3 h-32 overflow-hidden rounded-lg border\">\n                    <img src={editingCoverImage} alt=\"Cover preview\" className=\"w-full h-full object-cover\" onError={(e) => (e.currentTarget.style.display = 'none')} />\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"build\" className=\"space-y-6\">\n              <div>\n                <Label className=\"mb-3 block\">Add Field</Label>\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm text-muted-foreground\">Layout Elements</p>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {FIELD_TYPES.filter(ft => ft.category === 'layout').map((ft) => (\n                      <Button key={ft.value} variant=\"outline\" size=\"sm\" onClick={() => addField(ft.value)} data-testid={`button-add-field-${ft.value}`}>\n                        <ft.icon className=\"h-4 w-4 mr-1\" />\n                        {ft.label}\n                      </Button>\n                    ))}\n                  </div>\n                  <p className=\"text-sm text-muted-foreground mt-3\">Input Fields</p>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {FIELD_TYPES.filter(ft => ft.category === 'input').map((ft) => (\n                      <Button key={ft.value} variant=\"outline\" size=\"sm\" onClick={() => addField(ft.value)} data-testid={`button-add-field-${ft.value}`}>\n                        <ft.icon className=\"h-4 w-4 mr-1\" />\n                        {ft.label}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-4\">\n                <Label>Form Fields ({editingFields.length})</Label>\n                {editingFields.length === 0 ? (\n                  <p className=\"text-sm text-muted-foreground text-center py-8 border rounded-md\">\n                    No fields yet. Click a field type above to add one.\n                  </p>\n                ) : (\n                  editingFields.map((field, index) => (\n                    <FieldEditor\n                      key={field.id}\n                      field={field}\n                      index={index}\n                      totalFields={editingFields.length}\n                      isExpanded={expandedFieldId === field.id}\n                      onToggleExpand={() => setExpandedFieldId(expandedFieldId === field.id ? null : field.id)}\n                      onUpdate={(updates) => updateField(index, updates)}\n                      onRemove={() => removeField(index)}\n                      onMoveUp={() => moveField(index, index - 1)}\n                      onMoveDown={() => moveField(index, index + 1)}\n                      selectableFields={getSelectableFieldsForBranching(index)}\n                      onAddTableColumn={() => addTableColumn(index)}\n                      onRemoveTableColumn={(colIdx) => removeTableColumn(index, colIdx)}\n                      onAddTableRow={() => addTableRow(index)}\n                      onRemoveTableRow={(rowIdx) => removeTableRow(index, rowIdx)}\n                      onUpdateTableCell={(rowIdx, colIdx, val) => updateTableCell(index, rowIdx, colIdx, val)}\n                      onUpdateTableHeader={(colIdx, header) => updateTableHeader(index, colIdx, header)}\n                      onAddContentBlock={(type) => addContentBlock(index, type)}\n                      onUpdateContentBlock={(blockIdx, updates) => updateContentBlock(index, blockIdx, updates)}\n                      onRemoveContentBlock={(blockIdx) => removeContentBlock(index, blockIdx)}\n                    />\n                  ))\n                )}\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"preview\" className=\"space-y-6\">\n              <FormPreview\n                title={editingTitle}\n                description={editingDescription}\n                coverImage={editingCoverImage}\n                fields={editingFields}\n              />\n            </TabsContent>\n          </Tabs>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)}>Cancel</Button>\n            <Button onClick={handleSaveForm} disabled={updateForm.isPending} data-testid=\"button-save-form\">\n              {updateForm.isPending ? \"Saving...\" : \"Save Form\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showPreviewDialog} onOpenChange={setShowPreviewDialog}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Form Preview</DialogTitle>\n            <DialogDescription>This is how your form will appear to respondents</DialogDescription>\n          </DialogHeader>\n          {selectedForm && (\n            <FormPreview\n              title={selectedForm.title}\n              description={selectedForm.description || \"\"}\n              coverImage={selectedForm.coverImage || \"\"}\n              fields={selectedForm.fields}\n            />\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showShareDialog} onOpenChange={setShowShareDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Share Form</DialogTitle>\n            <DialogDescription>Share \"{selectedForm?.title}\" via email</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            {selectedForm?.shareToken && (\n              <div>\n                <Label>Form Link</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    readOnly\n                    value={`${window.location.origin}/form/${selectedForm.shareToken}`}\n                    className=\"flex-1\"\n                    data-testid=\"input-share-link\"\n                  />\n                  <Button variant=\"outline\" onClick={() => handleCopyLink(selectedForm)} data-testid=\"button-copy-share-link\">\n                    <Copy className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            )}\n            <div>\n              <Label htmlFor=\"share-emails\">Email Addresses</Label>\n              <Textarea\n                id=\"share-emails\"\n                value={shareEmails}\n                onChange={(e) => setShareEmails(e.target.value)}\n                placeholder=\"Enter email addresses, separated by commas\"\n                data-testid=\"input-share-emails\"\n              />\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Platform users will receive a task. External users will receive an email.\n              </p>\n            </div>\n            <div>\n              <Label htmlFor=\"share-message\">Message (optional)</Label>\n              <Textarea\n                id=\"share-message\"\n                value={shareMessage}\n                onChange={(e) => setShareMessage(e.target.value)}\n                placeholder=\"Add a personal message\"\n                data-testid=\"input-share-message\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowShareDialog(false)}>Cancel</Button>\n            <Button onClick={handleShareForm} disabled={shareForm.isPending} data-testid=\"button-send-share\">\n              <Send className=\"h-4 w-4 mr-2\" />\n              {shareForm.isPending ? \"Sending...\" : \"Send Invitations\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <SubmissionsDialog\n        open={showSubmissionsDialog}\n        onOpenChange={setShowSubmissionsDialog}\n        form={selectedForm}\n      />\n      </div>\n    </Layout>\n  );\n}\n\ninterface FieldEditorProps {\n  field: FormField;\n  index: number;\n  totalFields: number;\n  isExpanded: boolean;\n  onToggleExpand: () => void;\n  onUpdate: (updates: Partial<FormField>) => void;\n  onRemove: () => void;\n  onMoveUp: () => void;\n  onMoveDown: () => void;\n  selectableFields: FormField[];\n  onAddTableColumn: () => void;\n  onRemoveTableColumn: (colIndex: number) => void;\n  onAddTableRow: () => void;\n  onRemoveTableRow: (rowIndex: number) => void;\n  onUpdateTableCell: (rowIndex: number, colIndex: number, value: string) => void;\n  onUpdateTableHeader: (colIndex: number, header: string) => void;\n  onAddContentBlock: (type: 'paragraph' | 'heading' | 'list' | 'link') => void;\n  onUpdateContentBlock: (blockIndex: number, updates: Partial<FormContentBlock>) => void;\n  onRemoveContentBlock: (blockIndex: number) => void;\n}\n\nfunction FieldEditor({\n  field, index, totalFields, isExpanded, onToggleExpand, onUpdate, onRemove, onMoveUp, onMoveDown,\n  selectableFields, onAddTableColumn, onRemoveTableColumn, onAddTableRow, onRemoveTableRow,\n  onUpdateTableCell, onUpdateTableHeader, onAddContentBlock, onUpdateContentBlock, onRemoveContentBlock\n}: FieldEditorProps) {\n  const fieldType = FIELD_TYPES.find(ft => ft.value === field.type);\n  const Icon = fieldType?.icon || Type;\n  const isLayoutField = field.type === 'heading' || field.type === 'content' || field.type === 'table';\n\n  return (\n    <Card className=\"p-4\">\n      <div className=\"flex items-start gap-3\">\n        <div className=\"flex flex-col gap-1\">\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={onMoveUp} disabled={index === 0}>\n            <ChevronUp className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={onMoveDown} disabled={index === totalFields - 1}>\n            <ChevronDown className=\"h-4 w-4\" />\n          </Button>\n        </div>\n        <div className=\"flex-1 space-y-3\">\n          <div className=\"flex items-center gap-3\">\n            <Badge variant=\"outline\" className=\"gap-1\">\n              <Icon className=\"h-3 w-3\" />\n              {fieldType?.label || field.type}\n            </Badge>\n            <Input\n              value={field.label}\n              onChange={(e) => onUpdate({ label: e.target.value })}\n              placeholder=\"Field label\"\n              className=\"flex-1\"\n              data-testid={`input-field-label-${index}`}\n            />\n            {!isLayoutField && (\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  checked={field.required}\n                  onCheckedChange={(checked) => onUpdate({ required: checked })}\n                  data-testid={`switch-required-${index}`}\n                />\n                <Label className=\"text-sm\">Required</Label>\n              </div>\n            )}\n            <Button variant=\"ghost\" size=\"sm\" onClick={onToggleExpand}>\n              {isExpanded ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n            </Button>\n          </div>\n\n          {isExpanded && (\n            <div className=\"space-y-4 pt-3 border-t\">\n              {!isLayoutField && (\n                <>\n                  <div className=\"grid gap-4 md:grid-cols-2\">\n                    <div>\n                      <Label className=\"text-sm\">Description / Help Text</Label>\n                      <Input\n                        value={field.description || ''}\n                        onChange={(e) => onUpdate({ description: e.target.value })}\n                        placeholder=\"Add help text for this field\"\n                        data-testid={`input-field-description-${index}`}\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-sm\">Placeholder</Label>\n                      <Input\n                        value={field.placeholder || ''}\n                        onChange={(e) => onUpdate({ placeholder: e.target.value })}\n                        placeholder=\"Placeholder text\"\n                        data-testid={`input-field-placeholder-${index}`}\n                      />\n                    </div>\n                  </div>\n\n                  {selectableFields.length > 0 && (\n                    <div className=\"p-3 bg-muted/50 rounded-md\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <GitBranch className=\"h-4 w-4 text-muted-foreground\" />\n                        <Label className=\"text-sm font-medium\">Conditional Logic</Label>\n                      </div>\n                      <div className=\"grid gap-2 md:grid-cols-3\">\n                        <Select\n                          value={field.showWhen?.fieldId || 'none'}\n                          onValueChange={(val) => {\n                            if (val === 'none') {\n                              onUpdate({ showWhen: undefined });\n                            } else {\n                              onUpdate({ showWhen: { fieldId: val, operator: 'equals', value: '' } });\n                            }\n                          }}\n                        >\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Show when...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"none\">Always show</SelectItem>\n                            {selectableFields.map(f => (\n                              <SelectItem key={f.id} value={f.id}>{f.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        {field.showWhen && (\n                          <>\n                            <Select\n                              value={field.showWhen.operator}\n                              onValueChange={(val: 'equals' | 'not_equals' | 'contains') => onUpdate({ showWhen: { ...field.showWhen!, operator: val } })}\n                            >\n                              <SelectTrigger>\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"equals\">Equals</SelectItem>\n                                <SelectItem value=\"not_equals\">Not Equals</SelectItem>\n                                <SelectItem value=\"contains\">Contains</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <Input\n                              value={field.showWhen.value}\n                              onChange={(e) => onUpdate({ showWhen: { ...field.showWhen!, value: e.target.value } })}\n                              placeholder=\"Value\"\n                            />\n                          </>\n                        )}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-2\">\n                        This field will only be shown when the selected condition is met.\n                      </p>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {(field.type === 'single-select' || field.type === 'multi-select') && (\n                <div>\n                  <Label className=\"text-sm\">Options (comma-separated)</Label>\n                  <Input\n                    value={field.options?.join(', ') || ''}\n                    onChange={(e) => onUpdate({ options: e.target.value.split(',').map(o => o.trim()).filter(Boolean) })}\n                    placeholder=\"Option 1, Option 2, Option 3\"\n                    data-testid={`input-field-options-${index}`}\n                  />\n                </div>\n              )}\n\n              {field.type === 'table' && (\n                <div className=\"space-y-3\">\n                  <Label className=\"text-sm\">Table Configuration</Label>\n                  <div className=\"border rounded-md overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted\">\n                        <tr>\n                          {field.tableColumns?.map((col, ci) => (\n                            <th key={col.id} className=\"p-2 border-r last:border-r-0\">\n                              <div className=\"flex items-center gap-1\">\n                                <Input\n                                  value={col.header}\n                                  onChange={(e) => onUpdateTableHeader(ci, e.target.value)}\n                                  className=\"h-7 text-xs\"\n                                />\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 text-destructive\" onClick={() => onRemoveTableColumn(ci)}>\n                                  <X className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            </th>\n                          ))}\n                          <th className=\"p-2 w-12\">\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" onClick={onAddTableColumn}>\n                              <Plus className=\"h-3 w-3\" />\n                            </Button>\n                          </th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {field.tableRows?.map((row, ri) => (\n                          <tr key={ri} className=\"border-t\">\n                            {row.map((cell, ci) => (\n                              <td key={ci} className=\"p-2 border-r last:border-r-0\">\n                                <Input\n                                  value={cell.value}\n                                  onChange={(e) => onUpdateTableCell(ri, ci, e.target.value)}\n                                  className=\"h-7 text-xs\"\n                                />\n                              </td>\n                            ))}\n                            <td className=\"p-2 w-12\">\n                              <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 text-destructive\" onClick={() => onRemoveTableRow(ri)}>\n                                <X className=\"h-3 w-3\" />\n                              </Button>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                  <Button variant=\"outline\" size=\"sm\" onClick={onAddTableRow}>\n                    <Plus className=\"h-3 w-3 mr-1\" /> Add Row\n                  </Button>\n                </div>\n              )}\n\n              {field.type === 'content' && (\n                <div className=\"space-y-3\">\n                  <Label className=\"text-sm\">Content Blocks</Label>\n                  {field.contentBlocks?.map((block, bi) => (\n                    <div key={bi} className=\"flex gap-2 items-start\">\n                      <Badge variant=\"secondary\" className=\"mt-2\">{block.type}</Badge>\n                      <div className=\"flex-1\">\n                        {block.type === 'list' ? (\n                          <Textarea\n                            value={block.items?.join('\\n') || ''}\n                            onChange={(e) => onUpdateContentBlock(bi, { items: e.target.value.split('\\n').filter(Boolean) })}\n                            placeholder=\"One item per line\"\n                            rows={3}\n                          />\n                        ) : block.type === 'link' ? (\n                          <div className=\"space-y-2\">\n                            <Input\n                              value={block.linkText || ''}\n                              onChange={(e) => onUpdateContentBlock(bi, { linkText: e.target.value })}\n                              placeholder=\"Link text\"\n                            />\n                            <Input\n                              value={block.url || ''}\n                              onChange={(e) => onUpdateContentBlock(bi, { url: e.target.value })}\n                              placeholder=\"https://...\"\n                            />\n                          </div>\n                        ) : (\n                          <Textarea\n                            value={block.text || ''}\n                            onChange={(e) => onUpdateContentBlock(bi, { text: e.target.value })}\n                            placeholder=\"Enter text...\"\n                            rows={block.type === 'heading' ? 1 : 3}\n                          />\n                        )}\n                      </div>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive\" onClick={() => onRemoveContentBlock(bi)}>\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                  <div className=\"flex gap-2\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => onAddContentBlock('paragraph')}>\n                      <AlignLeft className=\"h-3 w-3 mr-1\" /> Paragraph\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => onAddContentBlock('heading')}>\n                      <Heading className=\"h-3 w-3 mr-1\" /> Heading\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => onAddContentBlock('list')}>\n                      <List className=\"h-3 w-3 mr-1\" /> List\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => onAddContentBlock('link')}>\n                      <Link className=\"h-3 w-3 mr-1\" /> Link\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive\" onClick={onRemove} data-testid={`button-remove-field-${index}`}>\n          <X className=\"h-4 w-4\" />\n        </Button>\n      </div>\n    </Card>\n  );\n}\n\ninterface FormPreviewProps {\n  title: string;\n  description: string;\n  coverImage: string;\n  fields: FormField[];\n}\n\nfunction FormPreview({ title, description, coverImage, fields }: FormPreviewProps) {\n  const [formValues, setFormValues] = useState<Record<string, string | string[]>>({});\n\n  const shouldShowField = (field: FormField): boolean => {\n    if (!field.showWhen) return true;\n    const triggerValue = formValues[field.showWhen.fieldId];\n    const conditionValue = field.showWhen.value;\n    \n    switch (field.showWhen.operator) {\n      case 'equals':\n        return triggerValue === conditionValue || (Array.isArray(triggerValue) && triggerValue.includes(conditionValue));\n      case 'not_equals':\n        return triggerValue !== conditionValue && (!Array.isArray(triggerValue) || !triggerValue.includes(conditionValue));\n      case 'contains':\n        return Array.isArray(triggerValue) ? triggerValue.includes(conditionValue) : String(triggerValue || '').includes(conditionValue);\n      default:\n        return true;\n    }\n  };\n\n  const visibleFields = fields.filter(shouldShowField);\n\n  return (\n    <div className=\"bg-[#f5f0e8] rounded-lg overflow-hidden border border-[#e5ddd0]\">\n      {coverImage && (\n        <div className=\"h-20 overflow-hidden\">\n          <img src={coverImage} alt=\"\" className=\"w-full h-full object-cover\" />\n        </div>\n      )}\n      <div className=\"bg-white m-4 rounded-lg p-6 space-y-6 border border-[#e5ddd0]\">\n        <div className=\"border-b border-[#e5ddd0] pb-4\">\n          <h2 className=\"text-2xl font-bold text-[#3d3428]\">{title || \"Untitled Form\"}</h2>\n          {description && <p className=\"text-[#6b5d4d] mt-2 leading-relaxed\">{description}</p>}\n        </div>\n\n        {visibleFields.map((field) => (\n          <div key={field.id} className=\"space-y-2\">\n            {field.type === 'heading' && (\n              <h3 className=\"text-lg font-semibold pt-4 border-t border-[#e5ddd0] text-[#3d3428]\">{field.label}</h3>\n            )}\n\n            {field.type === 'content' && (\n              <div className=\"py-3 px-4 bg-[#faf7f2] rounded-md border border-[#e5ddd0]\">\n                <h4 className=\"font-medium text-[#3d3428] mb-2\">{field.label}</h4>\n                <div className=\"text-[#6b5d4d] text-sm space-y-2\">\n                  {field.contentBlocks?.map((block, bi) => (\n                    <div key={bi}>\n                      {block.type === 'heading' && <h5 className=\"font-semibold text-[#3d3428]\">{block.text}</h5>}\n                      {block.type === 'paragraph' && <p>{block.text}</p>}\n                      {block.type === 'list' && (\n                        <ul className=\"list-disc pl-5 space-y-1\">\n                          {block.items?.map((item, ii) => <li key={ii}>{item}</li>)}\n                        </ul>\n                      )}\n                      {block.type === 'link' && (\n                        <a href={block.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#8b5a2b] underline hover:no-underline\">\n                          {block.linkText}\n                        </a>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {field.type === 'table' && (\n              <div>\n                <Label className=\"font-medium text-[#3d3428]\">{field.label}</Label>\n                {field.description && <p className=\"text-[#8b7355] text-sm mt-1\">{field.description}</p>}\n                <div className=\"border border-[#d4cbc0] rounded-md overflow-x-auto mt-2 bg-white\">\n                  <table className=\"w-full text-sm\">\n                    <thead className=\"bg-[#f5f0e8]\">\n                      <tr>\n                        {field.tableColumns?.map((col) => (\n                          <th key={col.id} className=\"p-3 text-left font-medium text-[#3d3428] border-r border-[#e5ddd0] last:border-r-0\">\n                            {col.header}\n                          </th>\n                        ))}\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {field.tableRows?.map((row, ri) => (\n                        <tr key={ri} className=\"border-t border-[#e5ddd0]\">\n                          {row.map((cell, ci) => (\n                            <td key={ci} className=\"p-3 text-[#5c4f3d] border-r border-[#e5ddd0] last:border-r-0\">\n                              {cell.value}\n                            </td>\n                          ))}\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              </div>\n            )}\n\n            {field.type !== 'heading' && field.type !== 'content' && field.type !== 'table' && (\n              <div>\n                <Label className=\"font-medium text-[#3d3428]\">\n                  {field.label}\n                  {field.required && <span className=\"text-red-600 ml-1\">*</span>}\n                </Label>\n                {field.description && (\n                  <p className=\"text-sm text-[#8b7355]\">{field.description}</p>\n                )}\n                <div className=\"mt-1.5\">\n                  {(field.type === 'text' || field.type === 'email' || field.type === 'number') && (\n                    <Input\n                      type={field.type}\n                      placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n                      value={String(formValues[field.id] || '')}\n                      onChange={(e) => setFormValues({ ...formValues, [field.id]: e.target.value })}\n                      className=\"border-[#d4cbc0] focus:border-[#8b7355] focus:ring-[#8b7355]\"\n                    />\n                  )}\n                  {field.type === 'textarea' && (\n                    <Textarea\n                      placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n                      value={String(formValues[field.id] || '')}\n                      onChange={(e) => setFormValues({ ...formValues, [field.id]: e.target.value })}\n                      className=\"border-[#d4cbc0] focus:border-[#8b7355] focus:ring-[#8b7355]\"\n                    />\n                  )}\n                  {field.type === 'date' && (\n                    <Input\n                      type=\"date\"\n                      value={String(formValues[field.id] || '')}\n                      onChange={(e) => setFormValues({ ...formValues, [field.id]: e.target.value })}\n                      className=\"border-[#d4cbc0] focus:border-[#8b7355] focus:ring-[#8b7355]\"\n                    />\n                  )}\n                  {field.type === 'single-select' && (\n                    <Select\n                      value={String(formValues[field.id] || '')}\n                      onValueChange={(val) => setFormValues({ ...formValues, [field.id]: val })}\n                    >\n                      <SelectTrigger className=\"border-[#d4cbc0]\">\n                        <SelectValue placeholder={field.placeholder || \"Choose one...\"} />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {field.options?.map((opt) => (\n                          <SelectItem key={opt} value={opt}>{opt}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  )}\n                  {field.type === 'multi-select' && (\n                    <div className=\"space-y-2\">\n                      {field.options?.map((opt) => {\n                        const selected = Array.isArray(formValues[field.id]) && formValues[field.id].includes(opt);\n                        return (\n                          <div key={opt} className=\"flex items-center gap-2\">\n                            <input\n                              type=\"checkbox\"\n                              checked={selected}\n                              onChange={(e) => {\n                                const current = Array.isArray(formValues[field.id]) ? formValues[field.id] as string[] : [];\n                                setFormValues({\n                                  ...formValues,\n                                  [field.id]: e.target.checked ? [...current, opt] : current.filter(v => v !== opt)\n                                });\n                              }}\n                              className=\"h-4 w-4 border-[#d4cbc0] accent-[#5c4f3d]\"\n                            />\n                            <span className=\"text-[#5c4f3d]\">{opt}</span>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n                  {field.type === 'file' && (\n                    <div className=\"border-2 border-dashed border-[#d4cbc0] rounded-lg p-6 text-center cursor-pointer hover:border-[#8b7355] hover:bg-[#faf7f2] transition-colors\">\n                      <Upload className=\"h-8 w-8 mx-auto mb-2 text-[#8b7355]\" />\n                      <p className=\"text-sm text-[#5c4f3d] font-medium\">Click to upload files</p>\n                      <p className=\"text-xs text-[#8b7355] mt-1\">Drag and drop or click to browse</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        ))}\n\n        <Button className=\"w-full bg-[#5c4f3d] hover:bg-[#4a3f31] text-white\" disabled>Submit (Preview Mode)</Button>\n      </div>\n    </div>\n  );\n}\n\nfunction SubmissionsDialog({ open, onOpenChange, form }: { open: boolean; onOpenChange: (open: boolean) => void; form: Form | null }) {\n  const { data: submissions, isLoading } = useFormSubmissions(form?.id);\n  const [selectedSubmission, setSelectedSubmission] = useState<any>(null);\n\n  if (!form) return null;\n\n  const handleDownloadPDF = (submission: any) => {\n    const doc = new jsPDF();\n    const pageWidth = doc.internal.pageSize.getWidth();\n    const margin = 20;\n    const maxWidth = pageWidth - margin * 2;\n    let yPos = 20;\n\n    doc.setFontSize(18);\n    doc.setFont('helvetica', 'bold');\n    doc.text(form.title, margin, yPos);\n    yPos += 12;\n\n    doc.setFontSize(10);\n    doc.setFont('helvetica', 'normal');\n    doc.setTextColor(100, 100, 100);\n    doc.text('Form Submission Report', margin, yPos);\n    yPos += 15;\n\n    doc.setDrawColor(200, 200, 200);\n    doc.line(margin, yPos, pageWidth - margin, yPos);\n    yPos += 10;\n\n    doc.setFontSize(11);\n    doc.setTextColor(60, 60, 60);\n    doc.setFont('helvetica', 'bold');\n    doc.text('Submitted By:', margin, yPos);\n    doc.setFont('helvetica', 'normal');\n    doc.text(submission.submitterName || 'Anonymous', margin + 35, yPos);\n    yPos += 7;\n\n    doc.setFont('helvetica', 'bold');\n    doc.text('Email:', margin, yPos);\n    doc.setFont('helvetica', 'normal');\n    doc.text(submission.submitterEmail || 'Not provided', margin + 35, yPos);\n    yPos += 7;\n\n    doc.setFont('helvetica', 'bold');\n    doc.text('Date:', margin, yPos);\n    doc.setFont('helvetica', 'normal');\n    doc.text(format(new Date(submission.createdAt), 'MMMM d, yyyy \\'at\\' h:mm a'), margin + 35, yPos);\n    yPos += 15;\n\n    doc.line(margin, yPos, pageWidth - margin, yPos);\n    yPos += 12;\n\n    doc.setFontSize(14);\n    doc.setFont('helvetica', 'bold');\n    doc.setTextColor(40, 40, 40);\n    doc.text('Responses', margin, yPos);\n    yPos += 10;\n\n    let attachmentCount = 0;\n    const attachments: { label: string; url: string; filename: string }[] = [];\n\n    submission.responses.forEach((resp: any) => {\n      const field = form.fields.find(f => f.id === resp.fieldId);\n      const isFile = field?.type === 'file';\n      \n      if (yPos > 260) {\n        doc.addPage();\n        yPos = 20;\n      }\n\n      doc.setFontSize(10);\n      doc.setFont('helvetica', 'bold');\n      doc.setTextColor(80, 80, 80);\n      doc.text(field?.label || resp.fieldId, margin, yPos);\n      yPos += 6;\n\n      doc.setFont('helvetica', 'normal');\n      doc.setTextColor(40, 40, 40);\n\n      if (isFile) {\n        const files = Array.isArray(resp.value) ? resp.value : [resp.value];\n        files.forEach((file: any) => {\n          if (file && (file.url || typeof file === 'string')) {\n            attachmentCount++;\n            const filename = file.filename || `Attachment ${attachmentCount}`;\n            const url = file.url || file;\n            attachments.push({ label: field?.label || 'File', url, filename });\n            doc.text(`[Attachment ${attachmentCount}] ${filename}`, margin + 5, yPos);\n            yPos += 5;\n          }\n        });\n      } else {\n        const value = Array.isArray(resp.value) ? resp.value.join(', ') : String(resp.value || 'No response');\n        const lines = doc.splitTextToSize(value, maxWidth - 5);\n        lines.forEach((line: string) => {\n          if (yPos > 280) {\n            doc.addPage();\n            yPos = 20;\n          }\n          doc.text(line, margin + 5, yPos);\n          yPos += 5;\n        });\n      }\n      yPos += 8;\n    });\n\n    if (attachments.length > 0) {\n      if (yPos > 240) {\n        doc.addPage();\n        yPos = 20;\n      }\n      yPos += 5;\n      doc.line(margin, yPos, pageWidth - margin, yPos);\n      yPos += 10;\n\n      doc.setFontSize(12);\n      doc.setFont('helvetica', 'bold');\n      doc.text('File Attachments', margin, yPos);\n      yPos += 8;\n\n      doc.setFontSize(9);\n      doc.setFont('helvetica', 'normal');\n      doc.setTextColor(60, 60, 60);\n      attachments.forEach((att, i) => {\n        if (yPos > 280) {\n          doc.addPage();\n          yPos = 20;\n        }\n        doc.text(`${i + 1}. ${att.filename}`, margin, yPos);\n        yPos += 4;\n        doc.setTextColor(0, 100, 200);\n        const urlLines = doc.splitTextToSize(att.url, maxWidth - 10);\n        urlLines.forEach((line: string) => {\n          doc.text(line, margin + 5, yPos);\n          yPos += 4;\n        });\n        doc.setTextColor(60, 60, 60);\n        yPos += 3;\n      });\n    }\n\n    const filename = `${form.title.replace(/[^a-z0-9]/gi, '_')}_${submission.submitterName?.replace(/[^a-z0-9]/gi, '_') || 'submission'}.pdf`;\n    doc.save(filename);\n    toast.success('PDF downloaded successfully');\n  };\n\n  const renderFileValue = (value: any) => {\n    if (!value) return null;\n    \n    if (typeof value === 'object' && value.url) {\n      return (\n        <a \n          href={value.url} \n          target=\"_blank\" \n          rel=\"noopener noreferrer\"\n          className=\"inline-flex items-center gap-2 px-3 py-2 bg-muted hover:bg-accent text-foreground rounded-lg transition-colors\"\n        >\n          <Paperclip className=\"h-4 w-4\" />\n          <span className=\"font-medium\">{value.filename || 'View attachment'}</span>\n          <ExternalLink className=\"h-3 w-3 ml-1\" />\n        </a>\n      );\n    }\n    \n    if (Array.isArray(value)) {\n      return (\n        <div className=\"flex flex-wrap gap-2\">\n          {value.map((file: any, idx: number) => (\n            <a \n              key={idx}\n              href={file.url || file} \n              target=\"_blank\" \n              rel=\"noopener noreferrer\"\n              className=\"inline-flex items-center gap-2 px-3 py-2 bg-muted hover:bg-accent text-foreground rounded-lg transition-colors\"\n            >\n              <Paperclip className=\"h-4 w-4\" />\n              <span className=\"font-medium\">{file.filename || `File ${idx + 1}`}</span>\n              <ExternalLink className=\"h-3 w-3 ml-1\" />\n            </a>\n          ))}\n        </div>\n      );\n    }\n    \n    return String(value);\n  };\n\n  const renderResponseValue = (field: FormField | undefined, value: any) => {\n    if (!value && value !== 0) return <span className=\"text-muted-foreground italic\">No response</span>;\n    \n    if (field?.type === 'file') {\n      return renderFileValue(value);\n    }\n    \n    if (field?.type === 'multi-select' && Array.isArray(value)) {\n      return (\n        <div className=\"flex flex-wrap gap-2\">\n          {value.map((item: string, idx: number) => (\n            <Badge key={idx} variant=\"secondary\">\n              {item}\n            </Badge>\n          ))}\n        </div>\n      );\n    }\n    \n    if (field?.type === 'single-select') {\n      return (\n        <Badge variant=\"secondary\">\n          {String(value)}\n        </Badge>\n      );\n    }\n    \n    if (field?.type === 'date') {\n      try {\n        return <span className=\"text-foreground\">{format(new Date(value), 'MMMM d, yyyy')}</span>;\n      } catch {\n        return <span className=\"text-foreground\">{String(value)}</span>;\n      }\n    }\n    \n    return (\n      <p className=\"text-foreground whitespace-pre-wrap leading-relaxed\">\n        {Array.isArray(value) ? value.join(', ') : String(value)}\n      </p>\n    );\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => { onOpenChange(open); if (!open) setSelectedSubmission(null); }}>\n      <DialogContent className=\"max-w-4xl max-h-[85vh] flex flex-col\">\n        <DialogHeader>\n          {selectedSubmission ? (\n            <div className=\"flex items-center gap-3\">\n              <Button variant=\"ghost\" size=\"sm\" onClick={() => setSelectedSubmission(null)} data-testid=\"button-back-submissions\">\n                <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                Back\n              </Button>\n              <Separator orientation=\"vertical\" className=\"h-6\" />\n              <div>\n                <DialogTitle>Submission Details</DialogTitle>\n                <DialogDescription>\n                  View complete form responses\n                </DialogDescription>\n              </div>\n            </div>\n          ) : (\n            <>\n              <DialogTitle>Submissions for \"{form.title}\"</DialogTitle>\n              <DialogDescription>\n                {submissions?.length || 0} response{submissions?.length !== 1 ? 's' : ''} received\n              </DialogDescription>\n            </>\n          )}\n        </DialogHeader>\n        \n        <ScrollArea className=\"flex-1 pr-4\">\n          {selectedSubmission ? (\n            <div className=\"py-4 space-y-6\">\n              <div className=\"bg-gradient-to-r from-muted to-muted/50 rounded-xl p-6 border border-border\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"w-12 h-12 rounded-full bg-primary flex items-center justify-center\">\n                      <User className=\"h-6 w-6 text-primary-foreground\" />\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-semibold text-foreground\">\n                        {selectedSubmission.submitterName || 'Anonymous'}\n                      </h3>\n                      <p className=\"text-muted-foreground\">{selectedSubmission.submitterEmail || 'No email provided'}</p>\n                      <div className=\"flex items-center gap-2 mt-2 text-sm text-muted-foreground\">\n                        <Clock className=\"h-4 w-4\" />\n                        <span>{format(new Date(selectedSubmission.createdAt), 'MMMM d, yyyy \\'at\\' h:mm a')}</span>\n                      </div>\n                    </div>\n                  </div>\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={() => handleDownloadPDF(selectedSubmission)} \n                    data-testid=\"button-download-submission-detail\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Download PDF\n                  </Button>\n                </div>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <h4 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wide\">Form Responses</h4>\n                \n                <div className=\"grid gap-4\">\n                  {selectedSubmission.responses.map((resp: any, i: number) => {\n                    const field = form.fields.find(f => f.id === resp.fieldId);\n                    \n                    return (\n                      <div \n                        key={i} \n                        className=\"bg-card border border-border rounded-xl p-5 hover:shadow-sm transition-shadow\"\n                        data-testid={`response-field-${i}`}\n                      >\n                        <div className=\"flex items-start gap-3\">\n                          <div className=\"w-8 h-8 rounded-lg bg-muted flex items-center justify-center flex-shrink-0 mt-0.5\">\n                            <span className=\"text-sm font-semibold text-muted-foreground\">{i + 1}</span>\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <Label className=\"text-sm font-medium text-muted-foreground block mb-2\">\n                              {field?.label || resp.fieldId}\n                            </Label>\n                            <div className=\"mt-1\">\n                              {renderResponseValue(field, resp.value)}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n          ) : isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"text-center\">\n                <div className=\"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-3\"></div>\n                <p className=\"text-muted-foreground\">Loading submissions...</p>\n              </div>\n            </div>\n          ) : submissions && submissions.length > 0 ? (\n            <div className=\"space-y-3 py-4\">\n              {submissions.map((sub) => (\n                <Card \n                  key={sub.id} \n                  className=\"cursor-pointer hover:shadow-md hover:border-primary/50 transition-all\"\n                  onClick={() => setSelectedSubmission(sub)}\n                  data-testid={`card-submission-${sub.id}`}\n                >\n                  <CardContent className=\"py-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                          <User className=\"h-5 w-5 text-muted-foreground\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium text-foreground\">{sub.submitterName || 'Anonymous'}</p>\n                          <p className=\"text-sm text-muted-foreground\">{sub.submitterEmail || 'No email'}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            {format(new Date(sub.createdAt), 'MMM d, yyyy')}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground/70\">\n                            {format(new Date(sub.createdAt), 'h:mm a')}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={(e) => { e.stopPropagation(); setSelectedSubmission(sub); }}\n                            data-testid={`button-view-submission-${sub.id}`}\n                          >\n                            <Eye className=\"h-4 w-4 mr-1\" />\n                            View\n                          </Button>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\"\n                            onClick={(e) => { e.stopPropagation(); handleDownloadPDF(sub); }}\n                            data-testid={`button-download-submission-${sub.id}`}\n                          >\n                            <Download className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-16\">\n              <div className=\"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4\">\n                <FileText className=\"h-8 w-8 text-muted-foreground\" />\n              </div>\n              <h3 className=\"text-lg font-medium text-foreground mb-2\">No submissions yet</h3>\n              <p className=\"text-muted-foreground\">Share this form to start collecting responses</p>\n            </div>\n          )}\n        </ScrollArea>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":71498,"size_tokens":null},"client/src/pages/shared/PublicForm.tsx":{"content":"import { useState, useMemo, useRef } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { usePublicForm, useSubmitPublicForm, type FormField } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { toast } from \"sonner\";\nimport { CheckCircle2, FileText, Send, Upload, X, File, Loader2 } from \"lucide-react\";\n\nexport default function PublicForm() {\n  const params = useParams<{ shareToken: string }>();\n  const shareToken = params.shareToken;\n  const { data: form, isLoading, error } = usePublicForm(shareToken);\n  const submitForm = useSubmitPublicForm();\n  const [, setLocation] = useLocation();\n\n  const [responses, setResponses] = useState<Record<string, any>>({});\n  const [submitterName, setSubmitterName] = useState(\"\");\n  const [submitterEmail, setSubmitterEmail] = useState(\"\");\n  const [submitted, setSubmitted] = useState(false);\n\n  const updateResponse = (fieldId: string, value: any) => {\n    setResponses(prev => ({ ...prev, [fieldId]: value }));\n  };\n\n  const shouldShowField = (field: FormField): boolean => {\n    if (!field.showWhen) return true;\n    const triggerValue = responses[field.showWhen.fieldId];\n    const conditionValue = field.showWhen.value;\n    \n    switch (field.showWhen.operator) {\n      case 'equals':\n        return triggerValue === conditionValue || (Array.isArray(triggerValue) && triggerValue.includes(conditionValue));\n      case 'not_equals':\n        return triggerValue !== conditionValue && (!Array.isArray(triggerValue) || !triggerValue.includes(conditionValue));\n      case 'contains':\n        return Array.isArray(triggerValue) ? triggerValue.includes(conditionValue) : String(triggerValue || '').includes(conditionValue);\n      default:\n        return true;\n    }\n  };\n\n  const visibleFields = useMemo(() => {\n    return (form?.fields || []).filter(shouldShowField);\n  }, [form?.fields, responses]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    const requiredFields = visibleFields.filter(f => f.required && f.type !== 'heading' && f.type !== 'content' && f.type !== 'table');\n    for (const field of requiredFields) {\n      const value = responses[field.id];\n      if (!value || (Array.isArray(value) && value.length === 0)) {\n        toast.error(`Please fill in \"${field.label}\"`);\n        return;\n      }\n    }\n\n    try {\n      const responseArray = Object.entries(responses).map(([fieldId, value]) => ({\n        fieldId,\n        value,\n      }));\n\n      await submitForm.mutateAsync({\n        shareToken: shareToken!,\n        responses: responseArray,\n        submitterName: submitterName || undefined,\n        submitterEmail: submitterEmail || undefined,\n      });\n\n      setSubmitted(true);\n      toast.success(\"Form submitted successfully\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-[#f5f0e8] flex items-center justify-center\">\n        <div className=\"flex items-center gap-2 text-[#5c4f3d]\">\n          <Loader2 className=\"h-5 w-5 animate-spin\" />\n          <span>Loading form...</span>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !form) {\n    return (\n      <div className=\"min-h-screen bg-[#f5f0e8] flex items-center justify-center\">\n        <div className=\"max-w-md w-full mx-4 bg-white rounded-lg shadow-sm border border-[#e5ddd0] p-8 text-center\">\n          <FileText className=\"h-12 w-12 mx-auto mb-4 text-[#8b7355]\" />\n          <h2 className=\"text-xl font-semibold mb-2 text-[#3d3428]\">Form Not Found</h2>\n          <p className=\"text-[#6b5d4d]\">This form may have been removed or the link is invalid.</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (submitted) {\n    return (\n      <div className=\"min-h-screen bg-[#f5f0e8] flex items-center justify-center p-4\">\n        <div className=\"max-w-md w-full bg-white rounded-lg shadow-sm border border-[#e5ddd0] p-12 text-center\">\n          <CheckCircle2 className=\"h-16 w-16 mx-auto mb-4 text-green-600\" />\n          <h2 className=\"text-2xl font-semibold mb-2 text-[#3d3428]\">Thank You!</h2>\n          <p className=\"text-[#6b5d4d]\">Your response has been submitted successfully.</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-[#f5f0e8] py-8 px-4\">\n      <div className=\"max-w-2xl mx-auto\">\n        {form.coverImage && (\n          <div className=\"h-20 rounded-t-lg overflow-hidden mb-0\">\n            <img src={form.coverImage} alt=\"\" className=\"w-full h-full object-cover\" />\n          </div>\n        )}\n        \n        <div className={`bg-white shadow-sm border border-[#e5ddd0] ${form.coverImage ? 'rounded-b-lg' : 'rounded-lg'}`}>\n          <div className=\"p-8 border-b border-[#e5ddd0]\">\n            <h1 className=\"text-2xl font-bold text-[#3d3428]\" data-testid=\"form-title\">{form.title}</h1>\n            {form.description && (\n              <p className=\"text-[#6b5d4d] mt-3 leading-relaxed\">{form.description}</p>\n            )}\n          </div>\n          \n          <div className=\"p-8\">\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <div>\n                  <Label htmlFor=\"submitter-name\" className=\"text-[#3d3428] font-medium\">Your Name (optional)</Label>\n                  <Input\n                    id=\"submitter-name\"\n                    value={submitterName}\n                    onChange={(e) => setSubmitterName(e.target.value)}\n                    placeholder=\"Enter your name\"\n                    className=\"mt-1.5 border-[#d4cbc0] bg-white text-[#3d3428] focus:border-[#8b7355] focus:ring-[#8b7355]\"\n                    data-testid=\"input-submitter-name\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"submitter-email\" className=\"text-[#3d3428] font-medium\">Your Email (optional)</Label>\n                  <Input\n                    id=\"submitter-email\"\n                    type=\"email\"\n                    value={submitterEmail}\n                    onChange={(e) => setSubmitterEmail(e.target.value)}\n                    placeholder=\"Enter your email\"\n                    className=\"mt-1.5 border-[#d4cbc0] bg-white text-[#3d3428] focus:border-[#8b7355] focus:ring-[#8b7355]\"\n                    data-testid=\"input-submitter-email\"\n                  />\n                </div>\n              </div>\n\n              {visibleFields.map((field) => (\n                <FieldRenderer\n                  key={field.id}\n                  field={field}\n                  value={responses[field.id]}\n                  onChange={(value) => updateResponse(field.id, value)}\n                  shareToken={shareToken}\n                />\n              ))}\n\n              <Button\n                type=\"submit\"\n                className=\"w-full bg-[#5c4f3d] hover:bg-[#4a3f31] text-white\"\n                size=\"lg\"\n                disabled={submitForm.isPending}\n                data-testid=\"button-submit-form\"\n              >\n                {submitForm.isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Submitting...\n                  </>\n                ) : (\n                  <>\n                    <Send className=\"h-4 w-4 mr-2\" />\n                    Submit\n                  </>\n                )}\n              </Button>\n            </form>\n          </div>\n        </div>\n\n        <p className=\"text-center text-sm text-[#8b7355] mt-6\">\n          Powered by Kronos\n        </p>\n      </div>\n    </div>\n  );\n}\n\ninterface UploadedFileData {\n  name: string;\n  size: number;\n  type: string;\n  objectPath: string; // Storage path reference\n}\n\nfunction FieldRenderer({ field, value, onChange, shareToken }: { field: FormField; value: any; onChange: (value: any) => void; shareToken?: string }) {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [uploadedFiles, setUploadedFiles] = useState<UploadedFileData[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n\n  if (field.type === 'heading') {\n    return (\n      <div className=\"pt-6 border-t border-[#e5ddd0]\">\n        <h3 className=\"text-lg font-semibold text-[#3d3428]\" data-testid={`heading-${field.id}`}>{field.label}</h3>\n        {field.description && <p className=\"text-[#6b5d4d] text-sm mt-1\">{field.description}</p>}\n      </div>\n    );\n  }\n\n  if (field.type === 'content') {\n    return (\n      <div className=\"py-3 px-4 bg-[#faf7f2] rounded-md border border-[#e5ddd0]\">\n        <h4 className=\"font-medium text-[#3d3428] mb-2\">{field.label}</h4>\n        <div className=\"text-[#6b5d4d] text-sm space-y-2\">\n          {field.contentBlocks?.map((block, bi) => (\n            <div key={bi}>\n              {block.type === 'heading' && <h5 className=\"font-semibold text-[#3d3428]\">{block.text}</h5>}\n              {block.type === 'paragraph' && <p>{block.text}</p>}\n              {block.type === 'list' && (\n                <ul className=\"list-disc pl-5 space-y-1\">\n                  {block.items?.map((item, ii) => <li key={ii}>{item}</li>)}\n                </ul>\n              )}\n              {block.type === 'link' && (\n                <a href={block.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#8b5a2b] underline hover:no-underline\">\n                  {block.linkText}\n                </a>\n              )}\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  if (field.type === 'table') {\n    return (\n      <div className=\"py-2\">\n        <Label className=\"font-medium text-[#3d3428]\">{field.label}</Label>\n        {field.description && <p className=\"text-[#6b5d4d] text-sm mt-1 mb-2\">{field.description}</p>}\n        <div className=\"border border-[#d4cbc0] rounded-md overflow-x-auto mt-2 bg-white\">\n          <table className=\"w-full text-sm\">\n            <thead className=\"bg-[#f5f0e8]\">\n              <tr>\n                {field.tableColumns?.map((col) => (\n                  <th key={col.id} className=\"p-3 text-left font-medium text-[#3d3428] border-r border-[#e5ddd0] last:border-r-0\">\n                    {col.header}\n                  </th>\n                ))}\n              </tr>\n            </thead>\n            <tbody>\n              {field.tableRows?.map((row, ri) => (\n                <tr key={ri} className=\"border-t border-[#e5ddd0]\">\n                  {row.map((cell, ci) => (\n                    <td key={ci} className=\"p-3 text-[#5c4f3d] border-r border-[#e5ddd0] last:border-r-0\">\n                      {cell.value}\n                    </td>\n                  ))}\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    );\n  }\n\n  const labelElement = (\n    <Label htmlFor={field.id} className=\"flex items-center gap-1 text-[#3d3428] font-medium\">\n      {field.label}\n      {field.required && <span className=\"text-red-600\">*</span>}\n    </Label>\n  );\n\n  const descriptionElement = field.description ? (\n    <p className=\"text-sm text-[#8b7355] mt-1\">{field.description}</p>\n  ) : null;\n\n  const inputClassName = \"mt-1.5 border-[#d4cbc0] bg-white text-[#3d3428] focus:border-[#8b7355] focus:ring-[#8b7355]\";\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0 || !shareToken) return;\n\n    setIsUploading(true);\n    const newFiles: UploadedFileData[] = [];\n    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB limit per file\n    \n    for (const file of Array.from(files)) {\n      if (file.size > MAX_FILE_SIZE) {\n        console.warn(`File ${file.name} exceeds 10MB limit, skipping`);\n        continue;\n      }\n      \n      try {\n        // Get presigned URL from server\n        const urlResponse = await fetch(`/api/public/forms/${shareToken}/upload`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ \n            filename: file.name,\n            size: file.size,\n            type: file.type \n          }),\n        });\n        \n        if (!urlResponse.ok) {\n          const error = await urlResponse.json();\n          throw new Error(error.error || 'Failed to get upload URL');\n        }\n        \n        const { uploadURL, objectPath } = await urlResponse.json();\n        \n        // Upload file to object storage\n        await new Promise<void>((resolve, reject) => {\n          const xhr = new XMLHttpRequest();\n          xhr.addEventListener('load', () => {\n            if (xhr.status >= 200 && xhr.status < 300) {\n              resolve();\n            } else {\n              reject(new Error(`Upload failed with status ${xhr.status}`));\n            }\n          });\n          xhr.addEventListener('error', () => reject(new Error('Upload failed')));\n          xhr.open('PUT', uploadURL);\n          xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');\n          xhr.send(file);\n        });\n        \n        // Confirm upload\n        await fetch(`/api/public/forms/${shareToken}/upload/confirm`, {\n          method: 'PUT',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ objectPath, filename: file.name, size: file.size, type: file.type }),\n        });\n        \n        newFiles.push({\n          name: file.name,\n          size: file.size,\n          type: file.type,\n          objectPath\n        });\n      } catch (error: any) {\n        console.error(`Failed to upload file ${file.name}:`, error);\n      }\n    }\n    \n    const allFiles = [...uploadedFiles, ...newFiles];\n    setUploadedFiles(allFiles);\n    // Store file references (not content) in the form value\n    onChange(allFiles);\n    setIsUploading(false);\n    \n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  };\n\n  const removeFile = (fileName: string) => {\n    const updatedFiles = uploadedFiles.filter(f => f.name !== fileName);\n    setUploadedFiles(updatedFiles);\n    onChange(updatedFiles);\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return bytes + ' B';\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\n  };\n\n  switch (field.type) {\n    case 'text':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Input\n            id={field.id}\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n            className={inputClassName}\n            data-testid={`input-${field.id}`}\n          />\n        </div>\n      );\n\n    case 'textarea':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Textarea\n            id={field.id}\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            placeholder={field.placeholder || `Enter ${field.label.toLowerCase()}`}\n            className={inputClassName}\n            rows={4}\n            data-testid={`input-${field.id}`}\n          />\n        </div>\n      );\n\n    case 'email':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Input\n            id={field.id}\n            type=\"email\"\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            placeholder={field.placeholder || \"Enter email address\"}\n            className={inputClassName}\n            data-testid={`input-${field.id}`}\n          />\n        </div>\n      );\n\n    case 'number':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Input\n            id={field.id}\n            type=\"number\"\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            placeholder={field.placeholder || \"Enter number\"}\n            className={inputClassName}\n            data-testid={`input-${field.id}`}\n          />\n        </div>\n      );\n\n    case 'date':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Input\n            id={field.id}\n            type=\"date\"\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            className={inputClassName}\n            data-testid={`input-${field.id}`}\n          />\n        </div>\n      );\n\n    case 'single-select':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <Select value={value || ''} onValueChange={onChange}>\n            <SelectTrigger className={`mt-1.5 border-[#d4cbc0] bg-white ${value ? '' : 'text-[#8b7355]'}`} data-testid={`select-${field.id}`}>\n              <SelectValue placeholder={field.placeholder || \"Choose one...\"} />\n            </SelectTrigger>\n            <SelectContent>\n              {field.options?.map((opt) => (\n                <SelectItem key={opt} value={opt}>{opt}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      );\n\n    case 'multi-select':\n      const selected = Array.isArray(value) ? value : [];\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <div className=\"space-y-2 mt-2\">\n            {field.options?.map((opt) => (\n              <div key={opt} className=\"flex items-center gap-2\">\n                <Checkbox\n                  id={`${field.id}-${opt}`}\n                  checked={selected.includes(opt)}\n                  onCheckedChange={(checked) => {\n                    if (checked) {\n                      onChange([...selected, opt]);\n                    } else {\n                      onChange(selected.filter((s: string) => s !== opt));\n                    }\n                  }}\n                  className=\"border-[#d4cbc0] data-[state=checked]:bg-[#5c4f3d] data-[state=checked]:border-[#5c4f3d]\"\n                  data-testid={`checkbox-${field.id}-${opt}`}\n                />\n                <Label htmlFor={`${field.id}-${opt}`} className=\"font-normal text-[#5c4f3d]\">{opt}</Label>\n              </div>\n            ))}\n          </div>\n        </div>\n      );\n\n    case 'file':\n      return (\n        <div>\n          {labelElement}\n          {descriptionElement}\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            multiple\n            onChange={handleFileSelect}\n            className=\"hidden\"\n            data-testid={`file-input-${field.id}`}\n          />\n          <div \n            className=\"border-2 border-dashed border-[#d4cbc0] rounded-lg p-6 text-center mt-1.5 cursor-pointer hover:border-[#8b7355] hover:bg-[#faf7f2] transition-colors\"\n            onClick={() => fileInputRef.current?.click()}\n          >\n            {isUploading ? (\n              <Loader2 className=\"h-8 w-8 mx-auto mb-2 text-[#8b7355] animate-spin\" />\n            ) : (\n              <Upload className=\"h-8 w-8 mx-auto mb-2 text-[#8b7355]\" />\n            )}\n            <p className=\"text-sm text-[#5c4f3d] font-medium\">\n              {isUploading ? 'Uploading...' : 'Click to upload files'}\n            </p>\n            <p className=\"text-xs text-[#8b7355] mt-1\">Drag and drop or click to browse</p>\n          </div>\n          {uploadedFiles.length > 0 && (\n            <div className=\"mt-3 space-y-2\">\n              {uploadedFiles.map((file, index) => (\n                <div key={index} className=\"flex items-center justify-between p-2 bg-[#faf7f2] rounded border border-[#e5ddd0]\">\n                  <div className=\"flex items-center gap-2\">\n                    <File className=\"h-4 w-4 text-[#8b7355]\" />\n                    <span className=\"text-sm text-[#5c4f3d]\">{file.name}</span>\n                    <span className=\"text-xs text-[#8b7355]\">({formatFileSize(file.size)})</span>\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"h-6 w-6 p-0 text-[#8b7355] hover:text-red-600\"\n                    onClick={() => removeFile(file.name)}\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      );\n\n    default:\n      return null;\n  }\n}\n","path":null,"size_bytes":20761,"size_tokens":null},"client/src/pages/shared/TaskTemplates.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useTaskTemplates, useCreateTaskTemplate, useUpdateTaskTemplate, useDeleteTaskTemplate, useApplyTaskTemplate, useUsers, useCurrentUser, type TaskTemplate, type TemplateSection, type TemplateTask } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { toast } from \"sonner\";\nimport { Plus, FileText, Trash2, Edit, Copy, GripVertical, X, Search, ChevronDown, ChevronRight, Calendar, User, Clock, ListTodo, Play, LayoutTemplate, FolderOpen } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { format } from \"date-fns\";\n\nconst CATEGORIES = [\n  { value: 'HR', label: 'Human Resources' },\n  { value: 'Onboarding', label: 'Employee Onboarding' },\n  { value: 'Offboarding', label: 'Employee Offboarding' },\n  { value: 'Project', label: 'Project Management' },\n  { value: 'General', label: 'General' },\n];\n\nfunction generateId() {\n  return crypto.randomUUID();\n}\n\nexport default function TaskTemplates() {\n  const [location] = useLocation();\n  const role: 'CEO' | 'Employee' = location.startsWith('/ceo') ? 'CEO' : 'Employee';\n  \n  const { data: currentUser } = useCurrentUser();\n  const { data: templates, isLoading } = useTaskTemplates();\n  const { data: users } = useUsers();\n  const createTemplate = useCreateTaskTemplate();\n  const updateTemplate = useUpdateTaskTemplate();\n  const deleteTemplate = useDeleteTaskTemplate();\n  const applyTemplate = useApplyTaskTemplate();\n\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showApplyDialog, setShowApplyDialog] = useState(false);\n  const [selectedTemplate, setSelectedTemplate] = useState<TaskTemplate | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n\n  const [editingName, setEditingName] = useState(\"\");\n  const [editingDescription, setEditingDescription] = useState(\"\");\n  const [editingCategory, setEditingCategory] = useState(\"HR\");\n  const [editingSections, setEditingSections] = useState<TemplateSection[]>([]);\n  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set());\n\n  const [applyStartDate, setApplyStartDate] = useState(format(new Date(), 'yyyy-MM-dd'));\n  const [applyContextName, setApplyContextName] = useState(\"\");\n  const [assigneeOverrides, setAssigneeOverrides] = useState<Record<string, string>>({});\n\n  const isTemplateAdmin = currentUser?.name?.toLowerCase().includes('dimitra') || \n                          currentUser?.email?.toLowerCase().includes('dimitra') ||\n                          currentUser?.name?.toLowerCase().includes('charles') || \n                          currentUser?.email?.toLowerCase().includes('charles');\n\n  const filteredTemplates = useMemo(() => {\n    if (!templates) return [];\n    let result = templates;\n    if (categoryFilter !== \"all\") {\n      result = result.filter(t => t.category === categoryFilter);\n    }\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter(t => \n        t.name.toLowerCase().includes(query) ||\n        (t.description && t.description.toLowerCase().includes(query))\n      );\n    }\n    return result;\n  }, [templates, categoryFilter, searchQuery]);\n\n  const handleCreateTemplate = async () => {\n    if (!editingName.trim()) {\n      toast.error(\"Please enter a template name\");\n      return;\n    }\n    try {\n      const template = await createTemplate.mutateAsync({\n        name: editingName,\n        description: editingDescription || undefined,\n        category: editingCategory,\n        sections: editingSections,\n      });\n      toast.success(\"Template created successfully\");\n      setShowCreateDialog(false);\n      resetEditingState();\n      setSelectedTemplate(template);\n      setEditingName(template.name);\n      setEditingDescription(template.description || \"\");\n      setEditingCategory(template.category);\n      setEditingSections(template.sections || []);\n      setShowEditDialog(true);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const resetEditingState = () => {\n    setEditingName(\"\");\n    setEditingDescription(\"\");\n    setEditingCategory(\"HR\");\n    setEditingSections([]);\n    setExpandedSections(new Set());\n  };\n\n  const handleOpenEdit = (template: TaskTemplate) => {\n    setSelectedTemplate(template);\n    setEditingName(template.name);\n    setEditingDescription(template.description || \"\");\n    setEditingCategory(template.category);\n    setEditingSections(template.sections || []);\n    const allSectionIds = new Set(template.sections?.map(s => s.id) || []);\n    setExpandedSections(allSectionIds);\n    setShowEditDialog(true);\n  };\n\n  const handleSaveTemplate = async () => {\n    if (!selectedTemplate) return;\n    try {\n      await updateTemplate.mutateAsync({\n        id: selectedTemplate.id,\n        name: editingName,\n        description: editingDescription,\n        category: editingCategory,\n        sections: editingSections,\n      });\n      toast.success(\"Template saved successfully\");\n      setShowEditDialog(false);\n      resetEditingState();\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleDeleteTemplate = async (template: TaskTemplate) => {\n    if (!confirm(`Are you sure you want to delete \"${template.name}\"?`)) return;\n    try {\n      await deleteTemplate.mutateAsync(template.id);\n      toast.success(\"Template deleted\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleOpenApply = (template: TaskTemplate) => {\n    setSelectedTemplate(template);\n    setApplyStartDate(format(new Date(), 'yyyy-MM-dd'));\n    setApplyContextName(\"\");\n    setAssigneeOverrides({});\n    setShowApplyDialog(true);\n  };\n\n  const handleApplyTemplate = async () => {\n    if (!selectedTemplate) return;\n    try {\n      const result = await applyTemplate.mutateAsync({\n        id: selectedTemplate.id,\n        startDate: applyStartDate,\n        contextType: selectedTemplate.category,\n        contextName: applyContextName || undefined,\n        assigneeOverrides: Object.keys(assigneeOverrides).length > 0 ? assigneeOverrides : undefined,\n      });\n      toast.success(`Created ${result.tasksCreated} tasks from template`);\n      setShowApplyDialog(false);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const handleDuplicateTemplate = async (template: TaskTemplate) => {\n    try {\n      await createTemplate.mutateAsync({\n        name: `${template.name} (Copy)`,\n        description: template.description || undefined,\n        category: template.category,\n        sections: template.sections,\n      });\n      toast.success(\"Template duplicated\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n\n  const addSection = () => {\n    const newSection: TemplateSection = {\n      id: generateId(),\n      title: \"New Section\",\n      position: editingSections.length,\n      tasks: [],\n    };\n    setEditingSections([...editingSections, newSection]);\n    setExpandedSections(prev => {\n      const next = new Set(prev);\n      next.add(newSection.id);\n      return next;\n    });\n  };\n\n  const updateSection = (sectionId: string, updates: Partial<TemplateSection>) => {\n    setEditingSections(editingSections.map(s => \n      s.id === sectionId ? { ...s, ...updates } : s\n    ));\n  };\n\n  const deleteSection = (sectionId: string) => {\n    setEditingSections(editingSections.filter(s => s.id !== sectionId));\n  };\n\n  const addTask = (sectionId: string) => {\n    const section = editingSections.find(s => s.id === sectionId);\n    if (!section) return;\n    const newTask: TemplateTask = {\n      id: generateId(),\n      title: \"New Task\",\n      position: section.tasks.length,\n    };\n    updateSection(sectionId, { tasks: [...section.tasks, newTask] });\n  };\n\n  const updateTask = (sectionId: string, taskId: string, updates: Partial<TemplateTask>) => {\n    const section = editingSections.find(s => s.id === sectionId);\n    if (!section) return;\n    const updatedTasks = section.tasks.map(t =>\n      t.id === taskId ? { ...t, ...updates } : t\n    );\n    updateSection(sectionId, { tasks: updatedTasks });\n  };\n\n  const deleteTask = (sectionId: string, taskId: string) => {\n    const section = editingSections.find(s => s.id === sectionId);\n    if (!section) return;\n    updateSection(sectionId, { tasks: section.tasks.filter(t => t.id !== taskId) });\n  };\n\n  const toggleSection = (sectionId: string) => {\n    setExpandedSections(prev => {\n      const next = new Set(prev);\n      if (next.has(sectionId)) {\n        next.delete(sectionId);\n      } else {\n        next.add(sectionId);\n      }\n      return next;\n    });\n  };\n\n  const getUserName = (userId: string | undefined) => {\n    if (!userId || !users) return \"Unassigned\";\n    const user = users.find(u => u.id === userId);\n    return user?.name || \"Unknown User\";\n  };\n\n  const totalTaskCount = (sections: TemplateSection[]) => {\n    return sections.reduce((acc, s) => acc + s.tasks.length, 0);\n  };\n\n  if (!isTemplateAdmin) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-[60vh]\">\n          <Card className=\"max-w-md\">\n            <CardHeader>\n              <CardTitle>Access Restricted</CardTitle>\n              <CardDescription>\n                Task templates are only available to HR administrators.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n        </div>\n      </Layout>\n    );\n  }\n\n  return (\n    <Layout role={role}>\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-foreground flex items-center gap-2\" data-testid=\"text-page-title\">\n              <LayoutTemplate className=\"h-6 w-6 text-primary\" />\n              Task Templates\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">Create reusable task templates for HR workflows</p>\n          </div>\n          <Button onClick={() => { resetEditingState(); setShowCreateDialog(true); }} data-testid=\"button-create-template\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            New Template\n          </Button>\n        </div>\n\n        <div className=\"flex gap-4 items-center\">\n          <div className=\"relative flex-1 max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search templates...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-templates\"\n            />\n          </div>\n          <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n            <SelectTrigger className=\"w-48\" data-testid=\"select-category-filter\">\n              <SelectValue placeholder=\"All Categories\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Categories</SelectItem>\n              {CATEGORIES.map(cat => (\n                <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {isLoading ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {[1, 2, 3].map(i => (\n              <Card key={i} className=\"animate-pulse\">\n                <CardHeader>\n                  <div className=\"h-5 bg-muted rounded w-3/4\" />\n                  <div className=\"h-4 bg-muted rounded w-1/2 mt-2\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"h-4 bg-muted rounded w-full\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : filteredTemplates.length === 0 ? (\n          <Card className=\"border-dashed\">\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <FolderOpen className=\"h-12 w-12 text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">No Templates Found</h3>\n              <p className=\"text-muted-foreground text-center mb-4\">\n                {searchQuery || categoryFilter !== \"all\" \n                  ? \"Try adjusting your search or filters\"\n                  : \"Create your first task template to get started\"\n                }\n              </p>\n              {!searchQuery && categoryFilter === \"all\" && (\n                <Button onClick={() => { resetEditingState(); setShowCreateDialog(true); }}>\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Create Template\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {filteredTemplates.map(template => (\n              <Card key={template.id} className=\"group hover:border-primary/50 transition-colors\" data-testid={`card-template-${template.id}`}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"space-y-1\">\n                      <CardTitle className=\"text-lg\">{template.name}</CardTitle>\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        {CATEGORIES.find(c => c.value === template.category)?.label || template.category}\n                      </Badge>\n                    </div>\n                    <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                      <Button variant=\"ghost\" size=\"icon\" onClick={() => handleOpenEdit(template)} data-testid={`button-edit-template-${template.id}`}>\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"icon\" onClick={() => handleDuplicateTemplate(template)} data-testid={`button-duplicate-template-${template.id}`}>\n                        <Copy className=\"h-4 w-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"icon\" onClick={() => handleDeleteTemplate(template)} data-testid={`button-delete-template-${template.id}`}>\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {template.description && (\n                    <p className=\"text-sm text-muted-foreground line-clamp-2\">{template.description}</p>\n                  )}\n                  <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                    <span className=\"flex items-center gap-1\">\n                      <ListTodo className=\"h-4 w-4\" />\n                      {totalTaskCount(template.sections)} tasks\n                    </span>\n                    <span className=\"flex items-center gap-1\">\n                      <FolderOpen className=\"h-4 w-4\" />\n                      {template.sections.length} sections\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                    <span>Used {template.usageCount || 0} times</span>\n                    <span>Updated {format(new Date(template.updatedAt), 'MMM d, yyyy')}</span>\n                  </div>\n                  <Button \n                    className=\"w-full\" \n                    onClick={() => handleOpenApply(template)}\n                    data-testid={`button-apply-template-${template.id}`}\n                  >\n                    <Play className=\"h-4 w-4 mr-2\" />\n                    Use Template\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create Task Template</DialogTitle>\n            <DialogDescription>Create a new reusable task template for HR workflows</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Template Name</Label>\n              <Input\n                value={editingName}\n                onChange={(e) => setEditingName(e.target.value)}\n                placeholder=\"e.g., Employee Onboarding\"\n                data-testid=\"input-template-name\"\n              />\n            </div>\n            <div>\n              <Label>Description</Label>\n              <Textarea\n                value={editingDescription}\n                onChange={(e) => setEditingDescription(e.target.value)}\n                placeholder=\"Describe what this template is for...\"\n                data-testid=\"input-template-description\"\n              />\n            </div>\n            <div>\n              <Label>Category</Label>\n              <Select value={editingCategory} onValueChange={setEditingCategory}>\n                <SelectTrigger data-testid=\"select-template-category\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {CATEGORIES.map(cat => (\n                    <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateDialog(false)}>Cancel</Button>\n            <Button onClick={handleCreateTemplate} disabled={createTemplate.isPending} data-testid=\"button-confirm-create\">\n              {createTemplate.isPending ? \"Creating...\" : \"Create & Edit\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={(open) => { if (!open) resetEditingState(); setShowEditDialog(open); }}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] flex flex-col\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <LayoutTemplate className=\"h-5 w-5\" />\n              Edit Template\n            </DialogTitle>\n          </DialogHeader>\n          <div className=\"flex-1 overflow-hidden flex flex-col\">\n            <div className=\"grid grid-cols-2 gap-4 mb-4\">\n              <div>\n                <Label>Template Name</Label>\n                <Input\n                  value={editingName}\n                  onChange={(e) => setEditingName(e.target.value)}\n                  data-testid=\"input-edit-template-name\"\n                />\n              </div>\n              <div>\n                <Label>Category</Label>\n                <Select value={editingCategory} onValueChange={setEditingCategory}>\n                  <SelectTrigger data-testid=\"select-edit-template-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CATEGORIES.map(cat => (\n                      <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"mb-4\">\n              <Label>Description</Label>\n              <Textarea\n                value={editingDescription}\n                onChange={(e) => setEditingDescription(e.target.value)}\n                placeholder=\"Template description...\"\n                className=\"resize-none\"\n                data-testid=\"input-edit-template-description\"\n              />\n            </div>\n            <Separator className=\"mb-4\" />\n            <div className=\"flex items-center justify-between mb-3\">\n              <h3 className=\"font-medium\">Sections & Tasks</h3>\n              <Button size=\"sm\" onClick={addSection} data-testid=\"button-add-section\">\n                <Plus className=\"h-4 w-4 mr-1\" />\n                Add Section\n              </Button>\n            </div>\n            <ScrollArea className=\"flex-1 pr-4\">\n              <div className=\"space-y-4\">\n                {editingSections.length === 0 ? (\n                  <Card className=\"border-dashed\">\n                    <CardContent className=\"flex flex-col items-center justify-center py-8\">\n                      <FolderOpen className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                      <p className=\"text-sm text-muted-foreground\">No sections yet. Add a section to start building your template.</p>\n                    </CardContent>\n                  </Card>\n                ) : (\n                  editingSections.map((section, sectionIndex) => (\n                    <Card key={section.id} className=\"border-muted\" data-testid={`section-${section.id}`}>\n                      <CardHeader className=\"py-3 px-4\">\n                        <div className=\"flex items-center gap-2\">\n                          <GripVertical className=\"h-4 w-4 text-muted-foreground cursor-move\" />\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"p-0 h-auto\"\n                            onClick={() => toggleSection(section.id)}\n                          >\n                            {expandedSections.has(section.id) ? (\n                              <ChevronDown className=\"h-4 w-4\" />\n                            ) : (\n                              <ChevronRight className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                          <Input\n                            value={section.title}\n                            onChange={(e) => updateSection(section.id, { title: e.target.value })}\n                            className=\"flex-1 h-8 font-medium\"\n                            data-testid={`input-section-title-${section.id}`}\n                          />\n                          <Badge variant=\"outline\">{section.tasks.length} tasks</Badge>\n                          <Button \n                            variant=\"ghost\" \n                            size=\"icon\" \n                            className=\"h-8 w-8\"\n                            onClick={() => deleteSection(section.id)}\n                            data-testid={`button-delete-section-${section.id}`}\n                          >\n                            <X className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </CardHeader>\n                      {expandedSections.has(section.id) && (\n                        <CardContent className=\"pt-0 px-4 pb-4\">\n                          <div className=\"space-y-2 pl-6\">\n                            {section.tasks.map((task, taskIndex) => (\n                              <div \n                                key={task.id} \n                                className=\"flex items-start gap-2 p-3 bg-muted/50 rounded-lg\"\n                                data-testid={`task-${task.id}`}\n                              >\n                                <GripVertical className=\"h-4 w-4 text-muted-foreground cursor-move mt-1\" />\n                                <div className=\"flex-1 space-y-2\">\n                                  <Input\n                                    value={task.title}\n                                    onChange={(e) => updateTask(section.id, task.id, { title: e.target.value })}\n                                    placeholder=\"Task title\"\n                                    className=\"h-8\"\n                                    data-testid={`input-task-title-${task.id}`}\n                                  />\n                                  <Textarea\n                                    value={task.description || \"\"}\n                                    onChange={(e) => updateTask(section.id, task.id, { description: e.target.value })}\n                                    placeholder=\"Task description (optional)\"\n                                    className=\"resize-none min-h-[60px]\"\n                                    data-testid={`input-task-description-${task.id}`}\n                                  />\n                                  <div className=\"flex gap-2\">\n                                    <div className=\"flex-1\">\n                                      <Label className=\"text-xs text-muted-foreground\">Assignee</Label>\n                                      <Select \n                                        value={task.assigneeId || \"unassigned\"} \n                                        onValueChange={(val) => updateTask(section.id, task.id, { assigneeId: val === \"unassigned\" ? undefined : val })}\n                                      >\n                                        <SelectTrigger className=\"h-8\" data-testid={`select-task-assignee-${task.id}`}>\n                                          <SelectValue placeholder=\"Select assignee\" />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                                          {users?.filter(u => !u.isExternal).map(user => (\n                                            <SelectItem key={user.id} value={user.id}>{user.name}</SelectItem>\n                                          ))}\n                                        </SelectContent>\n                                      </Select>\n                                    </div>\n                                    <div className=\"w-32\">\n                                      <Label className=\"text-xs text-muted-foreground\">Due (days after start)</Label>\n                                      <Input\n                                        type=\"number\"\n                                        min=\"0\"\n                                        value={task.relativeDueDays ?? \"\"}\n                                        onChange={(e) => updateTask(section.id, task.id, { relativeDueDays: e.target.value ? parseInt(e.target.value) : undefined })}\n                                        placeholder=\"e.g., 7\"\n                                        className=\"h-8\"\n                                        data-testid={`input-task-due-days-${task.id}`}\n                                      />\n                                    </div>\n                                  </div>\n                                </div>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"icon\" \n                                  className=\"h-8 w-8\"\n                                  onClick={() => deleteTask(section.id, task.id)}\n                                  data-testid={`button-delete-task-${task.id}`}\n                                >\n                                  <X className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            ))}\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\" \n                              className=\"w-full\"\n                              onClick={() => addTask(section.id)}\n                              data-testid={`button-add-task-${section.id}`}\n                            >\n                              <Plus className=\"h-4 w-4 mr-1\" />\n                              Add Task\n                            </Button>\n                          </div>\n                        </CardContent>\n                      )}\n                    </Card>\n                  ))\n                )}\n              </div>\n            </ScrollArea>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button variant=\"outline\" onClick={() => { resetEditingState(); setShowEditDialog(false); }}>Cancel</Button>\n            <Button onClick={handleSaveTemplate} disabled={updateTemplate.isPending} data-testid=\"button-save-template\">\n              {updateTemplate.isPending ? \"Saving...\" : \"Save Template\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showApplyDialog} onOpenChange={setShowApplyDialog}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Play className=\"h-5 w-5 text-primary\" />\n              Use Template: {selectedTemplate?.name}\n            </DialogTitle>\n            <DialogDescription>\n              This will create {selectedTemplate ? totalTaskCount(selectedTemplate.sections) : 0} tasks from this template\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Start Date</Label>\n              <div className=\"relative\">\n                <Calendar className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  type=\"date\"\n                  value={applyStartDate}\n                  onChange={(e) => setApplyStartDate(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-apply-start-date\"\n                />\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Task due dates will be calculated relative to this date</p>\n            </div>\n            <div>\n              <Label>Context Name (Optional)</Label>\n              <Input\n                value={applyContextName}\n                onChange={(e) => setApplyContextName(e.target.value)}\n                placeholder=\"e.g., New Hire: John Smith\"\n                data-testid=\"input-apply-context-name\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">Helps identify what these tasks are for</p>\n            </div>\n            {selectedTemplate && selectedTemplate.sections.length > 0 && (\n              <div>\n                <Label className=\"mb-2 block\">Preview</Label>\n                <ScrollArea className=\"h-48 border rounded-lg p-3\">\n                  {selectedTemplate.sections.map(section => (\n                    <div key={section.id} className=\"mb-3\">\n                      <h4 className=\"font-medium text-sm mb-1\">{section.title}</h4>\n                      <div className=\"space-y-1 pl-4\">\n                        {section.tasks.map(task => (\n                          <div key={task.id} className=\"text-sm flex items-center gap-2\">\n                            <ListTodo className=\"h-3 w-3 text-muted-foreground\" />\n                            <span>{task.title}</span>\n                            {task.relativeDueDays !== undefined && (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                Day {task.relativeDueDays}\n                              </Badge>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  ))}\n                </ScrollArea>\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowApplyDialog(false)}>Cancel</Button>\n            <Button onClick={handleApplyTemplate} disabled={applyTemplate.isPending} data-testid=\"button-confirm-apply\">\n              {applyTemplate.isPending ? \"Creating Tasks...\" : \"Create Tasks\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":32522,"size_tokens":null},"client/src/components/chat/DockedChatBoxes.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { \n  X,\n  Maximize2,\n  Send,\n  ChevronDown,\n  ChevronUp,\n  Smile\n} from \"lucide-react\";\nimport { useCurrentUser } from \"@/lib/api\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\nimport { useLocation } from \"wouter\";\n\ntype ConversationMember = {\n  id: string;\n  name: string;\n  avatar?: string;\n};\n\ntype Conversation = {\n  id: string;\n  name: string | null;\n  isGroup: boolean | null;\n  createdBy: string | null;\n  members: ConversationMember[];\n  lastMessage: {\n    content: string;\n    senderId: string;\n    createdAt: string;\n  } | null;\n  unreadCount: number;\n};\n\ntype MessageReaction = {\n  emoji: string;\n  userId: string;\n  userName: string;\n  createdAt: string;\n};\n\ntype Message = {\n  id: string;\n  senderId: string;\n  senderName: string;\n  content: string;\n  createdAt: string;\n  reactions?: MessageReaction[];\n};\n\nconst QUICK_REACTIONS = ['', '', '', '', '', '', '', '', '', ''];\n\ntype OpenChat = {\n  conversationId: string;\n  isMinimized: boolean;\n};\n\nconst MAX_OPEN_CHATS = 3;\nconst STORAGE_KEY = 'kronos_open_chats';\n\nconst EMOJI_CATEGORIES = {\n  'Smileys': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Gestures': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Hearts': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Reactions': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Work': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Time': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Symbols': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Animals': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],\n  'Food': ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']\n};\n\nlet audioUnlocked = false;\nlet notificationAudio: HTMLAudioElement | null = null;\n\nconst initAudio = () => {\n  if (!notificationAudio) {\n    notificationAudio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4T/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV');\n    notificationAudio.volume = 0.5;\n  }\n};\n\nconst playNotificationSound = () => {\n  if (notificationAudio && audioUnlocked) {\n    notificationAudio.currentTime = 0;\n    notificationAudio.play().catch(() => {});\n  }\n};\n\nif (typeof window !== 'undefined') {\n  const unlockAudio = () => {\n    initAudio();\n    if (notificationAudio && !audioUnlocked) {\n      notificationAudio.play().then(() => {\n        notificationAudio!.pause();\n        notificationAudio!.currentTime = 0;\n        audioUnlocked = true;\n      }).catch(() => {});\n    }\n    document.removeEventListener('click', unlockAudio);\n    document.removeEventListener('keydown', unlockAudio);\n  };\n  document.addEventListener('click', unlockAudio);\n  document.addEventListener('keydown', unlockAudio);\n}\n\nconst saveOpenChats = (chats: OpenChat[]) => {\n  try {\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));\n  } catch {}\n};\n\nconst loadOpenChats = (): OpenChat[] => {\n  try {\n    const saved = localStorage.getItem(STORAGE_KEY);\n    if (saved) {\n      return JSON.parse(saved);\n    }\n  } catch {}\n  return [];\n};\n\nexport function DockedChatBoxes() {\n  const [, setLocation] = useLocation();\n  const { data: currentUser } = useCurrentUser();\n  const queryClient = useQueryClient();\n  \n  const [openChats, setOpenChats] = useState<OpenChat[]>(() => loadOpenChats());\n  const [messageInputs, setMessageInputs] = useState<Record<string, string>>({});\n  const [showMessagingMenu, setShowMessagingMenu] = useState(false);\n  const lastSeenMessagesRef = useRef<Record<string, string>>({});\n  const mountTimeRef = useRef(Date.now());\n  \n  useEffect(() => {\n    initAudio();\n  }, []);\n\n  useEffect(() => {\n    saveOpenChats(openChats);\n  }, [openChats]);\n  \n  const { data: conversations = [] } = useQuery<Conversation[]>({\n    queryKey: [\"/api/chat/conversations\"],\n    refetchInterval: 3000,\n  });\n\n  const openChatForConversation = useCallback((conversationId: string, minimized = false) => {\n    setOpenChats(prev => {\n      const existing = prev.find(c => c.conversationId === conversationId);\n      if (existing) {\n        return prev.map(c => \n          c.conversationId === conversationId \n            ? { ...c, isMinimized: minimized } \n            : c\n        );\n      }\n      const newChats = [...prev, { conversationId, isMinimized: minimized }];\n      if (newChats.length > MAX_OPEN_CHATS) {\n        return newChats.slice(-MAX_OPEN_CHATS);\n      }\n      return newChats;\n    });\n    setShowMessagingMenu(false);\n  }, []);\n\n  useEffect(() => {\n    if (!currentUser || conversations.length === 0) return;\n    \n    conversations.forEach(conv => {\n      if (!conv.lastMessage) return;\n      \n      const currentTimestamp = conv.lastMessage.createdAt;\n      const lastSeenTimestamp = lastSeenMessagesRef.current[conv.id];\n      const messageTime = new Date(currentTimestamp).getTime();\n      const isFromOtherUser = conv.lastMessage.senderId !== currentUser.id;\n      \n      if (lastSeenTimestamp === undefined) {\n        if (messageTime > mountTimeRef.current - 5000 && isFromOtherUser) {\n          lastSeenMessagesRef.current[conv.id] = currentTimestamp;\n          openChatForConversation(conv.id, false);\n          playNotificationSound();\n        } else {\n          lastSeenMessagesRef.current[conv.id] = currentTimestamp;\n        }\n        return;\n      }\n      \n      if (lastSeenTimestamp !== currentTimestamp && isFromOtherUser) {\n        lastSeenMessagesRef.current[conv.id] = currentTimestamp;\n        openChatForConversation(conv.id, false);\n        playNotificationSound();\n      }\n    });\n  }, [conversations, currentUser, openChatForConversation]);\n\n  const closeChat = (conversationId: string) => {\n    setOpenChats(prev => prev.filter(c => c.conversationId !== conversationId));\n  };\n\n  const toggleMinimize = (conversationId: string) => {\n    setOpenChats(prev => prev.map(c => \n      c.conversationId === conversationId \n        ? { ...c, isMinimized: !c.isMinimized } \n        : c\n    ));\n  };\n\n  const getConversationName = (conv: Conversation) => {\n    if (conv.name) return conv.name;\n    if (conv.isGroup) return \"Group Chat\";\n    const otherMember = conv.members.find(m => m.id !== currentUser?.id);\n    return otherMember?.name || \"Chat\";\n  };\n\n  const getInitials = (name: string) => {\n    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n  };\n\n  const openFullChat = () => {\n    const basePath = currentUser?.accessLevel === 'admin' ? '/ceo' : '/employee';\n    setLocation(`${basePath}/chat`);\n  };\n\n  if (!currentUser) return null;\n\n  const totalUnread = conversations.reduce((sum, c) => sum + c.unreadCount, 0);\n  const closedConversations = conversations.filter(\n    c => !openChats.some(oc => oc.conversationId === c.id)\n  );\n\n  return (\n    <div className=\"fixed bottom-0 right-0 flex items-end z-50\" data-testid=\"docked-chat-boxes\">\n      <div className=\"flex items-end gap-1 mr-1\">\n        {openChats.map((chat) => (\n          <ChatBox\n            key={chat.conversationId}\n            conversationId={chat.conversationId}\n            isMinimized={chat.isMinimized}\n            conversations={conversations}\n            currentUser={currentUser}\n            messageInput={messageInputs[chat.conversationId] || \"\"}\n            setMessageInput={(value) => setMessageInputs(prev => ({ ...prev, [chat.conversationId]: value }))}\n            onClose={() => closeChat(chat.conversationId)}\n            onToggleMinimize={() => toggleMinimize(chat.conversationId)}\n            onOpenFullChat={openFullChat}\n            getConversationName={getConversationName}\n            getInitials={getInitials}\n            queryClient={queryClient}\n          />\n        ))}\n      </div>\n      \n      <div className=\"relative mr-4 mb-0\">\n        {showMessagingMenu && (\n          <Card className=\"absolute bottom-12 right-0 w-80 shadow-2xl border border-gray-300 dark:border-border overflow-hidden animate-in slide-in-from-bottom-2 duration-200\">\n            <div className=\"px-4 py-3 border-b border-gray-200 dark:border-border bg-white dark:bg-card flex items-center justify-between\">\n              <span className=\"font-semibold text-gray-900 dark:text-foreground\">Messaging</span>\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                className=\"h-7 w-7\"\n                onClick={openFullChat}\n              >\n                <Maximize2 className=\"w-4 h-4\" />\n              </Button>\n            </div>\n            <ScrollArea className=\"h-72 bg-white dark:bg-card\">\n              {closedConversations.length === 0 ? (\n                <div className=\"text-center py-12 text-gray-500 text-sm\">\n                  No conversations\n                </div>\n              ) : (\n                closedConversations.map((conv) => (\n                  <div\n                    key={conv.id}\n                    className={cn(\n                      \"flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-secondary/50 transition-colors border-b border-gray-100 dark:border-border/50\",\n                      conv.unreadCount > 0 && \"bg-blue-50/50 dark:bg-primary/5\"\n                    )}\n                    onClick={() => openChatForConversation(conv.id, false)}\n                    data-testid={`list-conversation-${conv.id}`}\n                  >\n                    <div className=\"relative shrink-0\">\n                      <Avatar className=\"h-12 w-12\">\n                        <AvatarFallback className=\"text-sm bg-gray-300 dark:bg-secondary text-gray-700 dark:text-foreground\">\n                          {getInitials(getConversationName(conv))}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className={cn(\n                          \"text-sm truncate\",\n                          conv.unreadCount > 0 ? \"font-semibold text-gray-900 dark:text-foreground\" : \"text-gray-700 dark:text-foreground\"\n                        )}>\n                          {getConversationName(conv)}\n                        </span>\n                        {conv.unreadCount > 0 && (\n                          <Badge className=\"h-5 min-w-[20px] px-1.5 text-[10px] bg-red-500 hover:bg-red-500\">\n                            {conv.unreadCount}\n                          </Badge>\n                        )}\n                      </div>\n                      {conv.lastMessage && (\n                        <p className=\"text-xs text-gray-500 dark:text-muted-foreground truncate mt-0.5\">\n                          {conv.lastMessage.content}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n                ))\n              )}\n            </ScrollArea>\n          </Card>\n        )}\n        \n        <div \n          className={cn(\n            \"flex items-center gap-2 px-4 py-2.5 rounded-t-lg shadow-lg cursor-pointer transition-all border border-b-0 border-gray-300 dark:border-border\",\n            \"bg-white dark:bg-card hover:bg-gray-50 dark:hover:bg-secondary\"\n          )}\n          onClick={() => setShowMessagingMenu(!showMessagingMenu)}\n          data-testid=\"button-messaging-dock\"\n        >\n          <Avatar className=\"h-8 w-8\">\n            <AvatarFallback className=\"text-xs bg-gray-200 dark:bg-secondary\">\n              {currentUser ? getInitials(currentUser.name) : \"?\"}\n            </AvatarFallback>\n          </Avatar>\n          <span className=\"font-semibold text-sm text-gray-900 dark:text-foreground\">Messaging</span>\n          {totalUnread > 0 && (\n            <Badge className=\"h-5 min-w-[20px] px-1.5 text-[10px] bg-red-500 hover:bg-red-500\">\n              {totalUnread > 9 ? '9+' : totalUnread}\n            </Badge>\n          )}\n          {showMessagingMenu ? (\n            <ChevronDown className=\"w-4 h-4 text-gray-600\" />\n          ) : (\n            <ChevronUp className=\"w-4 h-4 text-gray-600\" />\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction EmojiPicker({ onSelect }: { onSelect: (emoji: string) => void }) {\n  const [activeCategory, setActiveCategory] = useState('Smileys');\n  const categories = Object.keys(EMOJI_CATEGORIES);\n  \n  return (\n    <div className=\"w-72\">\n      <div className=\"flex gap-1 p-2 border-b overflow-x-auto\">\n        {categories.map(cat => (\n          <Button\n            key={cat}\n            variant={activeCategory === cat ? \"default\" : \"ghost\"}\n            size=\"sm\"\n            className=\"text-xs px-2 py-1 h-7 shrink-0\"\n            onClick={() => setActiveCategory(cat)}\n          >\n            {cat}\n          </Button>\n        ))}\n      </div>\n      <ScrollArea className=\"h-48 p-2\">\n        <div className=\"grid grid-cols-8 gap-1\">\n          {EMOJI_CATEGORIES[activeCategory as keyof typeof EMOJI_CATEGORIES].map((emoji, i) => (\n            <button\n              key={i}\n              className=\"w-8 h-8 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-secondary rounded text-lg transition-colors\"\n              onClick={() => onSelect(emoji)}\n            >\n              {emoji}\n            </button>\n          ))}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n\nfunction ChatBox({\n  conversationId,\n  isMinimized,\n  conversations,\n  currentUser,\n  messageInput,\n  setMessageInput,\n  onClose,\n  onToggleMinimize,\n  onOpenFullChat,\n  getConversationName,\n  getInitials,\n  queryClient,\n}: {\n  conversationId: string;\n  isMinimized: boolean;\n  conversations: Conversation[];\n  currentUser: any;\n  messageInput: string;\n  setMessageInput: (value: string) => void;\n  onClose: () => void;\n  onToggleMinimize: () => void;\n  onOpenFullChat: () => void;\n  getConversationName: (conv: Conversation) => string;\n  getInitials: (name: string) => string;\n  queryClient: any;\n}) {\n  const endRef = useRef<HTMLDivElement>(null);\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\n  \n  const conversation = conversations.find(c => c.id === conversationId);\n  \n  const { data: messages = [] } = useQuery<Message[]>({\n    queryKey: [`/api/chat/conversations/${conversationId}/messages`],\n    enabled: !isMinimized,\n    refetchInterval: 3000,\n  });\n  \n  const sendMessageMutation = useMutation({\n    mutationFn: async ({ conversationId, content }: { conversationId: string; content: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!res.ok) throw new Error(\"Failed to send message\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${conversationId}/messages`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setMessageInput(\"\");\n    },\n  });\n\n  const addReactionMutation = useMutation({\n    mutationFn: async ({ messageId, emoji }: { messageId: string; emoji: string }) => {\n      const res = await fetch(`/api/chat/conversations/${conversationId}/messages/${messageId}/reactions`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ emoji }),\n      });\n      if (!res.ok) throw new Error(\"Failed to add reaction\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/chat/conversations/${conversationId}/messages`] });\n    },\n  });\n\n  useEffect(() => {\n    if (!isMinimized && endRef.current) {\n      endRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [messages, isMinimized]);\n\n  const handleSendMessage = () => {\n    if (!messageInput.trim()) return;\n    sendMessageMutation.mutate({ conversationId, content: messageInput.trim() });\n  };\n\n  const handleEmojiSelect = (emoji: string) => {\n    setMessageInput(messageInput + emoji);\n    setShowEmojiPicker(false);\n  };\n\n  if (!conversation) return null;\n\n  const convName = getConversationName(conversation);\n\n  return (\n    <div \n      className={cn(\n        \"flex flex-col shadow-2xl border border-gray-300 dark:border-border overflow-hidden transition-all duration-200 rounded-t-lg\",\n        isMinimized ? \"w-56\" : \"w-80\"\n      )}\n      data-testid={`docked-chat-${conversationId}`}\n    >\n      {!isMinimized && (\n        <div className=\"bg-white dark:bg-card\">\n          <ScrollArea className=\"h-80 p-3\">\n            {messages.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-400 text-sm\">\n                No messages yet. Say hello! \n              </div>\n            ) : (\n              messages.map((msg) => {\n                const groupedReactions = (msg.reactions || []).reduce((acc, r) => {\n                  if (!acc[r.emoji]) acc[r.emoji] = [];\n                  acc[r.emoji].push(r);\n                  return acc;\n                }, {} as Record<string, MessageReaction[]>);\n\n                return (\n                  <div \n                    key={msg.id}\n                    className={cn(\n                      \"mb-3 max-w-[85%] group\",\n                      msg.senderId === currentUser?.id ? \"ml-auto\" : \"\"\n                    )}\n                  >\n                    <div className=\"relative\">\n                      <div className={cn(\n                        \"rounded-2xl px-3 py-2 text-sm\",\n                        msg.senderId === currentUser?.id \n                          ? \"bg-blue-600 text-white rounded-br-sm\" \n                          : \"bg-gray-100 dark:bg-secondary text-gray-900 dark:text-foreground rounded-bl-sm\"\n                      )}>\n                        {msg.senderId !== currentUser?.id && (\n                          <div className=\"text-xs font-medium mb-1 text-gray-500 dark:text-muted-foreground\">{msg.senderName}</div>\n                        )}\n                        {msg.content}\n                      </div>\n                      <Popover>\n                        <PopoverTrigger asChild>\n                          <button \n                            className={cn(\n                              \"absolute -bottom-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white dark:bg-card border border-gray-200 dark:border-border rounded-full p-1 shadow-sm hover:bg-gray-50 dark:hover:bg-secondary\",\n                              msg.senderId === currentUser?.id ? \"right-0\" : \"left-0\"\n                            )}\n                          >\n                            <Smile className=\"w-3.5 h-3.5 text-gray-500\" />\n                          </button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-auto p-1\" align={msg.senderId === currentUser?.id ? \"end\" : \"start\"} side=\"top\">\n                          <div className=\"flex gap-1\">\n                            {QUICK_REACTIONS.map((emoji) => (\n                              <button\n                                key={emoji}\n                                className=\"w-7 h-7 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-secondary rounded text-base transition-colors\"\n                                onClick={() => addReactionMutation.mutate({ messageId: msg.id, emoji })}\n                              >\n                                {emoji}\n                              </button>\n                            ))}\n                          </div>\n                        </PopoverContent>\n                      </Popover>\n                    </div>\n                    {Object.keys(groupedReactions).length > 0 && (\n                      <div className={cn(\n                        \"flex flex-wrap gap-1 mt-1\",\n                        msg.senderId === currentUser?.id ? \"justify-end\" : \"\"\n                      )}>\n                        {Object.entries(groupedReactions).map(([emoji, reactions]) => {\n                          const hasUserReacted = reactions.some(r => r.userId === currentUser?.id);\n                          return (\n                            <button\n                              key={emoji}\n                              onClick={() => addReactionMutation.mutate({ messageId: msg.id, emoji })}\n                              className={cn(\n                                \"flex items-center gap-0.5 px-1.5 py-0.5 rounded-full text-xs border transition-colors\",\n                                hasUserReacted \n                                  ? \"bg-blue-100 dark:bg-blue-900/30 border-blue-300 dark:border-blue-700\" \n                                  : \"bg-gray-100 dark:bg-secondary border-gray-200 dark:border-border hover:bg-gray-200 dark:hover:bg-secondary/80\"\n                              )}\n                              title={reactions.map(r => r.userName).join(', ')}\n                            >\n                              <span>{emoji}</span>\n                              <span className=\"text-gray-600 dark:text-muted-foreground\">{reactions.length}</span>\n                            </button>\n                          );\n                        })}\n                      </div>\n                    )}\n                    <div className={cn(\n                      \"text-[10px] text-gray-400 mt-0.5 px-1\",\n                      msg.senderId === currentUser?.id ? \"text-right\" : \"\"\n                    )}>\n                      {format(new Date(msg.createdAt), 'h:mm a')}\n                    </div>\n                  </div>\n                );\n              })\n            )}\n            <div ref={endRef} />\n          </ScrollArea>\n          <div className=\"p-2 border-t border-gray-200 dark:border-border flex gap-1 bg-white dark:bg-card\">\n            <Popover open={showEmojiPicker} onOpenChange={setShowEmojiPicker}>\n              <PopoverTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\" \n                  className=\"h-9 w-9 shrink-0\"\n                  data-testid={`button-emoji-${conversationId}`}\n                >\n                  <Smile className=\"w-5 h-5 text-gray-500\" />\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\" side=\"top\">\n                <EmojiPicker onSelect={handleEmojiSelect} />\n              </PopoverContent>\n            </Popover>\n            <Input\n              value={messageInput}\n              onChange={(e) => setMessageInput(e.target.value)}\n              placeholder=\"Write a message...\"\n              className=\"h-9 text-sm border-gray-300 dark:border-border rounded-full px-4\"\n              onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}\n              data-testid={`input-message-${conversationId}`}\n            />\n            <Button \n              size=\"icon\" \n              className=\"h-9 w-9 shrink-0 rounded-full bg-blue-600 hover:bg-blue-700\"\n              onClick={handleSendMessage}\n              disabled={sendMessageMutation.isPending || !messageInput.trim()}\n              data-testid={`button-send-${conversationId}`}\n            >\n              <Send className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n      )}\n      \n      <div \n        className=\"px-3 py-2 bg-white dark:bg-card border-t border-gray-200 dark:border-border flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-secondary\"\n        onClick={onToggleMinimize}\n      >\n        <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n          <div className=\"relative shrink-0\">\n            <Avatar className=\"h-8 w-8\">\n              <AvatarFallback className=\"text-xs bg-gray-200 dark:bg-secondary text-gray-700 dark:text-foreground\">\n                {getInitials(convName)}\n              </AvatarFallback>\n            </Avatar>\n            <div className=\"absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-card rounded-full\" />\n          </div>\n          <span className=\"font-medium text-sm text-gray-900 dark:text-foreground truncate\">{convName}</span>\n        </div>\n        <div className=\"flex items-center gap-0.5 shrink-0\">\n          {isMinimized ? (\n            <ChevronUp className=\"w-4 h-4 text-gray-600\" />\n          ) : (\n            <ChevronDown className=\"w-4 h-4 text-gray-600\" />\n          )}\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"h-6 w-6 hover:bg-gray-200 dark:hover:bg-secondary\"\n            onClick={(e) => { e.stopPropagation(); onOpenFullChat(); }}\n            data-testid={`button-fullscreen-chat-${conversationId}`}\n          >\n            <Maximize2 className=\"w-3.5 h-3.5 text-gray-600\" />\n          </Button>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"h-6 w-6 hover:bg-gray-200 dark:hover:bg-secondary\"\n            onClick={(e) => { e.stopPropagation(); onClose(); }}\n            data-testid={`button-close-chat-${conversationId}`}\n          >\n            <X className=\"w-4 h-4 text-gray-600\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":29526,"size_tokens":null},"client/src/pages/shared/ResumeOnboarding.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { useResumeAnalysis, useUploadResume, type ResumeAIAnalysis, type OnboardingPlacement } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { toast } from \"sonner\";\nimport { Upload, FileText, Loader2, Target, Briefcase, Users, AlertTriangle, CheckCircle2, RefreshCw, ChevronRight } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\nconst PROFILE_COLORS: Record<string, string> = {\n  'Politician': 'bg-purple-100 text-purple-800 border-purple-300',\n  'Sherpa': 'bg-blue-100 text-blue-800 border-blue-300',\n  'Deal Junkie': 'bg-red-100 text-red-800 border-red-300',\n  'Closer': 'bg-green-100 text-green-800 border-green-300',\n  'Architect': 'bg-slate-100 text-slate-800 border-slate-300',\n  'Firefighter': 'bg-orange-100 text-orange-800 border-orange-300',\n  'Guru': 'bg-indigo-100 text-indigo-800 border-indigo-300',\n  'Misfit': 'bg-pink-100 text-pink-800 border-pink-300',\n  'Legal': 'bg-gray-100 text-gray-800 border-gray-300',\n  'Rainmaker': 'bg-yellow-100 text-yellow-800 border-yellow-300',\n  'Creative': 'bg-cyan-100 text-cyan-800 border-cyan-300',\n  'Auditor': 'bg-emerald-100 text-emerald-800 border-emerald-300',\n  'Mayor': 'bg-amber-100 text-amber-800 border-amber-300',\n  'Liaison': 'bg-teal-100 text-teal-800 border-teal-300',\n  'Grandmaster': 'bg-violet-100 text-violet-800 border-violet-300',\n  'Regulatory': 'bg-rose-100 text-rose-800 border-rose-300',\n};\n\nfunction AnalysisSection({ title, content, icon: Icon }: { title: string; content: string; icon?: any }) {\n  if (!content) return null;\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-center gap-2\">\n        {Icon && <Icon className=\"h-4 w-4 text-muted-foreground\" />}\n        <h3 className=\"font-semibold text-sm\">{title}</h3>\n      </div>\n      <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">{content}</p>\n    </div>\n  );\n}\n\nexport default function ResumeOnboarding() {\n  const [location, navigate] = useLocation();\n  const role: 'CEO' | 'Employee' = location.startsWith('/ceo') ? 'CEO' : 'Employee';\n  \n  const { data: existingAnalysis, isLoading, refetch } = useResumeAnalysis();\n  const uploadResume = useUploadResume();\n  \n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [dragActive, setDragActive] = useState(false);\n  \n  const isAnalyzing = existingAnalysis?.status === 'analyzing';\n  const hasCompletedAnalysis = existingAnalysis && existingAnalysis.status === 'completed';\n  \n  useEffect(() => {\n    if (isAnalyzing) {\n      const interval = setInterval(() => {\n        refetch();\n      }, 2000);\n      return () => clearInterval(interval);\n    }\n  }, [isAnalyzing, refetch]);\n  \n  const handleFileSelect = async (file: File) => {\n    if (!file) return;\n    \n    const validTypes = ['application/pdf', 'text/plain'];\n    if (!validTypes.includes(file.type) && !file.name.endsWith('.txt')) {\n      toast.error(\"Please upload a PDF or TXT file\");\n      return;\n    }\n    \n    if (file.size > 10 * 1024 * 1024) {\n      toast.error(\"File size must be less than 10MB\");\n      return;\n    }\n    \n    try {\n      await uploadResume.mutateAsync(file);\n      toast.success(\"Resume uploaded! Analyzing...\");\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n  \n  const handleDrag = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (e.type === \"dragenter\" || e.type === \"dragover\") {\n      setDragActive(true);\n    } else if (e.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  };\n  \n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n    \n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\n      handleFileSelect(e.dataTransfer.files[0]);\n    }\n  };\n  \n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      handleFileSelect(e.target.files[0]);\n    }\n  };\n  \n  const handleRetake = () => {\n    fileInputRef.current?.click();\n  };\n  \n  const handleContinueToAssessment = () => {\n    const basePath = role === 'CEO' ? '/ceo' : '/employee';\n    navigate(`${basePath}/personality-assessment`);\n  };\n  \n  if (isLoading) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n        </div>\n      </Layout>\n    );\n  }\n  \n  if (isAnalyzing) {\n    return (\n      <Layout role={role}>\n        <div className=\"max-w-2xl mx-auto\">\n          <Card>\n            <CardContent className=\"py-16 text-center\">\n              <Loader2 className=\"h-12 w-12 animate-spin mx-auto text-primary mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Analyzing Your Resume</h2>\n              <p className=\"text-muted-foreground\">\n                Our AI is reviewing your experience to determine your Deal Team placement.\n                This usually takes about 15-20 seconds...\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </Layout>\n    );\n  }\n  \n  if (hasCompletedAnalysis) {\n    const aiAnalysis = existingAnalysis.aiAnalysis;\n    const placement = aiAnalysis?.onboardingPlacement;\n    \n    return (\n      <Layout role={role}>\n        <div className=\"max-w-5xl mx-auto space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-2xl font-bold tracking-tight\">Your Onboarding Placement</h1>\n              <p className=\"text-muted-foreground\">\n                {existingAnalysis.completedAt && `Analyzed on ${format(new Date(existingAnalysis.completedAt), 'MMMM d, yyyy')}`}\n                {existingAnalysis.fileName && ` - ${existingAnalysis.fileName}`}\n              </p>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button variant=\"outline\" onClick={handleRetake} data-testid=\"button-reupload-resume\">\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Upload New Resume\n              </Button>\n              <Button onClick={handleContinueToAssessment} data-testid=\"button-continue-assessment\">\n                Continue to Assessment\n                <ChevronRight className=\"h-4 w-4 ml-2\" />\n              </Button>\n            </div>\n          </div>\n          \n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\".pdf,.txt\"\n            onChange={handleInputChange}\n            className=\"hidden\"\n          />\n          \n          {placement && (\n            <Card className=\"bg-gradient-to-r from-primary/5 to-primary/10 border-primary/20\">\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Target className=\"h-5 w-5\" />\n                  Final Onboarding Placement\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Assigned Deal Team</p>\n                    <Badge variant=\"secondary\" className=\"text-sm font-semibold\">{placement.assignedDealTeam}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Primary Vertical</p>\n                    <Badge className=\"text-sm bg-blue-600\">{placement.primaryVertical}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Secondary Vertical</p>\n                    <Badge variant=\"outline\" className=\"text-sm\">{placement.secondaryVertical}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Initial Seat</p>\n                    <Badge className=\"text-sm bg-green-600\">{placement.initialSeatRecommendation}</Badge>\n                  </div>\n                </div>\n                <Separator className=\"my-4\" />\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <p className=\"text-xs text-muted-foreground\">Deal Phases</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      <Badge className=\"text-sm bg-emerald-600\">Primary: {placement.primaryDealPhase}</Badge>\n                      <Badge variant=\"outline\" className=\"text-sm\">Secondary: {placement.secondaryDealPhase}</Badge>\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <p className=\"text-xs text-muted-foreground\">Resume Inferred Tags</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {placement.topFiveInferredTags?.map((tag, idx) => (\n                        <Badge \n                          key={idx}\n                          className={cn(\"text-sm border\", PROFILE_COLORS[tag] || 'bg-gray-100 text-gray-800')}\n                        >\n                          {idx + 1}. {tag}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n                {placement.coverageGaps && placement.coverageGaps !== 'No material gaps observed' && (\n                  <div className=\"mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200\">\n                    <div className=\"flex items-center gap-2 text-amber-800\">\n                      <AlertTriangle className=\"h-4 w-4\" />\n                      <span className=\"text-sm font-medium\">Coverage Gaps: {placement.coverageGaps}</span>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n          \n          <Tabs defaultValue=\"profile\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"profile\">Candidate Profile</TabsTrigger>\n              <TabsTrigger value=\"experience\">Experience</TabsTrigger>\n              <TabsTrigger value=\"deployment\">Deployment Fit</TabsTrigger>\n              <TabsTrigger value=\"management\">Management Notes</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"profile\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-6\">\n                  {aiAnalysis?.candidateSnapshot && (\n                    <AnalysisSection title=\"Candidate Snapshot\" content={aiAnalysis.candidateSnapshot} icon={Users} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.evidenceAnchors && (\n                    <AnalysisSection title=\"Evidence Anchors\" content={aiAnalysis.evidenceAnchors} icon={FileText} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"experience\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-6\">\n                  {aiAnalysis?.transactionProfile && (\n                    <AnalysisSection title=\"Transaction Profile\" content={aiAnalysis.transactionProfile} icon={Briefcase} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.roleElevationAutonomy && (\n                    <AnalysisSection title=\"Role Elevation & Autonomy\" content={aiAnalysis.roleElevationAutonomy} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"deployment\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-6\">\n                  {aiAnalysis?.dealPhaseFit && (\n                    <AnalysisSection title=\"Deal Phase Fit\" content={aiAnalysis.dealPhaseFit} icon={Target} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.dealTypeProficiency && (\n                    <AnalysisSection title=\"Deal Type Proficiency\" content={aiAnalysis.dealTypeProficiency} icon={Briefcase} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.resumeInferredTags && (\n                    <AnalysisSection title=\"Resume Inferred Tags\" content={aiAnalysis.resumeInferredTags} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"management\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6\">\n                  {aiAnalysis?.managerialNotes && (\n                    <AnalysisSection title=\"Managerial Notes\" content={aiAnalysis.managerialNotes} icon={FileText} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n          \n          <Card className=\"bg-muted/50\">\n            <CardContent className=\"py-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h3 className=\"font-semibold\">Ready for Personality Assessment?</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Complete the 25-question assessment to refine your deployment profile with behavioral insights.\n                  </p>\n                </div>\n                <Button onClick={handleContinueToAssessment} size=\"lg\">\n                  Take Assessment\n                  <ChevronRight className=\"h-4 w-4 ml-2\" />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </Layout>\n    );\n  }\n  \n  return (\n    <Layout role={role}>\n      <div className=\"max-w-2xl mx-auto space-y-6\">\n        <div className=\"text-center space-y-2\">\n          <div className=\"mx-auto w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n            <FileText className=\"h-8 w-8 text-primary\" />\n          </div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Resume Onboarding</h1>\n          <p className=\"text-muted-foreground\">\n            Upload your resume to get your initial Deal Team placement and deployment profile\n          </p>\n        </div>\n        \n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Upload Your Resume</CardTitle>\n            <CardDescription>\n              Our AI will analyze your experience to assign you to the appropriate Deal Team\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div\n              className={cn(\n                \"border-2 border-dashed rounded-lg p-12 text-center transition-colors cursor-pointer\",\n                dragActive ? \"border-primary bg-primary/5\" : \"border-gray-300 hover:border-primary/50\",\n                uploadResume.isPending && \"pointer-events-none opacity-50\"\n              )}\n              onDragEnter={handleDrag}\n              onDragLeave={handleDrag}\n              onDragOver={handleDrag}\n              onDrop={handleDrop}\n              onClick={() => fileInputRef.current?.click()}\n              data-testid=\"dropzone-resume\"\n            >\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\".pdf,.txt\"\n                onChange={handleInputChange}\n                className=\"hidden\"\n                data-testid=\"input-resume-file\"\n              />\n              \n              {uploadResume.isPending ? (\n                <div className=\"space-y-3\">\n                  <Loader2 className=\"h-12 w-12 mx-auto text-primary animate-spin\" />\n                  <p className=\"text-sm font-medium\">Uploading...</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  <Upload className=\"h-12 w-12 mx-auto text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-lg font-medium\">Drop your resume here</p>\n                    <p className=\"text-sm text-muted-foreground\">or click to browse</p>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">Supports PDF and TXT files up to 10MB</p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card className=\"bg-muted/30\">\n          <CardContent className=\"py-4\">\n            <h4 className=\"font-medium mb-2\">What happens next?</h4>\n            <ul className=\"text-sm text-muted-foreground space-y-2\">\n              <li className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                AI analyzes your transaction and deal experience\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                Assigns you to a Deal Team (Floater, DT10, DT8, DT6, DT4, or DT2)\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                Identifies your vertical fit and deal phase strengths\n              </li>\n              <li className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                Recommends your initial seat on live mandates\n              </li>\n            </ul>\n          </CardContent>\n        </Card>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":17971,"size_tokens":null},"client/src/pages/shared/PersonalityAssessment.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { usePersonalityQuestions, usePersonalityAssessment, useSubmitPersonalityAssessment, useCurrentUser, useResumeAnalysis, type PersonalityScore, type AIAnalysis } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { toast } from \"sonner\";\nimport { CheckCircle2, Brain, Trophy, RefreshCw, ChevronLeft, ChevronRight, Loader2, Target, Briefcase, Users, AlertTriangle, FileText } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\nconst PROFILE_COLORS: Record<string, string> = {\n  'Politician': 'bg-purple-100 text-purple-800 border-purple-300',\n  'Sherpa': 'bg-blue-100 text-blue-800 border-blue-300',\n  'Deal Junkie': 'bg-red-100 text-red-800 border-red-300',\n  'Closer': 'bg-green-100 text-green-800 border-green-300',\n  'Architect': 'bg-slate-100 text-slate-800 border-slate-300',\n  'Firefighter': 'bg-orange-100 text-orange-800 border-orange-300',\n  'Guru': 'bg-indigo-100 text-indigo-800 border-indigo-300',\n  'Misfit': 'bg-pink-100 text-pink-800 border-pink-300',\n  'Legal': 'bg-gray-100 text-gray-800 border-gray-300',\n  'Rainmaker': 'bg-yellow-100 text-yellow-800 border-yellow-300',\n  'Creative': 'bg-cyan-100 text-cyan-800 border-cyan-300',\n  'Auditor': 'bg-emerald-100 text-emerald-800 border-emerald-300',\n  'Mayor': 'bg-amber-100 text-amber-800 border-amber-300',\n  'Liaison': 'bg-teal-100 text-teal-800 border-teal-300',\n  'Grandmaster': 'bg-violet-100 text-violet-800 border-violet-300',\n  'Regulatory': 'bg-rose-100 text-rose-800 border-rose-300',\n};\n\nconst DEAL_TEAM_OPTIONS = [\n  { value: 'Floater', label: 'Floater - New/Rotating Member' },\n  { value: 'Deal Team 10', label: 'Deal Team 10 - Entry Level' },\n  { value: 'Deal Team 8', label: 'Deal Team 8 - Mid Level' },\n  { value: 'Deal Team 6', label: 'Deal Team 6 - Senior' },\n  { value: 'Deal Team 4', label: 'Deal Team 4 - Lead' },\n  { value: 'Deal Team 2', label: 'Deal Team 2 - Principal' },\n];\n\nfunction AnalysisSection({ title, content, icon: Icon }: { title: string; content: string; icon?: any }) {\n  if (!content) return null;\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-center gap-2\">\n        {Icon && <Icon className=\"h-4 w-4 text-muted-foreground\" />}\n        <h3 className=\"font-semibold text-sm\">{title}</h3>\n      </div>\n      <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">{content}</p>\n    </div>\n  );\n}\n\nexport default function PersonalityAssessment() {\n  const [location] = useLocation();\n  const role: 'CEO' | 'Employee' = location.startsWith('/ceo') ? 'CEO' : 'Employee';\n  \n  const { data: currentUser } = useCurrentUser();\n  const { data: questions = [], isLoading: questionsLoading } = usePersonalityQuestions();\n  const { data: existingAssessment, isLoading: assessmentLoading, refetch } = usePersonalityAssessment();\n  const { data: resumeAnalysis } = useResumeAnalysis();\n  const submitAssessment = useSubmitPersonalityAssessment();\n  \n  const [answers, setAnswers] = useState<Record<number, 'A' | 'B'>>({});\n  const [currentQuestion, setCurrentQuestion] = useState(0);\n  const [showResults, setShowResults] = useState(false);\n  const [isRetaking, setIsRetaking] = useState(false);\n  const [dealTeamStatus, setDealTeamStatus] = useState('Floater');\n  \n  // Pre-populate deal team status from resume analysis if available\n  useEffect(() => {\n    const assignedTeam = resumeAnalysis?.aiAnalysis?.onboardingPlacement?.assignedDealTeam;\n    if (assignedTeam) {\n      setDealTeamStatus(assignedTeam);\n    }\n  }, [resumeAnalysis?.aiAnalysis?.onboardingPlacement?.assignedDealTeam]);\n  \n  const isLoading = questionsLoading || assessmentLoading;\n  const isAnalyzing = existingAssessment?.status === 'analyzing';\n  const hasCompletedAssessment = existingAssessment && existingAssessment.status === 'completed' && !isRetaking;\n  \n  useEffect(() => {\n    if (isAnalyzing) {\n      const interval = setInterval(() => {\n        refetch();\n      }, 2000);\n      return () => clearInterval(interval);\n    }\n  }, [isAnalyzing, refetch]);\n  \n  const handleAnswer = (answer: 'A' | 'B') => {\n    setAnswers(prev => ({ ...prev, [questions[currentQuestion].id]: answer }));\n    \n    if (currentQuestion < questions.length - 1) {\n      setTimeout(() => setCurrentQuestion(prev => prev + 1), 200);\n    }\n  };\n  \n  const handleSubmit = async () => {\n    if (Object.keys(answers).length !== 25) {\n      toast.error(\"Please answer all 25 questions\");\n      return;\n    }\n    \n    try {\n      await submitAssessment.mutateAsync({ answers, dealTeamStatus });\n      toast.success(\"Assessment submitted! Analyzing your profile...\");\n      setShowResults(true);\n      setIsRetaking(false);\n    } catch (error: any) {\n      toast.error(error.message);\n    }\n  };\n  \n  const handleRetake = () => {\n    setAnswers({});\n    setCurrentQuestion(0);\n    setShowResults(false);\n    setIsRetaking(true);\n  };\n  \n  const progress = (Object.keys(answers).length / 25) * 100;\n  const currentQ = questions[currentQuestion];\n  const canSubmit = Object.keys(answers).length === 25;\n  \n  if (isLoading) {\n    return (\n      <Layout role={role}>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n        </div>\n      </Layout>\n    );\n  }\n  \n  if (isAnalyzing) {\n    return (\n      <Layout role={role}>\n        <div className=\"max-w-2xl mx-auto\">\n          <Card>\n            <CardContent className=\"py-16 text-center\">\n              <Loader2 className=\"h-12 w-12 animate-spin mx-auto text-primary mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Analyzing Your Profile</h2>\n              <p className=\"text-muted-foreground\">\n                Our AI is analyzing your responses to create your personalized deployment profile.\n                This usually takes about 10-15 seconds...\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </Layout>\n    );\n  }\n  \n  if (hasCompletedAssessment || showResults) {\n    const assessment = existingAssessment;\n    const aiAnalysis = assessment?.aiAnalysis;\n    const deploymentTags = aiAnalysis?.deploymentTags;\n    \n    return (\n      <Layout role={role}>\n        <div className=\"max-w-5xl mx-auto space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-2xl font-bold tracking-tight\">Your Deployment Profile</h1>\n              <p className=\"text-muted-foreground\">\n                {assessment?.completedAt && `Completed on ${format(new Date(assessment.completedAt), 'MMMM d, yyyy')}`}\n              </p>\n            </div>\n            <Button variant=\"outline\" onClick={handleRetake} data-testid=\"button-retake-assessment\">\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\n              Retake Assessment\n            </Button>\n          </div>\n          \n          {deploymentTags && (\n            <Card className=\"bg-gradient-to-r from-primary/5 to-primary/10 border-primary/20\">\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Target className=\"h-5 w-5\" />\n                  Final Deployment Tags\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Deal Team Status</p>\n                    <Badge variant=\"secondary\" className=\"text-sm\">{deploymentTags.dealTeamStatus}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Primary Vertical</p>\n                    <Badge className=\"text-sm bg-blue-600\">{deploymentTags.primaryVertical}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Secondary Vertical</p>\n                    <Badge variant=\"outline\" className=\"text-sm\">{deploymentTags.secondaryVertical}</Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Primary Phase</p>\n                    <Badge className=\"text-sm bg-green-600\">{deploymentTags.primaryDealPhase}</Badge>\n                  </div>\n                </div>\n                <Separator className=\"my-4\" />\n                <div className=\"space-y-2\">\n                  <p className=\"text-xs text-muted-foreground\">Top 5 Archetypes</p>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {deploymentTags.topFiveArchetypes?.map((tag, idx) => (\n                      <Badge \n                        key={idx}\n                        className={cn(\"text-sm border\", PROFILE_COLORS[tag] || 'bg-gray-100 text-gray-800')}\n                      >\n                        {idx + 1}. {tag}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n                {deploymentTags.riskFlag && deploymentTags.riskFlag !== 'No material coverage gaps' && (\n                  <div className=\"mt-4 p-3 rounded-lg bg-amber-50 border border-amber-200\">\n                    <div className=\"flex items-center gap-2 text-amber-800\">\n                      <AlertTriangle className=\"h-4 w-4\" />\n                      <span className=\"text-sm font-medium\">Risk Flag: {deploymentTags.riskFlag}</span>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n          \n          <Tabs defaultValue=\"profile\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"profile\">Profile Analysis</TabsTrigger>\n              <TabsTrigger value=\"deployment\">Deployment Fit</TabsTrigger>\n              <TabsTrigger value=\"management\">Management Notes</TabsTrigger>\n              <TabsTrigger value=\"scores\">Raw Scores</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"profile\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-6\">\n                  {aiAnalysis?.employeeSnapshot && (\n                    <AnalysisSection title=\"Employee Snapshot\" content={aiAnalysis.employeeSnapshot} icon={Users} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.primaryArchetype && (\n                    <AnalysisSection title=\"Primary Archetype\" content={aiAnalysis.primaryArchetype} icon={Trophy} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.secondaryTraits && (\n                    <AnalysisSection title=\"Secondary Traits\" content={aiAnalysis.secondaryTraits} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.supportingTraits && (\n                    <AnalysisSection title=\"Supporting Traits\" content={aiAnalysis.supportingTraits} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.lowSignalTags && (\n                    <AnalysisSection title=\"Low Signal Tags\" content={aiAnalysis.lowSignalTags} />\n                  )}\n                  {aiAnalysis?.absentTraits && (\n                    <>\n                      <Separator />\n                      <AnalysisSection title=\"Absent Traits\" content={aiAnalysis.absentTraits} />\n                    </>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"deployment\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-6\">\n                  {aiAnalysis?.dealPhaseFit && (\n                    <AnalysisSection title=\"Deal Phase Fit\" content={aiAnalysis.dealPhaseFit} icon={Target} />\n                  )}\n                  <Separator />\n                  {aiAnalysis?.dealTypeProficiency && (\n                    <AnalysisSection title=\"Deal Type Proficiency (Verticals)\" content={aiAnalysis.dealTypeProficiency} icon={Briefcase} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"management\" className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6\">\n                  {aiAnalysis?.managerialNotes && (\n                    <AnalysisSection title=\"Managerial Notes\" content={aiAnalysis.managerialNotes} icon={FileText} />\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"scores\" className=\"space-y-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Score Distribution</CardTitle>\n                  <CardDescription>Raw scores from your questionnaire answers</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {aiAnalysis?.scoreDistribution ? (\n                    <pre className=\"text-sm whitespace-pre-wrap bg-muted p-4 rounded-lg\">\n                      {aiAnalysis.scoreDistribution}\n                    </pre>\n                  ) : (\n                    <div className=\"grid grid-cols-3 md:grid-cols-4 gap-2\">\n                      {assessment?.allScores?.map((score: PersonalityScore) => (\n                        <div \n                          key={score.profile}\n                          className={cn(\n                            \"p-2 rounded text-center text-sm border\",\n                            score.score > 0 ? PROFILE_COLORS[score.profile] : 'bg-gray-50 border-gray-200 text-gray-400'\n                          )}\n                        >\n                          <div className=\"font-medium truncate\">{score.profile}</div>\n                          <div className=\"text-xs\">{score.score}</div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n              \n              {!aiAnalysis && assessment?.topThreeProfiles && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Top 3 Profiles (Basic)</CardTitle>\n                    <CardDescription>Based on raw scoring (AI analysis pending)</CardDescription>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    {assessment.topThreeProfiles.map((profile: PersonalityScore, index: number) => (\n                      <div \n                        key={profile.profile}\n                        className={cn(\n                          \"p-3 rounded-lg border-2 flex items-center gap-3\",\n                          PROFILE_COLORS[profile.profile] || 'bg-gray-100 border-gray-300'\n                        )}\n                      >\n                        <div className={cn(\n                          \"w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0\",\n                          index === 0 ? \"bg-yellow-400 text-yellow-900\" :\n                          index === 1 ? \"bg-gray-300 text-gray-700\" :\n                          \"bg-amber-600 text-amber-100\"\n                        )}>\n                          {index + 1}\n                        </div>\n                        <div className=\"flex-1\">\n                          <span className=\"font-semibold\">{profile.profile}</span>\n                          <span className=\"ml-2 text-sm opacity-70\">Score: {profile.score}</span>\n                        </div>\n                      </div>\n                    ))}\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n          </Tabs>\n        </div>\n      </Layout>\n    );\n  }\n  \n  return (\n    <Layout role={role}>\n      <div className=\"max-w-3xl mx-auto space-y-6\">\n        <div className=\"text-center space-y-2\">\n          <div className=\"mx-auto w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n            <Brain className=\"h-8 w-8 text-primary\" />\n          </div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Personality Assessment</h1>\n          <p className=\"text-muted-foreground\">\n            Answer 25 questions to discover your work style and deployment profile\n          </p>\n        </div>\n        \n        {currentQuestion === 0 && Object.keys(answers).length === 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Before You Begin</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"dealTeam\">What is your Deal Team status?</Label>\n                <Select value={dealTeamStatus} onValueChange={setDealTeamStatus}>\n                  <SelectTrigger id=\"dealTeam\" data-testid=\"select-deal-team\">\n                    <SelectValue placeholder=\"Select your deal team\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DEAL_TEAM_OPTIONS.map(opt => (\n                      <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  This helps calibrate your deployment recommendations based on your experience level.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n        \n        <Card>\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\n              <span>Question {currentQuestion + 1} of 25</span>\n              <span>{Object.keys(answers).length} answered</span>\n            </div>\n            <Progress value={progress} className=\"h-2\" />\n          </CardHeader>\n          <CardContent className=\"pt-6\">\n            {currentQ && (\n              <div className=\"space-y-6\">\n                <h2 className=\"text-xl font-medium text-center\" data-testid={`question-${currentQ.id}`}>\n                  {currentQ.question}\n                </h2>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <button\n                    onClick={() => handleAnswer('A')}\n                    className={cn(\n                      \"p-6 rounded-lg border-2 text-left transition-all hover:border-primary hover:bg-primary/5\",\n                      answers[currentQ.id] === 'A' ? \"border-primary bg-primary/10\" : \"border-gray-200\"\n                    )}\n                    data-testid={`answer-${currentQ.id}-A`}\n                  >\n                    <div className=\"flex items-start gap-3\">\n                      <div className={cn(\n                        \"w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0\",\n                        answers[currentQ.id] === 'A' ? \"bg-primary text-primary-foreground\" : \"bg-gray-100\"\n                      )}>\n                        A\n                      </div>\n                      <span className=\"text-lg\">{currentQ.optionA}</span>\n                    </div>\n                  </button>\n                  \n                  <button\n                    onClick={() => handleAnswer('B')}\n                    className={cn(\n                      \"p-6 rounded-lg border-2 text-left transition-all hover:border-primary hover:bg-primary/5\",\n                      answers[currentQ.id] === 'B' ? \"border-primary bg-primary/10\" : \"border-gray-200\"\n                    )}\n                    data-testid={`answer-${currentQ.id}-B`}\n                  >\n                    <div className=\"flex items-start gap-3\">\n                      <div className={cn(\n                        \"w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0\",\n                        answers[currentQ.id] === 'B' ? \"bg-primary text-primary-foreground\" : \"bg-gray-100\"\n                      )}>\n                        B\n                      </div>\n                      <span className=\"text-lg\">{currentQ.optionB}</span>\n                    </div>\n                  </button>\n                </div>\n                \n                <div className=\"flex items-center justify-between pt-4\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setCurrentQuestion(prev => Math.max(0, prev - 1))}\n                    disabled={currentQuestion === 0}\n                  >\n                    <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                    Previous\n                  </Button>\n                  \n                  <div className=\"flex gap-2\">\n                    {canSubmit ? (\n                      <Button \n                        onClick={handleSubmit}\n                        disabled={submitAssessment.isPending}\n                        data-testid=\"button-submit-assessment\"\n                      >\n                        {submitAssessment.isPending ? (\n                          <>\n                            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                            Submitting...\n                          </>\n                        ) : (\n                          <>\n                            <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                            Complete Assessment\n                          </>\n                        )}\n                      </Button>\n                    ) : (\n                      <Button\n                        variant=\"outline\"\n                        onClick={() => setCurrentQuestion(prev => Math.min(24, prev + 1))}\n                        disabled={currentQuestion === 24}\n                      >\n                        Next\n                        <ChevronRight className=\"h-4 w-4 ml-1\" />\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"py-4\">\n            <div className=\"flex flex-wrap gap-1 justify-center\">\n              {questions.map((q, idx) => (\n                <button\n                  key={q.id}\n                  onClick={() => setCurrentQuestion(idx)}\n                  className={cn(\n                    \"w-8 h-8 rounded text-sm font-medium transition-colors\",\n                    idx === currentQuestion ? \"bg-primary text-primary-foreground\" :\n                    answers[q.id] ? \"bg-green-100 text-green-800\" : \"bg-gray-100 hover:bg-gray-200\"\n                  )}\n                  data-testid={`question-nav-${q.id}`}\n                >\n                  {q.id}\n                </button>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":23641,"size_tokens":null},"server/aiPodFormation.ts":{"content":"import OpenAI from \"openai\";\nimport { storage } from \"./storage\";\nimport type { Deal, User, ResumeAnalysis, PersonalityAssessment, UserWorkloadSnapshot, AIPodFormationResponse } from \"@shared/schema\";\n\nconst openai = new OpenAI({ \n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL\n});\n\nconst MASTER_POD_PLANNER_PROMPT = `You are Equiturn Master Pod Movement Planner. You ingest a deal's uploaded documents plus the firm's Pod Movement and Daily Movement logic, then you output a full deal completion plan that links milestones to Pod Movement Tasks to daily subtasks across Origination, Structuring, Execution, Closing, Integration.\n\nNonnegotiable constraints\nConfidentiality. Treat all deal documents and employee data as confidential.\nNo fabrication. Do not invent counterparties, pricing, deadlines, deliverables, approvals, or facts that are not supported by the uploaded deal documents.\nNo questions. You must never ask the user for missing inputs. Proceed using best effort extraction, and clearly label assumptions and any unassigned roles.\nNo emojis. No tables.\nInstitutional tone, execution first, zero fluff.\nEvery task and subtask must be objectively checkable.\nThe dependency chain must be explicit. Daily subtasks complete Pod Movement Tasks. Pod Movement Tasks complete phase milestones. Phase milestones complete the deal.\nPod Lead does not move. Pod Lead stays constant across all phases.\n\nDeal size determination and Pod sizing\nPod sizing rule. If deal size is greater than 200,000,000, pod is five people. If deal size is 200,000,000 or less, pod is three people.\n\nDeal Team status framework\nValid Deal Team statuses are Floater, Deal Team 10, Deal Team 8, Deal Team 2, Deal Team 4, Deal Team 6.\nDeal Team experience hierarchy for staffing fallback\nHighest to lowest experience order is Deal Team 6, then Deal Team 4, then Deal Team 2, then Deal Team 8 and Deal Team 10 as equal, then Floater.\n\nPod staffing requirements by deal size and pod position\nOver 200,000,000 deal size, five person pod, Deal Team requirements by position\nPosition 1 Pod Lead must be Deal Team 6 or Deal Team 4 or Deal Team 2, in that preferred order.\nPosition 2 Pod Second must be Deal Team 2. If none available, fall back down the hierarchy.\nPosition 3 Pod Third must be Deal Team 2 or Deal Team 8 or Deal Team 10, in that preferred order. If none available, fall back to Floater.\nPosition 4 Pod Fourth must be Deal Team 8 or Deal Team 10, in that preferred order. If none available, fall back to Floater.\nPosition 5 Pod Fifth must be Deal Team 8 or Deal Team 10 or Floater, in that preferred order. If none available, mark Unassigned.\n\n200,000,000 or less deal size, three person pod, Deal Team requirements by position\nPosition 1 Pod Lead must be Deal Team 2. If none available, fall back down the hierarchy.\nPosition 2 Pod Second must be Deal Team 8 or Deal Team 10, in that preferred order. If none available, fall back to Floater.\nPosition 3 Pod Third must be Floater. If none available, mark Unassigned.\n\nEmployee tag framework\nCanonical tags that may appear in employee tagging are Politician, Rainmaker, Mayor, Creative, Deal Junkie, Closer, Grandmaster, Architect, Guru, Sherpa, Firefighter, Legal, Liaison, Auditor, Regulatory, Misfit.\n\nPod role mapping and tag requirements\nFive person pod role map\nPod Lead role, required tags priority Grandmaster, Closer, Politician, Architect.\nOrigination Lead role, required tags priority Rainmaker, Politician, Mayor.\nStructuring Lead role, required tags priority Architect, Guru, Regulatory or Auditor when applicable.\nExecution Lead role, required tags priority Sherpa, Deal Junkie, Firefighter, Liaison.\nClosing and Integration Lead role, required tags priority Legal, Closer, Firefighter, Liaison, Auditor.\n\nThree person pod role map\nPod Lead role, required tags priority Grandmaster, Closer, Politician, Architect.\nStructuring Lead role, required tags priority Architect, Guru, Regulatory or Auditor when applicable.\nExecution Lead role, required tags priority Sherpa, Firefighter, Deal Junkie, Liaison.\n\nCRITICAL: You must also consider:\n1. Each employee's current workload (capacity score 0-100, lower is more available)\n2. Chemistry and compatibility between team members based on their personality profiles\n3. Whether they are already assigned to other deals at the same stage\n4. Their strengths for the current deal stage\n\nYou must respond in valid JSON format with this exact structure:\n{\n  \"podSize\": number,\n  \"podMembers\": [\n    {\n      \"position\": number,\n      \"role\": string,\n      \"userId\": string or null,\n      \"userName\": string or null,\n      \"dealTeamStatus\": string or null,\n      \"requiredTags\": string[],\n      \"matchedTags\": string[],\n      \"rationale\": string\n    }\n  ],\n  \"milestones\": [\n    {\n      \"stage\": string,\n      \"title\": string,\n      \"description\": string,\n      \"orderIndex\": number\n    }\n  ],\n  \"podMovementTasks\": [\n    {\n      \"milestoneTitle\": string,\n      \"title\": string,\n      \"ownerRole\": string,\n      \"definitionOfDone\": string,\n      \"qualityGates\": string,\n      \"escalationTriggers\": string\n    }\n  ],\n  \"dailySubtasks\": [\n    {\n      \"parentTaskTitle\": string,\n      \"title\": string,\n      \"assignedRole\": string,\n      \"frequency\": \"daily\" | \"weekly\" | \"monthly\"\n    }\n  ],\n  \"formationRationale\": string,\n  \"dataIntegrityNotes\": string\n}`;\n\nasync function buildUserRoster(usersWithProfiles: Array<{\n  user: User;\n  resumeAnalysis: ResumeAnalysis | null;\n  personalityAssessment: PersonalityAssessment | null;\n  workload: { activeTasks: number; pendingTasks: number; completedThisWeek: number };\n}>): Promise<UserWorkloadSnapshot[]> {\n  const rosterPromises = usersWithProfiles.map(async ({ user, resumeAnalysis, personalityAssessment, workload }) => {\n    const dealTeamStatus = resumeAnalysis?.assignedDealTeam || 'Floater';\n    \n    const personalityTags: string[] = [];\n    if (personalityAssessment?.aiAnalysis?.deploymentTags?.topFiveArchetypes) {\n      personalityTags.push(...personalityAssessment.aiAnalysis.deploymentTags.topFiveArchetypes);\n    }\n    if (resumeAnalysis?.aiAnalysis?.onboardingPlacement?.topFiveInferredTags) {\n      personalityTags.push(...resumeAnalysis.aiAnalysis.onboardingPlacement.topFiveInferredTags);\n    }\n    \n    const uniqueTags = [...new Set(personalityTags)];\n    \n    const capacityScore = Math.min(100, (workload.activeTasks * 20) + (workload.pendingTasks * 10));\n    \n    const currentStages = await storage.getUserCurrentStageAssignments(user.id);\n    \n    return {\n      userId: user.id,\n      userName: user.name,\n      dealTeamStatus,\n      personalityTags: uniqueTags,\n      activeTasks: workload.activeTasks,\n      pendingTasks: workload.pendingTasks,\n      completedThisWeek: workload.completedThisWeek,\n      activeDeals: user.activeDeals || 0,\n      capacityScore,\n      currentStages\n    };\n  });\n  \n  return Promise.all(rosterPromises);\n}\n\nexport async function formPodForDeal(\n  deal: Deal,\n  stage: string,\n  existingPodLeadId?: string\n): Promise<{ success: boolean; podId?: string; error?: string }> {\n  try {\n    console.log(`[AI Pod Formation] Starting pod formation for deal ${deal.id} at stage ${stage}`);\n    \n    const usersWithProfiles = await storage.getAllUsersWithProfiles();\n    const userRoster = await buildUserRoster(usersWithProfiles);\n    \n    const dealDocuments = await storage.getDealContextUpdates(deal.id);\n    const documentContents = dealDocuments\n      .filter(d => d.updateType === 'document' && d.content)\n      .map(d => ({ name: d.title, content: d.content || '' }));\n    \n    const dealValue = deal.value * 1000000;\n    const podSize = dealValue > 200000000 ? 5 : 3;\n    \n    const prompt = `\nDEAL INFORMATION:\nDeal Name: ${deal.name}\nDeal Type: ${deal.dealType}\nDeal Value: $${dealValue.toLocaleString()} (${deal.value}M)\nClient: ${deal.client}\nSector: ${deal.sector}\nCurrent Stage: ${stage}\nDescription: ${deal.description || 'Not provided'}\n\nPOD SIZE DETERMINATION:\nBased on deal value of $${dealValue.toLocaleString()}, the pod size is ${podSize} people.\n\n${existingPodLeadId ? `EXISTING POD LEAD: The Pod Lead from previous stage must be maintained. Pod Lead User ID: ${existingPodLeadId}` : ''}\n\nDEAL DOCUMENTS:\n${documentContents.length > 0 ? documentContents.map(d => `--- ${d.name} ---\\n${d.content}`).join('\\n\\n') : 'No documents uploaded yet. Use standard phase ladder.'}\n\nEMPLOYEE ROSTER:\n${userRoster.map(u => `\nUser: ${u.userName} (ID: ${u.userId})\nDeal Team Status: ${u.dealTeamStatus}\nPersonality Tags: ${u.personalityTags.join(', ') || 'None assessed'}\nCurrent Workload: ${u.activeTasks} active tasks, ${u.pendingTasks} pending tasks\nCapacity Score: ${u.capacityScore}/100 (lower is more available)\nActive Deals: ${u.activeDeals}\nCurrent Stage Assignments: ${u.currentStages.length > 0 ? u.currentStages.join(', ') : 'None'}\nAVAILABILITY FOR ${stage}: ${u.currentStages.includes(stage) ? 'ALREADY ASSIGNED TO THIS STAGE - PREFER NOT TO ASSIGN' : 'Available'}\n`).join('\\n')}\n\nBased on this information, form the optimal pod team and create the full deal completion plan.\nPrioritize team members with lower capacity scores (more available) while still meeting Deal Team status requirements.\nConsider personality tag compatibility for team chemistry.\n`;\n\n    console.log(`[AI Pod Formation] Calling OpenAI with ${userRoster.length} available users`);\n    \n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: MASTER_POD_PLANNER_PROMPT },\n        { role: \"user\", content: prompt }\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.3,\n      max_tokens: 8000\n    });\n\n    const content = response.choices[0].message.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    console.log(`[AI Pod Formation] Received AI response, parsing...`);\n    \n    const aiResponse: AIPodFormationResponse = JSON.parse(content);\n    \n    if (aiResponse.podSize !== podSize) {\n      console.warn(`[AI Pod Formation] AI returned pod size ${aiResponse.podSize}, but business rule requires ${podSize}. Using deterministic value.`);\n    }\n    \n    const aiLeadMember = aiResponse.podMembers.find(m => m.position === 1);\n    let finalLeadUserId = existingPodLeadId || aiLeadMember?.userId || null;\n    \n    if (existingPodLeadId) {\n      const existingLeadUser = userRoster.find(u => u.userId === existingPodLeadId);\n      if (!existingLeadUser) {\n        console.error(`[AI Pod Formation] CRITICAL: Existing pod lead ${existingPodLeadId} not found in active user roster. Cannot persist lead.`);\n        throw new Error(`Pod lead ${existingPodLeadId} not found in active roster. The lead may be inactive or removed.`);\n      }\n      \n      const leadInAIResponse = aiResponse.podMembers.find(m => m.userId === existingPodLeadId);\n      if (!leadInAIResponse) {\n        console.log(`[AI Pod Formation] Enforcing Pod Lead persistence - AI did not include existing lead ${existingPodLeadId}`);\n        const evictedLead = aiResponse.podMembers.find(m => m.position === 1);\n        if (evictedLead) {\n          aiResponse.podMembers = aiResponse.podMembers.filter(m => m.position !== 1);\n        }\n        aiResponse.podMembers.unshift({\n          position: 1,\n          role: 'Pod Lead',\n          userId: existingPodLeadId,\n          userName: existingLeadUser.userName,\n          dealTeamStatus: existingLeadUser.dealTeamStatus,\n          requiredTags: ['Grandmaster', 'Closer', 'Politician', 'Architect'],\n          matchedTags: existingLeadUser.personalityTags.filter(t => \n            ['Grandmaster', 'Closer', 'Politician', 'Architect'].includes(t)\n          ),\n          rationale: 'Pod Lead persisted from previous stage (Pod Lead does not move rule)'\n        });\n      }\n    }\n    \n    if (finalLeadUserId) {\n      const leadInFinalMembers = aiResponse.podMembers.find(m => m.userId === finalLeadUserId);\n      if (!leadInFinalMembers) {\n        console.error(`[AI Pod Formation] CRITICAL: Final lead ${finalLeadUserId} not in pod members list after normalization`);\n        throw new Error(`Pod lead integrity check failed. Lead ${finalLeadUserId} not in final membership list.`);\n      }\n    }\n    \n    const membersWithIds = aiResponse.podMembers.filter(m => m.userId);\n    if (membersWithIds.length < Math.min(podSize, 2)) {\n      console.warn(`[AI Pod Formation] WARNING: Only ${membersWithIds.length} assignable members for a ${podSize}-person pod`);\n    }\n    \n    const pod = await storage.createDealPod({\n      dealId: deal.id,\n      stage,\n      podSize,\n      leadUserId: finalLeadUserId,\n      aiFormationRationale: aiResponse.formationRationale,\n      aiRawResponse: content,\n      status: 'active'\n    });\n    \n    console.log(`[AI Pod Formation] Created pod ${pod.id} with ${aiResponse.podMembers.length} members (deterministic size: ${podSize})`);\n    \n    const addedUserIds = new Set<string>();\n    for (const member of aiResponse.podMembers) {\n      if (member.userId && !addedUserIds.has(member.userId)) {\n        addedUserIds.add(member.userId);\n        await storage.createPodMember({\n          podId: pod.id,\n          userId: member.userId,\n          role: member.role,\n          position: member.position,\n          dealTeamStatus: member.dealTeamStatus,\n          requiredTags: member.requiredTags,\n          matchedTags: member.matchedTags,\n          assignmentRationale: member.rationale,\n          isLead: member.position === 1 || member.userId === finalLeadUserId\n        });\n        \n        // Also create stage_pod_members entry for frontend display\n        const user = await storage.getUser(member.userId);\n        if (user) {\n          await storage.createStagePodMember({\n            dealId: deal.id,\n            stage,\n            userId: member.userId,\n            userName: user.name || member.userName || 'Unknown',\n            role: member.role,\n            email: user.email,\n            phone: user.phone || undefined,\n            isLead: member.position === 1 || member.userId === finalLeadUserId\n          });\n        }\n      }\n    }\n    \n    if (finalLeadUserId && !addedUserIds.has(finalLeadUserId)) {\n      console.error(`[AI Pod Formation] CRITICAL: Lead ${finalLeadUserId} was not added to pod_members table`);\n      throw new Error(`Pod lead integrity check failed. Lead was not persisted to membership table.`);\n    }\n    \n    const milestoneMap: Record<string, string> = {};\n    for (const milestone of aiResponse.milestones) {\n      const created = await storage.createDealMilestone({\n        dealId: deal.id,\n        podId: pod.id,\n        stage: milestone.stage,\n        title: milestone.title,\n        description: milestone.description,\n        orderIndex: milestone.orderIndex\n      });\n      milestoneMap[milestone.title] = created.id;\n    }\n    \n    console.log(`[AI Pod Formation] Created ${aiResponse.milestones.length} milestones`);\n    \n    const taskMap: Record<string, string> = {};\n    for (const task of aiResponse.podMovementTasks) {\n      const milestoneId = milestoneMap[task.milestoneTitle] || null;\n      \n      const assignedMember = aiResponse.podMembers.find(m => m.role === task.ownerRole);\n      \n      const created = await storage.createPodMovementTask({\n        dealId: deal.id,\n        milestoneId,\n        podId: pod.id,\n        title: task.title,\n        ownerRole: task.ownerRole,\n        assignedTo: assignedMember?.userId || null,\n        definitionOfDone: task.definitionOfDone,\n        qualityGates: task.qualityGates,\n        escalationTriggers: task.escalationTriggers,\n        status: 'pending'\n      });\n      taskMap[task.title] = created.id;\n    }\n    \n    console.log(`[AI Pod Formation] Created ${aiResponse.podMovementTasks.length} pod movement tasks`);\n    \n    let tasksCreated = 0;\n    for (const subtask of aiResponse.dailySubtasks) {\n      const assignedMember = aiResponse.podMembers.find(m => m.role === subtask.assignedRole);\n      \n      // If no role match, assign to a random pod member with a userId\n      const memberWithUserId = assignedMember?.userId \n        ? assignedMember \n        : aiResponse.podMembers.find(m => m.userId);\n      \n      if (memberWithUserId?.userId) {\n        const priority = subtask.frequency === 'daily' ? 'High' : \n                        subtask.frequency === 'weekly' ? 'Medium' : 'Low';\n        \n        try {\n          await storage.createTask({\n            title: subtask.title,\n            description: `Part of: ${subtask.parentTaskTitle}\\nFrequency: ${subtask.frequency}`,\n            dealId: deal.id,\n            dealStage: stage,\n            assignedTo: memberWithUserId.userId,\n            priority,\n            type: 'Deal',\n            status: 'Pending'\n          });\n          tasksCreated++;\n        } catch (taskError) {\n          console.error(`[AI Pod Formation] Failed to create task \"${subtask.title}\":`, taskError);\n        }\n      } else {\n        console.warn(`[AI Pod Formation] No pod member available to assign subtask: ${subtask.title}`);\n      }\n    }\n    \n    console.log(`[AI Pod Formation] Created ${tasksCreated}/${aiResponse.dailySubtasks.length} daily subtasks as tasks`);\n    \n    const podMemberUserIds = aiResponse.podMembers\n      .filter(m => m.userId)\n      .map(m => m.userId as string);\n    \n    for (const userId of podMemberUserIds) {\n      await storage.createNotification({\n        userId,\n        title: `Assigned to Deal: ${deal.name}`,\n        message: `You have been assigned to the pod team for \"${deal.name}\" (${stage} stage). Check your tasks for new assignments.`,\n        type: 'info',\n        link: `/ceo/deals?id=${deal.id}`\n      });\n    }\n    \n    await storage.createDealContextUpdate({\n      dealId: deal.id,\n      updateType: 'status_change',\n      title: `Pod team formed for ${stage} stage`,\n      content: aiResponse.formationRationale,\n      metadata: { podId: pod.id, stage, podSize: aiResponse.podSize }\n    });\n    \n    console.log(`[AI Pod Formation] Pod formation complete for deal ${deal.id}`);\n    \n    return { success: true, podId: pod.id };\n    \n  } catch (error: any) {\n    console.error(`[AI Pod Formation] Error:`, error);\n    return { success: false, error: error.message };\n  }\n}\n\nexport async function transitionDealStage(\n  dealId: string,\n  newStage: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const deal = await storage.getDeal(dealId);\n    if (!deal) {\n      return { success: false, error: \"Deal not found\" };\n    }\n    \n    const currentPod = await storage.getActivePodForDeal(dealId);\n    const existingLeadId = currentPod?.leadUserId || undefined;\n    \n    if (currentPod) {\n      await storage.updateDealPod(currentPod.id, { status: 'completed' });\n    }\n    \n    await storage.updateDeal(dealId, { stage: newStage });\n    \n    const result = await formPodForDeal(deal, newStage, existingLeadId);\n    \n    return result;\n    \n  } catch (error: any) {\n    console.error(`[Stage Transition] Error:`, error);\n    return { success: false, error: error.message };\n  }\n}\n\nexport async function approveOpportunityToDeal(\n  opportunityId: string\n): Promise<{ success: boolean; dealId?: string; error?: string }> {\n  try {\n    const opportunity = await storage.getDeal(opportunityId);\n    if (!opportunity) {\n      return { success: false, error: \"Opportunity not found\" };\n    }\n    \n    if (opportunity.dealType !== 'Opportunity') {\n      return { success: false, error: \"This is not an opportunity\" };\n    }\n    \n    const dealType = opportunity.value > 200 ? 'M&A' : 'Capital Raising';\n    \n    const updatedDeal = await storage.updateDeal(opportunityId, {\n      dealType,\n      stage: 'Origination',\n      status: 'Active'\n    });\n    \n    if (!updatedDeal) {\n      return { success: false, error: \"Failed to update deal\" };\n    }\n    \n    await storage.createDealContextUpdate({\n      dealId: opportunityId,\n      updateType: 'status_change',\n      title: 'Opportunity approved and converted to active deal',\n      content: `Deal type set to ${dealType}. Starting automated pod formation.`,\n      metadata: { previousType: 'Opportunity', newType: dealType }\n    });\n    \n    console.log(`[Opportunity Approval] Opportunity ${opportunityId} approved, forming pod...`);\n    \n    const podResult = await formPodForDeal(updatedDeal, 'Origination');\n    \n    if (!podResult.success) {\n      console.error(`[Opportunity Approval] Pod formation failed: ${podResult.error}`);\n    }\n    \n    return { success: true, dealId: opportunityId };\n    \n  } catch (error: any) {\n    console.error(`[Opportunity Approval] Error:`, error);\n    return { success: false, error: error.message };\n  }\n}\n","path":null,"size_bytes":20723,"size_tokens":null},"client/src/pages/ceo/TeamProfiles.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Layout } from \"@/components/layout/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Users,\n  Search,\n  Brain,\n  FileText,\n  CheckCircle2,\n  XCircle,\n  Clock,\n  ChevronRight,\n  Briefcase,\n  Target,\n  Star,\n  AlertTriangle,\n  User\n} from \"lucide-react\";\nimport { useCurrentUser, useUsers, useOnboardingStatus } from \"@/lib/api\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\ntype PersonalityAssessment = {\n  id: string;\n  userId: string;\n  status: string;\n  completedAt?: string;\n  topThreeProfiles?: { profile: string; score: number }[];\n  aiAnalysis?: {\n    employeeSnapshot: string;\n    primaryArchetype: string;\n    secondaryTraits: string;\n    dealPhaseFit: string;\n    dealTypeProficiency: string;\n    managerialNotes: string;\n  } | null;\n};\n\ntype ResumeAnalysis = {\n  id: string;\n  userId: string;\n  fileName: string;\n  status: string;\n  completedAt?: string;\n  assignedDealTeam?: string;\n  aiAnalysis?: {\n    candidateSnapshot: string;\n    evidenceAnchors: string;\n    transactionProfile: string;\n    dealPhaseFit: string;\n    dealTypeProficiency: string;\n    managerialNotes: string;\n    onboardingPlacement?: {\n      assignedDealTeam: string;\n      primaryVertical: string;\n      secondaryVertical: string;\n      primaryDealPhase: string;\n      secondaryDealPhase: string;\n      initialSeatRecommendation: string;\n      topFiveInferredTags: string[];\n    };\n  } | null;\n};\n\nexport default function TeamProfiles() {\n  const { data: currentUser } = useCurrentUser();\n  const { data: users = [] } = useUsers();\n  const { data: onboardingStatus = {} } = useOnboardingStatus();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState(\"all\");\n\n  const { data: allPersonalityAssessments = [] } = useQuery<PersonalityAssessment[]>({\n    queryKey: [\"all-personality-assessments\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/personality-assessments\", {\n        credentials: \"include\",\n      });\n      if (!res.ok) return [];\n      return res.json();\n    },\n  });\n\n  const { data: allResumeAnalyses = [] } = useQuery<ResumeAnalysis[]>({\n    queryKey: [\"all-resume-analyses\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/resume-analyses\", {\n        credentials: \"include\",\n      });\n      if (!res.ok) return [];\n      return res.json();\n    },\n  });\n\n  const filteredUsers = useMemo(() => {\n    let result = users.filter(u => u.status === 'active');\n    \n    if (searchQuery) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter(u => \n        u.name.toLowerCase().includes(query) || \n        u.email.toLowerCase().includes(query)\n      );\n    }\n    \n    if (activeTab === \"complete\") {\n      result = result.filter(u => onboardingStatus[u.id]?.isComplete);\n    } else if (activeTab === \"incomplete\") {\n      result = result.filter(u => !onboardingStatus[u.id]?.isComplete);\n    }\n    \n    return result;\n  }, [users, searchQuery, activeTab, onboardingStatus]);\n\n  const selectedUser = users.find(u => u.id === selectedUserId);\n  const selectedPersonality = allPersonalityAssessments.find(a => a.userId === selectedUserId);\n  const selectedResume = allResumeAnalyses.find(a => a.userId === selectedUserId);\n\n  const stats = useMemo(() => {\n    const activeUsers = users.filter(u => u.status === 'active');\n    const complete = activeUsers.filter(u => onboardingStatus[u.id]?.isComplete).length;\n    const hasResume = activeUsers.filter(u => onboardingStatus[u.id]?.hasResume).length;\n    const hasPersonality = activeUsers.filter(u => onboardingStatus[u.id]?.hasPersonality).length;\n    return { total: activeUsers.length, complete, hasResume, hasPersonality };\n  }, [users, onboardingStatus]);\n\n  const getInitials = (name: string) => {\n    return name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();\n  };\n\n  return (\n    <Layout role=\"CEO\" pageTitle=\"Team Profiles\" userName={currentUser?.name || \"\"}>\n      <div className=\"space-y-6\">\n        <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n              <Users className=\"w-6 h-6 text-primary\" />\n              Team Onboarding Profiles\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              View team members' resume analysis and personality assessment results\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center\">\n                  <Users className=\"w-6 h-6 text-blue-500\" />\n                </div>\n                <div>\n                  <div className=\"text-2xl font-bold\">{stats.total}</div>\n                  <div className=\"text-sm text-muted-foreground\">Active Team Members</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500\" />\n                </div>\n                <div>\n                  <div className=\"text-2xl font-bold\">{stats.complete}</div>\n                  <div className=\"text-sm text-muted-foreground\">Fully Onboarded</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center\">\n                  <FileText className=\"w-6 h-6 text-purple-500\" />\n                </div>\n                <div>\n                  <div className=\"text-2xl font-bold\">{stats.hasResume}</div>\n                  <div className=\"text-sm text-muted-foreground\">Resume Completed</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center\">\n                  <Brain className=\"w-6 h-6 text-amber-500\" />\n                </div>\n                <div>\n                  <div className=\"text-2xl font-bold\">{stats.hasPersonality}</div>\n                  <div className=\"text-sm text-muted-foreground\">Personality Completed</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n              <div className=\"relative flex-1 max-w-md\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input \n                  placeholder=\"Search team members...\" \n                  className=\"pl-9\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  data-testid=\"input-search-profiles\"\n                />\n              </div>\n              <Tabs value={activeTab} onValueChange={setActiveTab}>\n                <TabsList>\n                  <TabsTrigger value=\"all\">All ({stats.total})</TabsTrigger>\n                  <TabsTrigger value=\"complete\">Complete ({stats.complete})</TabsTrigger>\n                  <TabsTrigger value=\"incomplete\">Incomplete ({stats.total - stats.complete})</TabsTrigger>\n                </TabsList>\n              </Tabs>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <ScrollArea className=\"h-[500px]\">\n              <div className=\"space-y-2\">\n                {filteredUsers.length === 0 ? (\n                  <div className=\"text-center py-12 text-muted-foreground\">\n                    No team members found\n                  </div>\n                ) : (\n                  filteredUsers.map(user => {\n                    const status = onboardingStatus[user.id];\n                    const personality = allPersonalityAssessments.find(a => a.userId === user.id);\n                    const resume = allResumeAnalyses.find(a => a.userId === user.id);\n                    \n                    return (\n                      <div \n                        key={user.id}\n                        onClick={() => setSelectedUserId(user.id)}\n                        className={cn(\n                          \"p-4 rounded-lg border cursor-pointer transition-all hover:border-primary/50\",\n                          selectedUserId === user.id ? \"border-primary bg-primary/5\" : \"border-border\"\n                        )}\n                        data-testid={`profile-card-${user.id}`}\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-3\">\n                            <Avatar className=\"h-10 w-10\">\n                              <AvatarFallback className=\"bg-primary/20 text-primary\">\n                                {getInitials(user.name)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <div className=\"font-medium flex items-center gap-2\">\n                                {user.name}\n                                {status?.isComplete ? (\n                                  <Badge variant=\"default\" className=\"bg-green-500/20 text-green-500 border-green-500/30\">\n                                    <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                                    Complete\n                                  </Badge>\n                                ) : (\n                                  <Badge variant=\"outline\" className=\"text-amber-500 border-amber-500/30\">\n                                    <Clock className=\"w-3 h-3 mr-1\" />\n                                    Incomplete\n                                  </Badge>\n                                )}\n                              </div>\n                              <div className=\"text-sm text-muted-foreground\">{user.email}</div>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-4\">\n                            <div className=\"flex items-center gap-2\">\n                              <div className={cn(\n                                \"w-8 h-8 rounded-full flex items-center justify-center\",\n                                status?.hasResume ? \"bg-green-500/20\" : \"bg-muted\"\n                              )}>\n                                <FileText className={cn(\"w-4 h-4\", status?.hasResume ? \"text-green-500\" : \"text-muted-foreground\")} />\n                              </div>\n                              <div className={cn(\n                                \"w-8 h-8 rounded-full flex items-center justify-center\",\n                                status?.hasPersonality ? \"bg-green-500/20\" : \"bg-muted\"\n                              )}>\n                                <Brain className={cn(\"w-4 h-4\", status?.hasPersonality ? \"text-green-500\" : \"text-muted-foreground\")} />\n                              </div>\n                            </div>\n                            {personality?.topThreeProfiles?.[0] && (\n                              <Badge variant=\"secondary\" className=\"hidden md:flex\">\n                                {personality.topThreeProfiles[0].profile}\n                              </Badge>\n                            )}\n                            {resume?.assignedDealTeam && (\n                              <Badge variant=\"outline\" className=\"hidden md:flex\">\n                                {resume.assignedDealTeam}\n                              </Badge>\n                            )}\n                            <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n\n        <Dialog open={!!selectedUserId} onOpenChange={(open) => !open && setSelectedUserId(null)}>\n          <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-3\">\n                <Avatar className=\"h-10 w-10\">\n                  <AvatarFallback className=\"bg-primary/20 text-primary\">\n                    {selectedUser ? getInitials(selectedUser.name) : '?'}\n                  </AvatarFallback>\n                </Avatar>\n                <div>\n                  <div>{selectedUser?.name}</div>\n                  <div className=\"text-sm font-normal text-muted-foreground\">{selectedUser?.email}</div>\n                </div>\n              </DialogTitle>\n              <DialogDescription>\n                Onboarding profile and assessment results\n              </DialogDescription>\n            </DialogHeader>\n\n            <Tabs defaultValue=\"personality\" className=\"mt-4\">\n              <TabsList className=\"grid w-full grid-cols-2\">\n                <TabsTrigger value=\"personality\" className=\"flex items-center gap-2\">\n                  <Brain className=\"w-4 h-4\" />\n                  Personality Profile\n                </TabsTrigger>\n                <TabsTrigger value=\"resume\" className=\"flex items-center gap-2\">\n                  <FileText className=\"w-4 h-4\" />\n                  Resume Analysis\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"personality\" className=\"mt-4 space-y-4\">\n                {!selectedPersonality || selectedPersonality.status !== 'completed' ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Brain className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                    <p>Personality assessment not completed yet</p>\n                  </div>\n                ) : (\n                  <>\n                    {selectedPersonality.topThreeProfiles && (\n                      <Card>\n                        <CardHeader className=\"pb-3\">\n                          <CardTitle className=\"text-base flex items-center gap-2\">\n                            <Star className=\"w-4 h-4 text-amber-500\" />\n                            Top Personality Profiles\n                          </CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"flex gap-2 flex-wrap\">\n                            {selectedPersonality.topThreeProfiles.map((p, i) => (\n                              <Badge \n                                key={p.profile} \n                                variant={i === 0 ? \"default\" : \"secondary\"}\n                                className={i === 0 ? \"bg-primary\" : \"\"}\n                              >\n                                {i + 1}. {p.profile} ({p.score})\n                              </Badge>\n                            ))}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    )}\n\n                    {selectedPersonality.aiAnalysis && (\n                      <>\n                        <Card>\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-base\">Employee Snapshot</CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                              {selectedPersonality.aiAnalysis.employeeSnapshot}\n                            </p>\n                          </CardContent>\n                        </Card>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base\">Primary Archetype</CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm\">{selectedPersonality.aiAnalysis.primaryArchetype}</p>\n                            </CardContent>\n                          </Card>\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base\">Secondary Traits</CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm\">{selectedPersonality.aiAnalysis.secondaryTraits}</p>\n                            </CardContent>\n                          </Card>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base flex items-center gap-2\">\n                                <Target className=\"w-4 h-4\" />\n                                Deal Phase Fit\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground\">{selectedPersonality.aiAnalysis.dealPhaseFit}</p>\n                            </CardContent>\n                          </Card>\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base flex items-center gap-2\">\n                                <Briefcase className=\"w-4 h-4\" />\n                                Deal Type Proficiency\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground\">{selectedPersonality.aiAnalysis.dealTypeProficiency}</p>\n                            </CardContent>\n                          </Card>\n                        </div>\n\n                        {selectedPersonality.aiAnalysis.managerialNotes && (\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base flex items-center gap-2\">\n                                <AlertTriangle className=\"w-4 h-4 text-amber-500\" />\n                                Managerial Notes\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                                {selectedPersonality.aiAnalysis.managerialNotes}\n                              </p>\n                            </CardContent>\n                          </Card>\n                        )}\n                      </>\n                    )}\n\n                    {selectedPersonality.completedAt && (\n                      <p className=\"text-xs text-muted-foreground text-center\">\n                        Completed on {format(new Date(selectedPersonality.completedAt), 'MMM d, yyyy \\'at\\' h:mm a')}\n                      </p>\n                    )}\n                  </>\n                )}\n              </TabsContent>\n\n              <TabsContent value=\"resume\" className=\"mt-4 space-y-4\">\n                {!selectedResume || selectedResume.status !== 'completed' ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <FileText className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                    <p>Resume analysis not completed yet</p>\n                  </div>\n                ) : (\n                  <>\n                    {selectedResume.aiAnalysis?.onboardingPlacement && (\n                      <Card>\n                        <CardHeader className=\"pb-3\">\n                          <CardTitle className=\"text-base flex items-center gap-2\">\n                            <Target className=\"w-4 h-4 text-green-500\" />\n                            Onboarding Placement\n                          </CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Deal Team</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.assignedDealTeam}</div>\n                            </div>\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Primary Vertical</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.primaryVertical}</div>\n                            </div>\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Primary Deal Phase</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.primaryDealPhase}</div>\n                            </div>\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Secondary Vertical</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.secondaryVertical}</div>\n                            </div>\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Secondary Deal Phase</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.secondaryDealPhase}</div>\n                            </div>\n                            <div className=\"p-3 bg-secondary/30 rounded-lg\">\n                              <div className=\"text-xs text-muted-foreground\">Initial Seat</div>\n                              <div className=\"font-medium\">{selectedResume.aiAnalysis.onboardingPlacement.initialSeatRecommendation}</div>\n                            </div>\n                          </div>\n                          {selectedResume.aiAnalysis.onboardingPlacement.topFiveInferredTags?.length > 0 && (\n                            <div className=\"mt-3\">\n                              <div className=\"text-xs text-muted-foreground mb-2\">Inferred Tags</div>\n                              <div className=\"flex flex-wrap gap-1\">\n                                {selectedResume.aiAnalysis.onboardingPlacement.topFiveInferredTags.map((tag, i) => (\n                                  <Badge key={i} variant=\"outline\">{tag}</Badge>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    )}\n\n                    {selectedResume.aiAnalysis && (\n                      <>\n                        <Card>\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-base\">Candidate Snapshot</CardTitle>\n                          </CardHeader>\n                          <CardContent>\n                            <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                              {selectedResume.aiAnalysis.candidateSnapshot}\n                            </p>\n                          </CardContent>\n                        </Card>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base\">Transaction Profile</CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground\">{selectedResume.aiAnalysis.transactionProfile}</p>\n                            </CardContent>\n                          </Card>\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base\">Evidence Anchors</CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground\">{selectedResume.aiAnalysis.evidenceAnchors}</p>\n                            </CardContent>\n                          </Card>\n                        </div>\n\n                        {selectedResume.aiAnalysis.managerialNotes && (\n                          <Card>\n                            <CardHeader className=\"pb-3\">\n                              <CardTitle className=\"text-base flex items-center gap-2\">\n                                <AlertTriangle className=\"w-4 h-4 text-amber-500\" />\n                                Managerial Notes\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent>\n                              <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                                {selectedResume.aiAnalysis.managerialNotes}\n                              </p>\n                            </CardContent>\n                          </Card>\n                        )}\n                      </>\n                    )}\n\n                    <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                      <span>File: {selectedResume.fileName}</span>\n                      {selectedResume.completedAt && (\n                        <span>Completed on {format(new Date(selectedResume.completedAt), 'MMM d, yyyy \\'at\\' h:mm a')}</span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </TabsContent>\n            </Tabs>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </Layout>\n  );\n}\n","path":null,"size_bytes":27555,"size_tokens":null},"client/src/components/WelcomeModal.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Briefcase, \n  Users, \n  FileText, \n  Brain, \n  ArrowRight, \n  ArrowLeft,\n  Rocket,\n  CheckCircle2\n} from \"lucide-react\";\n\ninterface WelcomeModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  userName?: string;\n}\n\nconst steps = [\n  {\n    icon: Rocket,\n    title: \"Welcome to Kronos\",\n    description: \"Your intelligent M&A deal management platform. We're excited to have you on board!\",\n    details: [\n      \"Streamlined deal pipeline management\",\n      \"AI-powered team formation and task assignment\",\n      \"Real-time collaboration and document handling\"\n    ]\n  },\n  {\n    icon: Users,\n    title: \"Join Your Team\",\n    description: \"Kronos automatically matches you with optimal deal teams based on your skills, experience, and personality.\",\n    details: [\n      \"AI analyzes your resume to understand your strengths\",\n      \"Personality assessment helps optimize team chemistry\",\n      \"Smart workload balancing across deals\"\n    ]\n  },\n  {\n    icon: Briefcase,\n    title: \"Manage Deals\",\n    description: \"Track deals through every stage from origination to close, with full visibility into tasks, milestones, and deadlines.\",\n    details: [\n      \"Visual deal pipeline with stage tracking\",\n      \"Automated task creation and assignment\",\n      \"Investor matching and CRM integration\"\n    ]\n  },\n  {\n    icon: Brain,\n    title: \"Complete Your Onboarding\",\n    description: \"To get the most out of Kronos, complete your profile by uploading your resume and taking a quick personality assessment.\",\n    details: [\n      \"Upload your resume for AI analysis\",\n      \"Complete the personality assessment\",\n      \"Get matched to deals that fit your profile\"\n    ],\n    isOnboardingStep: true\n  }\n];\n\nexport function WelcomeModal({ isOpen, onClose, userName }: WelcomeModalProps) {\n  const [currentStep, setCurrentStep] = useState(0);\n  const isLastStep = currentStep === steps.length - 1;\n  const isFirstStep = currentStep === 0;\n  \n  const handleNext = () => {\n    if (isLastStep) {\n      onClose();\n    } else {\n      setCurrentStep(prev => prev + 1);\n    }\n  };\n  \n  const handleBack = () => {\n    if (!isFirstStep) {\n      setCurrentStep(prev => prev - 1);\n    }\n  };\n  \n  const handleSkip = () => {\n    onClose();\n  };\n\n  const step = steps[currentStep];\n  const Icon = step.icon;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent \n        className=\"sm:max-w-[520px] p-0 overflow-hidden\"\n        data-testid=\"welcome-modal\"\n      >\n        <div className=\"bg-gradient-to-br from-primary/10 via-primary/5 to-background p-8\">\n          <div className=\"flex flex-col items-center text-center\">\n            <div className=\"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n              <Icon className=\"w-8 h-8 text-primary\" />\n            </div>\n            \n            <h2 className=\"text-2xl font-semibold mb-2\" data-testid=\"welcome-step-title\">\n              {currentStep === 0 && userName \n                ? `Welcome to Kronos, ${userName}!`\n                : step.title\n              }\n            </h2>\n            \n            <p className=\"text-muted-foreground mb-6\" data-testid=\"welcome-step-description\">\n              {step.description}\n            </p>\n            \n            <div className=\"w-full space-y-3 text-left\">\n              {step.details.map((detail, index) => (\n                <div \n                  key={index}\n                  className=\"flex items-start gap-3 p-3 rounded-lg bg-card/50 border border-border/50\"\n                >\n                  <CheckCircle2 className=\"w-5 h-5 text-primary shrink-0 mt-0.5\" />\n                  <span className=\"text-sm\">{detail}</span>\n                </div>\n              ))}\n            </div>\n            \n            {step.isOnboardingStep && (\n              <div className=\"mt-4 p-4 rounded-lg bg-amber-500/10 border border-amber-500/20 w-full\">\n                <p className=\"text-sm text-amber-600 dark:text-amber-400 font-medium\">\n                  Your profile is not yet complete. Complete onboarding to get matched to deals!\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n        \n        <div className=\"p-6 border-t bg-card/50\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              {steps.map((_, index) => (\n                <button\n                  key={index}\n                  onClick={() => setCurrentStep(index)}\n                  className={`w-2 h-2 rounded-full transition-colors ${\n                    index === currentStep \n                      ? 'bg-primary' \n                      : 'bg-muted-foreground/30 hover:bg-muted-foreground/50'\n                  }`}\n                  data-testid={`welcome-step-indicator-${index}`}\n                />\n              ))}\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              {!isFirstStep && (\n                <Button \n                  variant=\"outline\" \n                  onClick={handleBack}\n                  data-testid=\"welcome-back-button\"\n                >\n                  <ArrowLeft className=\"w-4 h-4 mr-1\" />\n                  Back\n                </Button>\n              )}\n              \n              {!isLastStep && (\n                <Button \n                  variant=\"ghost\" \n                  onClick={handleSkip}\n                  data-testid=\"welcome-skip-button\"\n                >\n                  Skip\n                </Button>\n              )}\n              \n              <Button \n                onClick={handleNext}\n                data-testid=\"welcome-next-button\"\n              >\n                {isLastStep ? (\n                  <>\n                    Get Started\n                    <Rocket className=\"w-4 h-4 ml-1\" />\n                  </>\n                ) : (\n                  <>\n                    Next\n                    <ArrowRight className=\"w-4 h-4 ml-1\" />\n                  </>\n                )}\n              </Button>\n            </div>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":6313,"size_tokens":null}},"version":2}